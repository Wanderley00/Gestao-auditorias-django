{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    Identificação do Item
</h4>
<div class="form-row">
    <div class="form-group required">
        <label for="codigo_interno" class="form-label">Código Interno</label>
        <input type="text" id="codigo_interno" name="codigo_interno" class="form-control" value="{{ object.codigo_interno|default:'' }}" required maxlength="50">
    </div>
    <div class="form-group">
        <label for="codigo_alternativo" class="form-label">Código Alternativo</label>
        <input type="text" id="codigo_alternativo" name="codigo_alternativo" class="form-control" value="{{ object.codigo_alternativo|default:'' }}" maxlength="50">
    </div>
</div>
<div class="form-row single">
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição</label>
        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ object.descricao|default:'' }}" required maxlength="255">
    </div>
</div>

<div class="form-row triple">
    <div class="form-group">
        <label for="unidade_medida" class="form-label">Unidade de Medida</label>
        <select id="unidade_medida" name="unidade_medida" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for um in unidades_medida %}<option value="{{ um.pk }}" {% if object.unidade_medida.pk == um.pk %}selected{% endif %}>{{ um.nome }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="peso" class="form-label">Peso</label>
        <input type="number" step="0.001" id="peso" name="peso" class="form-control" value="{{ object.peso|default:'' }}">
    </div>
    <div class="form-group">
        <label for="valor" class="form-label">Valor (R$)</label>
        <input type="number" step="0.01" id="valor" name="valor" class="form-control" value="{{ object.valor|default:'' }}">
    </div>
</div>

<h4 style="color: var(--text-primary); margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    Classificação e Localização
</h4>
<div class="form-row">
    <div class="form-group">
        <label for="categoria_principal" class="form-label">Categoria</label>
        <select id="categoria_principal" name="categoria_principal" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for cat in categorias %}<option value="{{ cat.pk }}" {% if object.categoria_principal.pk == cat.pk %}selected{% endif %}>{{ cat.descricao }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="subcategoria_principal" class="form-label">Subcategoria</label>
        <select id="subcategoria_principal" name="subcategoria_principal" class="form-control form-select">
            <option value="">Selecione uma categoria primeiro</option>
             {% if object.subcategoria_principal %}
                <option value="{{ object.subcategoria_principal.pk }}" selected>{{ object.subcategoria_principal.descricao }}</option>
            {% endif %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group">
        <label for="almoxarifado" class="form-label">Almoxarifado</label>
        <select id="almoxarifado" name="almoxarifado" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for almox in almoxarifados %}<option value="{{ almox.pk }}" {% if object.almoxarifado.pk == almox.pk %}selected{% endif %}>{{ almox.nome }}</option>{% endfor %}
        </select>
    </div>
</div>
<div class="form-group">
    <label for="imagem_item" class="form-label">Imagem do Item</label>
    {% if object.imagem_item %}
    <p>Imagem atual: <a href="{{ object.imagem_item.url }}" target="_blank">{{ object.imagem_item.name }}</a></p>
    {% endif %}
    <input type="file" id="imagem_item" name="imagem_item" class="form-control">
</div>
<div class="form-group">
    <label class="form-label">Status</label>
    <div style="display: flex; align-items: center; gap: 12px;">
        <label class="toggle-switch">
            <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px;">Item ativo no sistema</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.getElementById('categoria_principal');
    const subcategoriaSelect = document.getElementById('subcategoria_principal');

    categoriaSelect.addEventListener('change', function() {
        const categoriaId = this.value;
        subcategoriaSelect.innerHTML = '<option value="">Carregando...</option>';

        if (categoriaId) {
            fetch(`{% url 'itens:get_subcategorias_por_categoria' %}?categoria_id=${categoriaId}`)
                .then(response => response.json())
                .then(data => {
                    subcategoriaSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
                    data.forEach(subcat => {
                        const option = document.createElement('option');
                        option.value = subcat.id;
                        option.textContent = subcat.descricao;
                        subcategoriaSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar subcategorias:', error);
                    subcategoriaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                });
        } else {
            subcategoriaSelect.innerHTML = '<option value="">Selecione uma categoria primeiro</option>';
        }
    });
});
</script>
{% endblock %}