C:\Users\SV1830\Downloads\Gestao-auditorias-django\create_superuser.py

import os
import django
from django.contrib.auth import get_user_model

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
django.setup()

User = get_user_model()

# Pega os dados das variáveis de ambiente que vamos definir no Render
username = os.environ.get('DJANGO_SUPERUSER_USERNAME', '')
email = os.environ.get('DJANGO_SUPERUSER_EMAIL', '')
password = os.environ.get('DJANGO_SUPERUSER_PASSWORD', '')

if not User.objects.filter(username=username).exists():
    print(f"Criando superusuário: {username}...")
    User.objects.create_superuser(
        username=username, email=email, password=password)
    print("Superusuário criado com sucesso!")
else:
    print(f"Superusuário {username} já existe.")

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\gerar.py

import os
import fnmatch


def analisar_e_escrever_arquivos(
    ignorar_nomes_pastas=None,
    ignorar_padroes_glob=None,
    ignorar_caminhos_relativos=None,
):
    """
    Percorre o diretório atual e suas subpastas em busca de arquivos
    com extensões específicas (.py, .html, .css, .js) e escreve seus
    caminhos e conteúdos em um arquivo de texto.

    Permite ignorar pastas:
      - por nome exato (ex.: {'node_modules', '.git', 'venv'})
      - por padrão glob (ex.: {'*.venv*', 'build*'})
      - por caminho relativo a partir da pasta raiz (ex.: {'projetos/arquivos/grandes'})
    """
    pasta_raiz = os.getcwd()

    # Normaliza parâmetros
    ignorar_nomes_pastas = set(ignorar_nomes_pastas or [])
    ignorar_padroes_glob = set(ignorar_padroes_glob or [])
    # Normaliza separadores e resolve caminhos relativos em relação à pasta raiz
    ignorar_caminhos_relativos = {
        os.path.normpath(os.path.join(pasta_raiz, p))
        for p in (ignorar_caminhos_relativos or set())
    }

    extensoes_desejadas = ('.py', '.html', '.css', '.js')
    arquivo_saida = 'conteudo_arquivos.txt'

    try:
        with open(arquivo_saida, 'w', encoding='utf-8') as saida:
            print(f"Analisando a partir de: {pasta_raiz}")
            print(f"Os resultados serão salvos em: {arquivo_saida}\n")

            for diretorio_atual, dirnames, arquivos in os.walk(pasta_raiz):
                # --- FILTRO DE PASTAS A SEREM IGNORADAS ---
                # Vamos modificar dirnames in-place para evitar descer nessas pastas.
                dirnames[:] = [
                    d for d in dirnames
                    if not deve_ignorar_pasta(
                        dir_nome=d,
                        dir_absoluto=os.path.join(diretorio_atual, d),
                        pasta_raiz=pasta_raiz,
                        ignorar_nomes_pastas=ignorar_nomes_pastas,
                        ignorar_padroes_glob=ignorar_padroes_glob,
                        ignorar_caminhos_absolutos=ignorar_caminhos_relativos
                    )
                ]

                for nome_arquivo in arquivos:
                    if nome_arquivo.endswith(extensoes_desejadas):
                        caminho_completo = os.path.join(
                            diretorio_atual, nome_arquivo)

                        saida.write(f"{caminho_completo}\n\n")

                        try:
                            with open(caminho_completo, 'r', encoding='utf-8', errors='ignore') as entrada:
                                conteudo = entrada.read()
                                saida.write(f"{conteudo}\n")
                        except Exception as e:
                            saida.write(
                                f"--- Erro ao ler o arquivo: {e} ---\n")

                        saida.write(
                            "_____________________________________\n\n")
                        print(f"Processado: {caminho_completo}")

        print(
            f"\nAnálise concluída com sucesso! Verifique o arquivo '{arquivo_saida}'.")

    except IOError as e:
        print(f"Erro ao escrever no arquivo de saída: {e}")
    except Exception as e:
        print(f"Ocorreu um erro inesperado: {e}")


def deve_ignorar_pasta(
    dir_nome: str,
    dir_absoluto: str,
    pasta_raiz: str,
    ignorar_nomes_pastas: set,
    ignorar_padroes_glob: set,
    ignorar_caminhos_absolutos: set,
) -> bool:
    """
    Retorna True se a pasta deve ser ignorada, com base em:
      - nome exato
      - padrões glob
      - caminho absoluto correspondente a caminhos relativos ignorados
    """
    # 1) Nome exato (case-sensitive; ajuste se quiser case-insensitive)
    if dir_nome in ignorar_nomes_pastas:
        return True

    # 2) Padrões glob (ex.: '*.venv*', 'build*')
    for padrao in ignorar_padroes_glob:
        if fnmatch.fnmatch(dir_nome, padrao):
            return True

    # 3) Caminhos absolutos específicos (derivados dos caminhos relativos)
    dir_absoluto_norm = os.path.normpath(dir_absoluto)

    # Ignora se a pasta atual é exatamente uma das listadas
    if dir_absoluto_norm in ignorar_caminhos_absolutos:
        return True

    # Ignora se a pasta atual está dentro de um caminho ignorado (subdiretório)
    for caminho_ignorado in ignorar_caminhos_absolutos:
        # Ex.: /raiz/projetos/arquivos/grandes é prefixo de /raiz/projetos/arquivos/grandes/imagens
        if dir_absoluto_norm.startswith(caminho_ignorado + os.sep):
            return True

    return False


if __name__ == '__main__':
    # EXEMPLO DE USO: ajuste conforme sua necessidade
    analisar_e_escrever_arquivos(
        ignorar_nomes_pastas={
            '__pycache__', 'migrations', '.git', 'venv', 'antigos', 'media',
        },
        ignorar_padroes_glob={
            '*.venv*', 'build*', '.gitattributes', '.txt'
        },
        ignorar_caminhos_relativos={
            # caminhos relativos a partir da pasta raiz
            # 'projetos/arquivos/grandes',
            r'C:\Users\SV1830\Downloads\Gestao-auditorias-django\gerar.py'
        }
    )

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\manage.py

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\admin.py

# ativos/admin.py

from django.contrib import admin
from .models import Categoria, Marca, Modelo, Ativo


@admin.register(Categoria)
class CategoriaAdmin(admin.ModelAdmin):
    list_display = ('nome', 'ativo', 'data_cadastro')
    list_filter = ('ativo',)
    search_fields = ('nome',)


@admin.register(Marca)
class MarcaAdmin(admin.ModelAdmin):
    list_display = ('nome', 'ativo', 'data_cadastro')
    list_filter = ('ativo',)
    search_fields = ('nome',)


@admin.register(Modelo)
class ModeloAdmin(admin.ModelAdmin):
    list_display = ('nome', 'marca', 'ativo', 'data_cadastro')
    list_filter = ('ativo', 'marca')
    search_fields = ('nome', 'marca__nome')


@admin.register(Ativo)
class AtivoAdmin(admin.ModelAdmin):
    list_display = (
        'tag',
        'descricao',
        'categoria',
        'marca',
        'modelo',
        'estrutura_organizacional',  # Exibe o subsetor
        'ativo',
        'data_cadastro'
    )
    list_filter = ('ativo', 'categoria', 'marca', 'modelo',
                   'estrutura_organizacional__setor__area__empresa')  # Filtros úteis
    search_fields = (
        'tag',
        'descricao',
        'codigo_fabricante',
        'categoria__nome',
        'marca__nome',
        'modelo__nome',
        'estrutura_organizacional__nome',
        'estrutura_organizacional__setor__nome',
        'estrutura_organizacional__setor__area__nome',
        'estrutura_organizacional__setor__area__empresa__nome'
    )
    # Campos que aparecem no formulário de adicionar/editar
    fieldsets = (
        (None, {
            'fields': ('tag', 'descricao', 'custo', 'codigo_fabricante', 'imagem_ativo')
        }),
        ('Classificação', {
            'fields': ('categoria', 'marca', 'modelo')
        }),
        ('Localização', {
            'fields': ('estrutura_organizacional',)
        }),
        ('Status', {
            'fields': ('ativo',)
        }),
    )

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\apps.py

from django.apps import AppConfig


class AtivosConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'ativos'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\models.py

# ativos/models.py

from django.db import models
# Importar o SubSetor para a Estrutura Organizacional
from organizacao.models import SubSetor


class Categoria(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome da Categoria")
    descricao = models.TextField(
        null=True, blank=True, verbose_name="Descrição")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Categoria"
        verbose_name_plural = "Categorias"
        ordering = ['nome']

    def __str__(self):
        return self.nome


class Marca(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome da Marca")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Marca"
        verbose_name_plural = "Marcas"
        ordering = ['nome']

    def __str__(self):
        return self.nome


class Modelo(models.Model):
    marca = models.ForeignKey(
        Marca, on_delete=models.CASCADE, verbose_name="Marca")
    nome = models.CharField(max_length=100, verbose_name="Nome do Modelo")
    descricao = models.TextField(
        null=True, blank=True, verbose_name="Descrição Detalhada")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Modelo"
        verbose_name_plural = "Modelos"
        # Garante que um modelo é único para uma marca
        unique_together = ('marca', 'nome')
        ordering = ['marca__nome', 'nome']

    def __str__(self):
        return f"{self.nome} ({self.marca.nome})"


class Ativo(models.Model):
    tag = models.CharField(max_length=50, unique=True,
                           verbose_name="Tag do Ativo")
    descricao = models.CharField(max_length=255, verbose_name="Descrição")
    custo = models.DecimalField(
        max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="Custo")
    codigo_fabricante = models.CharField(
        max_length=100, null=True, blank=True, verbose_name="Código do Fabricante")

    # Relações com outros modelos - ADICIONAR related_name AQUI
    categoria = models.ForeignKey(
        Categoria,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Categoria",
        related_name='ativos_categoria'  # <-- Nome único para a relação reversa
    )
    marca = models.ForeignKey(
        Marca,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Marca",
        related_name='ativos_marca'  # <-- Nome único
    )
    modelo = models.ForeignKey(
        Modelo,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Modelo",
        related_name='ativos_modelo'  # <-- Nome único
    )
    estrutura_organizacional = models.ForeignKey(
        SubSetor,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Estrutura Organizacional (Subsetor)",
        related_name='ativos_subsetor'  # <-- Nome único (e claro)
    )

    # Campos de controle
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    # Campo para imagem do ativo
    imagem_ativo = models.ImageField(
        upload_to='ativos_imagens/', null=True, blank=True, verbose_name="Imagem do Ativo")

    class Meta:
        verbose_name = "Ativo"
        verbose_name_plural = "Ativos"
        ordering = ['tag']

    def __str__(self):
        return f"{self.tag} - {self.descricao}"

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\urls.py

# ativos/urls.py

from django.urls import path
from . import views

app_name = 'ativos'

urlpatterns = [
    # Dashboard
    path('', views.dashboard_ativos, name='dashboard'),

    # Categorias
    path('categorias/', views.lista_categorias, name='lista_categorias'),
    path('categorias/criar/', views.criar_categoria, name='criar_categoria'),
    path('categorias/<int:pk>/editar/',
         views.editar_categoria, name='editar_categoria'),
    path('categorias/<int:pk>/deletar/',
         views.deletar_categoria, name='deletar_categoria'),
    path('categorias/exportar-csv/', views.exportar_categorias_csv,
         name='exportar_categorias_csv'),  # NOVO

    # Marcas
    path('marcas/', views.lista_marcas, name='lista_marcas'),
    path('marcas/criar/', views.criar_marca, name='criar_marca'),
    path('marcas/<int:pk>/editar/', views.editar_marca, name='editar_marca'),
    path('marcas/<int:pk>/deletar/', views.deletar_marca, name='deletar_marca'),
    path('marcas/exportar-csv/', views.exportar_marcas_csv,
         name='exportar_marcas_csv'),  # NOVO

    # Modelos
    path('modelos/', views.lista_modelos, name='lista_modelos'),
    path('modelos/criar/', views.criar_modelo, name='criar_modelo'),
    path('modelos/<int:pk>/editar/', views.editar_modelo, name='editar_modelo'),
    path('modelos/<int:pk>/deletar/', views.deletar_modelo, name='deletar_modelo'),
    path('modelos/exportar-csv/', views.exportar_modelos_csv,
         name='exportar_modelos_csv'),  # NOVO

    # Ativos
    path('ativos/', views.lista_ativos, name='lista_ativos'),
    path('ativos/criar/', views.criar_ativo, name='criar_ativo'),
    path('ativos/<int:pk>/editar/', views.editar_ativo, name='editar_ativo'),
    path('ativos/<int:pk>/deletar/', views.deletar_ativo, name='deletar_ativo'),
    path('ativos/exportar-csv/', views.exportar_ativos_csv,
         name='exportar_ativos_csv'),  # NOVO

    # AJAX
    path('ajax/modelos-por-marca/', views.get_modelos_por_marca,
         name='get_modelos_por_marca'),
]

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\views.py

# ativos/views.py

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.db.models import Q, Count
from django.http import JsonResponse
import csv
from django.http import HttpResponse

from .models import Categoria, Marca, Modelo, Ativo
from organizacao.models import SubSetor


# ============================================================================
# DASHBOARD
# ============================================================================

@login_required
def dashboard_ativos(request):
    """Dashboard principal do módulo de ativos"""
    context = {
        'total_ativos': Ativo.objects.count(),
        'ativos_ativos': Ativo.objects.filter(ativo=True).count(),
        'total_categorias': Categoria.objects.count(),
        'total_marcas': Marca.objects.count(),
        'total_modelos': Modelo.objects.count(),
        'ativos_recentes': Ativo.objects.select_related(
            'categoria', 'marca', 'modelo', 'estrutura_organizacional'
        ).order_by('-data_cadastro')[:5],
    }
    return render(request, 'ativos/dashboard.html', context)


# ============================================================================
# VIEWS PARA CATEGORIAS
# ============================================================================

@login_required
def lista_categorias(request):
    """Lista todas as categorias de ativos"""
    search = request.GET.get('search', '')
    categorias = Categoria.objects.annotate(
        total_ativos=Count('ativos_categoria')
    )

    if search:
        categorias = categorias.filter(
            Q(nome__icontains=search) | Q(descricao__icontains=search)
        )

    paginator = Paginator(categorias, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Categorias de Ativos',
        'singular': 'Categoria',
        'button_text': 'Nova Categoria',
        'create_url': 'ativos:criar_categoria',
        'export_url': 'ativos:exportar_categorias_csv',  # NOVO
        'artigo': 'a',
        'empty_message': 'Nenhuma categoria cadastrada',
        'empty_subtitle': 'Comece criando a primeira categoria.'
    }
    return render(request, 'ativos/categorias/lista.html', context)


@login_required
def criar_categoria(request):
    """Cria uma nova categoria"""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        descricao = request.POST.get('descricao', '')
        ativo = request.POST.get('ativo') == 'on'

        if nome:
            try:
                Categoria.objects.create(
                    nome=nome,
                    descricao=descricao,
                    ativo=ativo
                )
                messages.success(request, 'Categoria criada com sucesso!')
                return redirect('ativos:lista_categorias')
            except Exception as e:
                messages.error(request, f'Erro ao criar categoria: {str(e)}')
        else:
            messages.error(request, 'Nome é obrigatório!')

    context = {
        'title': 'Criar Categoria',
        'back_url': 'ativos:lista_categorias'
    }
    return render(request, 'ativos/categorias/form.html', context)


@login_required
def editar_categoria(request, pk):
    """Edita uma categoria existente"""
    categoria = get_object_or_404(Categoria, pk=pk)

    if request.method == 'POST':
        categoria.nome = request.POST.get('nome')
        categoria.descricao = request.POST.get('descricao', '')
        categoria.ativo = request.POST.get('ativo') == 'on'

        try:
            categoria.save()
            messages.success(request, 'Categoria atualizada com sucesso!')
            return redirect('ativos:lista_categorias')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar categoria: {str(e)}')

    context = {
        'categoria': categoria,
        'title': 'Editar Categoria',
        'back_url': 'ativos:lista_categorias'
    }
    return render(request, 'ativos/categorias/form.html', context)


@login_required
def deletar_categoria(request, pk):
    """Deleta uma categoria"""
    categoria = get_object_or_404(Categoria, pk=pk)

    if request.method == 'POST':
        try:
            categoria.delete()
            messages.success(request, 'Categoria deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar categoria: {str(e)}')
        return redirect('ativos:lista_categorias')

    context = {
        'object': categoria,
        'title': 'Categoria'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_categorias_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={
            'Content-Disposition': 'attachment; filename="ativos_categorias.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Descrição', 'Status', 'Data de Cadastro'])

    search = request.GET.get('search', '')
    categorias = Categoria.objects.all()
    if search:
        categorias = categorias.filter(
            Q(nome__icontains=search) | Q(descricao__icontains=search))

    for categoria in categorias:
        writer.writerow([
            categoria.nome,
            categoria.descricao,
            'Ativo' if categoria.ativo else 'Inativo',
            categoria.data_cadastro.strftime('%d/%m/%Y %H:%M')
        ])

    return response


# ============================================================================
# VIEWS PARA MARCAS
# ============================================================================


@login_required
def lista_marcas(request):
    """Lista todas as marcas"""
    search = request.GET.get('search', '')
    marcas = Marca.objects.annotate(
        total_modelos=Count('modelo'),
        total_ativos=Count('ativos_marca')
    )

    if search:
        marcas = marcas.filter(nome__icontains=search)

    paginator = Paginator(marcas, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Marcas',
        'singular': 'Marca',
        'button_text': 'Nova Marca',
        'create_url': 'ativos:criar_marca',
        'export_url': 'ativos:exportar_marcas_csv',  # NOVO
        'artigo': 'a',
        'empty_message': 'Nenhuma marca cadastrada',
        'empty_subtitle': 'Comece criando a primeira marca.'
    }
    return render(request, 'ativos/marcas/lista.html', context)


@login_required
def criar_marca(request):
    """Cria uma nova marca"""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        ativo = request.POST.get('ativo') == 'on'

        if nome:
            try:
                Marca.objects.create(
                    nome=nome,
                    ativo=ativo
                )
                messages.success(request, 'Marca criada com sucesso!')
                return redirect('ativos:lista_marcas')
            except Exception as e:
                messages.error(request, f'Erro ao criar marca: {str(e)}')
        else:
            messages.error(request, 'Nome é obrigatório!')

    context = {
        'title': 'Criar Marca',
        'back_url': 'ativos:lista_marcas'
    }
    return render(request, 'ativos/marcas/form.html', context)


@login_required
def editar_marca(request, pk):
    """Edita uma marca existente"""
    marca = get_object_or_404(Marca, pk=pk)

    if request.method == 'POST':
        marca.nome = request.POST.get('nome')
        marca.ativo = request.POST.get('ativo') == 'on'

        try:
            marca.save()
            messages.success(request, 'Marca atualizada com sucesso!')
            return redirect('ativos:lista_marcas')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar marca: {str(e)}')

    context = {
        'marca': marca,
        'title': 'Editar Marca',
        'back_url': 'ativos:lista_marcas'
    }
    return render(request, 'ativos/marcas/form.html', context)


@login_required
def deletar_marca(request, pk):
    """Deleta uma marca"""
    marca = get_object_or_404(Marca, pk=pk)

    if request.method == 'POST':
        try:
            marca.delete()
            messages.success(request, 'Marca deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar marca: {str(e)}')
        return redirect('ativos:lista_marcas')

    context = {
        'object': marca,
        'title': 'Marca'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_marcas_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="marcas.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Status'])

    search = request.GET.get('search', '')
    marcas = Marca.objects.all()
    if search:
        marcas = marcas.filter(nome__icontains=search)

    for marca in marcas:
        writer.writerow([
            marca.nome,
            'Ativo' if marca.ativo else 'Inativo'
        ])

    return response
# ============================================================================
# VIEWS PARA MODELOS
# ============================================================================


@login_required
def lista_modelos(request):
    """Lista todos os modelos"""
    search = request.GET.get('search', '')
    marca_filter = request.GET.get('marca', '')

    modelos = Modelo.objects.select_related('marca').annotate(
        total_ativos=Count('ativos_modelo')
    )

    if search:
        modelos = modelos.filter(
            Q(nome__icontains=search) |
            Q(marca__nome__icontains=search) |
            Q(descricao__icontains=search)
        )

    if marca_filter:
        modelos = modelos.filter(marca_id=marca_filter)

    paginator = Paginator(modelos, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'marca_filter': marca_filter,
        'marcas': Marca.objects.filter(ativo=True),
        'title': 'Modelos',
        'singular': 'Modelo',
        'button_text': 'Novo Modelo',
        'create_url': 'ativos:criar_modelo',
        'export_url': 'ativos:exportar_modelos_csv',  # NOVO
        'artigo': 'o',
        'empty_message': 'Nenhum modelo cadastrado',
        'empty_subtitle': 'Comece criando o primeiro modelo.'
    }
    return render(request, 'ativos/modelos/lista.html', context)


@login_required
def criar_modelo(request):
    """Cria um novo modelo"""
    if request.method == 'POST':
        marca_id = request.POST.get('marca')
        nome = request.POST.get('nome')
        descricao = request.POST.get('descricao', '')
        ativo = request.POST.get('ativo') == 'on'

        if marca_id and nome:
            try:
                marca = Marca.objects.get(pk=marca_id)
                Modelo.objects.create(
                    marca=marca,
                    nome=nome,
                    descricao=descricao,
                    ativo=ativo
                )
                messages.success(request, 'Modelo criado com sucesso!')
                return redirect('ativos:lista_modelos')
            except Exception as e:
                messages.error(request, f'Erro ao criar modelo: {str(e)}')
        else:
            messages.error(request, 'Marca e nome são obrigatórios!')

    context = {
        'marcas': Marca.objects.filter(ativo=True),
        'title': 'Criar Modelo',
        'back_url': 'ativos:lista_modelos'
    }
    return render(request, 'ativos/modelos/form.html', context)


@login_required
def editar_modelo(request, pk):
    """Edita um modelo existente"""
    modelo = get_object_or_404(Modelo, pk=pk)

    if request.method == 'POST':
        marca_id = request.POST.get('marca')
        modelo.nome = request.POST.get('nome')
        modelo.descricao = request.POST.get('descricao', '')
        modelo.ativo = request.POST.get('ativo') == 'on'

        if marca_id:
            modelo.marca = Marca.objects.get(pk=marca_id)

        try:
            modelo.save()
            messages.success(request, 'Modelo atualizado com sucesso!')
            return redirect('ativos:lista_modelos')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar modelo: {str(e)}')

    context = {
        'modelo': modelo,
        'marcas': Marca.objects.filter(ativo=True),
        'title': 'Editar Modelo',
        'back_url': 'ativos:lista_modelos'
    }
    return render(request, 'ativos/modelos/form.html', context)


@login_required
def deletar_modelo(request, pk):
    """Deleta um modelo"""
    modelo = get_object_or_404(Modelo, pk=pk)

    if request.method == 'POST':
        try:
            modelo.delete()
            messages.success(request, 'Modelo deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar modelo: {str(e)}')
        return redirect('ativos:lista_modelos')

    context = {
        'object': modelo,
        'title': 'Modelo'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_modelos_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="modelos.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Marca', 'Descrição', 'Status'])

    search = request.GET.get('search', '')
    marca_filter = request.GET.get('marca', '')

    modelos = Modelo.objects.select_related('marca').all()

    if search:
        modelos = modelos.filter(
            Q(nome__icontains=search) |
            Q(marca__nome__icontains=search) |
            Q(descricao__icontains=search)
        )
    if marca_filter:
        modelos = modelos.filter(marca_id=marca_filter)

    for modelo in modelos:
        writer.writerow([
            modelo.nome,
            modelo.marca.nome,
            modelo.descricao,
            'Ativo' if modelo.ativo else 'Inativo'
        ])

    return response
# ============================================================================
# VIEWS PARA ATIVOS
# ============================================================================


@login_required
def lista_ativos(request):
    """Lista todos os ativos"""
    search = request.GET.get('search', '')
    categoria_filter = request.GET.get('categoria', '')
    marca_filter = request.GET.get('marca', '')

    ativos = Ativo.objects.select_related(
        'categoria', 'marca', 'modelo', 'estrutura_organizacional'
    )

    if search:
        ativos = ativos.filter(
            Q(tag__icontains=search) |
            Q(descricao__icontains=search) |
            Q(codigo_fabricante__icontains=search)
        )

    if categoria_filter:
        ativos = ativos.filter(categoria_id=categoria_filter)

    if marca_filter:
        ativos = ativos.filter(marca_id=marca_filter)

    paginator = Paginator(ativos, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'categoria_filter': categoria_filter,
        'marca_filter': marca_filter,
        'categorias': Categoria.objects.filter(ativo=True),
        'marcas': Marca.objects.filter(ativo=True),
        'title': 'Ativos',
        'singular': 'Ativo',
        'button_text': 'Novo Ativo',
        'create_url': 'ativos:criar_ativo',
        'export_url': 'ativos:exportar_ativos_csv',  # NOVO
        'artigo': 'o',
        'empty_message': 'Nenhum ativo cadastrado',
        'empty_subtitle': 'Comece criando o primeiro ativo.'
    }
    return render(request, 'ativos/lista.html', context)


@login_required
def criar_ativo(request):
    """Cria um novo ativo"""
    if request.method == 'POST':
        tag = request.POST.get('tag')
        descricao = request.POST.get('descricao')
        custo = request.POST.get('custo') or None
        codigo_fabricante = request.POST.get('codigo_fabricante', '')
        categoria_id = request.POST.get('categoria') or None
        marca_id = request.POST.get('marca') or None
        modelo_id = request.POST.get('modelo') or None
        estrutura_id = request.POST.get('estrutura_organizacional') or None
        ativo = request.POST.get('ativo') == 'on'

        if tag and descricao:
            try:
                novo_ativo = Ativo.objects.create(
                    tag=tag,
                    descricao=descricao,
                    custo=custo,
                    codigo_fabricante=codigo_fabricante,
                    categoria_id=categoria_id,
                    marca_id=marca_id,
                    modelo_id=modelo_id,
                    estrutura_organizacional_id=estrutura_id,
                    ativo=ativo
                )

                # Processar imagem se fornecida
                if request.FILES.get('imagem_ativo'):
                    novo_ativo.imagem_ativo = request.FILES['imagem_ativo']
                    novo_ativo.save()

                messages.success(request, 'Ativo criado com sucesso!')
                return redirect('ativos:lista_ativos')
            except Exception as e:
                messages.error(request, f'Erro ao criar ativo: {str(e)}')
        else:
            messages.error(request, 'Tag e descrição são obrigatórios!')

    context = {
        'categorias': Categoria.objects.filter(ativo=True),
        'marcas': Marca.objects.filter(ativo=True),
        'modelos': Modelo.objects.filter(ativo=True),
        'subsetores': SubSetor.objects.filter(ativo=True),
        'title': 'Criar Ativo',
        'back_url': 'ativos:lista_ativos'
    }
    return render(request, 'ativos/form.html', context)


@login_required
def editar_ativo(request, pk):
    """Edita um ativo existente"""
    ativo_obj = get_object_or_404(Ativo, pk=pk)

    if request.method == 'POST':
        ativo_obj.tag = request.POST.get('tag')
        ativo_obj.descricao = request.POST.get('descricao')
        ativo_obj.custo = request.POST.get('custo') or None
        ativo_obj.codigo_fabricante = request.POST.get('codigo_fabricante', '')
        ativo_obj.categoria_id = request.POST.get('categoria') or None
        ativo_obj.marca_id = request.POST.get('marca') or None
        ativo_obj.modelo_id = request.POST.get('modelo') or None
        ativo_obj.estrutura_organizacional_id = request.POST.get(
            'estrutura_organizacional') or None
        ativo_obj.ativo = request.POST.get('ativo') == 'on'

        try:
            # Processar imagem se fornecida
            if request.FILES.get('imagem_ativo'):
                ativo_obj.imagem_ativo = request.FILES['imagem_ativo']

            ativo_obj.save()
            messages.success(request, 'Ativo atualizado com sucesso!')
            return redirect('ativos:lista_ativos')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar ativo: {str(e)}')

    context = {
        'ativo': ativo_obj,
        'categorias': Categoria.objects.filter(ativo=True),
        'marcas': Marca.objects.filter(ativo=True),
        'modelos': Modelo.objects.filter(ativo=True),
        'subsetores': SubSetor.objects.filter(ativo=True),
        'title': 'Editar Ativo',
        'back_url': 'ativos:lista_ativos'
    }
    return render(request, 'ativos/form.html', context)


@login_required
def deletar_ativo(request, pk):
    """Deleta um ativo"""
    ativo = get_object_or_404(Ativo, pk=pk)

    if request.method == 'POST':
        try:
            ativo.delete()
            messages.success(request, 'Ativo deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar ativo: {str(e)}')
        return redirect('ativos:lista_ativos')

    context = {
        'object': ativo,
        'title': 'Ativo'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_ativos_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="ativos.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Tag', 'Descrição', 'Categoria', 'Marca',
                    'Modelo', 'Local (Subsetor)', 'Status'])

    search = request.GET.get('search', '')
    categoria_filter = request.GET.get('categoria', '')
    marca_filter = request.GET.get('marca', '')

    ativos = Ativo.objects.select_related(
        'categoria', 'marca', 'modelo', 'estrutura_organizacional')

    if search:
        ativos = ativos.filter(
            Q(tag__icontains=search) |
            Q(descricao__icontains=search) |
            Q(codigo_fabricante__icontains=search)
        )
    if categoria_filter:
        ativos = ativos.filter(categoria_id=categoria_filter)
    if marca_filter:
        ativos = ativos.filter(marca_id=marca_filter)

    for ativo in ativos:
        writer.writerow([
            ativo.tag,
            ativo.descricao,
            ativo.categoria.nome if ativo.categoria else 'N/A',
            ativo.marca.nome if ativo.marca else 'N/A',
            ativo.modelo.nome if ativo.modelo else 'N/A',
            str(ativo.estrutura_organizacional) if ativo.estrutura_organizacional else 'N/A',
            'Ativo' if ativo.ativo else 'Inativo'
        ])

    return response


# ============================================================================
# VIEWS AJAX
# ============================================================================

@login_required
def get_modelos_por_marca(request):
    """Retorna modelos de uma marca via AJAX"""
    marca_id = request.GET.get('marca_id')
    modelos = Modelo.objects.filter(
        marca_id=marca_id, ativo=True).values('id', 'nome')
    return JsonResponse(list(modelos), safe=False)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\dashboard.html

{% extends 'auditorias/base.html' %}

{% block title %}Dashboard de Ativos{% endblock %}
{% block page_title %}Dashboard de Ativos{% endblock %}

{% block content %}
<div class="content-header">
    <h2 class="content-title">Visão Geral de Ativos</h2>
    <p class="content-subtitle">Estatísticas e informações sobre os ativos cadastrados.</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">{{ total_ativos }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Total de Ativos</p>
                </div>
                <div style="font-size: 24px; color: var(--primary);"><i class="fas fa-box"></i></div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 8px;">{{ ativos_ativos }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Ativos em Operação</p>
                </div>
                <div style="font-size: 24px; color: var(--success);"><i class="fas fa-check-circle"></i></div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">{{ total_categorias }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Categorias</p>
                </div>
                <div style="font-size: 24px; color: var(--warning);"><i class="fas fa-tags"></i></div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--info); margin-bottom: 8px;">{{ total_marcas }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Marcas</p>
                </div>
                <div style="font-size: 24px; color: var(--info);"><i class="fas fa-building"></i></div>
            </div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Ativos Adicionados Recentemente</h3>
        </div>
        <div class="card-body">
            {% if ativos_recentes %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tag</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Data Cadastro</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ativo in ativos_recentes %}
                            <tr>
                                <td><a href="{% url 'ativos:editar_ativo' ativo.pk %}">{{ ativo.tag }}</a></td>
                                <td>{{ ativo.descricao }}</td>
                                <td><span class="badge badge-info">{{ ativo.categoria.nome|default:'N/A' }}</span></td>
                                <td>{{ ativo.data_cadastro|date:"d/m/Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Nenhum ativo cadastrado recentemente.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Ações Rápidas</h3>
        </div>
        <div class="card-body" style="display: flex; flex-direction: column; gap: 12px;">
            <a href="{% url 'ativos:criar_ativo' %}" class="btn btn-primary"><i class="fas fa-plus"></i> Novo Ativo</a>
            <a href="{% url 'ativos:criar_categoria' %}" class="btn btn-secondary"><i class="fas fa-plus"></i> Nova Categoria</a>
            <a href="{% url 'ativos:criar_marca' %}" class="btn btn-secondary"><i class="fas fa-plus"></i> Nova Marca</a>
            <a href="{% url 'ativos:criar_modelo' %}" class="btn btn-secondary"><i class="fas fa-plus"></i> Novo Modelo</a>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    Identificação do Ativo
</h4>
<div class="form-row">
    <div class="form-group required">
        <label for="tag" class="form-label">TAG do Ativo</label>
        <input type="text" id="tag" name="tag" class="form-control" value="{{ ativo.tag|default:'' }}" required maxlength="50">
    </div>
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição</label>
        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ ativo.descricao|default:'' }}" required maxlength="255">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="custo" class="form-label">Custo (R$)</label>
        <input type="number" step="0.01" id="custo" name="custo" class="form-control" value="{{ ativo.custo|default:'' }}">
    </div>
    <div class="form-group">
        <label for="codigo_fabricante" class="form-label">Código do Fabricante</label>
        <input type="text" id="codigo_fabricante" name="codigo_fabricante" class="form-control" value="{{ ativo.codigo_fabricante|default:'' }}" maxlength="100">
    </div>
</div>
<div class="form-group">
    <label for="imagem_ativo" class="form-label">Imagem do Ativo</label>
    {% if ativo.imagem_ativo %}
    <p>Imagem atual: <a href="{{ ativo.imagem_ativo.url }}" target="_blank">{{ ativo.imagem_ativo.name }}</a></p>
    {% endif %}
    <input type="file" id="imagem_ativo" name="imagem_ativo" class="form-control">
</div>

<h4 style="color: var(--text-primary); margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    Classificação e Localização
</h4>
<div class="form-row triple">
    <div class="form-group">
        <label for="categoria" class="form-label">Categoria</label>
        <select id="categoria" name="categoria" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for cat in categorias %}<option value="{{ cat.pk }}" {% if ativo.categoria.pk == cat.pk %}selected{% endif %}>{{ cat.nome }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="marca" class="form-label">Marca</label>
        <select id="marca" name="marca" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for marca in marcas %}<option value="{{ marca.pk }}" {% if ativo.marca.pk == marca.pk %}selected{% endif %}>{{ marca.nome }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="modelo" class="form-label">Modelo</label>
        <select id="modelo" name="modelo" class="form-control form-select">
            <option value="">Selecione uma marca primeiro</option>
            {% if ativo.modelo %}
                <option value="{{ ativo.modelo.pk }}" selected>{{ ativo.modelo.nome }}</option>
            {% endif %}
        </select>
    </div>
</div>
<div class="form-row">
     <div class="form-group">
        <label for="estrutura_organizacional" class="form-label">Local (Subsetor)</label>
        <select id="estrutura_organizacional" name="estrutura_organizacional" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for subsetor in subsetores %}<option value="{{ subsetor.pk }}" {% if ativo.estrutura_organizacional.pk == subsetor.pk %}selected{% endif %}>{{ subsetor }}</option>{% endfor %}
        </select>
    </div>
</div>
<div class="form-group">
    <label class="form-label">Status</label>
    <div style="display: flex; align-items: center; gap: 12px;">
        <label class="toggle-switch">
            <input type="checkbox" name="ativo" {% if ativo.ativo|default:True %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px;">Ativo no sistema</span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const marcaSelect = document.getElementById('marca');
    const modeloSelect = document.getElementById('modelo');

    marcaSelect.addEventListener('change', function() {
        const marcaId = this.value;
        modeloSelect.innerHTML = '<option value="">Carregando...</option>';

        if (marcaId) {
            fetch(`{% url 'ativos:get_modelos_por_marca' %}?marca_id=${marcaId}`)
                .then(response => response.json())
                .then(data => {
                    modeloSelect.innerHTML = '<option value="">Selecione um modelo</option>';
                    data.forEach(modelo => {
                        const option = document.createElement('option');
                        option.value = modelo.id;
                        option.textContent = modelo.nome;
                        modeloSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar modelos:', error);
                    modeloSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                });
        } else {
            modeloSelect.innerHTML = '<option value="">Selecione uma marca primeiro</option>';
        }
    });
});
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Tag</th>
    <th>Descrição</th>
    <th>Categoria</th>
    <th>Marca</th>
    <th>Modelo</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.tag }}
        </div>
    </td>
    <td>{{ object.descricao|truncatechars:40 }}</td>
    <td>{{ object.categoria.nome|default:"—" }}</td>
    <td>{{ object.marca.nome|default:"—" }}</td>
    <td>{{ object.modelo.nome|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'ativos:editar_ativo' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Ativo">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Ativo"
                    onclick="confirmDelete('{% url 'ativos:deletar_ativo' object.pk %}', '{{ object.tag }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\categorias\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome da Categoria</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ categoria.nome|default:'' }}" required maxlength="100">
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea id="descricao" name="descricao" class="form-control" rows="4">{{ categoria.descricao|default:'' }}</textarea>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if categoria.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Categoria ativa no sistema
            </span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\categorias\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome da Categoria</th>
    <th>Total de Ativos</th>
    <th>Status</th>
    <th>Data de Cadastro</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.total_ativos }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>{{ object.data_cadastro|date:"d/m/Y" }}</td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'ativos:editar_categoria' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Categoria">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Categoria"
                    onclick="confirmDelete('{% url 'ativos:deletar_categoria' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\marcas\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome da Marca</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ marca.nome|default:'' }}" required maxlength="100">
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if marca.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Marca ativa no sistema
            </span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\marcas\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome da Marca</th>
    <th>Modelos</th>
    <th>Ativos</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.total_modelos }}</td>
    <td>{{ object.total_ativos }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'ativos:editar_marca' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Marca">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Marca"
                    onclick="confirmDelete('{% url 'ativos:deletar_marca' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\modelos\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row">
    <div class="form-group required">
        <label for="marca" class="form-label">Marca</label>
        <select id="marca" name="marca" class="form-control form-select" required>
            <option value="">Selecione uma marca...</option>
            {% for marca in marcas %}
            <option value="{{ marca.pk }}" {% if modelo.marca.pk == marca.pk %}selected{% endif %}>
                {{ marca.nome }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Modelo</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ modelo.nome|default:'' }}" required maxlength="100">
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea id="descricao" name="descricao" class="form-control" rows="4">{{ modelo.descricao|default:'' }}</textarea>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if modelo.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Modelo ativo no sistema
            </span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\ativos\templates\ativos\modelos\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome do Modelo</th>
    <th>Marca</th>
    <th>Total de Ativos</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.marca.nome }}</td>
    <td>{{ object.total_ativos }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'ativos:editar_modelo' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Modelo">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Modelo"
                    onclick="confirmDelete('{% url 'ativos:deletar_modelo' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\admin.py

# auditorias/admin.py

from django.contrib import admin
from .models import (
    Pilar,
    CategoriaAuditoria,
    Norma,
    RequisitoNorma,
    FerramentaDigital,
    Checklist,
    FerramentaCausaRaiz,
    ModeloAuditoria,
    Auditoria,
    AuditoriaInstancia,
    Topico,
    Pergunta,
    OpcaoResposta,
    OpcaoPorcentagem,
    Resposta,  # <-- ADICIONE ESTA LINHA
    AnexoResposta,  # <-- ADICIONE ESTA LINHA
    PlanoDeAcao,
)

# 1. Crie uma classe Inline para os Anexos


class AnexoRespostaInline(admin.TabularInline):
    model = AnexoResposta
    extra = 0  # Não mostra campos de anexo extras para adicionar pelo admin
    readonly_fields = ('arquivo', 'data_upload')  # Apenas visualização

# 2. Crie uma classe ModelAdmin para as Respostas


@admin.register(Resposta)
class RespostaAdmin(admin.ModelAdmin):
    list_display = ('pergunta', 'auditoria_instancia',
                    'resposta_livre_texto', 'data_resposta')
    list_filter = ('auditoria_instancia__data_execucao',
                   'pergunta__topico__checklist')
    search_fields = ('pergunta__descricao', 'resposta_livre_texto')
    # Mostra os anexos dentro da página da resposta
    inlines = [AnexoRespostaInline]

# 3. Crie uma classe Inline para as Respostas


class RespostaInline(admin.TabularInline):
    model = Resposta
    extra = 0  # Não permite adicionar novas respostas pelo admin
    # Campos que você quer ver na lista de respostas
    fields = ('pergunta', 'opcao_resposta',
              'opcao_porcentagem', 'resposta_livre_texto')
    readonly_fields = fields  # Torna todos os campos somente leitura


@admin.register(Pilar)
class PilarAdmin(admin.ModelAdmin):
    list_display = ('nome', 'descricao', 'ativo', 'data_cadastro')
    list_filter = ('ativo',)
    search_fields = ('nome', 'descricao')
    fieldsets = (
        (None, {
            'fields': ('nome', 'descricao', 'ativo')
        }),
    )


@admin.register(CategoriaAuditoria)
class CategoriaAuditoriaAdmin(admin.ModelAdmin):
    list_display = ('id', 'pilar', 'descricao', 'ativo', 'data_cadastro')
    list_filter = ('ativo', 'pilar')
    search_fields = ('descricao', 'pilar__nome')
    fieldsets = (
        (None, {
            'fields': ('pilar', 'descricao', 'ativo')
        }),
    )


class RequisitoNormaInline(admin.TabularInline):
    model = RequisitoNorma
    extra = 0
    min_num = 1
    fields = ('codigo', 'requisito', 'descricao', 'ativo')


@admin.register(Norma)
class NormaAdmin(admin.ModelAdmin):
    list_display = ('descricao', 'revisao', 'ativo', 'data_cadastro')
    list_filter = ('ativo',)
    search_fields = ('descricao', 'revisao')
    inlines = [RequisitoNormaInline]
    fieldsets = (
        (None, {
            'fields': ('descricao', 'revisao', 'ativo')
        }),
    )


@admin.register(FerramentaDigital)
class FerramentaDigitalAdmin(admin.ModelAdmin):
    list_display = ('nome',)
    search_fields = ('nome',)


@admin.register(FerramentaCausaRaiz)
class FerramentaCausaRaizAdmin(admin.ModelAdmin):
    list_display = ('nome',)
    search_fields = ('nome',)


@admin.register(ModeloAuditoria)
class ModeloAuditoriaAdmin(admin.ModelAdmin):
    list_display = (
        'descricao',
        'checklist',
        'categoria',
        'ferramenta_causa_raiz',
        'ativo',
        'iniciar_por_codigo_qr',
        'data_cadastro'
    )
    list_filter = (
        'ativo',
        'iniciar_por_codigo_qr',
        'checklist',
        'categoria',
        'ferramenta_causa_raiz'
    )
    search_fields = (
        'descricao',
        'checklist__nome',
        'categoria__descricao',
        'ferramenta_causa_raiz__nome'
    )
    fieldsets = (
        (None, {
            'fields': ('descricao', 'checklist', 'categoria', 'ferramenta_causa_raiz', 'ativo', 'iniciar_por_codigo_qr')
        }),
    )


@admin.register(Auditoria)
class AuditoriaAdmin(admin.ModelAdmin):
    list_display = (
        'id',
        'responsavel',
        'nivel_organizacional',
        'ferramenta',
        'data_inicio',
        'data_fim',
        'data_criacao'
    )
    list_filter = (
        'nivel_organizacional',
        'ferramenta',
        'responsavel',
        'data_inicio'
    )
    search_fields = (
        'responsavel__first_name',
        'responsavel__last_name',
        'responsavel__username',
        'local_empresa__nome',
        'local_area__nome',
        'local_setor__nome',
        'local_subsetor__nome'
    )
    filter_horizontal = ('modelos', 'ativos_auditados', 'turnos')
    fieldsets = (
        ("Informações Gerais", {
            'fields': ('ferramenta', 'responsavel', 'categoria_auditoria')
        }),
        ("Localização", {
            'fields': ('nivel_organizacional', 'local_empresa', 'local_area', 'local_setor', 'local_subsetor')
        }),
        ("Seleção de Conteúdo", {
            'fields': ('modelos', 'ativos_auditados')
        }),
        ("Programação", {
            'fields': ('data_inicio', 'data_fim', ('por_frequencia', 'por_intervalo'), 'frequencia', 'intervalo', 'numero_repeticoes', 'pular_finais_semana', 'contem_turnos', 'turnos')
        }),
    )


@admin.register(AuditoriaInstancia)
class AuditoriaInstanciaAdmin(admin.ModelAdmin):
    list_display = ('auditoria_agendada', 'data_execucao', 'executada')
    list_filter = ('executada', 'data_execucao')
    # Busca pelo ID da auditoria pai
    search_fields = ('auditoria_agendada__id',)
    inlines = [RespostaInline]


class OpcaoRespostaInline(admin.TabularInline):
    model = OpcaoResposta
    extra = 0
    fields = ('descricao', 'status')


class OpcaoPorcentagemInline(admin.TabularInline):
    model = OpcaoPorcentagem
    extra = 0
    fields = ('descricao', 'peso', 'cor')


@admin.register(Pergunta)
class PerguntaAdmin(admin.ModelAdmin):
    list_display = ('topico', 'descricao', 'obrigatoria', 'campo_desabilitado')
    list_filter = ('obrigatoria', 'campo_desabilitado')
    search_fields = ('descricao',)
    inlines = [OpcaoRespostaInline, OpcaoPorcentagemInline]


class PerguntaInline(admin.TabularInline):
    model = Pergunta
    extra = 0
    fields = ('descricao', 'obrigatoria', 'campo_desabilitado', 'ordem')


@admin.register(Topico)
class TopicoAdmin(admin.ModelAdmin):
    list_display = ('checklist', 'descricao', 'ordem')
    list_filter = ('checklist',)
    search_fields = ('descricao',)
    inlines = [PerguntaInline]


class TopicoInline(admin.TabularInline):
    model = Topico
    extra = 0
    fields = ('descricao', 'ordem')


@admin.register(Checklist)
class ChecklistAdmin(admin.ModelAdmin):
    list_display = (
        'nome',
        'ativo',
        'ferramenta',
    )
    list_filter = ('ativo', 'ferramenta')
    search_fields = ('nome',)
    inlines = [TopicoInline]


@admin.register(PlanoDeAcao)
class PlanoDeAcaoAdmin(admin.ModelAdmin):
    list_display = ('id', 'titulo', 'status_plano', 'tipo',
                    'origem_resposta', 'criado_por', 'data_abertura')
    list_filter = ('status_plano', 'tipo', 'fluxo_simplificado')
    search_fields = ('titulo', 'descricao_acao')

    # Isso ajuda a identificar visualmente os manuais no admin
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        return qs

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\apps.py

from django.apps import AppConfig


class AuditoriasConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'auditorias'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\models.py

# auditorias/models.py

from django.db import models
from django.contrib.auth.models import User
from organizacao.models import Empresa, Area, Setor, SubSetor
from ativos.models import Ativo
from cadastros_base.models import Turno
from django.conf import settings

from django.utils import timezone
from datetime import timedelta
from dateutil.relativedelta import relativedelta

from django.db.models import Q


class Pilar(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome do Pilar")
    descricao = models.TextField(
        null=True, blank=True, verbose_name="Descrição")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Pilar"
        verbose_name_plural = "Pilares"
        ordering = ['nome']

    def __str__(self):
        return self.nome


class CategoriaAuditoria(models.Model):
    pilar = models.ForeignKey(
        Pilar,
        on_delete=models.CASCADE,
        verbose_name="Pilar",
        related_name='categorias_auditoria'
    )
    descricao = models.CharField(
        max_length=255, verbose_name="Descrição da Categoria")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    dias_para_quarentena = models.PositiveIntegerField(
        default=7,
        verbose_name="Dias de Tolerância para Quarentena",
        help_text="Quantos dias de atraso são permitidos antes de entrar em quarentena."
    )

    class Meta:
        verbose_name = "Categoria de Auditoria"
        verbose_name_plural = "Categorias de Auditorias"
        unique_together = ('pilar', 'descricao')
        ordering = ['pilar__nome', 'descricao']

    def __str__(self):
        return f"{self.descricao} ({self.pilar.nome})"


class Norma(models.Model):
    descricao = models.CharField(
        max_length=255, unique=True, verbose_name="Descrição da Norma")
    revisao = models.CharField(max_length=100, verbose_name="Revisão")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Norma"
        verbose_name_plural = "Normas"
        unique_together = ('descricao', 'revisao')
        ordering = ['descricao', 'revisao']

    def __str__(self):
        return f"{self.descricao} (Rev. {self.revisao})"


class RequisitoNorma(models.Model):
    norma = models.ForeignKey(
        Norma,
        on_delete=models.CASCADE,
        verbose_name="Norma",
        related_name='requisitos'
    )
    codigo = models.CharField(max_length=50, verbose_name="Código")
    requisito = models.CharField(max_length=255, verbose_name="Requisito")
    descricao = models.TextField(
        null=True, blank=True, verbose_name="Descrição")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Requisito de Norma"
        verbose_name_plural = "Requisitos de Normas"
        unique_together = ('norma', 'codigo')
        ordering = ['norma__descricao', 'codigo']

    def __str__(self):
        return f"{self.codigo} - {self.norma.descricao}"


class FerramentaDigital(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome da Ferramenta")

    aplicavel_em_checklist = models.BooleanField(
        default=True,
        verbose_name="É aplicável em checklists?"
    )

    class Meta:
        verbose_name = "Ferramenta Digital"
        verbose_name_plural = "Ferramentas Digitais"
        ordering = ['nome']

    def __str__(self):
        return self.nome


class Checklist(models.Model):
    nome = models.CharField(max_length=255, verbose_name="Nome do Checklist")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    ferramenta = models.ForeignKey(
        FerramentaDigital,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Ferramenta Digital",
        related_name='checklists'
    )

    # --- NOVO CAMPO ADICIONADO AQUI ---
    normas_relacionadas = models.ManyToManyField(
        Norma,
        blank=True,  # Permite que um checklist não tenha nenhuma norma
        verbose_name="Normas Relacionadas"
    )

    # --- NOVOS CAMPOS PARA VERSIONAMENTO ---
    version = models.PositiveIntegerField(default=1, verbose_name="Versão")
    is_latest = models.BooleanField(
        default=True, verbose_name="É a versão mais recente")
    original_checklist = models.ForeignKey(
        'self',
        # Usar SET_NULL para não perder o histórico se o original for deletado
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='versions',
        verbose_name="Checklist Original"
    )
    # --- FIM DOS NOVOS CAMPOS ---
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Checklist"
        verbose_name_plural = "Checklists"
        ordering = ['nome']

    def __str__(self):
        return f"{self.nome} (V{self.version})"


class Topico(models.Model):
    checklist = models.ForeignKey(
        Checklist,
        on_delete=models.CASCADE,
        verbose_name="Checklist",
        related_name='topicos'
    )
    descricao = models.CharField(
        max_length=255, verbose_name="Descrição do Tópico")
    ordem = models.IntegerField(default=0, verbose_name="Ordem")

    class Meta:
        verbose_name = "Tópico"
        verbose_name_plural = "Tópicos"
        unique_together = ('checklist', 'descricao')
        ordering = ['ordem', 'descricao']

    def __str__(self):
        return self.descricao


class Pergunta(models.Model):
    topico = models.ForeignKey(
        Topico,
        on_delete=models.CASCADE,
        verbose_name="Tópico",
        related_name='perguntas'
    )
    descricao = models.TextField(verbose_name="Descrição da Pergunta")

    # Novos campos para tipos de resposta
    resposta_livre = models.BooleanField(
        default=False, verbose_name="Permitir Resposta Livre")
    foto = models.BooleanField(default=False, verbose_name="Permitir Foto")
    criar_opcao = models.BooleanField(
        default=True, verbose_name="Permitir Criar uma Opção")
    porcentagem = models.BooleanField(
        default=False, verbose_name="Permitir Porcentagem")

    # Campo para definir se a resposta é obrigatória
    obrigatoria = models.BooleanField(
        default=False, verbose_name="Resposta Obrigatória")

    campo_obrigatorio = models.BooleanField(
        default=False, verbose_name="Campo Obrigatório")
    campo_desabilitado = models.BooleanField(
        default=False, verbose_name="Campo Desabilitado")
    ordem = models.IntegerField(default=0, verbose_name="Ordem")

    class Meta:
        verbose_name = "Pergunta"
        verbose_name_plural = "Perguntas"
        unique_together = ('topico', 'descricao')
        ordering = ['ordem', 'descricao']

    def __str__(self):
        return self.descricao[:50] + '...' if len(self.descricao) > 50 else self.descricao


class OpcaoResposta(models.Model):
    pergunta = models.ForeignKey(
        Pergunta, on_delete=models.CASCADE, related_name='opcoes_resposta')
    descricao = models.CharField(
        max_length=255, verbose_name="Descrição da Opção")
    status = models.CharField(
        max_length=20,
        choices=[
            ('CONFORME', 'Conforme'),
            ('NAO_CONFORME', 'Não Conforme'),
            ('NA', 'N/A'),
        ],
        verbose_name="Status Vinculado"
    )
    # <-- ADICIONE ESTA LINHA
    ordem = models.IntegerField(default=0, verbose_name="Ordem")

    class Meta:
        verbose_name = "Opção de Resposta"
        verbose_name_plural = "Opções de Resposta"
        ordering = ['ordem', 'descricao']  # <-- MODIFIQUE ESTA LINHA

    def __str__(self):
        return f"{self.descricao} ({self.get_status_display()})"


class OpcaoPorcentagem(models.Model):
    pergunta = models.ForeignKey(
        Pergunta, on_delete=models.CASCADE, related_name='opcoes_porcentagem')
    descricao = models.CharField(max_length=255, verbose_name="Descrição")
    peso = models.PositiveIntegerField(verbose_name="Peso (%)")
    # Para armazenar o código hexadecimal da cor
    cor = models.CharField(max_length=7, default='#FFFFFF', verbose_name="Cor")
    # <-- ADICIONE ESTA LINHA
    ordem = models.IntegerField(default=0, verbose_name="Ordem")

    class Meta:
        verbose_name = "Opção de Porcentagem"
        verbose_name_plural = "Opções de Porcentagem"
        ordering = ['ordem', 'peso']  # <-- MODIFIQUE ESTA LINHA

    def __str__(self):
        return f"{self.descricao} - {self.peso}%"


class FerramentaCausaRaiz(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome da Ferramenta")

    class Meta:
        verbose_name = "Ferramenta de Causa Raiz"
        verbose_name_plural = "Ferramentas de Causa Raiz"
        ordering = ['nome']

    def __str__(self):
        return self.nome


class ModeloAuditoria(models.Model):
    descricao = models.CharField(
        max_length=255, verbose_name="Descrição do Modelo")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    iniciar_por_codigo_qr = models.BooleanField(
        default=False, verbose_name="Iniciar por Código QR")
    checklist = models.ForeignKey(
        Checklist,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Checklist",
        related_name='modelos_auditoria'
    )
    categoria = models.ForeignKey(
        CategoriaAuditoria,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Categoria",
        related_name='modelos_auditoria'
    )
    ferramenta_causa_raiz = models.ForeignKey(
        FerramentaCausaRaiz,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Ferramenta para Causa Raiz",
        related_name='modelos_auditoria'
    )
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Modelo de Auditoria"
        verbose_name_plural = "Modelos de Auditoria"
        ordering = ['descricao']

    def __str__(self):
        return self.descricao


NIVEIS_ORGANIZACIONAIS = [
    ('EMPRESA', 'Empresa'),
    ('AREA', 'Área'),
    ('SETOR', 'Setor'),
    ('SUBSETOR', 'Subsetor'),
]

CATEGORIAS_AUDITORIA = [
    ('APP', 'App'),
    ('WEB', 'Web'),
]

FREQUENCIAS_AGENDAMENTO = [
    ('DIARIO', 'Diário'),
    ('SEMANAL', 'Semanal'),
    ('QUINZENAL', 'Quinzenal'),
    ('MENSAL', 'Mensal'),
    ('ANUAL', 'Anual'),
]


class Auditoria(models.Model):
    criado_por = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Criado por",
        related_name='auditorias_criadas',  # 'related_name' para evitar conflito
        editable=False  # Impede que seja editado pelo painel de admin)
    )
    ferramenta = models.ForeignKey(
        FerramentaDigital,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Ferramenta Digital"
    )
    responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Responsável"
    )
    nivel_organizacional = models.CharField(
        max_length=50,
        choices=[
            ('EMPRESA', 'Empresa'),
            ('AREA', 'Área'),
            ('SETOR', 'Setor'),
            ('SUBSETOR', 'Subsetor'),
        ],
        verbose_name="Nível"
    )
    local_empresa = models.ForeignKey(
        'organizacao.Empresa',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Local (Empresa)"
    )
    local_area = models.ForeignKey(
        'organizacao.Area',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Local (Área)"
    )
    local_setor = models.ForeignKey(
        'organizacao.Setor',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Local (Setor)"
    )
    local_subsetor = models.ForeignKey(
        'organizacao.SubSetor',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Local (Subsetor)"
    )
    modelos = models.ManyToManyField(
        ModeloAuditoria, verbose_name="Modelos de Auditoria")

    # --- NOVO CAMPO ADICIONADO ---
    agendamento_especifico = models.BooleanField(
        default=False,
        verbose_name="Agendar para locais específicos",
        help_text="Se marcado, permite selecionar subsetores específicos. Se desmarcado, cria uma auditoria única para o nível selecionado (o local será escolhido no app)."
    )

    ativos_auditados = models.ManyToManyField(
        Ativo,
        verbose_name="Ativos Auditados",
        related_name='auditorias_agendadas',
        blank=True  # <-- MUDANÇA AQUI
    )
    categoria_auditoria = models.CharField(
        max_length=10,
        choices=CATEGORIAS_AUDITORIA,
        verbose_name="Categoria"
    )
    turnos = models.ManyToManyField(
        Turno,
        blank=True,
        verbose_name="Turnos"
    )
    data_inicio = models.DateField(verbose_name="Data de Início")
    data_fim = models.DateField(
        null=True, blank=True, verbose_name="Data de Fim")
    por_frequencia = models.BooleanField(
        default=False, verbose_name="Por Frequência")
    por_intervalo = models.BooleanField(
        default=False, verbose_name="Por Intervalo")
    frequencia = models.CharField(
        max_length=10,
        choices=FREQUENCIAS_AGENDAMENTO,
        null=True, blank=True,
        verbose_name="Frequência"
    )
    intervalo = models.IntegerField(
        null=True, blank=True, verbose_name="Intervalo")
    numero_repeticoes = models.IntegerField(
        null=True, blank=True, verbose_name="Número de Repetições")
    pular_finais_semana = models.BooleanField(
        default=False, verbose_name="Pular Finais de Semana")
    contem_turnos = models.BooleanField(
        default=False, verbose_name="Contém Turnos")
    data_criacao = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Criação")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Auditoria Agendada"
        verbose_name_plural = "Auditorias Agendadas"
        ordering = ['-data_criacao']

    def __str__(self):
        return f"Auditoria agendada para {self.get_nivel_organizacional_display()} - {self.data_inicio}"

    @property
    def get_programacao_display(self):
        """ Retorna uma string descrevendo o tipo de agendamento. """
        if self.por_frequencia and self.frequencia:
            # get_frequencia_display() pega o nome legível (ex: 'Semanal')
            return f"Frequência ({self.get_frequencia_display()})"
        elif self.por_intervalo and self.intervalo:
            return f"Intervalo de {self.intervalo} dia(s)"
        else:
            # Se não for por frequência nem intervalo, é uma auditoria de data única
            return "Dia Único"

    def save(self, *args, **kwargs):
        """
        Sobrescrevemos o save apenas para garantir a chamada do método pai.
        Toda a lógica de criação de instâncias foi movida para as views.
        """
        super().save(*args, **kwargs)


class AuditoriaInstancia(models.Model):
    auditoria_agendada = models.ForeignKey(
        Auditoria,
        on_delete=models.CASCADE,
        verbose_name="Auditoria Agendada",
        related_name='instancias'
    )

    # --- NOVO CAMPO PARA VINCULAR A VERSÃO EXATA DO CHECKLIST ---
    checklist_usado = models.ForeignKey(
        Checklist,
        on_delete=models.PROTECT,  # Protege contra a exclusão do checklist se houver auditorias
        null=True, blank=True,
        verbose_name="Checklist Utilizado"
    )
    # --- FIM DO NOVO CAMPO ---

    turno = models.ForeignKey(
        Turno,
        on_delete=models.CASCADE,
        null=True, blank=True,
        verbose_name="Turno de Execução"
    )

    responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Auditor da Execução")

    local_execucao = models.ForeignKey(
        SubSetor,
        on_delete=models.CASCADE,
        null=True, blank=True,
        verbose_name="Local de Execução (Subsetor)")

    data_execucao = models.DateField(verbose_name="Data de Execução")
    executada = models.BooleanField(default=False, verbose_name="Executada?")

    @property
    def status(self):
        """Calcula o status desta instância específica."""
        if self.executada:
            return "Concluída"

        if self.data_execucao < timezone.now().date():
            return "Atrasada"

        return "Pendente"
    # --- FIM DA ADIÇÃO ---

    @property
    def status_execucao(self):
        """ Retorna o status específico para a tela de execuções, considerando a frequência. """
        today = timezone.now().date()

        if self.executada:
            return "Concluída"

        # Se a data de execução ainda está no futuro, está 'Agendada'
        if self.data_execucao > today:
            return "Agendada"

        # Se a data de execução é hoje, está 'Pendente'
        if self.data_execucao == today:
            return "Pendente"

        # Se a data de execução já passou, verificamos se está em atraso real
        if self.data_execucao < today:
            agendamento = self.auditoria_agendada
            # Padrão de 1 dia para auditorias únicas
            grace_period = timedelta(days=1)

            if agendamento.por_frequencia and agendamento.frequencia:
                if agendamento.frequencia == 'DIARIO':
                    grace_period = timedelta(days=1)
                elif agendamento.frequencia == 'SEMANAL':
                    grace_period = timedelta(weeks=1)
                elif agendamento.frequencia == 'QUINZENAL':
                    grace_period = timedelta(weeks=2)
                elif agendamento.frequencia == 'MENSAL':
                    grace_period = relativedelta(months=1)
                elif agendamento.frequencia == 'ANUAL':
                    grace_period = relativedelta(years=1)

            elif agendamento.por_intervalo and agendamento.intervalo:
                grace_period = timedelta(days=agendamento.intervalo + 1)

            # A data limite é a data programada + o período de carência
            data_limite = self.data_execucao + grace_period

            if today >= data_limite:
                return "Atraso"
            else:
                # Se a data de hoje ainda está dentro do período de carência, continua pendente
                return "Pendente"

        return "Pendente"  # Fallback para o dia de hoje

    def get_data_conclusao(self):
        """Retorna a data e hora da última resposta enviada para esta instância."""
        ultima_resposta = self.respostas.order_by('-data_resposta').first()
        if ultima_resposta:
            return ultima_resposta.data_resposta
        return None

    def get_total_perguntas(self):
        """
        Calcula o número total de perguntas DO CHECKLIST ESPECÍFICO
        usado para esta instância.
        """
        # --- ALTERAÇÃO AQUI ---
        # A lógica antiga olhava para o agendamento pai, que sempre tem a última versão.
        # A nova lógica olha para o checklist exato que foi salvo nesta instância.
        if self.checklist_usado:
            return Pergunta.objects.filter(topico__checklist=self.checklist_usado).count()

        # Se por algum motivo não houver um checklist vinculado, retorna 0 para evitar erros.
        return 0

    def get_percentual_conclusao(self):
        """Calcula e formata o percentual de respostas concluídas."""
        total_perguntas = self.get_total_perguntas()
        respostas_dadas = self.respostas.count()

        if total_perguntas == 0:
            return 0.0  # Evita divisão por zero se não houver perguntas

        percentual = (respostas_dadas / total_perguntas) * 100
        return round(percentual, 2)

    # --- FIM DA ADIÇÃO ---

    class Meta:
        verbose_name = "Instância de Auditoria"
        verbose_name_plural = "Instâncias de Auditoria"
        ordering = ['data_execucao']

    def __str__(self):
        return f"Execução em {self.data_execucao} de {self.auditoria_agendada}"


class Resposta(models.Model):

    auditoria_instancia = models.ForeignKey(
        AuditoriaInstancia,
        on_delete=models.CASCADE,
        related_name='respostas',
        verbose_name="Instância da Auditoria"
    )
    pergunta = models.ForeignKey(
        Pergunta,
        on_delete=models.CASCADE,
        related_name='respostas',
        verbose_name="Pergunta"
    )
    # Campos para cada tipo de resposta possível (a maioria será nula)
    opcao_resposta = models.ForeignKey(
        OpcaoResposta,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Opção de Resposta Selecionada"
    )
    opcao_porcentagem = models.ForeignKey(
        OpcaoPorcentagem,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Opção de Porcentagem Selecionada"
    )
    resposta_livre_texto = models.TextField(
        null=True, blank=True,
        verbose_name="Texto da Resposta Livre (Observações)"
    )

    # --- CAMPOS ADICIONADOS ---
    # Para "Oportunidade de Melhoria" = Sim
    descricao_oportunidade_melhoria = models.TextField(
        null=True, blank=True,
        verbose_name="Descrição da Oportunidade de Melhoria"
    )
    # Para "Desvio Solucionado" = Sim
    descricao_desvio_solucionado = models.TextField(
        null=True, blank=True,
        verbose_name="Descrição do Desvio Solucionado"
    )
    # Para "Desvio Solucionado" = Não
    descricao_desvio_nao_solucionado = models.TextField(
        null=True, blank=True,
        verbose_name="Descrição do Desvio (Não Solucionado)"
    )
    # --- FIM DOS CAMPOS ADICIONADOS ---

    # --- ADICIONE OS CAMPOS ABAIXO ---
    oportunidade_melhoria = models.BooleanField(
        null=True, blank=True, verbose_name="Oportunidade de Melhoria"
    )
    desvio_solucionado = models.BooleanField(
        null=True, blank=True, verbose_name="Desvio Solucionado na Hora"
    )
    grau_nc = models.CharField(
        max_length=20,
        null=True, blank=True,
        choices=[('NC MAIOR', 'NC Maior'), ('NC MENOR', 'NC Menor')],
        verbose_name="Grau da Não Conformidade"
    )
    data_resposta = models.DateTimeField(
        verbose_name="Data da Resposta", null=True, blank=True)

    class Meta:
        verbose_name = "Resposta"
        verbose_name_plural = "Respostas"
        unique_together = ('auditoria_instancia', 'pergunta')

    def __str__(self):
        return f"Resposta para '{self.pergunta.descricao[:30]}...' na auditoria {self.auditoria_instancia.id}"


class AnexoResposta(models.Model):
    """
    Armazena os arquivos (fotos) anexados a uma resposta.
    """
    resposta = models.ForeignKey(
        Resposta,
        on_delete=models.CASCADE,
        related_name='anexos',
        verbose_name="Resposta"
    )
    arquivo = models.FileField(
        upload_to='anexos_respostas/', verbose_name="Arquivo")
    data_upload = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Anexo da Resposta"
        verbose_name_plural = "Anexos das Respostas"

    def __str__(self):
        return f"Anexo para a resposta {self.resposta.id}"


class PlanoDeAcao(models.Model):
    """
    Armazena uma ação corretiva ou de melhoria gerada a partir
    de uma resposta de auditoria.
    """
    TIPOS_PLANO = (
        ('NAO_CONFORMIDADE', 'Não Conformidade'),
        ('OPORTUNIDADE_MELHORIA', 'Oportunidade de Melhoria'),
    )

    STATUS_PLANO = (
        ('ABERTO', 'Recebido'),  # 1. Nasce aqui
        # 2. Responsável propôs, Auditor avalia
        ('AGUARDANDO_VALIDACAO', 'Aguardando Validação'),
        # 3. Aprovado, Responsável executa
        ('EM_IMPLEMENTACAO', 'Em Implementação'),
        # 4. Feito, Auditor confere
        ('AGUARDANDO_APROVACAO', 'Aguardando Aprovação'),
        # 5. (Opcional) Ciclo extra
        ('VALIDACAO_EFICACIA', 'Validação de Eficácia'),
        ('CONCLUIDO', 'Concluído'),  # 6. Fim
        ('CANCELADO', 'Cancelado'),
        ('ARQUIVADO', 'Arquivado'),
    )

    # --- Vínculo com a Resposta que gerou o plano ---
    origem_resposta = models.ForeignKey(
        Resposta,
        on_delete=models.CASCADE,
        related_name='planos_de_acao',
        verbose_name="Resposta de Origem",
        null=True,   # <--- Essencial para o banco aceitar vazio
        blank=True   # <--- Essencial para o formulário/admin aceitar vazio
    )

    forum = models.OneToOneField(
        'planos_de_acao.Forum',  # <-- MUDANÇA AQUI
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Fórum de Discussão",
        related_name='plano_de_acao'
    )

    # --- Informações copiadas para o "snapshot" ---
    tipo = models.CharField(
        max_length=50, choices=TIPOS_PLANO, verbose_name="Tipo de Ação")
    titulo = models.TextField(verbose_name="Título (Descrição da Pergunta)")
    local_execucao = models.ForeignKey(
        SubSetor,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Local de Execução"
    )
    ferramenta = models.ForeignKey(
        FerramentaDigital,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Ferramenta"
    )
    categoria = models.ForeignKey(
        CategoriaAuditoria,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Categoria da Auditoria"
    )
    data_abertura = models.DateTimeField(
        verbose_name="Data da Ocorrência")

    # --- Gerenciamento do Plano ---
    responsavel_acao = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Responsável pela Ação",
        related_name='planos_de_acao_responsaveis'
    )
    status_plano = models.CharField(
        max_length=50,
        choices=STATUS_PLANO,
        # <--- Garante que nasce como 'ABERTO' (que agora exibe "Recebido")
        default='ABERTO',
        verbose_name="Status"
    )
    prazo_conclusao = models.DateField(
        null=True, blank=True, verbose_name="Prazo de Conclusão")
    data_conclusao = models.DateTimeField(
        null=True, blank=True, verbose_name="Data de Conclusão")

    # --- Campos para a tratativa ---
    descricao_causa_raiz = models.TextField(
        null=True, blank=True, verbose_name="Descrição da Causa Raiz")
    descricao_acao = models.TextField(
        null=True, blank=True, verbose_name="Descrição da Ação Corretiva/Melhoria")

    descricao_acao_realizada = models.TextField(
        null=True, blank=True, verbose_name="Ações Realizadas na Conclusão")

    observacao_eficacia = models.TextField(
        null=True, blank=True, verbose_name="Observação da Eficácia")

    motivo_arquivamento = models.TextField(
        null=True,
        blank=True,
        verbose_name="Motivo do Arquivamento"
    )

    # Campo para a data preenchida no modal "Aceitar"
    data_finalizacao_prevista = models.DateField(
        null=True, blank=True, verbose_name="Data Finalização Prevista"
    )

    motivo_recusa = models.TextField(
        null=True, blank=True, verbose_name="Motivo da Recusa/Devolução")

    orientacoes_extra = models.TextField(
        null=True, blank=True, verbose_name="Orientações Adicionais (Clonagem)")

    origem_orientacao = models.CharField(
        max_length=20,
        choices=[('CLONAGEM', 'Clonagem'),
                 ('REDIRECIONAMENTO', 'Redirecionamento')],
        null=True, blank=True,
        verbose_name="Origem da Orientação"
    )

    criado_por = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Criado por (Auditor Manual)",
        related_name='planos_manuais'
    )

    observacao_origem = models.TextField(
        null=True, blank=True,
        verbose_name="Observação de Origem (Manual)"
    )

    fluxo_simplificado = models.BooleanField(
        default=False,
        verbose_name="Fluxo Simplificado (Sem Aprovações)"
    )

    class Meta:
        verbose_name = "Plano de Ação"
        verbose_name_plural = "Planos de Ação"
        ordering = ['-data_abertura']

    def __str__(self):
        return f"Plano #{self.id} - {self.get_tipo_display()}"


class Investimento(models.Model):
    plano = models.ForeignKey(
        PlanoDeAcao,
        on_delete=models.CASCADE,
        related_name='investimentos',
        verbose_name="Plano de Ação"
    )
    descricao = models.TextField(verbose_name="Descrição do Investimento")
    quantidade = models.PositiveIntegerField(
        default=1, verbose_name="Quantidade")
    valor_unitario = models.DecimalField(
        max_digits=10, decimal_places=2, verbose_name="Preço Unitário")
    data_registro = models.DateTimeField(auto_now_add=True)

    @property
    def valor_total(self):
        return self.quantidade * self.valor_unitario

    class Meta:
        verbose_name = "Investimento"
        verbose_name_plural = "Investimentos"


class EvidenciaPlano(models.Model):
    plano = models.ForeignKey(
        PlanoDeAcao,
        on_delete=models.CASCADE,
        related_name='evidencias',
        verbose_name="Plano de Ação"
    )
    arquivo = models.FileField(
        upload_to='evidencias_planos/', verbose_name="Arquivo")
    data_upload = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Evidência do Plano"
        verbose_name_plural = "Evidências do Plano"


class HistoricoPlanoAcao(models.Model):
    plano = models.ForeignKey(
        PlanoDeAcao,
        on_delete=models.CASCADE,
        related_name='historico',
        verbose_name="Plano de Ação"
    )
    usuario = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Usuário"
    )
    descricao = models.TextField(verbose_name="Descrição do Evento")
    data_registro = models.DateTimeField(auto_now_add=True)

    # Tipo de evento para facilitar ícones no frontend (opcional, mas recomendado)
    TIPO_EVENTO = (
        ('CRIACAO', 'Criação'),
        ('STATUS', 'Mudança de Status'),
        ('EDICAO', 'Edição'),
        ('ANEXO', 'Anexo'),
        ('REDISTRIBUICAO', 'Redistribuição'),
        ('PRAZO', 'Alteração de Prazo'),
    )
    tipo = models.CharField(
        max_length=20, choices=TIPO_EVENTO, default='STATUS')

    class Meta:
        ordering = ['-data_registro']  # Do mais recente para o mais antigo

    def __str__(self):
        return f"{self.plano.id} - {self.descricao}"

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\serializers.py

# auditorias/serializers.py

from rest_framework import serializers
from .models import (
    Auditoria, AuditoriaInstancia, Checklist, Topico, Pergunta,
    OpcaoResposta, OpcaoPorcentagem, Resposta, AnexoResposta, PlanoDeAcao
)
import base64
import uuid
from django.core.files.base import ContentFile
from django.utils import timezone

from planos_de_acao.models import Forum

# --- CAMPO Base64 CORRIGIDO E MELHORADO ---
# Renomeado para Base64FileField para ser mais genérico


class Base64FileField(serializers.FileField):
    """
    Um campo de serializer que lida com arquivos codificados em Base64,
    aceitando tanto o formato raw quanto o formato com prefixo "data:".
    """

    def to_internal_value(self, data):
        # Verifica se o dado é uma string Base64
        if isinstance(data, str):
            # Se tiver o prefixo 'data:[...];base64,', remove-o
            if 'base64,' in data:
                header, data = data.split(';base64,')

            try:
                # Decodifica os dados e cria um ContentFile
                decoded_file = base64.b64decode(data)
                # Gera um nome de arquivo único. Você pode adicionar uma extensão padrão se quiser.
                file_name = str(uuid.uuid4())[:12]
                # Usa o ContentFile que o Django entende
                data = ContentFile(decoded_file, name=f'{file_name}.jpg')
            except (TypeError, ValueError):
                self.fail('invalid_file')

        return super().to_internal_value(data)

# --- O RESTO DOS SERIALIZERS CONTINUA IGUAL ---


class OpcaoRespostaSerializer(serializers.ModelSerializer):
    class Meta:
        model = OpcaoResposta
        fields = ['id', 'descricao', 'status']

# ... (outros serializers como OpcaoPorcentagemSerializer, PerguntaSerializer, etc. continuam aqui sem alterações) ...


class OpcaoPorcentagemSerializer(serializers.ModelSerializer):
    class Meta:
        model = OpcaoPorcentagem
        fields = ['id', 'descricao', 'peso', 'cor']


class PerguntaSerializer(serializers.ModelSerializer):
    opcoes_resposta = OpcaoRespostaSerializer(many=True, read_only=True)
    opcoes_porcentagem = OpcaoPorcentagemSerializer(many=True, read_only=True)

    class Meta:
        model = Pergunta
        fields = [
            'id', 'descricao', 'ordem', 'obrigatoria',
            'resposta_livre', 'foto', 'criar_opcao', 'porcentagem',
            'opcoes_resposta', 'opcoes_porcentagem'
        ]


class TopicoSerializer(serializers.ModelSerializer):
    perguntas = PerguntaSerializer(many=True, read_only=True)

    class Meta:
        model = Topico
        fields = ['id', 'descricao', 'ordem', 'perguntas']


class ChecklistSerializer(serializers.ModelSerializer):
    topicos = TopicoSerializer(many=True, read_only=True)

    class Meta:
        model = Checklist
        fields = ['id', 'nome', 'topicos']


class AuditoriaPaiSerializer(serializers.ModelSerializer):
    """ Serializer enriquecido para a Auditoria 'pai' """
    modelo_auditoria_nome = serializers.SerializerMethodField()
    checklist_nome = serializers.SerializerMethodField()
    local_nome = serializers.SerializerMethodField()
    data_criacao = serializers.DateTimeField(format="%d/%m/%Y", read_only=True)
    ferramenta_nome = serializers.CharField(
        source='ferramenta.nome', read_only=True)
    programacao = serializers.CharField(
        source='get_programacao_display', read_only=True)
    criado_por_nome = serializers.CharField(
        source='criado_por.get_full_name', read_only=True, default='Sistema')

    class Meta:
        model = Auditoria
        fields = [
            'id',
            'data_criacao',
            'modelo_auditoria_nome',
            'checklist_nome',
            'local_nome',
            'ferramenta_nome',
            'programacao',
            'criado_por_nome',
        ]

    def get_modelo_auditoria_nome(self, obj):
        primeiro_modelo = obj.modelos.first()
        return primeiro_modelo.descricao if primeiro_modelo else 'N/A'

    def get_checklist_nome(self, obj):
        primeiro_modelo = obj.modelos.first()
        if primeiro_modelo and primeiro_modelo.checklist:
            return primeiro_modelo.checklist.nome
        return 'N/A'

    def get_local_nome(self, obj):
        if obj.nivel_organizacional == 'SUBSETOR' and obj.local_subsetor:
            return obj.local_subsetor.nome
        if obj.nivel_organizacional == 'SETOR' and obj.local_setor:
            return obj.local_setor.nome
        if obj.nivel_organizacional == 'AREA' and obj.local_area:
            return obj.local_area.nome
        if obj.nivel_organizacional == 'EMPRESA' and obj.local_empresa:
            return obj.local_empresa.nome
        return 'Local não definido'


class AuditoriaInstanciaDetailSerializer(serializers.ModelSerializer):
    checklist = serializers.SerializerMethodField()

    class Meta:
        model = AuditoriaInstancia
        fields = ['id', 'data_execucao', 'checklist']

    def get_checklist(self, obj):
        if obj.checklist_usado:
            return ChecklistSerializer(obj.checklist_usado).data
        return None


class AuditoriaInstanciaListSerializer(serializers.ModelSerializer):
    auditoria_info = AuditoriaPaiSerializer(
        source='auditoria_agendada', read_only=True)
    status = serializers.CharField(source='status_execucao', read_only=True)

    local_execucao_nome = serializers.CharField(
        source='local_execucao.nome', read_only=True, default='N/A')

    # Precisamos do ID para saber se a auditoria é "flutuante" (null)
    local_execucao_id = serializers.IntegerField(
        source='local_execucao.id', read_only=True, allow_null=True)

    total_perguntas = serializers.IntegerField(
        source='get_total_perguntas', read_only=True)

    class Meta:
        model = AuditoriaInstancia
        fields = [
            'id',
            'data_execucao',
            'executada',
            'status',
            'auditoria_info',
            'local_execucao_nome',
            'local_execucao_id',
            'total_perguntas',
        ]


class RespostaSerializer(serializers.ModelSerializer):
    pergunta_id = serializers.IntegerField(write_only=True)
    # --- ATUALIZADO: Usando o novo campo Base64FileField ---
    anexos_base64 = serializers.ListField(
        child=Base64FileField(),  # <<<--- MUDANÇA AQUI
        required=False,
        write_only=True
    )

    class Meta:
        model = Resposta
        fields = [
            'pergunta_id',
            'opcao_resposta',
            'opcao_porcentagem',
            'resposta_livre_texto',
            'anexos_base64',
            'oportunidade_melhoria',
            'desvio_solucionado',
            'grau_nc',
            'data_resposta',
            # --- CAMPOS ADICIONADOS ---
            'descricao_oportunidade_melhoria',
            'descricao_desvio_solucionado',
            'descricao_desvio_nao_solucionado',
            # --- FIM DOS CAMPOS ADICIONADOS ---
        ]

    def create(self, validated_data):
        anexos_data = validated_data.pop('anexos_base64', [])
        instancia = self.context['auditoria_instancia']

        resposta, created = Resposta.objects.update_or_create(
            auditoria_instancia=instancia,
            pergunta_id=validated_data.get('pergunta_id'),
            defaults=validated_data
        )

        for anexo_file in anexos_data:
            AnexoResposta.objects.create(resposta=resposta, arquivo=anexo_file)

        # --- LÓGICA PARA CRIAR O PLANO DE AÇÃO ---
        self.criar_plano_de_acao_se_necessario(resposta)
        # --- FIM DA LÓGICA ---

        return resposta

    def criar_plano_de_acao_se_necessario(self, resposta):
        """
        Verifica a resposta e cria um Plano de Ação se for uma
        Não Conformidade (e não tiver sido solucionada) ou Oportunidade de Melhoria.
        """
        instancia = resposta.auditoria_instancia
        agendamento = instancia.auditoria_agendada

        tipo_plano = None

        # 1. Verifica se é Não Conformidade
        if resposta.opcao_resposta and resposta.opcao_resposta.status == 'NAO_CONFORME':
            # --- CORREÇÃO AQUI ---
            # Só cria o plano se o desvio NÃO foi solucionado na hora
            if not resposta.desvio_solucionado:
                tipo_plano = 'NAO_CONFORMIDADE'
            # ---------------------

        # 2. Verifica se é Oportunidade de Melhoria
        elif resposta.oportunidade_melhoria == True:
            tipo_plano = 'OPORTUNIDADE_MELHORIA'

        if tipo_plano:
            # Pega a categoria do primeiro modelo (pode ajustar se houver múltiplos)
            categoria_auditoria = None
            primeiro_modelo = agendamento.modelos.first()
            if primeiro_modelo:
                categoria_auditoria = primeiro_modelo.categoria

            # Busca o responsável pela ação com base no local de execução
            responsavel_do_local = None
            if instancia.local_execucao:
                responsavel_do_local = instancia.local_execucao.usuario_responsavel

            # Verifica se já existe um plano (e, por extensão, um fórum)
            plano_existente = PlanoDeAcao.objects.filter(
                origem_resposta=resposta).first()

            # Se o plano não existir, crie um novo fórum para ele
            if not plano_existente:
                novo_forum = Forum.objects.create(
                    nome=f"Discussão Plano #{resposta.pergunta.descricao[:50]}..."
                )
            else:
                novo_forum = plano_existente.forum  # Reutiliza o fórum existente

            # Cria ou atualiza o plano de ação
            PlanoDeAcao.objects.update_or_create(
                origem_resposta=resposta,
                defaults={
                    'tipo': tipo_plano,
                    'titulo': resposta.pergunta.descricao,
                    'local_execucao': instancia.local_execucao,
                    'ferramenta': agendamento.ferramenta,
                    'categoria': categoria_auditoria,
                    'data_abertura': resposta.data_resposta or timezone.now(),
                    'responsavel_acao': responsavel_do_local,
                    'forum': novo_forum
                }
            )

        # 3. Se a resposta foi corrigida (não é mais NC nem Oportunidade)
        # OU SE FOI MARCADO COMO DESVIO SOLUCIONADO (tipo_plano continuará None)
        # e um plano já existia, devemos excluí-lo.
        elif not tipo_plano:
            # Encontra e deleta qualquer plano de ação obsoleto
            PlanoDeAcao.objects.filter(origem_resposta=resposta).delete()

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\urls.py

# auditorias/urls.py

from django.urls import path
from . import views

app_name = 'auditorias'

urlpatterns = [
    path('dashboard/', views.dashboard_auditorias, name='dashboard'),

    path('pilares/', views.lista_pilares, name='lista_pilares'),
    path('pilares/criar/', views.criar_pilar, name='criar_pilar'),
    path('pilares/<int:pk>/editar/', views.editar_pilar, name='editar_pilar'),
    path('pilares/<int:pk>/deletar/', views.deletar_pilar, name='deletar_pilar'),
    path('pilares/exportar-csv/', views.exportar_pilares_csv,
         name='exportar_pilares_csv'),  # NOVO

    path('categorias/', views.lista_categorias_auditoria,
         name='lista_categorias_auditoria'),
    path('categorias/criar/', views.criar_categoria_auditoria,
         name='criar_categoria_auditoria'),
    path('categorias/<int:pk>/editar/', views.editar_categoria_auditoria,
         name='editar_categoria_auditoria'),
    path('categorias/<int:pk>/deletar/', views.deletar_categoria_auditoria,
         name='deletar_categoria_auditoria'),
    path('categorias/exportar-csv/', views.exportar_categorias_auditoria_csv,
         name='exportar_categorias_auditoria_csv'),  # NOVO

    path('normas/', views.lista_normas, name='lista_normas'),
    path('normas/criar/', views.criar_norma, name='criar_norma'),
    path('normas/<int:pk>/editar/', views.editar_norma, name='editar_norma'),
    path('normas/<int:pk>/deletar/', views.deletar_norma, name='deletar_norma'),
    path('normas/exportar-csv/', views.exportar_normas_csv,
         name='exportar_normas_csv'),  # NOVO

    path('ferramentas-digitais/', views.lista_ferramentas_digitais,
         name='lista_ferramentas_digitais'),

    path('checklists/', views.lista_checklists, name='lista_checklists'),
    path('checklists/criar/', views.criar_checklist, name='criar_checklist'),
    path('checklists/<int:pk>/editar/',
         views.editar_checklist, name='editar_checklist'),
    path('checklists/<int:pk>/deletar/',
         views.deletar_checklist, name='deletar_checklist'),
    path('checklists/exportar-csv/', views.exportar_checklists_csv,
         name='exportar_checklists_csv'),  # NOVO

    path('modelos-auditoria/', views.lista_modelos_auditoria,
         name='lista_modelos_auditoria'),
    path('modelos-auditoria/criar/', views.criar_modelo_auditoria,
         name='criar_modelo_auditoria'),
    path('modelos-auditoria/<int:pk>/editar/',
         views.editar_modelo_auditoria, name='editar_modelo_auditoria'),
    path('modelos-auditoria/exportar-csv/', views.exportar_modelos_auditoria_csv,
         name='exportar_modelos_auditoria_csv'),  # NOVO

    path('agendamentos/<int:pk>/redirecionar/',
         views.redirecionar_agendamento, name='redirecionar_agendamento'),
    path('execucoes/<int:pk>/redirecionar/',
         views.redirecionar_execucao, name='redirecionar_execucao'),

    path('modelos-auditoria/<int:pk>/deletar/',
         views.deletar_modelo_auditoria, name='deletar_modelo_auditoria'),

    path('auditorias/', views.lista_auditorias, name='lista_auditorias'),
    path('auditorias/criar/', views.criar_auditoria, name='criar_auditoria'),
    path('auditorias/<int:pk>/editar/',
         views.editar_auditoria, name='editar_auditoria'),
    path('auditorias/<int:pk>/deletar/',
         views.deletar_auditoria, name='deletar_auditoria'),

    path('ajax/areas-por-empresa/', views.get_areas_por_empresa,
         name='get_areas_por_empresa'),
    path('ajax/setores-por-area/', views.get_setores_por_area,
         name='get_setores_por_area'),
    path('ajax/subsetores-por-setor/', views.get_subsetores_por_setor,
         name='get_subsetores_por_setor'),
    path('ajax/ativos-por-local/', views.get_ativos_por_local,
         name='get_ativos_por_local'),

    # --- ADICIONE ESTA NOVA URL ABAIXO ---
    path('ajax/get-subsetores-por-nivel/', views.get_subsetores_por_nivel,
         name='get_subsetores_por_nivel'),

    path('ajax/preview-dates/', views.preview_audit_dates,
         name='preview_audit_dates'),

    path('execucoes/', views.lista_execucoes, name='lista_execucoes'),

    path('historico/', views.historico_concluidas, name='historico_concluidas'),

    path('execucoes/<int:pk>/deletar/',
         views.deletar_execucao, name='deletar_execucao'),

    path('checklists/<int:pk>/historico/',
         views.historico_versoes_checklist, name='historico_versoes_checklist'),

    path('checklists/<int:pk>/comparar/', views.comparar_versoes_checklist,
         name='comparar_versoes_checklist'),

    path('historico/<int:pk>/detalhes/',
         views.detalhes_auditoria, name='detalhes_auditoria'),


    path('historico/<int:pk>/visualizar/',
         views.detalhes_historico_auditoria, name='detalhes_historico_auditoria'),

    path('planos-de-acao/', views.lista_planos_de_acao,
         name='lista_planos_de_acao'),

    path('planos-de-acao/<int:pk>/arquivar/',
         views.arquivar_plano, name='arquivar_plano'),

    path('planos-de-acao/api/<int:pk>/detalhes/',
         views.get_detalhes_plano, name='api_detalhes_plano'),

    path('planos-de-acao/api/<int:pk>/aceitar/',
         views.aceitar_plano, name='api_aceitar_plano'),

    path('planos-de-acao/api/<int:pk>/aprovar-planejamento/',
         views.aprovar_planejamento, name='api_aprovar_planejamento'),

    path('planos-de-acao/api/<int:pk>/investir/',
         views.adicionar_investimento, name='api_adicionar_investimento'),

    path('planos-de-acao/api/<int:pk>/concluir/',
         views.concluir_planejamento, name='api_concluir_planejamento'),

    path('planos-de-acao/api/<int:pk>/avaliar-conclusao/',
         views.avaliar_conclusao, name='api_avaliar_conclusao'),

    path('planos-de-acao/api/<int:pk>/validar-eficacia/',
         views.validar_eficacia, name='api_validar_eficacia'),

    path('planos-de-acao/api/<int:pk>/recusar/',
         views.recusar_plano, name='api_recusar_plano'),

    path('planos-de-acao/api/<int:pk>/clonar/',
         views.clonar_plano, name='api_clonar_plano'),

    path('planos-de-acao/api/<int:pk>/alterar-prazo/',
         views.alterar_prazo, name='api_alterar_prazo'),

    path('planos-de-acao/api/<int:pk>/redirecionar/',
         views.redirecionar_plano, name='api_redirecionar_plano'),

    path('planos-de-acao/api/forum/<int:forum_id>/mensagens/',
         views.api_listar_mensagens, name='api_listar_mensagens'),
    path('planos-de-acao/api/forum/<int:forum_id>/enviar/',
         views.api_enviar_mensagem, name='api_enviar_mensagem'),

    path('planos-de-acao/criar-manual/',
         views.criar_plano_manual, name='criar_plano_manual'),

    path('planos-de-acao/dashboard/',
         views.dashboard_planos_de_acao, name='dashboard_planos'),

    path('ajax/calendario-dados/', views.get_dados_calendario,
         name='get_dados_calendario'),

    path('quarentena/', views.lista_quarentena, name='lista_quarentena'),

]

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\views.py

# auditorias/views.py

from datetime import timedelta
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.db.models import Q
from django.http import JsonResponse
from django.urls import reverse
from django.views.decorators.http import require_http_methods
from django.views.decorators.csrf import csrf_exempt
import json
from datetime import datetime, timedelta
from dateutil.relativedelta import relativedelta
import csv
from django.http import HttpResponse
from django.db.models import Q, Count
from rest_framework.response import Response
from rest_framework.views import APIView
from rest_framework import status
from .serializers import RespostaSerializer

from planos_de_acao.models import Forum, MensagemForum

from django.views.decorators.http import require_POST

# Altere ListAPIView para incluir RetrieveAPIView
from rest_framework.generics import ListAPIView, RetrieveAPIView
from rest_framework.permissions import IsAuthenticated
# Altere a importação dos serializers
from .serializers import AuditoriaInstanciaListSerializer, AuditoriaInstanciaDetailSerializer

from .models import (
    Pilar, CategoriaAuditoria, Norma, RequisitoNorma, FerramentaDigital,
    Checklist, Topico, Pergunta, OpcaoResposta, OpcaoPorcentagem,
    FerramentaCausaRaiz, ModeloAuditoria, Auditoria, AuditoriaInstancia, Resposta,
    CATEGORIAS_AUDITORIA, PlanoDeAcao, Investimento, EvidenciaPlano, HistoricoPlanoAcao
)
from organizacao.models import Empresa, Area, Setor, SubSetor
from ativos.models import Ativo
from cadastros_base.models import Turno
from usuarios.models import Usuario

from django.db.models import Min, Max
from django.db.models import Max, Q
from django.db.models import Q, F, Value
from django.db.models.functions import Concat

from django.utils import timezone

from datetime import date, timedelta

from django.db.models import F, ExpressionWrapper, fields

from django.db import transaction

from django.db.models.functions import TruncMonth
from django.db.models import Count, Q

import json

from calendar import monthrange
from datetime import date

# ============================================================================
# VIEWS PRINCIPAIS - DASHBOARD E LISTAGENS
# ============================================================================


def registrar_historico(plano, usuario, descricao, tipo='STATUS'):
    """Função auxiliar para registrar eventos no histórico."""
    HistoricoPlanoAcao.objects.create(
        plano=plano,
        usuario=usuario,
        descricao=descricao,
        tipo=tipo
    )


@login_required
def dashboard_auditorias(request):
    # 1. Filtros Básicos (Por padrão, ano atual)
    ano_atual = timezone.now().year
    qs_instancias = AuditoriaInstancia.objects.filter(
        data_execucao__year=ano_atual)

    # 2. KPIs Principais
    total_planejadas = qs_instancias.count()
    total_realizadas = qs_instancias.filter(executada=True).count()

    eficiencia = 0
    if total_planejadas > 0:
        eficiencia = (total_realizadas / total_planejadas) * 100

    # Total de Itens Não Conformes (Respostas NC em auditorias deste ano)
    total_nc = Resposta.objects.filter(
        auditoria_instancia__in=qs_instancias,
        opcao_resposta__status='NAO_CONFORME'
    ).count()

    # 3. Gráfico: Planejado vs Realizado por Mês (Barras Agrupadas)
    dados_mensais = qs_instancias.annotate(
        mes=TruncMonth('data_execucao')
    ).values('mes').annotate(
        planejado=Count('id'),
        realizado=Count('id', filter=Q(executada=True))
    ).order_by('mes')

    # Jan, Fev...
    meses_labels = [d['mes'].strftime('%b') for d in dados_mensais]
    series_planejado = [d['planejado'] for d in dados_mensais]
    series_realizado = [d['realizado'] for d in dados_mensais]

    # 4. Gráfico: Auditorias por Local (Top 10)
    # Tenta pegar o subsetor, se não tiver, pega o setor
    locais_data = qs_instancias.values(
        'local_execucao__nome'
    ).annotate(qtd=Count('id')).order_by('-qtd')[:10]

    # Limpeza de nomes (trata auditorias sem local definido ainda)
    locais_labels = [l['local_execucao__nome'] if l['local_execucao__nome']
                     else 'Não Definido' for l in locais_data]
    locais_series = [l['qtd'] for l in locais_data]

    # 5. Gráfico: Conformidade Geral (Pizza)
    # Conta total de respostas avaliadas no período
    total_respostas = Resposta.objects.filter(
        auditoria_instancia__in=qs_instancias).count()
    total_respostas_nc = Resposta.objects.filter(
        auditoria_instancia__in=qs_instancias,
        opcao_resposta__status='NAO_CONFORME'
    ).count()

    total_conforme = total_respostas - total_respostas_nc

    # Evita gráfico vazio
    if total_respostas == 0:
        series_conformidade = [0, 0]
    else:
        series_conformidade = [total_conforme, total_respostas_nc]

    # 6. Tabela: Próximas Auditorias (Agenda)
    proximas_auditorias = qs_instancias.filter(
        executada=False,
        data_execucao__gte=timezone.now().date()
    ).select_related('responsavel', 'auditoria_agendada__ferramenta').order_by('data_execucao')[:5]

    context = {
        'title': f'Dashboard de Auditorias {ano_atual}',

        # KPIs
        'kpi_realizadas': total_realizadas,
        'kpi_planejadas': total_planejadas,
        'kpi_eficiencia': f"{eficiencia:.1f}".replace('.', ','),
        'kpi_nc': total_nc,

        # Listas
        'proximas_auditorias': proximas_auditorias,

        # Dados Gráficos
        'chart_meses_labels': json.dumps(meses_labels),
        'chart_series_planejado': json.dumps(series_planejado),
        'chart_series_realizado': json.dumps(series_realizado),

        'chart_locais_labels': json.dumps(locais_labels),
        'chart_locais_series': json.dumps(locais_series),

        'chart_conformidade_series': json.dumps(series_conformidade),
    }

    return render(request, 'auditorias/dashboard.html', context)


# ============================================================================
# VIEWS PARA PILARES
# ============================================================================

@login_required
def lista_pilares(request):
    """Lista todos os pilares com busca e paginação"""
    search = request.GET.get('search', '')
    pilares = Pilar.objects.all()

    if search:
        pilares = pilares.filter(
            Q(nome__icontains=search) | Q(descricao__icontains=search)
        )

    paginator = Paginator(pilares, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Pilares',
        'singular': 'Pilar',
        'button_text': 'Novo Pilar',
        'create_url': 'auditorias:criar_pilar',
        'export_url': 'auditorias:exportar_pilares_csv',  # NOVO
        'artigo': 'o',
        'empty_message': 'Nenhum pilar cadastrado',
        'empty_subtitle': 'Comece criando o primeiro pilar.',
        'tem_permissao_criar': request.user.has_perm('auditorias.add_pilar')
    }
    return render(request, 'auditorias/pilares/lista.html', context)


@login_required
def criar_pilar(request):
    """Cria um novo pilar"""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        descricao = request.POST.get('descricao', '')
        ativo = request.POST.get('ativo') == 'on'

        if nome:
            try:
                Pilar.objects.create(
                    nome=nome,
                    descricao=descricao,
                    ativo=ativo
                )
                messages.success(request, 'Pilar criado com sucesso!')
                return redirect('auditorias:lista_pilares')
            except Exception as e:
                messages.error(request, f'Erro ao criar pilar: {repr(e)}')
        else:
            messages.error(request, 'Nome é obrigatório!')

    context = {
        'title': 'Criar Pilar',
        'back_url': 'auditorias:lista_pilares'
    }
    return render(request, 'auditorias/pilares/form.html', context)


@login_required
def editar_pilar(request, pk):
    """Edita um pilar existente"""
    pilar = get_object_or_404(Pilar, pk=pk)

    if request.method == 'POST':
        pilar.nome = request.POST.get('nome')
        pilar.descricao = request.POST.get('descricao', '')
        pilar.ativo = request.POST.get('ativo') == 'on'

        try:
            pilar.save()
            messages.success(request, 'Pilar atualizado com sucesso!')
            return redirect('auditorias:lista_pilares')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar pilar: {repr(e)}')

    context = {
        'pilar': pilar,
        'title': 'Editar Pilar',
        'back_url': 'auditorias:lista_pilares'
    }
    return render(request, 'auditorias/pilares/form.html', context)


@login_required
def deletar_pilar(request, pk):
    """Deleta um pilar"""
    pilar = get_object_or_404(Pilar, pk=pk)

    if request.method == 'POST':
        try:
            pilar.delete()
            messages.success(request, 'Pilar deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar pilar: {repr(e)}')
        return redirect('auditorias:lista_pilares')

    context = {
        'object': pilar,
        'title': 'Pilar'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_pilares_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="pilares.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Descrição', 'Status', 'Data de Cadastro'])

    search = request.GET.get('search', '')
    pilares = Pilar.objects.all()
    if search:
        pilares = pilares.filter(
            Q(nome__icontains=search) | Q(descricao__icontains=search))

    for pilar in pilares:
        writer.writerow([
            pilar.nome,
            pilar.descricao,
            'Ativo' if pilar.ativo else 'Inativo',
            pilar.data_cadastro.strftime('%d/%m/%Y %H:%M')
        ])

    return response

# ============================================================================
# VIEWS PARA CATEGORias DE AUDITORIA
# ============================================================================


@login_required
def lista_categorias_auditoria(request):
    """Lista todas as categorias de auditoria"""
    search = request.GET.get('search', '')
    categorias = CategoriaAuditoria.objects.select_related('pilar').all()

    if search:
        categorias = categorias.filter(
            Q(descricao__icontains=search) | Q(pilar__nome__icontains=search)
        )

    paginator = Paginator(categorias, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Categorias de Auditoria',
        'singular': 'Categoria de Auditoria',
        'button_text': 'Nova Categoria de Auditoria',
        'create_url': 'auditorias:criar_categoria_auditoria',
        'export_url': 'auditorias:exportar_categorias_auditoria_csv',  # NOVO
        'artigo': 'a',
        'empty_message': 'Nenhuma categoria de auditoria cadastrada',
        'empty_subtitle': 'Comece criando a primeira categoria de auditoria.',
        'tem_permissao_criar': request.user.has_perm('auditorias.add_categoriaauditoria')
    }
    return render(request, 'auditorias/categorias/lista.html', context)


@login_required
def criar_categoria_auditoria(request):
    """Cria uma nova categoria de auditoria"""
    if request.method == 'POST':
        pilar_id = request.POST.get('pilar')
        descricao = request.POST.get('descricao')
        ativo = request.POST.get('ativo') == 'on'

        # Pega o valor do formulário, se vazio usa 7 como padrão
        dias_quarentena = request.POST.get('dias_para_quarentena')
        if not dias_quarentena:
            dias_quarentena = 7

        if pilar_id and descricao:
            try:
                pilar = Pilar.objects.get(pk=pilar_id)
                CategoriaAuditoria.objects.create(
                    pilar=pilar,
                    descricao=descricao,
                    ativo=ativo,
                    dias_para_quarentena=dias_quarentena
                )
                messages.success(request, 'Categoria criada com sucesso!')
                return redirect('auditorias:lista_categorias_auditoria')
            except Exception as e:
                messages.error(request, f'Erro ao criar categoria: {repr(e)}')
        else:
            messages.error(request, 'Pilar e descrição são obrigatórios!')

    context = {
        'pilares': Pilar.objects.filter(ativo=True),
        'title': 'Criar Categoria de Auditoria',
        'back_url': 'auditorias:lista_categorias_auditoria'
    }
    return render(request, 'auditorias/categorias/form.html', context)


@login_required
def editar_categoria_auditoria(request, pk):
    """Edita uma categoria de auditoria existente"""
    categoria = get_object_or_404(CategoriaAuditoria, pk=pk)

    if request.method == 'POST':
        pilar_id = request.POST.get('pilar')
        categoria.descricao = request.POST.get('descricao')
        categoria.ativo = request.POST.get('ativo') == 'on'

        dias_quarentena = request.POST.get('dias_para_quarentena')
        if dias_quarentena:
            categoria.dias_para_quarentena = int(dias_quarentena)

        if pilar_id:
            categoria.pilar = Pilar.objects.get(pk=pilar_id)

        try:
            categoria.save()
            messages.success(request, 'Categoria atualizada com sucesso!')
            return redirect('auditorias:lista_categorias_auditoria')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar categoria: {repr(e)}')

    context = {
        'categoria': categoria,
        'pilares': Pilar.objects.filter(ativo=True),
        'title': 'Editar Categoria de Auditoria',
        'back_url': 'auditorias:lista_categorias_auditoria'
    }
    return render(request, 'auditorias/categorias/form.html', context)


@login_required
def deletar_categoria_auditoria(request, pk):
    """Deleta uma categoria de auditoria"""
    categoria = get_object_or_404(CategoriaAuditoria, pk=pk)

    if request.method == 'POST':
        try:
            categoria.delete()
            messages.success(request, 'Categoria deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar categoria: {repr(e)}')
        return redirect('auditorias:lista_categorias_auditoria')

    context = {
        'object': categoria,
        'title': 'Categoria de Auditoria'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_categorias_auditoria_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={
            'Content-Disposition': 'attachment; filename="categorias_auditoria.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Descrição', 'Pilar', 'Status', 'Data de Cadastro'])

    search = request.GET.get('search', '')
    categorias = CategoriaAuditoria.objects.select_related('pilar').all()
    if search:
        categorias = categorias.filter(
            Q(descricao__icontains=search) | Q(pilar__nome__icontains=search))

    for cat in categorias:
        writer.writerow([
            cat.descricao,
            cat.pilar.nome if cat.pilar else 'N/A',
            'Ativo' if cat.ativo else 'Inativo',
            cat.data_cadastro.strftime('%d/%m/%Y %H:%M')
        ])

    return response


# ============================================================================
# VIEWS PARA NORMAS
# ============================================================================

@login_required
def lista_normas(request):
    """Lista todas as normas"""
    search = request.GET.get('search', '')
    normas = Norma.objects.all()

    if search:
        normas = normas.filter(
            Q(descricao__icontains=search) | Q(revisao__icontains=search)
        )

    paginator = Paginator(normas, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Normas',
        'singular': 'Norma',
        'button_text': 'Nova Norma',
        'create_url': 'auditorias:criar_norma',
        'export_url': 'auditorias:exportar_normas_csv',  # NOVO
        'artigo': 'a',
        'empty_message': 'Nenhuma norma cadastrada',
        'empty_subtitle': 'Comece criando a primeira norma.',
        'tem_permissao_criar': request.user.has_perm('auditorias.add_norma')
    }
    return render(request, 'auditorias/normas/lista.html', context)


@login_required
def criar_norma(request):
    """Cria uma nova norma"""
    if request.method == 'POST':
        descricao = request.POST.get('descricao')
        revisao = request.POST.get('revisao')
        ativo = request.POST.get('ativo') == 'on'

        if descricao and revisao:
            try:
                Norma.objects.create(
                    descricao=descricao,
                    revisao=revisao,
                    ativo=ativo
                )
                messages.success(request, 'Norma criada com sucesso!')
                return redirect('auditorias:lista_normas')
            except Exception as e:
                messages.error(request, f'Erro ao criar norma: {repr(e)}')
        else:
            messages.error(request, 'Descrição e revisão são obrigatórios!')

    context = {
        'title': 'Criar Norma',
        'back_url': 'auditorias:lista_normas'
    }
    return render(request, 'auditorias/normas/form.html', context)


@login_required
def editar_norma(request, pk):
    """Edita uma norma existente"""
    norma = get_object_or_404(Norma, pk=pk)

    if request.method == 'POST':
        norma.descricao = request.POST.get('descricao')
        norma.revisao = request.POST.get('revisao')
        norma.ativo = request.POST.get('ativo') == 'on'

        try:
            norma.save()
            messages.success(request, 'Norma atualizada com sucesso!')
            return redirect('auditorias:lista_normas')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar norma: {repr(e)}')

    context = {
        'norma': norma,
        'title': 'Editar Norma',
        'back_url': 'auditorias:lista_normas'
    }
    return render(request, 'auditorias/normas/form.html', context)


@login_required
def deletar_norma(request, pk):
    """Deleta uma norma"""
    norma = get_object_or_404(Norma, pk=pk)

    if request.method == 'POST':
        try:
            norma.delete()
            messages.success(request, 'Norma deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar norma: {repr(e)}')
        return redirect('auditorias:lista_normas')

    context = {
        'object': norma,
        'title': 'Norma'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_normas_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="normas.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Descrição', 'Revisão', 'Status'])

    search = request.GET.get('search', '')
    normas = Norma.objects.all()
    if search:
        normas = normas.filter(Q(descricao__icontains=search)
                               | Q(revisao__icontains=search))

    for norma in normas:
        writer.writerow([
            norma.descricao,
            norma.revisao,
            'Ativo' if norma.ativo else 'Inativo'
        ])

    return response

# ============================================================================
# VIEWS PARA FERRAMENTAS DIGITAIS
# ============================================================================


@login_required
def lista_ferramentas_digitais(request):
    """Lista todas as ferramentas digitais"""
    search = request.GET.get('search', '')
    ferramentas = FerramentaDigital.objects.all()

    if search:
        ferramentas = ferramentas.filter(nome__icontains=search)

    paginator = Paginator(ferramentas, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Ferramentas Digitais',
        'singular': 'Ferramenta Digital',
        'artigo': 'a',
        'empty_message': 'Nenhuma ferramenta digital cadastrada',
    }
    return render(request, 'auditorias/ferramentas_digitais/lista.html', context)


@login_required
def criar_ferramenta_digital(request):
    """Cria uma nova ferramenta digital"""
    if request.method == 'POST':
        nome = request.POST.get('nome')

        if nome:
            try:
                FerramentaDigital.objects.create(nome=nome)
                messages.success(
                    request, 'Ferramenta digital criada com sucesso!')
                return redirect('auditorias:lista_ferramentas_digitais')
            except Exception as e:
                messages.error(request, f'Erro ao criar ferramenta: {repr(e)}')
        else:
            messages.error(request, 'Nome é obrigatório!')

    context = {
        'title': 'Criar Ferramenta Digital',
        'back_url': 'auditorias:lista_ferramentas_digitais'
    }
    return render(request, 'auditorias/ferramentas_digitais/form.html', context)


@login_required
def editar_ferramenta_digital(request, pk):
    """Edita uma ferramenta digital existente"""
    ferramenta = get_object_or_404(FerramentaDigital, pk=pk)

    if request.method == 'POST':
        ferramenta.nome = request.POST.get('nome')

        try:
            ferramenta.save()
            messages.success(
                request, 'Ferramenta digital atualizada com sucesso!')
            return redirect('auditorias:lista_ferramentas_digitais')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar ferramenta: {repr(e)}')

    context = {
        'ferramenta': ferramenta,
        'title': 'Editar Ferramenta Digital',
        'back_url': 'auditorias:lista_ferramentas_digitais'
    }
    return render(request, 'auditorias/ferramentas_digitais/form.html', context)


@login_required
def deletar_ferramenta_digital(request, pk):
    """Deleta uma ferramenta digital"""
    ferramenta = get_object_or_404(FerramentaDigital, pk=pk)

    if request.method == 'POST':
        try:
            ferramenta.delete()
            messages.success(
                request, 'Ferramenta digital deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar ferramenta: {repr(e)}')
        return redirect('auditorias:lista_ferramentas_digitais')

    context = {
        'object': ferramenta,
        'title': 'Ferramenta Digital'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_ferramentas_digitais_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={
            'Content-Disposition': 'attachment; filename="ferramentas_digitais.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome'])

    search = request.GET.get('search', '')
    ferramentas = FerramentaDigital.objects.all()
    if search:
        ferramentas = ferramentas.filter(nome__icontains=search)

    for ferramenta in ferramentas:
        writer.writerow([ferramenta.nome])

    return response


# ============================================================================
# VIEWS PARA CHECKLISTS
# ============================================================================

@login_required
def lista_checklists(request):
    """Lista todos os checklists (apenas a versão mais recente de cada)."""
    search = request.GET.get('search', '')
    # --- ALTERAÇÃO AQUI ---
    checklists = Checklist.objects.select_related(
        'ferramenta').filter(is_latest=True)

    if search:
        checklists = checklists.filter(nome__icontains=search)

    paginator = Paginator(checklists, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Checklists',
        'create_url': 'auditorias:criar_checklist',
        'export_url': 'auditorias:exportar_checklists_csv',  # NOVO
        'tem_permissao_criar': request.user.has_perm('auditorias.add_checklist')

    }
    return render(request, 'auditorias/checklists/lista.html', context)


@login_required
def criar_checklist(request):
    """Cria um novo checklist com estrutura completa."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        ferramenta_id = request.POST.get('ferramenta')
        ativo = request.POST.get('ativo') == 'on'

        # --- CAPTURA DAS NORMAS ---
        normas_ids = request.POST.getlist('normas_relacionadas')

        if nome:
            try:
                # Criar o checklist básico
                checklist = Checklist.objects.create(
                    nome=nome,
                    ativo=ativo
                )

                # --- ASSOCIAÇÃO DAS NORMAS ---
                if normas_ids:
                    checklist.normas_relacionadas.set(normas_ids)

                if ferramenta_id:
                    checklist.ferramenta_id = ferramenta_id
                    checklist.save()

                # Processar tópicos e perguntas
                processar_estrutura_checklist(request, checklist)

                messages.success(request, 'Checklist criado com sucesso!')
                return redirect('auditorias:lista_checklists')
            except Exception as e:
                messages.error(request, f'Erro ao criar checklist: {repr(e)}')
                import traceback
                print(traceback.format_exc())
        else:
            messages.error(request, 'Nome é obrigatório!')

    context = {
        'ferramentas': FerramentaDigital.objects.filter(aplicavel_em_checklist=True),
        'status_opcoes': OpcaoResposta._meta.get_field('status').choices,
        'title': 'Criar Checklist',
        'back_url': 'auditorias:lista_checklists',
        'todas_as_normas': Norma.objects.filter(ativo=True)
    }
    return render(request, 'auditorias/checklists/form.html', context)


def _create_new_version_from_request(request, checklist_original):
    """
    Cria uma nova versão de um checklist, garantindo que o número da versão
    seja sempre o próximo da sequência, independentemente de qual versão foi editada.
    """
    # --- INÍCIO DA CORREÇÃO ---
    # 1. Encontra o checklist "pai" (a primeira versão) para agrupar todas as versões.
    base_checklist = checklist_original.original_checklist or checklist_original

    # 2. Encontra o número da versão mais alta existente para este checklist.
    latest_version_number = Checklist.objects.filter(
        Q(pk=base_checklist.pk) | Q(original_checklist=base_checklist)
    ).aggregate(max_version=Max('version'))['max_version'] or 0

    # 3. O número da nova versão será o mais alto + 1 (ex: se o max for 2, a nova será 3).
    new_version_number = latest_version_number + 1
    # --- FIM DA CORREÇÃO ---

    normas_ids = request.POST.getlist('normas_relacionadas')

    # 4. Cria o novo objeto Checklist com o número de versão correto.
    nova_versao = Checklist.objects.create(
        nome=request.POST.get('nome'),
        ativo=request.POST.get('ativo') == 'on',
        ferramenta_id=request.POST.get('ferramenta') or None,
        version=new_version_number,  # <-- CORRIGIDO
        is_latest=True,
        original_checklist=base_checklist
    )

    # --- ASSOCIAÇÃO DAS NORMAS À NOVA VERSÃO ---
    if normas_ids:
        nova_versao.normas_relacionadas.set(normas_ids)

    # (O restante da função para copiar os tópicos e perguntas continua o mesmo)
    # ... (código existente para processar a estrutura do checklist)
    topicos_data = {}
    for key in request.POST:
        if key.startswith('topico-descricao['):
            topico_id_form = key.split('[')[1].split(']')[0]
            topicos_data[topico_id_form] = {
                'descricao': request.POST.get(key),
                'ordem': request.POST.get(f'topico-ordem[{topico_id_form}]', 0)
            }

    for topico_id_form, topico_info in topicos_data.items():
        novo_topico = Topico.objects.create(
            checklist=nova_versao,
            descricao=topico_info['descricao'],
            ordem=int(topico_info['ordem']) if topico_info['ordem'] else 0
        )

        for key in request.POST:
            if key.startswith(f'pergunta-descricao[{topico_id_form}-'):
                pergunta_id_full = key.split('[')[1].split(']')[0]
                nova_pergunta = Pergunta.objects.create(
                    topico=novo_topico,
                    descricao=request.POST.get(key),
                    ordem=int(request.POST.get(
                        f'pergunta-ordem[{pergunta_id_full}]', 0)),
                    obrigatoria=request.POST.get(
                        f'pergunta-obrigatorio[{pergunta_id_full}]') == 'on',
                    resposta_livre=request.POST.get(
                        f'pergunta-resposta_livre[{pergunta_id_full}]') == 'on',
                    foto=request.POST.get(
                        f'pergunta-foto[{pergunta_id_full}]') == 'on',
                    criar_opcao=request.POST.get(
                        f'pergunta-criar_opcao[{pergunta_id_full}]') == 'on',
                    porcentagem=request.POST.get(
                        f'pergunta-porcentagem[{pergunta_id_full}]') == 'on'
                )

                for opt_key in request.POST:
                    if opt_key.startswith(f'opcao-resposta-descricao[{pergunta_id_full}-'):
                        opt_id_full = opt_key.split('[')[1].split(']')[
                            0]
                        OpcaoResposta.objects.create(
                            pergunta=nova_pergunta,
                            descricao=request.POST.get(opt_key),
                            status=request.POST.get(
                                f'opcao-resposta-status[{opt_id_full}]', 'CONFORME')
                        )

                for opt_key in request.POST:
                    if opt_key.startswith(f'opcao-porcentagem-descricao[{pergunta_id_full}-'):
                        opt_id_full = opt_key.split('[')[1].split(']')[
                            0]
                        OpcaoPorcentagem.objects.create(
                            pergunta=nova_pergunta,
                            descricao=request.POST.get(opt_key),
                            peso=int(request.POST.get(
                                f'opcao-porcentagem-peso[{opt_id_full}]', 0)),
                            cor=request.POST.get(
                                f'opcao-porcentagem-cor[{opt_id_full}]', '#FFFFFF')
                        )

    return nova_versao


@login_required
def editar_checklist(request, pk):
    """
    Ao editar um checklist, cria uma nova versão (clone) com as modificações
    e atualiza as auditorias futuras. A nova versão será sempre a mais recente.
    """
    checklist_a_ser_editado = get_object_or_404(Checklist, pk=pk)

    if request.method == 'POST':
        try:
            with transaction.atomic():
                # --- INÍCIO DA CORREÇÃO ---
                # 1. Encontra o checklist "pai" e a versão que é atualmente a mais recente.
                base_checklist = checklist_a_ser_editado.original_checklist or checklist_a_ser_editado
                versao_mais_recente_anterior = Checklist.objects.filter(
                    Q(pk=base_checklist.pk) | Q(
                        original_checklist=base_checklist),
                    is_latest=True
                ).first()
                # --- FIM DA CORREÇÃO ---

                # 2. Cria a nova versão (a função interna agora calcula o número da versão corretamente).
                novo_checklist = _create_new_version_from_request(
                    request, checklist_a_ser_editado)

                # 3. Desativa a versão que ERA a mais recente, marcando-a como 'is_latest=False'.
                if versao_mais_recente_anterior:
                    versao_mais_recente_anterior.is_latest = False
                    versao_mais_recente_anterior.save()

                # 4. Encontra todos os Modelos de Auditoria que usavam a versão mais recente anterior.
                if versao_mais_recente_anterior:
                    modelos_afetados_ids = list(ModeloAuditoria.objects.filter(
                        checklist=versao_mais_recente_anterior
                    ).values_list('id', flat=True))

                    if modelos_afetados_ids:
                        # 5. Atualiza esses modelos para apontarem para o NOVO checklist.
                        ModeloAuditoria.objects.filter(
                            id__in=modelos_afetados_ids).update(checklist=novo_checklist)

                        # 6. Atualiza APENAS as instâncias de auditoria futuras.
                        AuditoriaInstancia.objects.filter(
                            auditoria_agendada__modelos__id__in=modelos_afetados_ids,
                            executada=False,
                            data_execucao__gt=timezone.now().date()
                        ).update(checklist_usado=novo_checklist)

                messages.success(
                    request, f'Checklist "{novo_checklist.nome}" atualizado para a versão {novo_checklist.version} com sucesso!')
                return redirect('auditorias:lista_checklists')

        except Exception as e:
            messages.error(request, f'Erro ao atualizar checklist: {repr(e)}')
            import traceback
            print(traceback.format_exc())

    # O contexto para o método GET (para exibir o formulário) continua o mesmo.
    context = {
        'checklist': checklist_a_ser_editado,
        'object': checklist_a_ser_editado,
        'ferramentas': FerramentaDigital.objects.filter(aplicavel_em_checklist=True),
        'status_opcoes': OpcaoResposta._meta.get_field('status').choices,
        'title': f'Editar Checklist: {checklist_a_ser_editado.nome} (V{checklist_a_ser_editado.version})',
        'back_url': 'auditorias:lista_checklists',
        'todas_as_normas': Norma.objects.filter(ativo=True)
    }
    return render(request, 'auditorias/checklists/form.html', context)

# Supondo que seus models (AuditoriaInstancia, Checklist, SubSetor, Topico, etc.)
# estejam importados corretamente.
# from .models import AuditoriaInstancia, Checklist, SubSetor, Topico, Pergunta, OpcaoResposta, OpcaoPorcentagem


def _gerar_instancias_para_auditoria(auditoria, subsetores_selecionados_ids=None):
    """
    Função ATUALIZADA para gerar instâncias com base na nova lógica de agendamento.
    """
    # 1. Apaga todas as instâncias futuras que ainda não foram executadas
    auditoria.instancias.filter(
        executada=False,
        data_execucao__gte=timezone.now().date()
    ).delete()

    # 2. Busca o checklist mais recente a ser usado
    primeiro_modelo = auditoria.modelos.first()
    checklist_para_usar = None
    if primeiro_modelo and primeiro_modelo.checklist:
        checklist_base = primeiro_modelo.checklist
        original = checklist_base.original_checklist or checklist_base
        checklist_para_usar = Checklist.objects.filter(
            Q(pk=original.pk) | Q(original_checklist=original),
            is_latest=True
        ).first()

    # 3. Lógica para gerar a lista de datas
    dates_to_create = []
    if auditoria.data_inicio:
        current_date = auditoria.data_inicio
        end_date = auditoria.data_fim
        if not end_date:
            if not (auditoria.pular_finais_semana and current_date.weekday() >= 5):
                dates_to_create.append(current_date)
        else:
            loop_limit = 365 * 5
            loops = 0
            while current_date <= end_date and loops < loop_limit:
                loops += 1
                if not (auditoria.pular_finais_semana and current_date.weekday() >= 5):
                    dates_to_create.append(current_date)
                if auditoria.por_intervalo and auditoria.intervalo:
                    current_date += timedelta(days=auditoria.intervalo + 1)
                elif auditoria.por_frequencia and auditoria.frequencia:
                    # ... lógica de frequência ...
                    if auditoria.frequencia == 'DIARIO':
                        current_date += timedelta(days=1)
                    elif auditoria.frequencia == 'SEMANAL':
                        current_date += timedelta(weeks=1)
                    elif auditoria.frequencia == 'QUINZENAL':
                        current_date += timedelta(weeks=2)
                    elif auditoria.frequencia == 'MENSAL':
                        current_date += relativedelta(months=1)
                    elif auditoria.frequencia == 'ANUAL':
                        current_date += relativedelta(years=1)
                    else:
                        break
                else:
                    break

    # 4. Determina os locais e turnos
    target_locations = []

    if auditoria.agendamento_especifico:
        # CENÁRIO 2: Locais Específicos. Usa a lista de IDs recebida.
        if subsetores_selecionados_ids:
            target_locations = list(SubSetor.objects.filter(
                pk__in=subsetores_selecionados_ids))
    else:
        # CENÁRIO 1: Auditoria de Gestão ("Flutuante").
        # Se o nível NÃO for Subsetor, criamos uma instância sem local definido.
        if auditoria.nivel_organizacional != 'SUBSETOR':
            # O 'None' indica que o local será escolhido no app
            target_locations.append(None)
        elif auditoria.local_subsetor:
            # Caso especial: se o nível for Subsetor, o agendamento é para aquele local.
            target_locations.append(auditoria.local_subsetor)

    # Garante que não falhe se nenhuma localização for encontrada
    if not target_locations:
        target_locations.append(None)

    target_turnos = list(auditoria.turnos.all())
    if not target_turnos:
        target_turnos.append(None)

    repetitions = auditoria.numero_repeticoes if auditoria.numero_repeticoes and auditoria.numero_repeticoes > 0 else 1

    # 5. Cria as novas instâncias (lógica inalterada)
    instancias_a_criar = []
    for dt in dates_to_create:
        for location in target_locations:
            for turno in target_turnos:
                if turno and not turno.turnodetalhedia_set.filter(dia_semana=dt.weekday()).exists():
                    continue
                for _ in range(repetitions):
                    instancias_a_criar.append(AuditoriaInstancia(
                        auditoria_agendada=auditoria,
                        data_execucao=dt,
                        local_execucao=location,
                        responsavel=auditoria.responsavel,
                        turno=turno,
                        checklist_usado=checklist_para_usar
                    ))

    if instancias_a_criar:
        AuditoriaInstancia.objects.bulk_create(instancias_a_criar)


def processar_estrutura_checklist(request, checklist):
    """Processa e salva toda a estrutura de tópicos, perguntas e opções do checklist."""
    topicos_ids_processados = set()
    perguntas_ids_processadas = set()
    opcoes_resposta_ids_processadas = set()
    opcoes_porcentagem_ids_processadas = set()

    for key, value in request.POST.items():
        if key.startswith('topico-descricao['):
            topico_id_str = key.split('[')[1].split(']')[0]
            topico_descricao = value
            topico_ordem = request.POST.get(
                f'topico-ordem[{topico_id_str}]', 0)

            if topico_id_str.startswith('new-'):
                topico = Topico.objects.create(
                    checklist=checklist, descricao=topico_descricao, ordem=topico_ordem)
            else:
                topico = get_object_or_404(Topico, pk=int(
                    topico_id_str), checklist=checklist)
                topico.descricao = topico_descricao
                topico.ordem = topico_ordem
                topico.save()
            topicos_ids_processados.add(topico.id)

            # Processar perguntas deste tópico
            for p_key, p_value in request.POST.items():
                if p_key.startswith(f'pergunta-descricao[{topico_id_str}-'):
                    pergunta_id_full = p_key.split('[')[1].split(']')[0]
                    pergunta_id_str = pergunta_id_full.replace(
                        f'{topico_id_str}-', '')

                    pergunta_descricao = p_value
                    pergunta_ordem = request.POST.get(
                        f'pergunta-ordem[{pergunta_id_full}]', 0)

                    if pergunta_id_str.startswith('new-'):
                        pergunta = Pergunta.objects.create(
                            topico=topico, descricao=pergunta_descricao, ordem=pergunta_ordem)
                    else:
                        pergunta = get_object_or_404(
                            Pergunta, pk=int(pergunta_id_str), topico=topico)
                        pergunta.descricao = pergunta_descricao
                        pergunta.ordem = pergunta_ordem

                    pergunta.obrigatoria = request.POST.get(
                        f'pergunta-obrigatorio[{pergunta_id_full}]') == 'on'
                    pergunta.resposta_livre = request.POST.get(
                        f'pergunta-resposta_livre[{pergunta_id_full}]') == 'on'
                    pergunta.foto = request.POST.get(
                        f'pergunta-foto[{pergunta_id_full}]') == 'on'
                    pergunta.criar_opcao = request.POST.get(
                        f'pergunta-criar_opcao[{pergunta_id_full}]') == 'on'
                    pergunta.porcentagem = request.POST.get(
                        f'pergunta-porcentagem[{pergunta_id_full}]') == 'on'
                    pergunta.save()
                    perguntas_ids_processadas.add(pergunta.id)

                    # Processar opções de resposta
                    for o_key, o_value in request.POST.items():
                        if o_key.startswith(f'opcao-resposta-descricao[{pergunta_id_full}-'):
                            opcao_id_full = o_key.split('[')[1].split(']')[0]
                            opcao_id_str = opcao_id_full.replace(
                                f'{pergunta_id_full}-', '')

                            if opcao_id_str.startswith('new-'):
                                opcao = OpcaoResposta.objects.create(
                                    pergunta=pergunta)
                            else:
                                opcao = get_object_or_404(OpcaoResposta, pk=int(
                                    opcao_id_str), pergunta=pergunta)

                            opcao.descricao = o_value
                            opcao.status = request.POST.get(
                                f'opcao-resposta-status[{opcao_id_full}]')
                            opcao.ordem = int(request.POST.get(
                                f'opcao-resposta-ordem[{opcao_id_full}]', 0))
                            opcao.save()
                            opcoes_resposta_ids_processadas.add(opcao.id)

                    # Processar opções de porcentagem
                    for o_key, o_value in request.POST.items():
                        if o_key.startswith(f'opcao-porcentagem-descricao[{pergunta_id_full}-'):
                            opcao_id_full = o_key.split('[')[1].split(']')[0]
                            opcao_id_str = opcao_id_full.replace(
                                f'{pergunta_id_full}-', '')

                            # ==========================================================
                            # INÍCIO DA CORREÇÃO
                            # ==========================================================
                            if opcao_id_str.startswith('new-'):
                                # Passa todos os dados diretamente na criação
                                opcao = OpcaoPorcentagem.objects.create(
                                    pergunta=pergunta,
                                    descricao=o_value,
                                    peso=int(request.POST.get(
                                        f'opcao-porcentagem-peso[{opcao_id_full}]', 0)),
                                    cor=request.POST.get(
                                        f'opcao-porcentagem-cor[{opcao_id_full}]', '#FFFFFF'),
                                    ordem=int(request.POST.get(
                                        f'opcao-porcentagem-ordem[{opcao_id_full}]', 0))
                                )
                            else:
                                # Lógica de atualização continua a mesma
                                opcao = get_object_or_404(OpcaoPorcentagem, pk=int(
                                    opcao_id_str), pergunta=pergunta)
                                opcao.descricao = o_value
                                opcao.peso = int(request.POST.get(
                                    f'opcao-porcentagem-peso[{opcao_id_full}]', 0))
                                opcao.cor = request.POST.get(
                                    f'opcao-porcentagem-cor[{opcao_id_full}]', '#FFFFFF')
                                opcao.ordem = int(request.POST.get(
                                    f'opcao-porcentagem-ordem[{opcao_id_full}]', 0))
                                opcao.save()
                            # ==========================================================
                            # FIM DA CORREÇÃO
                            # ==========================================================

                            opcoes_porcentagem_ids_processadas.add(opcao.id)

    # Deletar itens que não foram processados (removidos do formulário)
    OpcaoResposta.objects.filter(pergunta__topico__checklist=checklist).exclude(
        id__in=opcoes_resposta_ids_processadas).delete()
    OpcaoPorcentagem.objects.filter(pergunta__topico__checklist=checklist).exclude(
        id__in=opcoes_porcentagem_ids_processadas).delete()
    Pergunta.objects.filter(topico__checklist=checklist).exclude(
        id__in=perguntas_ids_processadas).delete()
    Topico.objects.filter(checklist=checklist).exclude(
        id__in=topicos_ids_processados).delete()


@login_required
def deletar_checklist(request, pk):
    """Deleta um checklist"""
    checklist = get_object_or_404(Checklist, pk=pk)

    if request.method == 'POST':
        try:
            checklist.delete()
            messages.success(request, 'Checklist deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar checklist: {repr(e)}')
        return redirect('auditorias:lista_checklists')

    context = {
        'object': checklist,
        'title': 'Checklist'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def historico_versoes_checklist(request, pk):
    """
    Lista todas as versões de um checklist específico.
    """
    checklist_atual = get_object_or_404(Checklist, pk=pk)

    # Encontra o checklist original (V1) para buscar todas as suas versões
    original = checklist_atual.original_checklist or checklist_atual

    # MODIFICAÇÃO: A consulta agora 'anota' (annotate) em cada versão
    # a contagem total de perguntas, somando as de todos os seus tópicos.
    versoes = Checklist.objects.filter(
        Q(pk=original.pk) | Q(original_checklist=original)
    ).prefetch_related(
        'topicos'
    ).annotate(
        total_perguntas=Count('topicos__perguntas')
    ).order_by('-version')

    context = {
        'versoes': versoes,
        'original': original,
        'title': f'Histórico de Versões - {original.nome}',
    }

    return render(request, 'auditorias/checklists/historico.html', context)


@login_required
def comparar_versoes_checklist(request, pk):
    """
    View para comparar múltiplas versões de um checklist.
    Permite selecionar e comparar 2 ou mais versões lado a lado.
    """
    checklist_atual = get_object_or_404(Checklist, pk=pk)

    # Encontra o checklist original
    original = checklist_atual.original_checklist or checklist_atual

    # Busca todas as versões
    versoes = (Checklist.objects.filter(
        Q(pk=original.pk) | Q(original_checklist=original)
    ).prefetch_related(
        'topicos__perguntas__opcoes_resposta',
        'topicos__perguntas__opcoes_porcentagem'
    ).order_by('-version'))

    # Se versões específicas foram selecionadas para comparação
    versoes_selecionadas_ids = request.GET.getlist('versoes')

    if versoes_selecionadas_ids and len(versoes_selecionadas_ids) >= 2:
        versoes_para_comparar = versoes.filter(
            pk__in=versoes_selecionadas_ids
        ).order_by('version')

        # Gera dados de comparação
        comparacao_data = _gerar_dados_comparacao(versoes_para_comparar)

        context = {
            'original': original,
            'versoes': versoes,
            'versoes_comparadas': versoes_para_comparar,
            'comparacao_data': comparacao_data,
            'title': f'Comparar Versões - {original.nome}',
        }
    else:
        context = {
            'original': original,
            'versoes': versoes,
            'versoes_comparadas': None,
            'title': f'Selecionar Versões para Comparar - {original.nome}',
        }

    return render(request, 'auditorias/checklists/comparar_versoes.html', context)


def _gerar_dados_comparacao(versoes):
    """
    Gera estrutura de dados para comparação entre versões.
    Retorna um dicionário com as diferenças detectadas organizadas para exibição lado a lado.
    """
    comparacao = {
        'versoes_info': [],
        'topicos_comparados': [],
        'alteracoes_resumo': {
            'topicos_adicionados': 0,
            'topicos_removidos': 0,
            'perguntas_adicionadas': 0,
            'perguntas_removidas': 0,
            'perguntas_modificadas': 0,
        }
    }

    # Informações básicas de cada versão
    versoes_list = list(versoes)
    for v in versoes_list:
        comparacao['versoes_info'].append({
            'id': v.pk,
            'version': v.version,
            'nome': v.nome,
            'data': v.data_cadastro,
            'total_topicos': v.topicos.count(),
            'total_perguntas': sum(t.perguntas.count() for t in v.topicos.all()),
        })

    # Criar estrutura de dados para cada versão
    versoes_data = {}
    for v in versoes_list:
        versoes_data[v.pk] = {}
        for topico in v.topicos.all():
            if topico.descricao not in versoes_data[v.pk]:
                versoes_data[v.pk][topico.descricao] = []

            for pergunta in topico.perguntas.all():
                versoes_data[v.pk][topico.descricao].append({
                    'id': pergunta.pk,
                    'descricao': pergunta.descricao,
                    'ordem': pergunta.ordem,
                    'obrigatoria': pergunta.obrigatoria,
                    'resposta_livre': pergunta.resposta_livre,
                    'foto': pergunta.foto,
                    'criar_opcao': pergunta.criar_opcao,
                    'porcentagem': pergunta.porcentagem,
                    'opcoes_resposta': [
                        {'descricao': o.descricao, 'status': o.status,
                            'status_display': o.get_status_display()}
                        for o in pergunta.opcoes_resposta.all()
                    ],
                    'opcoes_porcentagem': [
                        {'descricao': o.descricao, 'peso': o.peso}
                        for o in pergunta.opcoes_porcentagem.all()
                    ],
                })

    # Obter todos os tópicos únicos
    todos_topicos = set()
    for v_pk in versoes_data:
        todos_topicos.update(versoes_data[v_pk].keys())

    # Análise de alterações entre primeira e última versão
    if len(versoes_list) >= 2:
        primeira_versao = versoes_list[0]
        ultima_versao = versoes_list[-1]

        topicos_primeira = set(versoes_data[primeira_versao.pk].keys())
        topicos_ultima = set(versoes_data[ultima_versao.pk].keys())

        comparacao['alteracoes_resumo']['topicos_adicionados'] = len(
            topicos_ultima - topicos_primeira)
        comparacao['alteracoes_resumo']['topicos_removidos'] = len(
            topicos_primeira - topicos_ultima)

        # Contar perguntas
        for topico in topicos_primeira & topicos_ultima:
            pergs_primeira = versoes_data[primeira_versao.pk][topico]
            pergs_ultima = versoes_data[ultima_versao.pk][topico]

            desc_primeira = [p['descricao'] for p in pergs_primeira]
            desc_ultima = [p['descricao'] for p in pergs_ultima]

            comparacao['alteracoes_resumo']['perguntas_adicionadas'] += len(
                set(desc_ultima) - set(desc_primeira))
            comparacao['alteracoes_resumo']['perguntas_removidas'] += len(
                set(desc_primeira) - set(desc_ultima))

            # Contar modificadas
            for p1 in pergs_primeira:
                for p2 in pergs_ultima:
                    if p1['descricao'] == p2['descricao']:
                        # Verifica se outras propriedades mudaram
                        if (p1['obrigatoria'] != p2['obrigatoria'] or
                            p1['resposta_livre'] != p2['resposta_livre'] or
                            p1['foto'] != p2['foto'] or
                            p1['criar_opcao'] != p2['criar_opcao'] or
                            p1['porcentagem'] != p2['porcentagem'] or
                            p1['opcoes_resposta'] != p2['opcoes_resposta'] or
                                p1['opcoes_porcentagem'] != p2['opcoes_porcentagem']):
                            comparacao['alteracoes_resumo']['perguntas_modificadas'] += 1
                        break

    # Organizar dados para exibição lado a lado
    for topico_nome in sorted(todos_topicos):
        topico_data = {
            'nome': topico_nome,
            'perguntas_agrupadas': []
        }

        # Coletar todas as perguntas únicas deste tópico de todas as versões
        todas_perguntas_desc = set()
        for v_pk in versoes_data:
            if topico_nome in versoes_data[v_pk]:
                for p in versoes_data[v_pk][topico_nome]:
                    todas_perguntas_desc.add(p['descricao'])

        # Para cada descrição de pergunta única, criar uma linha de comparação
        for pergunta_desc in sorted(todas_perguntas_desc):
            linha_pergunta = {
                'descricao': pergunta_desc,
                'versoes_dados': {}
            }

            # Para cada versão, buscar a pergunta com essa descrição
            for v in versoes_list:
                v_pk = v.pk
                linha_pergunta['versoes_dados'][v_pk] = None

                if topico_nome in versoes_data[v_pk]:
                    for p in versoes_data[v_pk][topico_nome]:
                        if p['descricao'] == pergunta_desc:
                            linha_pergunta['versoes_dados'][v_pk] = p
                            break

            topico_data['perguntas_agrupadas'].append(linha_pergunta)

        comparacao['topicos_comparados'].append(topico_data)

    comparacao['versoes_data'] = versoes_data

    return comparacao


@login_required
def exportar_checklists_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="checklists.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Ferramenta', 'Status'])

    search = request.GET.get('search', '')
    checklists = Checklist.objects.select_related('ferramenta').all()
    if search:
        checklists = checklists.filter(nome__icontains=search)

    for checklist in checklists:
        writer.writerow([
            checklist.nome,
            checklist.ferramenta.nome if checklist.ferramenta else 'N/A',
            'Ativo' if checklist.ativo else 'Inativo'
        ])

    return response

# ============================================================================
# VIEWS PARA MODELOS DE AUDITORIA
# ============================================================================


@login_required
def lista_modelos_auditoria(request):
    """Lista todos os modelos de auditoria"""
    search = request.GET.get('search', '')
    modelos = ModeloAuditoria.objects.select_related(
        'checklist', 'categoria', 'ferramenta_causa_raiz').all()

    if search:
        modelos = modelos.filter(descricao__icontains=search)

    paginator = Paginator(modelos, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Modelos de Auditoria',
        'singular': 'Modelo de Auditoria',
        'button_text': 'Novo Modelo de Auditoria',
        'create_url': 'auditorias:criar_modelo_auditoria',
        'export_url': 'auditorias:exportar_modelos_auditoria_csv',  # NOVO
        'artigo': 'o',
        'empty_message': 'Nenhum modelo de auditoria cadastrado',
        'empty_subtitle': 'Comece criando o primeiro modelo de auditoria.',
        'tem_permissao_criar': request.user.has_perm('auditorias.add_modeloauditoria')
    }
    return render(request, 'auditorias/modelos_auditoria/lista.html', context)


@login_required
def criar_modelo_auditoria(request):
    """Cria um novo modelo de auditoria"""
    if request.method == 'POST':
        descricao = request.POST.get('descricao')
        ativo = request.POST.get('ativo') == 'on'
        iniciar_por_codigo_qr = request.POST.get(
            'iniciar_por_codigo_qr') == 'on'
        checklist_id = request.POST.get('checklist')
        categoria_id = request.POST.get('categoria')
        ferramenta_causa_raiz_id = request.POST.get('ferramenta_causa_raiz')

        if descricao:
            try:
                modelo = ModeloAuditoria.objects.create(
                    descricao=descricao,
                    ativo=ativo,
                    iniciar_por_codigo_qr=iniciar_por_codigo_qr
                )

                if checklist_id:
                    modelo.checklist = Checklist.objects.get(pk=checklist_id)
                if categoria_id:
                    modelo.categoria = CategoriaAuditoria.objects.get(
                        pk=categoria_id)
                if ferramenta_causa_raiz_id:
                    modelo.ferramenta_causa_raiz = FerramentaCausaRaiz.objects.get(
                        pk=ferramenta_causa_raiz_id)

                modelo.save()
                messages.success(
                    request, 'Modelo de auditoria criado com sucesso!')
                return redirect('auditorias:lista_modelos_auditoria')
            except Exception as e:
                messages.error(request, f'Erro ao criar modelo: {repr(e)}')
        else:
            messages.error(request, 'Descrição é obrigatória!')

    context = {
        'checklists': Checklist.objects.filter(ativo=True, is_latest=True),
        'categorias': CategoriaAuditoria.objects.filter(ativo=True),
        'ferramentas_causa_raiz': FerramentaCausaRaiz.objects.all(),
        'title': 'Criar Modelo de Auditoria',
        'back_url': 'auditorias:lista_modelos_auditoria'
    }
    return render(request, 'auditorias/modelos_auditoria/form.html', context)


@login_required
def editar_modelo_auditoria(request, pk):
    """Edita um modelo de auditoria existente"""
    modelo = get_object_or_404(ModeloAuditoria, pk=pk)

    if request.method == 'POST':
        modelo.descricao = request.POST.get('descricao')
        modelo.ativo = request.POST.get('ativo') == 'on'
        modelo.iniciar_por_codigo_qr = request.POST.get(
            'iniciar_por_codigo_qr') == 'on'

        checklist_id = request.POST.get('checklist')
        categoria_id = request.POST.get('categoria')
        ferramenta_causa_raiz_id = request.POST.get('ferramenta_causa_raiz')

        if checklist_id:
            modelo.checklist = Checklist.objects.get(pk=checklist_id)
        else:
            modelo.checklist = None

        if categoria_id:
            modelo.categoria = CategoriaAuditoria.objects.get(pk=categoria_id)
        else:
            modelo.categoria = None

        if ferramenta_causa_raiz_id:
            modelo.ferramenta_causa_raiz = FerramentaCausaRaiz.objects.get(
                pk=ferramenta_causa_raiz_id)
        else:
            modelo.ferramenta_causa_raiz = None

        try:
            modelo.save()
            messages.success(
                request, 'Modelo de auditoria atualizado com sucesso!')
            return redirect('auditorias:lista_modelos_auditoria')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar modelo: {repr(e)}')

    context = {
        'modelo': modelo,
        'checklists': Checklist.objects.filter(ativo=True, is_latest=True),
        'categorias': CategoriaAuditoria.objects.filter(ativo=True),
        'ferramentas_causa_raiz': FerramentaCausaRaiz.objects.all(),
        'title': 'Editar Modelo de Auditoria',
        'back_url': 'auditorias:lista_modelos_auditoria'
    }
    return render(request, 'auditorias/modelos_auditoria/form.html', context)


@login_required
def deletar_modelo_auditoria(request, pk):
    """Deleta um modelo de auditoria"""
    modelo = get_object_or_404(ModeloAuditoria, pk=pk)

    if request.method == 'POST':
        try:
            modelo.delete()
            messages.success(
                request, 'Modelo de auditoria deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar modelo: {repr(e)}')
        return redirect('auditorias:lista_modelos_auditoria')

    context = {
        'object': modelo,
        'title': 'Modelo de Auditoria'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_modelos_auditoria_csv(request):

    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={
            'Content-Disposition': 'attachment; filename="modelos_auditoria.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Descrição', 'Checklist', 'Categoria', 'Status'])

    search = request.GET.get('search', '')
    modelos = ModeloAuditoria.objects.select_related(
        'checklist', 'categoria').all()
    if search:
        modelos = modelos.filter(descricao__icontains=search)

    for modelo in modelos:
        writer.writerow([
            modelo.descricao,
            modelo.checklist.nome if modelo.checklist else 'N/A',
            modelo.categoria.descricao if modelo.categoria else 'N/A',
            'Ativo' if modelo.ativo else 'Inativo'
        ])

    return response

# ============================================================================
# VIEWS PARA AUDITORIAS
# ============================================================================


@login_required
def lista_auditorias(request):
    """Lista todas as auditorias agendadas"""
    search = request.GET.get('search', '')
    auditorias = Auditoria.objects.select_related(
        'responsavel',
        'ferramenta',
        'criado_por'
    ).prefetch_related(
        'modelos'
    ).all()

    if search:
        auditorias = auditorias.filter(
            Q(responsavel__first_name__icontains=search) |
            Q(responsavel__last_name__icontains=search) |
            Q(ferramenta__nome__icontains=search)
        )

    paginator = Paginator(auditorias, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    # --- INÍCIO DA CORREÇÃO ---
    all_users_list = list(Usuario.objects.filter(is_active=True).annotate(
        name=Concat('first_name', Value(' '), 'last_name')
    ).values('id', 'name'))
    # --- FIM DA CORREÇÃO ---

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Agendamento de Auditorias',
        'singular': 'Auditoria',
        'button_text': 'Criar Auditoria',
        'create_url': 'auditorias:criar_auditoria',
        'artigo': 'a',
        'empty_message': 'Nenhuma auditoria agendada',
        'empty_subtitle': 'Comece criando a primeira auditoria.',
        # Passa o JSON para o template
        'all_users_json': json.dumps(all_users_list)
    }
    return render(request, 'auditorias/auditorias/lista.html', context)


@login_required
def criar_auditoria(request):
    """Cria uma nova auditoria agendada com a nova lógica de locais."""
    if request.method == 'POST':
        try:
            # --- VALIDAÇÃO DE DATAS NO BACKEND ---
            hoje = timezone.now().date()
            data_inicio_str = request.POST.get('data_inicio')
            data_fim_str = request.POST.get('data_fim')

            if data_inicio_str:
                data_inicio = datetime.strptime(
                    data_inicio_str, '%Y-%m-%d').date()
                if data_inicio < hoje:
                    messages.error(
                        request, 'A Data de Início não pode ser no passado.')
                    # Redireciona de volta para o formulário
                    return redirect('auditorias:criar_auditoria')
            else:
                # Se a data de início é obrigatória e não foi enviada
                messages.error(request, 'A Data de Início é obrigatória.')
                return redirect('auditorias:criar_auditoria')

            if data_fim_str:
                data_fim = datetime.strptime(data_fim_str, '%Y-%m-%d').date()
                if data_fim < data_inicio:  # Garante que a data fim não é antes da de início
                    messages.error(
                        request, 'A data "Até o Dia" não pode ser anterior à Data de Início.')
                    return redirect('auditorias:criar_auditoria')
            else:
                data_fim = None

            with transaction.atomic():
                # --- Captura todos os dados do formulário ---
                data_inicio_str = request.POST.get('data_inicio')
                data_fim_str = request.POST.get('data_fim')
                data_inicio = datetime.strptime(
                    data_inicio_str, '%Y-%m-%d').date()
                data_fim = datetime.strptime(
                    data_fim_str, '%Y-%m-%d').date() if data_fim_str else None

                schedule_type = request.POST.get('schedule_type')

                # --- NOVA LÓGICA DE AGENDAMENTO ---
                agendamento_especifico = request.POST.get(
                    'agendamento_especifico') == 'on'
                subsetores_selecionados_ids = request.POST.getlist(
                    'subsetores_selecionados')

                # --- NOVA LÓGICA: Descobrir a ferramenta baseada no Modelo selecionado ---
                modelos_ids = request.POST.getlist('modelos')
                ferramenta_id_automatico = None

                if modelos_ids:
                    # Pega o primeiro modelo da lista para definir a ferramenta da auditoria
                    # Isso garante consistência com o checklist usado
                    primeiro_modelo = ModeloAuditoria.objects.filter(
                        pk=modelos_ids[0]).select_related('checklist__ferramenta').first()

                    if primeiro_modelo and primeiro_modelo.checklist and primeiro_modelo.checklist.ferramenta:
                        ferramenta_id_automatico = primeiro_modelo.checklist.ferramenta.id

                auditoria = Auditoria(
                    criado_por=request.user,
                    # <--- AQUI: Usamos o ID descoberto automaticamente
                    ferramenta_id=ferramenta_id_automatico,
                    responsavel_id=request.POST.get('responsavel'),
                    nivel_organizacional=request.POST.get(
                        'nivel_organizacional'),
                    categoria_auditoria=request.POST.get(
                        'categoria_auditoria'),
                    data_inicio=data_inicio,
                    data_fim=data_fim,
                    local_empresa_id=request.POST.get('local_empresa') or None,
                    local_area_id=request.POST.get('local_area') or None,
                    local_setor_id=request.POST.get('local_setor') or None,
                    local_subsetor_id=request.POST.get(
                        'local_subsetor') or None,
                    por_frequencia=schedule_type == 'por_frequencia',
                    por_intervalo=schedule_type == 'por_intervalo',
                    frequencia=request.POST.get('frequencia') or None,
                    intervalo=int(request.POST.get('intervalo')
                                  ) if request.POST.get('intervalo') else None,
                    numero_repeticoes=int(request.POST.get('numero_repeticoes')) if request.POST.get(
                        'numero_repeticoes') else None,
                    pular_finais_semana=request.POST.get(
                        'pular_finais_semana') == 'on',
                    contem_turnos=request.POST.get('contem_turnos') == 'on',
                    agendamento_especifico=agendamento_especifico  # Salva o novo flag
                )
                auditoria.save()

                auditoria.modelos.set(modelos_ids)  # Salva os modelos (M2M)
                auditoria.ativos_auditados.set(
                    request.POST.getlist('ativos_auditados'))
                auditoria.turnos.set(request.POST.getlist('turnos'))

                # --- CHAMA A FUNÇÃO ATUALIZADA ---
                _gerar_instancias_para_auditoria(
                    auditoria, subsetores_selecionados_ids)

            messages.success(request, 'Auditoria criada com sucesso!')
            return redirect('auditorias:lista_auditorias')
        except Exception as e:
            messages.error(request, f'Erro ao criar auditoria: {repr(e)}')
            import traceback
            traceback.print_exc()  # Para debug no terminal

    # Contexto para o método GET
    context = {
        'ferramentas': FerramentaDigital.objects.all(),
        'usuarios': Usuario.objects.filter(is_active=True),
        'empresas': Empresa.objects.filter(ativo=True),
        'areas': Area.objects.filter(ativo=True),
        'setores': Setor.objects.filter(ativo=True),
        'subsetores': SubSetor.objects.filter(ativo=True),
        'modelos': ModeloAuditoria.objects.filter(ativo=True),
        'ativos': Ativo.objects.filter(ativo=True),
        'turnos': Turno.objects.filter(ativo=True),
        'title': 'Criar Auditoria',
        'back_url': 'auditorias:lista_auditorias'
    }
    return render(request, 'auditorias/auditorias/form.html', context)


@login_required
def editar_auditoria(request, pk):
    """Edita uma auditoria existente com a nova lógica de locais."""
    auditoria = get_object_or_404(Auditoria, pk=pk)
    if request.method == 'POST':
        try:
            hoje = timezone.now().date()
            data_inicio_str = request.POST.get('data_inicio')
            data_fim_str = request.POST.get('data_fim')

            if data_inicio_str:
                data_inicio = datetime.strptime(
                    data_inicio_str, '%Y-%m-%d').date()
                # Para edição, permitimos que a data de início seja hoje ou no passado
                # se a auditoria já começou, mas não pode ser alterada para o passado.
                # A regra mais simples e segura é impedir que seja anterior à data original.
                if data_inicio < auditoria.data_inicio:
                    messages.error(
                        request, 'A Data de Início não pode ser movida para o passado.')
                    return redirect('auditorias:editar_auditoria', pk=pk)

            with transaction.atomic():
                data_inicio_str = request.POST.get('data_inicio')
                data_fim_str = request.POST.get('data_fim')
                auditoria.data_inicio = datetime.strptime(
                    data_inicio_str, '%Y-%m-%d').date()
                auditoria.data_fim = datetime.strptime(
                    data_fim_str, '%Y-%m-%d').date() if data_fim_str else None

                schedule_type = request.POST.get('schedule_type')

                # --- NOVA LÓGICA DE AGENDAMENTO ---
                agendamento_especifico = request.POST.get(
                    'agendamento_especifico') == 'on'
                subsetores_selecionados_ids = request.POST.getlist(
                    'subsetores_selecionados')

                modelos_ids = request.POST.getlist('modelos')

                # Atualiza a ferramenta se houver mudança nos modelos
                if modelos_ids:
                    primeiro_modelo = ModeloAuditoria.objects.filter(
                        pk=modelos_ids[0]).select_related('checklist__ferramenta').first()
                    if primeiro_modelo and primeiro_modelo.checklist and primeiro_modelo.checklist.ferramenta:
                        auditoria.ferramenta_id = primeiro_modelo.checklist.ferramenta.id

                # auditoria.ferramenta_id = request.POST.get('ferramenta') <--- REMOVA ou COMENTE esta linha antiga que pegava do form
                auditoria.responsavel_id = request.POST.get('responsavel')

                auditoria.ferramenta_id = request.POST.get('ferramenta')
                auditoria.responsavel_id = request.POST.get('responsavel')
                auditoria.nivel_organizacional = request.POST.get(
                    'nivel_organizacional')
                auditoria.categoria_auditoria = request.POST.get(
                    'categoria_auditoria')
                auditoria.local_empresa_id = request.POST.get(
                    'local_empresa') or None
                auditoria.local_area_id = request.POST.get(
                    'local_area') or None
                auditoria.local_setor_id = request.POST.get(
                    'local_setor') or None
                auditoria.local_subsetor_id = request.POST.get(
                    'local_subsetor') or None
                auditoria.por_frequencia = schedule_type == 'por_frequencia'
                auditoria.por_intervalo = schedule_type == 'por_intervalo'
                auditoria.frequencia = request.POST.get('frequencia') or None
                auditoria.intervalo = int(request.POST.get(
                    'intervalo')) if request.POST.get('intervalo') else None
                auditoria.numero_repeticoes = int(request.POST.get(
                    'numero_repeticoes')) if request.POST.get('numero_repeticoes') else None
                auditoria.pular_finais_semana = request.POST.get(
                    'pular_finais_semana') == 'on'
                auditoria.contem_turnos = request.POST.get(
                    'contem_turnos') == 'on'
                auditoria.agendamento_especifico = agendamento_especifico  # Salva o novo flag

                auditoria.save()

                auditoria.modelos.set(modelos_ids)
                auditoria.ativos_auditados.set(
                    request.POST.getlist('ativos_auditados'))
                auditoria.turnos.set(request.POST.getlist('turnos'))

                # --- CHAMA A FUNÇÃO ATUALIZADA ---
                _gerar_instancias_para_auditoria(
                    auditoria, subsetores_selecionados_ids)

            messages.success(request, 'Auditoria atualizada com sucesso!')
            return redirect('auditorias:lista_auditorias')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar auditoria: {repr(e)}')
            import traceback
            traceback.print_exc()  # Para debug

    # Contexto para o método GET
    context = {
        'auditoria': auditoria,
        'ferramentas': FerramentaDigital.objects.all(),
        'usuarios': Usuario.objects.filter(is_active=True),
        'empresas': Empresa.objects.filter(ativo=True),
        'areas': Area.objects.filter(ativo=True),
        'setores': Setor.objects.filter(ativo=True),
        'subsetores': SubSetor.objects.filter(ativo=True),
        'modelos': ModeloAuditoria.objects.filter(ativo=True),
        'ativos': Ativo.objects.filter(ativo=True),
        'turnos': Turno.objects.filter(ativo=True),
        'title': 'Editar Auditoria',
        'back_url': 'auditorias:lista_auditorias'
    }
    return render(request, 'auditorias/auditorias/form.html', context)


@login_required
def deletar_auditoria(request, pk):
    """Deleta uma auditoria"""
    auditoria = get_object_or_404(Auditoria, pk=pk)

    if request.method == 'POST':
        try:
            auditoria.delete()
            messages.success(request, 'Auditoria deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar auditoria: {repr(e)}')
        return redirect('auditorias:lista_auditorias')

    context = {
        'object': auditoria,
        'title': 'Auditoria'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


# ============================================================================
# VIEWS AJAX PARA FILTROS DINÂMICOS
# ============================================================================

@login_required
def get_areas_por_empresa(request):
    """Retorna áreas de uma empresa via AJAX"""
    empresa_id = request.GET.get('empresa_id')
    areas = Area.objects.filter(
        empresa_id=empresa_id, ativo=True).values('id', 'nome')
    return JsonResponse(list(areas), safe=False)


@login_required
def get_setores_por_area(request):
    """Retorna setores de uma área via AJAX"""
    area_id = request.GET.get('area_id')
    setores = Setor.objects.filter(
        area_id=area_id, ativo=True).values('id', 'nome')
    return JsonResponse(list(setores), safe=False)


@login_required
def get_subsetores_por_setor(request):
    """Retorna subsetores de um setor via AJAX"""
    setor_id = request.GET.get('setor_id')
    subsetores = SubSetor.objects.filter(
        setor_id=setor_id, ativo=True).values('id', 'nome')
    return JsonResponse(list(subsetores), safe=False)


@login_required
def get_ativos_por_local(request):
    """Retorna ativos filtrados por localização via AJAX"""
    nivel = request.GET.get('nivel')
    local_id = request.GET.get('local_id')

    ativos = Ativo.objects.filter(ativo=True)

    if nivel == 'EMPRESA' and local_id:
        ativos = ativos.filter(
            estrutura_organizacional__setor__area__empresa_id=local_id)
    elif nivel == 'AREA' and local_id:
        ativos = ativos.filter(
            estrutura_organizacional__setor__area_id=local_id)
    elif nivel == 'SETOR' and local_id:
        ativos = ativos.filter(estrutura_organizacional__setor_id=local_id)
    elif nivel == 'SUBSETOR' and local_id:
        ativos = ativos.filter(estrutura_organizacional_id=local_id)

    ativos_data = ativos.values('id', 'tag', 'descricao')
    return JsonResponse(list(ativos_data), safe=False)

# --- ADICIONE ESTA NOVA VIEW ABAIXO ---


@login_required
def get_subsetores_por_nivel(request):
    """
    Retorna subsetores filtrados por nível organizacional (Empresa, Área, ou Setor).
    """
    empresa_id = request.GET.get('empresa_id')
    area_id = request.GET.get('area_id')
    setor_id = request.GET.get('setor_id')

    queryset = SubSetor.objects.filter(ativo=True)

    if setor_id:
        queryset = queryset.filter(setor_id=setor_id)
    elif area_id:
        queryset = queryset.filter(setor__area_id=area_id)
    elif empresa_id:
        queryset = queryset.filter(setor__area__empresa_id=empresa_id)
    else:
        # Se nenhum ID for fornecido, retorna uma lista vazia
        queryset = queryset.none()

    subsetores = queryset.values('id', 'nome').order_by('nome')
    return JsonResponse(list(subsetores), safe=False)
# --- FIM DA NOVA VIEW ---


@login_required
def lista_perguntas(request, checklist_pk):
    """Lista todas as perguntas de um checklist, agrupadas por tópico."""
    checklist = get_object_or_404(Checklist, pk=checklist_pk)
    topicos_com_perguntas = checklist.topicos.prefetch_related(
        'perguntas').order_by('ordem')

    context = {
        'checklist': checklist,
        'topicos_com_perguntas': topicos_com_perguntas,
        'title': f'Perguntas do Checklist: {checklist.nome}',
        'back_url': 'auditorias:lista_checklists'
    }
    return render(request, 'auditorias/perguntas/lista.html', context)


@login_required
def criar_pergunta(request, checklist_pk):
    """Cria uma nova pergunta para um tópico dentro de um checklist."""
    checklist = get_object_or_404(Checklist, pk=checklist_pk)

    if request.method == 'POST':
        topico_id = request.POST.get('topico')
        descricao = request.POST.get('descricao')

        if topico_id and descricao:
            try:
                Pergunta.objects.create(
                    topico_id=topico_id,
                    descricao=descricao,
                    campo_obrigatorio=request.POST.get(
                        'campo_obrigatorio') == 'on',
                    campo_desabilitado=request.POST.get(
                        'campo_desabilitado') == 'on',
                    ordem=int(request.POST.get('ordem', 0))
                )
                messages.success(request, 'Pergunta criada com sucesso!')
                return redirect('auditorias:lista_perguntas', checklist_pk=checklist.pk)
            except Exception as e:
                messages.error(request, f'Erro ao criar pergunta: {e}')
        else:
            messages.error(request, 'Tópico e Descrição são obrigatórios.')

    context = {
        'checklist': checklist,
        'topicos': checklist.topicos.order_by('ordem'),
        'title': 'Criar Nova Pergunta',
        'back_url': reverse('auditorias:lista_perguntas', kwargs={'checklist_pk': checklist.pk}),
    }
    return render(request, 'auditorias/perguntas/form.html', context)


@login_required
def editar_pergunta(request, pk):
    """Edita uma pergunta existente."""
    pergunta = get_object_or_404(Pergunta.objects.select_related(
        'topico__checklist').prefetch_related('opcoes_resposta', 'opcoes_porcentagem'), pk=pk)
    checklist = pergunta.topico.checklist

    if request.method == 'POST':
        topico_id = request.POST.get('topico')
        descricao = request.POST.get('descricao')

        if topico_id and descricao:
            try:
                pergunta.topico_id = topico_id
                pergunta.descricao = descricao
                pergunta.campo_obrigatorio = request.POST.get(
                    'campo_obrigatorio') == 'on'
                pergunta.campo_desabilitado = request.POST.get(
                    'campo_desabilitado') == 'on'
                pergunta.ordem = int(request.POST.get('ordem', 0))
                pergunta.save()

                messages.success(request, 'Pergunta atualizada com sucesso!')
                return redirect('auditorias:lista_perguntas', checklist_pk=checklist.pk)
            except Exception as e:
                messages.error(request, f'Erro ao atualizar pergunta: {e}')
        else:
            messages.error(request, 'Tópico e Descrição são obrigatórios.')

    context = {
        'object': pergunta,
        'checklist': checklist,
        'topicos': checklist.topicos.order_by('ordem'),
        'title': 'Editar Pergunta',
        'back_url': reverse('auditorias:lista_perguntas', kwargs={'checklist_pk': checklist.pk}),
    }
    return render(request, 'auditorias/perguntas/form.html', context)


@login_required
def deletar_pergunta(request, pk):
    """Deleta uma pergunta."""
    pergunta = get_object_or_404(
        Pergunta.objects.select_related('topico__checklist'), pk=pk)
    checklist_pk = pergunta.topico.checklist.pk

    if request.method == 'POST':
        try:
            pergunta.delete()
            messages.success(request, 'Pergunta deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar pergunta: {e}')
        return redirect('auditorias:lista_perguntas', checklist_pk=checklist_pk)

    context = {
        'object': pergunta,
        'title': 'Pergunta',
        'back_url': reverse('auditorias:lista_perguntas', kwargs={'checklist_pk': checklist_pk}),
    }
    return render(request, 'auditorias/deletar_pergunta.html', context)


@login_required
def lista_topicos(request):
    """Lista todos os tópicos com busca e paginação."""
    search = request.GET.get('search', '')
    topicos = Topico.objects.select_related(
        'checklist').order_by('checklist__nome', 'ordem')

    if search:
        topicos = topicos.filter(
            Q(descricao__icontains=search) | Q(
                checklist__nome__icontains=search)
        )

    paginator = Paginator(topicos, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Tópicos de Checklist',
        'singular': 'Tópico',
        'button_text': 'Novo Tópico',
        'create_url': 'auditorias:criar_topico',
        'artigo': 'o',
        'empty_message': 'Nenhum tópico cadastrado.',
        'empty_subtitle': 'Comece criando o primeiro tópico.'
    }
    return render(request, 'auditorias/topicos/lista.html', context)


@login_required
def criar_topico(request):
    """Cria um novo tópico."""
    if request.method == 'POST':
        descricao = request.POST.get('descricao')
        checklist_id = request.POST.get('checklist')
        ordem = request.POST.get('ordem', 0)

        if descricao and checklist_id:
            try:
                Topico.objects.create(
                    descricao=descricao,
                    checklist_id=checklist_id,
                    ordem=int(ordem)
                )
                messages.success(request, 'Tópico criado com sucesso!')
                return redirect('auditorias:lista_topicos')
            except Exception as e:
                messages.error(request, f'Erro ao criar tópico: {e}')
        else:
            messages.error(request, 'Descrição e Checklist são obrigatórios.')

    context = {
        'title': 'Criar Tópico',
        'back_url': 'auditorias:lista_topicos',
        'checklists': Checklist.objects.filter(ativo=True)
    }
    return render(request, 'auditorias/topicos/form.html', context)


@login_required
def editar_topico(request, pk):
    """Edita um tópico existente."""
    topico = get_object_or_404(Topico, pk=pk)
    if request.method == 'POST':
        topico.descricao = request.POST.get('descricao')
        topico.checklist_id = request.POST.get('checklist')
        topico.ordem = int(request.POST.get('ordem', 0))

        if topico.descricao and topico.checklist_id:
            try:
                topico.save()
                messages.success(request, 'Tópico atualizado com sucesso!')
                return redirect('auditorias:lista_topicos')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar tópico: {e}')
        else:
            messages.error(request, 'Descrição e Checklist são obrigatórios.')

    context = {
        'object': topico,
        'title': 'Editar Tópico',
        'back_url': 'auditorias:lista_topicos',
        'checklists': Checklist.objects.filter(ativo=True)
    }
    return render(request, 'auditorias/topicos/form.html', context)


@login_required
def deletar_topico(request, pk):
    """Deleta um tópico."""
    topico = get_object_or_404(Topico, pk=pk)
    if request.method == 'POST':
        try:
            topico.delete()
            messages.success(request, 'Tópico deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar tópico: {e}')
        return redirect('auditorias:lista_topicos')

    context = {
        'object': topico,
        'title': 'Tópico'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


class AuditoriasPendentesAPIView(ListAPIView):
    """
    Endpoint da API que retorna a lista de instâncias de auditoria
    pendentes para o usuário autenticado.
    """
    serializer_class = AuditoriaInstanciaListSerializer
    # Garante que apenas usuários logados acessem
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        """
        Este método é sobrescrito para retornar apenas os objetos
        relevantes para o usuário que fez a requisição.
        """
        user = self.request.user
        hoje = timezone.now().date()

        # Filtra as instâncias não executadas
        # E que a auditoria pai tenha o usuário logado como responsável
        # 1. Pega o queryset de todas as auditorias não executadas do usuário
        todas_pendentes = AuditoriaInstancia.objects.filter(
            executada=False,
            responsavel=user,
        ).select_related(
            'auditoria_agendada__local_empresa',
            'auditoria_agendada__local_empresa',
            'auditoria_agendada__local_area',
            'auditoria_agendada__local_setor',
            'auditoria_agendada__local_subsetor',
            'auditoria_agendada__ferramenta'
        ).order_by('data_execucao')

        # 2. Pega os IDs das auditorias que estão em quarentena (usando a mesma lógica da outra view)
        quarentena_ids = AuditoriaInstancia.objects.filter(
            executada=False,
            responsavel=user,
            data_execucao__lt=hoje
        ).annotate(
            limite_quarentena=F(
                'auditoria_agendada__modelos__categoria__dias_para_quarentena'),
            dias_de_atraso=ExpressionWrapper(
                hoje - F('data_execucao'), output_field=fields.DurationField())
        ).filter(
            dias_de_atraso__gt=F('limite_quarentena') * timedelta(days=1)
        ).values_list('id', flat=True)

        # 3. Retorna a lista de pendentes EXCLUINDO os IDs da quarentena
        return todas_pendentes.exclude(id__in=quarentena_ids).order_by('data_execucao')


class AuditoriaInstanciaDetailAPIView(RetrieveAPIView):
    """
    Endpoint da API que retorna os detalhes completos de uma
    única instância de auditoria, incluindo o checklist.
    """
    serializer_class = AuditoriaInstanciaDetailSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        """
        Garante que o usuário só possa ver instâncias de auditorias
        pelas quais ele é o responsável.
        """
        user = self.request.user
        return AuditoriaInstancia.objects.filter(responsavel=user)


class SubmeterAuditoriaAPIView(APIView):
    permission_classes = [IsAuthenticated]

    def post(self, request, pk):
        try:
            instancia = AuditoriaInstancia.objects.get(
                pk=pk,
                responsavel=request.user,
                executada=False
            )
        except AuditoriaInstancia.DoesNotExist:
            return Response(
                {"detail": "Instância de auditoria não encontrada ou já finalizada."},
                status=status.HTTP_404_NOT_FOUND
            )

        # --- NOVA LÓGICA PARA ATUALIZAR O LOCAL ---
        local_execucao_id = request.data.get('local_execucao_id')
        if local_execucao_id and instancia.local_execucao is None:
            try:
                subsetor = SubSetor.objects.get(pk=local_execucao_id)
                instancia.local_execucao = subsetor
                # Não salvamos ainda, vamos salvar junto com o 'executada=True'
            except SubSetor.DoesNotExist:
                return Response(
                    {"detail": "O local de execução (subsetor) fornecido não é válido."},
                    status=status.HTTP_400_BAD_REQUEST
                )
        # --- FIM DA NOVA LÓGICA ---

        respostas_data = request.data.get('respostas', [])
        contexto = {'auditoria_instancia': instancia}
        respostas_serializer = RespostaSerializer(
            data=respostas_data, many=True, context=contexto)

        if respostas_serializer.is_valid():
            respostas_serializer.save()

            instancia.executada = True
            instancia.save()  # Agora salva o 'local_execucao' atualizado e o 'executada'

            return Response(
                {"detail": "Auditoria submetida com sucesso!"},
                status=status.HTTP_200_OK
            )

        return Response(respostas_serializer.errors, status=status.HTTP_400_BAD_REQUEST)


class LocaisPermitidosAPIView(ListAPIView):
    """
    Endpoint da API que retorna a lista de SubSetores permitidos
    para uma instância de auditoria de gestão (flutuante).
    """
    permission_classes = [IsAuthenticated]

    def get_serializer(self, *args, **kwargs):
        # Esta view não usa um serializer padrão, então retornamos None
        return None

    def get_queryset(self):
        """
        Filtra os subsetores com base no Nível Organizacional
        definido no Agendamento "pai" da instância.
        """
        instancia_id = self.kwargs.get('pk')
        try:
            instancia = AuditoriaInstancia.objects.select_related(
                'auditoria_agendada'
            ).get(pk=instancia_id, responsavel=self.request.user)
        except AuditoriaInstancia.DoesNotExist:
            return SubSetor.objects.none()  # Retorna vazio se não encontrar

        agendamento = instancia.auditoria_agendada
        nivel = agendamento.nivel_organizacional

        # Se for auditoria de gestão, busca os locais permitidos
        if not instancia.local_execucao and not agendamento.agendamento_especifico:
            if nivel == 'EMPRESA' and agendamento.local_empresa:
                return SubSetor.objects.filter(setor__area__empresa=agendamento.local_empresa, ativo=True)
            if nivel == 'AREA' and agendamento.local_area:
                return SubSetor.objects.filter(setor__area=agendamento.local_area, ativo=True)
            if nivel == 'SETOR' and agendamento.local_setor:
                return SubSetor.objects.filter(setor=agendamento.local_setor, ativo=True)

        # Se for auditoria específica ou nível subsetor, não retorna nada
        # (pois o local já está definido)
        return SubSetor.objects.none()

    def list(self, request, *args, **kwargs):
        queryset = self.get_queryset()
        # Converte o queryset em dados simples (id, nome) para o Flutter
        data = list(queryset.values('id', 'nome'))
        return Response(data)


class AuditoriasConcluidasAPIView(ListAPIView):
    """
    Endpoint da API que retorna o histórico de instâncias de auditoria
    concluídas pelo usuário autenticado.
    """
    serializer_class = AuditoriaInstanciaListSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        """
        Filtra as instâncias para retornar apenas as que foram executadas
        pelo usuário que fez a requisição, ordenadas pela mais recente.
        """
        user = self.request.user
        return AuditoriaInstancia.objects.filter(
            executada=True,  # <-- A ÚNICA MUDANÇA É AQUI
            auditoria_agendada__responsavel=user
        ).select_related(
            'auditoria_agendada__local_empresa',
            'auditoria_agendada__local_area',
            'auditoria_agendada__local_setor',
            'auditoria_agendada__local_subsetor'
            # Ordena da mais recente para a mais antiga
        ).order_by('-data_execucao')


@login_required
def preview_audit_dates(request):
    """
    Endpoint AJAX que calcula e retorna as datas de auditoria com base
    nos parâmetros do formulário. (VERSÃO FINAL COM REPETIÇÃO AJUSTADA)
    """
    try:
        start_date_str = request.GET.get('data_inicio')
        end_date_str = request.GET.get('ate_dia')
        schedule_type = request.GET.get('schedule_type')
        frequency = request.GET.get('frequencia')
        interval_str = request.GET.get('intervalo')
        repetitions_str = request.GET.get('numero_repeticoes')
        skip_weekends = request.GET.get('pular_fins_semana') == 'true'

        if not start_date_str:
            return JsonResponse({'dates': []})

        start_date = datetime.strptime(start_date_str, '%Y-%m-%d').date()
        end_date = datetime.strptime(
            end_date_str, '%Y-%m-%d').date() if end_date_str else None

        # AQUI ESTÁ A MUDANÇA: Capturamos o número de repetições
        repetitions = int(repetitions_str) if repetitions_str and repetitions_str.isdigit(
        ) and int(repetitions_str) > 0 else 1

        dates = []
        current_date = start_date
        loop_limit = 365 * 5
        loops = 0

        if not end_date:
            if not (skip_weekends and start_date.weekday() >= 5):
                # AQUI ESTÁ A MUDANÇA: Adicionamos a data apenas UMA vez
                dates.append(start_date)
        else:
            while current_date <= end_date and loops < loop_limit:
                loops += 1

                if not (skip_weekends and current_date.weekday() >= 5):
                    # AQUI ESTÁ A MUDANÇA: Adicionamos a data apenas UMA vez
                    dates.append(current_date)

                # A lógica de cálculo da próxima data permanece a mesma
                if schedule_type == 'por_intervalo':
                    interval = int(
                        interval_str) if interval_str and interval_str.isdigit() else 0
                    current_date += timedelta(days=interval + 1)
                elif schedule_type == 'por_frequencia':
                    if frequency == 'DIARIO':
                        current_date += timedelta(days=1)
                    # ... (resto da lógica de frequência)
                    elif frequency == 'SEMANAL':
                        current_date += timedelta(weeks=1)
                    elif frequency == 'QUINZENAL':
                        current_date += timedelta(weeks=2)
                    elif frequency == 'MENSAL':
                        current_date += relativedelta(months=1)
                    elif frequency == 'ANUAL':
                        current_date += relativedelta(years=1)
                else:
                    current_date += timedelta(days=1)

        # Formatação final para a resposta JSON
        dias_semana = ["seg.", "ter.", "qua.", "qui.", "sex.", "sáb.", "dom."]
        meses = ["jan.", "fev.", "mar.", "abr.", "mai.", "jun.",
                 "jul.", "ago.", "set.", "out.", "nov.", "dez."]

        formatted_dates = [{
            'auditoria_num': i + 1,
            # <-- AQUI ESTÁ A MUDANÇA: Usamos o número de repetições para todas as linhas
            'repeticao_num': repetitions,
            'dia_semana': dias_semana[date.weekday()],
            'dia': date.strftime('%d'),
            'mes': meses[date.month - 1],
            'ano': date.year
        } for i, date in enumerate(dates)]

        return JsonResponse({'dates': formatted_dates})

    except (ValueError, TypeError) as e:
        return JsonResponse({'error': f'Parâmetros inválidos: {repr(e)}'}, status=400)


@login_required
def lista_execucoes(request):
    """Exibe o histórico de todas as instâncias de auditoria PENDENTES e ATRASADAS."""
    instancias_list = AuditoriaInstancia.objects.exclude(executada=True).select_related(
        'auditoria_agendada__responsavel',
        'auditoria_agendada__ferramenta',
        'auditoria_agendada__criado_por',
        'local_execucao',
        'responsavel'
    ).prefetch_related(
        'auditoria_agendada__modelos'
    ).order_by('data_execucao')

    search = request.GET.get('search', '')
    if search:
        instancias_list = instancias_list.filter(
            Q(auditoria_agendada__responsavel__first_name__icontains=search) |
            Q(local_execucao__nome__icontains=search) |
            Q(auditoria_agendada__modelos__descricao__icontains=search)
        ).distinct()

    paginator = Paginator(instancias_list, 15)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    all_users_list = list(Usuario.objects.filter(is_active=True).annotate(
        name=Concat('first_name', Value(' '), 'last_name')
    ).values('id', 'name'))

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Auditorias para Execução',
        'all_users_json': json.dumps(all_users_list),
        'singular': 'Execução',
        'artigo': 'a',
        'create_url': 'auditorias:criar_auditoria',
        'button_text': 'Nova Auditoria',
        'empty_message': 'Nenhuma auditoria pendente ou atrasada encontrada.',
        'empty_subtitle': 'Todas as auditorias estão em dia!'
    }
    return render(request, 'auditorias/execucoes.html', context)


@login_required
def historico_concluidas(request):
    """Exibe o histórico de todas as instâncias de auditoria CONCLUÍDAS."""

    # A query agora filtra apenas as instâncias executadas
    instancias_list = AuditoriaInstancia.objects.filter(executada=True).select_related(
        'auditoria_agendada__responsavel',
        'auditoria_agendada__ferramenta',
    ).prefetch_related(
        'auditoria_agendada__modelos',
        'respostas'
    ).order_by('-data_execucao')

    search = request.GET.get('search', '')
    if search:
        # ... (lógica de busca pode ser adicionada aqui se necessário) ...
        pass

    paginator = Paginator(instancias_list, 15)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Histórico de Auditorias Concluídas',
        'singular': 'Auditoria',
        'artigo': 'a',
        'button_text': 'Nova Auditoria',
        'create_url': 'auditorias:criar_auditoria',
        'empty_message': 'Nenhuma auditoria concluída foi encontrada.',
        'empty_subtitle': 'As auditorias finalizadas aparecerão aqui.'
    }
    return render(request, 'auditorias/historico_concluidas.html', context)


@login_required
def redirecionar_agendamento(request, pk):
    """ Redireciona o auditor de um AGENDAMENTO PAI e de todas as suas execuções filhas não concluídas. """
    if request.method == 'POST':
        novo_responsavel_id = request.POST.get('responsavel_id')
        if novo_responsavel_id:
            try:
                # Usamos .filter() para poder usar .update()
                agendamento = Auditoria.objects.filter(pk=pk)
                if not agendamento.exists():
                    messages.error(request, 'Agendamento não encontrado.')
                    return redirect(request.META.get('HTTP_REFERER', 'auditorias:lista_auditorias'))

                # 1. Atualiza o agendamento pai diretamente no banco, sem chamar o save()
                agendamento.update(responsavel_id=novo_responsavel_id)

                # 2. Atualiza todas as execuções filhas NÃO CONCLUÍDAS
                # Usamos o ID do agendamento para encontrar as instâncias corretas
                AuditoriaInstancia.objects.filter(
                    auditoria_agendada_id=pk,
                    executada=False
                ).update(responsavel_id=novo_responsavel_id)

                messages.success(
                    request, f'Agendamento #{pk} e suas execuções foram redirecionados.')
            except Exception as e:
                messages.error(request, f'Erro ao redirecionar: {e}')

    return redirect(request.META.get('HTTP_REFERER', 'auditorias:lista_auditorias'))


@login_required
def redirecionar_execucao(request, pk):
    """ Redireciona o auditor de uma ÚNICA EXECUÇÃO. """
    execucao = get_object_or_404(AuditoriaInstancia, pk=pk)
    if request.method == 'POST':
        novo_responsavel_id = request.POST.get('responsavel_id')
        if novo_responsavel_id:
            try:
                # Atualiza o responsável apenas desta execução
                execucao.responsavel_id = novo_responsavel_id
                execucao.save(update_fields=['responsavel'])
                messages.success(
                    request, f'Execução #{execucao.id} foi redirecionada com sucesso.')
            except Exception as e:
                messages.error(request, f'Erro ao redirecionar: {e}')

    return redirect(request.META.get('HTTP_REFERER', 'auditorias:lista_execucoes'))


@login_required
def deletar_execucao(request, pk):
    """ Deleta uma única instância de auditoria. """
    instancia = get_object_or_404(AuditoriaInstancia, pk=pk)
    if request.method == 'POST':
        try:
            instancia.delete()
            messages.success(
                request, f'Execução #{instancia.id} deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar a execução: {e}')

    # Redireciona de volta para a lista de execuções
    return redirect('auditorias:lista_execucoes')


@login_required
def detalhes_auditoria(request, pk):
    """Exibe os detalhes de uma instância de auditoria concluída."""
    try:
        # AQUI ESTÁ A CORREÇÃO: 'checklistusado' foi corrigido para 'checklist_usado'
        instancia = AuditoriaInstancia.objects.select_related(
            'auditoria_agendada__responsavel',
            'auditoria_agendada__ferramenta',
            'local_execucao__setor__area__empresa',
            'responsavel',
            'checklist_usado'  # Corrigido de 'checklistusado'
        ).prefetch_related(
            'respostas__pergunta__topico',
            'respostas__anexos'
        ).get(pk=pk)

        # Organizar as respostas por tópico para facilitar a exibição no template
        respostas_por_topico = {}
        if instancia.checklist_usado:
            for topico in instancia.checklist_usado.topicos.all().order_by('ordem'):
                respostas_por_topico[topico] = []

        for resposta in instancia.respostas.all().order_by('pergunta__ordem'):
            topico = resposta.pergunta.topico
            if topico in respostas_por_topico:
                respostas_por_topico[topico].append(resposta)

        context = {
            'instancia': instancia,
            'respostas_por_topico': respostas_por_topico,
            'title': f'Detalhes da Auditoria #{instancia.id}'
        }
        return render(request, 'auditorias/detalhes_auditoria.html', context)

    except AuditoriaInstancia.DoesNotExist:
        messages.error(
            request, 'A instância de auditoria solicitada não foi encontrada.')
        return redirect('auditorias:historico_concluidas')


@login_required
def detalhes_historico_auditoria(request, pk):
    instancia = get_object_or_404(
        AuditoriaInstancia.objects.select_related(
            'checklist_usado',
            'local_execucao__setor__area__empresa',
            'auditoria_agendada__ferramenta',
            'responsavel'
        ).prefetch_related(
            'auditoria_agendada__modelos__categoria__pilar',
            'respostas__opcao_resposta',
            'respostas__opcao_porcentagem',  # Adiciona prefetch para otimizar
            'respostas__anexos'
        ),
        pk=pk
    )

    respostas_map = {
        resposta.pergunta_id: resposta
        for resposta in instancia.respostas.all()
    }

    # Cálculo de Tempo
    tempo_execucao_str = "N/A"
    respostas_queryset = instancia.respostas.all()
    if respostas_queryset.count() > 1:
        datas_respostas = respostas_queryset.aggregate(
            primeira=Min('data_resposta'),
            ultima=Max('data_resposta')
        )
        if datas_respostas['primeira'] and datas_respostas['ultima']:
            delta = datas_respostas['ultima'] - datas_respostas['primeira']
            total_seconds = int(delta.total_seconds())
            hours = total_seconds // 3600
            minutes = (total_seconds % 3600) // 60
            seconds = total_seconds % 60
            tempo_execucao_str = f"{hours:02}:{minutes:02}:{seconds:02}"

    taxa_conformidade = None
    pontuacao_final = None

    # 1. Cálculos para Perguntas de Conformidade
    respostas_conformidade = instancia.respostas.filter(
        opcao_resposta__isnull=False)
    if respostas_conformidade.exists():
        qtd_na = respostas_conformidade.filter(
            opcao_resposta__status='NA').count()
        qtd_nc = respostas_conformidade.filter(
            opcao_resposta__status='NAO_CONFORME').count()
        total_respondido_conf = respostas_conformidade.count()
        itens_aplicaveis = total_respondido_conf - qtd_na

        taxa_conformidade = ((itens_aplicaveis - qtd_nc) /
                             itens_aplicaveis * 100) if itens_aplicaveis > 0 else 0.0

    # 2. Cálculos para Perguntas de Pontuação
    respostas_porcentagem = instancia.respostas.filter(
        opcao_porcentagem__isnull=False)
    if respostas_porcentagem.exists():
        total_pontos = sum(
            r.opcao_porcentagem.peso for r in respostas_porcentagem if r.opcao_porcentagem)
        total_respostas_validas = respostas_porcentagem.count()

        pontuacao_final = (
            total_pontos / total_respostas_validas) if total_respostas_validas > 0 else 0.0

    # 3. Resumo da Auditoria (mantém o foco em conformidade)
    summary_stats = {
        'total_itens': instancia.respostas.count(),
        'nao_conformidade_maior': respostas_conformidade.filter(grau_nc='NC MAIOR').count(),
        'nao_conformidade_menor': respostas_conformidade.filter(grau_nc='NC MENOR').count(),
        'desvios_solucionados': respostas_conformidade.filter(desvio_solucionado=True).count(),
        'oportunidades_melhoria': respostas_conformidade.filter(oportunidade_melhoria=True).count(),
        'nao_aplicaveis': respostas_conformidade.filter(opcao_resposta__status='NA').count(),
    }

    context = {
        'title': f'Detalhes da Auditoria #{instancia.id}',
        'instancia': instancia,
        'respostas_map': respostas_map,
        'tempo_execucao': tempo_execucao_str,
        'summary_stats': summary_stats,

        # --- NOVAS VARIÁVEIS DE CONTEXTO ---
        'taxa_conformidade': taxa_conformidade,
        'pontuacao_final': pontuacao_final,
        # --- FIM DAS NOVAS VARIÁVEIS ---
    }
    return render(request, 'auditorias/detalhes_historico.html', context)


@login_required
def lista_planos_de_acao(request):
    usuario = request.user

    # 1. Base da Query (Sem filtros de status ainda)
    queryset = PlanoDeAcao.objects.select_related(
        'origem_resposta__auditoria_instancia__responsavel',
        'responsavel_acao',
        'local_execucao__setor__area__empresa',
        'ferramenta',
        'categoria'
    )

    # 2. Filtro de Segurança
    if not usuario.is_superuser:
        filtro_seguranca = Q(
            responsavel_acao=usuario
        ) | Q(
            origem_resposta__auditoria_instancia__responsavel=usuario
        ) | Q(
            local_execucao__usuario_responsavel=usuario
        ) | Q(
            local_execucao__setor__usuario_responsavel=usuario
        ) | Q(
            local_execucao__setor__area__usuario_responsavel=usuario
        ) | Q(
            local_execucao__setor__area__empresa__usuario_responsavel=usuario
        )
        queryset = queryset.filter(filtro_seguranca).distinct()

    # 3. Lógica de Modos (Ativas vs Finalizadas)
    current_mode = request.GET.get('mode', 'active')  # Padrão é 'active'

    if current_mode == 'finished':
        # MODO FINALIZADAS: Mostra apenas o que acabou
        queryset = queryset.filter(
            status_plano__in=['CONCLUIDO', 'CANCELADO', 'ARQUIVADO'])

        # Contagem para os Cards de Finalizadas
        status_counts = queryset.aggregate(
            concluidas=Count('id', filter=Q(status_plano='CONCLUIDO')),
            recusadas=Count('id', filter=Q(status_plano='CANCELADO')),
            arquivadas=Count('id', filter=Q(status_plano='ARQUIVADO'))
        )

        # Mapa de filtros para Finalizadas
        status_map = {
            'concluidas': ['CONCLUIDO'],
            'recusadas': ['CANCELADO'],
            'arquivadas': ['ARQUIVADO'],
        }

    else:
        # MODO ATIVAS: Exclui o que acabou (Comportamento Padrão)
        queryset = queryset.exclude(
            status_plano__in=['CONCLUIDO', 'CANCELADO', 'ARQUIVADO'])

        # Contagem para os Cards de Ativas
        status_counts = queryset.aggregate(
            recebidas=Count('id', filter=Q(status_plano='ABERTO')),
            aguardando_validacao=Count('id', filter=Q(
                status_plano='AGUARDANDO_VALIDACAO')),
            implementacao=Count('id', filter=Q(
                status_plano='EM_IMPLEMENTACAO')),
            ag_aprovacao=Count('id', filter=Q(
                status_plano='AGUARDANDO_APROVACAO')),
            val_eficacia=Count('id', filter=Q(
                status_plano='VALIDACAO_EFICACIA'))
        )

        # Mapa de filtros para Ativas
        status_map = {
            'recebidas': ['ABERTO'],
            'validacao': ['AGUARDANDO_VALIDACAO'],
            'implementacao': ['EM_IMPLEMENTACAO'],
            'ag_aprovacao': ['AGUARDANDO_APROVACAO'],
            'val_eficacia': ['VALIDACAO_EFICACIA'],
        }

    # 4. Aplicação do Filtro de Status Específico (Clique no Card)
    status_filtro = request.GET.get('status', 'todos')
    if status_filtro != 'todos' and status_filtro in status_map:
        queryset = queryset.filter(status_plano__in=status_map[status_filtro])

    # 5. Filtros de Busca (Input de Texto)
    search_id = request.GET.get('search_id', '')
    search_auditoria_id = request.GET.get('search_auditoria_id', '')

    if search_id:
        queryset = queryset.filter(id__icontains=search_id)
    if search_auditoria_id:
        queryset = queryset.filter(
            origem_resposta__auditoria_instancia__id__icontains=search_auditoria_id)

    # 6. Paginação e Contexto
    paginator = Paginator(queryset.order_by('-data_abertura'), 20)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    # Lista de usuários para os modais
    usuarios_ativos = Usuario.objects.filter(is_active=True).values(
        'id', 'first_name', 'last_name', 'username')

    categorias = CategoriaAuditoria.objects.filter(ativo=True)
    subsetores = SubSetor.objects.filter(
        ativo=True).select_related('setor__area__empresa')

    context = {
        'page_obj': page_obj,
        'title': 'Histórico de Ações Finalizadas' if current_mode == 'finished' else 'Gerenciamento dos Planos de Ações',
        'status_counts': status_counts,
        'current_status': status_filtro,
        # Enviamos o modo para o template saber qual botão mostrar
        'current_mode': current_mode,
        'singular': 'Plano de Ação',
        'artigo': 'o',
        'create_url': 'auditorias:dashboard',
        'button_text': 'Novo Plano',
        'empty_message': 'Nenhum plano encontrado neste status.',
        'searches': {'id': search_id, 'auditoria_id': search_auditoria_id},
        'usuarios_ativos': usuarios_ativos,
        'categorias': categorias,
        'subsetores': subsetores,
        'tem_permissao_criar': request.user.has_perm('auditorias.add_planodeacao')
    }
    return render(request, 'auditorias/planos_de_acao/lista.html', context)


@login_required
@require_POST
def arquivar_plano(request, pk):
    """
    Recebe uma requisição AJAX para arquivar um Plano de Ação.
    """
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        data = json.loads(request.body)
        motivo = data.get('motivo', '')

        # Atualiza o status e o motivo
        plano.status_plano = 'ARQUIVADO'
        plano.motivo_arquivamento = motivo
        plano.save()

        return JsonResponse({'status': 'success', 'message': 'Plano arquivado com sucesso!'})

    except Exception as e:
        return JsonResponse(
            {'status': 'error', 'message': f'Erro ao arquivar: {str(e)}'},
            status=400
        )


@login_required
def get_detalhes_plano(request, pk):
    """Retorna dados completos do plano e da resposta de origem para o modal via AJAX"""
    plano = get_object_or_404(PlanoDeAcao, pk=pk)
    resposta = plano.origem_resposta

    lista_investimentos = []
    total_geral_investido = 0

    # =================================================================
    # 1. LÓGICA DE EVIDÊNCIAS (FOTOS)
    # =================================================================
    evidencias_origem = []
    evidencias_conclusao = []

    # Busca todas as evidências atreladas diretamente ao plano
    todas_evidencias_plano = plano.evidencias.all()

    if resposta:
        # --- CENÁRIO 1: PLANO VINDO DE AUDITORIA ---

        # A. Contexto: Pega as fotos da Resposta da Auditoria
        for anexo in resposta.anexos.all():
            evidencias_origem.append({
                'url': anexo.arquivo.url,
                'nome': anexo.arquivo.name.split('/')[-1]
            })

        # B. Conclusão: Pega as fotos anexadas no Plano (EvidenciaPlano)
        for ev in todas_evidencias_plano:
            evidencias_conclusao.append({
                'url': ev.arquivo.url,
                'nome': ev.arquivo.name.split('/')[-1]
            })

    else:
        # --- CENÁRIO 2: PLANO MANUAL (AVULSO) ---

        # A. Contexto: Como não tem auditoria, as fotos que subimos na criação (EvidenciaPlano)
        # devem aparecer aqui, como solicitado.
        for ev in todas_evidencias_plano:
            evidencias_origem.append({
                'url': ev.arquivo.url,
                'nome': ev.arquivo.name.split('/')[-1]
            })

        # B. Conclusão: Deixamos vazio por enquanto para não duplicar as imagens.
        # (Futuramente, se houver uploads na etapa de conclusão de um plano manual,
        # poderíamos diferenciar pela data de upload ou criar um campo 'tipo' no modelo)
        pass

    # =================================================================
    # 2. LÓGICA DE OBSERVAÇÃO
    # =================================================================
    texto_observacao = "Sem observações."

    if resposta:
        # Prioridade de campos da auditoria
        if resposta.descricao_desvio_nao_solucionado:
            texto_observacao = resposta.descricao_desvio_nao_solucionado
        elif resposta.descricao_oportunidade_melhoria:
            texto_observacao = resposta.descricao_oportunidade_melhoria
        elif resposta.descricao_desvio_solucionado:
            texto_observacao = resposta.descricao_desvio_solucionado
        elif resposta.resposta_livre_texto:
            texto_observacao = resposta.resposta_livre_texto
    else:
        # Plano Manual: Pega do campo de observação de origem
        if plano.observacao_origem:
            texto_observacao = plano.observacao_origem

    # =================================================================
    # 3. INVESTIMENTOS
    # =================================================================
    for inv in plano.investimentos.all().order_by('-data_registro'):
        lista_investimentos.append({
            'descricao': inv.descricao,
            'quantidade': inv.quantidade,
            'valor_unitario': float(inv.valor_unitario),
            'valor_total': float(inv.valor_total)
        })
        total_geral_investido += float(inv.valor_total)

    # =================================================================
    # 4. HISTÓRICO
    # =================================================================
    historico_data = []
    for hist in plano.historico.all():
        data_local = timezone.localtime(hist.data_registro)
        historico_data.append({
            'usuario': hist.usuario.get_full_name() if hist.usuario else "Sistema",
            'avatar': hist.usuario.first_name[0].upper() if hist.usuario and hist.usuario.first_name else "S",
            'descricao': hist.descricao,
            'data': data_local.strftime('%d/%m/%Y'),
            'hora': data_local.strftime('%H:%M'),
            'tipo': hist.tipo
        })

    forum_id = plano.forum.id if plano.forum else None

    # Monta o JSON final
    data = {
        'id': plano.id,

        # Seção de Contexto (Topo do Modal)
        'auditoria_pergunta': plano.titulo,
        'auditoria_observacao': texto_observacao,
        # <--- Agora inclui os uploads manuais aqui
        'auditoria_evidencias': evidencias_origem,

        # Seção de Tratativa
        'causa_raiz': plano.descricao_causa_raiz or '',
        'plano_acao': plano.descricao_acao or '',

        'acoes_realizadas': plano.descricao_acao_realizada or '',
        # <--- Fica vazio para manuais (evita duplicação)
        'evidencias_conclusao': evidencias_conclusao,

        'data_prevista': plano.data_finalizacao_prevista.strftime('%Y-%m-%d') if plano.data_finalizacao_prevista else '',

        'investimentos': lista_investimentos,
        'total_investido': total_geral_investido,
        'historico': historico_data,
        'forum_id': forum_id,
    }
    return JsonResponse(data)


@login_required
@require_POST
def aceitar_plano(request, pk):
    plano = get_object_or_404(PlanoDeAcao, pk=pk)
    try:
        data = json.loads(request.body)

        plano.descricao_causa_raiz = data.get('causa_raiz')
        plano.descricao_acao = data.get('acoes_propostas')

        data_fim = data.get('data_finalizacao')
        if data_fim:
            plano.data_finalizacao_prevista = data_fim

        # --- NOVA LÓGICA DE FLUXO ---
        is_simplificado = data.get('fluxo_simplificado') == True
        plano.fluxo_simplificado = is_simplificado

        if is_simplificado:
            # Pula a validação do auditor e já permite executar
            plano.status_plano = 'EM_IMPLEMENTACAO'
            msg_hist = "Aceitou o plano em Fluxo Simplificado (sem validação)."
        else:
            # Fluxo normal
            plano.status_plano = 'AGUARDANDO_VALIDACAO'
            msg_hist = "Aceitou o plano e enviou para validação."
        # ---------------------------

        plano.save()

        registrar_historico(plano, request.user, msg_hist, "STATUS")

        return JsonResponse({'status': 'success'})
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def aprovar_planejamento(request, pk):
    """
    O Auditor aprova o plano proposto pelo responsável.
    Status muda de AGUARDANDO_VALIDACAO -> EM_IMPLEMENTACAO
    """
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    # Opcional: Verificar permissão (se o usuário é o auditor ou superuser)
    # auditor = plano.origem_resposta.auditoria_instancia.responsavel
    # if request.user != auditor and not request.user.is_superuser:
    #    return JsonResponse({'status': 'error', 'message': 'Apenas o auditor pode aprovar.'}, status=403)

    try:
        # Atualiza o status
        plano.status_plano = 'EM_IMPLEMENTACAO'
        plano.save()

        registrar_historico(
            plano, request.user, "Aprovou o planejamento. Plano em implementação.", "STATUS")

        return JsonResponse({'status': 'success'})
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def adicionar_investimento(request, pk):
    plano = get_object_or_404(PlanoDeAcao, pk=pk)
    try:
        dados = json.loads(request.body)

        # Verifica se recebeu uma lista (novo padrão) ou objeto único (legado/segurança)
        items = dados if isinstance(dados, list) else [dados]

        objs = []
        for item in items:
            descricao = item.get('descricao')
            if not descricao:
                continue  # Pula itens vazios se houver

            objs.append(Investimento(
                plano=plano,
                descricao=descricao,
                quantidade=int(item.get('quantidade', 1)),
                valor_unitario=float(
                    str(item.get('preco', 0)).replace(',', '.'))
            ))

        # Salva tudo de uma vez
        if objs:
            Investimento.objects.bulk_create(objs)

        return JsonResponse({'status': 'success', 'message': f'{len(objs)} investimentos registrados!'})
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def concluir_planejamento(request, pk):
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        acoes_realizadas = request.POST.get('acoes_realizadas')
        if acoes_realizadas:
            plano.descricao_acao_realizada = acoes_realizadas

        arquivos = request.FILES.getlist('evidencias')
        if arquivos:
            for f in arquivos:
                EvidenciaPlano.objects.create(plano=plano, arquivo=f)

        # --- NOVA LÓGICA DE FLUXO ---
        if plano.fluxo_simplificado:
            # Finaliza direto
            plano.status_plano = 'CONCLUIDO'
            plano.data_conclusao = timezone.now()
            msg_hist = "Concluiu a implementação. Plano finalizado automaticamente (Fluxo Simplificado)."
        else:
            # Vai para aprovação do auditor
            plano.status_plano = 'AGUARDANDO_APROVACAO'
            # (Data conclusão real só é setada quando o auditor aprovar de fato, ou aqui como provisória)
            plano.data_conclusao = timezone.now()
            msg_hist = "Concluiu a implementação e enviou para aprovação."
        # ---------------------------

        plano.save()

        registrar_historico(plano, request.user, msg_hist, "ANEXO")

        return JsonResponse({'status': 'success'})
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def avaliar_conclusao(request, pk):
    """
    O Auditor decide se finaliza o plano ou envia para validação de eficácia.
    """
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        data = json.loads(request.body)
        decisao = data.get('decisao')  # 'finalizar' ou 'eficacia'

        if decisao == 'finalizar':
            plano.status_plano = 'CONCLUIDO'
            # Garante que a data de conclusão final é hoje
            plano.data_conclusao = timezone.now()

            registrar_historico(plano, request.user,
                                "Finalizou o plano de ação.", "STATUS")

        elif decisao == 'eficacia':
            plano.status_plano = 'VALIDACAO_EFICACIA'
            # Opcional: Limpar data de conclusão pois o processo continuará
            # plano.data_conclusao = None

            registrar_historico(plano, request.user,
                                "Enviou para validação de eficácia.", "STATUS")

        else:
            return JsonResponse({'status': 'error', 'message': 'Decisão inválida'}, status=400)

        plano.save()
        return JsonResponse({'status': 'success'})

    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def validar_eficacia(request, pk):
    """
    Etapa Final: Validação da Eficácia.
    Status muda de VALIDACAO_EFICACIA -> CONCLUIDO
    """
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        # 1. Salva a observação
        obs = request.POST.get('observacao_eficacia')
        if obs:
            plano.observacao_eficacia = obs

        # 2. Salva as evidências de eficácia (adiciona à lista existente)
        arquivos = request.FILES.getlist('evidencias')
        if arquivos:
            for f in arquivos:
                EvidenciaPlano.objects.create(plano=plano, arquivo=f)

        # 3. Finaliza o Plano
        plano.status_plano = 'CONCLUIDO'
        plano.data_conclusao = timezone.now()  # Data real do fim do ciclo
        plano.save()

        registrar_historico(plano, request.user,
                            "Validou a eficácia e concluiu o plano.", "STATUS")

        return JsonResponse({'status': 'success'})
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def recusar_plano(request, pk):
    """
    Recusa a etapa atual e retorna ao status anterior.
    Se estiver em ABERTO, vai para CANCELADO (some da lista).
    """
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        data = json.loads(request.body)
        motivo = data.get('motivo')

        if motivo:
            # Salva o motivo (pode-se concatenar com histórico se desejar)
            plano.motivo_recusa = motivo

        # --- LÓGICA DE RETORNO ---
        status_atual = plano.status_plano

        if status_atual == 'ABERTO':
            # Responsável rejeitou o plano logo de cara
            plano.status_plano = 'CANCELADO'

        elif status_atual == 'AGUARDANDO_VALIDACAO':
            # Auditor rejeitou o planejamento -> Volta para o Responsável planejar
            plano.status_plano = 'ABERTO'

        elif status_atual == 'AGUARDANDO_APROVACAO':
            # Auditor rejeitou a execução -> Volta para Implementação (fazer de novo/melhorar)
            plano.status_plano = 'EM_IMPLEMENTACAO'

        elif status_atual == 'VALIDACAO_EFICACIA':
            # Se rejeitar a eficácia, volta para aprovação (ou implementação, depende da regra)
            # Geralmente volta para o Auditor decidir o que fazer, ou para implementação
            plano.status_plano = 'AGUARDANDO_APROVACAO'

        plano.save()

        registrar_historico(
            plano, request.user, f"Recusou/Devolveu a etapa. Motivo: {motivo}", "STATUS")

        return JsonResponse({'status': 'success'})
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def clonar_plano(request, pk):
    """
    Duplica um plano de ação existente, resetando o status para ABERTO
    e atribuindo um novo responsável.
    """
    plano_original = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        data = json.loads(request.body)
        novo_responsavel_id = data.get('novo_responsavel')
        orientacoes = data.get('orientacoes')

        if not novo_responsavel_id or not orientacoes:
            return JsonResponse({'status': 'error', 'message': 'Dados incompletos'}, status=400)

        # --- LÓGICA DE CLONAGEM ---
        # 1. Copia o objeto (colocando pk=None, o Django cria um novo ao salvar)
        novo_plano = plano_original
        novo_plano.pk = None
        novo_plano.id = None

        # 2. Define os novos dados
        novo_plano.responsavel_acao_id = novo_responsavel_id
        novo_plano.orientacoes_extra = orientacoes

        novo_plano.origem_orientacao = 'CLONAGEM'

        # 3. Reseta para o estado inicial (Como se fosse novo)
        novo_plano.status_plano = 'ABERTO'
        novo_plano.data_abertura = timezone.now()

        # 4. Limpa dados de execução/histórico do antigo
        novo_plano.prazo_conclusao = None  # Ou mantém o prazo original, você decide
        novo_plano.data_conclusao = None
        novo_plano.descricao_causa_raiz = None
        novo_plano.descricao_acao = None
        novo_plano.descricao_acao_realizada = None
        novo_plano.observacao_eficacia = None
        novo_plano.motivo_recusa = None
        novo_plano.motivo_arquivamento = None
        novo_plano.data_finalizacao_prevista = None

        # 5. Cria um NOVO Fórum (Importante! Não podem compartilhar o chat)
        novo_forum = Forum.objects.create(
            nome=f"Discussão Plano Clonado - {novo_plano.titulo[:30]}..."
        )
        novo_plano.forum = novo_forum

        novo_plano.save()

        return JsonResponse({'status': 'success'})

    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def alterar_prazo(request, pk):
    """
    Altera a data de finalização prevista do plano de ação.
    """
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        data = json.loads(request.body)
        nova_data = data.get('nova_data')

        if nova_data:
            plano.data_finalizacao_prevista = nova_data
            # Se quiser atualizar também o prazo oficial (prazo_conclusao), descomente abaixo:
            # plano.prazo_conclusao = nova_data
            plano.save()
            data_fmt = datetime.strptime(
                nova_data, '%Y-%m-%d').strftime('%d/%m/%Y')
            registrar_historico(
                plano, request.user, f"Alterou a data prevista para {data_fmt}.", "PRAZO")
            return JsonResponse({'status': 'success'})
        else:
            return JsonResponse({'status': 'error', 'message': 'Data inválida'}, status=400)

    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@login_required
@require_POST
def redirecionar_plano(request, pk):
    """
    Transfere a responsabilidade do plano para outro usuário.
    MANTÉM o status atual do plano.
    """
    plano = get_object_or_404(PlanoDeAcao, pk=pk)

    try:
        data = json.loads(request.body)
        novo_responsavel_id = data.get('novo_responsavel')
        acoes_sugeridas = data.get('acoes_sugeridas')

        if not novo_responsavel_id:
            return JsonResponse({'status': 'error', 'message': 'Novo responsável é obrigatório'}, status=400)

        # 1. Atualiza o responsável
        plano.responsavel_acao_id = novo_responsavel_id

        # 2. Salva as ações sugeridas
        if acoes_sugeridas:
            plano.orientacoes_extra = acoes_sugeridas

            plano.origem_orientacao = 'REDIRECIONAMENTO'

        # 3. STATUS: Mantemos o que já estava.
        # A linha abaixo foi removida para atender sua solicitação:
        # plano.status_plano = 'ABERTO'

        plano.save()

        novo_nome = plano.responsavel_acao.get_full_name()
        registrar_historico(
            plano, request.user, f"Redirecionou a ação para {novo_nome}.", "REDISTRIBUICAO")

        return JsonResponse({'status': 'success'})

    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


# 1. API para LISTAR mensagens (Retorna JSON)
@login_required
def api_listar_mensagens(request, forum_id):
    try:
        forum = Forum.objects.get(id=forum_id)
        # Verifica permissão se necessário

        mensagens = []
        for msg in forum.mensagens.all().order_by('data_envio'):
            mensagens.append({
                'id': msg.id,
                'autor': msg.autor.get_full_name() or msg.autor.username,
                'conteudo': msg.conteudo,
                'data_envio': msg.data_envio.strftime('%d/%m/%Y às %H:%M'),
                'is_me': msg.autor == request.user  # Para pintar de cor diferente
            })

        return JsonResponse({'mensagens': mensagens})
    except Forum.DoesNotExist:
        return JsonResponse({'error': 'Fórum não encontrado'}, status=404)

# 2. API para ENVIAR mensagem (Recebe JSON)


@login_required
@require_POST
def api_enviar_mensagem(request, forum_id):
    try:
        forum = get_object_or_404(Forum, id=forum_id)
        data = json.loads(request.body)
        conteudo = data.get('conteudo')

        if conteudo:
            MensagemForum.objects.create(
                forum=forum,
                autor=request.user,
                conteudo=conteudo
            )
            return JsonResponse({'success': True})
        return JsonResponse({'success': False, 'error': 'Conteúdo vazio'})
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)})


@login_required
@require_POST
def criar_plano_manual(request):
    try:
        titulo = request.POST.get('titulo')
        categoria_id = request.POST.get('categoria')
        responsavel_id = request.POST.get('responsavel')
        local_id = request.POST.get('local')
        data_inicio = request.POST.get('data_inicio')
        data_fim = request.POST.get('data_fim')  # Data do modal (Previsão)
        observacao = request.POST.get('observacao')

        if not titulo or not responsavel_id or not data_fim or not categoria_id:
            return JsonResponse({'status': 'error', 'message': 'Preencha os campos obrigatórios.'}, status=400)

        # Busca a ferramenta fixa
        ferramenta_obj, created = FerramentaDigital.objects.get_or_create(
            nome="Plano de Ação")

        novo_plano = PlanoDeAcao(
            titulo=titulo,
            responsavel_acao_id=responsavel_id,
            categoria_id=categoria_id,
            local_execucao_id=local_id,
            ferramenta=ferramenta_obj,

            # REGRAS DE AUDITOR E OBSERVAÇÃO
            criado_por=request.user,          # O usuário logado é o Auditor
            observacao_origem=observacao,     # Vai para observação, não para planejamento

            data_abertura=data_inicio or timezone.now(),

            # REGRAS DE DATA
            prazo_conclusao=None,             # Data Final permanece em branco
            data_finalizacao_prevista=data_fim,  # Preenche apenas a previsão

            descricao_acao=None,              # Planejamento começa vazio
            status_plano='ABERTO',
            tipo='NAO_CONFORMIDADE'
        )

        # Cria Fórum
        novo_forum = Forum.objects.create(
            nome=f"Discussão Plano Manual - {titulo[:30]}...")
        novo_plano.forum = novo_forum

        novo_plano.save()

        # Uploads
        arquivos = request.FILES.getlist('arquivos')
        for f in arquivos:
            EvidenciaPlano.objects.create(plano=novo_plano, arquivo=f)

        registrar_historico(novo_plano, request.user,
                            "Plano de ação criado manualmente.", "CRIACAO")

        return JsonResponse({'status': 'success', 'message': 'Plano criado com sucesso!'})

    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=500)


@login_required
def dashboard_planos_de_acao(request):
    # 1. QuerySets Base
    # Filtra apenas o que o usuário pode ver (reaproveitando lógica de segurança se necessário)
    qs_total = PlanoDeAcao.objects.all()

    # Pendentes: Tudo que não está finalizado
    status_pendentes = ['ABERTO', 'AGUARDANDO_VALIDACAO',
                        'EM_IMPLEMENTACAO', 'AGUARDANDO_APROVACAO', 'VALIDACAO_EFICACIA']
    qs_pendentes = qs_total.filter(status_plano__in=status_pendentes)

    # 2. KPIs (Cards da Esquerda)
    total_pendentes = qs_pendentes.count()

    # Colaboradores distintos com ações pendentes
    colaboradores_pendentes = qs_pendentes.values(
        'responsavel_acao').distinct().count()

    total_geral = qs_total.count()
    porcentagem_pendentes = (
        total_pendentes / total_geral * 100) if total_geral > 0 else 0

    # 3. Gráfico: Ações Pendentes por Status (Pizza)
    status_data = qs_pendentes.values('status_plano').annotate(qtd=Count('id'))
    # Você pode mapear para nomes amigáveis depois
    status_labels = [s['status_plano'] for s in status_data]
    status_series = [s['qtd'] for s in status_data]

    # 4. Gráfico: Total de Ações Geradas por Mês (Barras)
    # Pega os últimos 12 meses
    historico_mes = qs_total.annotate(
        mes=TruncMonth('data_abertura')
    ).values('mes').annotate(qtd=Count('id')).order_by('mes')

    meses_labels = [h['mes'].strftime('%b/%Y') for h in historico_mes]
    meses_series = [h['qtd'] for h in historico_mes]

    # 5. Gráfico: Ações por Ferramenta (Barras Horizontais)
    ferramentas_data = qs_total.values('ferramenta__nome').annotate(
        qtd=Count('id')).order_by('-qtd')[:10]
    ferramenta_labels = [f['ferramenta__nome'] for f in ferramentas_data]
    ferramenta_series = [f['qtd'] for f in ferramentas_data]

    # 6. Gráfico: Ações por Local (Pareto/Barras) - Usando Subsetor
    locais_data = qs_total.values('local_execucao__nome').annotate(
        qtd=Count('id')).order_by('-qtd')[:10]
    local_labels = [l['local_execucao__nome'] for l in locais_data]
    local_series = [l['qtd'] for l in locais_data]

    # 7. Ranking de Usuários (Top 5 Pendentes)
    ranking_data = qs_pendentes.values(
        'responsavel_acao__first_name', 'responsavel_acao__last_name', 'responsavel_acao__username'
    ).annotate(qtd=Count('id')).order_by('-qtd')[:5]

    ranking_list = []
    for r in ranking_data:
        nome = f"{r['responsavel_acao__first_name']} {r['responsavel_acao__last_name']}".strip()
        if not nome:
            nome = r['responsavel_acao__username']
        ranking_list.append({'nome': nome, 'qtd': r['qtd']})

    context = {
        'title': 'Dashboard de Planos de Ação',
        'kpi_total_pendentes': total_pendentes,
        'kpi_colaboradores': colaboradores_pendentes,
        'kpi_porcentagem': f"{porcentagem_pendentes:.1f}%",

        # Dados para JS (converteremos no template com json_script ou direto)
        'chart_status_labels': json.dumps(status_labels),
        'chart_status_series': json.dumps(status_series),

        'chart_mes_labels': json.dumps(meses_labels),
        'chart_mes_series': json.dumps(meses_series),

        'chart_ferramenta_labels': json.dumps(ferramenta_labels),
        'chart_ferramenta_series': json.dumps(ferramenta_series),

        'chart_local_labels': json.dumps(local_labels),
        'chart_local_series': json.dumps(local_series),

        'ranking_list': ranking_list,
    }

    return render(request, 'auditorias/planos_de_acao/dashboard.html', context)


@login_required
def get_dados_calendario(request):
    """Retorna dados para o calendário de auditorias via AJAX - Com Status de Atraso"""
    try:
        ano = int(request.GET.get('year', timezone.now().year))
        mes = int(request.GET.get('month', timezone.now().month))

        instancias = AuditoriaInstancia.objects.filter(
            data_execucao__year=ano,
            data_execucao__month=mes
        )

        dados_dias = {}

        for inst in instancias:
            dia = inst.data_execucao.day
            status_real = inst.status_execucao

            # --- LÓGICA ATUALIZADA (4 STATUS) ---
            if status_real == 'Concluída':
                label = 'Concluído'
                cor = 'success'   # Verde
            elif status_real == 'Atraso':
                label = 'Não realizado'
                cor = 'danger'    # Vermelho
            elif status_real == 'Pendente':
                label = 'Pendente'
                cor = 'warning'   # Laranja
            else:
                # Agendada, Em andamento, etc. viram Planejado
                label = 'Planejado'
                cor = 'secondary'  # Cinza

            if dia not in dados_dias:
                dados_dias[dia] = {}

            chave_status = f"{label}|{cor}"
            dados_dias[dia][chave_status] = dados_dias[dia].get(
                chave_status, 0) + 1

        return JsonResponse({
            'dados': dados_dias,
            'sucesso': True
        })
    except Exception as e:
        return JsonResponse({'sucesso': False, 'erro': str(e)})


@login_required
def lista_quarentena(request):
    """Lista apenas auditorias (instâncias) que estouraram o prazo de quarentena"""
    hoje = date.today()
    auditorias_em_quarentena = []

    auditorias_pendentes = AuditoriaInstancia.objects.filter(
        executada=False,
        data_execucao__lt=hoje
    ).select_related(
        'auditoria_agendada',
        'responsavel',                   # <--- ADICIONADO: Para pegar o Auditor sem nova query
        # <--- ADICIONADO: Para pegar a Ferramenta sem nova query
        'auditoria_agendada__ferramenta',
        'local_execucao'                 # <--- RECOMENDADO: Para o local
    ).prefetch_related(
        'auditoria_agendada__modelos__categoria'
    )

    for instancia in auditorias_pendentes:
        dias_atraso = (hoje - instancia.data_execucao).days
        limite_quarentena = 7

        try:
            agendamento = instancia.auditoria_agendada
            primeiro_modelo = agendamento.modelos.first()
            if primeiro_modelo and primeiro_modelo.categoria:
                limite_quarentena = primeiro_modelo.categoria.dias_para_quarentena
        except Exception:
            pass

        if dias_atraso > limite_quarentena:
            dias_na_quarentena = dias_atraso - limite_quarentena
            # Atributos temporários
            instancia.limite_configurado = limite_quarentena
            instancia.dias_na_quarentena = dias_na_quarentena
            auditorias_em_quarentena.append(instancia)

    context = {
        # <--- CUIDADO: O nome da chave deve bater com o HTML
        'auditorias_quarentena': auditorias_em_quarentena,
        'title': 'Auditorias em Quarentena'
    }
    return render(request, 'auditorias/lista_quarentena.html', context)


class AuditoriasQuarentenaAPIView(ListAPIView):
    """
    Endpoint da API que retorna a lista de instâncias de auditoria
    que estão em quarentena (atrasadas além da tolerância).
    """
    serializer_class = AuditoriaInstanciaListSerializer
    permission_classes = [IsAuthenticated]

    def get_queryset(self):
        user = self.request.user
        hoje = timezone.now().date()

        # Usamos anotações do Django para fazer o cálculo direto no banco de dados
        # Isso é muito mais eficiente do que iterar em Python
        queryset = AuditoriaInstancia.objects.filter(
            executada=False,
            responsavel=user,
            data_execucao__lt=hoje
        ).annotate(
            # Pega o limite de dias da categoria associada
            limite_quarentena=F(
                'auditoria_agendada__modelos__categoria__dias_para_quarentena'),
            # Calcula a diferença de dias entre hoje e a data de execução
            dias_de_atraso=ExpressionWrapper(
                hoje - F('data_execucao'), output_field=fields.DurationField())
        ).filter(
            # Filtra apenas onde os dias de atraso são MAIORES que o limite
            dias_de_atraso__gt=F('limite_quarentena') * timedelta(days=1)
        ).select_related(
            'auditoria_agendada__ferramenta',
            'local_execucao'
        ).order_by('data_execucao')

        return queryset

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\base.html

{% include 'auditorias/partials/_head.html' %}

<body>
    <div class="app-container">
        
        {% include 'auditorias/partials/_sidebar.html' %}

        <main class="main-content">
            
            {% include 'auditorias/partials/_header.html' %}

            <div class="content-area">
                
                {% include 'auditorias/partials/_messages.html' %}

                {% block content %}{% endblock %} 
            </div>
        </main>
    </div>

    <div id="redirectModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-people-arrows"></i> Redirecionar Auditoria</h2>
                <span class="close-btn" onclick="closeRedirectModal()">&times;</span>
            </div>
            <form id="redirectForm" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <label for="responsavel_select">Redirecionar para:</label>
                    <select id="responsavel_select" name="responsavel_id" class="form-control form-select">
                        </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeRedirectModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h2>
                <span class="close-btn" onclick="closeDeleteModal()">&times;</span>
            </div>
            <form id="deleteForm" method="POST">
                {% csrf_token %}
                <div class="modal-body" style="text-align: center;">
                    <p>Tem certeza que deseja excluir o item <strong id="deleteItemName"></strong>?</p>
                    <p style="color: var(--error); font-weight: 500;">Esta ação não pode ser desfeita.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Sim, Excluir</button>
                </div>
            </form>
        </div>
    </div>

    <div id="chatOverlay" class="chat-panel-overlay" onclick="closeChat()"></div>
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <h2><i class="fas fa-comments"></i> Fórum de Mensagens</h2>
            <span class="close-btn" onclick="closeChat()">&times;</span>
        </div>
        <div class="chat-body" id="chatMessages">
            <p style="color: var(--text-muted); text-align: center;">Carregando...</p>
        </div>
        <div class="chat-footer">
            <input type="text" id="chatMessageInput" class="form-control" placeholder="Digite sua mensagem...">
            <button class="btn btn-primary" id="chatSendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    {% include 'auditorias/partials/_scripts.html' %}

    {% block extra_js %}{% endblock %}

    </body>
</html>
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\dashboard.html

{% extends 'auditorias/base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    /* Variáveis e Layout */
    :root {
        --dash-bg: #f8fafc;
        --card-white: #ffffff;
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    /* KPI Cards */
    .kpi-card {
        background: var(--card-white);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-left: 5px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

    .kpi-info h4 { margin: 0; font-size: 13px; color: #64748b; text-transform: uppercase; font-weight: 600; }
    .kpi-info .value { font-size: 28px; font-weight: 800; color: #1e293b; margin-top: 5px; }
    
    .kpi-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }

    /* Cores Específicas dos KPIs */
    .kpi-realizadas { border-left-color: #10b981; }
    .kpi-realizadas .kpi-icon { background: #dcfce7; color: #10b981; }

    .kpi-planejadas { border-left-color: #3b82f6; }
    .kpi-planejadas .kpi-icon { background: #dbeafe; color: #3b82f6; }

    .kpi-eficiencia { border-left-color: #6366f1; }
    .kpi-eficiencia .kpi-icon { background: #e0e7ff; color: #6366f1; }

    .kpi-nc { border-left-color: #ef4444; }
    .kpi-nc .kpi-icon { background: #fee2e2; color: #ef4444; }

    /* Gráficos Containers */
    .chart-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .card-chart {
        background: var(--card-white);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
    }

    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f1f5f9;
    }
    .card-header-custom h3 { font-size: 16px; font-weight: 700; color: #333; margin: 0; }

    /* Tabela */
    .table-responsive { overflow-x: auto; }
    .table-modern { width: 100%; border-collapse: collapse; font-size: 14px; }
    .table-modern th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
    .table-modern td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .table-modern tr:hover td { background: #f8fafc; }

    /* Responsivo */
    @media (max-width: 1024px) {
        .dashboard-grid { grid-template-columns: 1fr 1fr; }
        .chart-row { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
        .dashboard-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">Dashboard de Auditorias</h2>
            <p class="content-subtitle">Indicadores de desempenho e programação (Ano Atual)</p>
        </div>
        <div style="display: flex; gap: 10px;">
            {# Botão Voltar #}
            {% if perms.auditorias.view_auditoria %}
            <a href="{% url 'auditorias:lista_execucoes' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
            {% endif %}

            {% if perms.auditorias.add_auditoria %}
            {# Botão Agendar (Já existia) #}
            <a href="{% url 'auditorias:criar_auditoria' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agendar Auditoria
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="kpi-card kpi-realizadas">
        <div class="kpi-info">
            <h4>Realizadas</h4>
            <div class="value">{{ kpi_realizadas }}</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
    </div>

    <div class="kpi-card kpi-planejadas">
        <div class="kpi-info">
            <h4>Planejadas</h4>
            <div class="value">{{ kpi_planejadas }}</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-calendar-alt"></i></div>
    </div>

    <div class="kpi-card kpi-eficiencia">
        <div class="kpi-info">
            <h4>Eficiência</h4>
            <div class="value">{{ kpi_eficiencia }}%</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
    </div>

    <div class="kpi-card kpi-nc">
        <div class="kpi-info">
            <h4>Itens Não Conforme</h4>
            <div class="value">{{ kpi_nc }}</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
    </div>
</div>

<div class="chart-row">
    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Desempenho Mensal</h3>
        </div>
        <div id="chartMensal"></div>
    </div>

    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Conformidade Geral</h3>
        </div>
        <div id="chartConformidade"></div>
    </div>
</div>

<div class="chart-row" style="grid-template-columns: 1fr 2fr;">
    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Auditorias por Local (Top 10)</h3>
        </div>
        <div id="chartLocais"></div>
    </div>

    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Próximas Auditorias Agendadas</h3>
            <a href="{% url 'auditorias:lista_execucoes' %}" style="font-size: 12px; color: #3b82f6; text-decoration: none;">Ver todas</a>
        </div>
        <div class="table-responsive">
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Local</th>
                        <th>Ferramenta</th>
                        <th>Auditor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for aud in proximas_auditorias %}
                    <tr>
                        <td><span style="font-weight: 600;">{{ aud.data_execucao|date:"d/m/Y" }}</span></td>
                        <td>{{ aud.local_execucao.nome|default:"A definir" }}</td>
                        <td><span class="badge badge-secondary">{{ aud.auditoria_agendada.ferramenta.nome }}</span></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 24px; height: 24px; background: #eff6ff; color: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">
                                    {{ aud.responsavel.first_name.0|default:'U' }}
                                </div>
                                {{ aud.responsavel.get_full_name|default:aud.responsavel.username }}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999; padding: 20px;">Nenhuma auditoria agendada para os próximos dias.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- DADOS DO BACKEND ---
    const labelsMeses = JSON.parse('{{ chart_meses_labels|safe }}');
    const dataPlanejado = JSON.parse('{{ chart_series_planejado|safe }}');
    const dataRealizado = JSON.parse('{{ chart_series_realizado|safe }}');
    
    const labelsLocais = JSON.parse('{{ chart_locais_labels|safe }}');
    const dataLocais = JSON.parse('{{ chart_locais_series|safe }}');
    
    const dataConformidade = JSON.parse('{{ chart_conformidade_series|safe }}');

    // 1. GRÁFICO MENSAL (COLUNAS MISTAS)
    var optionsMensal = {
        series: [{
            name: 'Planejado',
            data: dataPlanejado
        }, {
            name: 'Realizado',
            data: dataRealizado
        }],
        chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '55%',
                borderRadius: 4
            },
        },
        dataLabels: { enabled: false },
        stroke: { show: true, width: 2, colors: ['transparent'] },
        xaxis: { categories: labelsMeses },
        fill: { opacity: 1 },
        colors: ['#3b82f6', '#10b981'], // Azul (Plan), Verde (Real)
        tooltip: {
            y: { formatter: function (val) { return val + " auditorias" } }
        }
    };
    new ApexCharts(document.querySelector("#chartMensal"), optionsMensal).render();

    // 2. GRÁFICO DE PIZZA (CONFORMIDADE)
    var optionsPizza = {
        series: dataConformidade, // [Conforme, Não Conforme]
        labels: ['Conformes', 'Não Conformes'],
        chart: {
            type: 'donut',
            height: 350
        },
        colors: ['#10b981', '#ef4444'], // Verde, Vermelho
        plotOptions: {
            pie: {
                donut: {
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            label: 'Total Itens',
                            formatter: function (w) {
                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                            }
                        }
                    }
                }
            }
        },
        dataLabels: { enabled: false }
    };
    new ApexCharts(document.querySelector("#chartConformidade"), optionsPizza).render();

    // 3. GRÁFICO DE BARRAS HORIZONTAIS (LOCAIS)
    var optionsLocais = {
        series: [{
            name: 'Auditorias',
            data: dataLocais
        }],
        chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: true,
                barHeight: '60%'
            }
        },
        dataLabels: { enabled: true },
        xaxis: { categories: labelsLocais },
        colors: ['#f59e0b'] // Amarelo/Laranja igual imagem
    };
    new ApexCharts(document.querySelector("#chartLocais"), optionsLocais).render();

</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\deletar_generico.html

{% extends 'auditorias/base.html' %}

{% block title %}Deletar {{ title }} - Sistema de Auditorias{% endblock %}
{% block page_title %}Confirmar Exclusão de {{ title }}{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: auto;">
    <div class="card-body" style="text-align: center; padding: 40px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 24px;"></i>
        <h3 class="card-title" style="font-size: 22px;">Tem certeza?</h3>
        <p class="card-subtitle" style="margin-top: 8px; margin-bottom: 24px;">
            Você está prestes a deletar permanentemente o item: <br>
            <strong style="color: var(--text-primary);">"{{ object }}"</strong>
        </p>
        <p class="card-subtitle" style="color: var(--error);">
            Esta ação não pode ser desfeita.
        </p>

        <form method="post">
            {% csrf_token %}
            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 32px;">
                <a href="{{ request.META.HTTP_REFERER|default:'/' }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Sim, deletar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\deletar_pergunta.html

{% extends 'auditorias/base.html' %}

{% block title %}Deletar {{ title }} - Sistema de Auditorias{% endblock %}
{% block page_title %}Confirmar Exclusão de {{ title }}{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: auto;">
    <div class="card-body" style="text-align: center; padding: 40px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 24px;"></i>
        <h3 class="card-title" style="font-size: 22px;">Tem certeza?</h3>
        <p class="card-subtitle" style="margin-top: 8px; margin-bottom: 24px;">
            Você está prestes a deletar permanentemente o item:   

            <strong style="color: var(--text-primary);">"{{ object }}"</strong>
        </p>
        <p class="card-subtitle" style="color: var(--error);">
            Esta ação não pode ser desfeita.
        </p>

        <form method="post">
            {% csrf_token %}
            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 32px;">
                {# CORREÇÃO: Usa a URL completa passada pela view #}
                <a href="{{ back_url }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Sim, deletar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\detalhes_auditoria.html

{% extends 'auditorias/base.html' %}

{% block title %}{{ title }} - Sistema de Auditorias{% endblock %}

{% block pagetitle %}{{ title }}{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">Visualização completa das informações e respostas da auditoria</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-secondary" onclick="window.print()">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <a href="{% url backurl %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>
</div>

<!-- Seção 1: Cabeçalho da Auditoria -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-info-circle"></i> Informações da Execução
        </h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px;">
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-hashtag"></i> ID da Execução
                </div>
                <div class="info-value">{{ object.id }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-calendar-check"></i> Data de Execução
                </div>
                <div class="info-value">{{ object.data_execucao|date:"d/m/Y" }}</div>
            </div>
            
            {% if object.get_data_conclusao %}
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-clock"></i> Data de Conclusão
                </div>
                <div class="info-value">{{ object.get_data_conclusao|date:"d/m/Y H:i" }}</div>
            </div>
            {% endif %}
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-user-check"></i> Auditor
                </div>
                <div class="info-value">{{ object.responsavel.get_full_name|default:object.auditoria_agendada.responsavel.get_full_name|default:"N/A" }}</div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-map-marker-alt"></i> Local de Execução
                </div>
                <div class="info-value">{{ object.local_execucao.nome|default:"N/A" }}</div>
            </div>
            
            {% if object.turno %}
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-clock"></i> Turno
                </div>
                <div class="info-value">{{ object.turno.descricao }}</div>
            </div>
            {% endif %}
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-tools"></i> Ferramenta
                </div>
                <div class="info-value">
                    <span class="badge badge-secondary">
                        {{ object.auditoria_agendada.ferramenta.nome|default:"N/A" }}
                    </span>
                </div>
            </div>
            
            <div class="info-item">
                <div class="info-label">
                    <i class="fas fa-clipboard-list"></i> Checklist Utilizado
                </div>
                <div class="info-value">
                    {% if object.checklistusado %}
                        {{ object.checklistusado.nome }} <span class="badge badge-info">V{{ object.checklistusado.version }}</span>
                    {% else %}
                        N/A
                    {% endif %}
                </div>
            </div>
            
            {% if object.auditoria_agendada.modelos.exists %}
            <div class="info-item" style="grid-column: 1 / -1;">
                <div class="info-label">
                    <i class="fas fa-file-alt"></i> Modelo(s) de Auditoria
                </div>
                <div class="info-value">
                    {% for modelo in object.auditoria_agendada.modelos.all %}
                        <span class="badge badge-info">{{ modelo.descricao }}</span>{% if not forloop.last %} {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Seção 2: Respostas do Checklist -->
{% if dados_estruturados %}
    {% for item in dados_estruturados %}
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">
            <h3 class="card-title" style="color: white; font-size: 18px;">
                <i class="fas fa-layer-group"></i> {{ item.topico.descricao }}
            </h3>
        </div>
        <div class="card-body">
            {% if item.perguntas_respostas %}
                {% for pr in item.perguntas_respostas %}
                <div class="pergunta-container" style="{% if not forloop.last %}margin-bottom: 32px; padding-bottom: 32px; border-bottom: 1px solid var(--border);{% endif %}">
                    <!-- Descrição da Pergunta -->
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <div style="min-width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">
                                {{ forloop.counter }}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 16px; margin-bottom: 8px;">
                                    {{ pr.pergunta.descricao }}
                                    {% if pr.pergunta.obrigatoria %}
                                        <span class="badge badge-error" style="font-size: 11px; margin-left: 8px;">OBRIGATÓRIA</span>
                                    {% endif %}
                                </div>
                                
                                <!-- Tipos de resposta permitidos -->
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                                    {% if pr.pergunta.respostalivre %}
                                        <span class="badge badge-info" style="font-size: 11px;">
                                            <i class="fas fa-keyboard"></i> Resposta Livre
                                        </span>
                                    {% endif %}
                                    {% if pr.pergunta.foto %}
                                        <span class="badge badge-info" style="font-size: 11px;">
                                            <i class="fas fa-camera"></i> Foto
                                        </span>
                                    {% endif %}
                                    {% if pr.pergunta.criaropcao %}
                                        <span class="badge badge-info" style="font-size: 11px;">
                                            <i class="fas fa-list"></i> Opção
                                        </span>
                                    {% endif %}
                                    {% if pr.pergunta.porcentagem %}
                                        <span class="badge badge-info" style="font-size: 11px;">
                                            <i class="fas fa-percent"></i> Porcentagem
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resposta -->
                    <div style="margin-left: 44px;">
                        {% if pr.resposta %}
                            <div style="background: var(--background); border-left: 4px solid var(--primary); padding: 16px; border-radius: var(--radius-md);">
                                <div style="font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">
                                    <i class="fas fa-reply"></i> Resposta
                                </div>
                                
                                <!-- Opção de Resposta -->
                                {% if pr.resposta.opcao_resposta %}
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: var(--radius-md); 
                                            {% if pr.resposta.opcao_resposta.status == 'CONFORME' %}background: rgba(34, 197, 94, 0.1); color: #16a34a;
                                            {% elif pr.resposta.opcao_resposta.status == 'NAOCONFORME' %}background: rgba(239, 68, 68, 0.1); color: #dc2626;
                                            {% elif pr.resposta.opcao_resposta.status == 'NA' %}background: rgba(148, 163, 184, 0.1); color: #64748b;
                                            {% elif pr.resposta.opcao_resposta.status == 'DESVIOSOLUCIONADO' %}background: rgba(251, 191, 36, 0.1); color: #f59e0b;
                                            {% endif %}">
                                            {% if pr.resposta.opcao_resposta.status == 'CONFORME' %}
                                                <i class="fas fa-check-circle"></i>
                                            {% elif pr.resposta.opcao_resposta.status == 'NAOCONFORME' %}
                                                <i class="fas fa-times-circle"></i>
                                            {% elif pr.resposta.opcao_resposta.status == 'NA' %}
                                                <i class="fas fa-minus-circle"></i>
                                            {% elif pr.resposta.opcao_resposta.status == 'DESVIOSOLUCIONADO' %}
                                                <i class="fas fa-exclamation-circle"></i>
                                            {% endif %}
                                            <span style="font-weight: 600; font-size: 15px;">{{ pr.resposta.opcao_resposta.descricao }}</span>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <!-- Opção de Porcentagem -->
                                {% if pr.resposta.opcao_porcentagem %}
                                    <div style="margin-bottom: 12px;">
                                        <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: var(--radius-md); background: {{ pr.resposta.opcao_porcentagem.cor|default:'#e5e7eb' }};">
                                            <i class="fas fa-percent"></i>
                                            <span style="font-weight: 600; font-size: 15px;">{{ pr.resposta.opcao_porcentagem.descricao }}</span>
                                            <span class="badge badge-secondary">Peso: {{ pr.resposta.opcao_porcentagem.peso }}</span>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <!-- Resposta Livre (Texto) -->
                                {% if pr.resposta.respostalivre_texto %}
                                    <div style="margin-bottom: 12px;">
                                        <div style="background: white; border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px; color: var(--text-primary); line-height: 1.6; white-space: pre-wrap;">{{ pr.resposta.respostalivre_texto }}</div>
                                    </div>
                                {% endif %}
                                
                                <!-- Anexos (Fotos) -->
                                {% if pr.resposta.anexos.exists %}
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">
                                            <i class="fas fa-paperclip"></i> Anexos ({{ pr.resposta.anexos.count }})
                                        </div>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
                                            {% for anexo in pr.resposta.anexos.all %}
                                                <div class="anexo-item">
                                                    <a href="{{ anexo.arquivo.url }}" target="_blank" style="text-decoration: none;">
                                                        <div style="position: relative; border-radius: var(--radius-md); overflow: hidden; aspect-ratio: 1; background: var(--background);">
                                                            {% if anexo.arquivo.url|slice:"-4:" in '.jpg,.png,.gif,jpeg,.webp' or anexo.arquivo.url|slice:"-5:" in '.jpeg' %}
                                                                <img src="{{ anexo.arquivo.url }}" alt="Anexo" style="width: 100%; height: 100%; object-fit: cover; transition: transform 0.2s;">
                                                                <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: var(--radius-sm); font-size: 11px;">
                                                                    <i class="fas fa-image"></i>
                                                                </div>
                                                            {% else %}
                                                                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                                                                    <i class="fas fa-file" style="font-size: 32px; margin-bottom: 8px;"></i>
                                                                    <div style="font-size: 11px; text-align: center; padding: 0 8px; word-break: break-word;">{{ anexo.arquivo.name|slice:"-20:" }}</div>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </a>
                                                    <div style="margin-top: 8px; text-align: center;">
                                                        <a href="{{ anexo.arquivo.url }}" download class="btn btn-secondary btn-sm" style="font-size: 11px; padding: 4px 12px;">
                                                            <i class="fas fa-download"></i> Download
                                                        </a>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <!-- Se não houver resposta em nenhum campo -->
                                {% if not pr.resposta.opcao_resposta and not pr.resposta.opcao_porcentagem and not pr.resposta.respostalivre_texto and not pr.resposta.anexos.exists %}
                                    <div style="color: var(--text-muted); font-style: italic;">
                                        <i class="fas fa-info-circle"></i> Nenhuma resposta registrada
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div style="background: var(--background); border-left: 4px solid var(--text-muted); padding: 16px; border-radius: var(--radius-md); color: var(--text-muted); font-style: italic;">
                                <i class="fas fa-question-circle"></i> Pergunta não respondida
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 32px; color: var(--text-muted);">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <p>Nenhuma pergunta encontrada neste tópico.</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="card">
        <div class="card-body" style="text-align: center; padding: 64px 24px;">
            <i class="fas fa-clipboard-list" style="font-size: 64px; color: var(--text-muted); opacity: 0.3; margin-bottom: 24px;"></i>
            <h3 style="color: var(--text-secondary); margin-bottom: 12px;">Nenhum dado disponível</h3>
            <p style="color: var(--text-muted);">Esta auditoria não possui checklist ou respostas registradas.</p>
        </div>
    </div>
{% endif %}

{% endblock %}

{% block extracss %}
<style>
    .info-item {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }
    
    .info-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .info-label i {
        margin-right: 6px;
        color: var(--primary);
    }
    
    .info-value {
        font-size: 15px;
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .pergunta-container {
        transition: all 0.2s ease;
    }
    
    .anexo-item img:hover {
        transform: scale(1.05);
    }
    
    @media print {
        .btn, .content-header button, .content-header a {
            display: none !important;
        }
        
        .card {
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        .pergunta-container {
            page-break-inside: avoid;
            break-inside: avoid;
        }
    }
</style>
{% endblock %}

{% block extrajs %}
<script>
    // Lightbox simples para imagens
    document.addEventListener('DOMContentLoaded', function() {
        const images = document.querySelectorAll('.anexo-item img');
        
        images.forEach(img => {
            img.style.cursor = 'pointer';
            img.addEventListener('click', function(e) {
                e.preventDefault();
                const lightbox = document.createElement('div');
                lightbox.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: zoom-out;';
                
                const imgClone = document.createElement('img');
                imgClone.src = this.src;
                imgClone.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;';
                
                lightbox.appendChild(imgClone);
                document.body.appendChild(lightbox);
                
                lightbox.addEventListener('click', function() {
                    document.body.removeChild(lightbox);
                });
            });
        });
    });
</script>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\detalhes_historico.html

{% extends 'auditorias/base.html' %}
{% load auditoria_extras %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}Relatório de Auditoria{% endblock %}

{% block content %}
<style>
    /* --- ESTILOS GERAIS --- */
    .report-paper {
        background: white;
        max-width: 1100px;
        margin: 0 auto;
        padding: 40px;
        border-radius: 4px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border: 1px solid #e2e8f0;
    }

    /* Cabeçalho */
    .report-header-section {
        border-bottom: 2px solid var(--primary);
        padding-bottom: 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .report-title h1 {
        font-size: 24px;
        font-weight: 800;
        color: var(--text-primary);
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .report-meta {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 5px;
    }

    .section-formal-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-primary);
        text-transform: uppercase;
        margin-bottom: 10px;
        padding-left: 10px;
        border-left: 4px solid var(--primary);
        letter-spacing: 0.05em;
    }

    /* Grid de Informações */
    .info-grid-formal {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        background: #f8fafc;
        padding: 20px;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        margin-bottom: 30px;
    }

    .info-box label {
        display: block;
        font-size: 11px;
        text-transform: uppercase;
        color: #64748b;
        font-weight: 700;
        margin-bottom: 4px;
    }

    .info-box span {
        font-size: 14px;
        color: #0f172a;
        font-weight: 500;
    }

    /* --- RESUMO ESTATÍSTICO (ATUALIZADO COM ÍCONES) --- */
    .stats-strip {
        display: flex;
        gap: 1px;
        background: #e2e8f0;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 40px;
    }

    .stat-item {
        flex: 1;
        background: white;
        padding: 15px 10px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    /* Estilo para links no resumo */
    a.stat-item {
        text-decoration: none;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    a.stat-item:hover {
        background-color: #f8fafc;
        position: relative;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }

    .stat-icon-large {
        font-size: 20px;
        margin-bottom: 2px;
    }

    .stat-number {
        font-size: 22px;
        font-weight: 800;
        line-height: 1;
    }

    .stat-desc {
        font-size: 10px;
        color: #64748b;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    /* --- TABELA DE ITENS --- */
    .topic-section {
        margin-bottom: 30px;
        page-break-inside: avoid;
    }

    .topic-header {
        background: #1e293b;
        color: white;
        padding: 10px 15px;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        border-radius: 4px 4px 0 0;
    }

    .audit-table {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid #e2e8f0;
        font-size: 13px;
    }

    .audit-table th, .audit-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
    }

    .audit-table td.col-details { vertical-align: top; }

    .audit-table th {
        background: #f1f5f9;
        text-align: center;
        font-weight: 600;
        color: #475569;
        text-transform: uppercase;
        font-size: 11px;
    }

    .col-id { width: 5%; text-align: center; color: #94a3b8; font-weight: bold; }
    .col-desc { width: 40%; }
    .col-grau { width: 10%; text-align: center; }
    .col-resp { width: 15%; text-align: center; }
    .col-details { width: 30%; }

    /* ÍCONES DE GRAU (TABELA) */
    .grade-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        font-size: 14px;
    }
    
    /* CORES PADRONIZADAS (USADAS NO RESUMO E NA TABELA) */
    /* Verde */
    .color-conforme { color: #16a34a; }
    .bg-conforme { background: #dcfce7; }
    
    /* Vermelho */
    .color-nc-maior { color: #dc2626; }
    .bg-nc-maior { background: #fee2e2; }
    
    /* Laranja */
    .color-nc-menor { color: #ea580c; }
    .bg-nc-menor { background: #ffedd5; }
    
    /* Azul */
    .color-solucionado { color: #0284c7; }
    .bg-solucionado { background: #e0f2fe; }
    
    /* Roxo */
    .color-oportunidade { color: #7c3aed; }
    .bg-oportunidade { background: #ede9fe; }
    
    /* Cinza */
    .color-na { color: #64748b; }
    .bg-na { background: #f1f5f9; }

    /* Aplicação nas classes da tabela */
    .grade-conforme { color: #16a34a; background: #dcfce7; }
    .grade-nc-maior { color: #dc2626; background: #fee2e2; }
    .grade-nc-menor { color: #ea580c; background: #ffedd5; }
    .grade-solucionado { color: #0284c7; background: #e0f2fe; }
    .grade-oportunidade { color: #7c3aed; background: #ede9fe; }
    .grade-na { color: #64748b; background: #f1f5f9; }

    /* Resultado Texto */
    .result-text { font-weight: 700; text-transform: uppercase; font-size: 11px; }
    .text-conforme { color: #16a34a; }
    .text-nao-conforme { color: #dc2626; }
    .text-na { color: #64748b; }

    /* Detalhes */
    .detail-block {
        background: #f8fafc;
        border-left: 3px solid #cbd5e1;
        padding: 8px 12px;
        margin-bottom: 6px;
        border-radius: 0 4px 4px 0;
        font-size: 12px;
    }
    
    .detail-label {
        font-size: 10px;
        font-weight: 700;
        color: #64748b;
        display: block;
        margin-bottom: 2px;
        text-transform: uppercase;
    }

    .detail-text { color: #334155; white-space: pre-wrap; }

    .photo-grid { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .photo-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #e2e8f0; cursor: zoom-in; }

    .badge-stack { display: flex; flex-direction: column; gap: 4px; align-items: flex-start; margin-top: 4px; }
    .resp-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 10px; text-transform: uppercase; text-align: center; border: 1px solid transparent; white-space: nowrap; }
    
    .resp-conforme { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .resp-nao-conforme { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .resp-na { background: #f1f5f9; color: #475569; border-color: #e2e8f0; }
    .resp-solucionado-check { background: #fef3c7; color: #92400e; border-color: #fde68a; display: flex; align-items: center; gap: 4px; }

    .report-actions { display: flex; justify-content: flex-end; gap: 12px; margin-bottom: 20px; max-width: 1100px; margin-left: auto; margin-right: auto; }

    @media print {
        body { background: white; -webkit-print-color-adjust: exact; }
        .sidebar, .main-header, .report-actions, .app-container { display: none !important; }
        .report-paper { box-shadow: none; border: none; padding: 0; margin: 0; width: 100%; max-width: 100%; }
        .content-area { padding: 0; }
        .main-content { margin-left: 0 !important; }
        .topic-section { page-break-inside: avoid; }
        tr { page-break-inside: avoid; }
        .grade-icon, .stat-item { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
    .progress-bar-cell { background-color: #f1f5f9; border-radius: 4px; height: 12px; width: 100%; overflow: hidden; }
    .progress-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
</style>

<div class="report-actions">
    <a href="{% url 'auditorias:historico_concluidas' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>
    <button class="btn btn-primary" onclick="window.print()">
        <i class="fas fa-print"></i> Imprimir Relatório
    </button>
</div>

<div class="report-paper">
    
    <div style="display: flex; justify-content: flex-end; align-items: flex-start; gap: 40px;">

        {% if taxa_conformidade is not None %}
            <!-- Bloco da Conformidade -->
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #64748b; font-weight: bold; text-transform: uppercase;">CONFORMIDADE</div>
                <div style="font-size: 28px; font-weight: 800; color: var(--primary);">
                    {{ taxa_conformidade|floatformat:1 }}%
                </div>
            </div>
        {% endif %}

        {% if pontuacao_final is not None %}
            <!-- Bloco da Pontuação Média -->
            <div style="text-align: right;">
                <div style="font-size: 12px; color: #64748b; font-weight: bold; text-transform: uppercase;">PONTUAÇÃO MÉDIA</div>
                <div style="font-size: 28px; font-weight: 800; color: var(--accent);">
                    {{ pontuacao_final|floatformat:1 }}
                </div>
            </div>
        {% endif %}

    </div>

    <div class="info-grid-formal">
        <div class="info-box">
            <label>Modelo de Auditoria</label>
            <span>{% for m in instancia.auditoria_agendada.modelos.all %}{{ m.descricao }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
        </div>
        <div class="info-box">
            <label>Checklist</label>
            <span>{{ instancia.checklist_usado.nome }} (V{{ instancia.checklist_usado.version }})</span>
        </div>
        <div class="info-box">
            <label>Local Auditado</label>
            <span>{{ instancia.local_execucao.nome|default:"Não definido" }}</span>
        </div>
        <div class="info-box">
            <label>Pilar</label>
            <span>{% for modelo in instancia.auditoria_agendada.modelos.all %}{{ modelo.categoria.pilar.nome|default:"N/A" }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
        </div>
        <div class="info-box">
            <label>Categoria</label>
            <span>{% for modelo in instancia.auditoria_agendada.modelos.all %}{{ modelo.categoria.descricao|default:"N/A" }}{% if not forloop.last %}, {% endif %}{% endfor %}</span>
        </div>
        <div class="info-box">
            <label>Auditor Responsável</label>
            <span>{{ instancia.responsavel.get_full_name|default:instancia.responsavel.username }}</span>
        </div>
        <div class="info-box">
            <label>Data de Execução</label>
            <span>{{ instancia.get_data_conclusao|date:"d/m/Y - H:i"|default:"--" }}</span>
        </div>
        <div class="info-box">
            <label>Tempo de Execução</label>
            <span>{{ tempo_execucao }}</span>
        </div>
        <div class="info-box">
            <label>Preenchimento:</label>
            <span class="progress-value">{{ instancia.get_percentual_conclusao|floatformat:2 }}%</span>
        </div>
    </div>

    <div class="section-formal-title">Resumo da Auditoria</div>

    <div class="stats-strip">
        <div class="stat-item">
            <i class="fas fa-list-ol stat-icon-large" style="color: var(--text-primary);"></i>
            <span class="stat-number" style="color: var(--text-primary);">{{ summary_stats.total_itens }}</span>
            <span class="stat-desc">Itens</span>
        </div>
        
        <a href="{% url 'auditorias:lista_planos_de_acao' %}?search_auditoria_id={{ instancia.id }}" class="stat-item" title="Ver Planos">
            <i class="fas fa-tools stat-icon-large color-solucionado"></i>
            <span class="stat-number color-solucionado">{{ summary_stats.desvios_solucionados }}</span>
            <span class="stat-desc">Resolvidos</span>
        </a>

        <a href="{% url 'auditorias:lista_planos_de_acao' %}?search_auditoria_id={{ instancia.id }}" class="stat-item" title="Ver Planos">
            <i class="fas fa-lightbulb stat-icon-large color-oportunidade"></i>
            <span class="stat-number color-oportunidade">{{ summary_stats.oportunidades_melhoria }}</span>
            <span class="stat-desc">Oportunidades</span>
        </a>
        
        <a href="{% url 'auditorias:lista_planos_de_acao' %}?search_auditoria_id={{ instancia.id }}" class="stat-item" title="Ver Planos">
            <i class="fas fa-arrow-up stat-icon-large color-nc-maior"></i>
            <span class="stat-number color-nc-maior">{{ summary_stats.nao_conformidade_maior }}</span>
            <span class="stat-desc">NC Maior</span>
        </a>
        
        <a href="{% url 'auditorias:lista_planos_de_acao' %}?search_auditoria_id={{ instancia.id }}" class="stat-item" title="Ver Planos">
            <i class="fas fa-arrow-down stat-icon-large color-nc-menor"></i>
            <span class="stat-number color-nc-menor">{{ summary_stats.nao_conformidade_menor }}</span>
            <span class="stat-desc">NC Menor</span>
        </a>

        <div class="stat-item">
            <i class="fas fa-ban stat-icon-large color-na"></i>
            <span class="stat-number color-na">{{ summary_stats.nao_aplicaveis }}</span>
            <span class="stat-desc">N/A</span>
        </div>
    </div>

    {% if instancia.checklist_usado %}
        {% for topico in instancia.checklist_usado.topicos.all %}
        <div class="topic-section">
            <div class="topic-header">
                <span>{{ topico.descricao }}</span>
            </div>
            
            <table class="audit-table">
                <thead>
                    <tr>
                        <th class="col-id">#</th>
                        <th class="col-desc">Descrição do Item</th>
                        <th class="col-grau">Grau</th>
                        <th class="col-resp">Resultado</th>
                        <th class="col-details">Observações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pergunta in topico.perguntas.all %}
                        {% with resposta=respostas_map|get_item:pergunta.id %}
                        <tr>
                            <td class="col-id">{{ forloop.counter }}</td>
                            <td class="col-desc">{{ pergunta.descricao }}</td>

                            {% if resposta and resposta.opcao_porcentagem %}
                                <!-- RENDERIZAÇÃO PARA RESPOSTA DE PORCENTAGEM -->
                                <td class="col-grau" style="font-weight: 700; font-size: 14px; color: {{ resposta.opcao_porcentagem.cor }};">
                                    {{ resposta.opcao_porcentagem.peso }}%
                                </td>
                                <td class="col-resp">
                                    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 4px;">
                                        <span>{{ resposta.opcao_porcentagem.descricao }}</span>
                                        <div class="progress-bar-cell">
                                            <div class="progress-bar-fill" style="width: {{ resposta.opcao_porcentagem.peso }}%; background-color: {{ resposta.opcao_porcentagem.cor }};"></div>
                                        </div>
                                    </div>
                                </td>
                            {% else %}

                            <td class="col-grau">
                                {% if resposta %}
                                    {% if resposta.opcao_resposta.status == 'NA' %}
                                        <div class="grade-icon grade-na" title="Não Aplicável">
                                            <i class="fas fa-ban"></i>
                                        </div>
                                    
                                    {% elif resposta.desvio_solucionado %}
                                        <div class="grade-icon grade-solucionado" title="Desvio Solucionado">
                                            <i class="fas fa-tools"></i>
                                        </div>

                                    {% elif resposta.oportunidade_melhoria %}
                                        <div class="grade-icon grade-oportunidade" title="Oportunidade de Melhoria">
                                            <i class="fas fa-lightbulb"></i>
                                        </div>

                                    {% elif resposta.grau_nc == 'NC MAIOR' %}
                                        <div class="grade-icon grade-nc-maior" title="Não Conformidade Maior">
                                            <i class="fas fa-arrow-up"></i>
                                        </div>

                                    {% elif resposta.grau_nc == 'NC MENOR' %}
                                        <div class="grade-icon grade-nc-menor" title="Não Conformidade Menor">
                                            <i class="fas fa-arrow-down"></i>
                                        </div>

                                    {% elif resposta.opcao_resposta.status == 'NAO_CONFORME' %}
                                        <div class="grade-icon grade-nc-maior" title="Não Conforme">
                                            <i class="fas fa-times"></i>
                                        </div>

                                    {% else %}
                                        <div class="grade-icon grade-conforme" title="Conforme">
                                            <i class="fas fa-check"></i>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #cbd5e1;">-</span>
                                {% endif %}
                            </td>

                            {% endif %}

                            <td class="col-resp">
                                {% if resposta %}
                                    {% if resposta.opcao_resposta.status == 'NA' %}
                                        <span class="result-text text-na">N/A</span>
                                    {% elif resposta.opcao_resposta.status == 'NAO_CONFORME' and not resposta.desvio_solucionado %}
                                        <span class="result-text text-nao-conforme">Não Conforme</span>
                                    {% else %}
                                        <span class="result-text text-conforme">Conforme</span>
                                    {% endif %}
                                {% else %}
                                    <span style="color: #cbd5e1;">-</span>
                                {% endif %}
                            </td>

                            <td class="col-details">
                                {% if resposta %}
                                    {% if resposta.resposta_livre_texto %}
                                        <div class="detail-block">
                                            <span class="detail-label">Observação:</span>
                                            <span class="detail-text">{{ resposta.resposta_livre_texto }}</span>
                                        </div>
                                    {% endif %}

                                    {% if resposta.descricao_desvio_nao_solucionado %}
                                        <div class="detail-block" style="border-left-color: var(--error);">
                                            <span class="detail-label color-nc-maior">Detalhe do Desvio:</span>
                                            <span class="detail-text">{{ resposta.descricao_desvio_nao_solucionado }}</span>
                                        </div>
                                    {% endif %}

                                    {% if resposta.descricao_desvio_solucionado %}
                                        <div class="detail-block" style="border-left-color: var(--warning);">
                                            <span class="detail-label color-nc-menor">Ação Tomada:</span>
                                            <span class="detail-text">{{ resposta.descricao_desvio_solucionado }}</span>
                                        </div>
                                    {% endif %}

                                    {% if resposta.descricao_oportunidade_melhoria %}
                                        <div class="detail-block" style="border-left-color: #7c3aed;"> {# Cor Roxa #}
                                            <span class="detail-label color-oportunidade">Oportunidade de Melhoria:</span>
                                            <span class="detail-text">{{ resposta.descricao_oportunidade_melhoria }}</span>
                                        </div>
                                    {% endif %}

                                    {% if resposta.planos_de_acao.all %}
                                        <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 5px;">
                                            {% for plano in resposta.planos_de_acao.all %}
                                                
                                                {# Lógica para definir a URL correta baseada no status #}
                                                {% if plano.status_plano == 'CONCLUIDO' or plano.status_plano == 'CANCELADO' or plano.status_plano == 'ARQUIVADO' %}
                                                    {# Se for finalizado, manda para o histórico #}
                                                    <a href="{% url 'auditorias:lista_planos_de_acao' %}?search_id={{ plano.id }}&mode=finished" 
                                                {% else %}
                                                    {# Se for ativo, manda para a lista normal #}
                                                    <a href="{% url 'auditorias:lista_planos_de_acao' %}?search_id={{ plano.id }}" 
                                                {% endif %}
                                                
                                                   target="_blank" 
                                                   title="Gerenciar Plano de Ação #{{ plano.id }}"
                                                   style="font-size: 12px; font-weight: 700; color: #0066cc; text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
                                                    
                                                    <i class="fas fa-external-link-alt"></i> PA #{{ plano.id }}
                                                    
                                                    {# Ícones de Status #}
                                                    {% if plano.status_plano == 'CONCLUIDO' %}
                                                        <i class="fas fa-check-circle" style="color: #16a34a;" title="Concluído"></i>
                                                    {% elif plano.status_plano == 'CANCELADO' %}
                                                        <i class="fas fa-ban" style="color: #dc2626;" title="Recusado"></i>
                                                    {% elif plano.status_plano == 'ARQUIVADO' %}
                                                        <i class="fas fa-archive" style="color: #0ea5e9;" title="Arquivado"></i>
                                                    {% endif %}
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}

                                    {% if resposta.anexos.all %}
                                        <div class="photo-grid">
                                            {% for anexo in resposta.anexos.all %}
                                                <a href="{{ anexo.arquivo.url }}" target="_blank">
                                                    <img src="{{ anexo.arquivo.url }}" class="photo-thumb" alt="Evidência">
                                                </a>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 40px; color: #94a3b8;">
            <p>Nenhum checklist vinculado a esta auditoria.</p>
        </div>
    {% endif %}

    <div style="margin-top: 50px; border-top: 1px solid #e2e8f0; padding-top: 20px; display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8;">
        <div>Sistema de Gestão de Auditorias</div>
        <div>Página gerada automaticamente</div>
    </div>

</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\execucoes.html

{% extends 'auditorias/lista_generica.html' %}

{# --- 1. CABEÇALHO PERSONALIZADO (NOVO) --- #}
{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        
        <div>
            <h2 class="content-title" style="margin-bottom: 8px; font-weight: bold; color: #333;">Execução de Auditorias</h2>
            <p class="content-subtitle text-muted mb-0">Acompanhe o status e os resultados das auditorias em andamento.</p>
        </div>

        <div style="display: flex; gap: 10px;">
            
            <a href="{% url 'auditorias:dashboard' %}" class="btn btn-secondary shadow-sm" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-chart-pie mr-2" style="color: #7c3aed;"></i> 
                Dashboard
            </a>

            <a href="{% url 'auditorias:lista_quarentena' %}" class="btn btn-secondary shadow-sm" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-biohazard mr-2" style="color: #e74a3b;"></i> 
                Quarentena
            </a>

            {% if perms.auditorias.add_auditoria %}
            <a href="{% url 'auditorias:criar_auditoria' %}" class="btn btn-primary shadow-sm">
                <i class="fas fa-plus mr-2"></i>
                Novo Agendamento
            </a>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}


{# --- 2. RESTANTE DO CÓDIGO (MANTIDO IGUAL AO SEU) --- #}

{# Remove o formulário de busca genérico herdado do template pai #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros agora estão no cabeçalho da tabela #}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    {# Linha 1: Títulos das Colunas #}
    <tr>
        <th>ID Execução</th>
        <th>ID Agendamento</th>
        <th>Data Programada</th>
        <th>Auditor</th>
        <th>Local</th>
        <th>Modelo de Auditoria</th>
        <th>Ferramenta</th>
        <th>Plataforma</th>
        <th>Status</th>
        <th style="width: 120px; min-width: 120px;">Ações</th>
    </tr>
    {# Linha 2: Campos de Filtro com data-attributes para vincular às colunas #}
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="4"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="5"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="6"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="7"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="8"></th>
        <th></th> {# Coluna de Ações sem filtro #}
    </tr>
{% endblock %}

{% block table_row %}
    <td><strong>#{{ object.id }}</strong></td>
    <td>#{{ object.auditoria_agendada.id }}</td>
    <td>{{ object.data_execucao|date:"d/m/Y" }}</td>
    <td>{{ object.responsavel.get_full_name|default:object.auditoria_agendada.responsavel.get_full_name|default:"N/A" }}</td>
    <td>
     {{ object.local_execucao.nome|default:"N/A" }}
    </td>
    <td>
        {% for modelo in object.auditoria_agendada.modelos.all %}
            {{ modelo.descricao }}{% if not forloop.last %}, {% endif %}
        {% empty %}--{% endfor %}
    </td>
    <td>
        <span class="badge badge-secondary">{{ object.auditoria_agendada.ferramenta.nome|default:"N/A" }}</span>
    </td>
    <td>
        <span class="badge badge-info">{{ object.auditoria_agendada.get_categoria_auditoria_display|default:"N/A" }}</span>
    </td>
    <td>
        {% with status=object.status_execucao %}
            {% if status == 'Atraso' %}
                <span class="badge badge-error">{{ status }}</span>
            {% elif status == 'Pendente' %}
                <span class="badge badge-info">{{ status }}</span>
      {% else %} {# Agendada #}
                <span class="badge badge-secondary">{{ status }}</span>
            {% endif %}
        {% endwith %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.auditorias.change_auditoriainstancia %}
            <button type="button" class="btn btn-secondary btn-icon" title="Redirecionar Auditoria"
          onclick='openRedirectModal("{% url 'auditorias:redirecionar_execucao' object.pk %}", {{ object.responsavel.id|default:object.auditoria_agendada.responsavel.id|default:"null" }}, {{ all_users_json|safe }})'>
                <i class="fas fa-people-arrows"></i>
            </button>
            {% endif %}
            
            {% if perms.auditorias.delete_auditoriainstancia %}
            <button type="button" class="btn btn-danger btn-icon" title="Excluir Execução"
                    onclick="confirmDelete('{% url 'auditorias:deletar_execucao' object.pk %}', 'Execução #{{ object.id }}')">
    <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        const filters = document.querySelectorAll('.column-filter');


        const table = document.querySelector('#dataTable');
        // LOG 3: Verifica se a tabela foi encontrada.
        if (!table) {
            return;
        }

      const tableBody = table.querySelector('tbody');
        // LOG 4: Verifica se o corpo da tabela (tbody) foi encontrado.
        if (!tableBody) {
            return;
        }

        function applyTableFilters() {

            const dataRows = tableBody.querySelectorAll('tr');
            
        if (dataRows.length === 0) {
                console.warn("AVISO: Nenhuma linha de dados (<tr>) encontrada para filtrar.");
                return;
            }

            dataRows.forEach((row, rowIndex) => {
                let isRowVisible = true;
          const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);

                    if (filterText) {
                        const cell = cells[colIndex];
  if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
               isRowVisible = false;
                            }
                        } else {
                           isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }

        if (filters.length > 0) {
            filters.forEach((filter, index) => {
                // LOG 5: Confirma que o event listener foi adicionado a cada filtro.
                filter.addEventListener('input', applyTableFilters);
            });
        } else {
            console.warn("AVISO: Nenhum campo de filtro encontrado para adicionar listeners.");
        }
    });
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\form_generico.html

{% extends 'auditorias/base.html' %}

{% block title %}{{ title }} - Sistema de Auditorias{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">{{ subtitle|default:"Preencha os campos abaixo" }}</p>
        </div>
        {% if back_url %}
        {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
        <a href="{% url back_url %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Voltar
        </a>
        {% else %}
        <button type="button" onclick="window.history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Voltar
        </button>
        {% endif %}
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
    <!-- Formulário Principal -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ form_title|default:title }}</h3>
            <p class="card-subtitle">{{ form_subtitle|default:"Campos obrigatórios são marcados com *" }}</p>
        </div>
        
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="mainForm" novalidate>
                {% csrf_token %}
                
                {% block form_content %}
                <!-- Conteúdo específico do formulário será definido nos templates filhos -->
                {% endblock %}
                
                <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
                    {% if back_url %}
                    {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
                    <a href="{% url back_url %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </a>
                    {% else %}
                    <button type="button" onclick="window.history.back()" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    {% endif %}
                    <button type="submit" class="btn btn-primary" id="submitBtn" data-original-text="Salvar">
                        <i class="fas fa-save"></i>
                        {{ submit_text|default:"Salvar" }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Painel Lateral -->
    <div>
        <!-- Informações de Ajuda -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle"></i>
                    Ajuda
                </h3>
            </div>
            <div class="card-body">
                {% block help_content %}
                <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                    <p><strong>Dicas:</strong></p>
                    <ul style="margin: 12px 0; padding-left: 20px;">
                        <li>Campos marcados com * são obrigatórios</li>
                        <li>Use nomes descritivos e únicos</li>
                        <li>Verifique os dados antes de salvar</li>
                    </ul>
                </div>
                {% endblock %}
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bolt"></i>
                    Ações Rápidas
                </h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    {% block quick_actions %}
                    <button type="button" onclick="resetForm()" class="btn btn-secondary btn-sm">
                        <i class="fas fa-undo"></i>
                        Resetar
                    </button>
                    {% if back_url %}
                    {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
                    <a href="{% url back_url %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-list"></i>
                        Ver Lista
                    </a>
                    {% endif %}
                    {% endblock %}
                </div>
            </div>
        </div>

        <!-- Histórico (se editando) -->
        {% if object %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history"></i>
                    Histórico
                </h3>
            </div>
            <div class="card-body">
                <div style="font-size: 14px; color: var(--text-secondary);">
                    <div style="margin-bottom: 12px;">
                        <strong>Criado em:</strong><br>
                        {{ object.data_cadastro|date:"d/m/Y H:i" }}
                    </div>
                    {% if object.data_atualizacao != object.data_cadastro %}
                    <div>
                        <strong>Última atualização:</strong><br>
                        {{ object.data_atualizacao|date:"d/m/Y H:i" }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% block extra_js %}
<script>
// Função para resetar formulário
function resetForm() {
    if (confirm('Tem certeza que deseja resetar o formulário? Todos os dados não salvos serão perdidos.')) {
        document.getElementById('mainForm').reset();
        
        // Limpar erros e classes de validação
        document.querySelectorAll('.form-control').forEach(field => {
            field.classList.remove('error', 'success');
        });
        
        document.querySelectorAll('.field-error').forEach(error => {
            error.remove();
        });
    }
}

// Detectar mudanças no formulário para aviso antes de sair
let formChanged = false;
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mainForm');
    if (form) {
        form.addEventListener('input', () => formChanged = true);
        form.addEventListener('change', () => formChanged = true);
        form.addEventListener('submit', () => formChanged = false);
    }
});

// Aviso antes de sair da página com dados não salvos
window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S para salvar
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('submitBtn').click();
    }
    
    // Escape para voltar
    if (e.key === 'Escape') {
        {% if back_url %}
        {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
        window.location.href = "{{ back_url }}";
        {% else %}
        window.history.back();
        {% endif %}
    }
});
</script>
{% endblock %}
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\historico_concluidas.html

{% extends 'auditorias/lista_generica.html' %}

{# Remove o formulário de busca genérico herdado do template pai, pois usaremos filtros por coluna #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros agora estão no cabeçalho da tabela #}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    {# Linha 1: Títulos das Colunas com larguras definidas #}
    <tr>
        <th style="width: 8%;">ID Execução</th>
        <th style="width: 8%;">ID Agendamento</th>
        <th style="width: 10%;">Data Programada</th>
        <th style="width: 12%;">Data de Realização</th>
        <th>Auditor</th>
        <th>Local</th>
        <th>Modelo</th>
        <th>Checklist</th>

        <th style="width: 10%;">Ferramenta</th>
        <th style="width: 10%;">Status</th>
        <th style="width: 8%;">Ações</th>
    </tr>
    {# Linha 2: Campos de Filtro #}
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="4"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="5"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="6"></th>

        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="7"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="8"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="9"></th>
        <th></th>
    </tr>
{% endblock %}

{% block table_row %}
    <td><strong>#{{ object.id }}</strong></td>
    <td>#{{ object.auditoria_agendada.id }}</td>
    <td>{{ object.data_execucao|date:"d/m/Y" }}</td>
    <td>{{ object.get_data_conclusao|date:"d/m/Y H:i"|default:"--" }}</td>
    <td>{{ object.auditoria_agendada.responsavel.get_full_name|default:"N/A" }}</td>
    <td>
        {{ object.local_execucao.nome|default:"N/A" }}
    </td>
    <td>
        {% for modelo in object.auditoria_agendada.modelos.all %}
            {{ modelo.descricao }}{% if not forloop.last %}, {% endif %}
        {% empty %}--{% endfor %}
    </td>
    <td>
        {% if object.checklist_usado %}
            {{ object.checklist_usado.nome }} (V{{ object.checklist_usado.version }})
        {% else %}
            N/A
        {% endif %}
    </td>
    <td>
        <span class="badge badge-secondary">{{ object.auditoria_agendada.ferramenta.nome|default:"N/A" }}</span>
    </td>
    <td style="white-space: nowrap;">
        <span class="badge badge-success">{{ object.status }}</span>
    </td>
    <td>
        <a href="{% url 'auditorias:detalhes_historico_auditoria' object.pk %}" class="btn btn-secondary btn-icon" title="Ver Detalhes">
            <i class="fas fa-eye"></i>
        </a>
    </td>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) {
            return;
        }
        const tableBody = table.querySelector('tbody');
        if (!tableBody) {
            return;
        }

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) {
                return;
            }

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);

                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
                                isRowVisible = false;
                            }
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }

        if (filters.length > 0) {
            filters.forEach(filter => {
                filter.addEventListener('input', applyTableFilters);
            });
        }
    });
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\lista_generica.html

{% extends 'auditorias/base.html' %}

{% block title %}{{ title }} - Sistema de Auditorias{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
{# --- ENVOLVENDO O CABEÇALHO EM UM BLOCO PARA PERMITIR EDIÇÃO --- #}
{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">Administrar {{ title|lower }} do sistema</p>
        </div>
        
        {# AQUI ESTÁ A TRAVA DE SEGURANÇA #}
        {# O botão só aparece se a variável 'tem_permissao_criar' for True #}
        {% if tem_permissao_criar %}
        <a href="{% url create_url %}" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            {% if button_text %}{{ button_text }}{% else %}Criar {{ singular|default:title|slice:":-1" }}{% endif %}
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block search_form %}
<div class="card" style="margin-bottom: 24px;">
    <div class="card-body">
        <form method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Buscar</label>
                <div class="search-container">
                    <input type="text" name="search" value="{{ search }}" placeholder="Digite para buscar..." class="form-control search-input">
                </div>
            </div>

            {% block extra_filters %}
            {% endblock %}
            
            <div style="display: flex; gap: 8px; align-items: end;">
                <button type="submit" class="btn btn-secondary" style="flex-grow: 1;">
                    <i class="fas fa-search"></i>
                    Buscar
                </button>
                
                {% if request.GET %}
                <a href="?" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Limpar
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock search_form %}

<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 class="card-title">Lista de {{ title }}</h3>
                <p class="card-subtitle">
                    {% if page_obj.paginator.count %}
                        {{ page_obj.paginator.count }} registro{{ page_obj.paginator.count|pluralize:",s" }} encontrado{{ page_obj.paginator.count|pluralize:",s" }}
                    {% else %}
                        Nenhum registro encontrado
                    {% endif %}
                </p>
            </div>
            {% if page_obj.paginator.count > 0 %}
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary btn-sm" onclick="exportarDados()">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
                <button class="btn btn-secondary btn-sm" onclick="imprimirTabela()">
                    <i class="fas fa-print"></i>
                    Imprimir
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card-body">
        {% if page_obj.object_list %}
            <div class="table-container">
                <table class="table" id="dataTable">
                    <thead>
                        {% block table_headers %}
                        <tr>
                            {# O conteúdo dos templates filhos virá aqui #}
                        </tr>
                        {% endblock %}
                    </thead>
                    <tbody>
                        {% for object in page_obj %}
                        <tr>
                            {% block table_row %}
                            {% endblock %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if page_obj.has_other_pages %}
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1&{{ request.GET.urlencode|cut:'page=' }}" title="Primeira página">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}" title="Página anterior">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="current">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}&{{ request.GET.urlencode|cut:'page=' }}">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}" title="Próxima página">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode|cut:'page=' }}" title="Última página">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <div style="text-align: center; padding: 64px 24px; color: var(--text-muted);">
                <i class="fas fa-inbox" style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;"></i>
                <h3 style="margin-bottom: 12px; color: var(--text-secondary);">
                    {% if request.GET %}
                        Nenhum resultado encontrado
                    {% else %}
                        {% if empty_message %}{{ empty_message }}{% else %}Nenhum {{ singular|default:title|slice:":-1"|lower }} cadastrado{% endif %}
                    {% endif %}
                </h3>
                <p style="margin-bottom: 24px;">
                    {% if request.GET %}
                        Tente ajustar os termos de busca ou limpar os filtros.
                    {% else %}
                        {% if empty_subtitle %}{{ empty_subtitle }}{% else %}Comece criando {{ artigo|default:'o' }} primeiro {{ singular|default:title|slice:":-1"|lower }}.{% endif %}
                    {% endif %}
                </p>
                {% if tem_permissao_criar %}
                {% if not request.GET %}
                <a href="{% url create_url %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    {% if button_text %}{{ button_text }}{% else %}Criar {{ singular|default:title|slice:":-1" }}{% endif %}
                </a>
                {% else %}
                {% endif %}
                <a href="?" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Limpar Busca
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        /* --- ESTILOS GLOBAIS PARA TABELAS DE LISTAGEM --- */
        #dataTable {
            table-layout: auto; /* Garante que a tabela se ajuste ao conteúdo */
        }
        
        #dataTable th, 
        #dataTable td {
            text-align: center !important; /* Força a centralização do texto */
            vertical-align: middle !important; /* Alinha o conteúdo verticalmente */
        }

        /* Centraliza os botões de ação */
        .action-buttons {
            justify-content: center;
        }
    </style>
{% endblock %}


{% block extra_js %}
<script>
    // Função para confirmar exclusão
    function confirmDelete(url, itemName) {
        const modal = document.getElementById('deleteModal'); if (!modal) return;
        
        const form = modal.querySelector('#deleteForm');
        const nameSpan = modal.querySelector('#deleteItemName');
        
        form.action = url;
        nameSpan.textContent = `"${itemName}"`;
        modal.style.display = 'flex';
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        if (modal) modal.style.display = 'none';
    }

    // Fechar modal clicando fora
    document.getElementById('deleteModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    // Função para exportar dados
    function exportarDados() {
        alert('Funcionalidade de exportação será implementada');
    }

    // Função para imprimir tabela
    function imprimirTabela() {
        const printContent = document.getElementById('dataTable').outerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>{{ title }} - Impressão</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .action-buttons { display: none; }
                    </style>
                </head>
                <body>
                    <h1>{{ title }}</h1>
                    ${printContent}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\lista_quarentena.html

{% extends 'auditorias/base.html' %}

{% block content %}
<div class="container-fluid">
    
    <div class="content-header mb-4 mt-4">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            
            <div>
                <h2 class="content-title" style="margin-bottom: 8px; font-weight: bold; color: #0F172A;">Auditorias em Quarentena</h2>
                <p class="content-subtitle text-muted mb-0">Analise e gerencie as auditorias que excederam o tempo limite de execução.</p>
            </div>

            <div style="display: flex; gap: 10px;">
                <a href="{% url 'auditorias:lista_execucoes' %}" class="btn btn-secondary shadow-sm" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                    <i class="fas fa-arrow-left mr-2" style="color: #666;"></i> 
                    Voltar para Auditorias
                </a>
            </div>
        </div>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th>ID Execução</th>
                            <th>ID Agendamento</th>
                            <th>Data Programada</th>
                            <th>Auditor</th>
                            <th>Local</th>
                            <th>Modelo/Categoria</th>
                            <th>Ferramenta</th>
                            <th>Limite (dias)</th>
                            <th>Dias em Quarentena</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in auditorias_quarentena %} 
                        <tr>

                            <td><strong>#{{ item.auditoria_agendada.id }}</strong></td>

                            <td>#{{ item.id }}</td>

                            <td>{{ item.data_execucao|date:"d/m/Y" }}</td>

                            <td>
                                {% if item.responsavel %}
                                    {{ item.responsavel.get_full_name|default:item.responsavel.username }}
                                {% else %}
                                    <span class="text-muted">Não atribuído</span>
                                {% endif %}
                            </td>

                            <td>{{ item.local_execucao.nome|default:"-" }}</td>
                            <td>{{ item.auditoria_agendada.modelos.first.descricao|default:"-" }}</td>

                            <td>
                                <span class="badge badge-secondary">{{ item.auditoria_agendada.ferramenta.nome|default:"-" }}</span>
                            </td>
                            
                            <td>{{ item.limite_configurado }}</td>
                            <td class="text-danger font-weight-bold">+{{ item.dias_na_quarentena }}</td>

                            <td class="text-center">
                                {% if perms.auditorias.delete_auditoria %}
                                <button type="button" 
                                        class="btn btn-sm btn-danger" 
                                        title="Excluir esta execução"
                                        onclick="confirmDelete('{% url 'auditorias:deletar_execucao' item.pk %}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <h5 class="text-success"><i class="fas fa-check-circle"></i> Nenhuma auditoria em quarentena!</h5>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(url) {
    if (confirm('Tem certeza que deseja excluir esta auditoria da quarentena?')) {
        window.location.href = url;
    }
}
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\auditorias\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}

<h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    1. Informações Gerais
</h4>
<div class="form-row">
    <div class="form-group required">
        <label for="responsavel" class="form-label">Responsável</label>
        <select id="responsavel" name="responsavel" class="form-control form-select" required>
            <option value="">Selecione...</option>
            {% for u in usuarios %}
            <option value="{{ u.pk }}" {% if auditoria.responsavel.pk == u.pk %}selected{% endif %}>{{ u.get_full_name|default:u.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<h4 style="color: var(--text-primary); margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    2. Local e Modelo
</h4>
<div class="form-row">
    <div class="form-group required">
        <label for="nivel_organizacional" class="form-label">Nível Organizacional</label>
        <select id="nivel_organizacional" name="nivel_organizacional" class="form-control form-select" required>
            <option value="">Selecione...</option>
            <option value="EMPRESA" {% if auditoria.nivel_organizacional == 'EMPRESA' %}selected{% endif %}>Empresa</option>
            <option value="AREA" {% if auditoria.nivel_organizacional == 'AREA' %}selected{% endif %}>Área</option>
            <option value="SETOR" {% if auditoria.nivel_organizacional == 'SETOR' %}selected{% endif %}>Setor</option>
            <option value="SUBSETOR" {% if auditoria.nivel_organizacional == 'SUBSETOR' %}selected{% endif %}>Subsetor</option>
        </select>
    </div>
    <div class="form-group required">
        <label for="categoria_auditoria" class="form-label">Categoria</label>
        <select id="categoria_auditoria" name="categoria_auditoria" class="form-control form-select" required>
            <option value="APP" selected>App</option>
        </select>
    </div>
</div>
<div class="form-row">
    <div class="form-group" id="container-empresa">
        <label for="local_empresa" class="form-label">Empresa</label>
        <select id="local_empresa" name="local_empresa" class="form-control form-select">
            <option value="">Selecione uma empresa...</option>
            {% for e in empresas %}<option value="{{ e.pk }}" {% if auditoria.local_empresa.pk == e.pk %}selected{% endif %}>{{ e.nome }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group" id="container-area" style="display:none;">
        <label for="local_area" class="form-label">Área</label>
        <select id="local_area" name="local_area" class="form-control form-select"></select>
    </div>
</div>
<div class="form-row">
    <div class="form-group" id="container-setor" style="display:none;">
        <label for="local_setor" class="form-label">Setor</label>
        <select id="local_setor" name="local_setor" class="form-control form-select"></select>
    </div>
    <div class="form-group" id="container-subsetor" style="display:none;">
        <label for="local_subsetor" class="form-label">Subsetor</label>
        <select id="local_subsetor" name="local_subsetor" class="form-control form-select"></select>
    </div>
</div>

<div class="form-row single">
     <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="agendamento_especifico" name="agendamento_especifico" {% if auditoria.agendamento_especifico %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px; margin-left: 12px;">Agendar para locais específicos</span>
        <div class="field-help">Marque esta opção para selecionar subsetores individuais. Se desmarcado, será criada uma auditoria única para o nível selecionado (o local será escolhido no app).</div>
    </div>
</div>

<div class="form-row single" id="container-subsetores-especificos" style="display:none;">
    <div class="form-group">
        <label for="subsetores_selecionados" class="form-label">Subsetores Específicos</label>
        <select id="subsetores_selecionados" name="subsetores_selecionados" multiple>
            </select>
        <div class="field-help">Selecione um ou mais subsetores para criar uma auditoria para cada um.</div>
    </div>
</div>

<div class="form-row">
    <div class="form-group required">
        <label for="modelos" class="form-label">Modelo de Auditoria</label>
        <select id="modelos" name="modelos" required>
            <option value="">Selecione um modelo...</option>
            {% for m in modelos %}
                <option value="{{ m.pk }}" 
                    {% if auditoria and m in auditoria.modelos.all %}selected{% endif %}>
                    {{ m.descricao }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="ativos_auditados" class="form-label">Ativos Auditados (Opcional)</label>
        <select id="ativos_auditados" name="ativos_auditados" multiple>
            {% if auditoria %}{% for a in auditoria.ativos_auditados.all %}<option value="{{ a.pk }}" selected>{{ a.tag }} - {{ a.descricao }}</option>{% endfor %}{% endif %}
        </select>
    </div>
</div>

<h4 style="color: var(--text-primary); margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    3. Programação
</h4>

<div class="form-row">
    <div class="form-group required">
        <label for="data_inicio" class="form-label">Data de Início</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control schedule-input" value="{{ auditoria.data_inicio|date:'Y-m-d' }}" required>
    </div>
    <div class="form-group">
        <label for="data_fim" class="form-label">Até o Dia:</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control schedule-input" value="{{ auditoria.data_fim|date:'Y-m-d' }}">
        <div class="field-help">*Se desejar fazer somente um dia, não preencha este campo.</div>
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <input type="radio" id="por_frequencia" name="schedule_type" value="por_frequencia" class="schedule-input" {% if auditoria.por_frequencia or not auditoria %}checked{% endif %}>
        <label for="por_frequencia">Por Frequência</label>
    </div>
    <div class="form-group">
        <input type="radio" id="por_intervalo" name="schedule_type" value="por_intervalo" class="schedule-input" {% if auditoria.por_intervalo %}checked{% endif %}>
        <label for="por_intervalo">Por Intervalo</label>
    </div>
</div>

<div class="form-row">
    <div class="form-group" id="frequency-fields">
        <label for="frequencia" class="form-label">Frequência</label>
        <select id="frequencia" name="frequencia" class="form-control schedule-input">
            <option value="DIARIO" {% if auditoria.frequencia == 'DIARIO' %}selected{% endif %}>Diário</option>
            <option value="SEMANAL" {% if auditoria.frequencia == 'SEMANAL' %}selected{% endif %}>Semanal</option>
            <option value="QUINZENAL" {% if auditoria.frequencia == 'QUINZENAL' %}selected{% endif %}>Quinzenal</option>
            <option value="MENSAL" {% if auditoria.frequencia == 'MENSAL' %}selected{% endif %}>Mensal</option>
            <option value="ANUAL" {% if auditoria.frequencia == 'ANUAL' %}selected{% endif %}>Anual</option>
        </select>
    </div>
    <div class="form-group" id="interval-fields">
        <label for="intervalo" class="form-label">Intervalo (em dias)</label>
        <input type="number" id="intervalo" name="intervalo" class="form-control schedule-input" value="{{ auditoria.intervalo|default:'1' }}" min="1">
    </div>
    <div class="form-group">
        <label for="numero_repeticoes" class="form-label">Número de Repetições</label>
        <input type="number" id="numero_repeticoes" name="numero_repeticoes" class="form-control schedule-input" value="{{ auditoria.numero_repeticoes|default:'1' }}" min="1">
        <div class="field-help">Quantas vezes a auditoria deve ocorrer em cada data gerada.</div>
    </div>
</div>


<div class="form-row single">
     <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="pular_finais_semana" name="pular_finais_semana" class="schedule-input" {% if auditoria.pular_finais_semana %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px; margin-left: 12px;">Pular fins de semana</span>
    </div>
</div>

<div id="date-preview-container" style="margin-top: 24px; display: none;">
    <h5 style="color: var(--text-primary); margin-bottom: 12px;">Datas que serão geradas</h5>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Auditorias</th>
                    <th>Repetição</th>
                    <th>Dia da Semana</th>
                    <th>Dia</th>
                    <th>Mês</th>
                    <th>Ano</th>
                </tr>
            </thead>
            <tbody id="date-preview-body">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mainForm');
    const dataInicioInput = document.getElementById('data_inicio');
    const dataFimInput = document.getElementById('data_fim');

    if (form && dataInicioInput && dataFimInput) {
        
        // 1. Intercepta o envio do formulário
        form.addEventListener('submit', function(event) {
            
            // 2. Pega a data de hoje no formato YYYY-MM-DD
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); // Zera o tempo para comparar apenas o dia

            // 3. Valida a Data de Início
            const dataInicioValue = dataInicioInput.value;
            if (dataInicioValue) {
                const dataInicio = new Date(dataInicioValue + 'T00:00:00'); // Adiciona T00:00 para evitar problemas de fuso
                if (dataInicio < hoje) {
                    alert('Erro: A Data de Início não pode ser no passado.');
                    event.preventDefault(); // Impede o envio do formulário
                    return;
                }
            }

            // 4. Valida a Data de Fim (se preenchida)
            const dataFimValue = dataFimInput.value;
            if (dataFimValue) {
                const dataFim = new Date(dataFimValue + 'T00:00:00');
                if (dataFim < hoje) {
                    alert('Erro: A data "Até o Dia" não pode ser no passado.');
                    event.preventDefault(); // Impede o envio do formulário
                    return;
                }
            }
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===================================================================
    // LÓGICA NOVA: INICIALIZAÇÃO DO TOM SELECT
    // ===================================================================
    new TomSelect('#modelos',{
        placeholder: 'Selecione um modelo...',
        maxItems: 1, // Garante apenas 1 item
        sortField: {
            field: "text",
            direction: "asc"
        }
        // Removi o plugin 'remove_button' para ficar com cara de select padrão
    });

    // CORREÇÃO 1: Guardamos a instância do TomSelect em uma variável
    const ativosTomSelect = new TomSelect('#ativos_auditados',{
        plugins: ['remove_button'],
        placeholder: 'Selecione um ou mais ativos...', // Placeholder inicial
        sortField: {
            field: "text",
            direction: "asc"
        }
    });

    const subsetoresTomSelect = new TomSelect('#subsetores_selecionados',{
        plugins: ['remove_button'],
        placeholder: 'Selecione um ou mais subsetores...',
        sortField: { field: "text", direction: "asc" }
    });
    
    // ===================================================================
    // LÓGICA 1: CARREGAMENTO DINÂMICO DE LOCAL, MODELO E ATIVO
    // ===================================================================
    const nivelSelect = document.getElementById('nivel_organizacional');
    const empresaSelect = document.getElementById('local_empresa');
    const areaSelect = document.getElementById('local_area');
    const setorSelect = document.getElementById('local_setor');
    const subsetorSelect = document.getElementById('local_subsetor');
    const agendamentoEspecificoCheckbox = document.getElementById('agendamento_especifico');
    const containerSubsetoresEspecificos = document.getElementById('container-subsetores-especificos');

    const containers = {
        'EMPRESA': document.getElementById('container-empresa'),
        'AREA': document.getElementById('container-area'),
        'SETOR': document.getElementById('container-setor'),
        'SUBSETOR': document.getElementById('container-subsetor')
    };

    function atualizarVisibilidade() {
        const nivel = nivelSelect.value;
        
        Object.values(containers).forEach(c => c.style.display = 'none');
        if (nivel === 'EMPRESA') {
            containers.EMPRESA.style.display = 'block';
        } else if (nivel === 'AREA') {
            containers.EMPRESA.style.display = 'block';
            containers.AREA.style.display = 'block';
        } else if (nivel === 'SETOR') {
            containers.EMPRESA.style.display = 'block';
            containers.AREA.style.display = 'block';
            containers.SETOR.style.display = 'block';
        } else if (nivel === 'SUBSETOR') {
            Object.values(containers).forEach(c => c.style.display = 'block');
        }
        carregarAtivos();

        if (nivel && nivel !== 'SUBSETOR') {
            agendamentoEspecificoCheckbox.closest('.form-group').style.display = 'block';
            toggleSpecificScheduling();
        } else {
            agendamentoEspecificoCheckbox.closest('.form-group').style.display = 'none';
            containerSubsetoresEspecificos.style.display = 'none';
        }

        loadSubsetorsForSelection();
    }

    function toggleSpecificScheduling() {
        if (agendamentoEspecificoCheckbox.checked) {
            containerSubsetoresEspecificos.style.display = 'block';
        } else {
            containerSubsetoresEspecificos.style.display = 'none';
        }
    }

    function loadSubsetorsForSelection() {
        const nivel = nivelSelect.value;
        let local_id = null;
        let query_param = '';

        if (nivel === 'SETOR' && setorSelect.value) { local_id = setorSelect.value; query_param = 'setor_id'; }
        else if (nivel === 'AREA' && areaSelect.value) { local_id = areaSelect.value; query_param = 'area_id'; }
        else if (nivel === 'EMPRESA' && empresaSelect.value) { local_id = empresaSelect.value; query_param = 'empresa_id'; }

        subsetoresTomSelect.clear();
        subsetoresTomSelect.clearOptions();
        
        if (query_param && local_id) {
            // Esta é a URL que você criou em urls.py 
            const url = `{% url 'auditorias:get_subsetores_por_nivel' %}?${query_param}=${local_id}`;

            subsetoresTomSelect.addOption({value: '', text: 'Carregando subsetores...'});
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro na rede: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    subsetoresTomSelect.clearOptions();
                    if (data.length > 0) {
                        data.forEach(sub => {
                            subsetoresTomSelect.addOption({ value: sub.id, text: sub.nome });
                        });
                    } else {
                        subsetoresTomSelect.addOption({value: '', text: 'Nenhum subsetor encontrado'});
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar subsetores:', error);
                    subsetoresTomSelect.clearOptions();
                    subsetoresTomSelect.addOption({value: '', text: 'Erro ao carregar subsetores'});
                });

        } else if (nivel && nivel !== 'SUBSETOR') {
            subsetoresTomSelect.addOption({value: '', text: 'Selecione um local acima para carregar'});
        } else {
             subsetoresTomSelect.addOption({value: '', text: 'Opção desabilitada para este nível'});
        }
    }

    function popularSelect(selectElement, url, placeholder) {
        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                data.forEach(item => {
                    const option = new Option(item.nome, item.id);
                    selectElement.add(option);
                });
            })
            .catch(error => {
                console.error('Erro ao popular select:', error);
                selectElement.innerHTML = `<option value="">Erro ao carregar</option>`;
            });
    }

    function carregarAtivos() {
        const nivel = nivelSelect.value;
        let local_id = null;
        if (nivel === 'SUBSETOR' && subsetorSelect.value) local_id = subsetorSelect.value;
        else if (nivel === 'SETOR' && setorSelect.value) local_id = setorSelect.value;
        else if (nivel === 'AREA' && areaSelect.value) local_id = areaSelect.value;
        else if (nivel === 'EMPRESA' && empresaSelect.value) local_id = empresaSelect.value;
        
        // Limpa seleções e opções existentes
        ativosTomSelect.clear();
        ativosTomSelect.clearOptions();
        
        if (nivel && local_id) {
            // Define o placeholder para "Carregando..."
            ativosTomSelect.settings.placeholder = 'Carregando ativos...';
            ativosTomSelect.refreshOptions(false); // Atualiza a UI para mostrar o novo placeholder

            const url = `{% url 'auditorias:get_ativos_por_local' %}?nivel=${nivel}&local_id=${local_id}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        // Se encontrou ativos, restaura o placeholder padrão
                        ativosTomSelect.settings.placeholder = 'Selecione um ou mais ativos...';
                        data.forEach(ativo => {
                            ativosTomSelect.addOption({
                                value: ativo.id,
                                text: `${ativo.tag} - ${ativo.descricao}`
                            });
                        });
                    } else {
                        // Se não encontrou, define um placeholder informativo
                        ativosTomSelect.settings.placeholder = 'Nenhum ativo encontrado para este local';
                    }
                    // Atualiza a UI com o placeholder final e as novas opções
                    ativosTomSelect.refreshOptions(false);
                });
        } else {
            // Se nenhum local foi selecionado, define o placeholder inicial
            ativosTomSelect.settings.placeholder = 'Selecione um local para ver os ativos';
            ativosTomSelect.refreshOptions(false);
        }
    }

    // --- CORREÇÃO NOS LISTENERS ---
    agendamentoEspecificoCheckbox.addEventListener('change', toggleSpecificScheduling);

    nivelSelect.addEventListener('change', atualizarVisibilidade);
    
    empresaSelect.addEventListener('change', () => {
        popularSelect(areaSelect, `{% url 'auditorias:get_areas_por_empresa' %}?empresa_id=${empresaSelect.value}`, 'Selecione uma área...');
        carregarAtivos();
        loadSubsetorsForSelection(); // <-- ESTA LINHA FOI ADICIONADA
    });
    areaSelect.addEventListener('change', () => {
        popularSelect(setorSelect, `{% url 'auditorias:get_setores_por_area' %}?area_id=${areaSelect.value}`, 'Selecione um setor...');
        carregarAtivos();
        loadSubsetorsForSelection(); // <-- ESTA LINHA FOI ADICIONADA
    });
    setorSelect.addEventListener('change', () => {
        popularSelect(subsetorSelect, `{% url 'auditorias:get_subsetores_por_setor' %}?setor_id=${setorSelect.value}`, 'Selecione um subsetor...');
        carregarAtivos();
        loadSubsetorsForSelection(); // <-- ESTA LINHA FOI ADICIONADA
    });
    subsetorSelect.addEventListener('change', () => {
        carregarAtivos();
        // Não precisamos chamar loadSubsetorsForSelection() aqui, pois o nível "SUBSETOR" desativa o campo.
    });
    // --- FIM DA CORREÇÃO ---

    atualizarVisibilidade(); // Chamada inicial


    // ===================================================================
    // LÓGICA 2: PREVISÃO DINÂMICA DE DATAS DE AGENDAMENTO
    // ===================================================================
    const scheduleInputs = document.querySelectorAll('.schedule-input');
    const frequencyContainer = document.getElementById('frequency-fields');
    const intervalContainer = document.getElementById('interval-fields');
    const porFrequenciaRadio = document.getElementById('por_frequencia');
    const previewBody = document.getElementById('date-preview-body');
    const previewContainer = document.getElementById('date-preview-container');

    function toggleScheduleFields() {
        const frequenciaSelect = document.getElementById('frequencia');
        const intervaloInput = document.getElementById('intervalo');
        const repeticoesInput = document.getElementById('numero_repeticoes');

        if (porFrequenciaRadio.checked) {
            // Mostra Frequência / Esconde Intervalo
            frequencyContainer.style.display = 'block';
            intervalContainer.style.display = 'none';

            // TORNA OBRIGATÓRIO: Frequência
            // REMOVE OBRIGATORIEDADE: Intervalo
            frequenciaSelect.setAttribute('required', 'required');
            intervaloInput.removeAttribute('required');
        } else {
            // Mostra Intervalo / Esconde Frequência
            frequencyContainer.style.display = 'none';
            intervalContainer.style.display = 'block';

            // TORNA OBRIGATÓRIO: Intervalo
            // REMOVE OBRIGATORIEDADE: Frequência
            intervaloInput.setAttribute('required', 'required');
            frequenciaSelect.removeAttribute('required');
        }
        
        // Número de repetições é sempre obrigatório (padrão 1)
        repeticoesInput.setAttribute('required', 'required');
    }

    function updateDatePreview() {
        toggleScheduleFields();

        const dataInicio = document.getElementById('data_inicio').value;
        const dataFim = document.getElementById('data_fim').value;
        const scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
        const frequencia = document.getElementById('frequencia').value;
        const intervalo = document.getElementById('intervalo').value;
        const numeroRepeticoes = document.getElementById('numero_repeticoes').value;
        const pularFinsSemana = document.getElementById('pular_finais_semana').checked;

        if (!dataInicio) {
            previewContainer.style.display = 'none';
            return;
        }

        const params = new URLSearchParams({
            data_inicio: dataInicio,
            ate_dia: dataFim,
            schedule_type: scheduleType,
            frequencia: frequencia,
            intervalo: intervalo,
            numero_repeticoes: numeroRepeticoes,
            pular_fins_semana: pularFinsSemana
        });
        
        const url = `{% url 'auditorias:preview_audit_dates' %}?${params.toString()}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                previewBody.innerHTML = '';
                
                if (data.dates && data.dates.length > 0) {
                    previewContainer.style.display = 'block';
                    data.dates.forEach(date => {
                        const row = `
                            <tr>
                                <td>${date.auditoria_num}</td>
                                <td>${date.repeticao_num}x</td>
                                <td>${date.dia_semana}</td>
                                <td>${date.dia}</td>
                                <td>${date.mes}</td>
                                <td>${date.ano}</td>
                            </tr>
                        `;
                        previewBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    previewContainer.style.display = 'none';
                }
            })
            .catch(error => console.error('Erro:', error));
    }

    scheduleInputs.forEach(input => {
        input.addEventListener('change', updateDatePreview);
    });

    updateDatePreview();
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // CORREÇÃO: Removido o prefixo 'id_' para bater com o seu HTML
        const dataInicioInput = document.getElementById('data_inicio');
        const dataFimInput = document.getElementById('data_fim');

        if (dataInicioInput && dataFimInput) {
            
            // 1. Define a data mínima do "Início" como Hoje
            // Pega a data atual (YYYY-MM-DD)
            const hoje = new Date().toISOString().split('T')[0];
            
            // Se for cadastro novo (campo vazio), bloqueia datas passadas
            if (!dataInicioInput.value) {
                dataInicioInput.setAttribute('min', hoje);
            }

            // 2. Função para travar a data Fim baseada na data Início
            function atualizarDataFim() {
                const dataSelecionada = dataInicioInput.value;
                if (dataSelecionada) {
                    // O campo 'Até o dia' não pode ser menor que a data de início
                    dataFimInput.setAttribute('min', dataSelecionada);
                    
                    // Se o usuário já tinha escolhido um fim menor que o novo início, limpa o campo
                    if (dataFimInput.value && dataFimInput.value < dataSelecionada) {
                        dataFimInput.value = '';
                    }
                }
            }

            // Adiciona o evento de mudança
            dataInicioInput.addEventListener('change', atualizarDataFim);

            // Roda uma vez ao carregar a página para aplicar as regras
            atualizarDataFim();
        }
    });
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\auditorias\lista.html

{% extends 'auditorias/lista_generica.html' %}

{# --- CABEÇALHO --- #}
{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">Administrar auditorias agendadas do sistema</p>
        </div>
        <div style="display: flex; gap: 10px;">
            {# BOTÃO CALENDÁRIO #}
            <button type="button" onclick="openCalendarModal()" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-calendar-alt" style="color: #0ea5e9;"></i> Calendário
            </button>

            {# BOTÃO DE CRIAÇÃO (Texto alterado para "Criar Agendamento") #}
            {% if perms.auditorias.add_auditoria %}
            <a href="{% url create_url %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Criar Agendamento
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block search_form %}{% endblock %}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    <tr>
        <th>ID Agendamento</th>
        <th>Criado por</th>
        <th>Auditor</th>
        <th>Modelo(s)</th>
        <th>Local</th>
        <th>Ferramenta</th>
        <th>Plataforma</th>
        <th>Programação</th>
        <th>Data de Início</th>
        <th>Data de Fim</th>
        <th style="width: 120px;">Ações</th>
    </tr>
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="4"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="5"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="6"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="7"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="8"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="9"></th>
        <th></th>
    </tr>
{% endblock %}

{% block table_row %}
    <td><strong>#{{ object.id }}</strong></td>
    <td>{{ object.criado_por.get_full_name|default:object.criado_por.username|default:"Sistema" }}</td>
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
             {{ object.responsavel.get_full_name|default:object.responsavel.username|default:"N/A" }}
        </div>
    </td>
    <td>
        {% for modelo in object.modelos.all %}
            {{ modelo.descricao }}{% if not forloop.last %},<br>{% endif %}
        {% empty %}--{% endfor %}
    </td>
    <td>
        {% if object.local_subsetor %}{{ object.local_subsetor.nome }}{% elif object.local_setor %}{{ object.local_setor.nome }}{% elif object.local_area %}{{ object.local_area.nome }}{% elif object.local_empresa %}{{ object.local_empresa.nome }}{% else %}--{% endif %}
    </td>
    <td><span class="badge badge-secondary">{{ object.ferramenta.nome|default:"N/A" }}</span></td>
    <td><span class="badge badge-info">{{ object.get_categoria_auditoria_display|default:"N/A" }}</span></td>
    <td>{{ object.get_programacao_display }}</td>
    <td>{{ object.data_inicio|date:"d/m/Y" }}</td>
    <td>{{ object.data_fim|date:"d/m/Y"|default:"-" }}</td>
    <td>
        <div class="action-buttons">
            {% if perms.auditorias.change_auditoria %}
            <button type="button" class="btn btn-secondary btn-icon" title="Redirecionar Agendamento"
                 onclick='openRedirectModal("{% url 'auditorias:redirecionar_agendamento' object.pk %}", {{ object.responsavel.id|default:"null" }}, {{ all_users_json|safe }})'>
                <i class="fas fa-people-arrows"></i>
            </button>
            {% endif %}
            
            {% if perms.auditorias.delete_auditoria %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Agendamento"
                    onclick="confirmDelete('{% url 'auditorias:deletar_auditoria' object.pk %}', 'Agendamento #{{ object.id }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <style>
        .filter-row th { padding: 8px !important; vertical-align: top; }
        .column-filter { height: 38px; font-size: 13px; }

        /* ESTILOS DO CALENDÁRIO */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-month-title {
            font-size: 28px;
            font-weight: 800;
            color: #333;
            text-transform: lowercase;
            margin: 0;
        }
        .calendar-month-title::first-letter {
            text-transform: uppercase;
        }

        .calendar-grid-header {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            text-align: right;
            padding-right: 10px;
            margin-bottom: 5px;
            font-weight: 700;
            color: #555;
            text-transform: lowercase;
        }

        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .calendar-day {
            border: 1px solid #e2e8f0;
            min-height: 100px;
            padding: 5px;
            background: white;
            position: relative;
            margin: -1px 0 0 -1px;
        }

        .calendar-day.other-month {
            background-color: #fcfcfc;
            color: #ccc;
        }

        .day-number {
            text-align: right;
            font-size: 16px;
            color: #333;
            padding-right: 5px;
            margin-bottom: 5px;
        }
        .other-month .day-number { color: #ccc; }

        .event-bar {
            display: block;
            padding: 2px 6px;
            margin-bottom: 2px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            border-radius: 2px;
        }

        .bg-success { background-color: #10b981; }
        .bg-warning { background-color: #f59e0b; }
        .bg-secondary { background-color: #94a3b8; }
        .bg-info { background-color: #0ea5e9; }
        .bg-danger { background-color: #ef4444; }

        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #555;
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .dot-gray { background: #94a3b8; }
        .dot-blue { background: #0ea5e9; }
        .dot-orange { background: #f59e0b; }
        .dot-green { background: #10b981; }
        .dot-red { background: #ef4444; }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) return;
        const tableBody = table.querySelector('tbody');
        if (!tableBody) return;

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) return;

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);
                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) isRowVisible = false;
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }
        if (filters.length > 0) {
            filters.forEach(filter => filter.addEventListener('input', applyTableFilters));
        }
        renderCalendar();
    });

    let currentDate = new Date();

    function openCalendarModal() {
        document.getElementById('calendarModal').style.display = 'flex';
        renderCalendar(); 
    }

    function closeCalendarModal() {
        document.getElementById('calendarModal').style.display = 'none';
    }

    function irParaHoje() {
        currentDate = new Date();
        renderCalendar();
    }

    function mudarMes(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const monthNames = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
        document.getElementById('calendarTitle').innerText = `${monthNames[month]} ${year}`;

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Carregando...</div>';

        fetch(`{% url 'auditorias:get_dados_calendario' %}?year=${year}&month=${month + 1}`)
            .then(response => response.json())
            .then(data => {
                if(!data.sucesso) {
                    grid.innerHTML = `<div style="color:red; padding:20px;">Erro: ${data.erro}</div>`;
                    return;
                }
                construirGrade(year, month, data.dados);
            })
            .catch(err => {
                console.error(err);
                grid.innerHTML = '<div style="color:red; padding:20px;">Erro de conexão.</div>';
            });
    }

    function construirGrade(year, month, dadosAuditoria) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const prevMonthDays = new Date(year, month, 0).getDate();
        
        for (let i = firstDayOfMonth; i > 0; i--) {
            const dayNum = prevMonthDays - i + 1;
            grid.innerHTML += `<div class="calendar-day other-month"><div class="day-number">${dayNum}</div></div>`;
        }

        for (let i = 1; i <= daysInMonth; i++) {
            let barsHtml = '';
            
            if (dadosAuditoria[i]) {
                for (const [key, count] of Object.entries(dadosAuditoria[i])) {
                    const [label, color] = key.split('|');
                    barsHtml += `<div class="event-bar bg-${color}">${count} - ${label}</div>`;
                }
            }

            grid.innerHTML += `
                <div class="calendar-day">
                    <div class="day-number">${i}</div>
                    ${barsHtml}
                </div>
            `;
        }

        const totalCells = firstDayOfMonth + daysInMonth;
        const nextMonthDays = (totalCells > 35 ? 42 : 35) - totalCells;
        
        for (let i = 1; i <= nextMonthDays; i++) {
            grid.innerHTML += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
        }
    }
    </script>
{% endblock %}

{% block content %}
    {{ block.super }}

    <div id="calendarModal" class="modal" style="display: none; padding-top: 20px;">
        <div class="modal-content" style="max-width: 1100px; width: 95%; border-radius: 8px; height: 90vh; display: flex; flex-direction: column;">
            
            <div class="modal-header" style="background: white; border-bottom: 1px solid #e2e8f0; padding: 15px 25px;">
                <h2 style="font-size: 18px; color: #333; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-calendar-alt"></i> Calendário de Auditorias
                </h2>
                <span class="close-btn" onclick="closeCalendarModal()">&times;</span>
            </div>

            <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1; background: #f8fafc;">
                
                <div class="calendar-controls">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary" onclick="mudarMes(-1)">Anterior</button>
                        <button class="btn btn-sm btn-secondary" onclick="irParaHoje()">Este Mês</button>
                        <button class="btn btn-sm btn-primary" onclick="mudarMes(1)">Próximo</button>
                    </div>
                    <h2 id="calendarTitle" class="calendar-month-title">Dezembro 2025</h2>
                    <div style="width: 150px;"></div>
                </div>

                <div class="calendar-grid-header">
                    <div>domingo</div>
                    <div>segunda-feira</div>
                    <div>terça-feira</div>
                    <div>quarta-feira</div>
                    <div>quinta-feira</div>
                    <div>sexta-feira</div>
                    <div>sábado</div>
                </div>
                
                <div id="calendarGrid" class="calendar-grid">
                    </div>

                <div class="calendar-legend">
                    <div class="legend-item"><span class="dot dot-gray"></span> Planejado</div>
                    <div class="legend-item"><span class="dot dot-orange"></span> Pendente</div>
                    <div class="legend-item"><span class="dot dot-red"></span> Não realizado</div>
                    <div class="legend-item"><span class="dot dot-green"></span> Concluída</div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 10px 25px;">
                <button type="button" class="btn btn-primary" onclick="closeCalendarModal()">Fechar</button>
            </div>
        </div>
    </div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\categorias\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição da Categoria</label>
        <input type="text" 
               id="descricao" 
               name="descricao" 
               class="form-control" 
               value="{{ categoria.descricao|default:'' }}" 
               required 
               maxlength="255"
               placeholder="Digite a descrição da categoria">
    </div>
</div>

<div class="form-row single">
    <div class="form-group required">
        <label for="pilar" class="form-label">Pilar</label>
        <select id="pilar" name="pilar" class="form-control form-select" required>
            <option value="">Selecione um pilar...</option>
            {% for pilar in pilares %}
            <option value="{{ pilar.pk }}" {% if categoria.pilar.pk == pilar.pk %}selected{% endif %}>
                {{ pilar.nome }}
            </option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="form-row single">
    <div class="form-group required">
        <label for="dias_para_quarentena" class="form-label">Dias para Quarentena</label>
        <input type="number" 
               id="dias_para_quarentena" 
               name="dias_para_quarentena" 
               class="form-control" 
               value="{{ categoria.dias_para_quarentena|default:7 }}" 
               min="0"
               required>
        <small style="color: var(--text-secondary); font-size: 0.85em; margin-top: 5px; display: block;">
            <i class="fas fa-info-circle"></i> Quantidade de dias de atraso permitidos antes da auditoria entrar em quarentena.
        </small>
    </div>
</div>
<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" 
                       name="ativo" 
                       {% if categoria.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Categoria ativa no sistema
            </span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\categorias\lista.html

{% extends 'auditorias/lista_generica.html' %}

{# Remove o formulário de busca genérico herdado do template pai #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros agora estão no cabeçalho da tabela #}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    {# Linha 1: Títulos das Colunas #}
    <tr>
        <th>Descrição da Categoria</th>
        <th>Pilar</th>
        <th style="width: 150px;">Dias Quarentena</th> <th>Status</th>
        <th>Data Cadastro</th>
        <th style="width: 120px;">Ações</th>
    </tr>
    {# Linha 2: Campos de Filtro #}
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="4"></th>
        
        <th></th> {# Coluna de Ações sem filtro #}
    </tr>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.descricao }} 
        </div>
    </td>
    <td>{{ object.pilar.nome|default:"—" }}</td> 
    
    <td>
        <span class="badge" style="background-color: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9;">
            <i class="fas fa-clock"></i> {{ object.dias_para_quarentena }} dias
        </span>
    </td>

    <td>
        {% if object.ativo %}
            <span class="badge badge-success">
                <i class="fas fa-check-circle"></i> Ativo
            </span>
        {% else %}
            <span class="badge badge-error">
                <i class="fas fa-times-circle"></i> Inativo 
            </span>
        {% endif %}
    </td>
    <td>{{ object.data_cadastro|date:"d/m/Y" }}</td>
    <td>
        <div class="action-buttons">
            {% if perms.auditorias.change_categoriaauditoria %}
            <a href="{% url 'auditorias:editar_categoria_auditoria' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Categoria">
                <i class="fas fa-edit"></i> 
            </a>
            {% endif %}

            {% if perms.auditorias.delete_categoriaauditoria %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Categoria"
                    onclick="confirmDelete('{% url 'auditorias:deletar_categoria_auditoria' object.pk %}', '{{ object.descricao }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}

        </div>
    </td> 
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) {
            return;
        }
        const tableBody = table.querySelector('tbody');
        if (!tableBody) {
            return;
        }

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) {
                return;
            }

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);

                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
                                isRowVisible = false;
                            }
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }

        if (filters.length > 0) {
            filters.forEach(filter => {
                filter.addEventListener('input', applyTableFilters);
            });
        }
    });
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\checklists\comparar_versoes.html

{% extends 'auditorias/base.html' %}

{% load comparacao_filter %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">Compare diferentes versões do checklist "{{ original.nome }}" para identificar alterações.</p>
        </div>
        <a href="{% url 'auditorias:historico_versoes_checklist' original.pk %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar ao Histórico
        </a>
    </div>
</div>

{% if not versoes_comparadas %}
<!-- ========================= SELEÇÃO DE VERSÕES ========================= -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Selecione as Versões para Comparar</h3>
    </div>
    <div class="card-body">
        <form method="GET" action="{% url 'auditorias:comparar_versoes_checklist' original.pk %}" id="form-selecao-versoes">
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                <i class="fas fa-info-circle"></i> Selecione pelo menos 2 versões para realizar a comparação.
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px;">
                {% for versao in versoes %}
                <div class="version-card">
                    <label class="version-selector">
                        <input type="checkbox" name="versoes" value="{{ versao.pk }}" class="version-checkbox">
                        <div class="version-content">
                            <div class="version-header">
                                <span class="version-badge">V{{ versao.version }}</span>
                                {% if versao.is_latest %}
                                <span class="badge badge-primary">Mais Recente</span>
                                {% endif %}
                            </div>
                            <div class="version-info">
                                <p class="version-name">{{ versao.nome }}</p>
                                <p class="version-date">
                                    <i class="fas fa-calendar"></i> {{ versao.data_cadastro|date:"d/m/Y H:i" }}
                                </p>
                                <div class="version-stats">
                                    <span><i class="fas fa-list"></i> {{ versao.topicos.count }} tópicos</span>
                                    <span>
                                        <i class="fas fa-question-circle"></i>
                                        {% with total=0 %}
                                            {% for topico in versao.topicos.all %}
                                                {% if forloop.first %}
                                                    {{ topico.perguntas.count }}
                                                {% else %}
                                                    {% with total=total|add:topico.perguntas.count %}{% endwith %}
                                                {% endif %}
                                                {% if not forloop.first and forloop.last %}
                                                    {% with total=total|add:topico.perguntas.count %}
                                                        {{ total }}
                                                    {% endwith %}
                                                {% endif %}
                                            {% endfor %}
                                            {% if versao.topicos.count == 0 %}
                                                0
                                            {% elif versao.topicos.count == 1 %}
                                                <!-- Já mostrado acima -->
                                            {% endif %}
                                        {% endwith %}
                                        perguntas
                                    </span>
                                </div>
                            </div>
                        </div>
                    </label>
                </div>
                {% endfor %}
            </div>

            <div style="display: flex; gap: 12px; justify-content: center;">
                <button type="submit" class="btn btn-primary" id="btn-comparar" disabled>
                    <i class="fas fa-exchange-alt"></i> Comparar Versões Selecionadas
                </button>
                <button type="button" class="btn btn-secondary" onclick="selecionarTodas()">
                    <i class="fas fa-check-double"></i> Selecionar Todas
                </button>
                <button type="button" class="btn btn-secondary" onclick="limparSelecao()">
                    <i class="fas fa-times"></i> Limpar Seleção
                </button>
            </div>

            <!-- Atalhos rápidos -->
            <div style="margin-top: 32px; padding: 20px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">
                    <i class="fas fa-bolt"></i> Atalhos Rápidos
                </h4>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="compararPrimeiraUltima()">
                        Primeira vs Última
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="compararUltimasDuas()">
                        Últimas 2 Versões
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="compararUltimasTres()">
                        Últimas 3 Versões
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

{% else %}
<!-- ========================= COMPARAÇÃO DE VERSÕES ========================= -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Resumo das Alterações</h3>
            <div style="display: flex; gap: 8px;">
                <button onclick="window.print()" class="btn btn-sm btn-secondary">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Versões sendo comparadas -->
        <div style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
            {% for versao in versoes_comparadas %}
            <div class="version-badge-large">
                <span class="version-number">V{{ versao.version }}</span>
                <span class="version-date">{{ versao.data_cadastro|date:"d/m/Y" }}</span>
            </div>
            {% if not forloop.last %}
            <div style="display: flex; align-items: center; color: var(--text-muted);">
                <i class="fas fa-arrow-right" style="font-size: 24px;"></i>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <!-- Estatísticas de mudanças -->
        <div class="stats-grid">
            <div class="stat-card stat-added">
                <div class="stat-icon"><i class="fas fa-plus-circle"></i></div>
                <div class="stat-content">
                    <div class="stat-value">{{ comparacao_data.alteracoes_resumo.topicos_adicionados }}</div>
                    <div class="stat-label">Tópicos Adicionados</div>
                </div>
            </div>
            <div class="stat-card stat-removed">
                <div class="stat-icon"><i class="fas fa-minus-circle"></i></div>
                <div class="stat-content">
                    <div class="stat-value">{{ comparacao_data.alteracoes_resumo.topicos_removidos }}</div>
                    <div class="stat-label">Tópicos Removidos</div>
                </div>
            </div>
            <div class="stat-card stat-added">
                <div class="stat-icon"><i class="fas fa-plus"></i></div>
                <div class="stat-content">
                    <div class="stat-value">{{ comparacao_data.alteracoes_resumo.perguntas_adicionadas }}</div>
                    <div class="stat-label">Perguntas Adicionadas</div>
                </div>
            </div>
            <div class="stat-card stat-removed">
                <div class="stat-icon"><i class="fas fa-minus"></i></div>
                <div class="stat-content">
                    <div class="stat-value">{{ comparacao_data.alteracoes_resumo.perguntas_removidas }}</div>
                    <div class="stat-label">Perguntas Removidas</div>
                </div>
            </div>
            <div class="stat-card stat-modified">
                <div class="stat-icon"><i class="fas fa-edit"></i></div>
                <div class="stat-content">
                    <div class="stat-value">{{ comparacao_data.alteracoes_resumo.perguntas_modificadas }}</div>
                    <div class="stat-label">Perguntas Modificadas</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparação detalhada lado a lado -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Comparação Detalhada</h3>
        <div class="comparison-controls">
            <button onclick="toggleDiferencasApenas()" class="btn btn-sm btn-secondary" id="btn-filtro">
                <i class="fas fa-filter"></i> Mostrar Apenas Diferenças
            </button>
            <button onclick="expandirTodos()" class="btn btn-sm btn-secondary">
                <i class="fas fa-expand-alt"></i> Expandir Todos
            </button>
            <button onclick="recolherTodos()" class="btn btn-sm btn-secondary">
                <i class="fas fa-compress-alt"></i> Recolher Todos
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="comparison-table-container">
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th style="width: 35%;">Elemento</th>
                        {% for versao in versoes_comparadas %}
                        <th>
                            <div class="version-header-cell">
                                <span class="version-badge">V{{ versao.version }}</span>
                                <span class="version-date-small">{{ versao.data_cadastro|date:"d/m/Y" }}</span>
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody id="comparison-body">
                    {% for topico in comparacao_data.topicos_comparados %}
                    <tr class="topico-row" data-topico="{{ topico.nome }}">
                        <td class="element-name">
                            
                            <!-- ===== BOTÃO REINSERIDO AQUI ===== -->
                            <button class="expand-btn" onclick="toggleTopico(this, '{{ topico.nome|escapejs }}')">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <!-- =================================== -->

                            <strong>{{ topico.nome }}</strong>
                        </td>
                        {% for versao in versoes_comparadas %}
                        <td class="topico-info">
                            {% with perguntas_da_versao=comparacao_data.versoes_data|get_item:versao.pk|get_item:topico.nome %}
                                <span class="badge badge-info">{{ perguntas_da_versao|length|default:0 }} PERGUNTAS</span>
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    
                    {% for pergunta_grupo in topico.perguntas_agrupadas %}
                    <tr class="pergunta-row hidden" data-topico="{{ topico.nome }}">
                        <td class="element-name sub-element">
                            <i class="fas fa-question-circle"></i>
                            {{ pergunta_grupo.descricao }}
                        </td>
                        
                        {% for versao in versoes_comparadas %}
                        <td class="version-data {% if not pergunta_grupo.versoes_dados|get_item:versao.pk %}version-empty{% endif %}">
                            {% with pergunta=pergunta_grupo.versoes_dados|get_item:versao.pk %}
                            {% if pergunta %}
                                <div class="pergunta-details">
                                    {% if pergunta.obrigatoria %}
                                    <span class="detail-badge badge-required">Obrigatória</span>
                                    {% endif %}
                                    {% if pergunta.resposta_livre %}
                                    <span class="detail-badge">Texto Livre</span>
                                    {% endif %}
                                    {% if pergunta.foto %}
                                    <span class="detail-badge">📷 Foto</span>
                                    {% endif %}
                                    {% if pergunta.criar_opcao %}
                                    <span class="detail-badge">Opções</span>
                                    {% endif %}
                                    {% if pergunta.porcentagem %}
                                    <span class="detail-badge">% Porcentagem</span>
                                    {% endif %}
                                    
                                    {% if pergunta.opcoes_resposta %}
                                    <div class="opcoes-list">
                                        <strong>Opções de Resposta:</strong>
                                        <ul>
                                        {% for opcao in pergunta.opcoes_resposta %}
                                            <li>{{ opcao.descricao }} <span class="status-{{ opcao.status|lower }}">({{ opcao.status_display }})</span></li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    
                                    {% if pergunta.opcoes_porcentagem %}
                                    <div class="opcoes-list">
                                        <strong>Opções de Porcentagem:</strong>
                                        <ul>
                                        {% for opcao in pergunta.opcoes_porcentagem %}
                                            <li>{{ opcao.descricao }} (Peso: {{ opcao.peso }})</li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <span class="empty-indicator">—</span>
                            {% endif %}
                            {% endwith %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div style="margin-top: 24px; text-align: center;">
    <a href="{% url 'auditorias:comparar_versoes_checklist' original.pk %}" class="btn btn-secondary">
        <i class="fas fa-redo"></i> Nova Comparação
    </a>
</div>

{% endif %}

<style>
/* Estilos para seleção de versões */
.version-card {
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    transition: all 0.3s ease;
}

.version-selector {
    display: block;
    cursor: pointer;
}

.version-selector input[type="checkbox"] {
    position: absolute;
    opacity: 0;
}

.version-selector input[type="checkbox"]:checked + .version-content {
    border-color: var(--primary);
    background: rgba(79, 70, 229, 0.05);
}

.version-content {
    padding: 20px;
    border: 2px solid transparent;
    border-radius: var(--radius-md);
    transition: all 0.3s ease;
}

.version-card:hover .version-content {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.version-header {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    align-items: center;
}

.version-badge {
    font-size: 20px;
    font-weight: 700;
    color: var(--primary);
}

.version-name {
    font-weight: 600;
    color: var(--text-primary);
    margin: 8px 0;
}

.version-date {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 4px 0;
}

.version-stats {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    font-size: 13px;
    color: var(--text-secondary);
}

.version-stats span {
    display: flex;
    align-items: center;
    gap: 6px;
}

/* Estilos para comparação */
.version-badge-large {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 16px 24px;
    background: var(--bg-tertiary);
    border-radius: var(--radius-md);
    border: 2px solid var(--border);
}

.version-number {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary);
}

.version-date {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 24px;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
}

.stat-added {
    background: rgba(16, 185, 129, 0.05);
    border-color: var(--success);
}

.stat-removed {
    background: rgba(239, 68, 68, 0.05);
    border-color: var(--error);
}

.stat-modified {
    background: rgba(245, 158, 11, 0.05);
    border-color: var(--warning);
}

.stat-icon {
    font-size: 32px;
    color: inherit;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.comparison-controls {
    display: flex;
    gap: 8px;
}

.comparison-table-container {
    overflow-x: auto;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
}

.comparison-table th,
.comparison-table td {
    padding: 16px;
    border: 1px solid var(--border);
    text-align: left;
    vertical-align: top;
}

.comparison-table th {
    background: var(--bg-tertiary);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

.version-header-cell {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.version-date-small {
    font-size: 11px;
    color: var(--text-muted);
    font-weight: 400;
}

.topico-row {
    background: var(--bg-tertiary);
    font-weight: 600;
}

.topico-info {
    text-align: center;
}

.element-name {
    font-weight: 600;
}

.sub-element {
    padding-left: 48px !important;
    font-weight: 400;
}

.expand-btn {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 4px;
    margin-right: 8px;
    transition: transform 0.2s;
}

.expand-btn.expanded i {
    transform: rotate(90deg);
}

.pergunta-row.hidden {
    display: none;
}

.version-empty {
    background: rgba(0, 0, 0, 0.02);
    text-align: center;
}

.empty-indicator {
    color: var(--text-muted);
    font-size: 24px;
    font-weight: 300;
}

.pergunta-details {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-badge {
    display: inline-block;
    padding: 4px 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 11px;
    margin-right: 4px;
    margin-bottom: 4px;
}

.badge-required {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error);
}

.opcoes-list {
    margin-top: 8px;
    padding: 8px;
    background: var(--bg-secondary);
    border-radius: 4px;
    font-size: 12px;
}

.opcoes-list ul {
    margin: 4px 0 0 0;
    padding-left: 20px;
}

.opcoes-list li {
    margin: 4px 0;
}

.status-conforme { color: var(--success); font-weight: 600; }
.status-nao_conforme { color: var(--error); font-weight: 600; }
.status-desvio_solucionado { color: var(--warning); font-weight: 600; }
.status-na { color: var(--text-muted); }

@media print {
    .card-header button,
    .comparison-controls,
    .content-header a {
        display: none !important;
    }
}
</style>

<script>
// Template tag personalizado para acessar dicionário no template
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.version-checkbox');
    const btnComparar = document.getElementById('btn-comparar');
    
    if (checkboxes.length > 0 && btnComparar) {
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', atualizarBotaoComparar);
        });
        atualizarBotaoComparar();
    }
});

function atualizarBotaoComparar() {
    const checkboxes = document.querySelectorAll('.version-checkbox:checked');
    const btnComparar = document.getElementById('btn-comparar');
    
    if (checkboxes.length >= 2) {
        btnComparar.disabled = false;
        btnComparar.innerHTML = `<i class="fas fa-exchange-alt"></i> Comparar ${checkboxes.length} Versões`;
    } else {
        btnComparar.disabled = true;
        btnComparar.innerHTML = '<i class="fas fa-exchange-alt"></i> Selecione pelo menos 2 versões';
    }
}

function selecionarTodas() {
    document.querySelectorAll('.version-checkbox').forEach(cb => cb.checked = true);
    atualizarBotaoComparar();
}

function limparSelecao() {
    document.querySelectorAll('.version-checkbox').forEach(cb => cb.checked = false);
    atualizarBotaoComparar();
}

function compararPrimeiraUltima() {
    const checkboxes = Array.from(document.querySelectorAll('.version-checkbox'));
    limparSelecao();
    if (checkboxes.length >= 2) {
        checkboxes[0].checked = true;
        checkboxes[checkboxes.length - 1].checked = true;
        atualizarBotaoComparar();
    }
}

function compararUltimasDuas() {
    const checkboxes = Array.from(document.querySelectorAll('.version-checkbox'));
    limparSelecao();
    if (checkboxes.length >= 2) {
        checkboxes[checkboxes.length - 2].checked = true;
        checkboxes[checkboxes.length - 1].checked = true;
        atualizarBotaoComparar();
    }
}

function compararUltimasTres() {
    const checkboxes = Array.from(document.querySelectorAll('.version-checkbox'));
    limparSelecao();
    if (checkboxes.length >= 3) {
        checkboxes[checkboxes.length - 3].checked = true;
        checkboxes[checkboxes.length - 2].checked = true;
        checkboxes[checkboxes.length - 1].checked = true;
        atualizarBotaoComparar();
    }
}

function toggleTopico(btn, topicoNome) {
    const perguntasRows = document.querySelectorAll(`tr.pergunta-row[data-topico="${topicoNome}"]`);
    const isExpanded = btn.classList.contains('expanded');
    
    btn.classList.toggle('expanded');
    
    perguntasRows.forEach(row => {
        if (isExpanded) {
            row.classList.add('hidden');
        } else {
            row.classList.remove('hidden');
        }
    });
}

function expandirTodos() {
    const allBtns = document.querySelectorAll('.expand-btn');
    allBtns.forEach(btn => {
        if (!btn.classList.contains('expanded')) {
            const topicoRow = btn.closest('tr.topico-row');
            const topicoNome = topicoRow.dataset.topico;
            
            btn.classList.add('expanded');
            const perguntasRows = document.querySelectorAll(`tr.pergunta-row[data-topico="${topicoNome}"]`);
            perguntasRows.forEach(row => row.classList.remove('hidden'));
        }
    });
}

function recolherTodos() {
    const allBtns = document.querySelectorAll('.expand-btn.expanded');
    allBtns.forEach(btn => {
        const topicoRow = btn.closest('tr.topico-row');
        const topicoNome = topicoRow.dataset.topico;
        
        btn.classList.remove('expanded');
        const perguntasRows = document.querySelectorAll(`tr.pergunta-row[data-topico="${topicoNome}"]`);
        perguntasRows.forEach(row => row.classList.add('hidden'));
    });
}

let mostrandoApenasDiferencas = false;

function toggleDiferencasApenas() {
    mostrandoApenasDiferencas = !mostrandoApenasDiferencas;
    const btn = document.getElementById('btn-filtro');
    const todasLinhas = document.querySelectorAll('.topico-row, .pergunta-row');
    
    if (mostrandoApenasDiferencas) {
        btn.innerHTML = '<i class="fas fa-eye"></i> Mostrar Todas';
        
        expandirTodos();
        
        const perguntasRows = document.querySelectorAll('.pergunta-row');
        perguntasRows.forEach(row => {
            const cells = row.querySelectorAll('.version-data');
            const hasEmpty = Array.from(cells).some(cell => cell.classList.contains('version-empty'));
            
            if (hasEmpty) {
                row.style.display = '';
                return;
            }
            
            const contents = Array.from(cells).map(cell => cell.innerHTML.trim());
            const allEqual = contents.every(content => content === contents[0]);
            
            if (allEqual) {
                row.style.display = 'none';
            }
        });
        
        const topicoRows = document.querySelectorAll('.topico-row');
        topicoRows.forEach(topicoRow => {
            const topicoNome = topicoRow.dataset.topico;
            const perguntasVisiveis = document.querySelectorAll(
                `tr.pergunta-row[data-topico="${topicoNome}"]:not([style*="display: none"])`
            );
            
            if (perguntasVisiveis.length === 0) {
                topicoRow.style.display = 'none';
            }
        });
        
    } else {
        btn.innerHTML = '<i class="fas fa-filter"></i> Mostrar Apenas Diferenças';
        
        todasLinhas.forEach(row => {
            row.style.display = '';
        });
        
        recolherTodos();
    }
}

</script>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\checklists\form.html

{% extends 'auditorias/base.html' %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-light: #3b82f6;
        --secondary: #f8fafc;
        --accent: #059669;
        --error: #dc2626;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --border: rgba(255, 255, 255, 0.2);
        --border-focus: #93c5fd;
        --bg-primary: rgba(255, 255, 255, 0.95);
        --bg-secondary: #f1f5f9;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
    }

    .form-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin: 20px;
        overflow: hidden;
    }

    .content-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .content-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
        pointer-events: none;
    }

    .content-header .header-content {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .content-title {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        letter-spacing: -0.03em;
        color: white;
    }

    .content-subtitle {
        font-size: 1rem;
        color: white;
        opacity: 0.9;
        font-weight: 400;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: var(--shadow-md);
    }
    
    .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: var(--radius-sm);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }

    .btn-danger:hover {
        box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
    }

    .card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
    }

    .card-body {
        padding: 2rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .form-row.single {
        grid-template-columns: 1fr;
    }

    .form-group {
        position: relative;
    }

    .form-group.required .form-label::after {
        content: '*';
        color: var(--error);
        margin-left: 4px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        letter-spacing: -0.01em;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .form-control {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-md);
        padding: 16px 20px;
        color: var(--text-primary);
        font-size: 15px;
        font-weight: 500;
        width: 100%;
        outline: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    
    .form-control.validation-error {
        border-color: var(--error);
        animation: shake 0.3s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        75% { transform: translateX(4px); }
    }

    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1), 0 4px 20px rgba(37, 99, 235, 0.1);
        background: rgba(255, 255, 255, 0.98);
    }

    .form-control.error {
        border-color: var(--error);
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ccc;
        border-radius: 34px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input:checked + .toggle-slider {
        background: var(--primary);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    /* Tabs styling */
    .tabs-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-xl);
        padding: 0;
        margin-top: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    .tabs-header {
        display: flex;
        border-bottom: 2px solid rgba(37, 99, 235, 0.1);
    }

    .tab-btn {
        flex: 1;
        padding: 1.5rem 2rem;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: none;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .tab-btn:hover {
        background: rgba(37, 99, 235, 0.05);
    }

    .tab-btn.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: white;
    }

    .tab-content {
        display: none;
        padding: 2rem;
    }

    .tab-content.active {
        display: block;
    }

    .checklist-manager {
        background: rgba(255, 255, 255, 0.92);
        border-radius: var(--radius-xl);
        padding: 2.5rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
    }

    .checklist-manager::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 80%, rgba(37, 99, 235, 0.03) 0%, transparent 50%);
        pointer-events: none;
    }

    .manager-header {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid rgba(37, 99, 235, 0.1);
        position: relative;
        z-index: 2;
    }

    .manager-header h4 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.02em;
    }

    .checklist-body {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        z-index: 2;
    }

    .topic-wrapper {
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
        overflow: hidden;
    }

    .topic-wrapper:hover {
        box-shadow: var(--shadow-lg);
    }

    .topic-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.5rem 2rem;
        position: relative;
        overflow: hidden;
    }

    .topic-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
        pointer-events: none;
    }

    .topic-header-controls {
        position: relative;
        z-index: 2;
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .topic-header .form-control {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        flex: 1;
    }

    .topic-header .form-control::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .topic-header .form-control:focus {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .questions-container {
        padding: 2rem;
        background: rgba(248, 250, 252, 0.8);
    }

    .question-card {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
    }

    .question-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    }

    .question-card:hover {
        transform: translateX(2px);
        box-shadow: var(--shadow-md);
        border-color: rgba(37, 99, 235, 0.2);
    }

    .question-card textarea {
        resize: vertical;
        min-height: 80px;
        margin-bottom: 1rem;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 1rem 0;
        padding: 1rem;
        background: rgba(248, 250, 252, 0.6);
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-sm);
        border: 1px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
    }

    .checkbox-item:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: var(--shadow-sm);
    }

    .checkbox-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
    }

    .checkbox-item label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        margin: 0;
    }

    .question-footer {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px dashed rgba(37, 99, 235, 0.2);
    }

    .options-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(248, 250, 252, 0.7);
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .options-section h5 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .options-section h5::before {
        content: '⚙️';
        font-size: 16px;
    }

    .option-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .option-item.resposta { grid-template-columns: auto 2fr 1fr auto; }
    .option-item.porcentagem { grid-template-columns: auto 2fr 1fr 1fr auto; }

    .option-item:hover {
        background: rgba(255, 255, 255, 0.98);
        transform: translateX(2px);
        box-shadow: var(--shadow-sm);
    }
    
    .option-controls {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .option-controls .btn {
        padding: 4px;
        width: 24px;
        height: 24px;
        font-size: 12px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid #e2e8f0;
    }
    .option-controls .btn:hover {
        background: #e2e8f0;
    }
     .option-controls .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .form-container {
            margin: 10px;
        }

        .content-header {
            padding: 1.5rem;
        }

        .content-header .header-content {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .content-title {
            font-size: 1.5rem;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .checklist-manager {
            padding: 1.5rem;
        }

        .topic-header {
            padding: 1rem;
        }

        .topic-header-controls {
            flex-direction: column;
            gap: 0.5rem;
        }

        .questions-container {
            padding: 1rem;
        }

        .question-card {
            padding: 1rem;
        }

        .option-item, .option-item.resposta, .option-item.porcentagem {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .checkbox-group {
            flex-direction: column;
            gap: 0.5rem;
        }
    }

    .btn.loading {
        pointer-events: none;
        opacity: 0.7;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        margin-left: 8px;
    }

    .field-error {
        color: var(--error);
        font-size: 0.85rem;
        margin-top: 8px;
        font-weight: 500;
        padding-left: 5px;
    }

    .form-control,
    .btn,
    .card,
    .topic-wrapper,
    .question-card,
    .checkbox-item,
    .option-item {
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }

    /* NOVOS ESTILOS PARA BOTÕES DE AÇÃO */
    .action-btn-group {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
    }
    .action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    /* ESTILOS PARA OS TOASTS DE NOTIFICAÇÃO */
    .toast-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        pointer-events: none;
        gap: 12px;
    }
    .toast {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 20px;
        min-width: 400px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 16px;
        position: relative;
        overflow: hidden;
        pointer-events: auto;
        animation: slideDownIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: top center;
    }
    .toast.toast-error { color: #fca5a5; border-color: rgba(239, 68, 68, 0.3); }
    .toast-icon { flex-shrink: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.25); }
    .toast-content { flex: 1; min-width: 0; }
    .toast-title { font-size: 16px; font-weight: 700; color: #f8fafc; margin-bottom: 6px; }
    .toast-message { font-size: 14px; color: rgba(248, 250, 252, 0.85); line-height: 1.5; word-wrap: break-word; }
    .toast-close { flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; cursor: pointer; color: rgba(255, 255, 255, 0.6); }
    .toast-close:hover { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.9); }
    .toast.hiding { animation: slideUpOut 0.4s cubic-bezier(0.4, 0, 1, 1) forwards; }
    @keyframes slideDownIn { from { opacity: 0; transform: translateY(-100px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes slideUpOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-100px) scale(0.95); } }
</style>

<div class="modal" id="confirmActionModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2 id="confirmActionTitle"><i class="fas fa-exclamation-triangle"></i> Confirmar Ação</h2>
            <span class="close-btn" id="confirmActionClose">&times;</span>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p id="confirmActionMessage">Tem certeza que deseja executar esta ação?</p>
            <p style="color: var(--error); font-weight: 500;">Esta ação não pode ser desfeita.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="confirmActionCancel">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmActionConfirm">Sim, Confirmar</button>
        </div>
    </div>
</div>

<div class="form-container">
    <div class="toast-container" id="toastContainer"></div>

    <form method="post" enctype="multipart/form-data" id="mainForm" novalidate>
        {% csrf_token %}

        <div class="content-header">
            <div class="header-content">
                <div>
                    <h2 class="content-title">{{ title }}</h2>
                    <p class="content-subtitle">Configure seu checklist de forma completa e organizada</p>
                </div>
                <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs-header">
                <button type="button" class="tab-btn active" id="tab-btn-info" onclick="switchTab(event, 'checklist-info')">
                    <i class="fas fa-info-circle"></i> Informações do Checklist
                </button>
                <button type="button" class="tab-btn" id="tab-btn-structure" onclick="switchTab(event, 'checklist-structure')">
                    <i class="fas fa-sitemap"></i> Estrutura do Checklist
                </button>
            </div>
            
            <div class="tab-content active" id="checklist-info">
                <div class="card">
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin-bottom: 2rem; font-size: 15px;">
                            Preencha os campos abaixo para configurar as informações básicas do checklist.
                        </p>

                        <div class="form-row single">
                            <div class="form-group required">
                                <label for="nome" class="form-label">Nome do Checklist</label>
                                <input type="text" id="nome" name="nome" class="form-control" value="{{ checklist.nome|default:'' }}" required maxlength="255" placeholder="Digite o nome do checklist">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="ferramenta" class="form-label">Ferramenta Digital</label>
                                <select id="ferramenta" name="ferramenta" class="form-control form-select">
                                    <option value="">Selecione uma ferramenta...</option>
                                    {% for f in ferramentas %}
                                        <option value="{{ f.pk }}" {% if checklist.ferramenta.pk == f.pk %}selected{% endif %}>{{ f.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status do Checklist</label>
                                <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="ativo" {% if checklist.ativo|default:True %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="color: var(--text-secondary); font-size: 14px; font-weight: 500;">Checklist ativo no sistema</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label for="normas_relacionadas" class="form-label">Normas Relacionadas</label>
                                
                                <!-- Verifique se o 'id' e 'multiple' estão presentes -->
                                <select id="normas_relacionadas" name="normas_relacionadas" multiple placeholder="Selecione as normas...">
                                    {% for norma in todas_as_normas %}
                                        <option value="{{ norma.pk }}" 
                                            {% if checklist and norma in checklist.normas_relacionadas.all %}selected{% endif %}>
                                            {{ norma }} <!-- Usar o __str__ do modelo é uma boa prática -->
                                        </option>
                                    {% endfor %}
                                </select>

                                <div class="field-help">Selecione as normas que este checklist ajuda a verificar.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="checklist-structure">
                <div class="checklist-manager">
                    <div class="manager-header">
                        <h4>🔧 Estrutura do Checklist</h4>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 14px;">Configure os tópicos e perguntas que compõem seu checklist</p>
                    </div>
                    
                    <div class="checklist-body" id="topics-container">
                        {% for topico in checklist.topicos.all|dictsort:"ordem" %}
                        <div class="topic-wrapper" data-topic-id="{{ topico.id }}">
                            <div class="topic-header">
                                <div class="topic-header-controls">
                                    <input type="hidden" name="topico-ordem[{{ topico.id }}]" class="js-topic-order" value="{{ topico.ordem }}">
                                    <input type="text" name="topico-descricao[{{ topico.id }}]" class="form-control" value="{{ topico.descricao }}" placeholder="Descrição do Tópico">
                                    <div class="action-btn-group">
                                        <button type="button" class="action-btn js-move-topic-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                        <button type="button" class="action-btn js-move-topic-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                        <button type="button" class="action-btn js-duplicate-topic" title="Duplicar Tópico"><i class="fas fa-copy"></i></button>
                                        <button type="button" class="action-btn btn-danger js-remove-topic" title="Excluir Tópico">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="questions-container">
                                {% for pergunta in topico.perguntas.all|dictsort:"ordem" %}
                                <div class="question-card" data-question-id="{{ pergunta.id }}">
                                    <div class="question-header">
                                        <input type="hidden" name="pergunta-ordem[{{ topico.id }}-{{ pergunta.id }}]" class="js-question-order" value="{{ pergunta.ordem }}">
                                        <div class="action-btn-group">
                                            <button type="button" class="btn btn-secondary btn-sm js-move-question-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                            <button type="button" class="btn btn-secondary btn-sm js-move-question-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                        </div>
                                        <div class="action-btn-group">
                                            <button type="button" class="btn btn-secondary btn-sm js-duplicate-question" title="Duplicar Pergunta"><i class="fas fa-copy"></i></button>
                                            <button type="button" class="btn btn-danger btn-sm js-remove-question" title="Excluir Pergunta"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <textarea name="pergunta-descricao[{{ topico.id }}-{{ pergunta.id }}]" class="form-control" rows="3" placeholder="Digite a descrição da pergunta">{{ pergunta.descricao }}</textarea>
                                    
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" name="pergunta-resposta_livre[{{ topico.id }}-{{ pergunta.id }}]" id="resposta_livre_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.resposta_livre %}checked{% endif %}>
                                            <label for="resposta_livre_{{ topico.id }}_{{ pergunta.id }}">📝 Resposta Livre</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" name="pergunta-foto[{{ topico.id }}-{{ pergunta.id }}]" id="foto_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.foto %}checked{% endif %}>
                                            <label for="foto_{{ topico.id }}_{{ pergunta.id }}">📷 Foto</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" data-controls="options-resposta-section" name="pergunta-criar_opcao[{{ topico.id }}-{{ pergunta.id }}]" id="criar_opcao_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.criar_opcao %}checked{% endif %}>
                                            <label for="criar_opcao_{{ topico.id }}_{{ pergunta.id }}">✅ Criar uma Opção</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" data-controls="options-porcentagem-section" name="pergunta-porcentagem[{{ topico.id }}-{{ pergunta.id }}]" id="porcentagem_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.porcentagem %}checked{% endif %}>
                                            <label for="porcentagem_{{ topico.id }}_{{ pergunta.id }}">📊 Porcentagem</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="pergunta-obrigatorio[{{ topico.id }}-{{ pergunta.id }}]" id="obrigatorio_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.obrigatoria %}checked{% endif %}>
                                            <label for="obrigatorio_{{ topico.id }}_{{ pergunta.id }}">⚠️ Obrigatória</label>
                                        </div>
                                    </div>

                                    <div class="question-footer">
                                        <div class="options-section options-resposta-section" style="display: {% if pergunta.criar_opcao %}block{% else %}none{% endif %};">
                                            <h5>Opções de Resposta</h5>
                                            <div class="options-container">
                                                {% for opcao in pergunta.opcoes_resposta.all|dictsort:"ordem" %}
                                                <div class="option-item resposta">
                                                    <div class="option-controls">
                                                        <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                                        <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                                    </div>
                                                    <input type="hidden" class="js-option-order" name="opcao-resposta-ordem[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.ordem }}">
                                                    <input type="text" name="opcao-resposta-descricao[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.descricao }}" placeholder="Descrição da opção">
                                                    <select name="opcao-resposta-status[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control">
                                                        {% for value, text in status_opcoes %}
                                                            <option value="{{ value }}" {% if opcao.status == value %}selected{% endif %}>{{ text }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <button type="button" class="btn btn-danger btn-sm js-remove-option">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button type="button" class="btn btn-secondary js-add-option-resposta">
                                                <i class="fas fa-plus"></i> Adicionar Opção
                                            </button>
                                        </div>
                                        
                                        <div class="options-section options-porcentagem-section" style="display: {% if pergunta.porcentagem %}block{% else %}none{% endif %};">
                                            <h5>Opções de Porcentagem</h5>
                                            <div class="options-container">
                                                {% for opcao in pergunta.opcoes_porcentagem.all|dictsort:"ordem" %}
                                                <div class="option-item porcentagem">
                                                    <div class="option-controls">
                                                        <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                                        <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                                    </div>
                                                    <input type="hidden" class="js-option-order" name="opcao-porcentagem-ordem[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.ordem }}">
                                                    <input type="text" name="opcao-porcentagem-descricao[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.descricao }}" placeholder="Descrição da opção">
                                                    <input type="number" name="opcao-porcentagem-peso[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.peso }}" min="0" max="100" placeholder="Peso %">
                                                    <input type="color" name="opcao-porcentagem-cor[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.cor }}" style="width: 60px; height: 40px; padding: 4px;">
                                                    <button type="button" class="btn btn-danger btn-sm js-remove-option">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button type="button" class="btn btn-secondary js-add-option-porcentagem">
                                                <i class="fas fa-plus"></i> Adicionar Opção
                                            </button>
                                        </div>
                                    </div>
                                    
                                </div>
                                {% endfor %}
                                <button type="button" class="btn btn-primary js-add-question">
                                    <i class="fas fa-plus"></i> Adicionar Pergunta
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin-top: 2rem;">
                        <button type="button" id="add-topic-btn" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Adicionar Novo Tópico
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin: 2rem; padding-top: 2rem; border-top: 2px solid rgba(37, 99, 235, 0.1);">
            <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save"></i> Salvar Alterações
            </button>
        </div>
    </form>
</div>

{{ status_opcoes|json_script:"status-opcoes-data" }}

<template id="topic-template">
    <div class="topic-wrapper" data-topic-id="new-id">
        <div class="topic-header">
            <div class="topic-header-controls">
                <input type="hidden" name="topico-ordem[new-id]" class="js-topic-order" value="">
                <input type="text" name="topico-descricao[new-id]" class="form-control" placeholder="Descrição do Novo Tópico">
                <div class="action-btn-group">
                    <button type="button" class="action-btn js-move-topic-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                    <button type="button" class="action-btn js-move-topic-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                    <button type="button" class="action-btn js-duplicate-topic" title="Duplicar Tópico"><i class="fas fa-copy"></i></button>
                    <button type="button" class="action-btn btn-danger js-remove-topic" title="Excluir Tópico">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="questions-container">
            <button type="button" class="btn btn-primary js-add-question">
                <i class="fas fa-plus"></i> Adicionar Pergunta
            </button>
        </div>
    </div>
</template>

<template id="question-template">
    <div class="question-card" data-question-id="new-question-id">
        <div class="question-header">
            <input type="hidden" name="pergunta-ordem[topic-id-question-id]" class="js-question-order" value="">
            <div class="action-btn-group">
                <button type="button" class="btn btn-secondary btn-sm js-move-question-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                <button type="button" class="btn btn-secondary btn-sm js-move-question-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
            </div>
            <div class="action-btn-group">
                <button type="button" class="btn btn-secondary btn-sm js-duplicate-question" title="Duplicar Pergunta"><i class="fas fa-copy"></i></button>
                <button type="button" class="btn btn-danger btn-sm js-remove-question" title="Excluir Pergunta"><i class="fas fa-trash"></i></button>
            </div>
        </div>
        <textarea name="pergunta-descricao[topic-id-question-id]" class="form-control" rows="3" placeholder="Digite a descrição da pergunta"></textarea>
        
        <div class="checkbox-group">
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" name="pergunta-resposta_livre[topic-id-question-id]" id="resposta_livre_new">
                <label for="resposta_livre_new">📝 Resposta Livre</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" name="pergunta-foto[topic-id-question-id]" id="foto_new">
                <label for="foto_new">📷 Foto</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" data-controls="options-resposta-section" name="pergunta-criar_opcao[topic-id-question-id]" id="criar_opcao_new" checked>
                <label for="criar_opcao_new">✅ Criar uma Opção</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" data-controls="options-porcentagem-section" name="pergunta-porcentagem[topic-id-question-id]" id="porcentagem_new">
                <label for="porcentagem_new">📊 Porcentagem</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" name="pergunta-obrigatorio[topic-id-question-id]" id="obrigatorio_new">
                <label for="obrigatorio_new">⚠️ Obrigatória</label>
            </div>
        </div>
        
        <div class="question-footer">
            <div class="options-section options-resposta-section">
                <h5>Opções de Resposta</h5>
                <div class="options-container"></div>
                <button type="button" class="btn btn-secondary js-add-option-resposta">
                    <i class="fas fa-plus"></i> Adicionar Opção
                </button>
            </div>
            <div class="options-section options-porcentagem-section" style="display: none;">
                <h5>Opções de Porcentagem</h5>
                <div class="options-container"></div>
                <button type="button" class="btn btn-secondary js-add-option-porcentagem">
                    <i class="fas fa-plus"></i> Adicionar Opção
                </button>
            </div>
        </div>
    </div>
</template>

<template id="option-resposta-template">
    <div class="option-item resposta">
        <div class="option-controls">
            <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
            <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
        </div>
        <input type="hidden" class="js-option-order" name="opcao-resposta-ordem[question-id-option-id]" value="">
        <input type="text" name="opcao-resposta-descricao[question-id-option-id]" class="form-control" placeholder="Descrição da opção">
        <select name="opcao-resposta-status[question-id-option-id]" class="form-control"></select>
        <button type="button" class="btn btn-danger btn-sm js-remove-option">
            <i class="fas fa-times"></i>
        </button>
    </div>
</template>

<template id="option-porcentagem-template">
    <div class="option-item porcentagem">
        <div class="option-controls">
            <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
            <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
        </div>
        <input type="hidden" class="js-option-order" name="opcao-porcentagem-ordem[question-id-option-id]" value="">
        <input type="text" name="opcao-porcentagem-descricao[question-id-option-id]" class="form-control" placeholder="Descrição da opção">
        <input type="number" name="opcao-porcentagem-peso[question-id-option-id]" class="form-control" min="0" max="100" placeholder="Peso %">
        <input type="color" name="opcao-porcentagem-cor[question-id-option-id]" class="form-control" value="#3b82f6" style="width: 60px; height: 40px; padding: 4px;">
        <button type="button" class="btn btn-danger btn-sm js-remove-option">
            <i class="fas fa-times"></i>
        </button>
    </div>
</template>

<script>

// Função para trocar de aba
function switchTab(event, tabId) {
    if (event) event.preventDefault();
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.getElementById(`tab-btn-${tabId.split('-')[1]}`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

document.addEventListener('DOMContentLoaded', function() {
    
    // Inicializa o TomSelect para o campo de Normas (movido para cá)
    new TomSelect('#normas_relacionadas',{
        plugins: ['remove_button'],
        placeholder: 'Selecione uma ou mais normas...',
        sortField: {
            field: "text",
            direction: "asc"
        }
    });

    const topicsContainer = document.getElementById('topics-container');
    const statusOpcoesElement = document.getElementById('status-opcoes-data');
    let statusOpcoes = [];
    
    try {
        statusOpcoes = JSON.parse(statusOpcoesElement.textContent);
    } catch (e) {
        statusOpcoes = [['CONFORME', 'Conforme'], ['NAO_CONFORME', 'Não Conforme'], ['NA', 'N/A']];
    }

    let newTopicCounter = 0;
    let newQuestionCounter = 0;
    let newOptionCounter = 0;

    function getNewId(prefix) {
        if (prefix === 'topic') return `new-${++newTopicCounter}`;
        if (prefix === 'question') return `new-${++newQuestionCounter}`;
        if (prefix === 'option') return `new-${++newOptionCounter}`;
    }

    // *** INÍCIO DAS NOVAS FUNÇÕES DE MODAL E TOAST ***
    function showToast(type, title, message) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-icon"><i class="fas fa-exclamation-circle"></i></div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button type="button" class="toast-close" aria-label="Fechar"><i class="fas fa-times"></i></button>`;
        container.appendChild(toast);
        setTimeout(() => hideToast(toast), 5000);
    }

    function hideToast(toast) {
        if(toast) {
            toast.classList.add('hiding');
            toast.addEventListener('animationend', () => toast.remove());
        }
    }

    function showConfirmModal(title, message, onConfirmCallback) {
        const modal = document.getElementById('confirmActionModal');
        modal.querySelector('#confirmActionTitle').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${title}`;
        modal.querySelector('#confirmActionMessage').innerHTML = message;
        
        const confirmBtn = modal.querySelector('#confirmActionConfirm');
        const cancelBtn = modal.querySelector('#confirmActionCancel');
        const closeBtn = modal.querySelector('#confirmActionClose');

        // Clona o botão para remover listeners antigos
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener('click', () => {
            onConfirmCallback();
            hideConfirmModal();
        }, { once: true }); // Garante que o evento só dispare uma vez

        cancelBtn.onclick = hideConfirmModal;
        closeBtn.onclick = hideConfirmModal;
        
        modal.style.display = 'flex';
    }

    function hideConfirmModal() {
        const modal = document.getElementById('confirmActionModal');
        modal.style.display = 'none';
    }
    // *** FIM DAS NOVAS FUNÇÕES DE MODAL E TOAST ***

    document.body.addEventListener('click', function(e) {
        const target = e.target;
        const closest = target.closest.bind(target);
        
        if (target.id === 'add-topic-btn' || closest('#add-topic-btn')) { e.preventDefault(); addTopic(); return; }
        if (closest('.js-remove-topic')) { e.preventDefault(); removeTopic(closest('.js-remove-topic')); return; }
        if (closest('.js-duplicate-topic')) { e.preventDefault(); duplicateTopic(closest('.js-duplicate-topic')); return; }
        if (closest('.js-move-topic-up')) { e.preventDefault(); moveUp(closest('.topic-wrapper')); updateOrders(); return; }
        if (closest('.js-move-topic-down')) { e.preventDefault(); moveDown(closest('.topic-wrapper')); updateOrders(); return; }
        if (closest('.js-add-question')) { e.preventDefault(); addQuestion(closest('.js-add-question')); return; }
        if (closest('.js-remove-question')) { e.preventDefault(); removeQuestion(closest('.js-remove-question')); return; }
        if (closest('.js-duplicate-question')) { e.preventDefault(); duplicateQuestion(closest('.js-duplicate-question')); return; }
        if (closest('.js-move-question-up')) { e.preventDefault(); moveUp(closest('.question-card')); updateOrders(); return; }
        if (closest('.js-move-question-down')) { e.preventDefault(); moveDown(closest('.question-card')); updateOrders(); return; }
        if (closest('.js-add-option-resposta')) { e.preventDefault(); addOptionResposta(closest('.js-add-option-resposta')); return; }
        if (closest('.js-add-option-porcentagem')) { e.preventDefault(); addOptionPorcentagem(closest('.js-add-option-porcentagem')); return; }
        if (closest('.js-remove-option')) { e.preventDefault(); removeOption(closest('.js-remove-option')); return; }
        // *** NOVA LÓGICA DE ORDENAÇÃO DE OPÇÕES ***
        if (closest('.js-move-option-up')) { e.preventDefault(); moveUp(closest('.option-item')); updateOrders(); return; }
        if (closest('.js-move-option-down')) { e.preventDefault(); moveDown(closest('.option-item')); updateOrders(); return; }

        if (closest('.toast-close')) { hideToast(closest('.toast')); return; }
    });

    function updateOrders() {
        const topics = topicsContainer.querySelectorAll('.topic-wrapper');
        topics.forEach((topic, topicIndex) => {
            const topicOrderInput = topic.querySelector('.js-topic-order');
            if(topicOrderInput) topicOrderInput.value = topicIndex;

            const questions = topic.querySelectorAll('.question-card');
            questions.forEach((question, questionIndex) => {
                const questionOrderInput = question.querySelector('.js-question-order');
                if(questionOrderInput) questionOrderInput.value = questionIndex;
                
                // *** NOVA LÓGICA DE ORDENAÇÃO DE OPÇÕES ***
                const optionSections = question.querySelectorAll('.options-section');
                optionSections.forEach(section => {
                    const options = section.querySelectorAll('.option-item');
                    options.forEach((option, optionIndex) => {
                        const optionOrderInput = option.querySelector('.js-option-order');
                        if(optionOrderInput) optionOrderInput.value = optionIndex;
                    });
                });
            });
        });
        updateMoveButtons();
    }

    function updateMoveButtons() {
        const topics = topicsContainer.querySelectorAll('.topic-wrapper');
        topics.forEach((topic, index) => {
            topic.querySelector('.js-move-topic-up').disabled = (index === 0);
            topic.querySelector('.js-move-topic-down').disabled = (index === topics.length - 1);
        });

        topics.forEach(topic => {
            const questions = topic.querySelectorAll('.question-card');
            questions.forEach((question, index) => {
                question.querySelector('.js-move-question-up').disabled = (index === 0);
                question.querySelector('.js-move-question-down').disabled = (index === questions.length - 1);
                
                // *** NOVA LÓGICA DE ORDENAÇÃO DE OPÇÕES ***
                const optionSections = question.querySelectorAll('.options-section');
                optionSections.forEach(section => {
                    const options = section.querySelectorAll('.option-item');
                    options.forEach((option, optionIndex) => {
                        option.querySelector('.js-move-option-up').disabled = (optionIndex === 0);
                        option.querySelector('.js-move-option-down').disabled = (optionIndex === options.length - 1);
                    });
                });
            });
        });
    }

    function moveUp(element) { if (element.previousElementSibling) element.parentNode.insertBefore(element, element.previousElementSibling); }
    function moveDown(element) { if (element.nextElementSibling) element.parentNode.insertBefore(element.nextElementSibling, element); }
    
    function addTopic() {
        const tpl = document.getElementById('topic-template').content.cloneNode(true);
        const wrapper = tpl.querySelector('.topic-wrapper');
        const newId = getNewId('topic');
        wrapper.dataset.topicId = newId;
        wrapper.innerHTML = wrapper.innerHTML.replace(/new-id/g, newId);
        topicsContainer.appendChild(tpl);
        updateOrders();
    }

    function removeTopic(target) {
        const topicWrapper = target.closest('.topic-wrapper');
        const topicName = topicWrapper.querySelector('input[name*="topico-descricao"]').value || "este tópico";
        showConfirmModal(
            'Excluir Tópico?', 
            `Tem certeza que deseja excluir o tópico "<strong>${topicName}</strong>" e todas as suas perguntas?`,
            () => {
                topicWrapper.remove();
                updateOrders();
            }
        );
    }

    function duplicateTopic(target) {
        const originalTopic = target.closest('.topic-wrapper');
        const clone = originalTopic.cloneNode(true);
        const newTopicId = getNewId('topic');
        
        clone.dataset.topicId = newTopicId;

        // Renomeia os inputs do próprio tópico
        const descInput = clone.querySelector('input[name*="topico-descricao"]');
        descInput.value = `${descInput.value} (cópia)`;
        descInput.name = `topico-descricao[${newTopicId}]`;

        const orderInput = clone.querySelector('.js-topic-order');
        orderInput.name = `topico-ordem[${newTopicId}]`;

        // Itera sobre cada pergunta clonada para atualizar seus IDs e nomes
        clone.querySelectorAll('.question-card').forEach(question => {
            const originalQuestionId = question.dataset.questionId;
            const newQuestionId = getNewId('question');
            question.dataset.questionId = newQuestionId;
            
            const oldQuestionPrefix = `[${originalTopic.dataset.topicId}-${originalQuestionId}]`;
            const newQuestionPrefix = `[${newTopicId}-${newQuestionId}]`;
            
            // Atualiza todos os 'name' e 'id' da pergunta
            question.querySelectorAll(`[name*="${oldQuestionPrefix}"], [id*="${originalQuestionId}"]`).forEach(el => {
                const oldName = el.name;
                const oldId = el.id;

                if (oldName) {
                    el.name = oldName.replace(`[${originalTopic.dataset.topicId}-${originalQuestionId}]`, newQuestionPrefix);
                }
                if (oldId) {
                    el.id = oldId.replace(`_${originalQuestionId}`, `_${newQuestionId}`);
                    const label = question.querySelector(`label[for="${oldId}"]`);
                    if (label) {
                        label.setAttribute('for', el.id);
                    }
                }
            });

            // Itera sobre as opções para garantir que seus IDs também sejam novos
            question.querySelectorAll('.option-item').forEach(option => {
                const originalOptionId = option.querySelector('input, select')?.name.match(/(\d+|new-\d+)$/)?.[0] || getNewId('option');
                const newOptionId = getNewId('option');

                option.querySelectorAll('[name]').forEach(el => {
                    // Reconstrói o name do zero para garantir
                    const match = el.name.match(/^(opcao-\w+-\w+)\[(.*)\]$/);
                    if (match) {
                        const baseName = match[1];
                        el.name = `${baseName}[${newTopicId}-${newQuestionId}-${newOptionId}]`;
                    }
                });
            });
        });

        originalTopic.parentNode.insertBefore(clone, originalTopic.nextSibling);
        updateOrders();
    }

    function addQuestion(target) {
        const questionsContainer = target.closest('.questions-container');
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;
        const tpl = document.getElementById('question-template').content.cloneNode(true);
        const card = tpl.querySelector('.question-card');
        const newId = getNewId('question');
        card.dataset.questionId = newId;
        
        let html = card.innerHTML;
        const regex = /\[topic-id-question-id\]|id="(.*?)_new"/g;
        card.innerHTML = html.replace(regex, (match, p1) => {
            if (match.startsWith('[')) return `[${topicId}-${newId}]`;
            if (match.startsWith('id="')) return `id="${p1}_${topicId}_${newId}"`;
            return match;
        });
        questionsContainer.insertBefore(tpl, target);
        updateOrders();
    }

    function removeQuestion(target) {
        const questionCard = target.closest('.question-card');
        const questionName = questionCard.querySelector('textarea[name*="pergunta-descricao"]').value || "esta pergunta";
        const truncatedName = questionName.length > 50 ? questionName.substring(0, 50) + '...' : questionName;

        showConfirmModal(
            'Excluir Pergunta?',
            `Tem certeza que deseja excluir a pergunta "<strong>${truncatedName}</strong>"?`,
            () => {
                questionCard.remove();
                updateOrders();
            }
        );
    }

    function duplicateQuestion(target) {
        const originalQuestion = target.closest('.question-card');
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;

        const clone = originalQuestion.cloneNode(true);
        const newQuestionId = getNewId('question');
        clone.dataset.questionId = newQuestionId;
        
        // Limpa o valor da descrição clonada e adiciona "(cópia)"
        const descTextarea = clone.querySelector('textarea[name*="pergunta-descricao"]');
        descTextarea.value = `${descTextarea.value} (cópia)`;

        const oldQuestionId = originalQuestion.dataset.questionId;
        
        // Atualiza todos os 'name', 'id' e 'for' da pergunta clonada
        clone.querySelectorAll(`[name*="${oldQuestionId}"], [id*="${oldQuestionId}"]`).forEach(el => {
            const oldName = el.name;
            const oldId = el.id;

            if (oldName) {
                // Reconstrói o name usando o novo ID da pergunta
                el.name = oldName.replace(`[${topicId}-${oldQuestionId}]`, `[${topicId}-${newQuestionId}]`);
            }
            if (oldId) {
                // Atualiza o ID do elemento
                const newId = oldId.replace(`_${oldQuestionId}`, `_${newQuestionId}`);
                el.id = newId;
                
                // Busca e atualiza o 'for' do label correspondente
                const label = clone.querySelector(`label[for="${oldId}"]`);
                if (label) {
                    label.setAttribute('for', newId);
                }
            }
        });

        // Itera sobre as opções clonadas para garantir que recebam novos IDs
        clone.querySelectorAll('.option-item').forEach(option => {
            const newOptionId = getNewId('option');
            
            option.querySelectorAll('[name]').forEach(el => {
                // Reconstrói o name da opção do zero para máxima segurança
                const match = el.name.match(/^(opcao-\w+-\w+)\[(.*)\]$/);
                if (match) {
                    const baseName = match[1];
                    el.name = `${baseName}[${topicId}-${newQuestionId}-${newOptionId}]`;
                }
            });
        });

        originalQuestion.parentNode.insertBefore(clone, originalQuestion.nextSibling);
        updateOrders();
    }

    function addOptionResposta(target) {
        const optionsContainer = target.closest('.options-section').querySelector('.options-container');
        const questionCard = target.closest('.question-card');
        const questionId = questionCard.dataset.questionId;
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;
        const tpl = document.getElementById('option-resposta-template').content.cloneNode(true);
        const item = tpl.querySelector('.option-item');
        const newId = getNewId('option');
        
        item.innerHTML = item.innerHTML.replace(/\[question-id-option-id\]/g, `[${topicId}-${questionId}-${newId}]`);
        
        const select = item.querySelector('select');
        statusOpcoes.forEach(([value, text]) => select.add(new Option(text, value)));
        
        optionsContainer.appendChild(tpl);
        updateOrders();
    }

    function addOptionPorcentagem(target) {
        const optionsContainer = target.closest('.options-section').querySelector('.options-container');
        const questionCard = target.closest('.question-card');
        const questionId = questionCard.dataset.questionId;
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;
        const tpl = document.getElementById('option-porcentagem-template').content.cloneNode(true);
        const item = tpl.querySelector('.option-item');
        const newId = getNewId('option');
        
        item.innerHTML = item.innerHTML.replace(/\[question-id-option-id\]/g, `[${topicId}-${questionId}-${newId}]`);
        optionsContainer.appendChild(tpl);
        updateOrders();
    }

    function removeOption(target) {
        const optionItem = target.closest('.option-item');
        showConfirmModal(
            'Remover Opção?',
            'Tem certeza que deseja remover esta opção?',
            () => {
                optionItem.remove();
                updateOrders();
            }
        );
    }

    /**
     * Garante que apenas "Criar uma Opção" ou "Porcentagem" possam ser marcados.
     * @param {HTMLInputElement} checkbox - O checkbox que foi alterado.
     */
    function handleCheckboxExclusivity(checkbox) {
        // Só faz algo se o checkbox foi MARCADO
        if (!checkbox.checked) return;

        const questionCard = checkbox.closest('.question-card');
        if (!questionCard) return;
        
        let siblingCheckbox;

        // Se o checkbox de 'Opção' foi marcado, desmarca o de 'Porcentagem'
        if (checkbox.name.includes('pergunta-criar_opcao')) {
            siblingCheckbox = questionCard.querySelector('[name*="pergunta-porcentagem"]');
        } 
        // Se o checkbox de 'Porcentagem' foi marcado, desmarca o de 'Opção'
        else if (checkbox.name.includes('pergunta-porcentagem')) {
            siblingCheckbox = questionCard.querySelector('[name*="pergunta-criar_opcao"]');
        }

        // Se encontramos o "irmão" e ele está marcado, desmarcamos
        if (siblingCheckbox && siblingCheckbox.checked) {
            siblingCheckbox.checked = false;
            // Dispara o evento de 'change' para que a UI se atualize (esconda a seção de opções)
            siblingCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    document.body.addEventListener('change', function(e) {
        // Lógica de exclusividade dos checkboxes
        if (e.target.classList.contains('js-response-type')) {
            handleCheckboxExclusivity(e.target);
        }

        // Lógica para mostrar/esconder seções de opções
        if (e.target.classList.contains('js-response-type') && e.target.dataset.controls) {
            const section = e.target.closest('.question-card').querySelector(`.${e.target.dataset.controls}`);
            if (section) section.style.display = e.target.checked ? 'block' : 'none';
        }
    });

    // Validação do formulário
    const form = document.getElementById('mainForm');
    const submitBtn = document.getElementById('submitBtn');

    function validateForm() {
        document.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));

        const checklistNameInput = document.getElementById('nome');
        if (!checklistNameInput.value.trim()) {
            showToast('error', 'Validação Falhou', 'O nome do checklist é obrigatório. Por favor, preencha o campo antes de salvar.');
            switchTab(null, 'checklist-info');
            checklistNameInput.classList.add('validation-error');
            checklistNameInput.focus();
            return false;
        }

        const topicInputs = document.querySelectorAll('input[name*="topico-descricao"]');
        const topicNames = new Set();
        let duplicateFound = false;
        
        topicInputs.forEach(input => {
            const name = input.value.trim().toLowerCase();
            if (name && topicNames.has(name)) {
                duplicateFound = true;
                document.querySelectorAll('input[name*="topico-descricao"]').forEach(innerInput => {
                    if (innerInput.value.trim().toLowerCase() === name) {
                        innerInput.classList.add('validation-error');
                    }
                });
            }
            topicNames.add(name);
        });

        if (duplicateFound) {
            showToast('error', 'Validação Falhou', 'Existem tópicos com nomes duplicados.');
            switchTab(null, 'checklist-structure');
            return false;
        }

        return true;
    }

    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                return;
            }
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
        });
    }



    updateOrders();
    console.log('Script carregado completamente');
});
</script>

{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\checklists\historico.html

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histórico de Versões - {{ original.nome }}</title>
    {% load static %}
    {% include 'auditorias/partials/_head.html' %}
</head>
<body>
    <div class="app-container">
        {% include 'auditorias/partials/_sidebar.html' %}
        
        <main class="main-content">
            {% include 'auditorias/partials/_header.html' %}
            
            <div class="content-area">
                {% include 'auditorias/partials/_messages.html' %}
                
                <!-- Conteúdo do Histórico -->
                <div class="content-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 class="content-title">Histórico de Versões - {{ original.nome }}</h2>
                            <p class="content-subtitle">Visualize todas as versões criadas para este checklist.</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <a href="{% url 'auditorias:comparar_versoes_checklist' original.pk %}" class="btn btn-primary">
                                <i class="fas fa-exchange-alt"></i> Comparar Versões
                            </a>
                            <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar para a Lista
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 class="card-title">Lista de Versões</h3>
                                <p class="card-subtitle">
                                    {% if versoes.count %}

                                        {{ versoes.count }} vers{{ versoes.count|pluralize:"ão,ões" }} encontrada{{ versoes.count|pluralize:",s" }}

                                    {% else %}
                                        Nenhuma versão encontrada
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        {% if versoes %}
                        <div class="table-container">
                            <table class="table" id="dataTable">
                                <thead>
                                    <tr>
                                        <th>Versão</th> 
                                        <th>Nome</th> 
                                        <th>Status</th> 
                                        <th>Data de Criação</th> 
                                        <th>Tópicos</th> 
                                        <th>Perguntas</th> 
                                        <th style="width: 200px;">Ações</th> 
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for versao in versoes %}
                                    <tr>
                                        <td>
                                            <div style="font-weight: 600; color: var(--text-primary);">
                                                <span style="font-size: 18px; color: var(--primary);">V{{ versao.version }}</span> 
                                                {% if versao.is_latest %}
                                                <span class="badge badge-primary" style="margin-left: 8px;">Mais Recente</span> 
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div style="font-weight: 500; color: var(--text-primary);">
                                                {{ versao.nome }}
                                            </div>
                                        </td>
                                        <td>
                                            {% if versao.ativo %}
                                                <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span> 
                                            {% else %}
                                                <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span> 
                                            {% endif %}
                                        </td>
                                        <td>{{ versao.data_cadastro|date:"d/m/Y H:i" }}</td> 
                                        <td>
                                            <span class="badge badge-info">
                                                <i class="fas fa-list"></i> {{ versao.topicos.count }} 
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge badge-secondary">
                                                <i class="fas fa-question-circle"></i>
                                                
                                                {# MODIFICADO: A lógica complexa foi removida e substituída por esta linha simples #}
                                                {{ versao.total_perguntas }}

                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                {% if perms.auditorias.change_checklist%}
                                                <a href="{% url 'auditorias:editar_checklist' versao.pk %}" 
                                                class="btn btn-secondary btn-icon" 
                                                title="Visualizar Versão"> 
                                                    <i class="fas fa-eye"></i> 
                                                </a>
                                                {% endif %}
                                                <a href="{% url 'auditorias:comparar_versoes_checklist' original.pk %}?versoes={{ versao.pk }}" 
                                                class="btn btn-primary btn-icon" 
                                                title="Selecionar para Comparar"> 
                                                    <i class="fas fa-code-branch"></i> 
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div style="text-align: center; padding: 64px 24px; color: var(--text-muted);">
                            <i class="fas fa-history" style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;"></i>
                            <h3 style="margin-bottom: 12px; color: var(--text-secondary);">Nenhuma versão encontrada</h3>
                            <p style="margin-bottom: 24px;">Este checklist ainda não possui versões cadastradas.</p>
                            <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar para a Lista
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

            </div>
        </main>
    </div>

    {% include 'auditorias/partials/_scripts.html' %}

    <style>
    /* Estilos específicos para a página de histórico */
    .content-header {
        margin-bottom: 32px;
    }

    .content-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .content-subtitle {
        font-size: 15px;
        color: var(--text-secondary);
        margin: 0;
    }

    .card {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
        margin-bottom: 24px;
    }

    .card-header {
        padding: 24px;
        border-bottom: 2px solid rgba(37, 99, 235, 0.1);
    }

    .card-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 4px 0;
    }

    .card-subtitle {
        font-size: 14px;
        color: var(--text-secondary);
        margin: 0;
    }

    .card-body {
        padding: 24px;
    }

    .table-container {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        background: rgba(255, 255, 255, 0.9);
    }

    .table thead {
        background: var(--bg-tertiary);
    }

    .table th,
    .table td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border);
    }

    .table th {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .table tbody tr {
        transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
        background: rgba(37, 99, 235, 0.03);
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
    }

    .badge-primary {
        background: rgba(37, 99, 235, 0.1);
        color: var(--primary);
    }

    .badge-success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .badge-error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--error);
    }

    .badge-info {
        background: rgba(14, 165, 233, 0.1);
        color: #0ea5e9;
    }

    .badge-secondary {
        background: rgba(100, 116, 139, 0.1);
        color: var(--text-secondary);
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .btn-icon {
        padding: 10px;
        width: 40px;
        height: 40px;
        justify-content: center;
    }

    .btn-icon i {
        margin: 0;
    }

    @media (max-width: 768px) {
        .content-header > div {
            flex-direction: column;
            gap: 16px;
            align-items: flex-start !important;
        }

        .action-buttons {
            flex-direction: column;
        }

        .table {
            font-size: 13px;
        }

        .table th,
        .table td {
            padding: 12px;
        }
    }
    </style>

    <script>
    // Script para animações e interações
    document.addEventListener('DOMContentLoaded', function() {
        // Adicionar animação de fade-in nas linhas da tabela
        const tableRows = document.querySelectorAll('.table tbody tr');
        tableRows.forEach((row, index) => {
            row.style.opacity = '0';
            row.style.transform = 'translateY(10px)';
            setTimeout(() => {
                row.style.transition = 'all 0.3s ease';
                row.style.opacity = '1';
                row.style.transform = 'translateY(0)';
            }, index * 50);
        });
    });
    </script>
</body>
</html>

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\checklists\lista.html

{% extends 'auditorias/lista_generica.html' %}

{# Remove o formulário de busca padrão do topo #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros estão no cabeçalho #}
{% block extra_filters %}{% endblock %}

{# Adiciona a linha de filtros no cabeçalho da tabela #}
{% block table_headers %}
    <tr>
        <th>Nome do Checklist</th>
        <th>Versão</th>
        <th>Ferramenta</th>
        <th>Status</th>
        <th style="width: 140px;">Ações</th> {# Aumentei um pouco a largura para caber os 3 botões #}
    </tr>
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar por nome..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar por versão..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar por ferramenta..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar por status..." data-column-index="3"></th>
        <th></th> {# Coluna de Ações sem filtro #}
    </tr>
{% endblock %}

{# O conteúdo da linha da tabela com o novo botão #}
{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td><span class="badge badge-secondary">V{{ object.version }}</span></td>
    <td>{{ object.ferramenta.nome|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">

            {% if perms.auditorias.change_checklist %}
            <a href="{% url 'auditorias:editar_checklist' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Checklist">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}
            
            {# --- BOTÃO DE HISTÓRICO ADICIONADO AQUI --- #}
            <a href="{% url 'auditorias:historico_versoes_checklist' object.pk %}" class="btn btn-secondary btn-icon" title="Histórico de Versões">
                <i class="fas fa-history"></i>
            </a>

            {% if perms.auditorias.delete_checklist %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Checklist"
                    onclick="confirmDelete('{% url 'auditorias:deletar_checklist' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}

{# Adiciona o CSS para a linha de filtro #}
{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
            width: 100%;
        }
    </style>
{% endblock %}

{# Adiciona o JavaScript para a funcionalidade de filtro em tempo real #}
{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) {
            return;
        }
        const tableBody = table.querySelector('tbody');
        if (!tableBody) {
            return;
        }
        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) {
                return;
            }
            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);
                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
                                isRowVisible = false;
                            }
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }
        if (filters.length > 0) {
            filters.forEach(filter => {
                filter.addEventListener('input', applyTableFilters);
            });
        }
    });
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\ferramentas_digitais\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome da Ferramenta</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ ferramenta.nome|default:'' }}" required maxlength="100">
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\ferramentas_digitais\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome da Ferramenta</th>
    <!-- A coluna de Ações foi removida -->
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <!-- A célula de Ações foi removida -->
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\modelos_auditoria\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição do Modelo</label>
        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ modelo.descricao|default:'' }}" required maxlength="255">
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <label for="checklist" class="form-label">Checklist</label>
        <select id="checklist" name="checklist" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for c in checklists %}
            <option value="{{ c.pk }}" {% if modelo.checklist.pk == c.pk %}selected{% endif %}>{{ c.nome }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="categoria" class="form-label">Categoria</label>
        <select id="categoria" name="categoria" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for cat in categorias %}
            <option value="{{ cat.pk }}" {% if modelo.categoria.pk == cat.pk %}selected{% endif %}>{{ cat.descricao }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label for="ferramenta_causa_raiz" class="form-label">Ferramenta para Causa Raiz</label>
        <select id="ferramenta_causa_raiz" name="ferramenta_causa_raiz" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for f in ferramentas_causa_raiz %}
            <option value="{{ f.pk }}" {% if modelo.ferramenta_causa_raiz.pk == f.pk %}selected{% endif %}>{{ f.nome }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if modelo.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">Modelo ativo</span>
        </div>
    </div>
    <div class="form-group">
        <label class="form-label">Iniciar por QR Code</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="iniciar_por_codigo_qr" {% if modelo.iniciar_por_codigo_qr %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">Permitir iniciar via QR Code</span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\modelos_auditoria\lista.html

{% extends 'auditorias/lista_generica.html' %}

{# Remove o formulário de busca genérico herdado do template pai #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros agora estão no cabeçalho da tabela #}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    {# Linha 1: Títulos das Colunas #}
    <tr>
        <th>Descrição do Modelo</th>
        <th>Checklist Associado</th>
        <th>Categoria</th>
        <th>Status</th>
        <th style="width: 120px;">Ações</th>
    </tr>
    {# Linha 2: Campos de Filtro #}
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th></th> {# Coluna de Ações sem filtro #}
    </tr>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.descricao }}
        </div>
    </td>
    <td>{{ object.checklist.nome|default:"—" }}</td>
    <td>{{ object.categoria.descricao|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.auditorias.change_modeloauditoria %}
            <a href="{% url 'auditorias:editar_modelo_auditoria' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Modelo">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}
            {% if perms.auditorias.delete_modeloauditoria %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Modelo"
                    onclick="confirmDelete('{% url 'auditorias:deletar_modelo_auditoria' object.pk %}', '{{ object.descricao }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) {
            return;
        }
        const tableBody = table.querySelector('tbody');
        if (!tableBody) {
            return;
        }

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) {
                return;
            }

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);

                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
                                isRowVisible = false;
                            }
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }

        if (filters.length > 0) {
            filters.forEach(filter => {
                filter.addEventListener('input', applyTableFilters);
            });
        }
    });
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\normas\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row">
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição da Norma</label>
        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ norma.descricao|default:'' }}" required maxlength="255" placeholder="Ex: ISO 9001, NBR 14001">
        <div class="field-help">Nome completo da norma ou padrão</div>
    </div>
    <div class="form-group required">
        <label for="revisao" class="form-label">Revisão</label>
        <input type="text" id="revisao" name="revisao" class="form-control" value="{{ norma.revisao|default:'' }}" required maxlength="100" placeholder="Ex: 2015, Rev. 3.0">
        <div class="field-help">Versão ou revisão da norma</div>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if norma.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">Norma ativa no sistema</span>
        </div>
        <div class="field-help">Normas inativas não aparecerão nas listagens de seleção</div>
    </div>
</div>
{% endblock %}

{% block help_content %}
<div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
    <p><strong>Sobre Normas:</strong></p>
    <ul style="margin: 12px 0; padding-left: 20px;">
        <li>Normas são padrões técnicos ou regulamentações</li>
        <li>Cada norma pode ter múltiplos requisitos associados</li>
        <li>A combinação descrição + revisão deve ser única</li>
        <li>Use descrições claras e revisões precisas</li>
    </ul>
    
    <p><strong>Exemplos de Normas:</strong></p>
    <ul style="margin: 12px 0; padding-left: 20px;">
        <li>ISO 9001 - Sistemas de gestão da qualidade</li>
        <li>ISO 14001 - Sistemas de gestão ambiental</li>
        <li>OHSAS 18001 - Segurança e saúde ocupacional</li>
        <li>NBR 5410 - Instalações elétricas</li>
        <li>NR-12 - Segurança no trabalho em máquinas</li>
    </ul>
</div>
{% endblock %}

{% block quick_actions %}
<button type="button" onclick="previewForm()" class="btn btn-secondary btn-sm">
    <i class="fas fa-eye"></i>
    Visualizar
</button>
<button type="button" onclick="resetForm()" class="btn btn-secondary btn-sm">
    <i class="fas fa-undo"></i>
    Resetar
</button>
<button type="button" onclick="generateNormaSuggestions()" class="btn btn-secondary btn-sm">
    <i class="fas fa-lightbulb"></i>
    Sugestões
</button>
<button type="button" onclick="validateNorma()" class="btn btn-secondary btn-sm">
    <i class="fas fa-check"></i>
    Verificar Norma
</button>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Validação específica para normas
    document.addEventListener('DOMContentLoaded', function() {
        const descricaoField = document.getElementById('descricao');
        const revisaoField = document.getElementById('revisao');
        
        // Validação em tempo real da descrição
        descricaoField.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length > 0 && value.length < 3) {
                showFieldError(this, 'Descrição deve ter pelo menos 3 caracteres');
            } else if (value.length > 255) {
                showFieldError(this, 'Descrição não pode ter mais de 255 caracteres');
            }
        });
        
        // Validação em tempo real da revisão
        revisaoField.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length > 100) {
                showFieldError(this, 'Revisão não pode ter mais de 100 caracteres');
            }
        });
        
        // Auto-formatação da descrição
        descricaoField.addEventListener('blur', function() {
            let value = this.value.trim();
            if (value) {
                // Capitaliza apenas a primeira letra
                this.value = value.charAt(0).toUpperCase() + value.slice(1);
            }
        });
    });

    // Função para gerar sugestões de normas
    function generateNormaSuggestions() {
        const suggestions = [
            { descricao: 'ISO 9001', revisao: '2015' },
            { descricao: 'ISO 14001', revisao: '2015' },
            { descricao: 'ISO 45001', revisao: '2018' },
            { descricao: 'OHSAS 18001', revisao: '2007' },
            { descricao: 'NBR 5410', revisao: '2004' },
            { descricao: 'NR-12', revisao: '2019' },
            { descricao: 'NR-10', revisao: '2019' },
            { descricao: 'ISO 27001', revisao: '2013' },
            { descricao: 'ISO 22000', revisao: '2018' },
            { descricao: 'IATF 16949', revisao: '2016' }
        ];
        
        let suggestionsHtml = '<div style="margin-bottom: 16px;"><strong>Sugestões de Normas:</strong></div>';
        suggestionsHtml += '<div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">';
        
        suggestions.forEach(suggestion => {
            suggestionsHtml += `
                <button type="button" 
                        onclick="applyNormaSuggestion('${suggestion.descricao}', '${suggestion.revisao}')" 
                        class="btn btn-secondary btn-sm"
                        style="justify-content: flex-start; text-align: left;">
                    <strong>${suggestion.descricao}</strong> - Rev. ${suggestion.revisao}
                </button>
            `;
        });
        
        suggestionsHtml += '</div>';
        
        document.getElementById('previewContent').innerHTML = suggestionsHtml;
        document.getElementById('previewModal').style.display = 'flex';
    }

    // Aplicar sugestão de norma
    function applyNormaSuggestion(descricao, revisao) {
        document.getElementById('descricao').value = descricao;
        document.getElementById('revisao').value = revisao;
        
        closePreviewModal();
        
        // Trigger validation
        document.getElementById('descricao').dispatchEvent(new Event('input'));
        document.getElementById('revisao').dispatchEvent(new Event('input'));
    }

    // Validar norma
    function validateNorma() {
        const descricao = document.getElementById('descricao').value.trim();
        const revisao = document.getElementById('revisao').value.trim();
        
        if (!descricao) {
            alert('Digite uma descrição para validar');
            return;
        }
        
        if (!revisao) {
            alert('Digite uma revisão para validar');
            return;
        }
        
        // Simular validação via AJAX
        setButtonLoading('submitBtn', true);
        
        setTimeout(() => {
            setButtonLoading('submitBtn', false);
            
            // Simular resultado da validação
            const isUnique = Math.random() > 0.2; // 80% chance de ser único
            
            if (isUnique) {
                showFieldSuccess(document.getElementById('descricao'), 'Combinação norma + revisão disponível');
                showFieldSuccess(document.getElementById('revisao'), 'Revisão válida');
            } else {
                showFieldError(document.getElementById('descricao'), 'Esta combinação de norma e revisão já existe');
            }
        }, 1000);
    }

    // Mostrar sucesso no campo
    function showFieldSuccess(field, message) {
        field.classList.add('success');
        field.classList.remove('error');
        
        // Remover mensagem anterior
        const existingMessage = field.parentNode.querySelector('.field-error, .field-success');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // Adicionar mensagem de sucesso
        const successElement = document.createElement('div');
        successElement.className = 'field-success';
        successElement.style.color = 'var(--success)';
        successElement.style.fontSize = '12px';
        successElement.style.marginTop = '4px';
        successElement.style.display = 'flex';
        successElement.style.alignItems = 'center';
        successElement.style.gap = '4px';
        successElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        field.parentNode.appendChild(successElement);
        
        // Remover após 3 segundos
        setTimeout(() => {
            if (successElement.parentNode) {
                successElement.remove();
            }
        }, 3000);
    }

    // Validação customizada do formulário
    function validateForm() {
        const descricao = document.getElementById('descricao').value.trim();
        const revisao = document.getElementById('revisao').value.trim();
        let isValid = true;
        
        if (!descricao) {
            showFieldError(document.getElementById('descricao'), 'Descrição é obrigatória');
            isValid = false;
        } else if (descricao.length < 3) {
            showFieldError(document.getElementById('descricao'), 'Descrição deve ter pelo menos 3 caracteres');
            isValid = false;
        }
        
        if (!revisao) {
            showFieldError(document.getElementById('revisao'), 'Revisão é obrigatória');
            isValid = false;
        }
        
        return isValid;
    }

    // Atalhos específicos para normas
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + G para gerar sugestões
        if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
            e.preventDefault();
            generateNormaSuggestions();
        }
        
        // Ctrl/Cmd + T para validar norma
        if ((e.ctrlKey || e.metaKey) && e.key === 't') {
            e.preventDefault();
            validateNorma();
        }
    });
</script>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\normas\lista.html

{% extends 'auditorias/lista_generica.html' %}

{# Remove o formulário de busca genérico herdado do template pai #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros agora estão no cabeçalho da tabela #}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    {# Linha 1: Títulos das Colunas #}
    <tr>
        <th>Descrição da Norma</th>
        <th>Revisão</th>
        <th>Status</th>
        <th style="width: 120px;">Ações</th>
    </tr>
    {# Linha 2: Campos de Filtro #}
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th></th> {# Coluna de Ações sem filtro #}
    </tr>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.descricao }}
        </div>
    </td>
    <td>{{ object.revisao }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span> 
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.auditorias.change_norma%}
            <a href="{% url 'auditorias:editar_norma' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Norma">
                <i class="fas fa-edit"></i> 
            </a>
            {% endif %}
            
            {% if perms.auditorias.delete_norma%}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Norma"
                    onclick="confirmDelete('{% url 'auditorias:deletar_norma' object.pk %}', '{{ object.descricao }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td> 
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) {
            return;
        }
        const tableBody = table.querySelector('tbody');
        if (!tableBody) {
            return;
        }

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) {
                return;
            }

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);

                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
                                isRowVisible = false;
                            }
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }

        if (filters.length > 0) {
            filters.forEach(filter => {
                filter.addEventListener('input', applyTableFilters);
            });
        }
    });
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\partials\pagination.html

{% if page_obj.has_other_pages %}
<nav aria-label="Navegação das páginas" class="d-flex justify-content-between align-items-center mt-4">
    <span class="text-muted" style="font-size: 0.9rem;">
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
    </span>

    <ul class="pagination mb-0">
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1&{{ request.GET.urlencode|rem_page_param }}" aria-label="Primeira">
                    &laquo;&laquo;
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|rem_page_param }}" aria-label="Anterior">
                    &laquo;
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo;&laquo;</span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">&laquo;</span>
            </li>
        {% endif %}

        {% for i in page_obj.paginator.get_elided_page_range %}
            {% if i == page_obj.paginator.ELLIPSIS %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% else %}
                <li class="page-item {% if page_obj.number == i %}active{% endif %}">
                    <a class="page-link" href="?page={{ i }}&{{ request.GET.urlencode|rem_page_param }}">{{ i }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|rem_page_param }}" aria-label="Próxima">
                    &raquo;
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode|rem_page_param }}" aria-label="Última">
                    &raquo;&raquo;
                </a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
            </li>
            <li class="page-item disabled">
                <span class="page-link">&raquo;&raquo;</span>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\partials\_head.html

{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Sistema de Auditorias{% endblock %}</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #f8fafc;
            --accent: #059669;
            --error: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-focus: #93c5fd;
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #f8fafc;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-dark) 0%, var(--primary) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
        }

        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar-header {
            padding: 20px 28px 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            background: var(--primary-dark);
            z-index: 10;
        }
        
        .sidebar-header-top {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .sidebar.collapsed .sidebar-header-top {
            margin-bottom: 0;
        }
        
        .sidebar.collapsed .sidebar-search-container {
            display: none;
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .sidebar-title {
            opacity: 0;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: background 0.2s ease;
            margin-left: auto;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav {
            flex: 1;
            overflow-y: scroll;
            padding: 12px 0;
        }

        .nav-section {
            margin-bottom: 32px;
        }

        .nav-section-title {
            padding: 0 20px 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-right: 3px solid white;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .nav-item-text {
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-item-text {
            opacity: 0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            transition: margin-left 0.3s ease;
            background: var(--bg-secondary);
        }

        .sidebar.collapsed + .main-content {
            margin-left: 80px;
        }

        /* Header */
        .main-header {
            background: var(--bg-primary);
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-menu:hover {
            background: var(--bg-secondary);
            transform: translateY(-1px);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-role {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Content Area */
        .content-area {
            padding: 32px;
        }

        .content-header {
            margin-bottom: 32px;
        }

        .content-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .content-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 24px 24px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .card-body {
            padding: 0 24px 24px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%);
            color: white;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 16px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Tables */
        .table-container {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            overflow-x: auto; /* MODIFICADO: permite rolagem horizontal se necessário */
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* ADICIONADO: Força a tabela a respeitar a largura definida */
        }

        .table th {
            background: var(--bg-tertiary);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 14px;
            word-break: break-word; /* ADICIONADO: Quebra palavras longas para evitar expansão */
        }

        .table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        /* Alerts */
        .alert {
            padding: 16px 20px;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: #065f46;
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            border-color: var(--error);
            color: #991b1b;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
            color: #92400e;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 32px;
        }

        .pagination a,
        .pagination span {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            text-decoration: none;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .pagination a:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .pagination .current {
            background: var(--primary);
            color: white;
        }

        /* Search */
        .search-container {
            position: relative;
        }

        .search-input {
            padding-left: 48px;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236b7280'%3e%3cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m21 21-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3e%3c/svg%3e");
            background-position: 16px center;
            background-repeat: no-repeat;
            background-size: 20px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .badge-error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--error);
        }

        .badge-info {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }
        
        .badge-secondary {
            background-color: #e2e8f0;
            color: #475569;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .content-area {
                padding: 20px;
            }

            .main-header {
                padding: 16px 20px;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px; /* MODIFICADO: Adicionado altura para scroll horizontal */
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* MODIFICADO */
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* MODIFICADO */
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* MODIFICADO */
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary);
        }

        input:focus + .toggle-slider {
            box-shadow: 0 0 1px var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Form Rows */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .field-help {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .form-row,
            .form-row.triple {
                grid-template-columns: 1fr;
            }
        }    
    </style>

    {% block extra_css %}
    <style>
        .sidebar-search-container {
            position: relative;
        }
        .sidebar-search-container .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }
        #sidebarSearch {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.2);
            color: white;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        #sidebarSearch::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        #sidebarSearch:focus {
            outline: none;
            background-color: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 0;
            border: 1px solid #888; width: 80%; max-width: 500px;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-xl);
            animation: slide-down 0.3s ease-out;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 18px; margin: 0; }
        .modal-body { padding: 24px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border); }
        .close-btn { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: black; }
        @keyframes slide-down { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- NOVOS ESTILOS PARA O CHAT PANEL --- */
        .chat-panel-overlay {
            display: none; /* Oculto por padrão */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001; /* Mesmo z-index dos modais */
            opacity: 0;
            transition: opacity 0.3s ease-out;
        }
        .chat-panel-overlay.visible {
            display: block;
            opacity: 1;
        }
        
        .chat-panel {
            position: fixed;
            top: 0;
            right: -450px; /* Começa fora da tela */
            width: 100%;
            max-width: 450px;
            height: 100%;
            background: #ffffff;
            z-index: 1002; /* Acima do overlay */
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 25px rgba(0,0,0,0.2);
            transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .chat-panel.visible {
            right: 0; /* Desliza para dentro */
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--bg-secondary, #f1f5f9);
            border-bottom: 1px solid var(--border, #e2e8f0);
        }
        .chat-header h2 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            color: var(--text-primary);
        }
        .chat-header .close-btn {
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
        }
        
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8fafc;
        }
        
        .chat-footer {
            padding: 16px;
            background: var(--bg-secondary, #f1f5f9);
            border-top: 1px solid var(--border, #e2e8f0);
            display: flex;
            gap: 12px;
        }
        
        .chat-footer .form-control {
            flex: 1;
            margin: 0;
        }
        /* Container da mensagem */
        .msg-container {
        position: relative;
        transition: all 0.2s;
        /* Garante que o container se ajuste bem */
        min-height: 40px; 
    }

    /* Ações (Menu Lápis/Lixeira) */
    .msg-actions {
        position: absolute;
        top: -8px;
        right: -4px; /* Posiciona um pouco para fora para não cobrir texto */
        display: none; 
        gap: 4px;
        background: #ffffff;
        padding: 3px 6px;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 20;
    }

    .msg-container:hover .msg-actions {
        display: flex;
        animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .msg-btn {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: none;
        background: transparent;
        color: #64748b; /* Slate-500 */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 11px; /* Ícone menor */
        transition: all 0.2s;
    }

    .msg-btn:hover { background-color: #f1f5f9; color: #2563eb; transform: scale(1.1); }
    .msg-btn.delete:hover { background-color: #fee2e2; color: #dc2626; }

    /* --- ÁREA DE EDIÇÃO (Input + Botões) --- */
    
    .msg-edit-wrapper {
        margin-top: 2px;
        width: 100%;
        position: relative;
    }

    .msg-edit-input {
        width: 100%;
        padding: 8px 10px;
        /* Dá espaço na direita para os botões ficarem SOBRE o input ou abaixo */
        padding-bottom: 36px; 
        border: none;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.4;
        resize: none;
        font-family: inherit;
        color: #1e293b;
        background-color: #ffffff;
        outline: none;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        display: block;
        min-height: 60px; /* Altura mínima para caber os botões */
    }

    /* Container dos botões de ação DENTRO da área de edição */
    .msg-edit-actions {
        position: absolute;
        bottom: 6px;
        right: 6px;
        display: flex;
        gap: 6px;
    }

    /* Botões de Ação da Edição (Apenas Ícones ou Pequenos) */
    .btn-edit-action {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* Salvar (Verde) */
    .btn-save-edit {
        background-color: #22c55e; /* Green-500 */
        color: white;
    }
    .btn-save-edit:hover { background-color: #16a34a; transform: translateY(-1px); }

    /* Cancelar (Cinza) */
    .btn-cancel-edit {
        background-color: #e2e8f0; /* Slate-200 */
        color: #64748b;
    }
    .btn-cancel-edit:hover { background-color: #cbd5e1; color: #475569; }

    @keyframes popIn {
        from { opacity: 0; transform: scale(0.8) translateY(5px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    </style>
    {% endblock %}
</head>
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\partials\_header.html

<!-- auditorias/templates/auditorias/partials/_header.html -->

<header class="main-header">
    <div class="header-content">
        <h1 class="page-title">{% block page_title %}{% endblock %}</h1> 
        
        <div class="header-actions">
            <div class="user-menu">
                <div class="user-avatar"> 
                    {{ user.first_name.0|default:user.username.0|upper }} 
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.get_full_name|default:user.username }}</div> 
                    
                    <!-- ========================================================== -->
                    <!-- INÍCIO DA LÓGICA CORRIGIDA -->
                    <!-- ========================================================== -->
                    <div class="user-role">
                        {% if user.is_superuser %}
                            Superusuário
                        {% elif user.groups.all %}
                            {{ user.groups.first.name }}
                        {% else %}
                            Usuário
                        {% endif %}
                    </div>
                    <!-- ========================================================== -->
                    <!-- FIM DA LÓGICA CORRIGIDA -->
                    <!-- ========================================================== -->

                </div> 
            </div> 
        </div>
    </div>
</header>
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\partials\_messages.html

{% if messages %}
    {% for message in messages %} 
    <div class="alert alert-{{ message.tags }}">
        <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
        {{ message }} 
    </div>
    {% endfor %}
{% endif %} 
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\partials\_scripts.html

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
    
    // ===============================================
    // FUNÇÕES GLOBAIS (Válidas para todas as páginas)
    // ===============================================

    // Função para confirmar exclusão
    function confirmDelete(url, itemName) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        
        const form = modal.querySelector('#deleteForm');
        const nameSpan = modal.querySelector('#deleteItemName');
        
        form.action = url;
        nameSpan.textContent = `"${itemName}"`;
        modal.style.display = 'flex';
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        if (modal) modal.style.display = 'none';
    }
    
    // Função para abrir o modal de redirecionamento
    function openRedirectModal(formUrl, currentResponsavelId, allUsers) {
        const modal = document.getElementById('redirectModal');
        const form = document.getElementById('redirectForm');
        const select = document.getElementById('responsavel_select');

        if (!modal || !form || !select) {
            console.error('Elementos do modal de redirecionamento não encontrados!');
            return;
        }

        form.action = formUrl;

        select.innerHTML = '<option value="">Selecione um auditor...</option>';
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name.trim() ? user.name : `(Usuário ${user.id})`;
            if (user.id == currentResponsavelId) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        modal.style.display = 'flex';
    }

    function closeRedirectModal() {
        const modal = document.getElementById('redirectModal');
        if (modal) modal.style.display = 'none';
    }

    // Função para exportar dados (ATUALIZADA)
    function exportarDados() {
        const currentPath = window.location.pathname;
        const searchParams = window.location.search;
        let exportUrl = '';
        
        // Detectar qual listagem está sendo exibida e definir a URL de exportação
        if (currentPath.includes('/usuarios/')) {
            exportUrl = '/usuarios/exportar-csv/' + searchParams;
        } else {
            alert('Exportação não disponível para esta página');
            return;
        }
        
        // Criar elemento de link temporário e clicar nele para iniciar o download
        const link = document.createElement('a');
        link.href = exportUrl;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Função para imprimir tabela (ATUALIZADA)
    function imprimirTabela() {
        const dataTable = document.getElementById('dataTable') || document.getElementById('usuariosTable');
        
        if (!dataTable) {
            alert('Tabela não encontrada para impressão');
            return;
        }
        
        const printContent = dataTable.outerHTML;
        const printWindow = window.open('', '_blank');
        
        const title = document.querySelector('.content-title')?.textContent || 'Relatório';
        
        printWindow.document.write(`
            <html>
                <head>
                    <title>${title} - Impressão</title>
                    <style>
                        /* Estilos para o modo de edição dentro do chat */
                        .msg-edit-wrapper {
                            margin-top: 8px;
                            width: 100%;
                        }
                        .msg-edit-input {
                            width: 100%;
                            padding: 8px;
                            border: 1px solid var(--primary);
                            border-radius: 6px;
                            font-size: 13px;
                            resize: none;
                            font-family: inherit;
                            color: #333; /* Força cor escura */
                        }
                        .msg-edit-actions {
                            display: flex;
                            justify-content: flex-end;
                            gap: 6px;
                            margin-top: 6px;
                        }
                        .btn-xs {
                            padding: 4px 8px;
                            font-size: 11px;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            display: inline-flex;
                            align-items: center;
                            gap: 4px;
                        }
                        .btn-save-edit { background-color: var(--success); color: white; }
                        .btn-cancel-edit { background-color: #64748b; color: white; }
                        @media print {
                            @page { margin: 1cm; }
                        }
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 20px;
                        }
                        h1 {
                            text-align: center;
                            color: #2563eb;
                            margin-bottom: 20px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 12px 8px; 
                            text-align: left;
                            font-size: 12px;
                        }
                        th { 
                            background-color: #f8fafc;
                            font-weight: bold;
                            color: #0f172a;
                        }
                        tr:nth-child(even) {
                            background-color: #f9fafb;
                        }
                        .btn, .action-buttons { 
                            display: none !important; 
                        }
                        .badge {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 11px;
                            font-weight: bold;
                        }
                        .badge-success {
                            background-color: #d1fae5;
                            color: #065f46;
                        }
                        .badge-error {
                            background-color: #fee2e2;
                            color: #991b1b;
                        }
                        .print-header {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 20px;
                            padding-bottom: 10px;
                            border-bottom: 2px solid #2563eb;
                        }
                        .print-date {
                            color: #64748b;
                            font-size: 12px;
                        }
                        .msg-actions {
                            position: absolute;
                            top: 5px;
                            right: 5px;
                            display: none; /* Esconde por padrão */
                            gap: 5px;
                            background: rgba(255,255,255,0.9);
                            padding: 2px 5px;
                            border-radius: 4px;
                            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                        }
                        /* Mostra os botões quando passa o mouse sobre a mensagem */
                        .msg-container:hover .msg-actions {
                            display: flex;
                        }
                        .msg-btn {
                            cursor: pointer;
                            font-size: 10px;
                            padding: 2px 4px;
                            color: #64748b;
                            border: none;
                            background: transparent;
                        }
                        .msg-btn:hover { color: #0f172a; transform: scale(1.1); }
                        .msg-btn.delete:hover { color: #dc2626; }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>${title}</h1>
                        <div class="print-date">
                            Impresso em: ${new Date().toLocaleString('pt-BR')}
                        </div>
                    </div>
                    ${printContent}
                </body>
            </html>
        `);
        
        printWindow.document.close();
        
        // Aguardar o carregamento antes de imprimir
        printWindow.onload = function() {
            printWindow.focus();
            printWindow.print();
        };
    }

    // Funções de UI (sidebar, alertas, etc)
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    }

    window.isEditing = false; 

    document.addEventListener('DOMContentLoaded', function() {
        const chatPanel = document.getElementById('chatPanel');
        const chatOverlay = document.getElementById('chatOverlay');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatMessageInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        
        let currentForumId = null;
        let chatInterval = null;

        // 1. Rolar para o final
        function scrollChatToBottom() {
            if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 2. Carregar Mensagens
        window.loadMessages = function() {
            // TRAVA DE SEGURANÇA: Se estiver editando, PARE AQUI.
            if (!currentForumId || window.isEditing) return; 

            fetch(`/planos_de_acao/api/forum/${currentForumId}/mensagens/`)
                .then(r => r.json())
                .then(data => {
                    const mensagens = data.mensagens;
                    
                    if (mensagens.length === 0) {
                        chatMessages.innerHTML = `<p style="color: var(--text-muted); text-align: center; margin-top: 20px;">Nenhuma mensagem ainda.</p>`;
                        return;
                    }

                    let html = '';
                    mensagens.forEach(msg => {
                        // Define estilos baseados se a mensagem é minha ou de outro
                        const isMe = msg.is_me;
                        // Minhas mensagens: Fundo Azul (primary-light), Texto Branco
                        // Outras mensagens: Fundo Cinza, Texto Escuro
                        const alignStyle = isMe ? 
                            'margin-left: auto; background: var(--primary-light); color: white; border-radius: 12px 12px 0 12px;' : 
                            'margin-right: auto; background: #e2e8f0; color: var(--text-primary); border-radius: 12px 12px 12px 0;';
                        
                        const metaAlign = isMe ? 'text-align: right;' : 'text-align: left;';
                        // Ajuste sutil na cor do autor/data para garantir contraste
                        const metaColor = isMe ? 'rgba(255,255,255,0.8)' : 'var(--text-secondary)';

                        let actionsHtml = '';
                        if (msg.can_edit) {
                            const safeContent = msg.conteudo.replace(/"/g, '&quot;').replace(/'/g, "\\'");
                            actionsHtml = `
                                <div class="msg-actions">
                                    <button class="msg-btn" onclick="ativarEdicaoInline(${msg.id}, this)" title="Editar">
                                        <i class="fas fa-pencil-alt"></i>
                                    </button>
                                    <button class="msg-btn delete" onclick="deleteMessage(${msg.id})" title="Apagar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        }

                        const editedLabel = msg.editado ? '<span style="font-size: 9px; font-style: italic; opacity: 0.8; margin-left: 4px;">(Editada)</span>' : '';

                        html += `
                            <div class="msg-container" id="msg-container-${msg.id}" style="display: flex; flex-direction: column; margin-bottom: 12px; max-width: 85%; ${alignStyle} padding: 12px; position: relative; min-width: 140px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                ${actionsHtml}
                                <div style="font-size: 11px; font-weight: 700; margin-bottom: 4px; color: ${metaColor}; ${metaAlign}">
                                    ${msg.autor}
                                </div>
                                <div id="msg-content-${msg.id}" style="font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${msg.conteudo}</div>
                                <div style="font-size: 10px; margin-top: 4px; color: ${metaColor}; text-align: right;">
                                    ${editedLabel} ${msg.data_envio} </div>
                            </div>
                        `;
                    });

                    chatMessages.innerHTML = html;
                })
                .catch(console.error);
        }

        // 3. Abrir Chat
        window.openChat = function(forumId) {
            currentForumId = forumId;
            window.isEditing = false; // Garante que começa falso
            
            if (chatInput) {
                chatInput.value = '';
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
            }
            
            if (chatPanel) chatPanel.classList.add('visible');
            if (chatOverlay) chatOverlay.classList.add('visible');

            loadMessages();
            if (chatInterval) clearInterval(chatInterval);
            chatInterval = setInterval(loadMessages, 3000); // Atualiza a cada 3s
            setTimeout(() => { if(chatInput) chatInput.focus(); }, 300);
        }

        // 4. Fechar Chat
        window.closeChat = function() {
            if (chatPanel) chatPanel.classList.remove('visible');
            if (chatOverlay) chatOverlay.classList.remove('visible');
            currentForumId = null;
            window.isEditing = false; // Destrava
            if (chatInterval) clearInterval(chatInterval);
        }

        // 5. Enviar Mensagem
        function sendChatMessage() {
            const message = chatInput.value;
            if (!message.trim() || !currentForumId) return;

            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(`/planos_de_acao/api/forum/${currentForumId}/enviar/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ conteudo: message })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    chatInput.value = '';
                    loadMessages(); 
                    setTimeout(scrollChatToBottom, 100);
                } else {
                    alert('Erro: ' + (data.error || 'Desconhecido'));
                }
            })
            .finally(() => {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatInput.focus();
            });
        }

        if (chatSendBtn) chatSendBtn.addEventListener('click', sendChatMessage);
        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') sendChatMessage();
            });
        }
    });

    // ===============================================
    // FUNÇÕES DE AÇÃO EXTERNAS
    // ===============================================

    // A. Ativar Edição
    window.ativarEdicaoInline = function(msgId, btnElement) {
        // 1. Pausa o refresh automático
        window.isEditing = true; 

        const container = document.getElementById(`msg-container-${msgId}`);
        if(!container) return;

        // Esconde menu de ações
        const actionsDiv = container.querySelector('.msg-actions');
        if(actionsDiv) actionsDiv.style.display = 'none';

        const contentDiv = document.getElementById(`msg-content-${msgId}`);
        const currentText = contentDiv.innerText;

        // INJETA O HTML DE EDIÇÃO COMPACTO
        contentDiv.innerHTML = `
            <div class="msg-edit-wrapper">
                <textarea id="edit-input-${msgId}" class="msg-edit-input" rows="1">${currentText}</textarea>
                <div class="msg-edit-actions">
                    <button class="btn-edit-action btn-cancel-edit" onclick="cancelarEdicao()">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="btn-edit-action btn-save-edit" onclick="salvarEdicao(${msgId})">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        `;
        
        // Auto-resize do textarea
        const textarea = document.getElementById(`edit-input-${msgId}`);
        const autoResize = () => {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        };
        textarea.addEventListener('input', autoResize);
        
        setTimeout(() => {
            autoResize(); 
            textarea.focus();
            // Coloca o cursor no final
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }, 50);

        // Atalhos
        textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault(); 
                salvarEdicao(msgId);
            }
            if (e.key === 'Escape') {
                cancelarEdicao();
            }
        });
    }

    // B. Salvar
    window.salvarEdicao = function(msgId) {
        const input = document.getElementById(`edit-input-${msgId}`);
        
        // AQUI ESTÁ A CORREÇÃO DOS ENTERS:
        // .trim() remove espaços e quebras de linha inúteis no início e no fim
        const novoConteudo = input.value.trim(); 

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        if (!novoConteudo) {
            alert("A mensagem não pode ficar vazia."); // Opcional: pode usar um toast aqui também
            return;
        }

        fetch(`/planos_de_acao/api/mensagem/${msgId}/editar/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ conteudo: novoConteudo })
        })
        .then(r => r.json())
        .then(data => {
            if(data.success) {
                window.isEditing = false; // Libera o refresh
                if(window.loadMessages) window.loadMessages(); 
            } else {
                alert(data.error || 'Erro ao editar.');
            }
        });
    }

    // C. Cancelar
    window.cancelarEdicao = function() {
        window.isEditing = false; // Libera o refresh
        if(window.loadMessages) window.loadMessages();
    }

    // D. Deletar
    window.deleteMessage = function(msgId) {
        const modal = document.getElementById('chatDeleteModal');
        const confirmBtn = document.getElementById('btnConfirmDelete');
        
        // Pausa atualização automática enquanto o modal está aberto
        window.isEditing = true; 

        // Exibe o modal
        modal.style.display = 'flex';

        // Define o que acontece ao clicar em "Sim, Excluir"
        // Usamos .onclick direto para substituir qualquer evento anterior e evitar múltiplas chamadas
        confirmBtn.onclick = function() {
            // Desabilita o botão para evitar clique duplo
            confirmBtn.disabled = true;
            confirmBtn.innerText = "Excluindo...";

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`/planos_de_acao/api/mensagem/${msgId}/deletar/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(r => r.json())
            .then(data => {
                if(data.success) {
                    closeChatModal();
                    if(window.loadMessages) window.loadMessages();
                } else {
                    alert(data.error);
                    closeChatModal();
                }
            })
            .catch(() => {
                alert("Erro de conexão.");
                closeChatModal();
            })
            .finally(() => {
                // Reseta o botão para o próximo uso
                confirmBtn.disabled = false;
                confirmBtn.innerText = "Sim, Excluir";
            });
        };
    }

    // Função auxiliar para fechar o modal
    window.closeChatModal = function() {
        const modal = document.getElementById('chatDeleteModal');
        if(modal) modal.style.display = 'none';
        window.isEditing = false; // Libera o refresh do chat
    }
    
    // Fecha modal ao clicar fora (opcional, mas boa prática)
    document.getElementById('chatDeleteModal')?.addEventListener('click', function(e) {
        if(e.target === this) closeChatModal();
    });

    // Sobrescrevemos a função loadMessages globalmente para que as funções externas possam controlar a pausa
    // Pequeno hack para conectar o escopo de fora com o de dentro
    // A verdadeira loadMessages roda dentro do DOMContentLoaded, mas precisamos verificar
    // se há edição ativa para pausar.
    const originalFetch = window.fetch; 
    // A lógica de pausa (isEditing) já foi colocada dentro da função loadMessages no DOMContentLoaded
    // Mas precisamos garantir que ela saiba quando estamos editando.
    // Vamos usar uma verificação simples: se existe um elemento com classe .msg-edit-input na tela, estamos editando.
    
    // No loadMessages acima, altere a linha "if (!currentForumId || isEditing) return;" para:
    // if (!currentForumId || document.querySelector('.msg-edit-input')) return;
    // (Fiz essa alteração mentalmente, certifique-se de aplicar abaixo no código final)
</script>

<div id="chatDeleteModal" class="custom-chat-modal" style="display: none;">
    <div class="chat-modal-content">
        <div class="chat-modal-icon">
            <i class="fas fa-trash-alt"></i>
        </div>
        <h3>Excluir Mensagem?</h3>
        <p>Esta ação não pode ser desfeita.</p>
        <div class="chat-modal-actions">
            <button class="btn-chat-modal btn-cancel" onclick="closeChatModal()">Cancelar</button>
            <button id="btnConfirmDelete" class="btn-chat-modal btn-confirm">Sim, Excluir</button>
        </div>
    </div>
</div>

<style>
    /* CSS DO MODAL (Adicione ou coloque no seu _head.html) */
    .custom-chat-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(15, 23, 42, 0.6); /* Fundo escuro com blur */
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease-out;
    }

    .chat-modal-content {
        background: white;
        padding: 32px;
        border-radius: 20px;
        width: 90%;
        max-width: 320px;
        text-align: center;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        transform: scale(0.95);
        animation: scaleUp 0.2s ease-out forwards;
    }

    .chat-modal-icon {
        width: 60px;
        height: 60px;
        background: #fee2e2; /* Vermelho bem claro */
        color: #ef4444; /* Vermelho erro */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin: 0 auto 16px auto;
    }

    .chat-modal-content h3 {
        margin: 0 0 8px 0;
        color: #1e293b;
        font-size: 18px;
        font-weight: 700;
    }

    .chat-modal-content p {
        margin: 0 0 24px 0;
        color: #64748b;
        font-size: 14px;
    }

    .chat-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .btn-chat-modal {
        padding: 10px 20px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        flex: 1;
    }

    .btn-cancel {
        background: #f1f5f9;
        color: #475569;
    }
    .btn-cancel:hover { background: #e2e8f0; }

    .btn-confirm {
        background: #ef4444;
        color: white;
        box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
    }
    .btn-confirm:hover { background: #dc2626; transform: translateY(-1px); }

    @keyframes scaleUp { to { transform: scale(1); } }
</style>

{% block extra_js %}{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\partials\_sidebar.html

<style>
/* Estilo para o grupo de menu */
.nav-group {
    margin-bottom: 5px;
}

/* O botão que abre/fecha */
.nav-group-trigger {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    color: #fff; /* Ajuste para a cor do seu texto */
    cursor: pointer;
    border-radius: 5px;
    transition: background 0.3s;
}

.nav-group-trigger:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.trigger-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

/* A setinha lateral */
.nav-group-trigger .arrow {
    font-size: 0.8rem;
    transition: transform 0.3s ease;
}

/* Estado aberto: gira a seta */
.nav-group.open .nav-group-trigger .arrow {
    transform: rotate(90deg);
}

/* Os itens dentro do submenu */
.nav-group-items {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
    background-color: rgba(0, 0, 0, 0.1); /* Fundo levemente mais escuro */
    border-radius: 0 0 5px 5px;
}

/* Links do submenu */
.nav-subitem {
    display: block;
    padding: 8px 15px 8px 45px; /* Indentação maior */
    color: #ccc;
    text-decoration: none;
    font-size: 0.9em;
    transition: color 0.2s;
}

.nav-subitem:hover {
    color: #fff;
    background-color: rgba(255,255,255,0.05);
}

/* Estilo dos ícones dentro do submenu */
.nav-subitem i {
    width: 20px; /* Largura fixa para manter o texto alinhado verticalmente */
    text-align: center;
    margin-right: 8px;
    font-size: 0.9rem; /* Um pouco menor que os ícones principais */
    opacity: 0.8; /* Um pouco mais discretos */
}

.nav-subitem:hover i {
    opacity: 1; /* Fica 100% visível no hover */
    color: #fff;
}

/* Classe utilitária para quando o grupo estiver aberto via JS */
.nav-group.open .nav-group-items {
    max-height: 500px; /* Valor arbitrário alto suficiente */
}

/* --- ESTILOS PARA QUANDO O MENU ESTÁ FECHADO (.toggled) --- */

/* 1. Esconde textos e setas, deixando só os ícones */
#sidebar.toggled .nav-item-text,
#sidebar.toggled .arrow {
    display: none !important;
}

/* 2. Centraliza os ícones */
#sidebar.toggled .nav-item,
#sidebar.toggled .nav-group-trigger {
    justify-content: center;
    padding-left: 0;
    padding-right: 0;
    text-align: center;
}

#sidebar.toggled .trigger-content {
    gap: 0; /* Remove espaço entre ícone e texto invisível */
}

/* --- MÁGICA DO MENU FLUTUANTE (HOVER) --- */

/* Necessário para posicionar o menu flutuante em relação ao ícone */
#sidebar.toggled .nav-group {
    position: relative;
}

/* Quando passar o mouse no ícone (apenas se o menu estiver fechado) */
#sidebar.toggled .nav-group:hover .nav-group-items {
    display: block;
    position: absolute;
    left: 100%; /* Joga o menu para a direita, fora da barra */
    top: 0;
    width: 220px; /* Largura confortável para ler os subitens */
    background-color: #0d47a1; /* ATENÇÃO: Coloque aqui a cor de fundo do seu menu lateral (Azul da imagem) */
    border-radius: 0 5px 5px 0;
    box-shadow: 5px 5px 10px rgba(0,0,0,0.2);
    max-height: 1000px; /* Remove a limitação de altura da animação */
    overflow: visible;
    z-index: 999;
}

/* Ajuste visual dos itens dentro do menu flutuante */
#sidebar.toggled .nav-subitem {
    padding-left: 20px; /* Tira aquele recuo exagerado */
    text-align: left;
}

/* Mostra o texto dos subitens novamente no menu flutuante */
#sidebar.toggled .nav-subitem .nav-item-text {
    display: inline !important; 
}
</style>

<nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-header-top">
            <div class="sidebar-logo">
                <i class="fas fa-clipboard-check"></i>
            </div>
            <div class="sidebar-title">Sistema de Auditorias</div>
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <div class="sidebar-search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="sidebarSearch" placeholder="Filtrar...">
        </div>
    </div>

    <div class="sidebar-nav" id="sidebarNav">

    <div class="nav-section">
        <div class="nav-section-title">Gestão de Auditorias</div>
        
        {% if perms.auditorias.view_auditoria %}
        <a href="{% url 'auditorias:lista_auditorias' %}" class="nav-item {% if request.resolver_match.url_name == 'lista_auditorias' %}active{% endif %}">
            <i class="fas fa-calendar-alt"></i>
            <span class="nav-item-text">Agendamentos</span>
        </a>
        {% endif %}

        {% if perms.auditorias.view_auditoriainstancia %}
        <a href="{% url 'auditorias:lista_execucoes' %}" class="nav-item {% if request.resolver_match.url_name == 'lista_execucoes' %}active{% endif %}">
            <i class="fas fa-tasks"></i>
            <span class="nav-item-text">Auditorias</span>
        </a>
        {% endif %}

        {% if perms.auditorias.view_auditoriainstancia %}
        <a href="{% url 'auditorias:historico_concluidas' %}" class="nav-item {% if request.resolver_match.url_name == 'historico_concluidas' %}active{% endif %}">
            <i class="fas fa-history"></i>
            <span class="nav-item-text">Histórico</span>
        </a>
        {% endif %}

        {% if perms.auditorias.view_norma or perms.auditorias.view_pilar or perms.auditorias.view_categoriaauditoria or perms.auditorias.view_checklist or perms.auditorias.view_modeloauditoria or perms.auditorias.view_ferramentadigital %}
        <div class="nav-group">
            <div class="nav-group-trigger" onclick="toggleGroup(this)">
                <div class="trigger-content">
                    <i class="fas fa-cog"></i>
                    <span class="nav-item-text">Cadastros</span>
                </div>
                <i class="fas fa-chevron-right arrow"></i>
            </div>
            <div class="nav-group-items">
                {% if perms.auditorias.view_norma %}
                <a href="{% url 'auditorias:lista_normas' %}" class="nav-subitem"><i class="fas fa-book"></i> Normas</a>
                {% endif %}
                
                {% if perms.auditorias.view_pilar %}
                <a href="{% url 'auditorias:lista_pilares' %}" class="nav-subitem"><i class="fas fa-columns"></i> Pilares</a>
                {% endif %}
                
                {% if perms.auditorias.view_categoriaauditoria %}
                <a href="{% url 'auditorias:lista_categorias_auditoria' %}" class="nav-subitem"><i class="fas fa-tags"></i> Categorias</a>
                {% endif %}
                
                {% if perms.auditorias.view_checklist %}
                <a href="{% url 'auditorias:lista_checklists' %}" class="nav-subitem"><i class="fas fa-list-ul"></i> Checklists</a>
                {% endif %}
                
                {% if perms.auditorias.view_modeloauditoria %}
                <a href="{% url 'auditorias:lista_modelos_auditoria' %}" class="nav-subitem"><i class="fas fa-file-alt"></i> Modelos</a>
                {% endif %}
            
            </div>
        </div>
        {% endif %}
    </div>

    {% if perms.auditorias.view_planodeacao %}
    <div class="nav-section">
        <div class="nav-section-title">Plano de Ação</div>
        <a href="{% url 'auditorias:lista_planos_de_acao' %}" class="nav-item {% if request.resolver_match.url_name == 'lista_planos_de_acao' %}active{% endif %}">
            <i class="fas fa-flag-checkered"></i>
            <span class="nav-item-text">Gerenciamento de Planos</span>
        </a>
    </div>
    {% endif %}

    {% if perms.organizacao.view_empresa or perms.organizacao.view_area or perms.organizacao.view_setor or perms.organizacao.view_subsetor %}
    <div class="nav-section">
        <div class="nav-section-title">Estrutura</div>
        
        <div class="nav-group">
            <div class="nav-group-trigger" onclick="toggleGroup(this)">
                <div class="trigger-content">
                    <i class="fas fa-sitemap"></i>
                    <span class="nav-item-text">Organização</span>
                </div>
                <i class="fas fa-chevron-right arrow"></i>
            </div>
            <div class="nav-group-items">
                {% if perms.organizacao.view_empresa %}
                <a href="{% url 'organizacao:lista_empresas' %}" class="nav-subitem"><i class="fas fa-building"></i> Unid. de Negócio</a>
                {% endif %}
                
                {% if perms.organizacao.view_area %}
                <a href="{% url 'organizacao:lista_areas' %}" class="nav-subitem"><i class="fas fa-map-marked-alt"></i> Áreas</a>
                {% endif %}
                
                {% if perms.organizacao.view_setor %}
                <a href="{% url 'organizacao:lista_setores' %}" class="nav-subitem"><i class="fas fa-layer-group"></i> Setores</a>
                {% endif %}
                
                {% if perms.organizacao.view_subsetor %}
                <a href="{% url 'organizacao:lista_subsetores' %}" class="nav-subitem"><i class="fas fa-th-large"></i> Subsetores</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if perms.ativos.view_ativo or perms.ativos.view_categoria or perms.ativos.view_marca or perms.ativos.view_modelo %}
    <div class="nav-section">
        <div class="nav-section-title">Gestão de Ativos</div>
        
        {% if perms.ativos.view_ativo %}
        <a href="{% url 'ativos:dashboard' %}" class="nav-item"><i class="fas fa-chart-pie"></i><span class="nav-item-text">Dashboard</span></a>
        <a href="{% url 'ativos:lista_ativos' %}" class="nav-item"><i class="fas fa-archive"></i><span class="nav-item-text">Ativos</span></a>
        {% endif %}
        
        {% if perms.ativos.view_categoria or perms.ativos.view_marca or perms.ativos.view_modelo %}
        <div class="nav-group">
            <div class="nav-group-trigger" onclick="toggleGroup(this)">
                <div class="trigger-content">
                    <i class="fas fa-database"></i>
                    <span class="nav-item-text">Cadastros</span>
                </div>
                <i class="fas fa-chevron-right arrow"></i>
            </div>
            <div class="nav-group-items">
                {% if perms.ativos.view_categoria %}
                <a href="{% url 'ativos:lista_categorias' %}" class="nav-subitem"><i class="fas fa-tag"></i> Categorias</a>
                {% endif %}
                {% if perms.ativos.view_marca %}
                <a href="{% url 'ativos:lista_marcas' %}" class="nav-subitem"><i class="fas fa-certificate"></i> Marcas</a>
                {% endif %}
                {% if perms.ativos.view_modelo %}
                <a href="{% url 'ativos:lista_modelos' %}" class="nav-subitem"><i class="fas fa-cube"></i> Modelos</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if perms.itens.view_item or perms.itens.view_categoria or perms.itens.view_subcategoria or perms.itens.view_almoxarifado %}
    <div class="nav-section">
        <div class="nav-section-title">Estoque & Itens</div>
        
        {% if perms.itens.view_item %}
        <a href="{% url 'itens:dashboard' %}" class="nav-item"><i class="fas fa-tachometer-alt"></i><span class="nav-item-text">Dashboard</span></a>
        <a href="{% url 'itens:lista_itens' %}" class="nav-item"><i class="fas fa-box"></i><span class="nav-item-text">Itens</span></a>
        {% endif %}
        
        {% if perms.itens.view_categoria or perms.itens.view_subcategoria or perms.itens.view_almoxarifado %}
        <div class="nav-group">
            <div class="nav-group-trigger" onclick="toggleGroup(this)">
                <div class="trigger-content">
                    <i class="fas fa-layer-group"></i>
                    <span class="nav-item-text">Cadastros</span>
                </div>
                <i class="fas fa-chevron-right arrow"></i>
            </div>
            <div class="nav-group-items">
                {% if perms.itens.view_categoria %}
                <a href="{% url 'itens:lista_categorias' %}" class="nav-subitem"><i class="fas fa-tags"></i> Categorias</a>
                {% endif %}
                {% if perms.itens.view_subcategoria %}
                <a href="{% url 'itens:lista_subcategorias' %}" class="nav-subitem"><i class="fas fa-tag"></i> Subcategorias</a>
                {% endif %}
                {% if perms.itens.view_almoxarifado %}
                <a href="{% url 'itens:lista_almoxarifados' %}" class="nav-subitem"><i class="fas fa-warehouse"></i> Almoxarifados</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if perms.clientes.view_cliente or perms.fornecedores.view_fornecedor %}
    <div class="nav-section">
        <div class="nav-section-title">Externos</div>
        
        {% if perms.clientes.view_cliente %}
        <a href="{% url 'clientes:lista_clientes' %}" class="nav-item"><i class="fas fa-user-tie"></i><span class="nav-item-text">Clientes</span></a>
        {% endif %}
        
        {% if perms.fornecedores.view_fornecedor %}
        <a href="{% url 'fornecedores:lista_fornecedores' %}" class="nav-item"><i class="fas fa-truck"></i><span class="nav-item-text">Fornecedores</span></a>
        {% endif %}
    </div>
    {% endif %}

    <div class="nav-section">
        <div class="nav-section-title">Gerenciamento de usuários</div>
        
        {% if perms.usuarios.view_usuario %}
        <a href="{% url 'usuarios:lista_usuarios' %}" class="nav-item"><i class="fas fa-users"></i><span class="nav-item-text">Usuários</span></a>
        {% endif %}
        
        <form method="post" action="{% url 'logout' %}" style="display: inline;" id="logoutForm">
            {% csrf_token %}
            <a href="#" onclick="document.getElementById('logoutForm').submit(); return false;" class="nav-item">
                <i class="fas fa-sign-out-alt"></i>
                <span class="nav-item-text">Sair</span>
            </a>
        </form>
    </div>

</div>
</nav>

<script>

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed'); // <-- CORRIGIDO para 'collapsed'
}

function toggleGroup(element) {
    const group = element.parentElement;
    group.classList.toggle('open');
}

document.addEventListener("DOMContentLoaded", function() {
    
    // Mantém o menu aberto se a página atual estiver dentro dele
    const activeSubItem = document.querySelector('.nav-subitem.active');
    if(activeSubItem) {
        const parentGroup = activeSubItem.closest('.nav-group');
        if (parentGroup) {
            parentGroup.classList.add('open');
        }
    }

    // ==========================================================
    // INÍCIO DA NOVA LÓGICA DO FILTRO
    // ==========================================================
    const searchInput = document.getElementById('sidebarSearch');
    const sidebarNav = document.getElementById('sidebarNav');

    if (searchInput && sidebarNav) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();

            // Seleciona todos os itens de menu de primeiro nível e os grupos
            const navItems = sidebarNav.querySelectorAll('.nav-item');
            const navGroups = sidebarNav.querySelectorAll('.nav-group');

            // Filtra os itens diretos (não estão em grupos)
            navItems.forEach(item => {
                const itemText = item.querySelector('.nav-item-text')?.textContent.toLowerCase() || '';
                if (itemText.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });

            // Filtra os grupos
            navGroups.forEach(group => {
                const triggerText = group.querySelector('.nav-group-trigger .nav-item-text')?.textContent.toLowerCase() || '';
                const subItems = group.querySelectorAll('.nav-subitem');
                let groupHasMatch = false;

                // Verifica se o próprio título do grupo corresponde
                if (triggerText.includes(searchTerm)) {
                    groupHasMatch = true;
                }

                // Mostra/esconde subitens dentro do grupo
                subItems.forEach(subItem => {
                    const subItemText = subItem.textContent.toLowerCase();
                    if (subItemText.includes(searchTerm)) {
                        subItem.style.display = 'block';
                        groupHasMatch = true; // Se um filho corresponde, o pai deve aparecer
                    } else {
                        subItem.style.display = 'none';
                    }
                });

                // Se o título do grupo ou algum de seus filhos corresponde, mostra o grupo
                if (groupHasMatch) {
                    group.style.display = 'block';
                    // Se a busca não estiver vazia, expande o grupo para mostrar o resultado
                    if (searchTerm) {
                        group.classList.add('open');
                    }
                } else {
                    group.style.display = 'none';
                }
            });
            
            // Lógica para esconder os títulos de seção se estiverem vazios
            const navSections = sidebarNav.querySelectorAll('.nav-section');
            navSections.forEach(section => {
                const visibleItems = section.querySelectorAll('.nav-item[style*="display: flex"], .nav-group[style*="display: block"]');
                const title = section.querySelector('.nav-section-title');
                if (title) {
                    title.style.display = visibleItems.length > 0 ? 'block' : 'none';
                }
            });

            // Se o campo de busca estiver vazio, reseta tudo para o estado original
            if (searchTerm === '') {
                navItems.forEach(item => item.style.display = 'flex');
                navGroups.forEach(group => {
                    group.style.display = 'block';
                    group.querySelectorAll('.nav-subitem').forEach(sub => sub.style.display = 'block');
                    // Não fecha os grupos que já estavam abertos
                    // group.classList.remove('open');
                });
                navSections.forEach(section => {
                    const title = section.querySelector('.nav-section-title');
                    if(title) title.style.display = 'block';
                });
            }
        });
    }
});
</script>

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\pilares\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Pilar</label>
        <input type="text" 
               id="nome" 
               name="nome" 
               class="form-control" 
               value="{{ pilar.nome|default:'' }}" 
               required 
               maxlength="100"
               placeholder="Digite o nome do pilar">
        <div class="field-help">Nome único e descritivo para identificar o pilar</div>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea id="descricao" 
                  name="descricao" 
                  class="form-control" 
                  rows="4" 
                  placeholder="Descreva o propósito e objetivos deste pilar">{{ pilar.descricao|default:'' }}</textarea>
        <div class="field-help">Descrição detalhada do pilar e sua aplicação</div>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" 
                       name="ativo" 
                       {% if pilar.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Pilar ativo no sistema
            </span>
        </div>
        <div class="field-help">Pilares inativos não aparecerão nas listagens de seleção</div>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\pilares\lista.html

{% extends 'auditorias/lista_generica.html' %}

{# Remove o formulário de busca genérico herdado do template pai #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros agora estão no cabeçalho da tabela #}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    {# Linha 1: Títulos das Colunas #}
    <tr>
        <th>Nome</th>
        <th>Descrição</th>
        <th>Status</th>
        <th>Data Cadastro</th>
        <th style="width: 120px;">Ações</th>
    </tr>
    {# Linha 2: Campos de Filtro #}
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th></th> {# Coluna de Ações sem filtro #}
    </tr>
{% endblock %}

{% block table_row %}
<td>
    <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;"> 
            {{ object.nome.0|upper }}
        </div>
        <div>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">
                {{ object.nome }} 
            </div>
            <div style="font-size: 12px; color: var(--text-muted);"> 
                ID: {{ object.pk }}
            </div>
        </div>
    </div>
</td>
<td>
    <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ object.descricao }}">
        {{ object.descricao|default:"—" }} 
    </div>
</td>
<td>
    {% if object.ativo %} 
        <span class="badge badge-success"> 
            <i class="fas fa-check-circle"></i> 
            Ativo
        </span>
    {% else %}
        <span class="badge badge-error">
            <i class="fas fa-times-circle"></i>
            Inativo
        </span>
    {% endif %} 
</td>
<td>
    <div style="color: var(--text-secondary);"> 
        {{ object.data_cadastro|date:"d/m/Y" }}
    </div>
    <div style="font-size: 12px; color: var(--text-muted);">
        {{ object.data_cadastro|date:"H:i" }}
    </div>
</td>
<td>
    <div class="action-buttons">
        {% if perms.auditorias.change_pilar %}
        <a href="{% url 'auditorias:editar_pilar' object.pk %}" 
           class="btn btn-secondary btn-icon" 
           title="Editar pilar">
            <i class="fas fa-edit"></i> 
        </a>
        {% endif %}

        {% if perms.auditorias.delete_pilar %}
        <button type="button" 
                class="btn btn-danger btn-icon" 
                title="Deletar pilar"
                onclick="confirmDelete('{% url 'auditorias:deletar_pilar' object.pk %}', '{{ object.nome }}')">
            <i class="fas fa-trash"></i> 
        </button>
        {% endif %}

    </div>
</td>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) {
            return;
        }
        const tableBody = table.querySelector('tbody');
        if (!tableBody) {
            return;
        }

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) {
                return;
            }

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);

                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
                                isRowVisible = false;
                            }
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }

        if (filters.length > 0) {
            filters.forEach(filter => {
                filter.addEventListener('input', applyTableFilters);
            });
        }
    });
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\planos_de_acao\dashboard.html

{% extends 'auditorias/base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    :root {
        --dash-bg: #f3f4f6;
        --card-bg: #ffffff;
        --text-dark: #1f2937;
        --text-light: #6b7280;
    }
    
    .dashboard-container {
        display: grid;
        grid-template-columns: 250px 1fr 1fr; /* Coluna KPI + 2 Colunas Gráficos */
        grid-template-rows: auto auto;
        gap: 20px;
        padding-bottom: 30px;
    }

    /* Estilo dos Cards de KPI (Esquerda) */
    .kpi-column {
        display: flex;
        flex-direction: column;
        gap: 20px;
        grid-row: 1 / span 2; /* Ocupa as duas linhas de altura */
    }

    .kpi-card {
        color: white;
        padding: 25px 20px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        height: 150px;
    }

    .kpi-card h3 { font-size: 14px; font-weight: 600; margin: 0 0 10px 0; opacity: 0.9; text-transform: uppercase; }
    .kpi-card .value { font-size: 42px; font-weight: 800; line-height: 1; }

    .kpi-blue { background: linear-gradient(135deg, #0ea5e9, #2563eb); }
    .kpi-orange { background: linear-gradient(135deg, #f97316, #ea580c); }
    .kpi-green { background: linear-gradient(135deg, #10b981, #059669); }

    /* Estilo dos Cards de Gráfico */
    .chart-card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
        min-height: 350px;
    }

    .chart-header {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 15px;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 1px solid #f3f4f6;
    }

    /* Grid Areas */
    .area-status { grid-column: 2; }
    .area-mes { grid-column: 3; }
    .area-local { grid-column: 2; }
    .area-ferramenta { grid-column: 3; }

    /* Tabela de Ranking */
    .ranking-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .ranking-table th { text-align: left; color: var(--text-light); font-size: 12px; border-bottom: 1px solid #eee; padding: 5px; }
    .ranking-table td { padding: 10px 5px; border-bottom: 1px solid #f9fafb; color: var(--text-dark); font-size: 14px; }
    .ranking-badge { background: #eff6ff; color: #2563eb; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 12px; }

    /* Responsivo */
    @media (max-width: 1200px) {
        .dashboard-container { grid-template-columns: 1fr 1fr; }
        .kpi-column { grid-row: auto; display: grid; grid-template-columns: 1fr 1fr 1fr; grid-column: 1 / -1; }
        .kpi-card { height: 120px; }
        .area-status, .area-mes, .area-local, .area-ferramenta { grid-column: auto; }
    }
    @media (max-width: 768px) {
        .dashboard-container { grid-template-columns: 1fr; }
        .kpi-column { grid-template-columns: 1fr; }
    }
</style>

<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">Dashboard Analítico</h2>
            <p class="content-subtitle">Visão geral dos indicadores de planos de ação</p>
        </div>
        <a href="{% url 'auditorias:lista_planos_de_acao' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar para Lista
        </a>
    </div>
</div>

<div class="dashboard-container">
    
    <div class="kpi-column">
        <div class="kpi-card kpi-blue">
            <h3>Total Pendentes</h3>
            <div class="value">{{ kpi_total_pendentes }}</div>
        </div>
        <div class="kpi-card kpi-orange">
            <h3>Colaboradores Pend.</h3>
            <div class="value">{{ kpi_colaboradores }}</div>
        </div>
        <div class="kpi-card kpi-green">
            <h3>% Pendência</h3>
            <div class="value">{{ kpi_porcentagem }}</div>
        </div>
        
        <div class="chart-card" style="flex: 1; min-height: auto;">
            <div class="chart-header">Top Pendências</div>
            <table class="ranking-table">
                <thead><tr><th>Usuário</th><th style="text-align:right">Qtd</th></tr></thead>
                <tbody>
                    {% for user in ranking_list %}
                    <tr>
                        <td style="display:flex; align-items:center; gap:8px;">
                            <div style="width:24px; height:24px; background:#e0e7ff; color:#4f46e5; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:bold;">
                                {{ user.nome.0 }}
                            </div>
                            {{ user.nome|truncatechars:15 }}
                        </td>
                        <td style="text-align:right"><span class="ranking-badge">{{ user.qtd }}</span></td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2" style="text-align:center; color:#999;">Sem dados</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="chart-card area-status">
        <div class="chart-header">Pendentes por Status</div>
        <div id="chartStatus"></div>
    </div>

    <div class="chart-card area-mes">
        <div class="chart-header">Evolução Mensal (Geral)</div>
        <div id="chartMes"></div>
    </div>

    <div class="chart-card area-local">
        <div class="chart-header">Geradas por Local</div>
        <div id="chartLocal"></div>
    </div>

    <div class="chart-card area-ferramenta">
        <div class="chart-header">Ações por Ferramenta</div>
        <div id="chartFerramenta"></div>
    </div>

</div>

<script>
    // Recupera dados do Backend
    const dataStatusLabels = JSON.parse('{{ chart_status_labels|safe }}');
    const dataStatusSeries = JSON.parse('{{ chart_status_series|safe }}');
    
    const dataMesLabels = JSON.parse('{{ chart_mes_labels|safe }}');
    const dataMesSeries = JSON.parse('{{ chart_mes_series|safe }}');
    
    const dataFerramentaLabels = JSON.parse('{{ chart_ferramenta_labels|safe }}');
    const dataFerramentaSeries = JSON.parse('{{ chart_ferramenta_series|safe }}');
    
    const dataLocalLabels = JSON.parse('{{ chart_local_labels|safe }}');
    const dataLocalSeries = JSON.parse('{{ chart_local_series|safe }}');

    // 1. Chart: Status (Donut)
    var optionsStatus = {
        series: dataStatusSeries,
        labels: dataStatusLabels,
        chart: { type: 'donut', height: 300 },
        colors: ['#26a69a', '#f59e0b', '#2563eb', '#9333ea', '#4ade80'], // Cores do seu sistema
        plotOptions: { pie: { donut: { size: '65%' } } },
        legend: { position: 'bottom' },
        dataLabels: { enabled: false }
    };
    new ApexCharts(document.querySelector("#chartStatus"), optionsStatus).render();

    // 2. Chart: Meses (Barra Vertical)
    var optionsMes = {
        series: [{ name: 'Ações', data: dataMesSeries }],
        chart: { type: 'bar', height: 300, toolbar: {show: false} },
        colors: ['#f59e0b'], // Laranja/Amarelo da imagem
        plotOptions: { bar: { borderRadius: 4, columnWidth: '50%' } },
        xaxis: { categories: dataMesLabels },
        grid: { borderColor: '#f1f1f1' }
    };
    new ApexCharts(document.querySelector("#chartMes"), optionsMes).render();

    // 3. Chart: Local (Area ou Bar)
    var optionsLocal = {
        series: [{ name: 'Ações', data: dataLocalSeries }],
        chart: { type: 'area', height: 300, toolbar: {show: false} },
        colors: ['#b91c1c'], // Vermelho escuro da imagem
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.3 } },
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth' },
        xaxis: { categories: dataLocalLabels }
    };
    new ApexCharts(document.querySelector("#chartLocal"), optionsLocal).render();

    // 4. Chart: Ferramenta (Barra Horizontal)
    var optionsFerr = {
        series: [{ name: 'Ações', data: dataFerramentaSeries }],
        chart: { type: 'bar', height: 300, toolbar: {show: false} },
        plotOptions: { bar: { horizontal: true, borderRadius: 4, barHeight: '50%' } },
        colors: ['#0ea5e9'], // Azul ciano da imagem
        xaxis: { categories: dataFerramentaLabels },
        grid: { borderColor: '#f1f1f1' }
    };
    new ApexCharts(document.querySelector("#chartFerramenta"), optionsFerr).render();

</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\auditorias\planos_de_acao\lista.html

{% extends 'auditorias/lista_generica.html' %}
{% load static %}
{% load auditoria_extras %} 

{% block title %}{{ title }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{# --- SUBSTITUI O CABEÇALHO PADRÃO --- #}
{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle" style="font-size: 13px; color: #64748b; margin-top: 5px;">
                {% if current_mode == 'finished' %}
                    Histórico de ações concluídas, recusadas ou arquivadas.
                {% else %}
                    Acompanhe e gerencie as ações em andamento.
                {% endif %}
            </p>
        </div>
        
        <div style="display: flex; gap: 10px;">
            
            <a href="{% url 'auditorias:dashboard_planos' %}" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-chart-pie" style="color: #7c3aed;"></i> Dashboard
            </a>

            {% if current_mode == 'active' %}
                <a href="?mode=finished" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                    <i class="fas fa-check-double" style="color: #16a34a;"></i> Ver Ações Finalizadas
                </a>
            {% else %}
                <a href="?mode=active" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                    <i class="fas fa-list-ul" style="color: #0066cc;"></i> Ver Ações Em Andamento
                </a>
            {% endif %}

            {% if perms.auditorias.add_planodeacao %}
            {% if current_mode == 'active' %}
                <a href="#" class="btn btn-primary" onclick="openModalNovoPlano()">
                    <i class="fas fa-plus"></i> Novo Plano
                </a>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{# --- BLOCO DE ESTILOS E FILTROS (Consolidado para garantir funcionamento) --- #}
{% block search_form %}
<style>
    /* === ESTILOS DOS CARDS DE FILTRO (Mantido) === */
    .filter-card-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    .filter-card {
        display: flex;
        align-items: center;
        padding: 20px;
        border-radius: var(--radius-md, 8px);
        background-color: var(--bg-card, #fff);
        border: 1px solid var(--border, #e0e0e0);
        transition: all 0.2s ease;
        color: var(--text-secondary, #666);
        text-decoration: none;
    }
    .filter-card.active, .filter-card:hover {
        border-color: var(--primary, #2563eb);
        color: var(--primary, #2563eb);
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.1);
        transform: translateY(-2px);
    }
    .filter-card .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 16px;
        background-color: rgba(37, 99, 235, 0.1);
    }
    .filter-card.active .icon-wrapper { background-color: var(--primary, #2563eb); }
    .filter-card .icon-wrapper i { color: var(--primary, #2563eb); font-size: 16px; }
    .filter-card.active .icon-wrapper i { color: #fff; }
    .filter-card .info .count { font-size: 1.5rem; font-weight: 700; color: var(--text-primary, #333); }
    .filter-card.active .info .count { color: var(--primary, #2563eb); }
    .filter-card .info .label { font-size: 0.9rem; font-weight: 500; }
    
    /* Cores Específicas dos Filtros */
    /* 1. RECEBIDAS (Verde Água / Teal - #26a69a) */
    .filter-card[data-status="recebidas"] .icon-wrapper { 
        background-color: rgba(38, 166, 154, 0.1); 
    }
    .filter-card[data-status="recebidas"] .icon-wrapper i { 
        color: #26a69a; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="recebidas"].active,
    .filter-card[data-status="recebidas"]:hover {
        border-color: #26a69a;
        color: #26a69a;
    }
    .filter-card[data-status="recebidas"].active .icon-wrapper {
        background-color: #26a69a;
    }
    /* CORREÇÃO: Força o ícone a ficar branco quando ativo */
    .filter-card[data-status="recebidas"].active .icon-wrapper i {
        color: white !important;
    }

    /* 2. IMPLEMENTAÇÃO (Azul - #2563eb) */
    .filter-card[data-status="implementacao"] .icon-wrapper { 
        background-color: rgba(37, 99, 235, 0.1); 
    }
    .filter-card[data-status="implementacao"] .icon-wrapper i { 
        color: #2563eb; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="implementacao"].active,
    .filter-card[data-status="implementacao"]:hover {
        border-color: #2563eb;
        color: #2563eb;
    }
    .filter-card[data-status="implementacao"].active .icon-wrapper {
        background-color: #2563eb;
    }
    /* CORREÇÃO */
    .filter-card[data-status="implementacao"].active .icon-wrapper i {
        color: white !important;
    }

    /* 3. AG. APROVAÇÃO (Verde Claro / Lime - #4ade80) */
    .filter-card[data-status="ag_aprovacao"] .icon-wrapper { 
        background-color: rgba(74, 222, 128, 0.1); 
    }
    .filter-card[data-status="ag_aprovacao"] .icon-wrapper i { 
        color: #4ade80; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="ag_aprovacao"].active,
    .filter-card[data-status="ag_aprovacao"]:hover {
        border-color: #4ade80;
        color: #22c55e; 
    }
    .filter-card[data-status="ag_aprovacao"].active .icon-wrapper {
        background-color: #4ade80;
    }
    /* CORREÇÃO */
    .filter-card[data-status="ag_aprovacao"].active .icon-wrapper i {
        color: white !important;
    }

    /* 4. VAL. EFICÁCIA (Laranja / Amber - #f59e0b) */
    .filter-card[data-status="val_eficacia"] .icon-wrapper { 
        background-color: rgba(245, 158, 11, 0.1); 
    }
    .filter-card[data-status="val_eficacia"] .icon-wrapper i { 
        color: #f59e0b; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="val_eficacia"].active,
    .filter-card[data-status="val_eficacia"]:hover {
        border-color: #f59e0b;
        color: #f59e0b;
    }
    .filter-card[data-status="val_eficacia"].active .icon-wrapper {
        background-color: #f59e0b;
    }
    /* CORREÇÃO */
    .filter-card[data-status="val_eficacia"].active .icon-wrapper i {
        color: white !important;
    }

    /* 5. AG. VALIDAÇÃO (Roxo - #9333ea) */
    .filter-card[data-status="validacao"] .icon-wrapper { 
        background-color: rgba(147, 51, 234, 0.1); 
    }
    .filter-card[data-status="validacao"] .icon-wrapper i { 
        color: #9333ea; 
    }
    .filter-card[data-status="validacao"].active,
    .filter-card[data-status="validacao"]:hover {
        border-color: #9333ea;
        color: #9333ea;
    }
    .filter-card[data-status="validacao"].active .icon-wrapper {
        background-color: #9333ea;
    }
    /* CORREÇÃO */
    .filter-card[data-status="validacao"].active .icon-wrapper i {
        color: white !important;
    }

    /* === NOVOS ESTILOS DA TABELA (Movidos para cá para garantir carregamento) === */
    
    /* Filtros da Tabela */
    .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }

        /* --- ESTILOS PARA COLUNA DE AÇÕES/STATUS --- */
        
        /* Container para alinhar barra e botão */
        .status-action-wrapper {
            width: 100%;
            height: 100%;
            min-height: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        /* --- A BARRA LATERAL (GAVETA FINA) --- */
        .status-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 12px; /* BEM MAIS FINA AGORA */
            
            /* Visual */
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            cursor: pointer;
            
            /* Transição */
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10; 
            
            /* Layout interno */
            display: flex;
            align-items: center;
            justify-content: center; /* Centraliza o ícone na largura fina */
            overflow: hidden;
        }

        /* O ÍCONE (Mudado para Chevron '›' para caber melhor) */
        .status-bar::before {
            content: '\f105'; /* Código do fa-angle-right (›) */
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            
            position: absolute;
            left: 50%;
            transform: translateX(-50%); /* Centraliza exato no meio dos 12px */
            
            color: rgba(255, 255, 255, 0.9);
            font-size: 11px; /* Tamanho delicado */
            transition: all 0.2s ease;
        }

        /* O TEXTO (Status) */
        .status-bar::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            
            color: #fff;
            font-weight: 700;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease 0.1s;
        }

        /* --- INTERAÇÃO (HOVER NA BARRA) --- */
        
        /* 1. Expande a barra */
        .status-bar:hover {
            width: 100%; 
            border-radius: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
        }

        /* 2. O Chevron some suavemente ou desliza */
        .status-bar:hover::before {
            opacity: 0;
            transform: translateX(10px); /* Desliza um pouco para direita e some */
        }

        /* 3. Texto aparece */
        .status-bar:hover::after {
            opacity: 1;
        }

        /* --- A ENGRENAGEM --- */
        .gear-wrapper {
            z-index: 1;
            position: relative;
        }

        .btn-gear {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border, #e0e0e0);
            background: #fff;
            color: var(--text-secondary, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-gear:hover {
            border-color: var(--primary, #2563eb);
            color: var(--primary, #2563eb);
            transform: rotate(30deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- CORES PERSONALIZADAS (Baseadas na Imagem do Dashboard) --- */

        /* 1. Recebidas (ABERTO) - Turquesa/Teal */
        .status-bar.status-ABERTO,
        .status-bar.status-RECEBIDO { 
            background-color: #26a69a !important; /* Cor do ícone "Recebidas" */
        }

        /* 2. Em Implementação - Azul */
        .status-bar.status-EM_IMPLEMENTACAO { 
            background-color: #2563eb !important; /* Cor do ícone "Implementação" */
        }

        /* 3. Validação de Eficácia - Laranja */
        /* Mapeamos tanto o status de validação quanto checagem para laranja */
        .status-bar.status-VAL_EFICACIA,
        .status-bar.status-VALIDACAO_EFICACIA, 
        .status-bar.status-AGUARDANDO_VALIDACAO { 
            background-color: #f59e0b !important; /* Cor do ícone "Val. Eficácia" */
        }

        /* 4. Ag. Aprovação - Verde Claro (Lime) */
        .status-bar.status-AGUARDANDO_APROVACAO,
        .status-bar.status-AG_APROVACAO { 
            background-color: #4ade80 !important; /* Cor do ícone "Ag. Aprovação" */
        }

        /* Status Extras (Caso existam no sistema) */
        .status-bar.status-CONCLUIDO { 
            background-color: #16a34a !important; /* Um verde um pouco mais escuro para finalizado */
        }
        
        .status-bar.status-CANCELADO { 
            background-color: #94a3b8 !important; /* Cinza */
        }

        /* Grid de Ações */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
            justify-content: center;
        }

        .grid-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 20px 10px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-secondary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            border: 1px solid transparent;
            height: 140px; /* Altura fixa para ficarem quadrados */
            text-align: center;
        }

        .grid-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--border);
            color: var(--primary);
        }

        .grid-action-btn .icon-circle {
            width: 40px;
            height: 40px;
            background: #f1f5f9; /* Cor de fundo suave para o ícone */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 18px;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .grid-action-btn:hover .icon-circle {
            background: var(--primary);
            color: white;
        }

        .grid-action-btn span {
            font-size: 13px;
            font-weight: 600;
            line-height: 1.4;
        }

        /* Estilo específico para botão de deletar/recusar */
        .grid-action-btn.delete-style:hover .icon-circle {
            background: var(--error);
        }
        .grid-action-btn.delete-style:hover {
            color: var(--error);
        }

        .modal {
        display: none; /* Oculto por padrão */
        position: fixed;
        z-index: 9999; /* Alto para ficar sobre tudo */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5); /* Fundo escuro transparente */
        backdrop-filter: blur(4px); /* Efeito de desfoque */
        align-items: center;     /* Centraliza verticalmente (se usar flex) */
        justify-content: center; /* Centraliza horizontalmente (se usar flex) */
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto; /* Centraliza se não usar flex */
        border: 1px solid #888;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: modalFadeIn 0.3s ease-out;
        position: relative;
    }

    /* Animação suave de entrada */
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .close-btn {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
    }
    .close-btn:hover { color: #000; }



    /* === ESTILOS DO NOVO MODAL DE DETALHES (Estilo Clean/Cinza) === */
    .modal-detailed-header {
        background: #fff;
        padding: 20px 20px 0 20px;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .modal-top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-tabs {
        display: flex;
        gap: 20px;
    }

    .modal-tab {
        padding: 10px 5px;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .modal-tab.active {
        color: #0066cc; /* Azul */
        border-bottom-color: #0066cc; /* Azul */
    }

    .modal-detailed-body {
        padding: 20px;
        background-color: #f8fafc; /* Fundo levemente cinza */
        max-height: 80vh;
        overflow-y: auto;
    }

    /* Grid do Formulário */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 12px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .form-value-box {
        background: #e2e8f0; /* O cinza dos inputs da imagem */
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        color: #333;
        min-height: 36px;
        display: flex;
        align-items: center;
        border: 1px solid #cbd5e1;
    }

    .form-value-box.textarea-style {
        min-height: 100px;
        align-items: flex-start;
        white-space: pre-wrap;
    }

    .full-width {
        grid-column: 1 / -1;
    }

    /* Botões de Ação do Modal ( ... e X ) */
    .modal-actions-top {
        display: flex;
        gap: 10px;
    }
    .btn-circle-action {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: white;
        color: #666;
        transition: all 0.2s;
    }
    .btn-circle-action:hover {
        background: #f1f5f9;
        color: #333;
    }
    .btn-circle-action.close-red:hover {
        background: #fee2e2;
        color: #ef4444;
        border-color: #ef4444;
    }



    .textarea-container {
        position: relative;
        width: 100%;
    }

    #motivoArquivamento {
        width: 100%;
        height: 120px;
        padding: 12px;
        border: 1px solid #dc2626; /* Começa vermelho por padrão */
        border-radius: 4px;
        font-family: inherit;
        resize: none;
        outline: none;
        transition: all 0.2s;
    }

    /* Estado Válido (Verde) */
    #motivoArquivamento.valid {
        border-color: #22c55e !important;
        box-shadow: 0 0 0 1px #22c55e;
    }

    /* Botão Desativado */
    #btnConfirmarArquivar:disabled {
        background-color: #ccc !important;
        cursor: not-allowed;
        opacity: 0.7;
    }


    /* === ESTILOS DA NOTIFICAÇÃO (TOAST) === */
    #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000; /* Acima de tudo, inclusive modais */
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast-notification {
        min-width: 300px;
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideInRight 0.3s ease-out forwards;
        opacity: 0;
    }

    .toast-notification.success {
        background-color: #22c55e; /* Verde */
        border-left: 6px solid #15803d;
    }

    .toast-notification.error {
        background-color: #ef4444; /* Vermelho */
        border-left: 6px solid #b91c1c;
    }

    .toast-notification.warning {
        background-color: #f59e0b; /* Laranja */
        border-left: 6px solid #b45309; /* Laranja Escuro */
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    /* Estilos para a aba de Resolução */
    .resolution-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .context-section {
        background-color: #fff1f2; /* Fundo avermelhado suave para indicar o "Problema" */
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 15px;
    }

    .solution-section {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 15px;
    }

    .section-title {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .evidence-gallery {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .evidence-thumb {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        border: 1px solid #ddd;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .evidence-thumb:hover {
        transform: scale(1.05);
        border-color: #2563eb;
    }

    /* Ocultar/Mostrar Abas */
    .tab-content-panel {
        display: none; /* Escondido por padrão */
        animation: fadeIn 0.3s ease;
    }
    .tab-content-panel.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* 5. AG. VALIDAÇÃO (Roxo - #9333ea) */
    .filter-card[data-status="validacao"] .icon-wrapper { 
        background-color: rgba(147, 51, 234, 0.1); 
    }
    .filter-card[data-status="validacao"] .icon-wrapper i { 
        color: #9333ea; 
    }
    .filter-card[data-status="validacao"].active,
    .filter-card[data-status="validacao"]:hover {
        border-color: #9333ea;
        color: #9333ea;
    }
    .filter-card[data-status="validacao"].active .icon-wrapper {
        background-color: #9333ea;
    }
    
    /* Atualize também a barra lateral da tabela se quiser */
    .status-bar.status-AGUARDANDO_VALIDACAO { 
        background-color: #9333ea !important; 
    }

    .input-group-text {
        display: flex;
        align-items: stretch;
    }
    .input-group-text input {
        flex: 1;
    }

    /* Estilo de cada linha de investimento */
    .investimento-row {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }
    
    .investimento-row:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Botão de excluir flutuante no canto da linha */
    .btn-delete-row {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 28px;
        height: 28px;
        background: #fff;
        border: 1px solid #ef4444;
        color: #ef4444;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 2;
    }
    .btn-delete-row:hover {
        background: #ef4444;
        color: white;
    }

    /* TIMELINE STYLES */
    .timeline {
        position: relative;
        padding: 20px 0;
        margin-left: 20px;
        border-left: 2px solid #e2e8f0;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 30px;
    }

    .timeline-item:last-child {
        margin-bottom: 0;
    }

    /* Bolinha na linha do tempo */
    .timeline-marker {
        position: absolute;
        left: -11px; /* Centraliza na linha de 2px */
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #2563eb; /* Azul padrão */
        z-index: 1;
    }

    /* Cores das bolinhas por tipo */
    .marker-STATUS { border-color: #2563eb; } /* Azul */
    .marker-CRIACAO { border-color: #10b981; } /* Verde */
    .marker-REDISTRIBUICAO { border-color: #f59e0b; } /* Laranja */
    .marker-EDICAO { border-color: #64748b; } /* Cinza */
    .marker-ANEXO { border-color: #8b5cf6; } /* Roxo */
    .marker-PRAZO { border-color: #ec4899; } /* Rosa */

    .timeline-content {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .timeline-author {
        font-weight: 700;
        color: #333;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .timeline-avatar {
        width: 24px;
        height: 24px;
        background: #f1f5f9;
        color: #64748b;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
    }

    .timeline-date {
        font-size: 12px;
        color: #94a3b8;
    }

    .timeline-body {
        font-size: 13px;
        color: #555;
        line-height: 1.5;
    }

    /* --- ESTILOS DA ABA FÓRUM --- */
    .forum-container {
        display: flex;
        flex-direction: column;
        height: 60vh; /* Altura fixa para permitir scroll */
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
    }

    .forum-messages-area {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
    }

    /* Balão de Mensagem */
    .forum-msg-item {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .forum-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #c4b5fd; /* Cor padrão */
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        flex-shrink: 0;
    }

    .forum-msg-content {
        display: flex;
        flex-direction: column;
        max-width: 80%;
    }

    .forum-msg-meta {
        font-size: 11px;
        color: #64748b;
        margin-bottom: 4px;
    }

    .forum-msg-bubble {
        padding: 10px 14px;
        border-radius: 0 12px 12px 12px;
        font-size: 13px;
        line-height: 1.4;
        color: #fff;
        background-color: #0066cc; /* Azul (Era vermelho) */
        color: #fff;
    }

    /* Mensagem do Próprio Usuário (Opcional: Alinhar à direita) */
    .forum-msg-item.me {
        flex-direction: row-reverse;
    }
    .forum-msg-item.me .forum-msg-bubble {
        border-radius: 12px 0 12px 12px;
        background-color: #334155; /* Cinza escuro para diferenciar */
    }
    .forum-msg-item.me .forum-msg-meta {
        text-align: right;
    }

    /* Área de Input */
    .forum-input-area {
        display: flex;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        margin: -20px -20px -20px -20px; /* Expande para as bordas */
        padding: 15px 20px;
        border-radius: 0 0 8px 8px;
    }

    .forum-input-area input {
        background: #fff;
        border: 1px solid #cbd5e1;
    }

    .btn-send-forum {
        background-color: #0066cc;
        color: white;
        border: none;
        width: 42px;
        height: 38px; /* Altura igual ao input padrão */
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    .btn-send-forum:hover {
        background-color: #0052a3;
    }

    
    /* --- CORES DOS CARDS DE FINALIZADAS (PADRONIZADO) --- */
    
    /* 1. Concluídas (Verde Sucesso) */
    .filter-card[data-status="concluidas"] .icon-wrapper { 
        background-color: rgba(22, 163, 74, 0.1); 
    }
    .filter-card[data-status="concluidas"] .icon-wrapper i { 
        color: #16a34a; 
    }
    .filter-card[data-status="concluidas"].active,
    .filter-card[data-status="concluidas"]:hover { 
        border-color: #16a34a; 
        color: #16a34a; 
    }
    .filter-card[data-status="concluidas"].active .icon-wrapper { 
        background-color: #16a34a; 
        color: white !important;
    }
    .filter-card[data-status="concluidas"].active .icon-wrapper i {
        color: white !important;
    }

    /* 2. Recusadas (Vermelho Alerta) */
    .filter-card[data-status="recusadas"] .icon-wrapper { 
        background-color: rgba(220, 38, 38, 0.1); 
    }
    .filter-card[data-status="recusadas"] .icon-wrapper i { 
        color: #dc2626; 
    }
    .filter-card[data-status="recusadas"].active,
    .filter-card[data-status="recusadas"]:hover { 
        border-color: #dc2626; 
        color: #dc2626; 
    }
    .filter-card[data-status="recusadas"].active .icon-wrapper { 
        background-color: #dc2626; 
        color: white !important;
    }
    .filter-card[data-status="recusadas"].active .icon-wrapper i {
        color: white !important;
    }

    /* 3. Arquivadas (Azul Ciano - Para combinar com o status) */
    .filter-card[data-status="arquivadas"] .icon-wrapper { 
        background-color: rgba(14, 165, 233, 0.1); /* Azul Claro */
    }
    .filter-card[data-status="arquivadas"] .icon-wrapper i { 
        color: #0ea5e9; 
    }
    .filter-card[data-status="arquivadas"].active,
    .filter-card[data-status="arquivadas"]:hover { 
        border-color: #0ea5e9; 
        color: #0ea5e9; 
    }
    .filter-card[data-status="arquivadas"].active .icon-wrapper { 
        background-color: #0ea5e9; 
        color: white !important;
    }
    .filter-card[data-status="arquivadas"].active .icon-wrapper i {
        color: white !important;
    }

    /* --- CORES DOS STATUS FINAIS (TABELA) --- */

    /* CONCLUÍDO (Verde #16a34a) */
    .status-badge.status-CONCLUIDO {
        background-color: #f0fdf4; /* Fundo bem claro */
        color: #15803d; /* Texto escuro */
        border: 1px solid #bbf7d0;
    }
    .status-bar.status-CONCLUIDO { 
        background-color: #16a34a !important; /* Barra lateral cor principal */
    }

    /* RECUSADO/CANCELADO (Vermelho #dc2626) */
    .status-badge.status-CANCELADO {
        background-color: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    .status-bar.status-CANCELADO { 
        background-color: #dc2626 !important; 
    }

    /* ARQUIVADO (Azul Ciano #0ea5e9) */
    .status-badge.status-ARQUIVADO {
        background-color: #f0f9ff;
        color: #0369a1;
        border: 1px solid #bae6fd;
    }
    .status-bar.status-ARQUIVADO { 
        background-color: #0ea5e9 !important; 
    }

    /* Estilos Clean Form (Inspirado na imagem) */
    .date-input-group {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 5px;
        flex: 1;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .date-icon-box {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        margin-right: 10px;
    }
    .date-icon-box.success { background-color: #dcfce7; color: #166534; } /* Verde para Início */
    .date-icon-box.danger { background-color: #fee2e2; color: #991b1b; } /* Vermelho para Final */

    .date-label {
        font-size: 11px;
        color: #999;
        font-weight: 600;
        display: block;
        text-transform: uppercase;
    }

    .date-clean-input {
        border: none;
        outline: none;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        width: 100%;
        background: transparent;
    }

    .input-wrapper-clean {
        margin-bottom: 20px;
        position: relative;
    }

    .label-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
    }

    .label-row label {
        font-size: 14px;
        color: #444;
        font-weight: 500;
    }

    .label-row .counter {
        font-size: 12px;
        font-weight: 700;
        color: #ef4444; /* Vermelho como na imagem */
    }

    .input-clean {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc; /* Borda padrão */
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .input-clean:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        outline: none;
    }

    /* Estado de erro (Vermelho como na imagem) */
    .input-clean.error {
        border-color: #ef4444;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ef4444' viewBox='0 0 16 16'%3E%3Cpath d='M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }

    .error-msg {
        color: #ef4444;
        font-size: 11px;
        margin-top: 4px;
        display: none;
    }

    .input-clean.error + .error-msg {
        display: block;
    }

    .textarea-clean {
        resize: vertical;
        border-color: #e2e8f0;
    }

    .file-upload-box {
        border: 2px dashed #ccc;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: #fafafa;
        color: #666;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .file-upload-box:hover {
        border-color: #2563eb;
        background: #eff6ff;
        color: #2563eb;
    }
        
    </style>

<div class="filter-card-list">
    
    {% if current_mode == 'active' %}
        <a href="?mode=active&status={% if current_status == 'recebidas' %}todos{% else %}recebidas{% endif %}" 
           class="filter-card {% if current_status == 'recebidas' %}active{% endif %}" 
           data-status="recebidas">
            <div class="icon-wrapper"><i class="fas fa-inbox"></i></div>
            <div class="info"><div class="count">{{ status_counts.recebidas }}</div><div class="label">Recebidas</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'validacao' %}todos{% else %}validacao{% endif %}" 
           class="filter-card {% if current_status == 'validacao' %}active{% endif %}" 
           data-status="validacao">
            <div class="icon-wrapper"><i class="fas fa-search"></i></div>
            <div class="info"><div class="count">{{ status_counts.aguardando_validacao }}</div><div class="label">Ag. Validação</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'implementacao' %}todos{% else %}implementacao{% endif %}" 
           class="filter-card {% if current_status == 'implementacao' %}active{% endif %}" 
           data-status="implementacao">
            <div class="icon-wrapper"><i class="fas fa-cogs"></i></div>
            <div class="info"><div class="count">{{ status_counts.implementacao }}</div><div class="label">Implementação</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'ag_aprovacao' %}todos{% else %}ag_aprovacao{% endif %}" 
           class="filter-card {% if current_status == 'ag_aprovacao' %}active{% endif %}" 
           data-status="ag_aprovacao">
            <div class="icon-wrapper"><i class="fas fa-user-check"></i></div>
            <div class="info"><div class="count">{{ status_counts.ag_aprovacao }}</div><div class="label">Ag. Aprovação</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'val_eficacia' %}todos{% else %}val_eficacia{% endif %}" 
           class="filter-card {% if current_status == 'val_eficacia' %}active{% endif %}" 
           data-status="val_eficacia">
            <div class="icon-wrapper"><i class="fas fa-clipboard-check"></i></div>
            <div class="info"><div class="count">{{ status_counts.val_eficacia }}</div><div class="label">Val. Eficácia</div></div>
        </a>

    {% else %}
        <a href="?mode=finished&status={% if current_status == 'concluidas' %}todos{% else %}concluidas{% endif %}" 
           class="filter-card {% if current_status == 'concluidas' %}active{% endif %}" 
           data-status="concluidas">
            <div class="icon-wrapper"><i class="fas fa-check-circle"></i></div>
            <div class="info"><div class="count">{{ status_counts.concluidas }}</div><div class="label">Concluídas</div></div>
        </a>

        <a href="?mode=finished&status={% if current_status == 'recusadas' %}todos{% else %}recusadas{% endif %}" 
           class="filter-card {% if current_status == 'recusadas' %}active{% endif %}" 
           data-status="recusadas">
            <div class="icon-wrapper"><i class="fas fa-ban"></i></div>
            <div class="info"><div class="count">{{ status_counts.recusadas }}</div><div class="label">Recusadas</div></div>
        </a>

        <a href="?mode=finished&status={% if current_status == 'arquivadas' %}todos{% else %}arquivadas{% endif %}" 
           class="filter-card {% if current_status == 'arquivadas' %}active{% endif %}" 
           data-status="arquivadas">
            <div class="icon-wrapper"><i class="fas fa-archive"></i></div>
            <div class="info"><div class="count">{{ status_counts.arquivadas }}</div><div class="label">Arquivadas</div></div>
        </a>
    {% endif %}

</div>

<div id="actionGridModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px; background: #f8fafc; border-radius: 8px;">
        <div class="modal-header" style="background: white; border-bottom: 1px solid #e2e8f0; padding: 20px 30px; border-radius: 8px 8px 0 0;">
            <h2 id="modalActionTitle" style="font-size: 18px; color: #1e293b; font-weight: 700; margin: 0;"></h2>
            <span class="close-btn" onclick="closeActionGridModal()">&times;</span>
        </div>
        
        <div class="modal-body" style="padding: 30px;">
            <div class="action-grid">
                <a href="#" id="btnInvestir" class="grid-action-btn" style="display: none;">
                    <div class="icon-circle"><i class="fas fa-dollar-sign"></i></div>
                    <span>Investir</span>
                </a>
                <a href="#" id="btnExportar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-file-export"></i></div>
                    <span>Exportar</span>
                </a>

                <a href="#" id="btnRedirecionar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-share"></i></div>
                    <span>Redirecionar</span>
                </a>

                <a href="#" id="btnRelatorio" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-file-alt"></i></div>
                    <span>Relatório</span>
                </a>

                <a href="#" id="btnArquivar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-archive"></i></div>
                    <span>Arquivar</span>
                </a>

                <a href="#" id="btnClonar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-copy"></i></div>
                    <span>Clonar Ação</span>
                </a>

                <a href="#" id="btnPrazo" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-calendar-alt"></i></div>
                    <span>Nova data de<br>encerramento</span>
                </a>

                <a href="#" id="btnAceitar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-check-circle"></i></div>
                    <span>Aceitar</span>
                </a>

                <a href="#" id="btnRecusar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-times-circle"></i></div>
                    <span>Recusar</span>
                </a>
                
            </div>
        </div>
        
        <div class="modal-footer" style="background: white; border-top: 1px solid #e2e8f0; padding: 15px 30px; border-radius: 0 0 8px 8px;">
            <button type="button" class="btn btn-danger" onclick="closeActionGridModal()" style="padding: 8px 24px;">Fechar</button>
        </div>
    </div>
</div>

<div id="modalDetalhes" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 90%; border-radius: 8px;">
        
        <div class="modal-detailed-header">
            <div class="modal-top-bar">
                <h3 id="detalheTitulo" style="font-size: 16px; font-weight: 700; margin: 0; color: #333;">
                    </h3>
                <div class="modal-actions-top">
                    <button class="btn-circle-action" title="Mais opções" onclick="openOptionsFromDetails()">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    
                    <button class="btn-circle-action close-red" onclick="closeModalDetalhes()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="modal-tabs">
                <div class="modal-tab active">AÇÕES</div>
                <div class="modal-tab">RESOLUÇÃO</div>
                <div class="modal-tab">HISTÓRICO</div>
                <div class="modal-tab">FÓRUM</div>
                <div class="modal-tab">FERRAMENTA</div>
            </div>
        </div>

        <div class="modal-detailed-body">
            
            <div id="tab-acoes" class="tab-content-panel active">
                <div class="form-grid">
                    <div class="form-group"><label>ID do Plano</label><div id="detalheId" class="form-value-box"></div></div>
                    <div class="form-group"><label>ID da Auditoria</label><div id="detalheIdAuditoria" class="form-value-box"></div></div>
                    <div class="form-group"><label>Status Atual</label><div id="detalheStatus" class="form-value-box" style="font-weight: bold;"></div></div>
                    <div class="form-group"><label>Responsável</label><div id="detalheResponsavel" class="form-value-box"></div></div>
                    <div class="form-group"><label>Auditor</label><div id="detalheAuditor" class="form-value-box"></div></div>
                    <div class="form-group"><label>Categoria</label><div id="detalheCategoria" class="form-value-box"></div></div>
                    <div class="form-group"><label>Local</label><div id="detalheLocal" class="form-value-box"></div></div>
                    <div class="form-group"><label>Data Início</label><div id="detalheDataInicio" class="form-value-box"></div></div>
                    <div class="form-group"><label>Data Final</label><div id="detalheDataFim" class="form-value-box"></div></div>
                    <div id="grupoOrientacoesExtra" class="form-group full-width" style="display: none; margin-top: 10px;">
                    <label style="color: #2311c0;">Orientações Adicionais (Clonagem)</label>
                    <div id="detalheOrientacoesExtra" class="form-value-box textarea-style" style="background-color: #fff5f5; border-color: #fed7d7; color: #9b2c2c;">
                        </div>
                </div>
                </div>
            </div>

            <div id="tab-resolucao" class="tab-content-panel">
                <div class="resolution-container">
                    
                    <div class="context-section">
                        <div class="section-title" style="color: #b91c1c;">
                            <i class="fas fa-exclamation-circle"></i> O Que Foi Encontrado (Contexto)
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Item da Auditoria (Pergunta)</label>
                            <div id="resPergunta" class="form-value-box" style="background: #fff; border-color: #fecaca;">Carregando...</div>
                        </div>

                        <div class="form-group full-width" style="margin-top: 10px;">
                            <label>Observação do Auditor</label>
                            <div id="resObservacao" class="form-value-box textarea-style" style="min-height: 60px; background: #fff;">-</div>
                        </div>

                        <div style="margin-top: 10px;">
                            <label style="font-size: 12px; font-weight: 600; color: #333;">Evidências (Fotos da Auditoria)</label>
                            <div id="resEvidencias" class="evidence-gallery">
                                <span style="font-size: 12px; color: #666; font-style: italic;">Nenhuma evidência anexada na auditoria.</span>
                            </div>
                        </div>
                    </div>

                    <div class="solution-section">
                        <div class="section-title" style="color: #15803d;">
                            <i class="fas fa-tools"></i> Tratativa / Resolução
                        </div>

                        <form id="formTratativa">
                            <div class="form-group full-width">
                                <label for="inputCausaRaiz">Análise de Causa Raiz</label>
                                <textarea id="inputCausaRaiz" class="form-control" rows="3" readonly 
                                          style="background-color: #f1f5f9; color: #555; cursor: not-allowed;"
                                          placeholder="Aguardando preenchimento no aceite..."></textarea>
                            </div>

                            <div class="form-group full-width" style="margin-top: 15px;">
                                <label>Ações Propostas (Planejamento)</label>
                                <textarea id="inputAcoes" class="form-control" rows="3" readonly style="background-color: #f1f5f9; color: #555;"></textarea>
                            </div>

                            <div class="form-grid" style="margin-top: 15px;">
                                <div class="form-group">
                                    <label>Data Finalização - Prevista</label>
                                    <input type="date" id="inputDataPrevista" class="form-control" readonly style="background-color: #f1f5f9; color: #555;">
                                </div>

                                <div class="form-group full-width" style="margin-top: 15px;">
                                    <label style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 8px;">Investimentos Realizados</label>
                                    
                                    <div id="listaInvestimentosVisual" style="display: flex; flex-direction: column; gap: 15px;">
                                        </div>
                                    
                                    <div id="totalizadorInvestimentos" style="text-align: right; margin-top: 10px; font-weight: 700; color: #15803d; display: none;">
                                        Total Geral: R$ <span id="valorTotalGeral">0,00</span>
                                    </div>
                                </div>

                                <div class="form-group full-width" style="margin-top: 15px;">
                                <label style="color: #15803d; font-weight: 700;">Ações Realizadas (Execução)</label>
                                <textarea id="inputAcoesRealizadas" class="form-control" rows="3" readonly 
                                          style="background-color: #f0fdf4; border-color: #bbf7d0; color: #166534;" 
                                          placeholder="Aguardando conclusão..."></textarea>
                                </div>
                                
                                <div class="form-group full-width" style="margin-top: 15px;">
                                    <label style="font-size: 13px; font-weight: 700; color: #333;">
                                        <i class="fas fa-paperclip"></i> Evidências de Conclusão (Anexadas)
                                    </label>
                                    
                                    <div id="listaEvidenciasLeitura" style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">
                                        <span style="font-size: 12px; color: #999;">Carregando...</span>
                                    </div>
                                </div>
                            </div>
                            
                        </form>
                    </div>

                </div>
            </div>

            <div id="tab-historico" class="tab-content-panel">
                <div id="timelineContainer" class="timeline">
                    <span style="margin-left: 30px; color: #999;">Carregando histórico...</span>
                </div>
            </div>
            <div id="tab-forum" class="tab-content-panel" style="height: 100%;">
                <div class="forum-container">
                    
                    <div style="padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 14px; font-weight: 700; color: #333;">Fórum de Mensagens</h4>
                    </div>

                    <div id="forumMessagesArea" class="forum-messages-area">
                        <div style="text-align: center; color: #999; margin-top: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando mensagens...
                        </div>
                    </div>

                    <div class="forum-input-area">
                        <input type="text" id="forumInputMsg" class="form-control" placeholder="Mensagem" 
                               onkeypress="if(event.key === 'Enter') enviarMensagemForum()">
                        
                        <button type="button" onclick="enviarMensagemForum()" class="btn-send-forum">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                </div>
            </div>
            <div id="tab-ferramenta" class="tab-content-panel">...</div>

        </div>
    </div>
</div>
<div id="modalArquivar" class="modal">
    <div class="modal-content" style="max-width: 600px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Arquivar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <div class="input-wrapper-archive">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <label for="motivoArquivamento" style="font-size: 14px; color: #555;">Motivo do arquivamento</label>
                    <span id="charCounter" style="font-size: 12px; color: #22c55e; font-weight: bold;">0/255</span>
                </div>
                
                <div class="textarea-container">
                    <textarea id="motivoArquivamento" maxlength="255" placeholder="Digite o motivo..." oninput="updateCharCount(this)"></textarea>
                    <i class="fas fa-check" id="checkIcon" style="display: none; color: #22c55e; position: absolute; right: 10px; top: 10px;"></i>
                </div>
            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff;">
            <button type="button" onclick="closeArchiveModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarArquivar" onclick="submitArquivamento()" disabled 
                    style="background-color: #2311c0; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Arquivar
            </button>
        </div>
    </div>
</div>
<div id="modalAceitarAcao" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formAceitarAcao">
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label for="causaRaizAceitar" style="font-size: 14px; color: #555; font-weight: 600;">
                            Análise de Causa Raiz
                        </label>
                    </div>
                    <textarea id="causaRaizAceitar" class="form-control" rows="3" 
                              style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"
                              placeholder="Descreva a causa raiz do problema (ex: Utilize a técnica dos 5 Porquês)..."></textarea>
                    <small style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div class="input-wrapper-archive" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label for="acoesPropostas" style="font-size: 14px; color: #555;">Ações Propostas</label>
                        <span id="charCounterAceitar" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="acoesPropostas" class="form-control" rows="4" maxlength="255" 
                                  placeholder="Descreva as ações que serão realizadas..."
                                  oninput="updateCharCountAceitar(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconAceitar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="dataFinalizacaoPrevista" style="font-size: 14px; color: #555;">Data de Finalização Prevista</label>
                    <input type="date" id="dataFinalizacaoPrevista" class="form-control" required>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="checkFluxoSimplificado" style="width: 18px; height: 18px; margin-top: 2px; accent-color: #16a34a;">
                        <div>
                            <span style="font-weight: 600; color: #166534; font-size: 14px;">Fluxo Simplificado</span>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #15803d;">
                                Marque se esta ação for simples e não necessitar de validação ou aprovação posterior do auditor.
                                Ao concluir, a ação será finalizada automaticamente.
                            </p>
                        </div>
                    </label>
                </div>

                <div style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                    <div style="padding: 15px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                         onclick="toggleEvidenciasAceitar()">
                        <span style="font-weight: 600; color: #333;">Evidências</span>
                        <i class="fas fa-chevron-down" id="iconEvidencias"></i>
                    </div>
                    <div id="containerEvidenciasAceitar" style="padding: 20px; display: none; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>Adicionar evidência</span>
                            <button type="button" class="btn btn-primary btn-sm" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: #b91c1c; border-color: #b91c1c;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">(Funcionalidade de upload em breve)</p>
                    </div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeAceitarModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            

            <button type="button" id="btnConfirmarAceite" onclick="submitAceitarAcao('CONFIRMAR')" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalAprovarPlano" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <div style="margin-bottom: 20px;">
                <h5 style="font-size: 16px; font-weight: 700; color: #333; margin-bottom: 10px;">Ação Proposta</h5>
                <p id="textoAcaoProposta" style="font-size: 14px; color: #555; background: #f8fafc; padding: 10px; border-radius: 4px; border: 1px solid #e2e8f0;">
                    Carregando...
                </p>
            </div>
            
            <p style="font-size: 15px; color: #333;">
                Deseja confirmar novo prazo proposto para o dia <strong id="textoDataProposta">...</strong>?
            </p>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeAprovarModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarAprovacao" onclick="submitAprovacaoAuditor()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalInvestir" class="modal">
    <div class="modal-content" style="max-width: 900px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Investir</h3>
            
            <button type="button" onclick="adicionarLinhaInvestimento()" title="Adicionar novo item" 
                    style="background: #2311c0; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div style="padding: 20px; background-color: #f8fafc; max-height: 70vh; overflow-y: auto;">
            <form id="formInvestir">
                <div id="containerInvestimentos"></div>
            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <div style="margin-right: auto; display: flex; align-items: center; font-weight: 700; color: #333;">
                Total Geral: <span id="totalGeralInvest" style="margin-left: 5px; color: #15803d;">R$ 0,00</span>
            </div>

            <button type="button" onclick="closeInvestirModal()" style="background: #fff; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Fechar
            </button>
            
            <button type="button" onclick="submitInvestimentoEmLote()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Salvar Investimentos
            </button>
        </div>
    </div>
</div>
<div id="modalConcluir" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação (Conclusão)</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formConcluir">
                
                <div class="input-wrapper-archive" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Ações realizadas</label>
                        <span id="charCounterConcluir" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="acoesRealizadas" class="form-control" rows="4" maxlength="255" 
                                  placeholder="Descreva o que foi feito..."
                                  oninput="updateCharCountConcluir(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconConcluir" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroAcoes" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; background: #fff;">
                    <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #333;">Evidências</span>
                        <i class="fas fa-chevron-down" style="color: #666;"></i>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 14px; color: #555;">Adicionar evidência</span>
                            
                            <button type="button" onclick="document.getElementById('inputEvidenciasFile').click()" 
                                    style="width: 36px; height: 36px; background-color: #2311c0; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="file" id="inputEvidenciasFile" multiple style="display: none;" onchange="handleFileSelect(this)">
                        </div>

                        <div id="listaArquivosUpload" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
                        <small id="msgErroEvidencias" style="color: #ef4444; font-size: 11px; display: none;">É obrigatório anexar pelo menos uma evidência.</small>
                    </div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeConcluirModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>

            <button type="button" id="btnConfirmarConclusao" onclick="submitConclusao()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>

<div id="modalFinalizar" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Finalizar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <div style="display: flex; flex-direction: column; gap: 15px;">
                
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="radio" name="decisaoFinal" value="finalizar" checked 
                           style="accent-color: #2311c0; width: 18px; height: 18px;">
                    <span style="font-size: 15px; font-weight: 600; color: #333;">Finalizar Ação</span>
                </label>

                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="radio" name="decisaoFinal" value="eficacia" 
                           style="accent-color: #2311c0; width: 18px; height: 18px;">
                    <span style="font-size: 15px; font-weight: 600; color: #333;">Enviar para Validação de Eficácia</span>
                </label>

            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeFinalizarModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarFinalizacao" onclick="submitDecisaoAuditor()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalEficacia" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formEficacia">
                
                <div class="input-wrapper-archive" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Observações da eficácia</label>
                        <span id="charCounterEficacia" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="obsEficacia" class="form-control" rows="4" maxlength="255" 
                                  placeholder="Descreva a eficácia da ação..."
                                  oninput="updateCharCountEficacia(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconEficacia" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroEficacia" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; background: #fff;">
                    <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #333;">Evidências</span>
                        <i class="fas fa-chevron-down" style="color: #666;"></i>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 14px; color: #555;">Adicionar evidência</span>
                            
                            <button type="button" onclick="document.getElementById('inputEvidenciasEficacia').click()" 
                                    style="width: 36px; height: 36px; background-color: #2311c0; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="file" id="inputEvidenciasEficacia" multiple style="display: none;" onchange="handleFileSelectEficacia(this)">
                        </div>

                        <div id="listaArquivosEficacia" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
                    </div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeEficaciaModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarEficacia" onclick="submitEficacia()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalRecusar" class="modal">
    <div class="modal-content" style="max-width: 600px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Recusar / Devolver</h3>
        </div>

        <div style="padding: 30px;">
            <div class="input-wrapper-archive">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <label style="font-size: 14px; color: #555;">Motivo da recusa</label>
                    <span id="charCounterRecusar" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                </div>
                
                <div class="textarea-container">
                    <textarea id="motivoRecusa" class="form-control" rows="4" maxlength="255" 
                              placeholder="Descreva o motivo..." 
                              style="border-color: #ef4444;"
                              oninput="updateCharCountRecusar(this)"></textarea>
                    <i class="fas fa-exclamation-circle" id="errorIconRecusar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                </div>
                <small id="msgErroRecusa" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff;">
            <button type="button" onclick="closeRecusarModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarRecusa" onclick="submitRecusa()" disabled 
                    style="background-color: #2311c0; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                Confirmar Descarte
            </button>
        </div>
    </div>
</div>
<div id="modalClonar" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Solicitar mais ações</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formClonar">
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-size: 14px; color: #555;">Novo responsável</label>
                    <select id="clonarResponsavel" class="form-control" style="border-color: #22c55e; color: #555;">
                        <option value="">Selecione um item</option>
                        {% for u in usuarios_ativos %}
                            <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }} ({{ u.username }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-wrapper-archive">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Novas orientações</label>
                        <span id="charCounterClonar" style="font-size: 12px; color: #b91c1c; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="clonarOrientacoes" class="form-control" rows="5" maxlength="255" 
                                  style="border-color: #ef4444;"
                                  oninput="updateCharCountClonar(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconClonar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroClonar" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeClonarModal()" style="background: #f8fafc; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Fechar
            </button>
            
            <button type="button" id="btnConfirmarClonar" onclick="submitClonar()" disabled
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                Clonar
            </button>
        </div>
    </div>
</div>
<div id="modalAlterarPrazo" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Alterar data de encerramento</h3>
        </div>

        <div style="padding: 30px;">
            <div class="form-group">
                <label for="novaDataEncerramento" style="font-size: 14px; color: #555; margin-bottom: 8px; display: block;">Nova data de encerramento</label>
                <input type="date" id="novaDataEncerramento" class="form-control" 
                       style="border: 1px solid #93c5fd; padding: 10px; border-radius: 6px; width: 100%; outline: none; transition: box-shadow 0.2s;">
            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closePrazoModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarPrazo" onclick="submitNovoPrazo()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalRedirecionar" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Redirecionar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formRedirecionar">
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="font-size: 14px; color: #555;">De:</label>
                        <div id="txtResponsavelAtual" style="padding: 10px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 4px; color: #333;">
                            -
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="font-size: 14px; color: #555;">Para:</label>
                        <select id="selNovoResponsavel" class="form-control" style="border-color: #22c55e; color: #555;">
                            <option value="">Selecione um item</option>
                            {% for u in usuarios_ativos %}
                                <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="input-wrapper-archive">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Ações sugeridas</label>
                        <span id="charCounterRedirecionar" style="font-size: 12px; color: #b91c1c; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="txtAcoesSugeridas" class="form-control" rows="5" maxlength="255" 
                                  style="border-color: #ef4444;"
                                  oninput="updateCharCountRedirecionar(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconRedirecionar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroRedirecionar" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeRedirecionarModal()" style="background: #f8fafc; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Cancelar
            </button>
            
            <button type="button" id="btnConfirmarRedirecionar" onclick="submitRedirecionar()" disabled
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalNovoPlano" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Criar Ação</h3>
        </div>

        <div style="padding: 30px; background-color: #fff;">
            <form id="formNovoPlano" enctype="multipart/form-data">
                
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="date-input-group">
                        <div class="date-icon-box success"><i class="far fa-calendar-alt"></i></div>
                        <div style="flex: 1;">
                            <label class="date-label">Início</label>
                            <input type="date" name="data_inicio" class="date-clean-input" value="{% now 'Y-m-d' %}">
                        </div>
                    </div>

                    <div class="date-input-group">
                        <div class="date-icon-box danger"><i class="far fa-calendar-times"></i></div>
                        <div style="flex: 1;">
                            <label class="date-label">Final (Previsão)</label>
                            <input type="date" name="data_fim" class="date-clean-input">
                        </div>
                    </div>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Título <span style="color:red">*</span></label>
                        <span class="counter" id="countTitulo">0/255</span>
                    </div>
                    <input type="text" name="titulo" id="newTitulo" class="input-clean" maxlength="255" placeholder="Digite o título da ação" oninput="updateCounter(this, 'countTitulo')">
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Categoria <span style="color:red">*</span></label>
                    </div>
                    <select name="categoria" id="newCategoria" class="input-clean">
                        <option value="">Selecione a categoria...</option>
                        {% for cat in categorias %}
                            <option value="{{ cat.id }}">{{ cat.descricao }} ({{ cat.pilar.nome }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Observação <span style="color:red">*</span></label>
                    </div>
                    <div class="textarea-container">
                        <div style="border-bottom: 1px solid #eee; padding: 5px; background: #fafafa; display: flex; gap: 10px;">
                            <i class="fas fa-bold" style="color: #666; font-size: 12px;"></i>
                            <i class="fas fa-italic" style="color: #666; font-size: 12px;"></i>
                            <i class="fas fa-list-ul" style="color: #666; font-size: 12px;"></i>
                        </div>
                        <textarea name="observacao" class="input-clean textarea-clean" rows="5" style="border-top: none; border-radius: 0 0 4px 4px;" placeholder="Descreva os detalhes da ação..."></textarea>
                    </div>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Responsável <span style="color:red">*</span></label>
                    </div>
                    <select name="responsavel" id="newResponsavel" class="input-clean">
                        <option value="">Selecione...</option>
                        {% for u in usuarios_ativos %}
                            <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px;">
                    <div class="input-wrapper-clean">
                        <div class="label-row">
                            <label>Nível</label>
                        </div>
                        <select name="nivel" id="newNivel" class="input-clean" onchange="filtrarLocais()">
                            <option value="todos">Todos</option>
                            <option value="EMPRESA">Empresa</option>
                            <option value="AREA">Área</option>
                            <option value="SETOR">Setor</option>
                            <option value="SUBSETOR" selected>Subsetor</option>
                        </select>
                    </div>

                    <div class="input-wrapper-clean">
                        <div class="label-row">
                            <label>Local (Subsetor)</label>
                        </div>
                        <select name="local" id="newLocal" class="input-clean">
                            <option value="">Selecione um item</option>
                            {% for sub in subsetores %}
                                <option value="{{ sub.id }}">{{ sub.nome }} ({{ sub.setor.area.empresa.nome }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Anexos</label>
                    </div>
                    <div class="file-upload-box" onclick="document.getElementById('newFiles').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Clique para fazer upload de arquivos</span>
                        <input type="file" id="newFiles" name="arquivos" multiple style="display: none;" onchange="updateFileList(this)">
                    </div>
                    <div id="newFileList" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeModalNovoPlano()" style="background: transparent; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">Cancelar</button>
            <button type="button" onclick="submitNovoPlano()" style="background-color: #b91c1c; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">Salvar</button>
        </div>
    </div>
</div>
{% endblock search_form %}


{# --- CABEÇALHOS DA TABELA --- #}
{% block table_headers %}
    <tr>
        <th style="width: 100px; text-align: center;">Ações</th> 
        <th style="width: 80px;">ID Plano</th>
        <th style="width: 100px;">ID Auditoria</th>
        <th>Título (Pergunta)</th>
        <th>Tipo</th>
        <th>Auditor</th>
        <th>Responsável</th>
        <th>Local</th>
        <th>Ferramenta</th>
        <th>Categoria</th>
        <th>Data Abertura</th>
        <th>Prazo</th>
        <th>Data Encerramento</th>
        <th style="width: 80px;">Chat</th>
    </tr>
    <tr class="filter-row">
        <th></th> 
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1" value="{{ searches.id|default:'' }}"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2" value="{{ searches.auditoria_id|default:'' }}"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="4"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="5"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="6"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="7"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="8"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="9"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="10"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="11"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="12"></th>
        <th></th> 
    </tr>
{% endblock %}

{# --- LINHAS DA TABELA (SEM DEBUG) --- #}
{% block table_row %}
    {# --- CÉLULA 1: Ações (Status + Engrenagem) --- #}
    <td style="padding: 0; height: 1px; position: relative;">
        
        <div class="status-action-wrapper">
            {# 1. Barra Lateral: Abre Modal Padrão #}
            <div class="status-bar status-{{ object.status_plano|default:'ABERTO' }}" 
                    data-tooltip="{{ object.get_status_plano_display|default:'Recebido'|abreviar_status }}"
                    style="cursor: pointer;"
                    {# ADICIONADO O 4º PARÂMETRO: ID DA AUDITORIA #}
                    onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
            </div>

            {# 2. Engrenagem: Abre NOVO Modal #}
            <div class="gear-wrapper">
                <button type="button" class="btn-gear" title="Detalhes do Plano" 
                    style="cursor: pointer; border: 1px solid #e0e0e0; background: white;"
                    
                    data-id="{{ object.id }}"
                    data-id-auditoria="{{ object.origem_resposta.auditoria_instancia.id|default:'-' }}" 
                    
                    {# --- MUDANÇA 1: Adicionado Status CODE e Display --- #}
                    data-status="{{ object.get_status_plano_display }}"
                    data-status-code="{{ object.status_plano }}" 
                    
                    {# --- MUDANÇA 2: Adicionado ID do Responsável --- #}
                    data-responsavel-id="{{ object.responsavel_acao.id }}"
                    data-responsavel="{{ object.responsavel_acao.get_full_name|default:object.responsavel_acao.username }}"
                    
                    data-auditor="{% if object.origem_resposta %}{{ object.origem_resposta.auditoria_instancia.responsavel.get_full_name|default:'Sistema' }}{% elif object.criado_por %}{{ object.criado_por.get_full_name|default:object.criado_por.username }}{% else %}Sistema{% endif %}"
                    data-solicitante="{{ object.solicitante.get_full_name|default:'-' }}" 
                    data-id-form="{{ object.origem_resposta.auditoria_instancia.modelo.id|default:'-' }}" 
                    data-categoria="{{ object.categoria.descricao|default:'-' }}"
                    data-local="{{ object.local_execucao.nome|default:'-' }}"
                    data-inicio="{{ object.data_abertura|date:'d/m/Y' }}"
                    data-fim="{{ object.prazo_conclusao|date:'d/m/Y' }}"
                    data-titulo-pergunta="{{ object.titulo|escapejs }}"
                    data-titulo-modal="{{ object.id }} - {{ object.get_tipo_display }}" 
                    data-orientacoes-extra="{{ object.orientacoes_extra|default:''|escapejs }}"
                    data-origem-orientacao="{{ object.origem_orientacao|default:'CLONAGEM' }}" 

                    onclick="openDetailedModal(event, this)">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </td>
    
    {# --- DEMAIS CÉLULAS: Adicionado o 4º parâmetro (ID Auditoria) --- #}
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.id }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.origem_resposta.auditoria_instancia.id }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.titulo|truncatechars:40 }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {% if object.tipo == 'NAO_CONFORMIDADE' %}
            <span class="badge badge-error" style="font-size: 10px;">NC</span>
        {% else %}
            <span class="badge badge-success" style="font-size: 10px;">OM</span>
        {% endif %}
    </td>

    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {% if object.origem_resposta %}
            {{ object.origem_resposta.auditoria_instancia.responsavel.get_full_name|default:"-" }}
        {% else %}
            {# Se for manual, verifica se tem criado_por #}
            {% if object.criado_por %}
                {{ object.criado_por.get_full_name|default:object.criado_por.username }}
            {% else %}
                Sistema
            {% endif %}
        {% endif %}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.responsavel_acao.get_full_name|default:object.responsavel_acao.username|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.local_execucao.nome|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        <span class="badge badge-secondary" style="font-size: 10px;">{{ object.ferramenta.nome|default:"-" }}</span>
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.categoria.descricao|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.data_abertura|date:"d/m/Y" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.prazo_conclusao|date:"d/m/Y"|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.data_conclusao|date:"d/m/Y"|default:"-" }}
    </td>
    
    <td>
        {% if object.forum %}
            <button type="button" class="btn btn-secondary btn-icon js-open-chat" title="Abrir Chat" data-forum-id="{{ object.forum.id }}">
                <i class="fas fa-comments"></i>
            </button>
        {% else %}
            <button type="button" class="btn btn-secondary btn-icon" disabled style="opacity: 0.5;">
                <i class="fas fa-comments"></i>
            </button>
        {% endif %}
    </td>
{% endblock %}



{# --- SCRIPTS JS (Mantidos no final) --- #}
{% block extra_js %}
    {{ block.super }}
    <script>
    // Pega o ID do usuário logado do Django
    const currentUserId = "{{ request.user.id }}";
    let currentPlanContext = {};
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Script da Lista de Planos de Ação Carregado.");

        // --- Lógica de Filtros da Tabela ---
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        
        if (table) {
            const tableBody = table.querySelector('tbody');
            if (tableBody) {
                function applyTableFilters() {
                    const dataRows = tableBody.querySelectorAll('tr');
                    if (dataRows.length === 0) return;
                    
                    dataRows.forEach(row => {
                        let isRowVisible = true;
                        const cells = row.querySelectorAll('td');
                        if (cells.length === 0) return; 

                        filters.forEach(filter => {
                            const filterText = filter.value.toLowerCase().trim();
                            const colIndex = parseInt(filter.dataset.columnIndex, 10);
                            if (filterText) {
                                const cell = cells[colIndex];
                                if (cell) {
                                    const cellText = cell.textContent.toLowerCase().trim();
                                    if (!cellText.includes(filterText)) {
                                        isRowVisible = false;
                                    }
                                }
                            }
                        });
                        row.style.display = isRowVisible ? '' : 'none';
                    });
                }

                if (filters.length > 0) {
                    filters.forEach(filter => {
                        filter.addEventListener('input', applyTableFilters);
                    });
                }
                applyTableFilters();
            }
        }

        // --- LÓGICA DO CHAT ---
        const chatButtons = document.querySelectorAll('.js-open-chat');
        chatButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const forumId = this.dataset.forumId;
                if (typeof window.openChat === 'function') {
                    window.openChat(forumId);
                } else {
                    alert("Erro no sistema: Função de chat não carregada.");
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Adiciona evento de clique nas abas
        const tabs = document.querySelectorAll('.modal-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // 1. Remove ativo de todas as abas e painéis
                document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content-panel').forEach(p => p.classList.remove('active'));
                
                // 2. Ativa a aba clicada
                this.classList.add('active');
                
                // 3. Mostra o painel correspondente
                // Normaliza o texto para remover acentos (FÓRUM -> forum) e minúsculas
                const tabName = this.textContent.trim().toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
                
                const panelId = `tab-${tabName}`;
                const panel = document.getElementById(panelId);
                if(panel) panel.classList.add('active');

                // --- CORREÇÃO AQUI ---
                // Verifica "FÓRUM" (com acento) OU normaliza a comparação
                const textoAba = this.textContent.trim().toUpperCase();
                
                if (textoAba === 'FÓRUM' || textoAba === 'FORUM') {
                    if (activeForumId) {
                        carregarMensagensForum();
                    } else {
                        // Se não tiver ID ainda, tenta pegar do contexto global salvo ao abrir o modal
                        if(currentPlanContext && currentPlanContext.id) {
                             // Uma pequena contingência: recarrega os detalhes para garantir o ID do fórum
                             carregarDadosResolucao(currentPlanContext.id);
                        } else {
                             document.getElementById('forumMessagesArea').innerHTML = '<div style="text-align:center; padding:20px;">Fórum não disponível.</div>';
                        }
                    }
                }
            });
        });
    });

    // Variável global para armazenar o ID atual
    let currentActionId = null; 

    // --- FUNÇÕES DE MODAIS ---

    // --- Atualização: Adicionados responsavelId e responsavelNome ---
    function openStandardModal(id, titulo, status, auditoriaId, responsavelId, responsavelNome) {
        openActionGrid(id, titulo, status, auditoriaId, responsavelId, responsavelNome);
    }

    function openActionGrid(id, titulo, status, auditoriaId, responsavelId, responsavelNome) { // <--- CORREÇÃO AQUI: Adicionados os argumentos que faltavam
        currentActionId = id; 
        
        const modal = document.getElementById('actionGridModal');
        const titleEl = document.getElementById('modalActionTitle');
        const btnInvestir = document.getElementById('btnInvestir');
        const btnRelatorio = document.getElementById('btnRelatorio');
        const btnExportar = document.getElementById('btnExportar');
        const btnArquivar = document.getElementById('btnArquivar');
        const btnRedirecionar = document.getElementById('btnRedirecionar');
        const btnPrazo = document.getElementById('btnPrazo');
    
        // Configura Botão Arquivar
        const newBtnArquivar = btnArquivar.cloneNode(true);
        btnArquivar.parentNode.replaceChild(newBtnArquivar, btnArquivar);
        newBtnArquivar.onclick = function() {
            closeActionGridModal();
            openArchiveModal();
        };

        // Configura Botão Prazo
        const newBtnPrazo = btnPrazo.cloneNode(true);
        btnPrazo.parentNode.replaceChild(newBtnPrazo, btnPrazo);
        newBtnPrazo.onclick = function() {
            openPrazoModal();
        };
        
        // Configura Botão Clonar
        const btnClonar = document.getElementById('btnClonar');
        const newBtnClonar = btnClonar.cloneNode(true);
        btnClonar.parentNode.replaceChild(newBtnClonar, btnClonar);
        newBtnClonar.onclick = function() {
             openClonarModal();
        };

        // --- LÓGICA DE VISIBILIDADE DO REDIRECIONAR ---
        // Agora 'responsavelId' existe e não vai dar erro
        if (currentUserId == responsavelId && status !== 'CONCLUIDO' && status !== 'CANCELADO') {
            btnRedirecionar.style.display = 'flex';
            
            const newBtn = btnRedirecionar.cloneNode(true);
            btnRedirecionar.parentNode.replaceChild(newBtn, btnRedirecionar);
            
            newBtn.onclick = function() {
                openRedirecionarModal(responsavelNome);
            };
        } else {
            btnRedirecionar.style.display = 'none';
        }

        titleEl.textContent = `Plano #${id} - ${titulo}`;

        // Lógica de Visibilidade do Botão Investir
        if (status === 'EM_IMPLEMENTACAO') {
            btnInvestir.style.display = 'flex';
            
            const newBtnInvestir = btnInvestir.cloneNode(true);
            btnInvestir.parentNode.replaceChild(newBtnInvestir, btnInvestir);
            
            newBtnInvestir.onclick = function() {
                openInvestirModal();
            };
        } else {
            btnInvestir.style.display = 'none';
        }
        
        // Configura Botão Relatório
        if (auditoriaId && auditoriaId !== 'None' && auditoriaId !== '') {
            btnRelatorio.href = `/auditorias/historico/${auditoriaId}/visualizar`; 
            btnRelatorio.target = '_blank';
            btnRelatorio.style.pointerEvents = 'auto';
            btnRelatorio.style.opacity = '1';
        } else {
            btnRelatorio.href = '#';
            btnRelatorio.style.pointerEvents = 'none';
            btnRelatorio.style.opacity = '0.5';
        }

        btnExportar.href = 'javascript:void(0);';
        
        // --- LÓGICA DO BOTÃO ACEITAR ---
        const btnAceitar = document.getElementById('btnAceitar');
        const newBtnAceitar = btnAceitar.cloneNode(true);
        btnAceitar.parentNode.replaceChild(newBtnAceitar, btnAceitar);
        
        newBtnAceitar.onclick = function() {
            if (status === 'AGUARDANDO_VALIDACAO') {
                openAprovarModal(id); 
            } else if (status === 'EM_IMPLEMENTACAO') {
                openConcluirModal(); 
            } else if (status === 'AGUARDANDO_APROVACAO') {
                openFinalizarModal(); 
            } else if (status === 'VALIDACAO_EFICACIA') {
                openEficaciaModal(); 
            } else {
                openAceitarModal(); 
            }
        };
        
        newBtnAceitar.style.display = 'flex';

        // --- LÓGICA DO BOTÃO RECUSAR ---
        const btnRecusar = document.getElementById('btnRecusar');
        const newBtnRecusar = btnRecusar.cloneNode(true);
        btnRecusar.parentNode.replaceChild(newBtnRecusar, btnRecusar);
        
        newBtnRecusar.onclick = function() {
            openRecusarModal();
        };

        // EXIBE O MODAL
        modal.style.display = 'flex';
    }

    // --- NOVAS FUNÇÕES DE REDIRECIONAMENTO ---

    function openRedirecionarModal(nomeAtual) {
        closeActionGridModal();
        const modal = document.getElementById('modalRedirecionar');
        
        // Preenche o campo "De"
        document.getElementById('txtResponsavelAtual').textContent = nomeAtual || "Não definido";
        
        // Reset
        document.getElementById('selNovoResponsavel').value = "";
        document.getElementById('txtAcoesSugeridas').value = "";
        updateCharCountRedirecionar(document.getElementById('txtAcoesSugeridas'));
        
        modal.style.display = 'flex';
    }

    function closeRedirecionarModal() {
        document.getElementById('modalRedirecionar').style.display = 'none';
    }

    function updateCharCountRedirecionar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterRedirecionar').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarRedirecionar');
        const icon = document.getElementById('errorIconRedirecionar');
        const msg = document.getElementById('msgErroRedirecionar');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e';
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        }
    }

    function submitRedirecionar() {
        const novoResp = document.getElementById('selNovoResponsavel').value;
        const acoes = document.getElementById('txtAcoesSugeridas').value;

        if (!novoResp) {
            showToast("Selecione o novo responsável.", "error");
            return;
        }
        if (!acoes.trim()) {
            showToast("Ações sugeridas são obrigatórias.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarRedirecionar');
        btn.disabled = true;
        btn.innerText = "Redirecionando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/redirecionar/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                novo_responsavel: novoResp,
                acoes_sugeridas: acoes
            })
        })
        .then(async response => {
            if (response.ok) {
                closeRedirecionarModal();
                showToast("Ação redirecionada com sucesso!", "success");
                setTimeout(() => window.location.reload(), 1500);
            } else {
                throw new Error("Erro ao redirecionar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar solicitação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    const btnRecusar = document.getElementById('btnRecusar');
    
    // Clonar para limpar eventos anteriores
    const newBtnRecusar = btnRecusar.cloneNode(true);
    btnRecusar.parentNode.replaceChild(newBtnRecusar, btnRecusar);
    
    newBtnRecusar.onclick = function() {
        openRecusarModal();
    };
    
    /* --------------------------------------------------------- */

    // --- Novas Funções para o Modal de Aprovação (Auditor) ---

    function openAprovarModal(id) {
        closeActionGridModal(); // Fecha o grid
        const modal = document.getElementById('modalAprovarPlano');
        
        // Carrega os dados do plano para mostrar ao auditor
        // Reutilizamos a API de detalhes que já criamos
        fetch(`/auditorias/planos-de-acao/api/${id}/detalhes/`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('textoAcaoProposta').textContent = data.plano_acao || "Nenhuma ação descrita.";
                
                // Formata a data para exibir bonito (dd/mm/yyyy)
                let dataFormatada = data.data_prevista;
                if(dataFormatada && dataFormatada.includes('-')) {
                    const parts = dataFormatada.split('-');
                    dataFormatada = `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
                document.getElementById('textoDataProposta').textContent = dataFormatada || "Sem data";
                
                modal.style.display = 'flex';
            })
            .catch(err => {
                console.error(err);
                showToast("Erro ao carregar dados do plano.", "error");
            });
    }

    function closeAprovarModal() {
        document.getElementById('modalAprovarPlano').style.display = 'none';
    }

    function submitAprovacaoAuditor() {
        if (!currentActionId) return;

        const btn = document.getElementById('btnConfirmarAprovacao');
        btn.disabled = true;
        btn.innerText = "Confirmando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/aprovar-planejamento/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({}) // Corpo vazio, a ação é apenas confirmar
        })
        .then(async response => {
            if (response.ok) {
                closeAprovarModal();
                showToast("Planejamento aprovado! Plano em implementação.", "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao aprovar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar aprovação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    function closeActionGridModal() {
        document.getElementById('actionGridModal').style.display = 'none';
    }

    // --- Modal Detalhes (Engrenagem) ---
    function openDetailedModal(event, btnElement) {
        event.stopPropagation(); 
        
        // Resetar para aba inicial
        document.querySelector('.modal-tab:first-child').click();

        const modal = document.getElementById('modalDetalhes');
        const data = btnElement.dataset;
        currentActionId = data.id; // Garante que temos o ID globalmente

        currentPlanContext = {
            id: data.id,
            titulo: data.tituloPergunta, // Usamos o título da pergunta para o modal de ações
            status: data.statusCode, // Importante: Usa o código (ex: EM_IMPLEMENTACAO)
            auditoriaId: data.idAuditoria,
            responsavelId: data.responsavelId,
            responsavelNome: data.responsavel
        };

        // Preencher Aba 1 (Ações) - Dados estáticos do botão
        document.getElementById('detalheTitulo').textContent = data.tituloModal;
        setText('detalheId', data.id);
        setText('detalheIdAuditoria', data.idAuditoria);
        setText('detalheStatus', data.status);
        setText('detalheResponsavel', data.responsavel);
        setText('detalheAuditor', data.auditor);
        setText('detalheCategoria', data.categoria);
        setText('detalheLocal', data.local);
        setText('detalheDataInicio', data.inicio);
        setText('detalheDataFim', data.fim);

        // Preencher Aba 2 (Resolução) - Dados via AJAX
        carregarDadosResolucao(data.id);

        const orientacoesExtra = btnElement.dataset.orientacoesExtra;
        const origemOrientacao = btnElement.dataset.origemOrientacao;
        const divExtra = document.getElementById('grupoOrientacoesExtra');
        const labelExtra = divExtra.querySelector('label');
        const boxExtra = document.getElementById('detalheOrientacoesExtra');
        
        if (orientacoesExtra && orientacoesExtra.trim() !== "") {
            boxExtra.textContent = orientacoesExtra;
            
            // --- ESTILO PADRÃO (AMARELO/LARANJA) PARA AMBOS ---
            labelExtra.style.color = "#f59e0b"; // Laranja título
            boxExtra.style.borderColor = "#fcd34d"; // Borda amarela
            boxExtra.style.backgroundColor = "#fffbeb"; // Fundo amarelo claro
            boxExtra.style.color = "#92400e"; // Texto laranja escuro

            // --- DEFINIR APENAS O TEXTO ---
            if (origemOrientacao === 'REDIRECIONAMENTO') {
                labelExtra.textContent = "Orientações Adicionais (Redirecionamento)";
            } else {
                // Caso seja CLONAGEM ou Padrão
                labelExtra.textContent = "Orientações Adicionais (Clonagem)";
            }

            divExtra.style.display = 'flex'; 
        } else {
            divExtra.style.display = 'none'; 
        }

        modal.style.display = 'flex';
    }

    let activeForumId = null; // Variável global para o chat

    // --- Função para buscar dados da Resolução (AJAX) ---
    function carregarDadosResolucao(planoId) {
        // --- 1. Referências aos Elementos ---
        const elPergunta = document.getElementById('resPergunta');
        const elObservacao = document.getElementById('resObservacao');
        const elEvidencias = document.getElementById('resEvidencias'); // Fotos da Auditoria (Origem)
        
        const elCausa = document.getElementById('inputCausaRaiz');
        const elAcoes = document.getElementById('inputAcoes'); 
        const elAcoesRealizadas = document.getElementById('inputAcoesRealizadas'); 
        const elDataPrevista = document.getElementById('inputDataPrevista');
        
        // Elemento NOVO de leitura de evidências
        const elListaEvidenciasLeitura = document.getElementById('listaEvidenciasLeitura'); 
        
        const elListaInvestimentos = document.getElementById('listaInvestimentosVisual');
        const elTotalInvestimentos = document.getElementById('totalizadorInvestimentos');

        // --- 2. Limpeza Inicial ---
        if(elPergunta) elPergunta.textContent = "Carregando...";
        if(elObservacao) elObservacao.textContent = "...";
        if(elEvidencias) elEvidencias.innerHTML = '<span class="spinner"></span>';
        
        if(elCausa) elCausa.value = "";
        if(elAcoes) elAcoes.value = "";
        if(elAcoesRealizadas) elAcoesRealizadas.value = "";
        if(elDataPrevista) elDataPrevista.value = "";
        
        // Limpa a lista de leitura
        if(elListaEvidenciasLeitura) elListaEvidenciasLeitura.innerHTML = '<span style="font-size:12px; color:#999;">Buscando arquivos...</span>';
        
        if(elListaInvestimentos) elListaInvestimentos.innerHTML = '<div style="padding:15px; text-align:center; color:#666;">Carregando...</div>';
        if(elTotalInvestimentos) elTotalInvestimentos.style.display = 'none';

        // --- 3. Busca de Dados ---
        fetch(`/auditorias/planos-de-acao/api/${planoId}/detalhes/`)
            .then(r => r.json())
            .then(data => {

                // --- PARTE F: HISTÓRICO ---
                const timelineContainer = document.getElementById('timelineContainer');
                
                if (data.historico && data.historico.length > 0) {
                    timelineContainer.innerHTML = ''; // Limpa
                    
                    data.historico.forEach(item => {
                        // Define ícone/cor baseado no tipo (opcional, refinamento visual)
                        let markerClass = `marker-${item.tipo}`;
                        
                        const htmlItem = `
                            <div class="timeline-item">
                                <div class="timeline-marker ${markerClass}"></div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <div class="timeline-author">
                                            <div class="timeline-avatar">${item.avatar}</div>
                                            ${item.usuario}
                                        </div>
                                        <div class="timeline-date">
                                            <i class="far fa-clock"></i> ${item.data} às ${item.hora}
                                        </div>
                                    </div>
                                    <div class="timeline-body">
                                        ${item.descricao}
                                    </div>
                                </div>
                            </div>
                        `;
                        timelineContainer.insertAdjacentHTML('beforeend', htmlItem);
                    });
                } else {
                    timelineContainer.innerHTML = `
                        <div style="padding: 30px; text-align: center; color: #94a3b8; margin-left: -20px;">
                            <i class="fas fa-history" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>Nenhum histórico registrado ainda.</p>
                        </div>
                    `;
                }
                
                // A. Contexto
                if(elPergunta) elPergunta.textContent = data.auditoria_pergunta;
                if(elObservacao) elObservacao.textContent = data.auditoria_observacao || "Sem observações.";
                
                // B. Evidências da Auditoria (Origem)
                if(elEvidencias) {
                    elEvidencias.innerHTML = '';
                    if (data.auditoria_evidencias && data.auditoria_evidencias.length > 0) {
                        data.auditoria_evidencias.forEach(foto => {
                            const img = document.createElement('img');
                            img.src = foto.url;
                            img.className = 'evidence-thumb';
                            img.title = foto.nome;
                            img.onclick = () => window.open(foto.url, '_blank');
                            elEvidencias.appendChild(img);
                        });
                    } else {
                        elEvidencias.innerHTML = '<span style="font-size:12px; color:#999;">Sem evidências.</span>';
                    }
                }

                // C. Campos de Texto
                if(elCausa) elCausa.value = data.causa_raiz || "Não preenchido";
                if(elAcoes) elAcoes.value = data.plano_acao || "Não preenchido"; 
                if(elAcoesRealizadas) elAcoesRealizadas.value = data.acoes_realizadas || "";
                if(elDataPrevista) elDataPrevista.value = data.data_prevista || "";

                // D. Evidências de Conclusão (LEITURA APENAS)
                if(elListaEvidenciasLeitura) {
                    elListaEvidenciasLeitura.innerHTML = ''; // Limpa o "Carregando..."
                    
                    if (data.evidencias_conclusao && data.evidencias_conclusao.length > 0) {
                        data.evidencias_conclusao.forEach(arq => {
                            // Cria um card visual simples para cada arquivo
                            const item = `
                                <div style="display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 12px; overflow: hidden;">
                                        <div style="width: 36px; height: 36px; background: #e0f2fe; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #0284c7;">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-size: 13px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">${arq.nome}</span>
                                            <span style="font-size: 11px; color: #64748b;">Evidência de conclusão</span>
                                        </div>
                                    </div>
                                    <a href="${arq.url}" target="_blank" class="btn btn-sm btn-secondary" style="text-decoration: none; padding: 6px 12px; font-size: 12px; border: 1px solid #cbd5e1; border-radius: 4px; color: #475569; display: flex; align-items: center; gap: 5px;">
                                        <i class="fas fa-download"></i> Baixar
                                    </a>
                                </div>
                            `;
                            elListaEvidenciasLeitura.insertAdjacentHTML('beforeend', item);
                        });
                    } else {
                        // Mensagem caso não tenha nada anexado ainda
                        elListaEvidenciasLeitura.innerHTML = `
                            <div style="padding: 15px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 6px; color: #94a3b8; font-size: 13px; text-align: center;">
                                <i class="fas fa-folder-open" style="margin-right: 6px;"></i> Nenhuma evidência foi anexada na conclusão.
                            </div>
                        `;
                    }
                }

                // E. Investimentos (Mantido)
                if(elListaInvestimentos) {
                    elListaInvestimentos.innerHTML = '';
                    if (data.investimentos && data.investimentos.length > 0) {
                        data.investimentos.forEach(inv => {
                            const valUnit = inv.valor_unitario.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            const valTotal = inv.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2});

                            const htmlItem = `
                                <div style="display: flex; gap: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; color: #555;">Descrição</label>
                                        <div class="form-value-box textarea-style" style="min-height: 80px; background-color: #e2e8f0; border: 1px solid #cbd5e1;">${inv.descricao}</div>
                                    </div>
                                    <div style="width: 200px; display: flex; flex-direction: column; gap: 8px;">
                                        <div>
                                            <label style="font-size: 12px; color: #555;">Valor Unitário</label>
                                            <div class="form-value-box" style="background-color: #e2e8f0;">R$ ${valUnit}</div>
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; color: #555;">Quantidade</label>
                                            <div class="form-value-box" style="background-color: #e2e8f0;">${inv.quantidade}</div>
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; color: #555;">Total</label>
                                            <div class="form-value-box" style="background-color: #e2e8f0; font-weight: bold;">R$ ${valTotal}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            elListaInvestimentos.insertAdjacentHTML('beforeend', htmlItem);
                        });

                        if (data.total_investido > 0 && elTotalInvestimentos) {
                            document.getElementById('valorTotalGeral').textContent = data.total_investido.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            elTotalInvestimentos.style.display = 'block';
                        }
                    } else {
                        elListaInvestimentos.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #94a3b8; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 6px;">
                                <i class="fas fa-search-dollar" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                                <p style="margin: 0; font-size: 13px;">Nenhum investimento registrado.</p>
                            </div>
                        `;
                    }
                }

                // SALVA O ID DO FÓRUM PARA O CHAT
                // Certifique-se de que sua view 'get_detalhes_plano' retorna 'forum_id'
                if (data.forum_id) {
                    activeForumId = data.forum_id;
                    // Se a aba de fórum já estiver ativa, carrega as mensagens
                    const abaForum = document.getElementById('tab-forum');
                    if (abaForum.classList.contains('active')) {
                        carregarMensagensForum();
                    }
                }
            })
            .catch(err => {
                console.error("Erro no carregamento:", err);
                if(elPergunta) elPergunta.textContent = "Erro ao carregar dados.";
            });
    }

    // --- Função Placeholder para Salvar Tratativa ---
    function salvarTratativa() {
        // Aqui você implementará o fetch POST para salvar os dados
        // Pode usar o ID global `currentActionId`
        showToast("Funcionalidade de salvar em desenvolvimento", "info");
        
        const causa = document.getElementById('inputCausaRaiz').value;
        const acao = document.getElementById('inputAcoes').value;
        console.log("Salvando:", causa, acao);
    }

    function setText(id, value) {
        const el = document.getElementById(id);
        if(el) el.textContent = value || '-';
    }

    function closeModalDetalhes() {
        document.getElementById('modalDetalhes').style.display = 'none';
    }

    // --- ARQUIVAMENTO ---

    function openArchiveModal() {
        const modal = document.getElementById('modalArquivar');
        const textarea = document.getElementById('motivoArquivamento');
        const btn = document.getElementById('btnConfirmarArquivar');
        
        // Reset
        textarea.value = '';
        textarea.classList.remove('valid');
        textarea.style.borderColor = '#dc2626'; // Vermelho inicial
        btn.disabled = true;
        
        document.getElementById('charCounter').textContent = '0/255';
        document.getElementById('checkIcon').style.display = 'none';
        
        modal.style.display = 'flex';
        textarea.focus();
    }

    // A FUNÇÃO QUE FALTAVA
    function closeArchiveModal() {
        const modal = document.getElementById('modalArquivar');
        if (modal) modal.style.display = 'none';
    }

    function updateCharCount(textarea) {
        const count = textarea.value.length;
        const counterEl = document.getElementById('charCounter');
        const checkIcon = document.getElementById('checkIcon');
        const btn = document.getElementById('btnConfirmarArquivar');
        
        counterEl.textContent = `${count}/255`;
        
        if (count > 0) {
            textarea.classList.add('valid');
            textarea.style.borderColor = '#22c55e'; // Verde
            checkIcon.style.display = 'block';
            btn.disabled = false;
        } else {
            textarea.classList.remove('valid');
            textarea.style.borderColor = '#dc2626'; // Vermelho
            checkIcon.style.display = 'none';
            btn.disabled = true;
        }
    }

    // --- FUNÇÃO PARA EXIBIR MENSAGEM TOAST ---
    function showToast(message, type = 'success') {
        // Cria o container se não existir
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }

        // Cria o elemento da notificação
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        
        // Ícone baseado no tipo
        const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
        
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                ${icon} <span>${message}</span>
            </div>
        `;

        container.appendChild(toast);

        // Remove automaticamente após 4 segundos
        setTimeout(() => {
            toast.style.animation = 'fadeOutRight 0.5s ease-out forwards';
            toast.addEventListener('animationend', () => {
                toast.remove();
            });
        }, 4000);
    }

    // --- FUNÇÃO DE ARQUIVAR ATUALIZADA ---
    function submitArquivamento() {
        const motivo = document.getElementById('motivoArquivamento').value;
        
        if (!currentActionId) {
            showToast("Erro: ID da ação não encontrado.", "error");
            return;
        }

        const url = `/auditorias/planos-de-acao/${currentActionId}/arquivar/`; 
        
        // Desativa o botão para evitar cliques duplos
        const btn = document.getElementById('btnConfirmarArquivar');
        btn.disabled = true;
        btn.textContent = "Arquivando...";

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ motivo: motivo })
        })
        .then(async response => {
            if (response.ok) {
                // SUCESSO!
                closeArchiveModal();
                
                try {
                    // Remove visualmente
                    removeRowFromTable(currentActionId);
                    // Exibe mensagem de sucesso
                    showToast("Plano de ação arquivado com sucesso!", "success");
                } catch (e) {
                    console.warn("Erro visual:", e);
                    window.location.reload();
                }
            } else {
                throw new Error("Erro na resposta do servidor.");
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast("Não foi possível arquivar. Tente novamente.", "error");
        })
        .finally(() => {
            // Restaura o botão (caso tenha dado erro e o modal continue aberto)
            if(document.getElementById('modalArquivar').style.display !== 'none') {
                btn.disabled = false;
                btn.textContent = "Arquivar";
            }
        });
    }

    function removeRowFromTable(id) {
        // Busca o botão de engrenagem que contém o ID correto
        const gearButton = document.querySelector(`button.btn-gear[data-id="${id}"]`);
        
        if (gearButton) {
            const row = gearButton.closest('tr');
            if (row) {
                row.style.transition = 'all 0.5s ease';
                row.style.opacity = '0';
                row.style.backgroundColor = '#fee2e2';
                setTimeout(() => {
                    row.remove();
                    // Verifica se a tabela ficou vazia e recarrega se necessário
                    const tbody = document.querySelector('#dataTable tbody');
                    if (tbody && tbody.children.length === 0) window.location.reload();
                }, 500);
            }
        } else {
            // Se não achou o botão (talvez paginação ou erro de DOM), recarrega para garantir
            window.location.reload();
        }
    }

    // --- Funções do Modal Aceitar Ação ---

    function openAceitarModal() {
        // Fecha o modal anterior (grid de botões)
        closeActionGridModal();
        
        const modal = document.getElementById('modalAceitarAcao');
        const textarea = document.getElementById('acoesPropostas');
        const dataInput = document.getElementById('dataFinalizacaoPrevista');
        
        // Limpar campos
        textarea.value = '';
        dataInput.value = '';
        updateCharCountAceitar(textarea); // Reseta validação visual

        if(document.getElementById('checkFluxoSimplificado')) {
            document.getElementById('checkFluxoSimplificado').checked = false;
        }
        
        modal.style.display = 'flex';
    }

    function closeAceitarModal() {
        document.getElementById('modalAceitarAcao').style.display = 'none';
    }

    function toggleEvidenciasAceitar() {
        const container = document.getElementById('containerEvidenciasAceitar');
        const icon = document.getElementById('iconEvidencias');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        } else {
            container.style.display = 'none';
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        }
    }

    function updateCharCountAceitar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterAceitar').textContent = `${count}/255`;
        const btn = document.getElementById('btnConfirmarAceite');
        const errorIcon = document.getElementById('errorIconAceitar');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e'; // Verde
            errorIcon.style.display = 'none';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#b91c1c'; // Vermelho forte
        } else {
            textarea.style.borderColor = '#ef4444'; // Vermelho erro
            errorIcon.style.display = 'block';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.backgroundColor = '#cd5c5c'; // Vermelho claro
        }
    }

    function submitAceitarAcao(tipoBotao) {
        // 1. Captura os valores dos campos
        const causa = document.getElementById('causaRaizAceitar').value; // <--- NOVO
        const acoes = document.getElementById('acoesPropostas').value;
        const dataFim = document.getElementById('dataFinalizacaoPrevista').value;

        const isSimplificado = document.getElementById('checkFluxoSimplificado').checked;

        // 2. Validações
        if (!causa.trim()) {
            showToast("A Análise de Causa Raiz é obrigatória.", "error");
            return;
        }
        if (!acoes.trim()) {
            showToast("O campo de Ações Propostas é obrigatório.", "error");
            return;
        }
        if (!dataFim) {
            showToast("A Data Prevista é obrigatória.", "error");
            return;
        }

        // 3. Preparar dados para envio (Payload)
        const payload = {
            causa_raiz: causa,        // <--- ENVIANDO A CAUSA RAIZ AGORA
            acoes_propostas: acoes,
            data_finalizacao: dataFim,
            acao_botao: tipoBotao,
            fluxo_simplificado: isSimplificado
        };

        if (!currentActionId) {
            showToast("Erro: ID do plano perdido.", "error");
            return;
        }

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/aceitar/`;

        // Desativa botões para evitar duplo clique
        const btnConfirmar = document.getElementById('btnConfirmarAceite');
        const originalText = btnConfirmar.innerText;
        btnConfirmar.disabled = true;
        btnConfirmar.innerText = "Salvando...";

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(async response => {
            if (response.ok) {
                closeAceitarModal();
                showToast("Ação aceita e enviada para validação!", "success");
                
                // Recarregar a página para atualizar status na tabela e mover para o card correto
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar a solicitação.", "error");
            // Reativa o botão em caso de erro
            btnConfirmar.disabled = false;
            btnConfirmar.innerText = originalText;
        });
    }

    function openInvestirModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalInvestir');
        const container = document.getElementById('containerInvestimentos');
        
        // Limpa e adiciona a primeira linha obrigatória
        container.innerHTML = ''; 
        adicionarLinhaInvestimento(); 
        
        atualizarTotalGeral();
        modal.style.display = 'flex';
    }

    function closeInvestirModal() {
        document.getElementById('modalInvestir').style.display = 'none';
    }

    // Função que cria o HTML de uma nova linha
    function adicionarLinhaInvestimento() {
        const container = document.getElementById('containerInvestimentos');
        const index = container.children.length + 1; // Apenas para IDs únicos se precisar

        const row = document.createElement('div');
        row.className = 'investimento-row';
        row.innerHTML = `
            <button type="button" class="btn-delete-row" onclick="removerLinhaInvestimento(this)" title="Remover item">
                <i class="fas fa-trash"></i>
            </button>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="input-wrapper-archive">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 13px; font-weight: 600; color: #555;">Descrição</label>
                        <span class="char-counter" style="font-size: 11px; color: #999;">0/255</span>
                    </div>
                    <textarea class="form-control inv-descricao" rows="4" maxlength="255" 
                              style="resize: none;" placeholder="Descreva o item..."
                              oninput="atualizarContadorLinha(this)"></textarea>
                </div>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="font-size: 13px; color: #555;">Quantidade</label>
                        <input type="number" class="form-control inv-qtd" value="1" min="1" oninput="calcularTotalLinha(this)">
                    </div>
                    <div>
                        <label style="font-size: 13px; color: #555;">Preço Unitário</label>
                        <div class="input-group-text">
                            <span style="padding: 10px; background: #f8fafc; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px;">R$</span>
                            <input type="number" class="form-control inv-preco" step="0.01" placeholder="0,00" style="border-radius: 0 4px 4px 0;" oninput="calcularTotalLinha(this)">
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 13px; color: #555;">Total</label>
                        <div class="input-group-text">
                            <span style="padding: 10px; background: #e2e8f0; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px;">R$</span>
                            <input type="text" class="form-control inv-total" readonly style="background-color: #e2e8f0; border-radius: 0 4px 4px 0; font-weight: bold;" value="0,00">
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(row);
        
        // Foca na descrição da nova linha
        const textarea = row.querySelector('.inv-descricao');
        textarea.focus();
        
        verificarBotoesExclusao();
    }

    function removerLinhaInvestimento(btn) {
        const container = document.getElementById('containerInvestimentos');
        
        // Impede deletar se for a única linha (embora a função verificarBotoesExclusao já esconda o botão)
        if (container.children.length <= 1) {
            showToast("É necessário pelo menos um item de investimento.", "warning");
            return;
        }

        // Remove a linha (div pai do botão)
        btn.closest('.investimento-row').remove();
        
        verificarBotoesExclusao();
        atualizarTotalGeral();
    }

    // Esconde o botão de excluir se só tiver 1 linha
    function verificarBotoesExclusao() {
        const linhas = document.querySelectorAll('.investimento-row');
        linhas.forEach(linha => {
            const btn = linha.querySelector('.btn-delete-row');
            if (linhas.length === 1) {
                btn.style.display = 'none';
            } else {
                btn.style.display = 'flex';
            }
        });
    }

    function calcularTotalLinha(input) {
        // Encontra a linha pai do input que foi alterado
        const row = input.closest('.investimento-row');
        
        const qtd = parseFloat(row.querySelector('.inv-qtd').value) || 0;
        const preco = parseFloat(row.querySelector('.inv-preco').value) || 0;
        const total = qtd * preco;

        // Atualiza o campo total daquela linha
        row.querySelector('.inv-total').value = total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        atualizarTotalGeral();
    }

    function atualizarTotalGeral() {
        let totalGeral = 0;
        document.querySelectorAll('.investimento-row').forEach(row => {
            const qtd = parseFloat(row.querySelector('.inv-qtd').value) || 0;
            const preco = parseFloat(row.querySelector('.inv-preco').value) || 0;
            totalGeral += (qtd * preco);
        });
        
        document.getElementById('totalGeralInvest').textContent = 
            totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function atualizarContadorLinha(textarea) {
        const count = textarea.value.length;
        // Acha o contador dentro da mesma div wrapper
        const counter = textarea.closest('.input-wrapper-archive').querySelector('.char-counter');
        counter.textContent = `${count}/255`;
        
        if (count > 0) {
            textarea.style.borderColor = '#ccc';
            counter.style.color = '#15803d';
        } else {
            textarea.style.borderColor = '#ef4444';
            counter.style.color = '#ef4444';
        }
    }

    function submitInvestimentoEmLote() {
        const linhas = document.querySelectorAll('.investimento-row');
        const payload = [];
        let erroValidacao = false;

        linhas.forEach((row, index) => {
            const descricao = row.querySelector('.inv-descricao').value.trim();
            const qtd = row.querySelector('.inv-qtd').value;
            const preco = row.querySelector('.inv-preco').value;

            if (!descricao || !qtd || !preco) {
                row.style.border = "1px solid #ef4444"; // Marca a linha com erro
                erroValidacao = true;
            } else {
                row.style.border = "1px solid #e2e8f0"; // Remove marcação
                payload.push({
                    descricao: descricao,
                    quantidade: qtd,
                    preco: preco
                });
            }
        });

        if (erroValidacao) {
            showToast("Preencha todos os campos obrigatórios em todas as linhas.", "error");
            return;
        }

        if (payload.length === 0) return;

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/investir/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(async response => {
            if (response.ok) {
                closeInvestirModal();
                showToast(`${payload.length} investimento(s) salvo(s) com sucesso!`, "success");
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao registrar investimentos.", "error");
        });
    }
    // Array para armazenar os arquivos selecionados temporariamente
    let arquivosParaUpload = [];

    function openConcluirModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalConcluir');
        
        // Resetar campos
        document.getElementById('acoesRealizadas').value = '';
        document.getElementById('inputEvidenciasFile').value = '';
        document.getElementById('listaArquivosUpload').innerHTML = '';
        arquivosParaUpload = []; // Limpa array
        
        updateCharCountConcluir(document.getElementById('acoesRealizadas'));
        modal.style.display = 'flex';
    }

    function closeConcluirModal() {
        document.getElementById('modalConcluir').style.display = 'none';
    }

    function updateCharCountConcluir(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterConcluir').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarConclusao');
        const icon = document.getElementById('errorIconConcluir');
        const msg = document.getElementById('msgErroAcoes');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e'; // Verde
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#b91c1c';
        } else {
            textarea.style.borderColor = '#ef4444'; // Vermelho
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.backgroundColor = '#cd5c5c';
        }
    }

    // Gerencia a seleção de arquivos e exibe na tela
    function handleFileSelect(input) {
        const files = Array.from(input.files);
        const lista = document.getElementById('listaArquivosUpload');
        const msgErro = document.getElementById('msgErroEvidencias');

        files.forEach(file => {
            // Adiciona ao array global
            arquivosParaUpload.push(file);

            // Cria elemento visual
            const item = document.createElement('div');
            item.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; padding: 8px 12px; border-radius: 4px; font-size: 13px;";
            item.innerHTML = `
                <span><i class="fas fa-paperclip" style="color: #666; margin-right: 6px;"></i> ${file.name}</span>
                <i class="fas fa-times" style="color: #ef4444; cursor: pointer;" onclick="removerArquivo(this, '${file.name}')"></i>
            `;
            lista.appendChild(item);
        });

        if (arquivosParaUpload.length > 0) msgErro.style.display = 'none';
    }

    function removerArquivo(btnElement, fileName) {
        // Remove do array
        arquivosParaUpload = arquivosParaUpload.filter(f => f.name !== fileName);
        // Remove visualmente
        btnElement.parentElement.remove();
    }

    function submitConclusao() {
        const acoes = document.getElementById('acoesRealizadas').value;
        const msgErroEvidencias = document.getElementById('msgErroEvidencias');

        // Validação Final
        if (!acoes.trim()) {
            showToast("O campo de Ações Realizadas é obrigatório.", "error");
            return;
        }
        if (arquivosParaUpload.length === 0) {
            msgErroEvidencias.style.display = 'block';
            showToast("É obrigatório anexar pelo menos uma evidência.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarConclusao');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        // Usamos FormData para enviar arquivos
        const formData = new FormData();
        formData.append('acoes_realizadas', acoes);
        
        arquivosParaUpload.forEach(file => {
            formData.append('evidencias', file);
        });

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/concluir/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
                // Não definir Content-Type aqui, o browser define automaticamente para multipart/form-data
            },
            body: formData
        })
        .then(async response => {
            if (response.ok) {
                closeConcluirModal();
                showToast("Implementação concluída! Aguardando aprovação.", "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar a solicitação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    // --- LÓGICA DE FINALIZAÇÃO (AG_APROVACAO -> CONCLUIDO ou VAL_EFICACIA) ---

    function openFinalizarModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalFinalizar');
        // Reseta para a primeira opção sempre que abrir
        document.querySelector('input[name="decisaoFinal"][value="finalizar"]').checked = true;
        modal.style.display = 'flex';
    }

    function closeFinalizarModal() {
        document.getElementById('modalFinalizar').style.display = 'none';
    }

    function submitDecisaoAuditor() {
        // Pega o valor do radio selecionado
        const decisao = document.querySelector('input[name="decisaoFinal"]:checked').value;
        
        const btn = document.getElementById('btnConfirmarFinalizacao');
        btn.disabled = true;
        btn.innerText = "Processando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/avaliar-conclusao/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ decisao: decisao })
        })
        .then(async response => {
            if (response.ok) {
                closeFinalizarModal();
                let msg = decisao === 'finalizar' 
                    ? "Plano de ação concluído com sucesso!" 
                    : "Plano enviado para validação de eficácia.";
                
                showToast(msg, "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar decisão.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar solicitação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    // --- LÓGICA DE EFICÁCIA (VALIDACAO_EFICACIA -> CONCLUIDO) ---
    
    let arquivosEficacia = [];

    function openEficaciaModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalEficacia');
        
        // Reset
        document.getElementById('obsEficacia').value = '';
        document.getElementById('listaArquivosEficacia').innerHTML = '';
        arquivosEficacia = [];
        
        updateCharCountEficacia(document.getElementById('obsEficacia'));
        modal.style.display = 'flex';
    }

    function closeEficaciaModal() {
        document.getElementById('modalEficacia').style.display = 'none';
    }

    function updateCharCountEficacia(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterEficacia').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarEficacia');
        const icon = document.getElementById('errorIconEficacia');
        const msg = document.getElementById('msgErroEficacia');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e';
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#b91c1c';
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.backgroundColor = '#cd5c5c';
        }
    }

    function handleFileSelectEficacia(input) {
        const files = Array.from(input.files);
        const lista = document.getElementById('listaArquivosEficacia');

        files.forEach(file => {
            arquivosEficacia.push(file);
            const item = document.createElement('div');
            item.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; padding: 8px 12px; border-radius: 4px; font-size: 13px;";
            item.innerHTML = `
                <span><i class="fas fa-paperclip" style="color: #666; margin-right: 6px;"></i> ${file.name}</span>
                <i class="fas fa-times" style="color: #ef4444; cursor: pointer;" onclick="removerArquivoEficacia(this, '${file.name}')"></i>
            `;
            lista.appendChild(item);
        });
    }

    function removerArquivoEficacia(btnElement, fileName) {
        arquivosEficacia = arquivosEficacia.filter(f => f.name !== fileName);
        btnElement.parentElement.remove();
    }

    function submitEficacia() {
        const obs = document.getElementById('obsEficacia').value;
        
        if (!obs.trim()) {
            showToast("Observação é obrigatória.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarEficacia');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const formData = new FormData();
        formData.append('observacao_eficacia', obs);
        
        arquivosEficacia.forEach(file => {
            formData.append('evidencias', file);
        });

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/validar-eficacia/`;

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        })
        .then(async response => {
            if (response.ok) {
                closeEficaciaModal();
                showToast("Ciclo finalizado! Plano de ação concluído.", "success");
                // Ao recarregar, o item deve sumir da lista pois está CONCLUIDO
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao finalizar processo.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    // --- LÓGICA DE RECUSA ---

    function openRecusarModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalRecusar');
        const textarea = document.getElementById('motivoRecusa');
        
        // Reset
        textarea.value = '';
        updateCharCountRecusar(textarea);
        
        modal.style.display = 'flex';
        textarea.focus();
    }

    function closeRecusarModal() {
        document.getElementById('modalRecusar').style.display = 'none';
    }

    function updateCharCountRecusar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterRecusar').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarRecusa');
        const icon = document.getElementById('errorIconRecusar');
        const msg = document.getElementById('msgErroRecusa');

        if (count > 0) {
            textarea.style.borderColor = '#ccc';
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        }
    }

    function submitRecusa() {
        const motivo = document.getElementById('motivoRecusa').value;
        
        if (!motivo.trim()) {
            showToast("O motivo da recusa é obrigatório.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarRecusa');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/recusar/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ motivo: motivo })
        })
        .then(async response => {
            if (response.ok) {
                closeRecusarModal();
                
                // --- FEEDBACK PARA O USUÁRIO ---
                // Usa o tipo 'success' para ficar Verde
                showToast("Ação recusada com sucesso.", "success"); 
                
                // Recarrega a página para atualizar a lista (item some ou muda de status)
                setTimeout(() => window.location.reload(), 1500);
            } else {
                throw new Error("Erro ao recusar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Não foi possível recusar a ação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar Recusa";
        });
    }

    function openClonarModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalClonar');
        
        // Reset
        document.getElementById('clonarResponsavel').value = "";
        document.getElementById('clonarOrientacoes').value = "";
        updateCharCountClonar(document.getElementById('clonarOrientacoes'));
        
        modal.style.display = 'flex';
    }

    function closeClonarModal() {
        document.getElementById('modalClonar').style.display = 'none';
    }

    function updateCharCountClonar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterClonar').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarClonar');
        const icon = document.getElementById('errorIconClonar');
        const msg = document.getElementById('msgErroClonar');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e'; // Verde se preenchido
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            document.getElementById('charCounterClonar').style.color = '#22c55e';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#db5461'; // Rosa escuro/Vermelho suave
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            document.getElementById('charCounterClonar').style.color = '#ef4444';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        }
    }

    function submitClonar() {
        const responsavel = document.getElementById('clonarResponsavel').value;
        const orientacoes = document.getElementById('clonarOrientacoes').value;

        if (!responsavel) {
            showToast("Selecione um novo responsável.", "error");
            return;
        }
        if (!orientacoes.trim()) {
            showToast("Orientações são obrigatórias.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarClonar');
        btn.disabled = true;
        btn.innerText = "Clonando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/clonar/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                novo_responsavel: responsavel,
                orientacoes: orientacoes
            })
        })
        .then(async response => {
            if (response.ok) {
                closeClonarModal();
                showToast("Plano clonado com sucesso! Uma nova tarefa foi criada.", "success");
                setTimeout(() => window.location.reload(), 1500);
            } else {
                throw new Error("Erro ao clonar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao clonar ação.", "error");
            btn.disabled = false;
            btn.innerText = "Clonar";
        });
    }

    function openPrazoModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalAlterarPrazo');
        const inputData = document.getElementById('novaDataEncerramento');
        
        // Limpa o campo
        inputData.value = '';
        
        // Opcional: Adicionar foco visual extra
        inputData.addEventListener('focus', () => {
            inputData.style.boxShadow = '0 0 0 3px rgba(147, 197, 253, 0.5)'; // Anel azul claro
        });
        inputData.addEventListener('blur', () => {
            inputData.style.boxShadow = 'none';
        });

        modal.style.display = 'flex';
    }

    function closePrazoModal() {
        document.getElementById('modalAlterarPrazo').style.display = 'none';
    }

    function submitNovoPrazo() {
        const novaData = document.getElementById('novaDataEncerramento').value;
        
        if (!novaData) {
            showToast("Selecione uma data válida.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarPrazo');
        btn.disabled = true;
        btn.innerText = "Salvando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/alterar-prazo/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nova_data: novaData })
        })
        .then(async response => {
            if (response.ok) {
                closePrazoModal();
                showToast("Data de encerramento atualizada com sucesso!", "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar data.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao alterar data.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    function carregarMensagensForum() {
        if (!activeForumId) return;

        const container = document.getElementById('forumMessagesArea');
        // Não limpa o container imediatamente para evitar "piscar" se for refresh automático
        // container.innerHTML = '...'; 

        fetch(`/auditorias/planos-de-acao/api/forum/${activeForumId}/mensagens/`) 
            .then(r => r.json())
            .then(data => {
                const mensagens = data.mensagens;
                container.innerHTML = ''; // Agora limpa

                if (mensagens.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; margin-top: 40px;">Nenhuma mensagem ainda. Inicie a conversa!</div>';
                    return;
                }

                mensagens.forEach(msg => {
                    // Lógica visual: Minha mensagem (me) vs Outros
                    const isMe = msg.is_me;
                    const cssClass = isMe ? 'me' : '';
                    
                    // Avatar: Primeira letra ou ícone
                    // Supondo que msg.autor venha como string "Nome Sobrenome"
                    const avatarLetter = msg.autor ? msg.autor.charAt(0).toUpperCase() : '?';
                    // Cor do avatar (aleatória fixa baseada no nome seria ideal, mas fixo serve)
                    const avatarColor = isMe ? '#334155' : '#c4b5fd'; 

                    const html = `
                        <div class="forum-msg-item ${cssClass}">
                            <div class="forum-avatar" style="background-color: ${avatarColor};">
                                ${avatarLetter}
                            </div>
                            <div class="forum-msg-content">
                                <div class="forum-msg-meta">
                                    ${msg.autor} • ${msg.data_envio}
                                </div>
                                <div class="forum-msg-bubble">
                                    ${msg.conteudo}
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

                // Rola para o final
                container.scrollTop = container.scrollHeight;
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = '<div style="color:red; text-align:center;">Erro ao carregar mensagens.</div>';
            });
    }

    function enviarMensagemForum() {
        const input = document.getElementById('forumInputMsg');
        const texto = input.value.trim();

        if (!texto || !activeForumId) return;

        // Feedback visual imediato (Opcional, ou espera o servidor)
        input.disabled = true;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/auditorias/planos-de-acao/api/forum/${activeForumId}/enviar/`, { 
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Use a tag do Django
            },
            body: JSON.stringify({ conteudo: texto })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                input.value = ''; // Limpa input
                carregarMensagensForum(); // Recarrega lista
            } else {
                showToast("Erro ao enviar mensagem.", "error");
            }
        })
        .catch(err => {
            console.error(err);
            showToast("Erro de conexão.", "error");
        })
        .finally(() => {
            input.disabled = false;
            input.focus();
        });
    }

    // --- Função chamada pelo botão "..." do Modal de Detalhes ---
    function openOptionsFromDetails() {
        // 1. Fecha o modal de detalhes (Engrenagem)
        closeModalDetalhes();

        // 2. Abre o modal de ações (Grid) usando os dados salvos
        // Verifica se temos os dados necessários
        if (currentPlanContext.id) {
            // Pequeno delay para a transição visual ficar suave (opcional)
            setTimeout(() => {
                openActionGrid(
                    currentPlanContext.id,
                    currentPlanContext.titulo,
                    currentPlanContext.status,
                    currentPlanContext.auditoriaId,
                    currentPlanContext.responsavelId,
                    currentPlanContext.responsavelNome
                );
            }, 100);
        } else {
            console.error("Dados do contexto perdidos.");
        }
    }

    // --- LÓGICA DO NOVO PLANO ---

    function openModalNovoPlano() {
        document.getElementById('modalNovoPlano').style.display = 'flex';
    }

    function closeModalNovoPlano() {
        document.getElementById('modalNovoPlano').style.display = 'none';
    }

    function updateCounter(input, counterId) {
        const max = input.getAttribute('maxlength');
        const current = input.value.length;
        const counter = document.getElementById(counterId);
        counter.textContent = `${current}/${max}`;
        
        if (current === 0) {
            counter.style.color = '#ef4444';
            input.classList.add('error');
        } else {
            counter.style.color = '#22c55e';
            input.classList.remove('error');
        }
    }

    function updateFileList(input) {
        const list = document.getElementById('newFileList');
        list.innerHTML = '';
        if (input.files.length > 0) {
            for (let i = 0; i < input.files.length; i++) {
                list.innerHTML += `<div style="margin-bottom:4px;"><i class="fas fa-paperclip"></i> ${input.files[i].name}</div>`;
            }
        }
    }

    function submitNovoPlano() {
        const form = document.getElementById('formNovoPlano');
        const formData = new FormData(form);
        
        // Validações
        const titulo = document.getElementById('newTitulo');
        const categoria = document.getElementById('newCategoria');
        const responsavel = document.getElementById('newResponsavel');
        const dataFim = document.querySelector('input[name="data_fim"]');

        let hasError = false;

        if(!titulo.value.trim()) { titulo.classList.add('error'); hasError = true; }
        if(!categoria.value) { categoria.classList.add('error'); hasError = true; }
        if(!responsavel.value) { responsavel.classList.add('error'); hasError = true; }
        if(!dataFim.value) { dataFim.classList.add('error'); hasError = true; }

        if(hasError) {
            showToast("Preencha os campos obrigatórios em vermelho.", "error");
            return;
        }

        const btn = event.target;
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Salvando...";

        fetch("{% url 'auditorias:criar_plano_manual' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') {
                showToast(data.message, "success");
                closeModalNovoPlano();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(data.message || "Erro ao criar plano.", "error");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro de conexão.", "error");
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }

    // Opcional: Lógica simples para o select de Nível
    // Como no seu modelo o 'Local' do plano é um SubSetor,
    // o nível aqui serve mais como filtro visual ou metadado se quiser expandir depois.
    function filtrarLocais() {
        // Por enquanto, mantém todos os subsetores visíveis, 
        // ou você pode implementar uma chamada AJAX aqui se quiser filtrar
        // subsetores baseados na seleção (ex: filtrar por Empresa se selecionado Empresa).
        // Para simplificar e manter funcional:
        console.log("Filtro de nível alterado - Implementar filtro dinâmico se necessário.");
    }

    // Fechar modais ao clicar fora
    window.onclick = function(event) {
        const modalGrid = document.getElementById('actionGridModal');
        const modalDetalhes = document.getElementById('modalDetalhes');
        const modalArquivar = document.getElementById('modalArquivar');
        
        if (event.target == modalGrid) closeActionGridModal();
        if (event.target == modalDetalhes) closeModalDetalhes();
        if (event.target == modalArquivar) closeArchiveModal();
    }
    </script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\usuarios\form_usuario.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<!-- Informações Básicas -->
<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-user"></i>
        Informações Básicas
    </h4>
    
    <div class="form-row">
        <div class="form-group required">
            <label for="username" class="form-label">Username</label>
            <input type="text" 
                   id="username" 
                   name="username" 
                   class="form-control" 
                   value="{{ usuario.username|default:'' }}" 
                   required 
                   maxlength="150"
                   placeholder="Digite o username">
            <div class="field-help">Username único para login no sistema</div>
        </div>
        
        <div class="form-group required">
            <label for="email" class="form-label">Email</label>
            <input type="email" 
                   id="email" 
                   name="email" 
                   class="form-control" 
                   value="{{ usuario.email|default:'' }}" 
                   required 
                   placeholder="Digite o email">
            <div class="field-help">Email único para comunicações</div>
        </div>
    </div>

    
    <div class="form-row">
        <div class="form-group">
            <label for="first_name" class="form-label">Nome</label>
            <input type="text" 
                   id="first_name" 
                   name="first_name" 
                   class="form-control" 
                   value="{{ usuario.first_name|default:'' }}" 
                   maxlength="150"
                   placeholder="Digite o primeiro nome">
        </div>
        
        <div class="form-group">
            <label for="last_name" class="form-label">Sobrenome</label>
            <input type="text" 
                   id="last_name" 
                   name="last_name" 
                   class="form-control" 
                   value="{{ usuario.last_name|default:'' }}" 
                   maxlength="150"
                   placeholder="Digite o sobrenome">
        </div>
    </div>
</div>

<!-- Senha (apenas para criação) -->
{% if not usuario %}
<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-lock"></i>
        Senha
    </h4>
    
    <div class="form-row">
        <div class="form-group required">
            <label for="password" class="form-label">Senha</label>
            <input type="password" 
                   id="password" 
                   name="password" 
                   class="form-control" 
                   required 
                   minlength="8"
                   placeholder="Digite a senha">
            <div class="field-help">Mínimo de 8 caracteres</div>
        </div>
        
        <div class="form-group required">
            <label for="password_confirm" class="form-label">Confirmar Senha</label>
            <input type="password" 
                   id="password_confirm" 
                   name="password_confirm" 
                   class="form-control" 
                   required 
                   minlength="8"
                   placeholder="Confirme a senha">
            <div class="field-help">Digite a senha novamente</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Permissões -->
<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-shield-alt"></i>
        Permissões
    </h4>
    
    <div class="form-row triple">
        <div class="form-group">
            <label class="form-label">Status Ativo</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                    <input type="checkbox" 
                           name="is_active" 
                           {% if usuario.is_active|default:True %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span style="color: var(--text-secondary); font-size: 14px;">
                    Usuário pode fazer login
                </span>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Staff</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                    <input type="checkbox" 
                           name="is_staff" 
                           {% if usuario.is_staff %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span style="color: var(--text-secondary); font-size: 14px;">
                    Acesso ao admin
                </span>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Superusuário</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                    <input type="checkbox" 
                           name="is_superuser" 
                           {% if usuario.is_superuser %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span style="color: var(--text-secondary); font-size: 14px;">
                    Todas as permissões
                </span>
            </div>
        </div>
    </div>
</div>

<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-users"></i>
        Perfil de Acesso
    </h4>
    
    <div class="form-group required">
        <label for="grupo" class="form-label">Grupo do Usuário</label>
        <select name="grupo" id="grupo" class="form-control" required>
            <option value="">Selecione um perfil...</option>
            {% for grupo in grupos %}
                <option value="{{ grupo.id }}" 
                    {% if grupo_atual_id == grupo.id %}selected{% endif %}>
                    {{ grupo.name }}
                </option>
            {% endfor %}
        </select>
        <div class="field-help">Selecione o perfil de acesso único para este usuário.</div>
    </div>
</div>
{% endblock %}

{% block help_content %}
<div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
    <p><strong>Sobre Usuários:</strong></p>
    <ul style="margin: 12px 0; padding-left: 20px;">
        <li><strong>Username:</strong> Identificador único para login</li>
        <li><strong>Email:</strong> Deve ser único no sistema</li>
        <li><strong>Staff:</strong> Permite acesso ao painel administrativo</li>
        <li><strong>Superusuário:</strong> Tem todas as permissões</li>
    </ul>
    
    <p><strong>Níveis de Permissão:</strong></p>
    <ul style="margin: 12px 0; padding-left: 20px;">
        <li><strong>Usuário comum:</strong> Acesso básico ao sistema</li>
        <li><strong>Staff:</strong> Acesso ao admin + permissões específicas</li>
        <li><strong>Superusuário:</strong> Acesso total ao sistema</li>
    </ul>
</div>
{% endblock %}

{% block quick_actions %}
<button type="button" onclick="previewForm()" class="btn btn-secondary btn-sm">
    <i class="fas fa-eye"></i>
    Visualizar
</button>
<button type="button" onclick="resetForm()" class="btn btn-secondary btn-sm">
    <i class="fas fa-undo"></i>
    Resetar
</button>
<button type="button" onclick="generatePassword()" class="btn btn-secondary btn-sm">
    <i class="fas fa-key"></i>
    Gerar Senha
</button>
<button type="button" onclick="validateUser()" class="btn btn-secondary btn-sm">
    <i class="fas fa-check"></i>
    Validar
</button>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .password-strength {
        margin-top: 8px;
        padding: 8px;
        border-radius: var(--radius-sm);
        font-size: 12px;
        transition: all 0.3s ease;
    }
    
    .password-strength.weak {
        background: rgba(220, 38, 38, 0.1);
        color: var(--error);
    }
    
    .password-strength.medium {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }
    
    .password-strength.strong {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }
    
    .password-requirements {
        margin-top: 8px;
        font-size: 12px;
        color: var(--text-muted);
    }
    
    .password-requirements li {
        margin-bottom: 4px;
        transition: color 0.3s ease;
    }
    
    .password-requirements li.valid {
        color: var(--success);
    }
    
    .password-requirements li.invalid {
        color: var(--error);
    }
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Validação específica para usuários
    document.addEventListener('DOMContentLoaded', function() {
        const usernameField = document.getElementById('username');
        const emailField = document.getElementById('email');
        const passwordField = document.getElementById('password');
        const passwordConfirmField = document.getElementById('password_confirm');
        
        // Validação de username em tempo real
        if (usernameField) {
            let usernameTimeout;
            usernameField.addEventListener('input', function() {
                clearTimeout(usernameTimeout);
                usernameTimeout = setTimeout(() => {
                    validateUsername(this.value);
                }, 500);
            });
        }
        
        // Validação de email em tempo real
        if (emailField) {
            let emailTimeout;
            emailField.addEventListener('input', function() {
                clearTimeout(emailTimeout);
                emailTimeout = setTimeout(() => {
                    validateEmail(this.value);
                }, 500);
            });
        }
        
        // Validação de senha
        if (passwordField) {
            passwordField.addEventListener('input', function() {
                validatePassword(this.value);
                checkPasswordMatch();
            });
            
            // Adicionar indicador de força da senha
            const strengthIndicator = document.createElement('div');
            strengthIndicator.className = 'password-strength';
            passwordField.parentNode.appendChild(strengthIndicator);
            
        
        // Confirmação de senha
        if (passwordConfirmField) {
            passwordConfirmField.addEventListener('input', checkPasswordMatch);
        }
    });

    // Validar username via AJAX
    function validateUsername(username) {
        if (!username || username.length < 3) return;
        
        const userId = '{{ usuario.id|default:"" }}';
        const url = `{% url 'usuarios:verificar_username' %}?username=${encodeURIComponent(username)}&user_id=${userId}`;
        
        fetch(url)
        .then(response => response.json())
        .then(data => {
            const field = document.getElementById('username');
            if (data.available) {
                showFieldSuccess(field, data.message);
            } else {
                showFieldError(field, data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao validar username:', error);
        });
    }

    // Validar email via AJAX
    function validateEmail(email) {
        if (!email || !isValidEmail(email)) return;
        
        const userId = '{{ usuario.id|default:"" }}';
        const url = `{% url 'usuarios:verificar_email' %}?email=${encodeURIComponent(email)}&user_id=${userId}`;
        
        fetch(url)
        .then(response => response.json())
        .then(data => {
            const field = document.getElementById('email');
            if (data.available) {
                showFieldSuccess(field, data.message);
            } else {
                showFieldError(field, data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao validar email:', error);
        });
    }

    // Validar força da senha
    function validatePassword(password) {
        const strengthIndicator = document.querySelector('.password-strength');
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
        };
        
        // Atualizar indicadores visuais dos requisitos
        Object.keys(requirements).forEach(req => {
            const element = document.getElementById(`req-${req}`);
            if (element) {
                element.className = requirements[req] ? 'valid' : 'invalid';
            }
        });
        
        // Calcular força da senha
        const validCount = Object.values(requirements).filter(Boolean).length;
        let strength = 'weak';
        let message = 'Senha fraca';
        
        if (validCount >= 4) {
            strength = 'strong';
            message = 'Senha forte';
        } else if (validCount >= 3) {
            strength = 'medium';
            message = 'Senha média';
        }
        
        strengthIndicator.className = `password-strength ${strength}`;
        strengthIndicator.textContent = message;
    }

    // Verificar se as senhas coincidem
    function checkPasswordMatch() {
        const password = document.getElementById('password')?.value;
        const passwordConfirm = document.getElementById('password_confirm')?.value;
        
        if (passwordConfirm && password !== passwordConfirm) {
            showFieldError(document.getElementById('password_confirm'), 'As senhas não coincidem');
        } else if (passwordConfirm) {
            showFieldSuccess(document.getElementById('password_confirm'), 'Senhas coincidem');
        }
    }

    // Gerar senha aleatória
    function generatePassword() {
        const length = 12;
        const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*';
        let password = '';
        
        // Garantir pelo menos um caractere de cada tipo
        password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)];
        password += 'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)];
        password += '0123456789'[Math.floor(Math.random() * 10)];
        password += '!@#$%^&*'[Math.floor(Math.random() * 8)];
        
        // Preencher o resto aleatoriamente
        for (let i = password.length; i < length; i++) {
            password += charset[Math.floor(Math.random() * charset.length)];
        }
        
        // Embaralhar a senha
        password = password.split('').sort(() => Math.random() - 0.5).join('');
        
        // Definir nos campos
        const passwordField = document.getElementById('password');
        const passwordConfirmField = document.getElementById('password_confirm');
        
        if (passwordField) {
            passwordField.value = password;
            passwordField.dispatchEvent(new Event('input'));
        }
        
        if (passwordConfirmField) {
            passwordConfirmField.value = password;
            passwordConfirmField.dispatchEvent(new Event('input'));
        }
        
        // Mostrar a senha gerada
        alert(`Senha gerada: ${password}\n\nCopie esta senha e guarde em local seguro.`);
    }

    // Validar usuário completo
    function validateUser() {
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        
        if (!username) {
            alert('Digite um username para validar');
            return;
        }
        
        if (!email) {
            alert('Digite um email para validar');
            return;
        }
        
        // Validar ambos
        Promise.all([
            validateUsername(username),
            validateEmail(email)
        ]).then(() => {
            alert('Validação concluída! Verifique os campos para ver os resultados.');
        });
    }

    // Validação customizada do formulário
    function validateForm() {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const grupo = document.getElementById('grupo').value;
        const password = document.getElementById('password')?.value;
        const passwordConfirm = document.getElementById('password_confirm')?.value;
        let isValid = true;

        // Validar Grupo (NOVO)
        if (!grupo) {
            // Se tiver a função showFieldError, use ela, senão use alert
            const grupoField = document.getElementById('grupo');
            if (typeof showFieldError === 'function') {
                showFieldError(grupoField, 'O Perfil de Acesso é obrigatório');
            } else {
                grupoField.style.borderColor = 'red';
                alert('Por favor, selecione um Perfil de Acesso.');
            }
            isValid = false;
        } else {
             document.getElementById('grupo').style.borderColor = ''; // Limpa erro
        }
        
        // Validar campos obrigatórios
        if (!username) {
            showFieldError(document.getElementById('username'), 'Username é obrigatório');
            isValid = false;
        }
        
        if (!email) {
            showFieldError(document.getElementById('email'), 'Email é obrigatório');
            isValid = false;
        } else if (!isValidEmail(email)) {
            showFieldError(document.getElementById('email'), 'Digite um email válido');
            isValid = false;
        }
        
        // Validar senha (apenas na criação)
        if (password !== undefined) {
            if (!password) {
                showFieldError(document.getElementById('password'), 'Senha é obrigatória');
                isValid = false;
            } else if (password.length < 8) {
                showFieldError(document.getElementById('password'), 'Senha deve ter pelo menos 8 caracteres');
                isValid = false;
            }
            
            if (password !== passwordConfirm) {
                showFieldError(document.getElementById('password_confirm'), 'As senhas não coincidem');
                isValid = false;
            }
        }
        
        return isValid;
    }

    // Atalhos específicos para usuários
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + G para gerar senha
        if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
            e.preventDefault();
            generatePassword();
        }
        
        // Ctrl/Cmd + T para validar usuário
        if ((e.ctrlKey || e.metaKey) && e.key === 't') {
            e.preventDefault();
            validateUser();
        }
    });
</script>
{% endblock %}


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\usuarios\lista_usuarios.html

{% extends 'auditorias/base.html' %}

{% block title %}Usuários - Sistema de Auditorias{% endblock %}
{% block page_title %}Usuários{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">Gerenciamento de Usuários</h2>
            <p class="content-subtitle">Gerencie usuários, permissões e grupos do sistema</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{% url 'usuarios:lista_grupos' %}" class="btn btn-secondary">
                <i class="fas fa-users-cog"></i>
                Grupos
            </a>
            <a href="{% url 'usuarios:criar_usuario' %}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                Novo Usuário
            </a>
        </div>
    </div>
</div>

<!-- Filtros e Busca -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-body">
        <form method="get" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto auto; gap: 16px; align-items: end;">
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Buscar</label>
                <div class="search-container">
                    <input type="text" name="search" value="{{ search }}" placeholder="Nome, username ou email..." class="form-control search-input">
                </div>
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Status</label>
                <select name="status" class="form-control form-select">
                    <option value="">Todos</option>
                    <option value="ativo" {% if status == 'ativo' %}selected{% endif %}>Ativos</option>
                    <option value="inativo" {% if status == 'inativo' %}selected{% endif %}>Inativos</option>
                    <option value="staff" {% if status == 'staff' %}selected{% endif %}>Staff</option>
                </select>
            </div>
            
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Grupo</label>
                <select name="grupo" class="form-control form-select">
                    <option value="">Todos</option>
                    {% for g in grupos %}
                    <option value="{{ g.id }}" {% if grupo == g.id|stringformat:"s" %}selected{% endif %}>{{ g.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn btn-secondary">
                <i class="fas fa-search"></i>
                Buscar
            </button>
            
            {% if search or status or grupo %}
            <a href="?" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Limpar
            </a>
            {% endif %}
        </form>
    </div>
</div>

<!-- Tabela de Usuários -->
<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 class="card-title">Lista de Usuários</h3>
                <p class="card-subtitle">
                    {% if page_obj.paginator.count %}
                        {{ page_obj.paginator.count }} usuário{{ page_obj.paginator.count|pluralize:",s" }} encontrado{{ page_obj.paginator.count|pluralize:",s" }}
                    {% else %}
                        Nenhum usuário encontrado
                    {% endif %}
                </p>
            </div>
            {% if page_obj.paginator.count > 0 %}
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-secondary btn-sm" onclick="exportarUsuarios()">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
                <button class="btn btn-secondary btn-sm" onclick="imprimirTabela()">
                    <i class="fas fa-print"></i>
                    Imprimir
                </button>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card-body">
        {% if page_obj.object_list %}
            <div class="table-container">
                <table class="table" id="usuariosTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Usuário</th>
                            <th>Email</th>
                            <th>Grupos</th>
                            <th>Status</th>
                            <th>Último Login</th>
                            <th style="width: 140px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in page_obj %}
                        <tr>
                            <td>
                                <input type="checkbox" name="selected_users" value="{{ usuario.pk }}" class="user-checkbox">
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="user-avatar" style="width: 40px; height: 40px; font-size: 14px;">
                                        {{ usuario.first_name.0|default:usuario.username.0|upper }}
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">
                                            {{ usuario.get_full_name|default:usuario.username }}
                                            {% if usuario.is_superuser %}
                                                <span class="badge badge-error" style="font-size: 10px; margin-left: 8px;">SUPER</span>
                                            {% elif usuario.is_staff %}
                                                <span class="badge badge-warning" style="font-size: 10px; margin-left: 8px;">STAFF</span>
                                            {% endif %}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted);">
                                            @{{ usuario.username }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div style="color: var(--text-secondary);">
                                    {{ usuario.email|default:"—" }}
                                </div>
                            </td>
                            <td>
                                {% if usuario.groups.all %}
                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                        {% for grupo in usuario.groups.all %}
                                        <span class="badge badge-info" style="font-size: 10px;">
                                            {{ grupo.name }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span style="color: var(--text-muted); font-size: 12px;">Nenhum grupo</span>
                                {% endif %}
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    {% if usuario.is_active %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i>
                                            Ativo
                                        </span>
                                    {% else %}
                                        <span class="badge badge-error">
                                            <i class="fas fa-times-circle"></i>
                                            Inativo
                                        </span>
                                    {% endif %}
                                    
                                    {% if usuario != request.user %}
                                    <button onclick="toggleUserStatus({{ usuario.pk }})" 
                                            class="btn btn-secondary btn-icon btn-sm" 
                                            title="{% if usuario.is_active %}Desativar{% else %}Ativar{% endif %} usuário"
                                            id="toggleBtn{{ usuario.pk }}">
                                        <i class="fas fa-{% if usuario.is_active %}pause{% else %}play{% endif %}"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if usuario.last_login %}
                                    <div style="color: var(--text-secondary); font-size: 14px;">
                                        {{ usuario.last_login|date:"d/m/Y" }}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-muted);">
                                        {{ usuario.last_login|date:"H:i" }}
                                    </div>
                                {% else %}
                                    <span style="color: var(--text-muted); font-size: 12px;">Nunca</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'usuarios:editar_usuario' usuario.pk %}" 
                                       class="btn btn-secondary btn-icon" 
                                       title="Editar usuário">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="{% url 'usuarios:alterar_senha_usuario' usuario.pk %}" 
                                       class="btn btn-warning btn-icon" 
                                       title="Alterar senha">
                                        <i class="fas fa-key"></i>
                                    </a>
                                    {% if usuario != request.user %}
                                    <form method="POST" action="{% url 'usuarios:deletar_usuario' usuario.pk %}" id="delete-form-{{ usuario.pk }}" style="display: none;">
                                            {% csrf_token %}
                                        </form>

                                        <button type="button"
                                                class="js-confirm-delete-user"
                                                data-form-id="delete-form-{{ usuario.pk }}"
                                                data-user-name="{{ usuario.get_full_name|default:usuario.username }}">
                                            Deletar Usuário
                                        </button>

                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if page_obj.has_other_pages %}
            <div class="pagination">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if grupo %}&grupo={{ grupo }}{% endif %}" title="Primeira página">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if grupo %}&grupo={{ grupo }}{% endif %}" title="Página anterior">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <span class="current">{{ num }}</span>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <a href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if grupo %}&grupo={{ grupo }}{% endif %}">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if grupo %}&grupo={{ grupo }}{% endif %}" title="Próxima página">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if grupo %}&grupo={{ grupo }}{% endif %}" title="Última página">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </div>
            {% endif %}
        {% else %}
            <!-- Estado Vazio -->
            <div style="text-align: center; padding: 64px 24px; color: var(--text-muted);">
                <i class="fas fa-users" style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;"></i>
                <h3 style="margin-bottom: 12px; color: var(--text-secondary);">
                    {% if search or status or grupo %}
                        Nenhum usuário encontrado
                    {% else %}
                        Nenhum usuário cadastrado
                    {% endif %}
                </h3>
                <p style="margin-bottom: 24px;">
                    {% if search or status or grupo %}
                        Tente ajustar os filtros de busca.
                    {% else %}
                        Comece criando o primeiro usuário do sistema.
                    {% endif %}
                </p>
                {% if not search and not status and not grupo %}
                <a href="{% url 'usuarios:criar_usuario' %}" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    Criar Usuário
                </a>
                {% else %}
                <a href="?" class="btn btn-secondary">
                    <i class="fas fa-times"></i>
                    Limpar Filtros
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Confirmação para Exclusão -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--radius-lg); padding: 32px; max-width: 400px; width: 90%; box-shadow: var(--shadow-xl);">
        <div style="text-align: center; margin-bottom: 24px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 16px;"></i>
            <h3 style="margin-bottom: 8px;">Confirmar Exclusão</h3>
            <p style="color: var(--text-secondary);">Esta ação não pode ser desfeita.</p>
        </div>
        <div style="display: flex; gap: 12px; justify-content: center;">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancelar</button>
            <a id="confirmDeleteBtn" href="#" class="btn btn-danger">Excluir</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Função para confirmar exclusão
    function confirmDelete(url, userName) {
        document.getElementById('confirmDeleteBtn').href = url;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    // Fechar modal clicando fora
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });

    // Função para alternar status do usuário
    function toggleUserStatus(userId) {
        const btn = document.getElementById(`toggleBtn${userId}`);
        const originalHtml = btn.innerHTML;
        
        btn.innerHTML = '<span class="spinner"></span>';
        btn.disabled = true;
        
        fetch(`{% url 'usuarios:toggle_usuario_status' 0 %}`.replace('0', userId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Recarregar a página para atualizar o status
                location.reload();
            } else {
                alert(data.message);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao alterar status do usuário');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
    }

    // Função para selecionar/deselecionar todos os usuários
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.user-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkActions();
    }

    // Atualizar ações em lote
    function updateBulkActions() {
        const selectedUsers = document.querySelectorAll('.user-checkbox:checked');
        const bulkActions = document.getElementById('bulkActions');
        
        if (selectedUsers.length > 0) {
            if (!bulkActions) {
                createBulkActionsBar(selectedUsers.length);
            } else {
                updateBulkActionsCount(selectedUsers.length);
            }
        } else {
            removeBulkActionsBar();
        }
    }

    // Criar barra de ações em lote
    function createBulkActionsBar(count) {
        const bulkActionsHtml = `
            <div id="bulkActions" style="position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 16px 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); display: flex; align-items: center; gap: 16px; z-index: 1000;">
                <span id="bulkCount">${count} usuário${count > 1 ? 's' : ''} selecionado${count > 1 ? 's' : ''}</span>
                <div style="display: flex; gap: 8px;">
                    <button onclick="bulkAction('activate')" class="btn btn-success btn-sm">
                        <i class="fas fa-check"></i>
                        Ativar
                    </button>
                    <button onclick="bulkAction('deactivate')" class="btn btn-warning btn-sm">
                        <i class="fas fa-pause"></i>
                        Desativar
                    </button>
                    <button onclick="bulkAction('delete')" class="btn btn-danger btn-sm">
                        <i class="fas fa-trash"></i>
                        Excluir
                    </button>
                    <button onclick="clearSelection()" class="btn btn-secondary btn-sm">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', bulkActionsHtml);
    }

    // Atualizar contador de ações em lote
    function updateBulkActionsCount(count) {
        const bulkCount = document.getElementById('bulkCount');
        if (bulkCount) {
            bulkCount.textContent = `${count} usuário${count > 1 ? 's' : ''} selecionado${count > 1 ? 's' : ''}`;
        }
    }

    // Remover barra de ações em lote
    function removeBulkActionsBar() {
        const bulkActions = document.getElementById('bulkActions');
        if (bulkActions) {
            bulkActions.remove();
        }
    }

    // Limpar seleção
    function clearSelection() {
        document.getElementById('selectAll').checked = false;
        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
        removeBulkActionsBar();
    }

    // Executar ação em lote
    function bulkAction(action) {
        const selectedIds = getSelectedUserIds();
        
        if (selectedIds.length === 0) {
            alert('Nenhum usuário selecionado');
            return;
        }
        
        let confirmMessage = '';
        switch(action) {
            case 'activate':
                confirmMessage = `Ativar ${selectedIds.length} usuário(s)?`;
                break;
            case 'deactivate':
                confirmMessage = `Desativar ${selectedIds.length} usuário(s)?`;
                break;
            case 'delete':
                confirmMessage = `Excluir ${selectedIds.length} usuário(s)? Esta ação não pode ser desfeita.`;
                break;
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
        
        const formData = new FormData();
        formData.append('action', action);
        selectedIds.forEach(id => formData.append('user_ids', id));
        
        fetch('{% url "usuarios:bulk_action_usuarios" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao executar ação em lote');
        });
    }

    // Obter IDs dos usuários selecionados
    function getSelectedUserIds() {
        const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
        return Array.from(selectedCheckboxes).map(cb => cb.value);
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Adicionar listeners para checkboxes individuais
        document.querySelectorAll('.user-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });
        
        // Busca em tempo real
        const searchInput = document.querySelector('input[name="search"]');
        let searchTimeout;
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (this.value.length >= 3 || this.value.length === 0) {
                        this.form.submit();
                    }
                }, 500);
            });
        }
    });

    // Função para exportar usuários
    function exportarUsuarios() {
        alert('Funcionalidade de exportação será implementada');
    }

    // Função para imprimir tabela
    function imprimirTabela() {
        const printContent = document.getElementById('usuariosTable').outerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Lista de Usuários - Impressão</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        .btn, .user-checkbox, #selectAll { display: none; }
                    </style>
                </head>
                <body>
                    <h1>Lista de Usuários</h1>
                    ${printContent}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    }

    // Atalhos de teclado
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + A para selecionar todos
        if ((e.ctrlKey || e.metaKey) && e.key === 'a' && !e.target.matches('input[type="text"], textarea')) {
            e.preventDefault();
            document.getElementById('selectAll').checked = true;
            toggleSelectAll();
        }
        
        // Delete para excluir selecionados
        if (e.key === 'Delete') {
            const selectedIds = getSelectedUserIds();
            if (selectedIds.length > 0) {
                bulkAction('delete');
            }
        }
    });
</script>
{% endblock %}


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\usuarios\grupos\form.html

{% extends 'auditorias/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}

<style>
    /* ================================================================== */
    /* 1. ESTILOS GLOBAIS DA PÁGINA (Ajustado para TELA CHEIA)            */
    /* ================================================================== */
    .main-container {
        width: 100%;       /* Ocupa 100% da largura disponível */
        max-width: none;   /* Remove a limitação de 1200px */
        padding: 0 20px;   /* Pequeno respiro nas laterais */
    }

    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        margin-top: 20px;
    }
    .content-title { font-size: 28px; font-weight: 700; margin-bottom: 4px; color: #333; }
    .content-subtitle { color: #64748b; font-size: 14px; }

    /* Botões Padrão */
    .btn-secondary {
        background-color: #fff; color: #333; border: 1px solid #ddd;
        padding: 8px 16px; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; transition: all 0.2s;
    }
    .btn-secondary:hover { background-color: #f8f9fa; }

    /* Card Padrão */
    .card {
        background: #fff; border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0;
        margin-bottom: 24px;
        width: 100%; /* Garante que o card estique */
    }
    .card-body { padding: 32px; }

    /* Inputs Padrão (.form-control) */
    .form-group { margin-bottom: 24px; }
    .form-label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 12px; color: #1F54DE; text-transform: uppercase; letter-spacing: 0.5px; }
    
    .form-control {
        width: 100%; padding: 12px 16px; border: 1px solid #d1d5db;
        border-radius: 6px; font-size: 14px; transition: all 0.2s ease; height: 50px;
    }
    .form-control:focus { outline: none; border-color: #1F54DE; box-shadow: 0 0 0 3px rgba(31, 84, 222, 0.1); }
    .field-help { font-size: 13px; color: #64748b; margin-top: 6px; }

    /* Botão Salvar Largo */
    .btn-save-full {
        width: 100%; background-color: #1F54DE; color: white; border: none;
        padding: 14px; border-radius: 6px; font-weight: 700; cursor: pointer;
        font-size: 15px; transition: background 0.2s; margin-top: 10px;
    }
    .btn-save-full:hover { background-color: #1643b8; }


    /* ================================================================== */
    /* 2. ESTILOS DA MATRIZ DE PERMISSÕES (Mantidos intactos)             */
    /* ================================================================== */
    .accordion-item { margin-bottom: 10px; border: 1px solid #e3e6f0; border-radius: 6px; overflow: hidden; width: 100%; }
    .accordion-header {
        background-color: #f8f9fc; padding: 12px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: #4e73df; font-size: 14px; border-radius: 4px; transition: background 0.2s;
    }
    .accordion-header:hover { background-color: #eaecf4; }
    .accordion-icon { transition: transform 0.3s ease; color: #858796; }
    .accordion-header.active .accordion-icon { transform: rotate(180deg); }
    .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: white; border-top: 1px solid #e3e6f0; }
    
    .table-custom { width: 100%; border-collapse: collapse; margin: 0; }
    .table-custom th { text-align: center; font-size: 11px; font-weight: 800; color: #b7b9cc; text-transform: uppercase; padding: 12px; background: #fff; border-bottom: 1px solid #e3e6f0; }
    .table-custom th.text-left { text-align: left; padding-left: 20px; }
    .table-custom td { padding: 12px; border-bottom: 1px solid #fdfdfe; vertical-align: middle; text-align: center; color: #5a5c69; font-size: 13px; font-weight: 600; }
    .table-custom td.text-left { text-align: left; padding-left: 20px; }
    .table-custom tr:hover td { background-color: #f8f9fc; }
    .table-custom tr:last-child td { border-bottom: none; }
    
    .check-custom { width: 18px; height: 18px; accent-color: #1F54DE; cursor: pointer; margin-top: 5px; }
    .no-perm-dash { color: #e3e6f0; font-weight: bold; }
</style>

<div class="main-container">

    <div class="content-header">
        <div>
            <h2 class="content-title">{% if grupo %}Editando: {{ grupo.name }}{% else %}Novo Perfil de Acesso{% endif %}</h2>
            <p class="content-subtitle">Defina o nome e descrição do grupo e marque as permissões que ele pode ter.</p>
        </div>
        <a href="{% url 'usuarios:lista_grupos' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>

    <form method="post" id="permForm">
        {% csrf_token %}
        
        <div class="card">
            <div class="card-body">
                
                <div class="form-group required">
                    <label for="name" class="form-label">Nome do Perfil de Acesso</label>
                    <input type="text" name="name" id="name" class="form-control" 
                           value="{{ grupo.name|default:'' }}" 
                           placeholder="Ex: Auditor, Gerente, Administrador" required>
                    <div class="field-help">Dê um nome claro para identificar a função deste grupo.</div>
                </div>

                <div class="form-group">
                    <label for="descricao" class="form-label">Descrição</label>
                    <input type="text" name="descricao" id="descricao" class="form-control" 
                           value="{{ grupo.detalhe.descricao|default:'' }}" 
                           placeholder="Descreva as responsabilidades deste perfil...">
                </div>

                <button type="submit" class="btn-save-full">
                    <i class="fas fa-save mr-2"></i> Salvar Perfil
                </button>

            </div>
        </div>

        <h4 style="color: #333; margin-top: 32px; margin-bottom: 16px; font-weight: 700; font-size: 18px;">
            <i class="fas fa-lock" style="margin-right: 8px;"></i>
            Permissões do Sistema
        </h4>

        {% if perms_agrupadas %}
            {% for app_nome, funcionalidades in perms_agrupadas.items %}
            <div class="accordion-item">
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <span>{{ app_nome }}</span>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
                
                <div class="accordion-body">
                    <table class="table-custom">
                        <thead>
                            <tr>
                                <th class="text-left" style="width: 40%;">Funcionalidade</th>
                                <th style="width: 15%;">Criar</th>
                                <th style="width: 15%;">Visualizar</th>
                                <th style="width: 15%;">Editar</th>
                                <th style="width: 15%;">Excluir</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for func in funcionalidades %}
                            <tr>
                                <td class="text-left">{{ func.nome }}</td>
                                
                                <td>
                                    {% if func.acoes.add %}
                                        <input type="checkbox" name="permissoes" value="{{ func.acoes.add.id }}" 
                                            class="check-custom"
                                            {% if func.acoes.add.id in grupo_perms_ids %}checked{% endif %}>
                                    {% else %}<span class="no-perm-dash">-</span>{% endif %}
                                </td>

                                <td>
                                    {% if func.acoes.view %}
                                        <input type="checkbox" name="permissoes" value="{{ func.acoes.view.id }}" 
                                            class="check-custom"
                                            {% if func.acoes.view.id in grupo_perms_ids %}checked{% endif %}>
                                    {% else %}<span class="no-perm-dash">-</span>{% endif %}
                                </td>

                                <td>
                                    {% if func.acoes.change %}
                                        <input type="checkbox" name="permissoes" value="{{ func.acoes.change.id }}" 
                                            class="check-custom"
                                            {% if func.acoes.change.id in grupo_perms_ids %}checked{% endif %}>
                                    {% else %}<span class="no-perm-dash">-</span>{% endif %}
                                </td>

                                <td>
                                    {% if func.acoes.delete %}
                                        <input type="checkbox" name="permissoes" value="{{ func.acoes.delete.id }}" 
                                            class="check-custom"
                                            {% if func.acoes.delete.id in grupo_perms_ids %}checked{% endif %}>
                                    {% else %}<span class="no-perm-dash">-</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-light border text-center">
                Nenhuma permissão carregada.
            </div>
        {% endif %}

        <div style="height: 50px;"></div>
    </form>
</div>

{% block extra_js_script %}
<script>
    function toggleAccordion(header) {
        header.classList.toggle('active');
        var body = header.nextElementSibling;
        if (body.style.maxHeight) {
            body.style.maxHeight = null;
        } else {
            body.style.maxHeight = body.scrollHeight + "px";
        }
    }
    document.addEventListener("DOMContentLoaded", function() {
        const firstHeader = document.querySelector('.accordion-header');
        if(firstHeader) {
            toggleAccordion(firstHeader);
        }
    });
</script>
{% endblock %}

{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templates\usuarios\grupos\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block title %}Perfis de Acesso{% endblock %}
{% block page_title %}Perfis de Acesso{% endblock %}

{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        
        <div>
            <h2 class="content-title" style="margin-bottom: 8px; font-weight: bold; color: #333;">Perfis de Acesso</h2>
            <p class="content-subtitle text-muted mb-0">Gerencie os cargos e permissões dos usuários do sistema.</p>
        </div>

        <div>
            {# TRAVA DE SEGURANÇA: Só mostra se tiver permissão auth.add_group #}
            {% if perms.auth.add_group %}
            <a href="{% url 'usuarios:criar_grupo' %}" class="btn btn-primary shadow-sm">
                <i class="fas fa-plus mr-2"></i>
                Novo Grupo
            </a>
            {% endif %}
            
            <a href="{% url 'usuarios:lista_usuarios' %}" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-arrow-left" style="color: #666;"></i> Voltar
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block search_form %}{% endblock %}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    <tr>
        <th>Nome do Perfil</th>
        <th style="text-align: center;">Permissões</th>
        <th style="text-align: center;">Usuários Vinculados</th>
        <th style="width: 120px; text-align: center;">Ações</th>
    </tr>
{% endblock %}

{% block table_row %}
    <td class="align-middle">
        <div style="font-weight: 700; color: #2563EC; font-size: 14px;">
            {{ object.name }}
        </div>
        <div style="font-size: 12px; color: #858796; margin-top: 2px;">
            {{ object.detalhe.descricao|default:"Sem descrição definida." }}
        </div>
    </td>
    <td style="text-align: center;" class="align-middle">
        <span class="badge badge-info">{{ object.permissions.count }} permissões</span>
    </td>
    <td style="text-align: center;" class="align-middle">
        <span style="color: var(--text-secondary); font-weight: 500;">
            <i class="fas fa-user-friends mr-1" style="color: #b7b9cc;"></i> 
            {{ object.total_usuarios }} usuário{{ object.total_usuarios|pluralize }}
        </span>
    </td>
    <td style="text-align: center;" class="align-middle">
        <div class="action-buttons" style="justify-content: center;">
            {% if perms.auth.change_group %}
            <a href="{% url 'usuarios:editar_grupo' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Perfil"
               style="background: #fff; border: 1px solid #d1d3e2; color: #858796;">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}

            {% if perms.auth.delete_group %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Perfil"
                    onclick="confirmDelete('{% url 'usuarios:deletar_grupo' object.pk %}', '{{ object.name }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templatetags\auditoria_extras.py

# auditorias/templatetags/auditoria_extras.py

from django import template

register = template.Library()


@register.filter
def get_item(dictionary, key):
    """
    Permite acessar itens de um dicionário usando uma variável no template.
    Ex: {{ meu_dicionario|get_item:minha_chave }}
    """
    return dictionary.get(key)


@register.filter
def rem_page_param(query_dict):
    """
    Remove o parâmetro 'page' de um QueryDict (request.GET)
    para ser usado na paginação.
    Ex: {{ request.GET.urlencode|rem_page_param }}
    """
    # Cria uma cópia mutável do QueryDict
    query_dict = query_dict.copy()

    # Remove a chave 'page' se ela existir
    if 'page' in query_dict:
        del query_dict['page']

    # Retorna a string de query codificada sem o 'page'
    return query_dict.urlencode()


@register.filter
def abreviar_status(texto_status):
    """
    Abrevia os status longos para exibição na tabela.
    """
    if not texto_status:
        return ""

    mapeamento = {
        'Aguardando Validação': 'Ag. Validação',
        'Aguardando Aprovação': 'Ag. Aprovação',
        'Validação de Eficácia': 'Val. Eficácia',
        'Em Implementação': 'Implementação',  # Opcional: remove o "Em"
        'Desvio Solucionado': 'Solucionado',
        'Não Conformidade': 'NC',
        'Oportunidade de Melhoria': 'OM'
    }

    # Retorna o valor abreviado se existir no mapa, senão retorna o original
    return mapeamento.get(texto_status, texto_status)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templatetags\comparacao_filter.py

from django import template

register = template.Library()


@register.filter
def get_item(dictionary, key):
    """
    Template filter para acessar itens de um dicionário por chave.
    Uso: {{ dict|get_item:key }}
    """
    if dictionary is None:
        return None
    return dictionary.get(key)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\auditorias\templatetags\__init__.py



_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\cadastros_base\admin.py

# cadastros_base/admin.py

from django.contrib import admin
from .models import UnidadeMedida, Turno, TurnoDetalheDia, DIAS_SEMANA_CHOICES
# Nao precisa importar timedelta aqui, pois ja esta no models.py

# Inline para permitir adicionar/editar detalhes diários de um turno na mesma página do Turno


class TurnoDetalheDiaInline(admin.TabularInline):
    model = TurnoDetalheDia
    extra = 0  # Não mostra formulários vazios extras por padrão
    # Permite ter 0 detalhes (se desejar um turno sem dias definidos)
    min_num = 0
    # Máximo de 7 entradas, uma para cada dia da semana
    max_num = len(DIAS_SEMANA_CHOICES)
    # Campos que serão exibidos no inline
    fields = ('dia_semana', 'hora_inicio', 'hora_fim',
              'intervalo', 'duracao_liquida_display')
    # Campos que serão apenas de leitura (não editáveis)
    readonly_fields = ('duracao_liquida_display',)

    # Opcional: Para ordenar a lista de dias na interface do admin
    # Isso pode ser feito no Meta do modelo TurnoDetalheDia (já feito com ordering = ['dia_semana'])


@admin.register(Turno)
class TurnoAdmin(admin.ModelAdmin):
    # Campos a serem exibidos na lista de Turnos
    list_display = (
        'descricao',
        'ativo',
        'tempo_disponivel_semanal_display',  # Propriedade calculada
        'dias_planejados_display',        # Propriedade calculada
        'horas_por_dia_display',         # Propriedade calculada
    )
    list_filter = ('ativo',)
    search_fields = ('descricao',)
    # Adiciona o inline para gerenciar os detalhes diários
    inlines = [TurnoDetalheDiaInline]

    # Campos que serão exibidos no formulário de edição/criação do Turno
    fields = ('descricao', 'ativo')


@admin.register(UnidadeMedida)
class UnidadeMedidaAdmin(admin.ModelAdmin):
    list_display = ('nome', 'simbolo', 'ativo', 'data_cadastro')
    list_filter = ('ativo',)
    search_fields = ('nome', 'simbolo')

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\cadastros_base\apps.py

from django.apps import AppConfig


class CadastrosBaseConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'cadastros_base'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\cadastros_base\models.py

# cadastros_base/models.py

from django.db import models
from datetime import timedelta  # Importe timedelta para trabalhar com durações
from django.utils import timezone  # Importe timezone para cálculos de data/hora

# Opções para os dias da semana (usaremos um inteiro para armazenar no BD e exibir o nome)
DIAS_SEMANA_CHOICES = [
    (0, 'Segunda-feira'),
    (1, 'Terça-feira'),
    (2, 'Quarta-feira'),
    (3, 'Quinta-feira'),
    (4, 'Sexta-feira'),
    (5, 'Sábado'),
    (6, 'Domingo'),
]


class UnidadeMedida(models.Model):
    nome = models.CharField(max_length=50, unique=True,
                            verbose_name="Nome da Unidade")
    simbolo = models.CharField(
        max_length=10, unique=True, verbose_name="Símbolo")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Unidade de Medida"
        verbose_name_plural = "Unidades de Medida"
        ordering = ['nome']

    def __str__(self):
        return f"{self.nome} ({self.simbolo})"


class Turno(models.Model):
    # 'nome' foi renomeado para 'descricao' para refletir a imagem
    descricao = models.CharField(
        max_length=100, unique=True, verbose_name="Descrição do Turno")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Turno"
        verbose_name_plural = "Turnos"
        ordering = ['descricao']  # Ordena por descrição

    def __str__(self):
        return self.descricao

    # Estes campos não são armazenados diretamente no banco de dados,
    # mas são calculados dinamicamente com base nos 'TurnoDetalheDia' relacionados.

    @property
    def tempo_disponivel_semanal_display(self):
        """Calcula o tempo total disponível na semana para este turno."""
        total_duration = timedelta(0)
        # Itera sobre todos os detalhes diários relacionados a este turno
        for detail in self.turnodetalhedia_set.all():
            # Soma a duração líquida de cada dia
            total_duration += detail.duracao_liquida_calculada

        total_seconds = total_duration.total_seconds()
        hours = int(total_seconds // 3600)
        minutes = int((total_seconds % 3600) // 60)

        if hours == 0 and minutes == 0:
            return "0 Hora(s)"
        elif minutes == 0:
            return f"{hours} Hora(s)" if hours == 1 else f"{hours} Horas(s)"
        else:
            return f"{hours}h {minutes}m"

    @property
    def dias_planejados_display(self):
        """Conta quantos dias têm um detalhe de turno definido."""
        # Filtra os detalhes que possuem hora de início definida
        count = self.turnodetalhedia_set.filter(
            hora_inicio__isnull=False).count()
        return f"{count} dia(s)" if count == 1 else f"{count} dias(s)"

    @property
    def horas_por_dia_display(self):
        """Calcula a média de horas por dia com base nos detalhes."""
        total_duration = timedelta(0)
        count = 0
        # Apenas dias com horários
        for detail in self.turnodetalhedia_set.filter(hora_inicio__isnull=False):
            total_duration += detail.duracao_liquida_calculada
            count += 1

        if count > 0:
            avg_seconds = total_duration.total_seconds() / count
            hours = int(avg_seconds // 3600)
            minutes = int((avg_seconds % 3600) // 60)
            if hours == 0 and minutes == 0:
                return "0 Hora(s)"
            elif minutes == 0:
                return f"{hours} Hora(s)" if hours == 1 else f"{hours} Horas(s)"
            else:
                return f"{hours}h {minutes}m"
        return "N/A"  # Se não houver dias planejados


class TurnoDetalheDia(models.Model):
    # Chave estrangeira para o modelo Turno
    turno = models.ForeignKey(
        Turno, on_delete=models.CASCADE, verbose_name="Turno")
    # Dia da semana (0=Segunda, 6=Domingo)
    dia_semana = models.IntegerField(
        choices=DIAS_SEMANA_CHOICES, verbose_name="Dia da Semana")
    hora_inicio = models.TimeField(
        null=True, blank=True, verbose_name="Início")
    hora_fim = models.TimeField(null=True, blank=True, verbose_name="Fim")
    # Intervalo será uma duração (ex: 18 horas de intervalo, como na sua imagem)
    intervalo = models.DurationField(default=timedelta(
        minutes=0), verbose_name="Intervalo (Duração)")

    class Meta:
        verbose_name = "Detalhe do Turno por Dia"
        verbose_name_plural = "Detalhes do Turno por Dia"
        # Garante que um turno só pode ter um detalhe por dia da semana
        unique_together = ('turno', 'dia_semana')
        ordering = ['dia_semana']  # Ordena os detalhes por dia da semana

    def __str__(self):
        return f"{self.turno.descricao} - {self.get_dia_semana_display()}"

    # --- Propriedades calculadas para a duração líquida do dia ---

    @property
    def duracao_liquida_calculada(self):
        """Calcula a duração líquida do turno para o dia, considerando intervalo e virada de dia."""
        if self.hora_inicio and self.hora_fim:
            # Combina a hora com uma data fictícia para criar objetos datetime
            start_dt = timezone.datetime.combine(
                timezone.now().date(), self.hora_inicio)
            end_dt = timezone.datetime.combine(
                timezone.now().date(), self.hora_fim)

            # Se a hora de fim for menor que a hora de início, significa que o turno virou o dia
            if end_dt < start_dt:
                end_dt += timedelta(days=1)  # Adiciona um dia à data de fim

            gross_duration = end_dt - start_dt  # Duração bruta
            # Duração líquida (bruta - intervalo)
            net_duration = gross_duration - self.intervalo

            # Evita duração negativa se o intervalo for maior que a duração bruta
            if net_duration < timedelta(0):
                # Retorna zero ou levanta um erro, dependendo da regra de negócio
                return timedelta(0)

            return net_duration
        # Retorna duração zero se as horas não estiverem definidas
        return timedelta(0)

    @property
    def duracao_liquida_display(self):
        """Formata a duração líquida para exibição (ex: '1 Hora', '8h 30m')."""
        duration = self.duracao_liquida_calculada
        total_seconds = duration.total_seconds()
        hours = int(total_seconds // 3600)
        minutes = int((total_seconds % 3600) // 60)

        if hours == 0 and minutes == 0:
            return "0 Horas"
        elif minutes == 0:
            return f"{hours} Hora(s)" if hours == 1 else f"{hours} Horas"
        else:
            return f"{hours}h {minutes}m"

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\cadastros_base\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\cadastros_base\views.py

from django.shortcuts import render

# Create your views here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\cadastros_base\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\admin.py

# clientes/admin.py

from django.contrib import admin
from .models import Cliente


@admin.register(Cliente)
class ClienteAdmin(admin.ModelAdmin):
    list_display = (
        'nome',
        'npr',
        'email',
        'usuario_responsavel',  # Exibe o usuário associado
        'ativo',
        'data_cadastro'
    )
    list_filter = ('ativo', 'usuario_responsavel')
    search_fields = ('nome', 'npr', 'email', 'usuario_responsavel__username',
                     'usuario_responsavel__first_name', 'usuario_responsavel__last_name')
    fieldsets = (
        (None, {
            'fields': ('nome', 'npr', 'email', 'logo_cliente')
        }),
        ('Associação', {
            'fields': ('usuario_responsavel',)
        }),
        ('Status', {
            'fields': ('ativo',)
        }),
    )

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\apps.py

from django.apps import AppConfig


class ClientesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'clientes'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\models.py

# clientes/models.py

from django.db import models
# Importar o modelo de Usuário padrão do Django
from django.contrib.auth.models import User
from django.conf import settings


class Cliente(models.Model):
    nome = models.CharField(max_length=200, unique=True,
                            verbose_name="Nome do Cliente")
    # Assumi que NPR é um campo de texto/código
    npr = models.CharField(max_length=50, null=True,
                           blank=True, verbose_name="NPR")
    email = models.EmailField(
        max_length=255, unique=True, null=True, blank=True, verbose_name="E-mail")

    # Relação com o modelo de Usuário padrão do Django
    # Um cliente pode ter um usuário associado (ex: o responsável pelo cliente no sistema)
    usuario_responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,  # Se o usuário for apagado, o campo no cliente fica nulo
        null=True, blank=True,
        verbose_name="Usuário Responsável",
        related_name='clientes_responsavel'  # Nome para a relação reversa
    )

    # Campo para o logo do cliente
    logo_cliente = models.ImageField(
        upload_to='clientes_logos/', null=True, blank=True, verbose_name="Logo do Cliente")

    # Campos de controle
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Cliente"
        verbose_name_plural = "Clientes"
        ordering = ['nome']

    def __str__(self):
        return self.nome

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\urls.py

# clientes/urls.py

from django.urls import path
from . import views

app_name = 'clientes'

urlpatterns = [
    # URLs para Clientes
    path('', views.lista_clientes, name='lista_clientes'),
    path('criar/', views.criar_cliente, name='criar_cliente'),
    path('<int:pk>/editar/', views.editar_cliente, name='editar_cliente'),
    path('<int:pk>/deletar/', views.deletar_cliente, name='deletar_cliente'),
]

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\views.py

# clientes/views.py

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.db.models import Q
from .models import Cliente
from usuarios.models import Usuario

@login_required
def lista_clientes(request):
    """Lista todos os clientes com busca e paginação."""
    search = request.GET.get('search', '')
    clientes = Cliente.objects.select_related('usuario_responsavel').order_by('nome')

    if search:
        clientes = clientes.filter(
            Q(nome__icontains=search) |
            Q(npr__icontains=search) |
            Q(email__icontains=search) |
            Q(usuario_responsavel__username__icontains=search)
        )

    paginator = Paginator(clientes, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Clientes',
        'singular': 'Cliente',
        'button_text': 'Novo Cliente',
        'create_url': 'clientes:criar_cliente',
        'artigo': 'o',
        'empty_message': 'Nenhum cliente cadastrado.',
        'empty_subtitle': 'Comece criando o primeiro cliente.'
    }
    return render(request, 'clientes/lista.html', context)

@login_required
def criar_cliente(request):
    """Cria um novo cliente."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        if not nome:
            messages.error(request, 'O nome do cliente é obrigatório.')
        else:
            try:
                cliente = Cliente(
                    nome=nome,
                    npr=request.POST.get('npr'),
                    email=request.POST.get('email'),
                    ativo=request.POST.get('ativo') == 'on',
                    usuario_responsavel_id=request.POST.get('usuario_responsavel') or None
                )
                if request.FILES.get('logo_cliente'):
                    cliente.logo_cliente = request.FILES['logo_cliente']
                
                cliente.save()
                messages.success(request, 'Cliente criado com sucesso!')
                return redirect('clientes:lista_clientes')
            except Exception as e:
                messages.error(request, f'Erro ao criar cliente: {e}')

    context = {
        'title': 'Criar Cliente',
        'back_url': 'clientes:lista_clientes',
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'clientes/form.html', context)

@login_required
def editar_cliente(request, pk):
    """Edita um cliente existente."""
    cliente = get_object_or_404(Cliente, pk=pk)
    if request.method == 'POST':
        nome = request.POST.get('nome')
        if not nome:
            messages.error(request, 'O nome do cliente é obrigatório.')
        else:
            try:
                cliente.nome = nome
                cliente.npr = request.POST.get('npr')
                cliente.email = request.POST.get('email')
                cliente.ativo = request.POST.get('ativo') == 'on'
                cliente.usuario_responsavel_id = request.POST.get('usuario_responsavel') or None
                
                if request.FILES.get('logo_cliente'):
                    cliente.logo_cliente = request.FILES['logo_cliente']

                cliente.save()
                messages.success(request, 'Cliente atualizado com sucesso!')
                return redirect('clientes:lista_clientes')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar cliente: {e}')

    context = {
        'object': cliente,
        'title': 'Editar Cliente',
        'back_url': 'clientes:lista_clientes',
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'clientes/form.html', context)

@login_required
def deletar_cliente(request, pk):
    """Deleta um cliente."""
    cliente = get_object_or_404(Cliente, pk=pk)
    if request.method == 'POST':
        try:
            cliente.delete()
            messages.success(request, 'Cliente deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar cliente: {e}')
        return redirect('clientes:lista_clientes')

    context = {
        'object': cliente,
        'title': 'Cliente'
    }
    return render(request, 'auditorias/deletar_generico.html', context)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\templates\clientes\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Cliente</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ object.nome|default:'' }}" required maxlength="200">
    </div>
    <div class="form-group">
        <label for="npr" class="form-label">NPR</label>
        <input type="text" id="npr" name="npr" class="form-control" value="{{ object.npr|default:'' }}" maxlength="50">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="email" class="form-label">Email</label>
        <input type="email" id="email" name="email" class="form-control" value="{{ object.email|default:'' }}" maxlength="255">
    </div>
    <div class="form-group">
        <label for="usuario_responsavel" class="form-label">Responsável</label>
        <select id="usuario_responsavel" name="usuario_responsavel" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.pk }}" {% if object.usuario_responsavel.pk == usuario.pk %}selected{% endif %}>{{ usuario.get_full_name|default:usuario.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-group">
    <label for="logo_cliente" class="form-label">Logo do Cliente</label>
    {% if object.logo_cliente %}
    <p>Logo atual: <a href="{{ object.logo_cliente.url }}" target="_blank">{{ object.logo_cliente.name }}</a></p>
    {% endif %}
    <input type="file" id="logo_cliente" name="logo_cliente" class="form-control" accept="image/*">
</div>
<div class="form-group">
    <label class="form-label">Status</label>
    <div style="display: flex; align-items: center; gap: 12px;">
        <label class="toggle-switch">
            <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px;">Cliente ativo no sistema</span>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\clientes\templates\clientes\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome do Cliente</th>
    <th>NPR</th>
    <th>Email</th>
    <th>Responsável</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="display: flex; align-items: center; gap: 12px;">
            {% if object.logo_cliente %}
                <img src="{{ object.logo_cliente.url }}" alt="Logo" style="width: 40px; height: 40px; border-radius: var(--radius-sm); object-fit: contain;">
            {% else %}
                <div class="user-avatar" style="width: 40px; height: 40px; font-size: 14px; border-radius: var(--radius-sm);">
                    {{ object.nome.0|upper }}
                </div>
            {% endif %}
            <div style="font-weight: 600; color: var(--text-primary);">
                {{ object.nome }}
            </div>
        </div>
    </td>
    <td>{{ object.npr|default:"—" }}</td>
    <td>{{ object.email|default:"—" }}</td>
    <td>{{ object.usuario_responsavel.get_full_name|default:object.usuario_responsavel.username|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'clientes:editar_cliente' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Cliente">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Cliente"
                    onclick="confirmDelete('{% url 'clientes:deletar_cliente' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\core\asgi.py

"""
ASGI config for core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_asgi_application()

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\core\settings.py

from django.contrib.messages import constants as messages
import os
from pathlib import Path
import dj_database_url

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-your-secret-key-here-change-in-production'

DEBUG = True

# SECURITY WARNING: don't run with debug turned on in production!
# DEBUG = os.environ.get('DEBUG', 'False') == 'True'

ALLOWED_HOSTS = ['*']

# Application definition
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'corsheaders',

    # Apps locais (adicione todos os seus apps aqui)
    'auditorias',
    'usuarios',
    'itens',
    'organizacao',          # <-- ADICIONADO (Causa principal do erro)
    'cadastros_base',       # <-- ADICIONADO
    'ativos',               # <-- ADICIONADO
    'clientes',             # <-- ADICIONADO
    'fornecedores',         # <-- ADICIONADO
    'planos_de_acao',       # <-- ADICIONADO

    # Apps de terceiros (se necessário)
    'rest_framework',
    'rest_framework.authtoken',
    'drf_spectacular',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [
            BASE_DIR / 'templates',
            BASE_DIR / 'auditorias' / 'templates',  # Mantemos para usar o base.html
            BASE_DIR / 'usuarios' / 'templates',
            BASE_DIR / 'itens' / 'templates',  # <-- ADICIONADO
            BASE_DIR / 'organizacao' / 'templates',
        ],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'core.wsgi.application'

# Database
DATABASES = {
    'default': dj_database_url.config(
        # O 'default' abaixo serve apenas para quando você roda no seu PC (SQLite)
        # No Render, ele vai ignorar isso e usar a variável DATABASE_URL automaticamente
        default='sqlite:///' + os.path.join(BASE_DIR, 'db.sqlite3'),
        conn_max_age=600
    )
}

# Password validation
AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
        'OPTIONS': {
            'min_length': 8,
        }
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

# Internationalization
LANGUAGE_CODE = 'pt-br'
TIME_ZONE = 'America/Sao_Paulo'
USE_I18N = True
USE_TZ = True

# Static files (CSS, JavaScript, Images)
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]

# Media files
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# Default primary key field type
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Configurações de autenticação
AUTH_USER_MODEL = 'usuarios.Usuario'
LOGIN_URL = '/login/'
LOGIN_REDIRECT_URL = '/auditorias/dashboard'
LOGOUT_REDIRECT_URL = '/login/'

# Configurações de sessão
SESSION_COOKIE_AGE = 86400  # 24 horas
SESSION_EXPIRE_AT_BROWSER_CLOSE = False
SESSION_SAVE_EVERY_REQUEST = True

# Configurações de segurança
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# Configurações de email (para produção)
EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'  # Para desenvolvimento
# EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'  # Para produção
# EMAIL_HOST = 'smtp.gmail.com'
# EMAIL_PORT = 587
# EMAIL_USE_TLS = True
# EMAIL_HOST_USER = 'seu-email@gmail.com'
# EMAIL_HOST_PASSWORD = 'sua-senha-de-app'

# Configurações de logging
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': BASE_DIR / 'logs' / 'django.log',
            'formatter': 'verbose',
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'console'],
            'level': 'INFO',
            'propagate': False,
        },
        'auditorias': {
            'handlers': ['file', 'console'],
            'level': 'DEBUG',
            'propagate': False,
        },
        'usuarios': {
            'handlers': ['file', 'console'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
}

# Configurações específicas do sistema de auditorias
AUDITORIAS_CONFIG = {
    'ITEMS_PER_PAGE': 10,
    'MAX_UPLOAD_SIZE': 10 * 1024 * 1024,  # 10MB
    'ALLOWED_FILE_TYPES': ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'jpg', 'jpeg', 'png'],
    'AUTO_BACKUP_ENABLED': True,
    'BACKUP_RETENTION_DAYS': 30,
}

# Configurações de cache (para produção)
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
        'LOCATION': 'unique-snowflake',
    }
}

# Configurações para produção
if not DEBUG:
    # Configurações de segurança para produção
    SECURE_SSL_REDIRECT = True
    SECURE_HSTS_SECONDS = 31536000
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')

    # Configurações de cache para produção
    CACHES = {
        'default': {
            'BACKEND': 'django.core.cache.backends.redis.RedisCache',
            'LOCATION': 'redis://127.0.0.1:6379/1',
        }
    }

# Configurações de mensagens
MESSAGE_TAGS = {
    messages.DEBUG: 'debug',
    messages.INFO: 'info',
    messages.SUCCESS: 'success',
    messages.WARNING: 'warning',
    messages.ERROR: 'error',
}

# Configurações de paginação
PAGINATE_BY = 10

# Configurações de formato de data
DATE_FORMAT = 'd/m/Y'
DATETIME_FORMAT = 'd/m/Y H:i'
SHORT_DATE_FORMAT = 'd/m/Y'
SHORT_DATETIME_FORMAT = 'd/m/Y H:i'

# Configurações de fuso horário
USE_L10N = True
USE_TZ = True

# Configurações de arquivos estáticos para produção
if not DEBUG:
    STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.StaticFilesStorage'

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.TokenAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
}

SPECTACULAR_SETTINGS = {
    'TITLE': 'API do Sistema de Gestão de Auditorias',
    'DESCRIPTION': 'Documentação detalhada da API para o sistema de auditorias, '
                   'utilizada pelo aplicativo web e mobile.',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\core\urls.py

# core/urls.py
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static
from django.shortcuts import redirect
from django.contrib.auth import views as auth_views
from drf_spectacular.views import SpectacularAPIView, SpectacularRedocView, SpectacularSwaggerView

# Importe as views da API diretamente
from usuarios.views import CustomAuthToken, MeuPerfilAPIView, AlterarMinhaSenhaAPIView
from auditorias.views import (
    AuditoriasPendentesAPIView,
    AuditoriasConcluidasAPIView,
    AuditoriaInstanciaDetailAPIView,
    SubmeterAuditoriaAPIView,
    LocaisPermitidosAPIView,
    AuditoriasQuarentenaAPIView,
)


def redirect_to_auditorias(request):
    return redirect('auditorias:dashboard')


urlpatterns = [
    path('admin/', admin.site.urls),
    path('', redirect_to_auditorias, name='home'),
    path('login/', auth_views.LoginView.as_view(template_name='registration/login.html'), name='login'),
    path('logout/', auth_views.LogoutView.as_view(
        http_method_names=['get', 'post']), name='logout'),
    path('auditorias/', include('auditorias.urls')),
    path('usuarios/', include('usuarios.urls')),
    path('itens/', include('itens.urls')),
    path('ativos/', include('ativos.urls')),
    path('organizacao/', include('organizacao.urls')),
    # <-- ADICIONE ESTA LINHA
    path('clientes/', include('clientes.urls')),
    # <-- ADICIONE ESTA LINHA
    path('fornecedores/', include('fornecedores.urls')),

    path('planos_de_acao/', include('planos_de_acao.urls')),

    # URLs DA API E DOCUMENTAÇÃO
    # ============================================================================
    path('api/schema/', SpectacularAPIView.as_view(), name='schema'),
    # Interface Swagger UI:
    path('api/schema/swagger-ui/',
         SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
    # Interface Redoc:
    path('api/schema/redoc/',
         SpectacularRedocView.as_view(url_name='schema'), name='redoc'),
]

# URLs da API centralizadas
api_urlpatterns = [
    # Autenticação e Usuário
    path('login/', CustomAuthToken.as_view(), name='api_login'),
    path('meu-perfil/', MeuPerfilAPIView.as_view(), name='api_meu_perfil'),
    path('alterar-minha-senha/', AlterarMinhaSenhaAPIView.as_view(),
         name='api_alterar_minha_senha'),

    # Auditorias
    path('auditorias/pendentes/', AuditoriasPendentesAPIView.as_view(),
         name='api_auditorias_pendentes'),
    path('auditorias/quarentena/', AuditoriasQuarentenaAPIView.as_view(),
         name='api_auditorias_quarentena'),
    path('auditorias/concluidas/', AuditoriasConcluidasAPIView.as_view(),
         name='api_auditorias_concluidas'),
    path('instancias/<int:pk>/', AuditoriaInstanciaDetailAPIView.as_view(),
         name='api_instancia_detail'),
    path('instancias/<int:pk>/locais-permitidos/', LocaisPermitidosAPIView.as_view(),
         name='api_instancia_locais'),
    path('instancias/<int:pk>/submeter/',
         SubmeterAuditoriaAPIView.as_view(), name='api_instancia_submeter'),


]


# URLs da Documentação
schema_urlpatterns = [
    path('schema/', SpectacularAPIView.as_view(), name='schema'),
    path('schema/swagger-ui/',
         SpectacularSwaggerView.as_view(url_name='schema'), name='swagger-ui'),
]

# Adiciona os blocos de URLs da API e Documentação ao urlpatterns principal
urlpatterns += [
    path('api/', include(api_urlpatterns)),
    path('api/', include(schema_urlpatterns)),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL,
                          document_root=settings.MEDIA_ROOT)
    urlpatterns += static(settings.STATIC_URL,
                          document_root=settings.STATIC_ROOT)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\core\views.py

# core/views.py

from django.shortcuts import render
from django.contrib.auth.decorators import login_required
from django.utils import timezone
from auditorias.models import Auditoria, AuditoriaInstancia


@login_required
def home(request):
    # Contagem de auditorias agendadas
    total_auditorias = Auditoria.objects.count()
    auditorias_agendadas = Auditoria.objects.filter(
        data_inicio__gt=timezone.now()).count()
    auditorias_executadas = AuditoriaInstancia.objects.filter(
        executada=True).count()

    context = {
        'total_auditorias': total_auditorias,
        'auditorias_agendadas': auditorias_agendadas,
        'auditorias_executadas': auditorias_executadas,
    }
    return render(request, 'home.html', context)


def lista_auditorias(request):
    todas_auditorias = Auditoria.objects.all()
    context = {
        'todas_auditorias': todas_auditorias,
    }
    return render(request, 'lista_auditorias.html', context)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\core\wsgi.py

"""
WSGI config for core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_wsgi_application()

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\core\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\admin.py

# fornecedores/admin.py

from django.contrib import admin
from .models import Fornecedor


@admin.register(Fornecedor)
class FornecedorAdmin(admin.ModelAdmin):
    list_display = (
        'nome',
        'npr',
        'usuario_responsavel',  # Exibe o usuário associado
        'ativo',
        'data_cadastro'
    )
    list_filter = ('ativo', 'usuario_responsavel')
    search_fields = ('nome', 'npr', 'usuario_responsavel__username',
                     'usuario_responsavel__first_name', 'usuario_responsavel__last_name')
    fieldsets = (
        (None, {
            'fields': ('nome', 'npr',)
        }),
        ('Associação', {
            'fields': ('usuario_responsavel',)
        }),
        ('Status', {
            'fields': ('ativo',)
        }),
    )

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\apps.py

from django.apps import AppConfig


class FornecedoresConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'fornecedores'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\models.py

# fornecedores/models.py

from django.db import models
# Importar o modelo de Usuário padrão do Django
from django.contrib.auth.models import User
from django.conf import settings


class Fornecedor(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome do Fornecedor")
    # Assumi que NPR é um campo de texto/código
    npr = models.CharField(max_length=50, null=True,
                           blank=True, verbose_name="NPR")

    # Relação com o modelo de Usuário padrão do Django
    # Um fornecedor pode ter um usuário associado (ex: o responsável pelo contato com o fornecedor no sistema)
    usuario_responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,  # Se o usuário for apagado, o campo no fornecedor fica nulo
        null=True, blank=True,
        verbose_name="Usuário Responsável",
        related_name='fornecedores_responsavel'  # Nome único para a relação reversa
    )

    # Campos de controle
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Fornecedor"
        verbose_name_plural = "Fornecedores"
        ordering = ['nome']

    def __str__(self):
        return self.nome

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\urls.py

# fornecedores/urls.py

from django.urls import path
from . import views

app_name = 'fornecedores'

urlpatterns = [
    # URLs para Fornecedores
    path('', views.lista_fornecedores, name='lista_fornecedores'),
    path('criar/', views.criar_fornecedor, name='criar_fornecedor'),
    path('<int:pk>/editar/', views.editar_fornecedor, name='editar_fornecedor'),
    path('<int:pk>/deletar/', views.deletar_fornecedor, name='deletar_fornecedor'),
]

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\views.py

# fornecedores/views.py

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.db.models import Q
from .models import Fornecedor
from usuarios.models import Usuario

@login_required
def lista_fornecedores(request):
    """Lista todos os fornecedores com busca e paginação."""
    search = request.GET.get('search', '')
    fornecedores = Fornecedor.objects.select_related('usuario_responsavel').order_by('nome')

    if search:
        fornecedores = fornecedores.filter(
            Q(nome__icontains=search) |
            Q(npr__icontains=search) |
            Q(usuario_responsavel__username__icontains=search)
        )

    paginator = Paginator(fornecedores, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Fornecedores',
        'singular': 'Fornecedor',
        'button_text': 'Novo Fornecedor',
        'create_url': 'fornecedores:criar_fornecedor',
        'artigo': 'o',
        'empty_message': 'Nenhum fornecedor cadastrado.',
        'empty_subtitle': 'Comece criando o primeiro fornecedor.'
    }
    return render(request, 'fornecedores/lista.html', context)

@login_required
def criar_fornecedor(request):
    """Cria um novo fornecedor."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        if not nome:
            messages.error(request, 'O nome do fornecedor é obrigatório.')
        else:
            try:
                Fornecedor.objects.create(
                    nome=nome,
                    npr=request.POST.get('npr'),
                    ativo=request.POST.get('ativo') == 'on',
                    usuario_responsavel_id=request.POST.get('usuario_responsavel') or None
                )
                messages.success(request, 'Fornecedor criado com sucesso!')
                return redirect('fornecedores:lista_fornecedores')
            except Exception as e:
                messages.error(request, f'Erro ao criar fornecedor: {e}')

    context = {
        'title': 'Criar Fornecedor',
        'back_url': 'fornecedores:lista_fornecedores',
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'fornecedores/form.html', context)

@login_required
def editar_fornecedor(request, pk):
    """Edita um fornecedor existente."""
    fornecedor = get_object_or_404(Fornecedor, pk=pk)
    if request.method == 'POST':
        nome = request.POST.get('nome')
        if not nome:
            messages.error(request, 'O nome do fornecedor é obrigatório.')
        else:
            try:
                fornecedor.nome = nome
                fornecedor.npr = request.POST.get('npr')
                fornecedor.ativo = request.POST.get('ativo') == 'on'
                fornecedor.usuario_responsavel_id = request.POST.get('usuario_responsavel') or None
                fornecedor.save()
                messages.success(request, 'Fornecedor atualizado com sucesso!')
                return redirect('fornecedores:lista_fornecedores')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar fornecedor: {e}')

    context = {
        'object': fornecedor,
        'title': 'Editar Fornecedor',
        'back_url': 'fornecedores:lista_fornecedores',
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'fornecedores/form.html', context)

@login_required
def deletar_fornecedor(request, pk):
    """Deleta um fornecedor."""
    fornecedor = get_object_or_404(Fornecedor, pk=pk)
    if request.method == 'POST':
        try:
            fornecedor.delete()
            messages.success(request, 'Fornecedor deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar fornecedor: {e}')
        return redirect('fornecedores:lista_fornecedores')

    context = {
        'object': fornecedor,
        'title': 'Fornecedor'
    }
    return render(request, 'auditorias/deletar_generico.html', context)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\templates\fornecedores\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Fornecedor</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ object.nome|default:'' }}" required maxlength="100">
    </div>
    <div class="form-group">
        <label for="npr" class="form-label">NPR</label>
        <input type="text" id="npr" name="npr" class="form-control" value="{{ object.npr|default:'' }}" maxlength="50">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="usuario_responsavel" class="form-label">Responsável</label>
        <select id="usuario_responsavel" name="usuario_responsavel" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.pk }}" {% if object.usuario_responsavel.pk == usuario.pk %}selected{% endif %}>{{ usuario.get_full_name|default:usuario.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-group">
    <label class="form-label">Status</label>
    <div style="display: flex; align-items: center; gap: 12px;">
        <label class="toggle-switch">
            <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px;">Fornecedor ativo no sistema</span>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\fornecedores\templates\fornecedores\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome do Fornecedor</th>
    <th>NPR</th>
    <th>Responsável</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.npr|default:"—" }}</td>
    <td>{{ object.usuario_responsavel.get_full_name|default:object.usuario_responsavel.username|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'fornecedores:editar_fornecedor' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Fornecedor">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Fornecedor"
                    onclick="confirmDelete('{% url 'fornecedores:deletar_fornecedor' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\admin.py

# itens/admin.py

from django.contrib import admin
from .models import CategoriaItem, SubcategoriaItem, Almoxarifado, Item


@admin.register(CategoriaItem)
class CategoriaItemAdmin(admin.ModelAdmin):
    list_display = ('descricao', 'ativo', 'data_cadastro')
    list_filter = ('ativo',)
    search_fields = ('descricao',)


@admin.register(SubcategoriaItem)
class SubcategoriaItemAdmin(admin.ModelAdmin):
    list_display = ('descricao', 'categoria', 'ativo', 'data_cadastro')
    list_filter = ('ativo', 'categoria')
    search_fields = ('descricao', 'categoria__descricao')


@admin.register(Almoxarifado)
class AlmoxarifadoAdmin(admin.ModelAdmin):
    list_display = ('nome', 'ativo', 'data_cadastro')
    list_filter = ('ativo',)
    search_fields = ('nome', 'endereco')


@admin.register(Item)
class ItemAdmin(admin.ModelAdmin):
    list_display = (
        'codigo_interno',
        'descricao',
        'unidade_medida',
        'categoria_principal',
        'subcategoria_principal',
        'almoxarifado',
        'ativo',
        'data_cadastro'
    )
    list_filter = (
        'ativo',
        'unidade_medida',
        'categoria_principal',
        'subcategoria_principal',
        'almoxarifado'
    )
    search_fields = (
        'codigo_interno',
        'codigo_alternativo',
        'descricao',
        'unidade_medida__simbolo',  # Permite buscar pela unidade de medida
        'categoria_principal__descricao',
        'subcategoria_principal__descricao',
        'almoxarifado__nome'
    )
    fieldsets = (
        (None, {
            'fields': (
                'codigo_interno', 'codigo_alternativo', 'descricao',
                'imagem_item'
            )
        }),
        ('Dados Técnicos e Financeiros', {
            'fields': ('unidade_medida', 'peso', 'valor')
        }),
        ('Localização e Classificação', {
            'fields': ('almoxarifado', 'categoria_principal', 'subcategoria_principal')
        }),
        ('Status', {
            'fields': ('ativo',)
        }),
    )

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\apps.py

from django.apps import AppConfig


class ItensConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'itens'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\models.py

# itens/models.py

from django.db import models
# Importar o modelo de Unidade de Medida
from cadastros_base.models import UnidadeMedida


class CategoriaItem(models.Model):
    descricao = models.CharField(
        max_length=100, unique=True, verbose_name="Descrição da Categoria")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Categoria de Item"
        verbose_name_plural = "Categorias de Itens"
        ordering = ['descricao']

    def __str__(self):
        return self.descricao


class SubcategoriaItem(models.Model):
    # Uma subcategoria pertence a uma categoria principal
    categoria = models.ForeignKey(
        CategoriaItem,
        # Se a categoria for apagada, as subcategorias associadas também são
        on_delete=models.CASCADE,
        verbose_name="Categoria Principal",
        # Nome para a relação reversa (categoria.subcategorias.all())
        related_name='subcategorias'
    )
    descricao = models.CharField(
        max_length=100, verbose_name="Descrição da Subcategoria")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Subcategoria de Item"
        verbose_name_plural = "Subcategorias de Itens"
        # Garante que uma subcategoria é única para uma categoria específica
        unique_together = ('categoria', 'descricao')
        ordering = ['categoria__descricao', 'descricao']

    def __str__(self):
        return f"{self.descricao} ({self.categoria.descricao})"


class Almoxarifado(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome do Almoxarifado")
    endereco = models.CharField(
        max_length=255, null=True, blank=True, verbose_name="Endereço")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Almoxarifado"
        verbose_name_plural = "Almoxarifados"
        ordering = ['nome']

    def __str__(self):
        return self.nome


class Item(models.Model):
    codigo_interno = models.CharField(
        max_length=50, unique=True, verbose_name="Código Interno")
    codigo_alternativo = models.CharField(
        max_length=50, null=True, blank=True, verbose_name="Código Alternativo")
    descricao = models.CharField(max_length=255, verbose_name="Descrição")

    # Relações com outros cadastros base
    unidade_medida = models.ForeignKey(
        UnidadeMedida,
        # Se a unidade de medida for apagada, o campo no item fica nulo
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Unidade de Medida"
    )
    peso = models.DecimalField(
        max_digits=10, decimal_places=3, null=True, blank=True, verbose_name="Peso")
    valor = models.DecimalField(
        max_digits=10, decimal_places=2, null=True, blank=True, verbose_name="Valor")

    almoxarifado = models.ForeignKey(
        Almoxarifado,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Almoxarifado"
    )

    # Relações com categorias e subcategorias de item.
    # Por enquanto, assumimos que um item tem UMA categoria principal e UMA subcategoria principal.
    # Se precisar de múltiplas, teremos que mudar para ManyToManyField e ajustar a lógica da UI.
    categoria_principal = models.ForeignKey(
        CategoriaItem,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Categoria Principal",
        related_name='itens_por_categoria'
    )
    subcategoria_principal = models.ForeignKey(
        SubcategoriaItem,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Subcategoria Principal",
        related_name='itens_por_subcategoria'
    )

    # Campo para imagem do item (opcional)
    imagem_item = models.ImageField(
        upload_to='itens_imagens/', null=True, blank=True, verbose_name="Imagem do Item")

    # Campos de controle
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")

    class Meta:
        verbose_name = "Item"
        verbose_name_plural = "Itens"
        ordering = ['codigo_interno']

    def __str__(self):
        return f"{self.codigo_interno} - {self.descricao}"

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\urls.py

# itens/urls.py

from django.urls import path
from . import views

app_name = 'itens'

urlpatterns = [
    # Dashboard
    path('dashboard/', views.dashboard_itens, name='dashboard'),

    # Itens
    path('', views.lista_itens, name='lista_itens'),
    path('criar/', views.criar_item, name='criar_item'),
    path('<int:pk>/editar/', views.editar_item, name='editar_item'),
    path('<int:pk>/deletar/', views.deletar_item, name='deletar_item'),
    
    # Categorias de Itens
    path('categorias/', views.lista_categorias, name='lista_categorias'),
    path('categorias/criar/', views.criar_categoria, name='criar_categoria'),
    path('categorias/<int:pk>/editar/', views.editar_categoria, name='editar_categoria'),
    path('categorias/<int:pk>/deletar/', views.deletar_categoria, name='deletar_categoria'),

    # Subcategorias de Itens
    path('subcategorias/', views.lista_subcategorias, name='lista_subcategorias'),
    path('subcategorias/criar/', views.criar_subcategoria, name='criar_subcategoria'),
    path('subcategorias/<int:pk>/editar/', views.editar_subcategoria, name='editar_subcategoria'),
    path('subcategorias/<int:pk>/deletar/', views.deletar_subcategoria, name='deletar_subcategoria'),

    # Almoxarifados
    path('almoxarifados/', views.lista_almoxarifados, name='lista_almoxarifados'),
    path('almoxarifados/criar/', views.criar_almoxarifado, name='criar_almoxarifado'),
    path('almoxarifados/<int:pk>/editar/', views.editar_almoxarifado, name='editar_almoxarifado'),
    path('almoxarifados/<int:pk>/deletar/', views.deletar_almoxarifado, name='deletar_almoxarifado'),
    
    # AJAX
    path('ajax/subcategorias-por-categoria/', views.get_subcategorias_por_categoria, name='get_subcategorias_por_categoria'),
]
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\views.py

# itens/views.py

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.db.models import Q, Count
from django.http import JsonResponse

from .models import Item, CategoriaItem, SubcategoriaItem, Almoxarifado
from cadastros_base.models import UnidadeMedida

# ============================================================================
# DASHBOARD
# ============================================================================

@login_required
def dashboard_itens(request):
    """Dashboard principal do módulo de itens."""
    context = {
        'total_itens': Item.objects.count(),
        'itens_ativos': Item.objects.filter(ativo=True).count(),
        'total_categorias': CategoriaItem.objects.count(),
        'total_subcategorias': SubcategoriaItem.objects.count(),
        'total_almoxarifados': Almoxarifado.objects.count(),
        'itens_recentes': Item.objects.select_related(
            'categoria_principal', 'almoxarifado'
        ).order_by('-data_cadastro')[:5],
    }
    return render(request, 'itens/dashboard.html', context)


# ============================================================================
# VIEWS PARA CATEGORIAS DE ITEM
# ============================================================================

@login_required
def lista_categorias(request):
    """Lista todas as categorias de itens."""
    search = request.GET.get('search', '')
    categorias = CategoriaItem.objects.annotate(total_itens=Count('itens_por_categoria')).order_by('descricao')
    
    if search:
        categorias = categorias.filter(descricao__icontains=search)
        
    paginator = Paginator(categorias, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Categorias de Itens',
        'singular': 'Categoria',
        'button_text': 'Nova Categoria',
        'create_url': 'itens:criar_categoria',
        'artigo': 'a',
        'empty_message': 'Nenhuma categoria de item cadastrada.',
        'empty_subtitle': 'Comece criando a primeira categoria.'
    }
    return render(request, 'itens/categorias/lista.html', context)

@login_required
def criar_categoria(request):
    """Cria uma nova categoria de item."""
    if request.method == 'POST':
        descricao = request.POST.get('descricao')
        ativo = request.POST.get('ativo') == 'on'
        
        if descricao:
            try:
                CategoriaItem.objects.create(descricao=descricao, ativo=ativo)
                messages.success(request, 'Categoria de item criada com sucesso!')
                return redirect('itens:lista_categorias')
            except Exception as e:
                messages.error(request, f'Erro ao criar categoria: {e}')
        else:
            messages.error(request, 'A descrição é obrigatória.')
            
    context = {
        'title': 'Criar Categoria de Item',
        'back_url': 'itens:lista_categorias'
    }
    return render(request, 'itens/categorias/form.html', context)

@login_required
def editar_categoria(request, pk):
    """Edita uma categoria de item existente."""
    categoria = get_object_or_404(CategoriaItem, pk=pk)
    if request.method == 'POST':
        categoria.descricao = request.POST.get('descricao')
        categoria.ativo = request.POST.get('ativo') == 'on'
        
        if categoria.descricao:
            try:
                categoria.save()
                messages.success(request, 'Categoria de item atualizada com sucesso!')
                return redirect('itens:lista_categorias')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar categoria: {e}')
        else:
            messages.error(request, 'A descrição é obrigatória.')

    context = {
        'object': categoria,
        'title': 'Editar Categoria de Item',
        'back_url': 'itens:lista_categorias'
    }
    return render(request, 'itens/categorias/form.html', context)

@login_required
def deletar_categoria(request, pk):
    """Deleta uma categoria de item."""
    categoria = get_object_or_404(CategoriaItem, pk=pk)
    if request.method == 'POST':
        try:
            categoria.delete()
            messages.success(request, 'Categoria de item deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar categoria: {e}')
        return redirect('itens:lista_categorias')
    
    context = {
        'object': categoria,
        'title': 'Categoria de Item'
    }
    return render(request, 'auditorias/deletar_generico.html', context)


# ============================================================================
# VIEWS PARA SUBCATEGORIAS DE ITEM
# ============================================================================

@login_required
def lista_subcategorias(request):
    """Lista todas as subcategorias de itens."""
    search = request.GET.get('search', '')
    subcategorias = SubcategoriaItem.objects.select_related('categoria').annotate(total_itens=Count('itens_por_subcategoria')).order_by('categoria__descricao', 'descricao')
    
    if search:
        subcategorias = subcategorias.filter(
            Q(descricao__icontains=search) | Q(categoria__descricao__icontains=search)
        )
        
    paginator = Paginator(subcategorias, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Subcategorias de Itens',
        'singular': 'Subcategoria',
        'button_text': 'Nova Subcategoria',
        'create_url': 'itens:criar_subcategoria',
        'artigo': 'a',
        'empty_message': 'Nenhuma subcategoria de item cadastrada.',
        'empty_subtitle': 'Comece criando a primeira subcategoria.'
    }
    return render(request, 'itens/subcategorias/lista.html', context)

@login_required
def criar_subcategoria(request):
    """Cria uma nova subcategoria de item."""
    if request.method == 'POST':
        descricao = request.POST.get('descricao')
        categoria_id = request.POST.get('categoria')
        ativo = request.POST.get('ativo') == 'on'
        
        if descricao and categoria_id:
            try:
                categoria = get_object_or_404(CategoriaItem, pk=categoria_id)
                SubcategoriaItem.objects.create(descricao=descricao, categoria=categoria, ativo=ativo)
                messages.success(request, 'Subcategoria de item criada com sucesso!')
                return redirect('itens:lista_subcategorias')
            except Exception as e:
                messages.error(request, f'Erro ao criar subcategoria: {e}')
        else:
            messages.error(request, 'Descrição e Categoria são obrigatórios.')
            
    context = {
        'title': 'Criar Subcategoria de Item',
        'back_url': 'itens:lista_subcategorias',
        'categorias': CategoriaItem.objects.filter(ativo=True)
    }
    return render(request, 'itens/subcategorias/form.html', context)

@login_required
def editar_subcategoria(request, pk):
    """Edita uma subcategoria de item existente."""
    subcategoria = get_object_or_404(SubcategoriaItem, pk=pk)
    if request.method == 'POST':
        subcategoria.descricao = request.POST.get('descricao')
        subcategoria.categoria_id = request.POST.get('categoria')
        subcategoria.ativo = request.POST.get('ativo') == 'on'
        
        if subcategoria.descricao and subcategoria.categoria_id:
            try:
                subcategoria.save()
                messages.success(request, 'Subcategoria de item atualizada com sucesso!')
                return redirect('itens:lista_subcategorias')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar subcategoria: {e}')
        else:
            messages.error(request, 'Descrição e Categoria são obrigatórios.')

    context = {
        'object': subcategoria,
        'title': 'Editar Subcategoria de Item',
        'back_url': 'itens:lista_subcategorias',
        'categorias': CategoriaItem.objects.filter(ativo=True)
    }
    return render(request, 'itens/subcategorias/form.html', context)

@login_required
def deletar_subcategoria(request, pk):
    """Deleta uma subcategoria de item."""
    subcategoria = get_object_or_404(SubcategoriaItem, pk=pk)
    if request.method == 'POST':
        try:
            subcategoria.delete()
            messages.success(request, 'Subcategoria de item deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar subcategoria: {e}')
        return redirect('itens:lista_subcategorias')
    
    context = {
        'object': subcategoria,
        'title': 'Subcategoria de Item'
    }
    return render(request, 'auditorias/deletar_generico.html', context)

# ============================================================================
# VIEWS PARA ALMOXARIFADOS
# ============================================================================

@login_required
def lista_almoxarifados(request):
    """Lista todos os almoxarifados."""
    search = request.GET.get('search', '')
    almoxarifados = Almoxarifado.objects.annotate(total_itens=Count('item')).order_by('nome')
    
    if search:
        almoxarifados = almoxarifados.filter(
            Q(nome__icontains=search) | Q(endereco__icontains=search)
        )
        
    paginator = Paginator(almoxarifados, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    
    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Almoxarifados',
        'singular': 'Almoxarifado',
        'button_text': 'Novo Almoxarifado',
        'create_url': 'itens:criar_almoxarifado',
        'artigo': 'o',
        'empty_message': 'Nenhum almoxarifado cadastrado.',
        'empty_subtitle': 'Comece criando o primeiro almoxarifado.'
    }
    return render(request, 'itens/almoxarifados/lista.html', context)

@login_required
def criar_almoxarifado(request):
    """Cria um novo almoxarifado."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        endereco = request.POST.get('endereco')
        ativo = request.POST.get('ativo') == 'on'
        
        if nome:
            try:
                Almoxarifado.objects.create(nome=nome, endereco=endereco, ativo=ativo)
                messages.success(request, 'Almoxarifado criado com sucesso!')
                return redirect('itens:lista_almoxarifados')
            except Exception as e:
                messages.error(request, f'Erro ao criar almoxarifado: {e}')
        else:
            messages.error(request, 'O nome é obrigatório.')
            
    context = {
        'title': 'Criar Almoxarifado',
        'back_url': 'itens:lista_almoxarifados'
    }
    return render(request, 'itens/almoxarifados/form.html', context)

@login_required
def editar_almoxarifado(request, pk):
    """Edita um almoxarifado existente."""
    almoxarifado = get_object_or_404(Almoxarifado, pk=pk)
    if request.method == 'POST':
        almoxarifado.nome = request.POST.get('nome')
        almoxarifado.endereco = request.POST.get('endereco')
        almoxarifado.ativo = request.POST.get('ativo') == 'on'
        
        if almoxarifado.nome:
            try:
                almoxarifado.save()
                messages.success(request, 'Almoxarifado atualizado com sucesso!')
                return redirect('itens:lista_almoxarifados')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar almoxarifado: {e}')
        else:
            messages.error(request, 'O nome é obrigatório.')

    context = {
        'object': almoxarifado,
        'title': 'Editar Almoxarifado',
        'back_url': 'itens:lista_almoxarifados'
    }
    return render(request, 'itens/almoxarifados/form.html', context)

@login_required
def deletar_almoxarifado(request, pk):
    """Deleta um almoxarifado."""
    almoxarifado = get_object_or_404(Almoxarifado, pk=pk)
    if request.method == 'POST':
        try:
            almoxarifado.delete()
            messages.success(request, 'Almoxarifado deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar almoxarifado: {e}')
        return redirect('itens:lista_almoxarifados')
    
    context = {
        'object': almoxarifado,
        'title': 'Almoxarifado'
    }
    return render(request, 'auditorias/deletar_generico.html', context)

# ============================================================================
# VIEWS PARA ITENS
# ============================================================================

@login_required
def lista_itens(request):
    """Lista todos os itens com busca e paginação."""
    search = request.GET.get('search', '')
    itens_list = Item.objects.select_related(
        'unidade_medida', 
        'categoria_principal', 
        'subcategoria_principal', 
        'almoxarifado'
    ).order_by('codigo_interno')

    if search:
        itens_list = itens_list.filter(
            Q(codigo_interno__icontains=search) |
            Q(descricao__icontains=search) |
            Q(categoria_principal__descricao__icontains=search) |
            Q(almoxarifado__nome__icontains=search)
        )

    paginator = Paginator(itens_list, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Itens',
        'singular': 'Item',
        'button_text': 'Novo Item',
        'create_url': 'itens:criar_item',
        'artigo': 'o',
        'empty_message': 'Nenhum item cadastrado',
        'empty_subtitle': 'Comece criando o primeiro item.'
    }
    return render(request, 'itens/lista.html', context)

@login_required
def criar_item(request):
    """Cria um novo item."""
    if request.method == 'POST':
        # Tratamento de dados do form
        codigo_interno = request.POST.get('codigo_interno')
        descricao = request.POST.get('descricao')

        if not codigo_interno or not descricao:
            messages.error(request, 'Código Interno e Descrição são obrigatórios.')
        else:
            try:
                item = Item(
                    codigo_interno=codigo_interno,
                    descricao=descricao,
                    codigo_alternativo=request.POST.get('codigo_alternativo'),
                    peso=request.POST.get('peso') or None,
                    valor=request.POST.get('valor') or None,
                    ativo=request.POST.get('ativo') == 'on',
                    unidade_medida_id=request.POST.get('unidade_medida') or None,
                    almoxarifado_id=request.POST.get('almoxarifado') or None,
                    categoria_principal_id=request.POST.get('categoria_principal') or None,
                    subcategoria_principal_id=request.POST.get('subcategoria_principal') or None,
                )
                if request.FILES.get('imagem_item'):
                    item.imagem_item = request.FILES['imagem_item']

                item.save()
                messages.success(request, f"Item '{item.descricao}' criado com sucesso!")
                return redirect('itens:lista_itens')
            except Exception as e:
                messages.error(request, f"Erro ao criar o item: {e}")

    context = {
        'title': 'Criar Item',
        'back_url': 'itens:lista_itens',
        'unidades_medida': UnidadeMedida.objects.filter(ativo=True),
        'almoxarifados': Almoxarifado.objects.filter(ativo=True),
        'categorias': CategoriaItem.objects.filter(ativo=True),
        'subcategorias': SubcategoriaItem.objects.filter(ativo=True),
    }
    return render(request, 'itens/form.html', context)

@login_required
def editar_item(request, pk):
    """Edita um item existente."""
    item = get_object_or_404(Item, pk=pk)
    if request.method == 'POST':
        codigo_interno = request.POST.get('codigo_interno')
        descricao = request.POST.get('descricao')

        if not codigo_interno or not descricao:
            messages.error(request, 'Código Interno e Descrição são obrigatórios.')
        else:
            try:
                item.codigo_interno = codigo_interno
                item.descricao = descricao
                item.codigo_alternativo = request.POST.get('codigo_alternativo')
                item.peso = request.POST.get('peso') or None
                item.valor = request.POST.get('valor') or None
                item.ativo = request.POST.get('ativo') == 'on'
                item.unidade_medida_id = request.POST.get('unidade_medida') or None
                item.almoxarifado_id = request.POST.get('almoxarifado') or None
                item.categoria_principal_id = request.POST.get('categoria_principal') or None
                item.subcategoria_principal_id = request.POST.get('subcategoria_principal') or None
                
                if request.FILES.get('imagem_item'):
                    item.imagem_item = request.FILES['imagem_item']

                item.save()
                messages.success(request, f"Item '{item.descricao}' atualizado com sucesso!")
                return redirect('itens:lista_itens')
            except Exception as e:
                messages.error(request, f"Erro ao atualizar o item: {e}")

    context = {
        'object': item,
        'title': 'Editar Item',
        'back_url': 'itens:lista_itens',
        'unidades_medida': UnidadeMedida.objects.filter(ativo=True),
        'almoxarifados': Almoxarifado.objects.filter(ativo=True),
        'categorias': CategoriaItem.objects.filter(ativo=True),
        'subcategorias': SubcategoriaItem.objects.filter(ativo=True),
    }
    return render(request, 'itens/form.html', context)


@login_required
def deletar_item(request, pk):
    """Deleta um item."""
    item = get_object_or_404(Item, pk=pk)
    if request.method == 'POST':
        try:
            item_desc = item.descricao
            item.delete()
            messages.success(request, f"Item '{item_desc}' deletado com sucesso!")
        except Exception as e:
            messages.error(request, f"Erro ao deletar o item: {e}")
        return redirect('itens:lista_itens')

    context = {
        'object': item,
        'title': 'Item'
    }
    return render(request, 'auditorias/deletar_generico.html', context)

# AJAX view to get subcategories for a category
@login_required
def get_subcategorias_por_categoria(request):
    """Retorna subcategorias de uma categoria via AJAX"""
    categoria_id = request.GET.get('categoria_id')
    subcategorias = SubcategoriaItem.objects.filter(categoria_id=categoria_id, ativo=True).values('id', 'descricao')
    return JsonResponse(list(subcategorias), safe=False)
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\dashboard.html

{% extends 'auditorias/base.html' %}

{% block title %}Dashboard de Itens{% endblock %}
{% block page_title %}Dashboard de Itens{% endblock %}

{% block content %}
<div class="content-header">
    <h2 class="content-title">Visão Geral de Itens</h2>
    <p class="content-subtitle">Estatísticas e informações sobre os itens cadastrados.</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">{{ total_itens }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Total de Itens</p>
                </div>
                <div style="font-size: 24px; color: var(--primary);"><i class="fas fa-boxes"></i></div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 8px;">{{ itens_ativos }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Itens Ativos</p>
                </div>
                <div style="font-size: 24px; color: var(--success);"><i class="fas fa-check-circle"></i></div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">{{ total_categorias }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Categorias</p>
                </div>
                <div style="font-size: 24px; color: var(--warning);"><i class="fas fa-tags"></i></div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--info); margin-bottom: 8px;">{{ total_almoxarifados }}</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Almoxarifados</p>
                </div>
                <div style="font-size: 24px; color: var(--info);"><i class="fas fa-warehouse"></i></div>
            </div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Itens Adicionados Recentemente</h3>
        </div>
        <div class="card-body">
            {% if itens_recentes %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Descrição</th>
                                <th>Categoria</th>
                                <th>Data Cadastro</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in itens_recentes %}
                            <tr>
                                <td><a href="{% url 'itens:editar_item' item.pk %}">{{ item.codigo_interno }}</a></td>
                                <td>{{ item.descricao }}</td>
                                <td><span class="badge badge-info">{{ item.categoria_principal.descricao|default:'N/A' }}</span></td>
                                <td>{{ item.data_cadastro|date:"d/m/Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>Nenhum item cadastrado recentemente.</p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Ações Rápidas</h3>
        </div>
        <div class="card-body" style="display: flex; flex-direction: column; gap: 12px;">
            <a href="{% url 'itens:criar_item' %}" class="btn btn-primary"><i class="fas fa-plus"></i> Novo Item</a>
            <a href="{% url 'itens:criar_categoria' %}" class="btn btn-secondary"><i class="fas fa-plus"></i> Nova Categoria</a>
            <a href="{% url 'itens:criar_subcategoria' %}" class="btn btn-secondary"><i class="fas fa-plus"></i> Nova Subcategoria</a>
            <a href="{% url 'itens:criar_almoxarifado' %}" class="btn btn-secondary"><i class="fas fa-plus"></i> Novo Almoxarifado</a>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\deletar_item.html

{% extends 'auditorias/base.html' %}

{% block title %}Deletar Item - Sistema de Auditorias{% endblock %}
{% block page_title %}Confirmar Exclusão de Item{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: auto;">
    <div class="card-body" style="text-align: center; padding: 40px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 24px;"></i>
        <h3 class="card-title" style="font-size: 22px;">Tem certeza?</h3>
        <p class="card-subtitle" style="margin-top: 8px; margin-bottom: 24px;">
            Você está prestes a deletar permanentemente o item: <br>
            <strong style="color: var(--text-primary);">"{{ item.codigo_interno }} - {{ item.descricao }}"</strong>
        </p>
        <p class="card-subtitle" style="color: var(--error);">
            Esta ação não pode ser desfeita.
        </p>

        <form method="post">
            {% csrf_token %}
            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 32px;">
                <a href="{% url 'itens:lista_itens' %}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Sim, deletar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    Identificação do Item
</h4>
<div class="form-row">
    <div class="form-group required">
        <label for="codigo_interno" class="form-label">Código Interno</label>
        <input type="text" id="codigo_interno" name="codigo_interno" class="form-control" value="{{ object.codigo_interno|default:'' }}" required maxlength="50">
    </div>
    <div class="form-group">
        <label for="codigo_alternativo" class="form-label">Código Alternativo</label>
        <input type="text" id="codigo_alternativo" name="codigo_alternativo" class="form-control" value="{{ object.codigo_alternativo|default:'' }}" maxlength="50">
    </div>
</div>
<div class="form-row single">
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição</label>
        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ object.descricao|default:'' }}" required maxlength="255">
    </div>
</div>

<div class="form-row triple">
    <div class="form-group">
        <label for="unidade_medida" class="form-label">Unidade de Medida</label>
        <select id="unidade_medida" name="unidade_medida" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for um in unidades_medida %}<option value="{{ um.pk }}" {% if object.unidade_medida.pk == um.pk %}selected{% endif %}>{{ um.nome }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="peso" class="form-label">Peso</label>
        <input type="number" step="0.001" id="peso" name="peso" class="form-control" value="{{ object.peso|default:'' }}">
    </div>
    <div class="form-group">
        <label for="valor" class="form-label">Valor (R$)</label>
        <input type="number" step="0.01" id="valor" name="valor" class="form-control" value="{{ object.valor|default:'' }}">
    </div>
</div>

<h4 style="color: var(--text-primary); margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    Classificação e Localização
</h4>
<div class="form-row">
    <div class="form-group">
        <label for="categoria_principal" class="form-label">Categoria</label>
        <select id="categoria_principal" name="categoria_principal" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for cat in categorias %}<option value="{{ cat.pk }}" {% if object.categoria_principal.pk == cat.pk %}selected{% endif %}>{{ cat.descricao }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="subcategoria_principal" class="form-label">Subcategoria</label>
        <select id="subcategoria_principal" name="subcategoria_principal" class="form-control form-select">
            <option value="">Selecione uma categoria primeiro</option>
             {% if object.subcategoria_principal %}
                <option value="{{ object.subcategoria_principal.pk }}" selected>{{ object.subcategoria_principal.descricao }}</option>
            {% endif %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group">
        <label for="almoxarifado" class="form-label">Almoxarifado</label>
        <select id="almoxarifado" name="almoxarifado" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for almox in almoxarifados %}<option value="{{ almox.pk }}" {% if object.almoxarifado.pk == almox.pk %}selected{% endif %}>{{ almox.nome }}</option>{% endfor %}
        </select>
    </div>
</div>
<div class="form-group">
    <label for="imagem_item" class="form-label">Imagem do Item</label>
    {% if object.imagem_item %}
    <p>Imagem atual: <a href="{{ object.imagem_item.url }}" target="_blank">{{ object.imagem_item.name }}</a></p>
    {% endif %}
    <input type="file" id="imagem_item" name="imagem_item" class="form-control">
</div>
<div class="form-group">
    <label class="form-label">Status</label>
    <div style="display: flex; align-items: center; gap: 12px;">
        <label class="toggle-switch">
            <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px;">Item ativo no sistema</span>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoriaSelect = document.getElementById('categoria_principal');
    const subcategoriaSelect = document.getElementById('subcategoria_principal');

    categoriaSelect.addEventListener('change', function() {
        const categoriaId = this.value;
        subcategoriaSelect.innerHTML = '<option value="">Carregando...</option>';

        if (categoriaId) {
            fetch(`{% url 'itens:get_subcategorias_por_categoria' %}?categoria_id=${categoriaId}`)
                .then(response => response.json())
                .then(data => {
                    subcategoriaSelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
                    data.forEach(subcat => {
                        const option = document.createElement('option');
                        option.value = subcat.id;
                        option.textContent = subcat.descricao;
                        subcategoriaSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar subcategorias:', error);
                    subcategoriaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
                });
        } else {
            subcategoriaSelect.innerHTML = '<option value="">Selecione uma categoria primeiro</option>';
        }
    });
});
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\form_item.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
    <div class="form-row">
        <div class="form-group required">
            <label for="codigo_interno" class="form-label">Código Interno</label>
            <input type="text" id="codigo_interno" name="codigo_interno" class="form-control" value="{{ item.codigo_interno|default:'' }}" required maxlength="50" placeholder="Ex: ITM-001">
        </div>
        <div class="form-group">
            <label for="codigo_alternativo" class="form-label">Código Alternativo</label>
            <input type="text" id="codigo_alternativo" name="codigo_alternativo" class="form-control" value="{{ item.codigo_alternativo|default:'' }}" maxlength="50">
        </div>
    </div>
    <div class="form-row single">
        <div class="form-group required">
            <label for="descricao" class="form-label">Descrição do Item</label>
            <input type="text" id="descricao" name="descricao" class="form-control" value="{{ item.descricao|default:'' }}" required maxlength="255" placeholder="Digite uma descrição completa para o item">
        </div>
    </div>

    <div class="form-row triple">
        <div class="form-group">
            <label for="unidade_medida" class="form-label">Unidade de Medida</label>
            <select id="unidade_medida" name="unidade_medida" class="form-control form-select">
                <option value="">Selecione...</option>
                {% for um in unidades_medida %}
                <option value="{{ um.pk }}" {% if item.unidade_medida.pk == um.pk %}selected{% endif %}>{{ um.nome }} ({{ um.simbolo }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="peso" class="form-label">Peso</label>
            <input type="number" step="0.001" id="peso" name="peso" class="form-control" value="{{ item.peso|default:'' }}">
        </div>
        <div class="form-group">
            <label for="valor" class="form-label">Valor (R$)</label>
            <input type="number" step="0.01" id="valor" name="valor" class="form-control" value="{{ item.valor|default:'' }}">
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="categoria_principal" class="form-label">Categoria</label>
            <select id="categoria_principal" name="categoria_principal" class="form-control form-select">
                <option value="">Selecione...</option>
                {% for cat in categorias %}
                <option value="{{ cat.pk }}" {% if item.categoria_principal.pk == cat.pk %}selected{% endif %}>{{ cat.descricao }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="subcategoria_principal" class="form-label">Subcategoria</label>
            <select id="subcategoria_principal" name="subcategoria_principal" class="form-control form-select">
                <option value="">Selecione...</option>
                {% for subcat in subcategorias %}
                <option value="{{ subcat.pk }}" {% if item.subcategoria_principal.pk == subcat.pk %}selected{% endif %}>{{ subcat.descricao }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="form-row single">
         <div class="form-group">
            <label for="almoxarifado" class="form-label">Almoxarifado</label>
            <select id="almoxarifado" name="almoxarifado" class="form-control form-select">
                <option value="">Selecione...</option>
                {% for almox in almoxarifados %}
                <option value="{{ almox.pk }}" {% if item.almoxarifado.pk == almox.pk %}selected{% endif %}>{{ almox.nome }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="form-row single">
        <div class="form-group">
            <label class="form-label">Status</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                    <input type="checkbox" name="ativo" {% if item.ativo|default:True %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span style="color: var(--text-secondary); font-size: 14px;">
                    Item ativo no sistema
                </span>
            </div>
        </div>
    </div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Código Interno</th>
    <th>Descrição</th>
    <th>Categoria</th>
    <th>Almoxarifado</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.codigo_interno }}
        </div>
    </td>
    <td>{{ object.descricao|truncatechars:40 }}</td>
    <td>{{ object.categoria_principal.descricao|default:"—" }}</td>
    <td>{{ object.almoxarifado.nome|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
         <div class="action-buttons">
            <a href="{% url 'itens:editar_item' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Item">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Item"
                    onclick="confirmDelete('{% url 'itens:deletar_item' object.pk %}', '{{ object.codigo_interno }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\lista_itens.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Código Interno</th>
    <th>Descrição</th>
    <th>Categoria</th>
    <th>Almoxarifado</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.codigo_interno }}
        </div>
    </td>
    <td>
        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ object.descricao }}">
            {{ object.descricao|default:"—" }}
        </div>
    </td>
    <td>{{ object.categoria_principal.descricao|default:"—" }}</td>
    <td>{{ object.almoxarifado.nome|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success">
                <i class="fas fa-check-circle"></i> Ativo
            </span>
        {% else %}
            <span class="badge badge-error">
                <i class="fas fa-times-circle"></i> Inativo
            </span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'itens:editar_item' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Item">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Item"
                    onclick="confirmDelete('{% url 'itens:deletar_item' object.pk %}', '{{ object.descricao }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\almoxarifados\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Almoxarifado</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ object.nome|default:'' }}" required maxlength="100">
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label for="endereco" class="form-label">Endereço</label>
        <input type="text" id="endereco" name="endereco" class="form-control" value="{{ object.endereco|default:'' }}" maxlength="255">
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Almoxarifado ativo no sistema
            </span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\almoxarifados\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome do Almoxarifado</th>
    <th>Endereço</th>
    <th>Total de Itens</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.endereco|default:"—" }}</td>
    <td>{{ object.total_itens }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'itens:editar_almoxarifado' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Almoxarifado">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Almoxarifado"
                    onclick="confirmDelete('{% url 'itens:deletar_almoxarifado' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\categorias\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição da Categoria</label>
        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ object.descricao|default:'' }}" required maxlength="100">
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Categoria ativa no sistema
            </span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\categorias\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Descrição da Categoria</th>
    <th>Total de Itens</th>
    <th>Status</th>
    <th>Data de Cadastro</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.descricao }}
        </div>
    </td>
    <td>{{ object.total_itens }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>{{ object.data_cadastro|date:"d/m/Y" }}</td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'itens:editar_categoria' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Categoria">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Categoria"
                    onclick="confirmDelete('{% url 'itens:deletar_categoria' object.pk %}', '{{ object.descricao }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\subcategorias\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="descricao" class="form-label">Descrição da Subcategoria</label>
        <input type="text" id="descricao" name="descricao" class="form-control" value="{{ object.descricao|default:'' }}" required maxlength="100">
    </div>
</div>

<div class="form-row single">
    <div class="form-group required">
        <label for="categoria" class="form-label">Categoria Principal</label>
        <select id="categoria" name="categoria" class="form-control form-select" required>
            <option value="">Selecione...</option>
            {% for cat in categorias %}
            <option value="{{ cat.pk }}" {% if object.categoria.pk == cat.pk %}selected{% endif %}>{{ cat.descricao }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Subcategoria ativa no sistema
            </span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\itens\templates\itens\subcategorias\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Descrição da Subcategoria</th>
    <th>Categoria Principal</th>
    <th>Total de Itens</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.descricao }}
        </div>
    </td>
    <td>{{ object.categoria.descricao }}</td>
    <td>{{ object.total_itens }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            <a href="{% url 'itens:editar_subcategoria' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Subcategoria">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Subcategoria"
                    onclick="confirmDelete('{% url 'itens:deletar_subcategoria' object.pk %}', '{{ object.descricao }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\admin.py

from django.contrib import admin
from .models import Empresa, Area, Setor, SubSetor


@admin.register(Empresa)
class EmpresaAdmin(admin.ModelAdmin):
    list_display = ('nome', 'usuario_responsavel', 'ativo', 'data_cadastro')
    list_filter = ('ativo', 'usuario_responsavel')
    search_fields = ('nome', 'cnpj', 'endereco',
                     'usuario_responsavel__username')
    fieldsets = (
        (None, {
            'fields': ('nome', 'cnpj', 'endereco', 'ativo', 'usuario_responsavel')
        }),
    )


@admin.register(Area)
class AreaAdmin(admin.ModelAdmin):
    list_display = ('nome', 'empresa', 'usuario_responsavel',
                    'ativo', 'data_cadastro')
    list_filter = ('ativo', 'empresa', 'usuario_responsavel')
    search_fields = ('nome', 'empresa__nome', 'usuario_responsavel__username')
    fieldsets = (
        (None, {
            'fields': ('empresa', 'nome', 'ativo', 'usuario_responsavel')
        }),
    )


@admin.register(Setor)
class SetorAdmin(admin.ModelAdmin):
    list_display = ('nome', 'area', 'usuario_responsavel',
                    'ativo', 'data_cadastro')
    list_filter = ('ativo', 'area__empresa', 'area', 'usuario_responsavel')
    search_fields = ('nome', 'area__nome', 'area__empresa__nome',
                     'usuario_responsavel__username')
    fieldsets = (
        (None, {
            'fields': ('area', 'nome', 'ativo', 'usuario_responsavel')
        }),
    )


@admin.register(SubSetor)
class SubSetorAdmin(admin.ModelAdmin):
    list_display = ('nome', 'setor', 'usuario_responsavel',
                    'ativo', 'data_cadastro')
    list_filter = ('ativo', 'setor__area__empresa',
                   'setor__area', 'setor', 'usuario_responsavel')
    search_fields = ('nome', 'setor__nome', 'setor__area__nome',
                     'setor__area__empresa__nome', 'usuario_responsavel__username')
    fieldsets = (
        (None, {
            'fields': ('setor', 'nome', 'ativo', 'usuario_responsavel')
        }),
    )

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\apps.py

from django.apps import AppConfig


class OrganizacaoConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'organizacao'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\models.py

# organizacao/models.py

from django.db import models
from django.conf import settings


class Empresa(models.Model):
    nome = models.CharField(max_length=100, unique=True,
                            verbose_name="Nome da Empresa")
    cnpj = models.CharField(max_length=18, unique=True,
                            null=True, blank=True, verbose_name="CNPJ")
    endereco = models.CharField(
        max_length=255, null=True, blank=True, verbose_name="Endereço")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")
    # Novo campo para o responsável
    usuario_responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Usuário Responsável",
        related_name='empresas_responsavel'
    )

    class Meta:
        verbose_name = "Empresa"
        verbose_name_plural = "Empresas"
        ordering = ['nome']

    def __str__(self):
        return self.nome


class Area(models.Model):
    empresa = models.ForeignKey(
        Empresa, on_delete=models.CASCADE, verbose_name="Empresa")
    nome = models.CharField(max_length=100, verbose_name="Nome da Área")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")
    # Novo campo para o responsável
    usuario_responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Usuário Responsável",
        related_name='areas_responsavel'
    )

    class Meta:
        verbose_name = "Área"
        verbose_name_plural = "Áreas"
        unique_together = ('empresa', 'nome')
        ordering = ['empresa__nome', 'nome']

    def __str__(self):
        return f"{self.nome} ({self.empresa.nome})"


class Setor(models.Model):
    area = models.ForeignKey(
        Area, on_delete=models.CASCADE, verbose_name="Área")
    nome = models.CharField(max_length=100, verbose_name="Nome do Setor")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")
    # Novo campo para o responsável
    usuario_responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Usuário Responsável",
        related_name='setores_responsavel'
    )

    class Meta:
        verbose_name = "Setor"
        verbose_name_plural = "Setores"
        unique_together = ('area', 'nome')
        ordering = ['area__empresa__nome', 'area__nome', 'nome']

    def __str__(self):
        return f"{self.nome} ({self.area.nome} - {self.area.empresa.nome})"


class SubSetor(models.Model):
    setor = models.ForeignKey(
        Setor, on_delete=models.CASCADE, verbose_name="Setor")
    nome = models.CharField(max_length=100, verbose_name="Nome do Subsetor")
    ativo = models.BooleanField(default=True, verbose_name="Ativo")
    data_cadastro = models.DateTimeField(
        auto_now_add=True, verbose_name="Data de Cadastro")
    data_atualizacao = models.DateTimeField(
        auto_now=True, verbose_name="Última Atualização")
    # Novo campo para o responsável
    usuario_responsavel = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Usuário Responsável",
        related_name='subsetores_responsavel'
    )

    class Meta:
        verbose_name = "Subsetor"
        verbose_name_plural = "Subsetores"
        unique_together = ('setor', 'nome')
        ordering = ['setor__area__empresa__nome',
                    'setor__area__nome', 'setor__nome', 'nome']

    def __str__(self):
        return f"{self.nome} ({self.setor.nome} - {self.setor.area.nome})"

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\urls.py

# organizacao/urls.py

from django.urls import path
from . import views

app_name = 'organizacao'

urlpatterns = [
    # URLs para Empresas
    path('empresas/', views.lista_empresas, name='lista_empresas'),
    path('empresas/criar/', views.criar_empresa, name='criar_empresa'),
    path('empresas/<int:pk>/editar/', views.editar_empresa, name='editar_empresa'),
    path('empresas/<int:pk>/deletar/',
         views.deletar_empresa, name='deletar_empresa'),
    path('empresas/exportar-csv/', views.exportar_empresas_csv,
         name='exportar_empresas_csv'),  # NOVO

    # URLs para Áreas
    path('areas/', views.lista_areas, name='lista_areas'),
    path('areas/criar/', views.criar_area, name='criar_area'),
    path('areas/<int:pk>/editar/', views.editar_area, name='editar_area'),
    path('areas/<int:pk>/deletar/', views.deletar_area, name='deletar_area'),
    path('areas/exportar-csv/', views.exportar_areas_csv,
         name='exportar_areas_csv'),  # NOVO

    # URLs para Setores
    path('setores/', views.lista_setores, name='lista_setores'),
    path('setores/criar/', views.criar_setor, name='criar_setor'),
    path('setores/<int:pk>/editar/', views.editar_setor, name='editar_setor'),
    path('setores/<int:pk>/deletar/', views.deletar_setor, name='deletar_setor'),
    path('setores/exportar-csv/', views.exportar_setores_csv,
         name='exportar_setores_csv'),  # NOVO

    # URLs para Subsetores
    path('subsetores/', views.lista_subsetores, name='lista_subsetores'),
    path('subsetores/criar/', views.criar_subsetor, name='criar_subsetor'),
    path('subsetores/<int:pk>/editar/',
         views.editar_subsetor, name='editar_subsetor'),
    path('subsetores/<int:pk>/deletar/',
         views.deletar_subsetor, name='deletar_subsetor'),
    path('subsetores/exportar-csv/', views.exportar_subsetores_csv,
         name='exportar_subsetores_csv'),  # NOVO
]

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\views.py

# organizacao/views.py

from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required
from django.contrib import messages
from django.core.paginator import Paginator
from django.db.models import Q
from .models import Empresa, Area, Setor, SubSetor
from usuarios.models import Usuario
import csv
from django.http import HttpResponse

# ============================================================================
# VIEWS PARA EMPRESAS
# ============================================================================


@login_required
def lista_empresas(request):
    """Lista todas as empresas."""
    search = request.GET.get('search', '')
    empresas = Empresa.objects.select_related(
        'usuario_responsavel').all()  # Adicionado select_related
    if search:
        empresas = empresas.filter(
            Q(nome__icontains=search) | Q(cnpj__icontains=search))

    paginator = Paginator(empresas, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Empresas',
        'singular': 'Empresa',
        'button_text': 'Nova Empresa',
        'create_url': 'organizacao:criar_empresa',
        'export_url': 'organizacao:exportar_empresas_csv',  # NOVO
        'artigo': 'a',
        'empty_message': 'Nenhuma empresa cadastrada.',
        'empty_subtitle': 'Comece criando a primeira empresa.',
        'tem_permissao_criar': request.user.has_perm('organizacao.add_empresa')
    }
    return render(request, 'organizacao/empresas/lista.html', context)


@login_required
def criar_empresa(request):
    """Cria uma nova empresa."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        if nome:
            try:
                Empresa.objects.create(
                    nome=nome,
                    cnpj=request.POST.get('cnpj'),
                    endereco=request.POST.get('endereco'),
                    ativo=request.POST.get('ativo') == 'on',
                    usuario_responsavel_id=request.POST.get(
                        'usuario_responsavel') or None
                )
                messages.success(request, 'Empresa criada com sucesso!')
                return redirect('organizacao:lista_empresas')
            except Exception as e:
                messages.error(request, f'Erro ao criar empresa: {e}')
        else:
            messages.error(request, 'O nome da empresa é obrigatório.')

    context = {
        'title': 'Criar Empresa',
        'back_url': 'organizacao:lista_empresas',
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/empresas/form.html', context)


@login_required
def editar_empresa(request, pk):
    """Edita uma empresa existente."""
    empresa = get_object_or_404(Empresa, pk=pk)
    if request.method == 'POST':
        nome = request.POST.get('nome')
        if nome:
            try:
                empresa.nome = nome
                empresa.cnpj = request.POST.get('cnpj')
                empresa.endereco = request.POST.get('endereco')
                empresa.ativo = request.POST.get('ativo') == 'on'
                empresa.usuario_responsavel_id = request.POST.get(
                    'usuario_responsavel') or None
                empresa.save()
                messages.success(request, 'Empresa atualizada com sucesso!')
                return redirect('organizacao:lista_empresas')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar empresa: {e}')
        else:
            messages.error(request, 'O nome da empresa é obrigatório.')

    context = {
        'object': empresa,
        'title': 'Editar Empresa',
        'back_url': 'organizacao:lista_empresas',
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/empresas/form.html', context)


@login_required
def deletar_empresa(request, pk):
    """Deleta uma empresa."""
    empresa = get_object_or_404(Empresa, pk=pk)
    if request.method == 'POST':
        try:
            empresa.delete()
            messages.success(request, 'Empresa deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar empresa: {e}')
        return redirect('organizacao:lista_empresas')

    context = {'object': empresa, 'title': 'Empresa'}
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_empresas_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="empresas.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'CNPJ', 'Endereço', 'Responsável', 'Status'])

    search = request.GET.get('search', '')
    empresas = Empresa.objects.select_related('usuario_responsavel').all()
    if search:
        empresas = empresas.filter(
            Q(nome__icontains=search) | Q(cnpj__icontains=search))

    for empresa in empresas:
        responsavel = empresa.usuario_responsavel.get_full_name(
        ) or empresa.usuario_responsavel.username if empresa.usuario_responsavel else 'N/A'
        writer.writerow([
            empresa.nome,
            empresa.cnpj,
            empresa.endereco,
            responsavel,
            'Ativo' if empresa.ativo else 'Inativo'
        ])

    return response

# ============================================================================
# VIEWS PARA ÁREAS
# ============================================================================


@login_required
def lista_areas(request):
    """Lista todas as áreas."""
    search = request.GET.get('search', '')
    areas = Area.objects.select_related(
        'empresa', 'usuario_responsavel').all()  # Adicionado select_related
    if search:
        areas = areas.filter(Q(nome__icontains=search) |
                             Q(empresa__nome__icontains=search))

    paginator = Paginator(areas, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Áreas',
        'singular': 'Área',
        'button_text': 'Nova Área',
        'create_url': 'organizacao:criar_area',
        'export_url': 'organizacao:exportar_areas_csv',  # NOVO
        'artigo': 'a',
        'empty_message': 'Nenhuma área cadastrada.',
        'empty_subtitle': 'Comece criando a primeira área.',
        'tem_permissao_criar': request.user.has_perm('organizacao.add_area')
    }
    return render(request, 'organizacao/areas/lista.html', context)


@login_required
def criar_area(request):
    """Cria uma nova área."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        empresa_id = request.POST.get('empresa')
        if nome and empresa_id:
            try:
                Area.objects.create(
                    nome=nome,
                    empresa_id=empresa_id,
                    ativo=request.POST.get('ativo') == 'on',
                    usuario_responsavel_id=request.POST.get(
                        'usuario_responsavel') or None
                )
                messages.success(request, 'Área criada com sucesso!')
                return redirect('organizacao:lista_areas')
            except Exception as e:
                messages.error(request, f'Erro ao criar área: {e}')
        else:
            messages.error(request, 'Nome e Empresa são obrigatórios.')

    context = {
        'title': 'Criar Área',
        'back_url': 'organizacao:lista_areas',
        'empresas': Empresa.objects.filter(ativo=True),
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/areas/form.html', context)


@login_required
def editar_area(request, pk):
    """Edita uma área existente."""
    area = get_object_or_404(Area, pk=pk)
    if request.method == 'POST':
        nome = request.POST.get('nome')
        empresa_id = request.POST.get('empresa')
        if nome and empresa_id:
            try:
                area.nome = nome
                area.empresa_id = empresa_id
                area.ativo = request.POST.get('ativo') == 'on'
                area.usuario_responsavel_id = request.POST.get(
                    'usuario_responsavel') or None
                area.save()
                messages.success(request, 'Área atualizada com sucesso!')
                return redirect('organizacao:lista_areas')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar área: {e}')
        else:
            messages.error(request, 'Nome e Empresa são obrigatórios.')

    context = {
        'object': area,
        'title': 'Editar Área',
        'back_url': 'organizacao:lista_areas',
        'empresas': Empresa.objects.filter(ativo=True),
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/areas/form.html', context)


@login_required
def deletar_area(request, pk):
    """Deleta uma área."""
    area = get_object_or_404(Area, pk=pk)
    if request.method == 'POST':
        try:
            area.delete()
            messages.success(request, 'Área deletada com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar área: {e}')
        return redirect('organizacao:lista_areas')

    context = {'object': area, 'title': 'Área'}
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_areas_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="areas.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Empresa', 'Responsável', 'Status'])

    search = request.GET.get('search', '')
    areas = Area.objects.select_related('empresa', 'usuario_responsavel').all()
    if search:
        areas = areas.filter(Q(nome__icontains=search) |
                             Q(empresa__nome__icontains=search))

    for area in areas:
        responsavel = area.usuario_responsavel.get_full_name(
        ) or area.usuario_responsavel.username if area.usuario_responsavel else 'N/A'
        writer.writerow([
            area.nome,
            area.empresa.nome,
            responsavel,
            'Ativo' if area.ativo else 'Inativo'
        ])

    return response

# ============================================================================
# VIEWS PARA SETORES
# ============================================================================


@login_required
def lista_setores(request):
    """Lista todos os setores."""
    search = request.GET.get('search', '')
    setores = Setor.objects.select_related(
        # Adicionado select_related
        'area__empresa', 'usuario_responsavel').all()
    if search:
        setores = setores.filter(Q(nome__icontains=search) | Q(
            area__nome__icontains=search) | Q(area__empresa__nome__icontains=search))

    paginator = Paginator(setores, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Setores',
        'singular': 'Setor',
        'button_text': 'Novo Setor',
        'create_url': 'organizacao:criar_setor',
        'export_url': 'organizacao:exportar_setores_csv',  # NOVO
        'artigo': 'o',
        'empty_message': 'Nenhum setor cadastrado.',
        'empty_subtitle': 'Comece criando o primeiro setor.',
        'tem_permissao_criar': request.user.has_perm('organizacao.add_setor')
    }
    return render(request, 'organizacao/setores/lista.html', context)


@login_required
def criar_setor(request):
    """Cria um novo setor."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        area_id = request.POST.get('area')
        if nome and area_id:
            try:
                Setor.objects.create(
                    nome=nome,
                    area_id=area_id,
                    ativo=request.POST.get('ativo') == 'on',
                    usuario_responsavel_id=request.POST.get(
                        'usuario_responsavel') or None
                )
                messages.success(request, 'Setor criado com sucesso!')
                return redirect('organizacao:lista_setores')
            except Exception as e:
                messages.error(request, f'Erro ao criar setor: {e}')
        else:
            messages.error(request, 'Nome e Área são obrigatórios.')

    context = {
        'title': 'Criar Setor',
        'back_url': 'organizacao:lista_setores',
        'areas': Area.objects.filter(ativo=True),
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/setores/form.html', context)


@login_required
def editar_setor(request, pk):
    """Edita um setor existente."""
    setor = get_object_or_404(Setor, pk=pk)
    if request.method == 'POST':
        nome = request.POST.get('nome')
        area_id = request.POST.get('area')
        if nome and area_id:
            try:
                setor.nome = nome
                setor.area_id = area_id
                setor.ativo = request.POST.get('ativo') == 'on'
                setor.usuario_responsavel_id = request.POST.get(
                    'usuario_responsavel') or None
                setor.save()
                messages.success(request, 'Setor atualizado com sucesso!')
                return redirect('organizacao:lista_setores')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar setor: {e}')
        else:
            messages.error(request, 'Nome e Área são obrigatórios.')

    context = {
        'object': setor,
        'title': 'Editar Setor',
        'back_url': 'organizacao:lista_setores',
        'areas': Area.objects.filter(ativo=True),
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/setores/form.html', context)


@login_required
def deletar_setor(request, pk):
    """Deleta um setor."""
    setor = get_object_or_404(Setor, pk=pk)
    if request.method == 'POST':
        try:
            setor.delete()
            messages.success(request, 'Setor deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar setor: {e}')
        return redirect('organizacao:lista_setores')

    context = {'object': setor, 'title': 'Setor'}
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_setores_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="setores.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Área', 'Empresa', 'Responsável', 'Status'])

    search = request.GET.get('search', '')
    setores = Setor.objects.select_related(
        'area__empresa', 'usuario_responsavel').all()
    if search:
        setores = setores.filter(Q(nome__icontains=search) | Q(
            area__nome__icontains=search) | Q(area__empresa__nome__icontains=search))

    for setor in setores:
        responsavel = setor.usuario_responsavel.get_full_name(
        ) or setor.usuario_responsavel.username if setor.usuario_responsavel else 'N/A'
        writer.writerow([
            setor.nome,
            setor.area.nome,
            setor.area.empresa.nome,
            responsavel,
            'Ativo' if setor.ativo else 'Inativo'
        ])

    return response

# ============================================================================
# VIEWS PARA SUBSETORES
# ============================================================================


@login_required
def lista_subsetores(request):
    """Lista todos os subsetores."""
    search = request.GET.get('search', '')
    subsetores = SubSetor.objects.select_related(
        # Adicionado select_related
        'setor__area__empresa', 'usuario_responsavel').all()
    if search:
        subsetores = subsetores.filter(Q(nome__icontains=search) | Q(
            setor__nome__icontains=search) | Q(setor__area__nome__icontains=search))

    paginator = Paginator(subsetores, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Subsetores',
        'singular': 'Subsetor',
        'button_text': 'Novo Subsetor',
        'create_url': 'organizacao:criar_subsetor',
        'export_url': 'organizacao:exportar_subsetores_csv',  # NOVO
        'artigo': 'o',
        'empty_message': 'Nenhum subsetor cadastrado.',
        'empty_subtitle': 'Comece criando o primeiro subsetor.',
        'tem_permissao_criar': request.user.has_perm('organizacao.add_subsetor')
    }
    return render(request, 'organizacao/subsetores/lista.html', context)


@login_required
def criar_subsetor(request):
    """Cria um novo subsetor."""
    if request.method == 'POST':
        nome = request.POST.get('nome')
        setor_id = request.POST.get('setor')
        if nome and setor_id:
            try:
                SubSetor.objects.create(
                    nome=nome,
                    setor_id=setor_id,
                    ativo=request.POST.get('ativo') == 'on',
                    usuario_responsavel_id=request.POST.get(
                        'usuario_responsavel') or None
                )
                messages.success(request, 'Subsetor criado com sucesso!')
                return redirect('organizacao:lista_subsetores')
            except Exception as e:
                messages.error(request, f'Erro ao criar subsetor: {e}')
        else:
            messages.error(request, 'Nome e Setor são obrigatórios.')

    context = {
        'title': 'Criar Subsetor',
        'back_url': 'organizacao:lista_subsetores',
        'setores': Setor.objects.filter(ativo=True),
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/subsetores/form.html', context)


@login_required
def editar_subsetor(request, pk):
    """Edita um subsetor existente."""
    subsetor = get_object_or_404(SubSetor, pk=pk)
    if request.method == 'POST':
        nome = request.POST.get('nome')
        setor_id = request.POST.get('setor')
        if nome and setor_id:
            try:
                subsetor.nome = nome
                subsetor.setor_id = setor_id
                subsetor.ativo = request.POST.get('ativo') == 'on'
                subsetor.usuario_responsavel_id = request.POST.get(
                    'usuario_responsavel') or None
                subsetor.save()
                messages.success(request, 'Subsetor atualizado com sucesso!')
                return redirect('organizacao:lista_subsetores')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar subsetor: {e}')
        else:
            messages.error(request, 'Nome e Setor são obrigatórios.')

    context = {
        'object': subsetor,
        'title': 'Editar Subsetor',
        'back_url': 'organizacao:lista_subsetores',
        'setores': Setor.objects.filter(ativo=True),
        'usuarios': Usuario.objects.filter(is_active=True)
    }
    return render(request, 'organizacao/subsetores/form.html', context)


@login_required
def deletar_subsetor(request, pk):
    """Deleta um subsetor."""
    subsetor = get_object_or_404(SubSetor, pk=pk)
    if request.method == 'POST':
        try:
            subsetor.delete()
            messages.success(request, 'Subsetor deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar subsetor: {e}')
        return redirect('organizacao:lista_subsetores')

    context = {'object': subsetor, 'title': 'Subsetor'}
    return render(request, 'auditorias/deletar_generico.html', context)


@login_required
def exportar_subsetores_csv(request):
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="subsetores.csv"'}
    )

    writer = csv.writer(response)
    writer.writerow(['Nome', 'Setor', 'Área', 'Responsável', 'Status'])

    search = request.GET.get('search', '')
    subsetores = SubSetor.objects.select_related(
        'setor__area__empresa', 'usuario_responsavel').all()
    if search:
        subsetores = subsetores.filter(Q(nome__icontains=search) | Q(
            setor__nome__icontains=search) | Q(setor__area__nome__icontains=search))

    for subsetor in subsetores:
        responsavel = subsetor.usuario_responsavel.get_full_name(
        ) or subsetor.usuario_responsavel.username if subsetor.usuario_responsavel else 'N/A'
        writer.writerow([
            subsetor.nome,
            subsetor.setor.nome,
            subsetor.setor.area.nome,
            responsavel,
            'Ativo' if subsetor.ativo else 'Inativo'
        ])

    return response

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\areas\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="empresa" class="form-label">Empresa</label>
        <select id="empresa" name="empresa" class="form-control form-select" required>
            <option value="">Selecione...</option>
            {% for empresa in empresas %}
            <option value="{{ empresa.pk }}" {% if object.empresa.pk == empresa.pk %}selected{% endif %}>{{ empresa.nome }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome da Área</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ object.nome|default:'' }}" required maxlength="100">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="usuario_responsavel" class="form-label">Responsável</label>
        <select id="usuario_responsavel" name="usuario_responsavel" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.pk }}" {% if object.usuario_responsavel.pk == usuario.pk %}selected{% endif %}>{{ usuario.get_full_name|default:usuario.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">Área ativa no sistema</span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\areas\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome da Área</th>
    <th>Empresa</th>
    <th>Responsável</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.empresa.nome|default:"—" }}</td>
    <td>{{ object.usuario_responsavel.get_full_name|default:object.usuario_responsavel.username|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.organizacao.change_area %}
            <a href="{% url 'organizacao:editar_area' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Área">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}
            {% if perms.organizacao.delete_area %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Área"
                    onclick="confirmDelete('{% url 'organizacao:deletar_area' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\empresas\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome da Empresa</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ object.nome|default:'' }}" required maxlength="100">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="cnpj" class="form-label">CNPJ</label>
        <input type="text" id="cnpj" name="cnpj" class="form-control" value="{{ object.cnpj|default:'' }}" maxlength="18">
    </div>
    <div class="form-group">
        <label for="endereco" class="form-label">Endereço</label>
        <input type="text" id="endereco" name="endereco" class="form-control" value="{{ object.endereco|default:'' }}" maxlength="255">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="usuario_responsavel" class="form-label">Responsável</label>
        <select id="usuario_responsavel" name="usuario_responsavel" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.pk }}" {% if object.usuario_responsavel.pk == usuario.pk %}selected{% endif %}>{{ usuario.get_full_name|default:usuario.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">Empresa ativa no sistema</span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\empresas\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome da Empresa</th>
    <th>CNPJ</th>
    <th>Responsável</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.cnpj|default:"—" }}</td>
    <td>{{ object.usuario_responsavel.get_full_name|default:object.usuario_responsavel.username|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.organizacao.change_empresa %}
            <a href="{% url 'organizacao:editar_empresa' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Empresa">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}
            
            {% if perms.organizacao.delete_empresa %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Empresa"
                    onclick="confirmDelete('{% url 'organizacao:deletar_empresa' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\setores\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="area" class="form-label">Área</label>
        <select id="area" name="area" class="form-control form-select" required>
            <option value="">Selecione...</option>
            {% for area in areas %}
            <option value="{{ area.pk }}" {% if object.area.pk == area.pk %}selected{% endif %}>{{ area.nome }} ({{ area.empresa.nome }})</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Setor</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ object.nome|default:'' }}" required maxlength="100">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="usuario_responsavel" class="form-label">Responsável</label>
        <select id="usuario_responsavel" name="usuario_responsavel" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.pk }}" {% if object.usuario_responsavel.pk == usuario.pk %}selected{% endif %}>{{ usuario.get_full_name|default:usuario.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">Setor ativo no sistema</span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\setores\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome do Setor</th>
    <th>Área</th>
    <th>Empresa</th>
    <th>Responsável</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.area.nome|default:"—" }}</td>
    <td>{{ object.area.empresa.nome|default:"—" }}</td>
    <td>{{ object.usuario_responsavel.get_full_name|default:object.usuario_responsavel.username|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.organizacao.change_setor %}
            <a href="{% url 'organizacao:editar_setor' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Setor">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}
            {% if perms.organizacao.delete_setor %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Setor"
                    onclick="confirmDelete('{% url 'organizacao:deletar_setor' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\subsetores\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="setor" class="form-label">Setor</label>
        <select id="setor" name="setor" class="form-control form-select" required>
            <option value="">Selecione...</option>
            {% for setor in setores %}
            <option value="{{ setor.pk }}" {% if object.setor.pk == setor.pk %}selected{% endif %}>{{ setor.nome }} ({{ setor.area.nome }})</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Subsetor</label>
        <input type="text" id="nome" name="nome" class="form-control" value="{{ object.nome|default:'' }}" required maxlength="100">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label for="usuario_responsavel" class="form-label">Responsável</label>
        <select id="usuario_responsavel" name="usuario_responsavel" class="form-control form-select">
            <option value="">Selecione...</option>
            {% for usuario in usuarios %}
            <option value="{{ usuario.pk }}" {% if object.usuario_responsavel.pk == usuario.pk %}selected{% endif %}>{{ usuario.get_full_name|default:usuario.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>
<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" name="ativo" {% if object.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">Subsetor ativo no sistema</span>
        </div>
    </div>
</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\organizacao\templates\organizacao\subsetores\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block table_headers %}
    <th>Nome do Subsetor</th>
    <th>Setor</th>
    <th>Área</th>
    <th>Responsável</th>
    <th>Status</th>
    <th style="width: 120px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
            {{ object.nome }}
        </div>
    </td>
    <td>{{ object.setor.nome|default:"—" }}</td>
    <td>{{ object.setor.area.nome|default:"—" }}</td>
    <td>{{ object.usuario_responsavel.get_full_name|default:object.usuario_responsavel.username|default:"—" }}</td>
    <td>
        {% if object.ativo %}
            <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
        {% else %}
            <span class="badge badge-error"><i class="fas fa-times-circle"></i> Inativo</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.organizacao.change_subsetor %}
            <a href="{% url 'organizacao:editar_subsetor' object.pk %}" class="btn btn-secondary btn-icon" title="Editar Subsetor">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}
            {% if perms.organizacao.delete_subsetor %}
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Subsetor"
                    onclick="confirmDelete('{% url 'organizacao:deletar_subsetor' object.pk %}', '{{ object.nome }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
        </div>
    </td>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\planos_de_acao\admin.py

# planos_de_acao/admin.py

from django.contrib import admin
from .models import (
    ResponsavelLocal,
    NaoConformidade,
    Forum,
    MensagemForum
)


@admin.register(ResponsavelLocal)
class ResponsavelLocalAdmin(admin.ModelAdmin):
    list_display = ('usuario', 'local_empresa', 'local_area',
                    'local_setor', 'local_subsetor')
    search_fields = ('usuario__username',
                     'local_empresa__nome', 'local_area__nome')
    fieldsets = (
        (None, {
            'fields': ('usuario', 'local_empresa', 'local_area', 'local_setor', 'local_subsetor')
        }),
    )


@admin.register(NaoConformidade)
class NaoConformidadeAdmin(admin.ModelAdmin):
    list_display = (
        'id_nao_conformidade',
        'id_formulario',
        'titulo',
        'responsavel_acao',
        'data_abertura',
        'data_encerramento',
        'criticidade',
        'local_setor'  # Exibe o setor como exemplo de local
    )
    list_filter = ('criticidade', 'data_abertura', 'responsavel_acao')
    search_fields = ('id_nao_conformidade', 'titulo__descricao')
    filter_horizontal = ('ferramentas_auxiliares',)
    readonly_fields = ('data_abertura', 'data_encerramento',
                       'id_nao_conformidade')
    fieldsets = (
        ("Identificação", {
            'fields': ('id_nao_conformidade', 'id_formulario', 'titulo', 'descricao_desvio')
        }),
        ("Responsabilidade e Ação", {
            'fields': ('responsavel_acao', 'acao_corretiva', 'prazo_conclusao', 'criticidade')
        }),
        ("Detalhes da Auditoria", {
            'fields': ('ferramenta', 'categoria', 'local_empresa', 'local_area', 'local_setor', 'local_subsetor')
        }),
        ("Análise e Suporte", {
            'fields': ('analise', 'ferramentas_auxiliares', 'forum')
        }),
        ("Datas", {
            'fields': ('data_abertura', 'data_encerramento')
        })
    )

# Registro dos modelos de fórum (opcional, mas recomendado)


@admin.register(Forum)
class ForumAdmin(admin.ModelAdmin):
    list_display = ('nome', 'data_criacao')


@admin.register(MensagemForum)
class MensagemForumAdmin(admin.ModelAdmin):
    list_display = ('autor', 'forum', 'data_envio')
    list_filter = ('forum', 'autor')

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\planos_de_acao\apps.py

from django.apps import AppConfig


class PlanosDeAcaoConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'planos_de_acao'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\planos_de_acao\models.py

# planos_de_acao/models.py

from django.db import models
from django.conf import settings
from django.utils import timezone
from datetime import timedelta
from organizacao.models import Empresa, Area, Setor, SubSetor

# Definição do modelo de Responsáveis de Plano de Ação por Local


class ResponsavelLocal(models.Model):
    usuario = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        verbose_name="Responsável"
    )
    # Relação com os níveis organizacionais
    local_empresa = models.ForeignKey(
        Empresa, on_delete=models.CASCADE, null=True, blank=True)
    local_area = models.ForeignKey(
        Area, on_delete=models.CASCADE, null=True, blank=True)
    local_setor = models.ForeignKey(
        Setor, on_delete=models.CASCADE, null=True, blank=True)
    local_subsetor = models.ForeignKey(
        SubSetor, on_delete=models.CASCADE, null=True, blank=True)

    class Meta:
        verbose_name = "Responsável por Local"
        verbose_name_plural = "Responsáveis por Local"

    def __str__(self):
        return f"{self.usuario.get_full_name()} - {self.local_empresa or self.local_area or self.local_setor or self.local_subsetor}"

# Modelos para o Fórum/Chat


class Forum(models.Model):
    nome = models.CharField(max_length=255, verbose_name="Título do Fórum")
    data_criacao = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Fórum"
        verbose_name_plural = "Fóruns"

    def __str__(self):
        return self.nome


class MensagemForum(models.Model):
    forum = models.ForeignKey(
        Forum, on_delete=models.CASCADE, related_name='mensagens')
    autor = models.ForeignKey(settings.AUTH_USER_MODEL,
                              on_delete=models.SET_NULL, null=True)
    conteudo = models.TextField()
    data_envio = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Mensagem de Fórum"
        verbose_name_plural = "Mensagens de Fórum"
        ordering = ['data_envio']

    def __str__(self):
        return f"Mensagem de {self.autor} em {self.data_envio.strftime('%d/%m/%Y %H:%M')}"


# Opções para a Criticidade
CRITICIDADE_CHOICES = [
    ('NC MAIOR', 'Não Conformidade Maior'),
    ('NC MENOR', 'Não Conformidade Menor'),
    ('DESVIO SOLUCIONADO', 'Desvio Solucionado'),
    ('NA', 'N/A'),
]

# Modelo principal para a Não Conformidade / Plano de Ação


class NaoConformidade(models.Model):
    # Campos de identificação
    id_nao_conformidade = models.CharField(
        max_length=50, unique=True, verbose_name="ID Não Conformidade")

    id_formulario = models.ForeignKey(
        'auditorias.AuditoriaInstancia',  # <-- MUDANÇA AQUI
        on_delete=models.CASCADE,
        verbose_name="ID do Formulário"
    )
    titulo = models.ForeignKey(
        'auditorias.Topico',  # <-- MUDANÇA AQUI
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Título"
    )

    # Campos de Ação
    descricao_desvio = models.TextField(verbose_name="Descrição do Desvio")
    acao_corretiva = models.TextField(
        verbose_name="Ação Corretiva", null=True, blank=True)
    responsavel_acao = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True, blank=True,
        verbose_name="Responsável pela Ação"
    )
    prazo_conclusao = models.DateField(verbose_name="Prazo de Conclusão")

    # Campos da sua tabela
    perfil_responsavel = models.CharField(
        max_length=100, verbose_name="Perfil")
    forum = models.ForeignKey(
        # Este está OK (mesmo arquivo)
        Forum, on_delete=models.SET_NULL, null=True, blank=True)

    ferramenta = models.ForeignKey(
        'auditorias.FerramentaDigital',  # <-- MUDANÇA AQUI
        on_delete=models.SET_NULL, null=True, blank=True)
    categoria = models.ForeignKey(
        'auditorias.CategoriaAuditoria',  # <-- MUDANÇA AQUI
        on_delete=models.SET_NULL, null=True, blank=True)

    # Adicione os campos de data que estavam faltando
    data_abertura = models.DateTimeField(
        auto_now_add=True,
        verbose_name="Data de Abertura"
    )
    data_encerramento = models.DateTimeField(
        verbose_name="Data de Encerramento",
        null=True,
        blank=True
    )

    # Campo para criticidade
    criticidade = models.CharField(
        max_length=20,
        choices=CRITICIDADE_CHOICES,
        null=True, blank=True,
        verbose_name="Criticidade"
    )

    # Relação com o Local
    local_empresa = models.ForeignKey(
        Empresa, on_delete=models.SET_NULL, null=True, blank=True, related_name='nao_conformidades_empresa')
    local_area = models.ForeignKey(Area, on_delete=models.SET_NULL,
                                   null=True, blank=True, related_name='nao_conformidades_area')
    local_setor = models.ForeignKey(
        Setor, on_delete=models.SET_NULL, null=True, blank=True, related_name='nao_conformidades_setor')
    local_subsetor = models.ForeignKey(
        SubSetor, on_delete=models.SET_NULL, null=True, blank=True, related_name='nao_conformidades_subsetor')

    analise = models.TextField(null=True, blank=True, verbose_name="Análise")
    ferramentas_auxiliares = models.ManyToManyField(
        'auditorias.FerramentaCausaRaiz',  # <-- MUDANÇA AQUI
        verbose_name="Ferramentas Auxiliares",
        related_name='nao_conformidades',
        blank=True
    )

    class Meta:
        verbose_name = "Não Conformidade"
        verbose_name_plural = "Não Conformidades"
        ordering = ['-data_abertura']

    def __str__(self):
        return f"Não Conformidade {self.id_nao_conformidade}"

    def save(self, *args, **kwargs):
        if not self.data_encerramento:
            self.data_encerramento = self.data_abertura + timedelta(days=7)
        super().save(*args, **kwargs)


class MensagemForum(models.Model):
    forum = models.ForeignKey(
        Forum, on_delete=models.CASCADE, related_name='mensagens')
    autor = models.ForeignKey(settings.AUTH_USER_MODEL,
                              on_delete=models.SET_NULL, null=True)
    conteudo = models.TextField()
    data_envio = models.DateTimeField(auto_now_add=True)

    # --- ADICIONE ESTE CAMPO ---
    editado = models.BooleanField(default=False, verbose_name="Editado")

    class Meta:
        verbose_name = "Mensagem de Fórum"

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\planos_de_acao\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\planos_de_acao\urls.py

from django.urls import path
from . import views

app_name = 'planos_de_acao'

urlpatterns = [
    path('api/forum/<int:forum_id>/mensagens/',
         views.api_listar_mensagens, name='api_listar_mensagens'),
    path('api/forum/<int:forum_id>/enviar/',
         views.api_enviar_mensagem, name='api_enviar_mensagem'),

    path('api/mensagem/<int:mensagem_id>/editar/',
         views.api_editar_mensagem, name='api_editar_mensagem'),
    path('api/mensagem/<int:mensagem_id>/deletar/',
         views.api_deletar_mensagem, name='api_deletar_mensagem'),
]

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\planos_de_acao\views.py

from django.http import JsonResponse
from django.views.decorators.http import require_http_methods
from django.contrib.auth.decorators import login_required
from django.views.decorators.csrf import csrf_exempt
from django.shortcuts import get_object_or_404
from .models import Forum, MensagemForum
from django.utils import timezone
from datetime import timedelta
import json


@login_required
def api_listar_mensagens(request, forum_id):
    forum = get_object_or_404(Forum, pk=forum_id)
    mensagens = forum.mensagens.select_related(
        'autor').all().order_by('data_envio')

    data = []
    agora = timezone.now()

    for msg in mensagens:
        is_me = msg.autor == request.user

        # Verifica se passou menos de 1 hora (3600 segundos)
        tempo_decorrido = agora - msg.data_envio
        pode_editar = is_me and (tempo_decorrido.total_seconds() <= 3600)

        # Ajuste do fuso horário para exibição
        data_local = timezone.localtime(msg.data_envio)

        data.append({
            'id': msg.id,
            'autor': msg.autor.get_full_name() or msg.autor.username if msg.autor else 'Sistema',
            'conteudo': msg.conteudo,
            'data_envio': data_local.strftime('%d/%m %H:%M'),
            'is_me': is_me,
            'can_edit': pode_editar,  # <--- Nova flag para o frontend
            'editado': msg.editado,
        })

    return JsonResponse({'mensagens': data})


@login_required
@require_http_methods(["POST"])
def api_editar_mensagem(request, mensagem_id):
    """Edita uma mensagem se estiver dentro do prazo de 1 hora."""
    mensagem = get_object_or_404(
        MensagemForum, pk=mensagem_id, autor=request.user)

    # Validação de tempo no Backend (Segurança)
    agora = timezone.now()
    if (agora - mensagem.data_envio).total_seconds() > 3600:
        return JsonResponse({'success': False, 'error': 'Tempo limite para edição excedido.'}, status=403)

    try:
        data = json.loads(request.body)
        novo_conteudo = data.get('conteudo')

        if not novo_conteudo:
            return JsonResponse({'success': False, 'error': 'Conteúdo vazio.'})

        mensagem.conteudo = novo_conteudo
        mensagem.editado = True  # <--- ADICIONE ESTA LINHA: Marca como editado
        mensagem.save()

        return JsonResponse({'success': True})
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)})


@login_required
@require_http_methods(["POST"])
def api_deletar_mensagem(request, mensagem_id):
    """Deleta uma mensagem se estiver dentro do prazo de 1 hora."""
    mensagem = get_object_or_404(
        MensagemForum, pk=mensagem_id, autor=request.user)

    # Validação de tempo no Backend (Segurança)
    agora = timezone.now()
    if (agora - mensagem.data_envio).total_seconds() > 3600:
        return JsonResponse({'success': False, 'error': 'Tempo limite para exclusão excedido.'}, status=403)

    try:
        mensagem.delete()
        return JsonResponse({'success': True})
    except Exception as e:
        return JsonResponse({'success': False, 'error': str(e)})


@login_required
@require_http_methods(["POST"])
def api_enviar_mensagem(request, forum_id):
    """Recebe uma nova mensagem e salva no banco."""
    forum = get_object_or_404(Forum, pk=forum_id)

    try:
        data = json.loads(request.body)
        conteudo = data.get('conteudo')

        if not conteudo:
            return JsonResponse({'error': 'Conteúdo vazio'}, status=400)

        nova_mensagem = MensagemForum.objects.create(
            forum=forum,
            autor=request.user,
            conteudo=conteudo
        )

        return JsonResponse({
            'success': True,
            'mensagem': {
                'id': nova_mensagem.id,
                'autor': request.user.get_full_name() or request.user.username,
                'conteudo': nova_mensagem.conteudo,
                'data_envio': nova_mensagem.data_envio.strftime('%d/%m %H:%M'),
                'is_me': True
            }
        })
    except Exception as e:
        return JsonResponse({'error': str(e)}, status=500)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\planos_de_acao\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\static\css\login.css

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #3b82f6;
    --secondary: #f8fafc;
    --accent: #059669;
    --error: #dc2626;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #64748b;
    --border: rgba(255, 255, 255, 0.2);
    --border-focus: #93c5fd;
    --bg-primary: rgba(255, 255, 255, 0.95);
    --bg-secondary: #f1f5f9;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 15px;
    position: relative;
    overflow-x: hidden;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #64748b 100%);
}

/* Animated Background Elements */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(37, 99, 235, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 60% 70%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
}

body::after {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
        linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.02) 50%, transparent 70%),
        linear-gradient(-45deg, transparent 30%, rgba(37, 99, 235, 0.03) 50%, transparent 70%);
    pointer-events: none;
    z-index: -1;
}

/* Floating geometric shapes */
.bg-shape {
    position: fixed;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(168, 85, 247, 0.05));
    animation: float 6s ease-in-out infinite;
    z-index: -1;
}

.bg-shape:nth-child(1) {
    width: 120px;
    height: 120px;
    top: 10%;
    left: 10%;
    animation-delay: 0s;
}

.bg-shape:nth-child(2) {
    width: 80px;
    height: 80px;
    top: 70%;
    right: 15%;
    animation-delay: -2s;
}

.bg-shape:nth-child(3) {
    width: 60px;
    height: 60px;
    bottom: 20%;
    left: 20%;
    animation-delay: -4s;
}

.bg-shape:nth-child(4) {
    width: 100px;
    height: 100px;
    top: 30%;
    right: 25%;
    animation-delay: -1s;
}

.login-container {
    width: 100%;
    max-width: 1000px;
    min-height: 70vh;
    position: relative;
    z-index: 10;
    display: flex;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    animation: containerFadeIn 1s ease-out;
}

.welcome-section {
    flex: 1;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    backdrop-filter: blur(10px);
    padding: 40px 35px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    color: white;
    position: relative;
    overflow: hidden;
    min-height: 100%;
}

.welcome-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 60%),
        radial-gradient(circle at 70% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 60%),
        linear-gradient(45deg, transparent 40%, rgba(255, 255, 255, 0.03) 50%, transparent 60%);
    pointer-events: none;
}

.welcome-header-content {
    position: relative;
    z-index: 2;
    flex-shrink: 0;
}

.company-logo {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 30px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.company-logo svg {
    width: 28px;
    height: 28px;
    color: white;
}

.welcome-section h1 {
    font-size: clamp(1.8rem, 4vw, 2.5rem);
    font-weight: 800;
    margin-bottom: 15px;
    letter-spacing: -0.03em;
    line-height: 1.1;
    background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.welcome-section p {
    font-size: clamp(1rem, 2.5vw, 1.1rem);
    opacity: 0.9;
    line-height: 1.6;
    margin-bottom: 30px;
    font-weight: 400;
}

/* Container da imagem do celular */
.mobile-illustration-container {
    position: relative;
    width: 100%;
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    /* Adicione uma margem negativa para puxar para cima */
    margin-top: -30px; 
    margin-bottom: 20px;
    max-height: 300px;
    overflow: hidden;
}

/* Estilo para a imagem do celular */
.mobile-illustration {
    /* Use 'relative' para que o top e left funcionem em relação ao fluxo normal */
    position: relative; 
    max-width: 80%;
    height: auto;
    max-height: 250px;
    object-fit: contain;
    
    left: -45px; /* Ajuste para mover para a esquerda */
    
    transform: rotate(-10deg);
    opacity: 0.9;
    z-index: 1;
    transition: transform 0.5s ease-in-out;
}

.mobile-illustration:hover {
    transform: scale(1.05) rotate(-10deg);
}

.features-list {
    list-style: none;
    padding: 0;
    margin: 0;
    position: relative;
    z-index: 2;
    flex-shrink: 0;
}

.features-list li {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    font-size: clamp(0.9rem, 2vw, 1rem);
    opacity: 0.9;
    font-weight: 500;
}

.features-list li::before {
    content: '✓';
    width: 20px;
    height: 20px;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(5px);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 12px;
    font-weight: bold;
    border: 1px solid rgba(255, 255, 255, 0.2);
    flex-shrink: 0;
}

.login-section {
    flex: 1;
    padding: 40px 35px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    position: relative;
    min-height: 100%;
}

.login-section::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 150px;
    height: 150px;
    background: radial-gradient(circle, rgba(37, 99, 235, 0.03) 0%, transparent 70%);
    border-radius: 50%;
    transform: translate(75px, -75px);
}

.login-header {
    margin-bottom: 30px;
    position: relative;
    z-index: 2;
}

.login-header h2 {
    font-size: clamp(1.5rem, 3vw, 1.8rem);
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
    letter-spacing: -0.02em;
}

.login-header p {
    color: var(--text-secondary);
    font-size: clamp(0.95rem, 2vw, 1rem);
    font-weight: 400;
}

.form-group {
    margin-bottom: 24px;
    position: relative;
}

.input-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
}

.input-wrapper input {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-md);
    padding: 16px 20px;
    color: var(--text-primary);
    font-size: 15px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    width: 100%;
    outline: none;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}

.input-wrapper input::placeholder {
    color: transparent;
}

.input-wrapper label {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 15px;
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
    background: rgba(255, 255, 255, 0.9);
    padding: 0 6px;
    margin-left: -6px;
    border-radius: 4px;
}

.input-wrapper input:focus,
.input-wrapper input:valid,
.input-wrapper input.has-value {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1), 0 4px 20px rgba(37, 99, 235, 0.1);
    background: rgba(255, 255, 255, 0.95);
}

.input-wrapper input:focus + label,
.input-wrapper input:valid + label,
.input-wrapper input.has-value + label {
    transform: translateY(-32px) scale(0.85);
    color: var(--primary);
    font-weight: 600;
}

.password-wrapper {
    position: relative;
}

.password-wrapper input {
    padding-right: 50px;
}

.password-toggle {
    position: absolute;
    right: 15px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    color: var(--text-muted);
    transition: all 0.2s ease;
    border-radius: var(--radius-sm);
}

.password-toggle:hover {
    color: var(--text-secondary);
    background: rgba(37, 99, 235, 0.05);
}

.eye-icon {
    width: 20px;
    height: 20px;
}

.login-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border: none;
    border-radius: var(--radius-md);
    padding: 16px 24px;
    color: white;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    margin-bottom: 24px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
}

.login-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
}

.login-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
}

.login-btn:active {
    transform: translateY(0);
}

.login-btn:disabled {
    pointer-events: none;
    background: var(--text-muted);
    box-shadow: none;
}

.btn-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: opacity 0.2s ease;
    position: relative;
    z-index: 2;
}

.btn-loader {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 20px;
    height: 20px;
    border: 2px solid transparent;
    border-top: 2px solid white;
    border-radius: 50%;
    opacity: 0;
    animation: spin 1s linear infinite;
    transition: opacity 0.2s ease;
}

.login-btn.loading .btn-content {
    opacity: 0;
}

.login-btn.loading .btn-loader {
    opacity: 1;
}

/* Django form errors */
.errorlist {
    list-style: none;
    padding: 0;
    margin: 6px 0 0 0;
}

.errorlist li {
    color: var(--error);
    font-size: 0.85rem;
    margin-bottom: 3px;
    font-weight: 500;
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-15px) rotate(180deg); }
}

@keyframes containerFadeIn {
    from { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95);
    }
    to { 
        opacity: 1; 
        transform: translateY(0) scale(1);
    }
}

/* Mobile Responsive */
@media (max-width: 768px) {
    body {
        padding: 10px;
        align-items: flex-start;
        padding-top: 20px;
    }
    
    .login-container {
        flex-direction: column;
        max-width: 100%;
        min-height: auto;
        max-height: none;
    }
    
    .welcome-section {
        padding: 30px 25px;
        min-height: auto;
        justify-content: flex-start;
    }
    
    .welcome-section h1 {
        font-size: 2rem;
        margin-bottom: 12px;
    }
    
    .welcome-section p {
        margin-bottom: 20px;
    }
    
    .mobile-illustration-container {
        max-height: 200px;
        margin: 15px 0;
    }
    
    .mobile-illustration {
        max-width: 70%;
        max-height: 180px;
    }
    
    .features-list li {
        margin-bottom: 12px;
        font-size: 0.9rem;
    }
    
    .features-list li::before {
        width: 18px;
        height: 18px;
        margin-right: 10px;
    }
    
    .login-section {
        padding: 30px 25px;
        min-height: auto;
    }
    
    .login-header {
        margin-bottom: 25px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .login-btn {
        margin-bottom: 20px;
    }
}

@media (max-width: 480px) {
    body {
        padding: 8px;
    }
    
    .login-container {
        border-radius: var(--radius-md);
    }
    
    .welcome-section {
        padding: 25px 20px;
    }
    
    .welcome-section h1 {
        font-size: 1.8rem;
    }
    
    .mobile-illustration-container {
        max-height: 180px;
        margin: 10px 0;
    }
    
    .mobile-illustration {
        max-width: 70%;
        max-height: 170px;
    }
    
    .features-list li {
        font-size: 0.85rem;
        margin-bottom: 10px;
    }
    
    .login-section {
        padding: 25px 20px;
    }
    
    .input-wrapper input {
        padding: 14px 18px;
        font-size: 16px; /* Evita zoom no iOS */
    }
    
    .password-wrapper input {
        padding-right: 45px;
    }
}

@media (max-width: 360px) {
    .welcome-section {
        padding: 20px 15px;
    }
    
    .login-section {
        padding: 20px 15px;
    }
    
    .company-logo {
        width: 50px;
        height: 50px;
        margin-bottom: 20px;
    }
    
    .mobile-illustration-container {
        max-height: 120px;
    }
    
    .mobile-illustration {
        max-height: 110px;
    }
}

/* Landscape orientation fixes for mobile */
@media (max-height: 600px) and (orientation: landscape) {
    body {
        align-items: center;
        padding: 10px;
    }
    
    .login-container {
        min-height: auto;
        max-height: 90vh;
    }
    
    .welcome-section {
        padding: 20px;
    }
    
    .mobile-illustration-container {
        display: none; /* Esconde a ilustração em landscape */
    }
    
    .features-list {
        display: none; /* Esconde features em landscape para economizar espaço */
    }
    
    .login-section {
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .login-section {
        background: rgba(30, 41, 59, 0.95);
        color: #f8fafc;
    }

    .login-header h2 {
        color: #f8fafc;
    }

    .login-header p {
        color: #cbd5e1;
    }

    .input-wrapper input {
        background: rgba(15, 23, 42, 0.8);
        color: #f8fafc;
        border-color: rgba(255, 255, 255, 0.1);
    }

    .input-wrapper label {
        background: rgba(30, 41, 59, 0.9);
        color: #94a3b8;
    }

    .input-wrapper input:focus,
    .input-wrapper input:valid,
    .input-wrapper input.has-value {
        background: rgba(15, 23, 42, 0.95);
    }

    .password-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .toast-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        pointer-events: none; /* Permite cliques através do container */
        gap: 12px;
    }

    .toast {
        background: linear-gradient(135deg, 
            rgba(15, 23, 42, 0.98) 0%, 
            rgba(30, 41, 59, 0.98) 100%);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 20px;
        min-width: 400px;
        max-width: 500px;
        width: 90%;
        box-shadow: 
            0 25px 50px -12px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 16px;
        position: relative;
        overflow: hidden;
        pointer-events: auto; /* Permite interação com o toast */
        animation: slideDownIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: top center;
    }

    .toast::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
            transparent 0%, 
            currentColor 50%, 
            transparent 100%);
    }

    .toast.toast-error {
        color: #fca5a5;
        border-color: rgba(239, 68, 68, 0.3);
    }

    .toast.toast-error::before {
        background: linear-gradient(90deg, 
            transparent 0%, 
            #ef4444 50%, 
            transparent 100%);
    }

    .toast.toast-success {
        color: #86efac;
        border-color: rgba(34, 197, 94, 0.3);
    }

    .toast.toast-success::before {
        background: linear-gradient(90deg, 
            transparent 0%, 
            #22c55e 50%, 
            transparent 100%);
    }

    .toast-icon {
        flex-shrink: 0;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.25);
    }

    .toast.toast-success .toast-icon {
        background: rgba(34, 197, 94, 0.15);
        border-color: rgba(34, 197, 94, 0.25);
    }

    .toast-content {
        flex: 1;
        min-width: 0;
    }

    .toast-title {
        font-size: 16px;
        font-weight: 700;
        color: #f8fafc;
        margin-bottom: 6px;
        letter-spacing: -0.025em;
    }

    .toast-message {
        font-size: 14px;
        color: rgba(248, 250, 252, 0.85);
        line-height: 1.5;
        word-wrap: break-word;
    }

    .toast-close {
        flex-shrink: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: rgba(255, 255, 255, 0.6);
    }

    .toast-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
        transform: scale(1.05);
    }

    .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: rgba(255, 255, 255, 0.1);
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, 
            currentColor 0%, 
            rgba(255, 255, 255, 0.8) 50%, 
            currentColor 100%);
        width: 100%;
        transform: translateX(-100%);
        animation: progressSlide 8s linear forwards;
    }

    /* Animações */
    @keyframes slideDownIn {
        from {
            opacity: 0;
            transform: translateY(-100px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes slideUpOut {
        from {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        to {
            opacity: 0;
            transform: translateY(-100px) scale(0.95);
        }
    }

    @keyframes progressSlide {
        from {
            transform: translateX(-100%);
        }
        to {
            transform: translateX(0);
        }
    }

    .toast.hiding {
        animation: slideUpOut 0.4s cubic-bezier(0.4, 0, 1, 1) forwards;
    }

    /* Responsivo para toasts */
    @media (max-width: 600px) {
        .toast-container {
            padding: 16px 12px;
        }
        
        .toast {
            min-width: unset;
            width: 100%;
            max-width: unset;
            padding: 16px;
            border-radius: 12px;
        }
        
        .toast-icon {
            width: 36px;
            height: 36px;
        }
        
        .toast-title {
            font-size: 15px;
        }
        
        .toast-message {
            font-size: 13px;
        }
        
        .toast-close {
            width: 28px;
            height: 28px;
        }
    }

    @media (max-width: 400px) {
        .toast {
            padding: 14px;
            gap: 12px;
        }
        
        .toast-icon {
            width: 32px;
            height: 32px;
        }
        
        .toast-title {
            font-size: 14px;
        }
        
        .toast-message {
            font-size: 12px;
        }
    }

    .field-error {
        color: var(--error);
        font-size: 0.85rem;
        margin-top: 8px; /* Aumenta o espaçamento superior */
        font-weight: 500;
        padding-left: 5px; /* Adiciona um pequeno recuo */
        animation: shake 0.3s ease-in-out; /* Adiciona uma animação sutil */
    }

    /* Estilo para inputs com erro */
    .input-wrapper input.error {
        border-color: var(--error) !important;
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
    }

    .input-wrapper input.error + label {
        color: var(--error) !important;
    }

    /* Animação de "tremor" para erros */
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        75% { transform: translateX(4px); }
    }

}
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\static\js\login.js

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('loginForm');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const passwordToggle = document.getElementById('passwordToggle');
    const loginButton = document.getElementById('loginButton');

    // Sai da função se o formulário não for encontrado, evitando erros.
    if (!form) return;

    // --- 1. Lógica para os Labels Flutuantes ---
    function checkValue(input) {
        if (input.value.trim() !== '') {
            input.classList.add('has-value');
        } else {
            input.classList.remove('has-value');
        }
    }

    [usernameInput, passwordInput].forEach(input => {
        if (input) {
            // Verifica o valor inicial (caso o navegador preencha automaticamente)
            checkValue(input);
            
            // Adiciona os "ouvintes" de eventos
            input.addEventListener('input', () => checkValue(input));
            input.addEventListener('blur', () => checkValue(input));
        }
    });

    // --- 2. Lógica para Mostrar/Ocultar Senha (O Ponto Principal da Correção) ---
    if (passwordToggle && passwordInput) {
        passwordToggle.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';

            const eyeIcon = passwordToggle.querySelector('.eye-icon');
            if (isPassword) {
                // Se a senha estava oculta, agora será mostrada. Usamos o ícone de "olho cortado".
                eyeIcon.innerHTML = `
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                    <line x1="1" y1="1" x2="23" y2="23"/>
                `;
            } else {
                // Se a senha estava visível, agora será ocultada. Usamos o ícone de "olho normal".
                eyeIcon.innerHTML = `
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                `;
            }
        });
    }

    // --- 3. Lógica do Botão de Login (efeito "loading") ---
    form.addEventListener('submit', function(e) {
        if (loginButton) {
            // Validação simples para não ativar o loading se os campos estiverem vazios
            if (usernameInput.value.trim() === '' || passwordInput.value.trim() === '') {
                return;
            }
            loginButton.classList.add('loading');
            loginButton.disabled = true;
        }
    });

});
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\templates\home.html

{% extends 'auditorias/base.html' %}

{% block title %}Dashboard - Sistema de Auditorias{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="content-header">
    <h2 class="content-title">Bem-vindo, {{ user.get_full_name|default:user.username }}!</h2>
    <p class="content-subtitle">Esta é a página inicial do sistema de auditorias.</p>
</div>

<!-- Cards de Estatísticas -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">
                        {{ total_auditorias }}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Total de Auditorias</p>
                </div>
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-calendar-check"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 8px;">
                        {{ auditorias_agendadas }}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Auditorias Futuras</p>
                </div>
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-calendar-plus"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--error); margin-bottom: 8px;">
                        {{ auditorias_executadas }}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Executadas</p>
                </div>
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-clipboard-check"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 32px;">
    <div class="card-header">
        <h3 class="card-title">Acesso rápido</h3>
        <p class="card-subtitle">Vá direto para os principais módulos</p>
    </div>
    <div class="card-body">
        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
            <a href="{% url 'auditorias:lista_auditorias' %}" class="btn btn-primary">
                <i class="fas fa-list"></i> Ver Todas as Auditorias
            </a>
            <a href="{% url 'auditorias:criar_auditoria' %}" class="btn btn-secondary">
                <i class="fas fa-plus"></i> Nova Auditoria
            </a>
            <a href="{% url 'logout' %}" class="btn btn-danger">
                <i class="fas fa-sign-out-alt"></i> Sair
            </a>
        </div>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\templates\lista_auditorias.html

{% extends 'auditorias/base.html' %}

{% block title %}Lista de Auditorias - Sistema de Auditorias{% endblock %}
{% block page_title %}Auditorias Agendadas{% endblock %}

{% block content %}
<div class="content-header">
    <h2 class="content-title">Auditorias Agendadas</h2>
    <p class="content-subtitle">Veja todas as auditorias agendadas no sistema.</p>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">Lista de Auditorias</h3>
    </div>
    <div class="card-body">
        {% if todas_auditorias %}
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Ferramenta</th>
                        <th>Descrição</th>
                    </tr>
                </thead>
                <tbody>
                    {% for auditoria in todas_auditorias %}
                    <tr>
                        <td>{{ auditoria.ferramenta }}</td>
                        <td>{{ auditoria.descricao }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-align:center; padding:2em;">
            <i class="fas fa-calendar-times" style="font-size: 2em; color: var(--text-muted);"></i>
            <p>Nenhuma auditoria agendada.</p>
        </div>
        {% endif %}
        <a href="{% url 'home' %}" class="btn btn-secondary" style="margin-top:20px;">
            <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
        </a>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\templates\registration\login.html

{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema de Auditorias</title>
    
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <style>
        .login-alert {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: var(--radius-md);
            border-left: 4px solid;
            animation: fadeIn 0.5s ease-out;
        }

        .login-alert.alert-warning {
            background-color: #fffbeb; /* Amarelo bem claro */
            border-color: #f59e0b; /* Amarelo/Laranja */
            color: #b45309; /* Texto Laranja Escuro */
        }

        .login-alert-icon {
            font-size: 20px;
            margin-top: 2px;
        }

        .login-alert-content {
            flex: 1;
        }

        .login-alert-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .login-alert-message {
            font-size: 14px;
            line-height: 1.5;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>
    <div class="bg-shape"></div>

    <!-- O BLOCO ANTIGO DE TOAST FOI REMOVIDO DAQUI -->

    <div class="login-container">
        <div class="welcome-section">
            <div class="welcome-header-content">
                <h1>Bem-vindo de volta</h1>
                <p>Sistema de Gestão de Auditorias</p>
            </div>

            <div class="mobile-illustration-container">
                <img src="{% static 'img/imagem2.png' %}" 
                    alt="Interface do Sistema de Auditorias" 
                    class="mobile-illustration">
            </div>

            <ul class="features-list">
                <li>Gestão completa de auditorias</li>
                <li>Relatórios avançados e analytics</li>
                <li>Suporte técnico especializado</li>
            </ul>
        </div>
        
        <div class="login-section">
            <div class="login-header">
                <h2>Auditorias</h2>
                <p>Faça o login para acessar a plataforma</p>
            </div>
            
            <!-- Bloco de mensagens correto, posicionado dentro do formulário -->
            {% if form.errors or request.GET.next %}
                <div class="login-alert alert-warning">
                    <div class="login-alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="login-alert-content">
                        {% if request.GET.next and not form.errors %}
                            <div class="login-alert-title">Sessão expirada</div>
                            <div class="login-alert-message">Sua sessão expirou por inatividade. Por favor, faça login novamente para continuar.</div>
                        {% elif form.non_field_errors %}
                            <div class="login-alert-title">Acesso Negado</div>
                            <div class="login-alert-message">{{ form.non_field_errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            
            <form method="post" class="login-form" id="loginForm" novalidate>
                {% csrf_token %}
                <div class="form-group">
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="username" 
                            name="username" 
                            required 
                            autocomplete="username"
                            value="{{ form.username.value|default:'' }}"
                        >
                        <label for="username">Nome de Usuário</label>
                    </div>
                    {% if form.username.errors %}
                        <div class="field-error">{{ form.username.errors.0 }}</div>
                    {% endif %}
                </div>

                <div class="form-group">
                    <div class="input-wrapper password-wrapper">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            required 
                            autocomplete="current-password"
                        >
                        <label for="password">Senha</label>
                        <button type="button" class="password-toggle" id="passwordToggle" aria-label="Mostrar/ocultar senha">
                            <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                    {% if form.password.errors %}
                        <div class="field-error">{{ form.password.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <button type="submit" class="login-btn" id="loginButton">
                    <div class="btn-content">
                        <span>Acessar Sistema</span>
                    </div>
                    <div class="btn-loader"></div>
                </button>
            </form>
        </div>
    </div>
    
    <script src="{% static 'js/login.js' %}"></script>
</body>
</html>
_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\admin.py

# usuarios/admin.py

from django.contrib import admin
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from .models import Usuario

# Crie uma classe inline para gerenciar o ManyToMany se for o caso


class FornecedorInline(admin.TabularInline):
    model = Usuario.fornecedores.through  # Usar o modelo intermediário para o M2M
    extra = 1


@admin.register(Usuario)
class UsuarioAdmin(BaseUserAdmin):
    # Adicione os campos personalizados aos fieldsets
    fieldsets = BaseUserAdmin.fieldsets + (
        ('Informações Adicionais', {'fields': ('registro',)}),
    )

    # Adicione a relação a Fornecedores no `filter_horizontal`
    filter_horizontal = BaseUserAdmin.filter_horizontal + ('fornecedores',)

    # Ajuste o list_display para incluir o novo campo
    list_display = (
        'username',
        'email',
        'first_name',
        'last_name',
        'registro',  # Adicione o campo de registro
        'is_staff',
    )

    search_fields = (
        'username',
        'email',
        'first_name',
        'last_name',
        'registro'
    )

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\apps.py

from django.apps import AppConfig


class UsuariosConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'usuarios'

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\models.py

# usuarios/models.py

from django.db import models
from django.contrib.auth.models import AbstractUser, Group
from fornecedores.models import Fornecedor  # Importe o modelo de Fornecedor


class Usuario(AbstractUser):
    # Campos personalizados
    registro = models.CharField(
        max_length=50,
        unique=True,
        null=True,
        blank=True,
        verbose_name="Nº de Registro"
    )

    # Relacionamento com Fornecedores
    fornecedores = models.ManyToManyField(
        Fornecedor,
        blank=True,
        verbose_name="Fornecedores com Acesso",
        related_name="usuarios_com_acesso"
    )

    # Acesso a permissões e grupos já é incluído com o AbstractUser

    class Meta:
        verbose_name = "Usuário"
        verbose_name_plural = "Usuários"


class DetalheGrupo(models.Model):
    group = models.OneToOneField(
        Group, on_delete=models.CASCADE, related_name='detalhe')
    descricao = models.CharField(max_length=255, blank=True, null=True)

    def __str__(self):
        return f"Detalhe de {self.group.name}"

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\serializers.py

# usuarios/serializers.py

from rest_framework import serializers
from .models import Usuario


class UsuarioSerializer(serializers.ModelSerializer):
    """
    Serializer para o modelo de Usuário.
    """
    class Meta:
        model = Usuario
        # Define os campos que serão expostos na API
        fields = ['id', 'username', 'email', 'first_name', 'last_name']
        # Garante que o username não possa ser alterado via API
        read_only_fields = ['username']


class AlterarSenhaSerializer(serializers.Serializer):
    """
    Serializer para o endpoint de alteração de senha.
    """
    old_password = serializers.CharField(required=True)
    new_password1 = serializers.CharField(required=True)
    new_password2 = serializers.CharField(required=True)

    def validate_old_password(self, value):
        user = self.context['request'].user
        if not user.check_password(value):
            raise serializers.ValidationError(
                "Sua senha antiga não foi digitada corretamente. Por favor, tente novamente.")
        return value

    def validate(self, data):
        if data['new_password1'] != data['new_password2']:
            raise serializers.ValidationError(
                {"new_password2": "As duas senhas não coincidem."})
        return data

    def save(self, **kwargs):
        password = self.validated_data['new_password1']
        user = self.context['request'].user
        user.set_password(password)
        user.save()
        return user

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\urls.py

# usuarios/urls.py

from django.urls import path
from . import views
from .views import CustomAuthToken

app_name = 'usuarios'

urlpatterns = [
    # Dashboard
    path('', views.dashboard_usuarios, name='dashboard'),

    # Usuários
    path('usuarios/', views.lista_usuarios, name='lista_usuarios'),
    path('usuarios/criar/', views.criar_usuario, name='criar_usuario'),
    path('usuarios/<int:pk>/editar/', views.editar_usuario, name='editar_usuario'),
    path('usuarios/<int:pk>/deletar/',
         views.deletar_usuario, name='deletar_usuario'),
    path('usuarios/<int:pk>/alterar-senha/',
         views.alterar_senha_usuario, name='alterar_senha_usuario'),

    # Grupos
    path('grupos/', views.lista_grupos, name='lista_grupos'),
    path('grupos/criar/', views.criar_grupo, name='criar_grupo'),
    path('grupos/<int:pk>/editar/', views.editar_grupo, name='editar_grupo'),
    path('grupos/<int:pk>/deletar/', views.deletar_grupo, name='deletar_grupo'),

    # AJAX
    path('ajax/verificar-username/',
         views.verificar_username, name='verificar_username'),
    path('ajax/verificar-email/', views.verificar_email, name='verificar_email'),
    path('ajax/toggle-status/<int:pk>/',
         views.toggle_usuario_status, name='toggle_usuario_status'),
    path('ajax/bulk-action/', views.bulk_action_usuarios,
         name='bulk_action_usuarios'),

    # Perfil do usuário
    path('meu-perfil/', views.meu_perfil, name='meu_perfil'),
    path('alterar-senha/', views.alterar_minha_senha, name='alterar_minha_senha'),

    path('exportar-csv/', views.exportar_usuarios_csv,
         name='exportar_usuarios_csv'),


]

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\views.py

# usuarios/views.py

from django.contrib.auth.models import Permission
from django.shortcuts import render, get_object_or_404, redirect
from django.contrib.auth.decorators import login_required, user_passes_test
from django.contrib.auth import update_session_auth_hash
from django.contrib.auth.models import Group, Permission
from django.contrib import messages
from django.core.paginator import Paginator
from django.db.models import Q
from django.http import JsonResponse
from django.views.decorators.http import require_http_methods
from django.contrib.auth.forms import PasswordChangeForm
from django.contrib.contenttypes.models import ContentType
import csv
from django.http import HttpResponse
import json

from django.contrib.auth.decorators import login_required, permission_required

from .models import Usuario, DetalheGrupo

from collections import defaultdict

from .serializers import UsuarioSerializer

from .models import Usuario

from .serializers import AlterarSenhaSerializer

from django.db.models import Count

from rest_framework import status
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework.authtoken.views import ObtainAuthToken
from rest_framework.authtoken.models import Token
from rest_framework.generics import RetrieveUpdateAPIView, UpdateAPIView

# Decorator para verificar se o usuário é administrador


def admin_required(user):
    return user.is_superuser or user.is_staff


# ============================================================================
# VIEWS PARA USUÁRIOS
# ============================================================================

@login_required
@permission_required('usuarios.view_usuario', raise_exception=True)
def dashboard_usuarios(request):
    """Dashboard principal do módulo de usuários."""
    context = {
        'total_usuarios': Usuario.objects.count(),
        'usuarios_ativos': Usuario.objects.filter(is_active=True).count(),
        'usuarios_staff': Usuario.objects.filter(is_staff=True).count(),
        'total_grupos': Group.objects.count(),
        'usuarios_recentes': Usuario.objects.order_by('-date_joined')[:5],
        'title': 'Dashboard de Usuários'
    }
    return render(request, 'usuarios/dashboard.html', context)


@login_required
# <--- TRAVA FORTE: SÓ SUPERUSUÁRIO
@user_passes_test(lambda u: u.is_superuser)
def alterar_senha_usuario(request, pk):
    """Altera a senha de um usuário específico (Apenas Superusuário)"""
    usuario = get_object_or_404(Usuario, pk=pk)

    if request.method == 'POST':
        password = request.POST.get('password')
        password_confirm = request.POST.get('password_confirm')

        if not password:
            messages.error(request, 'A senha é obrigatória!')
        elif password != password_confirm:
            messages.error(request, 'As senhas não coincidem!')
        elif len(password) < 8:
            messages.error(
                request, 'A senha deve ter pelo menos 8 caracteres!')
        else:
            try:
                usuario.set_password(password)
                usuario.save()
                messages.success(request, 'Senha alterada com sucesso!')
                return redirect('usuarios:lista_usuarios')
            except Exception as e:
                messages.error(request, f'Erro ao alterar senha: {str(e)}')

    context = {
        'usuario': usuario,
        'title': f'Alterar Senha - {usuario.get_full_name() or usuario.username}'
    }
    return render(request, 'usuarios/alterar_senha.html', context)


@login_required
@permission_required('usuarios.view_usuario', raise_exception=True)
def lista_usuarios(request):
    """Lista todos os usuários com busca e paginação"""
    search = request.GET.get('search', '')
    status = request.GET.get('status', '')
    grupo = request.GET.get('grupo', '')

    usuarios = Usuario.objects.all()

    if search:
        usuarios = usuarios.filter(
            Q(username__icontains=search) |
            Q(first_name__icontains=search) |
            Q(last_name__icontains=search) |
            Q(email__icontains=search)
        )

    if status == 'ativo':
        usuarios = usuarios.filter(is_active=True)
    elif status == 'inativo':
        usuarios = usuarios.filter(is_active=False)
    elif status == 'staff':
        usuarios = usuarios.filter(is_staff=True)

    if grupo:
        usuarios = usuarios.filter(groups__id=grupo)

    usuarios = usuarios.order_by('-date_joined')

    paginator = Paginator(usuarios, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'status': status,
        'grupo': grupo,
        'grupos': Group.objects.all(),
        'title': 'Usuários',
        'singular': 'Usuário',
        'button_text': 'Novo Usuário',
        'create_url': 'usuarios:criar_usuario',
        'artigo': 'o',
    }
    return render(request, 'usuarios/lista.html', context)


@login_required
@permission_required('usuarios.add_usuario', raise_exception=True)
def criar_usuario(request):
    """Cria um novo usuário"""
    if request.method == 'POST':
        username = request.POST.get('username')
        email = request.POST.get('email')
        first_name = request.POST.get('first_name')
        last_name = request.POST.get('last_name')
        password = request.POST.get('password')
        password_confirm = request.POST.get('password_confirm')
        is_active = request.POST.get('is_active') == 'on'
        is_staff = request.POST.get('is_staff') == 'on'
        is_superuser = request.POST.get('is_superuser') == 'on'
        # MUDANÇA 1: Pegamos apenas 'grupo' (singular)
        grupo_id = request.POST.get('grupo')

        # Validações
        if not username or not email or not password:
            messages.error(
                request, 'Username, email e senha são obrigatórios!')
        elif not grupo_id:  # <--- NOVA VALIDAÇÃO AQUI
            messages.error(
                request, 'É obrigatório selecionar um Perfil de Acesso (Grupo)!')
        elif password != password_confirm:
            messages.error(request, 'As senhas não coincidem!')
        elif Usuario.objects.filter(username=username).exists():
            messages.error(request, 'Este username já está em uso!')
        elif Usuario.objects.filter(email=email).exists():
            messages.error(request, 'Este email já está em uso!')
        else:
            try:
                # Criação do usuário (código igual ao seu)
                usuario = Usuario.objects.create_user(
                    username=username,
                    email=email,
                    password=password,
                    first_name=first_name,
                    last_name=last_name,
                    is_active=request.POST.get('is_active') == 'on',
                    is_staff=request.POST.get('is_staff') == 'on',
                    is_superuser=request.POST.get('is_superuser') == 'on'
                )

                # MUDANÇA 2: Lógica de atribuição de grupo único
                if grupo_id:
                    grupo = Group.objects.get(id=grupo_id)
                    usuario.groups.add(grupo)

                messages.success(request, 'Usuário criado com sucesso!')
                return redirect('usuarios:lista_usuarios')
            except Exception as e:
                messages.error(request, f'Erro ao criar usuário: {str(e)}')

    # GET: Mandamos os grupos para preencher o <select>
    context = {
        'grupos': Group.objects.all().order_by('name'),
        'title': 'Criar Usuário'
    }
    # Ajuste o nome do template se necessário
    return render(request, 'usuarios/form_usuario.html', context)


@login_required
@permission_required('usuarios.change_usuario', raise_exception=True)
def editar_usuario(request, pk):
    """Edita um usuário existente"""
    usuario = get_object_or_404(Usuario, pk=pk)

    if request.method == 'POST':
        usuario.username = request.POST.get('username')
        usuario.email = request.POST.get('email')
        usuario.first_name = request.POST.get('first_name')
        usuario.last_name = request.POST.get('last_name')
        usuario.is_active = request.POST.get('is_active') == 'on'
        usuario.is_staff = request.POST.get('is_staff') == 'on'
        usuario.is_superuser = request.POST.get('is_superuser') == 'on'
        grupo_id = request.POST.get('grupo')  # MUDANÇA 1

        if not grupo_id:  # <--- NOVA VALIDAÇÃO AQUI
            messages.error(
                request, 'É obrigatório selecionar um Perfil de Acesso (Grupo)!')
        # Validar username único (exceto o próprio usuário)
        elif Usuario.objects.filter(username=usuario.username).exclude(pk=pk).exists():
            messages.error(request, 'Este username já está em uso!')
        # Validar email único (exceto o próprio usuário)
        elif Usuario.objects.filter(email=usuario.email).exclude(pk=pk).exists():
            messages.error(request, 'Este email já está em uso!')
        else:
            try:
                usuario.username = request.POST.get('username')
                usuario.save()

                # MUDANÇA 2: Atualizar o grupo
                if grupo_id:
                    novo_grupo = Group.objects.get(id=grupo_id)
                    usuario.groups.clear()
                    usuario.groups.add(novo_grupo)
                else:
                    usuario.groups.clear()  # Se não selecionou nada, remove permissões

                messages.success(request, 'Usuário atualizado com sucesso!')
                return redirect('usuarios:lista_usuarios')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar usuário: {str(e)}')

    # MUDANÇA 3: Descobrir qual o grupo atual para marcar no HTML
    grupo_atual = usuario.groups.first()  # Pega o primeiro grupo encontrado

    context = {
        'usuario': usuario,
        'grupos': Group.objects.all().order_by('name'),
        # Envia o ID para o template
        'grupo_atual_id': grupo_atual.id if grupo_atual else None,
        'title': 'Editar Usuário'
    }
    return render(request, 'usuarios/form_usuario.html', context)


@login_required
@user_passes_test(admin_required)
def deletar_usuario(request, pk):
    """Deleta um usuário"""
    usuario = get_object_or_404(Usuario, pk=pk)

    # Não permitir deletar o próprio usuário
    if usuario == request.user:
        messages.error(request, 'Você não pode deletar sua própria conta!')
        return redirect('usuarios:lista_usuarios')

    if request.method == 'POST':
        try:
            usuario.delete()
            messages.success(request, 'Usuário deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar usuário: {str(e)}')
        return redirect('usuarios:lista_usuarios')

    context = {
        'usuario': usuario,
        'title': 'Deletar Usuário'
    }
    return render(request, 'usuarios/deletar.html', context)


# ============================================================================
# VIEWS PARA GRUPOS E PERMISSÕES
# ============================================================================
# Função auxiliar para organizar as permissões (Evita repetir código)
# Em usuarios/views.py

def get_permissions_dict():
    """
    Organiza as permissões em uma estrutura de matriz:
    Módulo -> Model -> {add, change, delete, view}
    """
    ignorar_models = ['session', 'content type',
                      'log entry', 'permission', 'group']

    # Busca todas as permissões relevantes
    perms = Permission.objects.exclude(content_type__model__in=ignorar_models)\
        .select_related('content_type')\
        .order_by('content_type__app_label', 'content_type__model')

    estrutura = {}

    for p in perms:
        # Nome do App (Ex: Auditorias, Usuários)
        app_label = p.content_type.app_label
        # Nome do Model (Ex: Auditoria, Agendamento)
        model_name = p.content_type.model
        # Nome Bonito para exibir (Ex: "Agendamento de Auditoria")
        nome_exibicao = p.content_type.name.title()

        # Cria a chave do App se não existir
        # Mapeamento para nomes mais bonitos se quiser
        app_nome = app_label.title()
        if app_label == 'auth':
            app_nome = 'Administração'
        if app_label == 'usuarios':
            app_nome = 'Gestão de Acesso'

        if app_nome not in estrutura:
            estrutura[app_nome] = {}

        # Cria a chave do Model dentro do App
        if model_name not in estrutura[app_nome]:
            estrutura[app_nome][model_name] = {
                'nome': nome_exibicao,
                'acoes': {}
            }

        # Identifica a ação baseada no codename (add_user, change_user...)
        codename = p.codename
        if codename.startswith('add_'):
            estrutura[app_nome][model_name]['acoes']['add'] = p
        elif codename.startswith('change_'):
            estrutura[app_nome][model_name]['acoes']['change'] = p
        elif codename.startswith('delete_'):
            estrutura[app_nome][model_name]['acoes']['delete'] = p
        elif codename.startswith('view_'):
            estrutura[app_nome][model_name]['acoes']['view'] = p

    return estrutura


@login_required
@permission_required('auth.view_group', raise_exception=True)
def lista_grupos(request):
    search = request.GET.get('search', '')

    # Adicionamos .select_related('detalhe') para carregar a descrição junto e ficar rápido
    grupos = Group.objects.all().annotate(
        total_usuarios=Count('user')
    ).select_related('detalhe').order_by('name')

    if search:
        grupos = grupos.filter(name__icontains=search)

    paginator = Paginator(grupos, 10)
    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)

    context = {
        'page_obj': page_obj,
        'search': search,
        'title': 'Perfis de Acesso'
    }
    return render(request, 'usuarios/grupos/lista.html', context)


@login_required
@permission_required('auth.add_group', raise_exception=True)
def criar_grupo(request):
    if request.method == 'POST':
        name = request.POST.get('name')
        descricao = request.POST.get('descricao')  # Pegamos a descrição
        permissoes_ids = request.POST.getlist('permissoes')

        if not name:
            messages.error(request, 'O nome do perfil é obrigatório.')
        else:
            try:
                grupo = Group.objects.create(name=name)

                # SALVAR DESCRIÇÃO: Criamos o detalhe vinculado ao grupo
                if descricao:
                    DetalheGrupo.objects.create(
                        group=grupo, descricao=descricao)

                if permissoes_ids:
                    perms = Permission.objects.filter(id__in=permissoes_ids)
                    grupo.permissions.set(perms)

                messages.success(request, 'Perfil criado com sucesso!')
                return redirect('usuarios:lista_grupos')
            except Exception as e:
                messages.error(request, f'Erro ao criar perfil: {e}')

    context = {
        'perms_agrupadas': agrupar_permissoes_para_template(),
        'title': 'Novo Perfil de Acesso'
    }
    return render(request, 'usuarios/grupos/form.html', context)


@login_required
@permission_required('auth.change_group', raise_exception=True)
def editar_grupo(request, pk):
    grupo = get_object_or_404(Group, pk=pk)

    if request.method == 'POST':
        name = request.POST.get('name')
        descricao = request.POST.get('descricao')  # Pegamos a descrição
        permissoes_ids = request.POST.getlist('permissoes')

        if not name:
            messages.error(request, 'O nome do perfil é obrigatório.')
        else:
            try:
                grupo.name = name
                grupo.save()

                # SALVAR DESCRIÇÃO: Usamos update_or_create para criar se não existir ou atualizar se existir
                DetalheGrupo.objects.update_or_create(
                    group=grupo,
                    defaults={'descricao': descricao}
                )

                if permissoes_ids:
                    perms = Permission.objects.filter(id__in=permissoes_ids)
                    grupo.permissions.set(perms)
                else:
                    grupo.permissions.clear()

                messages.success(request, 'Perfil atualizado com sucesso!')
                return redirect('usuarios:lista_grupos')
            except Exception as e:
                messages.error(request, f'Erro ao atualizar perfil: {e}')

    grupo_perms_ids = list(grupo.permissions.values_list('id', flat=True))

    context = {
        'grupo': grupo,
        'perms_agrupadas': agrupar_permissoes_para_template(),
        'grupo_perms_ids': grupo_perms_ids,
        'title': 'Editar Perfil de Acesso'
    }
    return render(request, 'usuarios/grupos/form.html', context)


def agrupar_permissoes_para_template():
    """
    Cria uma estrutura de dados aninhada e organizada para exibir as
    permissões no template, com overrides manuais para organização visual.
    """

    # 1. MAPEAMENTO DE NOMES AMIGÁVEIS (MODELO -> TELA)
    nomes_funcionalidades = {
        'pilar': 'Pilares',
        'categoriaauditoria': 'Categorias de Auditoria',
        'norma': 'Normas',
        'ferramentadigital': 'Ferramentas Digitais',
        'checklist': 'Checklists',
        'modeloauditoria': 'Modelos de Auditoria',
        'auditoria': 'Agendamentos',
        'auditoriainstancia': 'Execuções de Auditoria',
        'planodeacao': 'Planos de Ação',
        'naoconformidade': 'Não Conformidades',  # Movido para cá
        'usuario': 'Usuários',
        'group': 'Perfis de Acesso (Grupos)',
        'detalhegrupo': 'Detalhes do Grupo',
        'cliente': 'Clientes',
        'fornecedor': 'Fornecedores',
        'ativo': 'Ativos',
        'categoria': 'Categorias',
        'marca': 'Marcas',
        'modelo': 'Modelos',
        'item': 'Itens',
        'almoxarifado': 'Almoxarifados',
        'empresa': 'Unidades de Negócio',
        'area': 'Áreas',
        'setor': 'Setores',
        'subsetor': 'Subsetores',
        # Cadastros Base
        'turno': 'Turnos',
        'turnodetalhedia': 'Detalhes de Turno',
        'unidademedida': 'Unidades de Medida',
        'categoriaitem': 'Categorias',
        'subcategoriaitem': 'Subcategorias',
    }

    # 2. MAPEAMENTO DE NOMES DE MÓDULOS (APP -> TÍTULO DO ACCORDION)
    nomes_modulos = {
        'auditorias': 'Gestão de Auditorias',
        'usuarios': 'Gestão de Usuários',
        'organizacao': 'Estrutura Organizacional',
        'ativos': 'Gestão de Ativos',
        'itens': 'Estoque & Itens',
        'clientes': 'Gestão de Clientes',  # Se o app for 'clientes'
        'fornecedores': 'Gestão de Fornecedores',
        'cadastros_base': 'Cadastros Gerais',
        # Criamos uma chave "virtual" para o módulo novo
        'modulo_planos': 'Gestão de Planos de Ação',
        'auth': 'Grupos & Permissões',
    }

    # 3. LISTA NEGRA: O QUE NÃO DEVE APARECER NA TELA
    ignorar_apps = [
        'admin', 'authtoken', 'contenttypes', 'sessions',
        'easy_thumbnails', 'guardian', 'cadastros_base',  # Outros apps técnicos comuns
    ]

    # Adicione aqui os modelos estranhos que você quer esconder
    ignorar_modelos = [
        'log entry', 'permission', 'content type', 'session', 'admin log',
        'token', 'token proxy',
        # Modelos técnicos do plano de ação que você não quer ver:
        'forum', 'mensagemforum', 'responsavellocal', 'anexoresposta',
        'evidenciaplano', 'ferramentacausaraiz',
    ]

    # Busca as permissões no banco
    permissions = Permission.objects.select_related('content_type')\
        .exclude(content_type__app_label__in=ignorar_apps)\
        .exclude(content_type__model__in=ignorar_modelos)\
        .order_by('content_type__model')

    # Agrupa permissões por modelo
    perms_por_modelo = defaultdict(list)
    for perm in permissions:
        perms_por_modelo[perm.content_type.model].append(perm)

    # Estrutura final
    modulos = defaultdict(list)

    # 4. ORGANIZAÇÃO E LÓGICA DE OVERRIDE (AQUI ACONTECE A MÁGICA)
    for model_codename, perms in perms_por_modelo.items():
        if not perms:
            continue

        app_label = perms[0].content_type.app_label

        # --- LÓGICA DE OVERRIDE (MUDAR DE LUGAR) ---

        # Se for Plano de Ação ou Não Conformidade, forçamos ir para o módulo 'modulo_planos'
        if model_codename in ['planodeacao', 'naoconformidade']:
            chave_modulo = 'modulo_planos'
        else:
            chave_modulo = app_label

        # Pega o nome bonito do módulo ou usa o nome do app formatado
        modulo_nome = nomes_modulos.get(
            chave_modulo, chave_modulo.replace('_', ' ').title())

        # Pega o nome bonito da funcionalidade ou usa o nome do model formatado
        funcionalidade_nome = nomes_funcionalidades.get(
            model_codename, model_codename.replace('_', ' ').title())

        # Mapeia as ações
        acoes = {
            'add': next((p for p in perms if p.codename.startswith('add_')), None),
            'view': next((p for p in perms if p.codename.startswith('view_')), None),
            'change': next((p for p in perms if p.codename.startswith('change_')), None),
            'delete': next((p for p in perms if p.codename.startswith('delete_')), None),
        }

        # Só adiciona se tiver pelo menos uma ação válida
        if any(acoes.values()):
            modulos[modulo_nome].append({
                'nome': funcionalidade_nome,
                'acoes': acoes
            })

    # Ordena os módulos e as funcionalidades dentro deles
    modulos_ordenados = {
        k: sorted(v, key=lambda x: x['nome']) for k, v in sorted(modulos.items())
    }

    return modulos_ordenados


@login_required
@user_passes_test(admin_required)
def deletar_grupo(request, pk):
    """Deleta um grupo"""
    grupo = get_object_or_404(Group, pk=pk)

    if request.method == 'POST':
        try:
            grupo.delete()
            messages.success(request, 'Grupo deletado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao deletar grupo: {str(e)}')
        return redirect('usuarios:lista_grupos')

    context = {
        'grupo': grupo,
        'title': 'Deletar Grupo'
    }
    return render(request, 'usuarios/grupos/deletar.html', context)


# ============================================================================
# VIEWS AJAX E UTILITÁRIAS
# ============================================================================
@login_required
@user_passes_test(admin_required)
def exportar_usuarios_csv(request):
    """Exporta a lista de usuários filtrada para um arquivo CSV."""
    response = HttpResponse(
        content_type='text/csv; charset=utf-8-sig',
        headers={'Content-Disposition': 'attachment; filename="usuarios.csv"'}
    )

    # Reaplica a mesma lógica de filtro da view de listagem
    search = request.GET.get('search', '')
    status = request.GET.get('status', '')
    grupo = request.GET.get('grupo', '')

    usuarios = Usuario.objects.prefetch_related('groups').all()

    if search:
        usuarios = usuarios.filter(
            Q(username__icontains=search) |
            Q(first_name__icontains=search) |
            Q(last_name__icontains=search) |
            Q(email__icontains=search)
        )

    if status == 'ativo':
        usuarios = usuarios.filter(is_active=True)
    elif status == 'inativo':
        usuarios = usuarios.filter(is_active=False)
    elif status == 'staff':
        usuarios = usuarios.filter(is_staff=True)

    if grupo:
        usuarios = usuarios.filter(groups__id=grupo)

    usuarios = usuarios.order_by('username')

    # Cria o escritor CSV
    writer = csv.writer(response)

    # Escreve o cabeçalho
    writer.writerow([
        'ID',
        'Username',
        'Nome',
        'Sobrenome',
        'Email',
        'Ativo',
        'Staff',
        'Superusuário',
        'Grupos',
        'Data de Cadastro'
    ])

    # Escreve os dados de cada usuário no arquivo
    for usuario in usuarios:
        grupos_str = ', '.join([g.name for g in usuario.groups.all()])

        writer.writerow([
            usuario.id,
            usuario.username,
            usuario.first_name,
            usuario.last_name,
            usuario.email,
            'Sim' if usuario.is_active else 'Não',
            'Sim' if usuario.is_staff else 'Não',
            'Sim' if usuario.is_superuser else 'Não',
            grupos_str,
            usuario.date_joined.strftime('%d/%m/%Y %H:%M')
        ])

    return response


@require_http_methods(["GET"])
def verificar_username(request):
    """Verifica se um username está disponível"""
    username = request.GET.get('username')
    user_id = request.GET.get('user_id')

    if not username:
        return JsonResponse({'available': False, 'message': 'Username é obrigatório'})

    query = Usuario.objects.filter(username=username)
    if user_id:
        query = query.exclude(pk=user_id)

    if query.exists():
        return JsonResponse({'available': False, 'message': 'Este username já está em uso'})

    return JsonResponse({'available': True, 'message': 'Username disponível'})


@require_http_methods(["GET"])
def verificar_email(request):
    """Verifica se um email está disponível"""
    email = request.GET.get('email')
    user_id = request.GET.get('user_id')

    if not email:
        return JsonResponse({'available': False, 'message': 'Email é obrigatório'})

    query = Usuario.objects.filter(email=email)
    if user_id:
        query = query.exclude(pk=user_id)

    if query.exists():
        return JsonResponse({'available': False, 'message': 'Este email já está em uso'})

    return JsonResponse({'available': True, 'message': 'Email disponível'})


@require_http_methods(["POST"])
def toggle_usuario_status(request, pk):
    """Alterna o status ativo/inativo de um usuário"""
    usuario = get_object_or_404(Usuario, pk=pk)

    if usuario == request.user:
        return JsonResponse({'success': False, 'message': 'Você não pode desativar sua própria conta'})

    try:
        usuario.is_active = not usuario.is_active
        usuario.save()

        status_text = 'ativado' if usuario.is_active else 'desativado'
        return JsonResponse({
            'success': True,
            'message': f'Usuário {status_text} com sucesso',
            'new_status': usuario.is_active
        })
    except Exception as e:
        return JsonResponse({'success': False, 'message': str(e)})


@require_http_methods(["POST"])
def bulk_action_usuarios(request):
    """Executa ações em lote nos usuários"""
    action = request.POST.get('action')
    user_ids = request.POST.getlist('user_ids')

    if not action or not user_ids:
        return JsonResponse({'success': False, 'message': 'Ação ou usuários não especificados'})

    try:
        usuarios = Usuario.objects.filter(
            id__in=user_ids).exclude(pk=request.user.pk)
        count = usuarios.count()

        if action == 'activate':
            usuarios.update(is_active=True)
            message = f'{count} usuário(s) ativado(s) com sucesso'
        elif action == 'deactivate':
            usuarios.update(is_active=False)
            message = f'{count} usuário(s) desativado(s) com sucesso'
        elif action == 'delete':
            usuarios.delete()
            message = f'{count} usuário(s) excluído(s) com sucesso'
        else:
            return JsonResponse({'success': False, 'message': 'Ação inválida'})

        return JsonResponse({'success': True, 'message': message})
    except Exception as e:
        return JsonResponse({'success': False, 'message': str(e)})

# ============================================================================
# VIEWS PARA PERFIL DO USUÁRIO
# ============================================================================


@login_required
def meu_perfil(request):
    """Exibe e edita o perfil do usuário logado"""
    if request.method == 'POST':
        request.user.first_name = request.POST.get('first_name', '')
        request.user.last_name = request.POST.get('last_name', '')
        request.user.email = request.POST.get('email', '')

        try:
            request.user.save()
            messages.success(request, 'Perfil atualizado com sucesso!')
        except Exception as e:
            messages.error(request, f'Erro ao atualizar perfil: {str(e)}')

    context = {
        'title': 'Meu Perfil'
    }
    return render(request, 'usuarios/perfil.html', context)


@login_required
def alterar_minha_senha(request):
    """Permite ao usuário alterar sua própria senha"""
    if request.method == 'POST':
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(request, user)
            messages.success(request, 'Senha alterada com sucesso!')
            return redirect('usuarios:meu_perfil')
        else:
            for error in form.errors.values():
                messages.error(request, error[0])
    else:
        form = PasswordChangeForm(request.user)

    context = {
        'form': form,
        'title': 'Alterar Senha'
    }
    return render(request, 'usuarios/alterar_minha_senha.html', context)


class CustomAuthToken(ObtainAuthToken):
    """
    View de login personalizada para retornar mais dados além do token.
    """

    def post(self, request, *args, **kwargs):
        serializer = self.serializer_class(data=request.data,
                                           context={'request': request})
        serializer.is_valid(raise_exception=True)
        user = serializer.validated_data['user']
        token, created = Token.objects.get_or_create(user=user)

        # Serializa os dados do usuário para incluir na resposta
        user_serializer = UsuarioSerializer(user)

        return Response({
            'token': token.key,
            'user': user_serializer.data
        })


class MeuPerfilAPIView(RetrieveUpdateAPIView):
    """
    Endpoint da API para ver e editar o perfil do usuário logado.
    Permite requisições GET (buscar) e PUT/PATCH (atualizar).
    """
    serializer_class = UsuarioSerializer
    permission_classes = [IsAuthenticated]

    def get_object(self):
        """
        Retorna o objeto do próprio usuário que está fazendo a requisição.
        """
        return self.request.user


class AlterarMinhaSenhaAPIView(UpdateAPIView):
    """
    Endpoint para o usuário alterar a própria senha.
    """
    serializer_class = AlterarSenhaSerializer
    permission_classes = [IsAuthenticated]

    def get_object(self):
        return self.request.user

    def update(self, request, *args, **kwargs):
        usuario = self.get_object()
        serializer = self.get_serializer(data=request.data)

        if serializer.is_valid():
            serializer.save()
            return Response({"detail": "Senha alterada com sucesso!"}, status=status.HTTP_200_OK)

        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\templates\usuarios\alterar_senha.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-group">
    <div style="background: rgba(37, 99, 235, 0.1); padding: 16px; border-radius: var(--radius-md); margin-bottom: 24px; border-left: 4px solid var(--primary);">
        <p style="margin: 0; color: var(--text-primary);">
            <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
            Alterando senha para: <strong>{{ usuario.get_full_name|default:usuario.username }}</strong>
        </p>
    </div>
</div>

<div class="form-row">
    <div class="form-group required">
        <label for="password" class="form-label">Nova Senha</label>
        <input type="password" 
               id="password" 
               name="password" 
               class="form-control" 
               required 
               minlength="8"
               placeholder="Digite a nova senha">
        <div class="field-help">Mínimo de 8 caracteres</div>
    </div>
    
    <div class="form-group required">
        <label for="password_confirm" class="form-label">Confirmar Nova Senha</label>
        <input type="password" 
               id="password_confirm" 
               name="password_confirm" 
               class="form-control" 
               required 
               minlength="8"
               placeholder="Confirme a nova senha">
        <div class="field-help">Digite a senha novamente</div>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\templates\usuarios\dashboard.html

{% extends 'auditorias/base.html' %}

{% block title %}Dashboard Usuários - Sistema de Auditorias{% endblock %}
{% block page_title %}Gestão de Usuários{% endblock %}

{% block content %}
<div class="content-header">
    <h2 class="content-title">Dashboard de Usuários</h2>
    <p class="content-subtitle">Gerencie usuários, permissões e grupos do sistema</p>
</div>

<!-- Cards de Estatísticas -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 32px;">
    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--primary); margin-bottom: 8px;">
                        {{ total_usuarios }}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Total de Usuários</p>
                </div>
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--success); margin-bottom: 8px;">
                        {{ usuarios_ativos }}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Usuários Ativos</p>
                </div>
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--success) 0%, #059669 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-user-check"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--warning); margin-bottom: 8px;">
                        {{ usuarios_staff }}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Administradores</p>
                </div>
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-user-shield"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body" style="padding: 24px;">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h3 style="font-size: 32px; font-weight: 700; color: var(--error); margin-bottom: 8px;">
                        {{ total_grupos }}
                    </h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Grupos de Permissão</p>
                </div>
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                    <i class="fas fa-users-cog"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ações Rápidas -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
    <!-- Usuários Recentes -->
    <div class="card">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 class="card-title">Usuários Recentes</h3>
                    <p class="card-subtitle">Últimos usuários cadastrados no sistema</p>
                </div>
                <a href="{% url 'usuarios:lista_usuarios' %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-eye"></i>
                    Ver Todos
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if usuarios_recentes %}
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Usuário</th>
                                <th>Email</th>
                                <th>Data Cadastro</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usuario in usuarios_recentes %}
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div class="user-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                                            {{ usuario.first_name.0|default:usuario.username.0|upper }}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-primary);">
                                                {{ usuario.get_full_name|default:usuario.username }}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-muted);">
                                                @{{ usuario.username }}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ usuario.email|default:"—" }}</td>
                                <td>{{ usuario.date_joined|date:"d/m/Y" }}</td>
                                <td>
                                    {% if usuario.is_active %}
                                        <span class="badge badge-success">Ativo</span>
                                    {% else %}
                                        <span class="badge badge-error">Inativo</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="text-align: center; padding: 48px 24px; color: var(--text-muted);">
                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <h4 style="margin-bottom: 8px;">Nenhum usuário encontrado</h4>
                    <p>Crie o primeiro usuário para começar</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Ações Rápidas -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Ações Rápidas</h3>
            <p class="card-subtitle">Acesso rápido às principais funcionalidades</p>
        </div>
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <a href="{% url 'usuarios:criar_usuario' %}" class="btn btn-primary" style="justify-content: flex-start;">
                    <i class="fas fa-user-plus"></i>
                    Novo Usuário
                </a>
                
                <a href="{% url 'usuarios:criar_grupo' %}" class="btn btn-secondary" style="justify-content: flex-start;">
                    <i class="fas fa-users-cog"></i>
                    Novo Grupo
                </a>
                
                <a href="{% url 'usuarios:lista_grupos' %}" class="btn btn-secondary" style="justify-content: flex-start;">
                    <i class="fas fa-list"></i>
                    Ver Grupos
                </a>
                
                <hr style="border: none; border-top: 1px solid var(--border); margin: 8px 0;">
                
                <a href="{% url 'usuarios:meu_perfil' %}" class="btn btn-secondary" style="justify-content: flex-start;">
                    <i class="fas fa-user-edit"></i>
                    Meu Perfil
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\templates\usuarios\form.html

{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<!-- Informações Básicas -->
<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-user"></i>
        Informações Básicas
    </h4>
    
    <div class="form-row">
        <div class="form-group required">
            <label for="username" class="form-label">Username</label>
            <input type="text" 
                   id="username" 
                   name="username" 
                   class="form-control" 
                   value="{{ usuario.username|default:'' }}" 
                   required 
                   maxlength="150"
                   placeholder="Digite o username">
            <div class="field-help">Username único para login no sistema</div>
        </div>
        
        <div class="form-group required">
            <label for="email" class="form-label">Email</label>
            <input type="email" 
                   id="email" 
                   name="email" 
                   class="form-control" 
                   value="{{ usuario.email|default:'' }}" 
                   required 
                   placeholder="Digite o email">
            <div class="field-help">Email único para comunicações</div>
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="first_name" class="form-label">Nome</label>
            <input type="text" 
                   id="first_name" 
                   name="first_name" 
                   class="form-control" 
                   value="{{ usuario.first_name|default:'' }}" 
                   maxlength="150"
                   placeholder="Digite o primeiro nome">
        </div>
        
        <div class="form-group">
            <label for="last_name" class="form-label">Sobrenome</label>
            <input type="text" 
                   id="last_name" 
                   name="last_name" 
                   class="form-control" 
                   value="{{ usuario.last_name|default:'' }}" 
                   maxlength="150"
                   placeholder="Digite o sobrenome">
        </div>
    </div>
</div>

<!-- Senha (apenas para criação) -->
{% if not usuario %}
<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-lock"></i>
        Senha
    </h4>
    
    <div class="form-row">
        <div class="form-group required">
            <label for="password" class="form-label">Senha</label>
            <input type="password" 
                   id="password" 
                   name="password" 
                   class="form-control" 
                   required 
                   minlength="8"
                   placeholder="Digite a senha">
            <div class="field-help">Mínimo de 8 caracteres</div>
        </div>
        
        <div class="form-group required">
            <label for="password_confirm" class="form-label">Confirmar Senha</label>
            <input type="password" 
                   id="password_confirm" 
                   name="password_confirm" 
                   class="form-control" 
                   required 
                   minlength="8"
                   placeholder="Confirme a senha">
            <div class="field-help">Digite a senha novamente</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Permissões -->
<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-shield-alt"></i>
        Permissões
    </h4>
    
    <div class="form-row triple">
        <div class="form-group">
            <label class="form-label">Status Ativo</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                    <input type="checkbox" 
                           name="is_active" 
                           {% if usuario.is_active|default:True %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span style="color: var(--text-secondary); font-size: 14px;">
                    Usuário pode fazer login
                </span>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Staff</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                    <input type="checkbox" 
                           name="is_staff" 
                           {% if usuario.is_staff %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span style="color: var(--text-secondary); font-size: 14px;">
                    Acesso ao admin
                </span>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Superusuário</label>
            <div style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                    <input type="checkbox" 
                           name="is_superuser" 
                           {% if usuario.is_superuser %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>
                <span style="color: var(--text-secondary); font-size: 14px;">
                    Todas as permissões
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Grupos -->
<div style="margin-bottom: 32px;">
    <h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
        <i class="fas fa-users"></i>
        Grupos
    </h4>
    
    <div class="form-group">
        <label class="form-label">Grupos do Usuário</label>
        <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px;">
            {% if grupos %}
                {% for grupo in grupos %}
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <input type="checkbox" 
                           name="grupos" 
                           value="{{ grupo.id }}" 
                           id="grupo_{{ grupo.id }}"
                           {% if usuario and grupo in usuario.groups.all %}checked{% endif %}>
                    <label for="grupo_{{ grupo.id }}" style="margin: 0; cursor: pointer; flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">{{ grupo.name }}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            {{ grupo.permissions.count }} permissão{{ grupo.permissions.count|pluralize:"ões" }}
                        </div>
                    </label>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; color: var(--text-muted); padding: 24px;">
                    <i class="fas fa-users" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                    <p>Nenhum grupo disponível</p>
                </div>
            {% endif %}
        </div>
        <div class="field-help">Selecione os grupos aos quais o usuário pertence</div>
    </div>
</div>
{% endblock %}

_____________________________________

C:\Users\SV1830\Downloads\Gestao-auditorias-django\usuarios\templates\usuarios\lista.html

{% extends 'auditorias/lista_generica.html' %}

{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        
        <div>
            <h2 class="content-title">Gerenciamento de Usuários</h2>
            <p class="content-subtitle">Gerencie usuários, permissões e grupos do sistema</p>
        </div>

        <div style="display: flex; gap: 10px;">
            
            {% if perms.auth.view_group %}
            <a href="{% url 'usuarios:lista_grupos' %}" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-users-cog" style="color: #4e73df;"></i>
                Gerenciar Grupos
            </a>
            {% endif %}

            {% if perms.usuarios.add_usuario %}
            <a href="{% url 'usuarios:criar_usuario' %}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                Novo Usuário
            </a>
            {% endif %}
            
        </div>
    </div>
</div>
{% endblock %}

{% block table_headers %}
    <th>Usuário</th>
    <th>Email</th>
    <th>Grupos</th>
    <th>Status</th>
    <th>Último Login</th>
    <th style="width: 140px;">Ações</th>
{% endblock %}

{% block table_row %}
    <td>
        <div style="display: flex; align-items: center; gap: 12px;">
            <div class="user-avatar" style="width: 40px; height: 40px; font-size: 14px;">
                {{ object.first_name.0|default:object.username.0|upper }}
            </div>
            <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">
                    {{ object.get_full_name|default:object.username }}
                    {% if object.is_superuser %}
                        <span class="badge badge-error" style="font-size: 10px; margin-left: 8px;">SUPER</span>
                    {% elif object.is_staff %}
                        <span class="badge badge-warning" style="font-size: 10px; margin-left: 8px;">STAFF</span>
                    {% endif %}
                </div>
                <div style="font-size: 12px; color: var(--text-muted);">
                    @{{ object.username }}
                </div>
            </div>
        </div>
    </td>
    <td>
        <div style="color: var(--text-secondary);">
            {{ object.email|default:"—" }}
        </div>
    </td>
    <td>
        {% if object.groups.all %}
            <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                {% for grupo in object.groups.all %}
                <span class="badge badge-info" style="font-size: 10px;">
                    {{ grupo.name }}
                </span>
                {% endfor %}
            </div>
        {% else %}
            <span style="color: var(--text-muted); font-size: 12px;">Nenhum grupo</span>
        {% endif %}
    </td>
    <td>
        <div style="display: flex; align-items: center; gap: 8px;">
            {% if object.is_active %}
                <span class="badge badge-success">
                    <i class="fas fa-check-circle"></i>
                    Ativo
                </span>
            {% else %}
                <span class="badge badge-error">
                    <i class="fas fa-times-circle"></i>
                    Inativo
                </span>
            {% endif %}
        </div>
    </td>
    <td>
        {% if object.last_login %}
            <div style="color: var(--text-secondary); font-size: 14px;">
                {{ object.last_login|date:"d/m/Y" }}
            </div>
            <div style="font-size: 12px; color: var(--text-muted);">
                {{ object.last_login|date:"H:i" }}
            </div>
        {% else %}
            <span style="color: var(--text-muted); font-size: 12px;">Nunca</span>
        {% endif %}
    </td>
    <td>
        <div class="action-buttons">
            {% if perms.usuarios.change_usuario %}
            <a href="{% url 'usuarios:editar_usuario' object.pk %}" 
               class="btn btn-secondary btn-icon" 
               title="Editar usuário">
                <i class="fas fa-edit"></i>
            </a>
            {% endif %}

            {% if request.user.is_superuser %}
            <a href="{% url 'usuarios:alterar_senha_usuario' object.pk %}" 
               class="btn btn-warning btn-icon" 
               title="Alterar senha">
                <i class="fas fa-key"></i>
            </a>
            {% endif %}

            {% if perms.usuarios.delete_usuario %}
            {% if object != request.user %}
            <button type="button" 
                    class="btn btn-danger btn-icon" 
                    title="Deletar usuário"
                    onclick="confirmDelete('{% url 'usuarios:deletar_usuario' object.pk %}', '{{ object.get_full_name|default:object.username }}')">
                <i class="fas fa-trash"></i>
            </button>
            {% endif %}
            {% endif %}
        </div>
    </td>
{% endblock %}

_____________________________________

