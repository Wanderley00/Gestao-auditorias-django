{% extends 'auditorias/lista_generica.html' %}
{% load static %}
{% load auditoria_extras %} 

{% block title %}{{ title }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{# --- SUBSTITUI O CABEÇALHO PADRÃO --- #}
{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle" style="font-size: 13px; color: #64748b; margin-top: 5px;">
                {% if current_mode == 'finished' %}
                    Histórico de ações concluídas, recusadas ou arquivadas.
                {% else %}
                    Acompanhe e gerencie as ações em andamento.
                {% endif %}
            </p>
        </div>
        
        <div style="display: flex; gap: 10px;">
            
            <a href="{% url 'auditorias:dashboard_planos' %}" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-chart-pie" style="color: #7c3aed;"></i> Dashboard
            </a>

            {% if current_mode == 'active' %}
                <a href="?mode=finished" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                    <i class="fas fa-check-double" style="color: #16a34a;"></i> Ver Ações Finalizadas
                </a>
            {% else %}
                <a href="?mode=active" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                    <i class="fas fa-list-ul" style="color: #0066cc;"></i> Ver Ações Em Andamento
                </a>
            {% endif %}

            {% if perms.auditorias.add_planodeacao %}
            {% if current_mode == 'active' %}
                <a href="#" class="btn btn-primary" onclick="openModalNovoPlano()">
                    <i class="fas fa-plus"></i> Novo Plano
                </a>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{# --- BLOCO DE ESTILOS E FILTROS (Consolidado para garantir funcionamento) --- #}
{% block search_form %}
<style>
    /* === ESTILOS DOS CARDS DE FILTRO (Mantido) === */
    .filter-card-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    .filter-card {
        display: flex;
        align-items: center;
        padding: 20px;
        border-radius: var(--radius-md, 8px);
        background-color: var(--bg-card, #fff);
        border: 1px solid var(--border, #e0e0e0);
        transition: all 0.2s ease;
        color: var(--text-secondary, #666);
        text-decoration: none;
    }
    .filter-card.active, .filter-card:hover {
        border-color: var(--primary, #2563eb);
        color: var(--primary, #2563eb);
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.1);
        transform: translateY(-2px);
    }
    .filter-card .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 16px;
        background-color: rgba(37, 99, 235, 0.1);
    }
    .filter-card.active .icon-wrapper { background-color: var(--primary, #2563eb); }
    .filter-card .icon-wrapper i { color: var(--primary, #2563eb); font-size: 16px; }
    .filter-card.active .icon-wrapper i { color: #fff; }
    .filter-card .info .count { font-size: 1.5rem; font-weight: 700; color: var(--text-primary, #333); }
    .filter-card.active .info .count { color: var(--primary, #2563eb); }
    .filter-card .info .label { font-size: 0.9rem; font-weight: 500; }
    
    /* Cores Específicas dos Filtros */
    /* 1. RECEBIDAS (Verde Água / Teal - #26a69a) */
    .filter-card[data-status="recebidas"] .icon-wrapper { 
        background-color: rgba(38, 166, 154, 0.1); 
    }
    .filter-card[data-status="recebidas"] .icon-wrapper i { 
        color: #26a69a; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="recebidas"].active,
    .filter-card[data-status="recebidas"]:hover {
        border-color: #26a69a;
        color: #26a69a;
    }
    .filter-card[data-status="recebidas"].active .icon-wrapper {
        background-color: #26a69a;
    }
    /* CORREÇÃO: Força o ícone a ficar branco quando ativo */
    .filter-card[data-status="recebidas"].active .icon-wrapper i {
        color: white !important;
    }

    /* 2. IMPLEMENTAÇÃO (Azul - #2563eb) */
    .filter-card[data-status="implementacao"] .icon-wrapper { 
        background-color: rgba(37, 99, 235, 0.1); 
    }
    .filter-card[data-status="implementacao"] .icon-wrapper i { 
        color: #2563eb; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="implementacao"].active,
    .filter-card[data-status="implementacao"]:hover {
        border-color: #2563eb;
        color: #2563eb;
    }
    .filter-card[data-status="implementacao"].active .icon-wrapper {
        background-color: #2563eb;
    }
    /* CORREÇÃO */
    .filter-card[data-status="implementacao"].active .icon-wrapper i {
        color: white !important;
    }

    /* 3. AG. APROVAÇÃO (Verde Claro / Lime - #4ade80) */
    .filter-card[data-status="ag_aprovacao"] .icon-wrapper { 
        background-color: rgba(74, 222, 128, 0.1); 
    }
    .filter-card[data-status="ag_aprovacao"] .icon-wrapper i { 
        color: #4ade80; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="ag_aprovacao"].active,
    .filter-card[data-status="ag_aprovacao"]:hover {
        border-color: #4ade80;
        color: #22c55e; 
    }
    .filter-card[data-status="ag_aprovacao"].active .icon-wrapper {
        background-color: #4ade80;
    }
    /* CORREÇÃO */
    .filter-card[data-status="ag_aprovacao"].active .icon-wrapper i {
        color: white !important;
    }

    /* 4. VAL. EFICÁCIA (Laranja / Amber - #f59e0b) */
    .filter-card[data-status="val_eficacia"] .icon-wrapper { 
        background-color: rgba(245, 158, 11, 0.1); 
    }
    .filter-card[data-status="val_eficacia"] .icon-wrapper i { 
        color: #f59e0b; 
    }
    /* Comportamento Ativo/Hover */
    .filter-card[data-status="val_eficacia"].active,
    .filter-card[data-status="val_eficacia"]:hover {
        border-color: #f59e0b;
        color: #f59e0b;
    }
    .filter-card[data-status="val_eficacia"].active .icon-wrapper {
        background-color: #f59e0b;
    }
    /* CORREÇÃO */
    .filter-card[data-status="val_eficacia"].active .icon-wrapper i {
        color: white !important;
    }

    /* 5. AG. VALIDAÇÃO (Roxo - #9333ea) */
    .filter-card[data-status="validacao"] .icon-wrapper { 
        background-color: rgba(147, 51, 234, 0.1); 
    }
    .filter-card[data-status="validacao"] .icon-wrapper i { 
        color: #9333ea; 
    }
    .filter-card[data-status="validacao"].active,
    .filter-card[data-status="validacao"]:hover {
        border-color: #9333ea;
        color: #9333ea;
    }
    .filter-card[data-status="validacao"].active .icon-wrapper {
        background-color: #9333ea;
    }
    /* CORREÇÃO */
    .filter-card[data-status="validacao"].active .icon-wrapper i {
        color: white !important;
    }

    /* === NOVOS ESTILOS DA TABELA (Movidos para cá para garantir carregamento) === */
    
    /* Filtros da Tabela */
    .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }

        /* --- ESTILOS PARA COLUNA DE AÇÕES/STATUS --- */
        
        /* Container para alinhar barra e botão */
        .status-action-wrapper {
            width: 100%;
            height: 100%;
            min-height: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        /* --- A BARRA LATERAL (GAVETA FINA) --- */
        .status-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 12px; /* BEM MAIS FINA AGORA */
            
            /* Visual */
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
            cursor: pointer;
            
            /* Transição */
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10; 
            
            /* Layout interno */
            display: flex;
            align-items: center;
            justify-content: center; /* Centraliza o ícone na largura fina */
            overflow: hidden;
        }

        /* O ÍCONE (Mudado para Chevron '›' para caber melhor) */
        .status-bar::before {
            content: '\f105'; /* Código do fa-angle-right (›) */
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            
            position: absolute;
            left: 50%;
            transform: translateX(-50%); /* Centraliza exato no meio dos 12px */
            
            color: rgba(255, 255, 255, 0.9);
            font-size: 11px; /* Tamanho delicado */
            transition: all 0.2s ease;
        }

        /* O TEXTO (Status) */
        .status-bar::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            
            color: #fff;
            font-weight: 700;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease 0.1s;
        }

        /* --- INTERAÇÃO (HOVER NA BARRA) --- */
        
        /* 1. Expande a barra */
        .status-bar:hover {
            width: 100%; 
            border-radius: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
        }

        /* 2. O Chevron some suavemente ou desliza */
        .status-bar:hover::before {
            opacity: 0;
            transform: translateX(10px); /* Desliza um pouco para direita e some */
        }

        /* 3. Texto aparece */
        .status-bar:hover::after {
            opacity: 1;
        }

        /* --- A ENGRENAGEM --- */
        .gear-wrapper {
            z-index: 1;
            position: relative;
        }

        .btn-gear {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border, #e0e0e0);
            background: #fff;
            color: var(--text-secondary, #666);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-gear:hover {
            border-color: var(--primary, #2563eb);
            color: var(--primary, #2563eb);
            transform: rotate(30deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- CORES PERSONALIZADAS (Baseadas na Imagem do Dashboard) --- */

        /* 1. Recebidas (ABERTO) - Turquesa/Teal */
        .status-bar.status-ABERTO,
        .status-bar.status-RECEBIDO { 
            background-color: #26a69a !important; /* Cor do ícone "Recebidas" */
        }

        /* 2. Em Implementação - Azul */
        .status-bar.status-EM_IMPLEMENTACAO { 
            background-color: #2563eb !important; /* Cor do ícone "Implementação" */
        }

        /* 3. Validação de Eficácia - Laranja */
        /* Mapeamos tanto o status de validação quanto checagem para laranja */
        .status-bar.status-VAL_EFICACIA,
        .status-bar.status-VALIDACAO_EFICACIA, 
        .status-bar.status-AGUARDANDO_VALIDACAO { 
            background-color: #f59e0b !important; /* Cor do ícone "Val. Eficácia" */
        }

        /* 4. Ag. Aprovação - Verde Claro (Lime) */
        .status-bar.status-AGUARDANDO_APROVACAO,
        .status-bar.status-AG_APROVACAO { 
            background-color: #4ade80 !important; /* Cor do ícone "Ag. Aprovação" */
        }

        /* Status Extras (Caso existam no sistema) */
        .status-bar.status-CONCLUIDO { 
            background-color: #16a34a !important; /* Um verde um pouco mais escuro para finalizado */
        }
        
        .status-bar.status-CANCELADO { 
            background-color: #94a3b8 !important; /* Cinza */
        }

        /* Grid de Ações */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
            justify-content: center;
        }

        .grid-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 20px 10px;
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-secondary);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            border: 1px solid transparent;
            height: 140px; /* Altura fixa para ficarem quadrados */
            text-align: center;
        }

        .grid-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--border);
            color: var(--primary);
        }

        .grid-action-btn .icon-circle {
            width: 40px;
            height: 40px;
            background: #f1f5f9; /* Cor de fundo suave para o ícone */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 18px;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .grid-action-btn:hover .icon-circle {
            background: var(--primary);
            color: white;
        }

        .grid-action-btn span {
            font-size: 13px;
            font-weight: 600;
            line-height: 1.4;
        }

        /* Estilo específico para botão de deletar/recusar */
        .grid-action-btn.delete-style:hover .icon-circle {
            background: var(--error);
        }
        .grid-action-btn.delete-style:hover {
            color: var(--error);
        }

        .modal {
        display: none; /* Oculto por padrão */
        position: fixed;
        z-index: 9999; /* Alto para ficar sobre tudo */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5); /* Fundo escuro transparente */
        backdrop-filter: blur(4px); /* Efeito de desfoque */
        align-items: center;     /* Centraliza verticalmente (se usar flex) */
        justify-content: center; /* Centraliza horizontalmente (se usar flex) */
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto; /* Centraliza se não usar flex */
        border: 1px solid #888;
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: modalFadeIn 0.3s ease-out;
        position: relative;
    }

    /* Animação suave de entrada */
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .close-btn {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.2s;
    }
    .close-btn:hover { color: #000; }



    /* === ESTILOS DO NOVO MODAL DE DETALHES (Estilo Clean/Cinza) === */
    .modal-detailed-header {
        background: #fff;
        padding: 20px 20px 0 20px;
        border-radius: 8px 8px 0 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .modal-top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-tabs {
        display: flex;
        gap: 20px;
    }

    .modal-tab {
        padding: 10px 5px;
        font-size: 14px;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .modal-tab.active {
        color: #0066cc; /* Azul */
        border-bottom-color: #0066cc; /* Azul */
    }

    .modal-detailed-body {
        padding: 20px;
        background-color: #f8fafc; /* Fundo levemente cinza */
        max-height: 80vh;
        overflow-y: auto;
    }

    /* Grid do Formulário */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-size: 12px;
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }

    .form-value-box {
        background: #e2e8f0; /* O cinza dos inputs da imagem */
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
        color: #333;
        min-height: 36px;
        display: flex;
        align-items: center;
        border: 1px solid #cbd5e1;
    }

    .form-value-box.textarea-style {
        min-height: 100px;
        align-items: flex-start;
        white-space: pre-wrap;
    }

    .full-width {
        grid-column: 1 / -1;
    }

    /* Botões de Ação do Modal ( ... e X ) */
    .modal-actions-top {
        display: flex;
        gap: 10px;
    }
    .btn-circle-action {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: white;
        color: #666;
        transition: all 0.2s;
    }
    .btn-circle-action:hover {
        background: #f1f5f9;
        color: #333;
    }
    .btn-circle-action.close-red:hover {
        background: #fee2e2;
        color: #ef4444;
        border-color: #ef4444;
    }



    .textarea-container {
        position: relative;
        width: 100%;
    }

    #motivoArquivamento {
        width: 100%;
        height: 120px;
        padding: 12px;
        border: 1px solid #dc2626; /* Começa vermelho por padrão */
        border-radius: 4px;
        font-family: inherit;
        resize: none;
        outline: none;
        transition: all 0.2s;
    }

    /* Estado Válido (Verde) */
    #motivoArquivamento.valid {
        border-color: #22c55e !important;
        box-shadow: 0 0 0 1px #22c55e;
    }

    /* Botão Desativado */
    #btnConfirmarArquivar:disabled {
        background-color: #ccc !important;
        cursor: not-allowed;
        opacity: 0.7;
    }


    /* === ESTILOS DA NOTIFICAÇÃO (TOAST) === */
    #toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000; /* Acima de tudo, inclusive modais */
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .toast-notification {
        min-width: 300px;
        padding: 16px 20px;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        font-size: 14px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideInRight 0.3s ease-out forwards;
        opacity: 0;
    }

    .toast-notification.success {
        background-color: #22c55e; /* Verde */
        border-left: 6px solid #15803d;
    }

    .toast-notification.error {
        background-color: #ef4444; /* Vermelho */
        border-left: 6px solid #b91c1c;
    }

    .toast-notification.warning {
        background-color: #f59e0b; /* Laranja */
        border-left: 6px solid #b45309; /* Laranja Escuro */
    }

    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOutRight {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    /* Estilos para a aba de Resolução */
    .resolution-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .context-section {
        background-color: #fff1f2; /* Fundo avermelhado suave para indicar o "Problema" */
        border: 1px solid #fecaca;
        border-radius: 6px;
        padding: 15px;
    }

    .solution-section {
        background-color: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 15px;
    }

    .section-title {
        font-size: 13px;
        font-weight: 700;
        text-transform: uppercase;
        color: #64748b;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .evidence-gallery {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .evidence-thumb {
        width: 60px;
        height: 60px;
        border-radius: 4px;
        border: 1px solid #ddd;
        object-fit: cover;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .evidence-thumb:hover {
        transform: scale(1.05);
        border-color: #2563eb;
    }

    /* Ocultar/Mostrar Abas */
    .tab-content-panel {
        display: none; /* Escondido por padrão */
        animation: fadeIn 0.3s ease;
    }
    .tab-content-panel.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* 5. AG. VALIDAÇÃO (Roxo - #9333ea) */
    .filter-card[data-status="validacao"] .icon-wrapper { 
        background-color: rgba(147, 51, 234, 0.1); 
    }
    .filter-card[data-status="validacao"] .icon-wrapper i { 
        color: #9333ea; 
    }
    .filter-card[data-status="validacao"].active,
    .filter-card[data-status="validacao"]:hover {
        border-color: #9333ea;
        color: #9333ea;
    }
    .filter-card[data-status="validacao"].active .icon-wrapper {
        background-color: #9333ea;
    }
    
    /* Atualize também a barra lateral da tabela se quiser */
    .status-bar.status-AGUARDANDO_VALIDACAO { 
        background-color: #9333ea !important; 
    }

    .input-group-text {
        display: flex;
        align-items: stretch;
    }
    .input-group-text input {
        flex: 1;
    }

    /* Estilo de cada linha de investimento */
    .investimento-row {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        transition: all 0.2s;
    }
    
    .investimento-row:hover {
        border-color: #cbd5e1;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    /* Botão de excluir flutuante no canto da linha */
    .btn-delete-row {
        position: absolute;
        top: -10px;
        right: -10px;
        width: 28px;
        height: 28px;
        background: #fff;
        border: 1px solid #ef4444;
        color: #ef4444;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 2;
    }
    .btn-delete-row:hover {
        background: #ef4444;
        color: white;
    }

    /* TIMELINE STYLES */
    .timeline {
        position: relative;
        padding: 20px 0;
        margin-left: 20px;
        border-left: 2px solid #e2e8f0;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 30px;
    }

    .timeline-item:last-child {
        margin-bottom: 0;
    }

    /* Bolinha na linha do tempo */
    .timeline-marker {
        position: absolute;
        left: -11px; /* Centraliza na linha de 2px */
        top: 0;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #2563eb; /* Azul padrão */
        z-index: 1;
    }

    /* Cores das bolinhas por tipo */
    .marker-STATUS { border-color: #2563eb; } /* Azul */
    .marker-CRIACAO { border-color: #10b981; } /* Verde */
    .marker-REDISTRIBUICAO { border-color: #f59e0b; } /* Laranja */
    .marker-EDICAO { border-color: #64748b; } /* Cinza */
    .marker-ANEXO { border-color: #8b5cf6; } /* Roxo */
    .marker-PRAZO { border-color: #ec4899; } /* Rosa */

    .timeline-content {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .timeline-author {
        font-weight: 700;
        color: #333;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .timeline-avatar {
        width: 24px;
        height: 24px;
        background: #f1f5f9;
        color: #64748b;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
    }

    .timeline-date {
        font-size: 12px;
        color: #94a3b8;
    }

    .timeline-body {
        font-size: 13px;
        color: #555;
        line-height: 1.5;
    }

    /* --- ESTILOS DA ABA FÓRUM --- */
    .forum-container {
        display: flex;
        flex-direction: column;
        height: 60vh; /* Altura fixa para permitir scroll */
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 20px;
    }

    .forum-messages-area {
        flex: 1;
        overflow-y: auto;
        padding-right: 10px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 15px;
    }

    /* Balão de Mensagem */
    .forum-msg-item {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .forum-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: #c4b5fd; /* Cor padrão */
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
        flex-shrink: 0;
    }

    .forum-msg-content {
        display: flex;
        flex-direction: column;
        max-width: 80%;
    }

    .forum-msg-meta {
        font-size: 11px;
        color: #64748b;
        margin-bottom: 4px;
    }

    .forum-msg-bubble {
        padding: 10px 14px;
        border-radius: 0 12px 12px 12px;
        font-size: 13px;
        line-height: 1.4;
        color: #fff;
        background-color: #0066cc; /* Azul (Era vermelho) */
        color: #fff;
    }

    /* Mensagem do Próprio Usuário (Opcional: Alinhar à direita) */
    .forum-msg-item.me {
        flex-direction: row-reverse;
    }
    .forum-msg-item.me .forum-msg-bubble {
        border-radius: 12px 0 12px 12px;
        background-color: #334155; /* Cinza escuro para diferenciar */
    }
    .forum-msg-item.me .forum-msg-meta {
        text-align: right;
    }

    /* Área de Input */
    .forum-input-area {
        display: flex;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
        margin: -20px -20px -20px -20px; /* Expande para as bordas */
        padding: 15px 20px;
        border-radius: 0 0 8px 8px;
    }

    .forum-input-area input {
        background: #fff;
        border: 1px solid #cbd5e1;
    }

    .btn-send-forum {
        background-color: #0066cc;
        color: white;
        border: none;
        width: 42px;
        height: 38px; /* Altura igual ao input padrão */
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    .btn-send-forum:hover {
        background-color: #0052a3;
    }

    
    /* --- CORES DOS CARDS DE FINALIZADAS (PADRONIZADO) --- */
    
    /* 1. Concluídas (Verde Sucesso) */
    .filter-card[data-status="concluidas"] .icon-wrapper { 
        background-color: rgba(22, 163, 74, 0.1); 
    }
    .filter-card[data-status="concluidas"] .icon-wrapper i { 
        color: #16a34a; 
    }
    .filter-card[data-status="concluidas"].active,
    .filter-card[data-status="concluidas"]:hover { 
        border-color: #16a34a; 
        color: #16a34a; 
    }
    .filter-card[data-status="concluidas"].active .icon-wrapper { 
        background-color: #16a34a; 
        color: white !important;
    }
    .filter-card[data-status="concluidas"].active .icon-wrapper i {
        color: white !important;
    }

    /* 2. Recusadas (Vermelho Alerta) */
    .filter-card[data-status="recusadas"] .icon-wrapper { 
        background-color: rgba(220, 38, 38, 0.1); 
    }
    .filter-card[data-status="recusadas"] .icon-wrapper i { 
        color: #dc2626; 
    }
    .filter-card[data-status="recusadas"].active,
    .filter-card[data-status="recusadas"]:hover { 
        border-color: #dc2626; 
        color: #dc2626; 
    }
    .filter-card[data-status="recusadas"].active .icon-wrapper { 
        background-color: #dc2626; 
        color: white !important;
    }
    .filter-card[data-status="recusadas"].active .icon-wrapper i {
        color: white !important;
    }

    /* 3. Arquivadas (Azul Ciano - Para combinar com o status) */
    .filter-card[data-status="arquivadas"] .icon-wrapper { 
        background-color: rgba(14, 165, 233, 0.1); /* Azul Claro */
    }
    .filter-card[data-status="arquivadas"] .icon-wrapper i { 
        color: #0ea5e9; 
    }
    .filter-card[data-status="arquivadas"].active,
    .filter-card[data-status="arquivadas"]:hover { 
        border-color: #0ea5e9; 
        color: #0ea5e9; 
    }
    .filter-card[data-status="arquivadas"].active .icon-wrapper { 
        background-color: #0ea5e9; 
        color: white !important;
    }
    .filter-card[data-status="arquivadas"].active .icon-wrapper i {
        color: white !important;
    }

    /* --- CORES DOS STATUS FINAIS (TABELA) --- */

    /* CONCLUÍDO (Verde #16a34a) */
    .status-badge.status-CONCLUIDO {
        background-color: #f0fdf4; /* Fundo bem claro */
        color: #15803d; /* Texto escuro */
        border: 1px solid #bbf7d0;
    }
    .status-bar.status-CONCLUIDO { 
        background-color: #16a34a !important; /* Barra lateral cor principal */
    }

    /* RECUSADO/CANCELADO (Vermelho #dc2626) */
    .status-badge.status-CANCELADO {
        background-color: #fef2f2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    .status-bar.status-CANCELADO { 
        background-color: #dc2626 !important; 
    }

    /* ARQUIVADO (Azul Ciano #0ea5e9) */
    .status-badge.status-ARQUIVADO {
        background-color: #f0f9ff;
        color: #0369a1;
        border: 1px solid #bae6fd;
    }
    .status-bar.status-ARQUIVADO { 
        background-color: #0ea5e9 !important; 
    }

    /* Estilos Clean Form (Inspirado na imagem) */
    .date-input-group {
        display: flex;
        align-items: center;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 5px;
        flex: 1;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .date-icon-box {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        margin-right: 10px;
    }
    .date-icon-box.success { background-color: #dcfce7; color: #166534; } /* Verde para Início */
    .date-icon-box.danger { background-color: #fee2e2; color: #991b1b; } /* Vermelho para Final */

    .date-label {
        font-size: 11px;
        color: #999;
        font-weight: 600;
        display: block;
        text-transform: uppercase;
    }

    .date-clean-input {
        border: none;
        outline: none;
        font-size: 14px;
        font-weight: 600;
        color: #333;
        width: 100%;
        background: transparent;
    }

    .input-wrapper-clean {
        margin-bottom: 20px;
        position: relative;
    }

    .label-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
    }

    .label-row label {
        font-size: 14px;
        color: #444;
        font-weight: 500;
    }

    .label-row .counter {
        font-size: 12px;
        font-weight: 700;
        color: #ef4444; /* Vermelho como na imagem */
    }

    .input-clean {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc; /* Borda padrão */
        border-radius: 4px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .input-clean:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        outline: none;
    }

    /* Estado de erro (Vermelho como na imagem) */
    .input-clean.error {
        border-color: #ef4444;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ef4444' viewBox='0 0 16 16'%3E%3Cpath d='M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }

    .error-msg {
        color: #ef4444;
        font-size: 11px;
        margin-top: 4px;
        display: none;
    }

    .input-clean.error + .error-msg {
        display: block;
    }

    .textarea-clean {
        resize: vertical;
        border-color: #e2e8f0;
    }

    .file-upload-box {
        border: 2px dashed #ccc;
        border-radius: 6px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: #fafafa;
        color: #666;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .file-upload-box:hover {
        border-color: #2563eb;
        background: #eff6ff;
        color: #2563eb;
    }
        
    </style>

<div class="filter-card-list">
    
    {% if current_mode == 'active' %}
        <a href="?mode=active&status={% if current_status == 'recebidas' %}todos{% else %}recebidas{% endif %}" 
           class="filter-card {% if current_status == 'recebidas' %}active{% endif %}" 
           data-status="recebidas">
            <div class="icon-wrapper"><i class="fas fa-inbox"></i></div>
            <div class="info"><div class="count">{{ status_counts.recebidas }}</div><div class="label">Recebidas</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'validacao' %}todos{% else %}validacao{% endif %}" 
           class="filter-card {% if current_status == 'validacao' %}active{% endif %}" 
           data-status="validacao">
            <div class="icon-wrapper"><i class="fas fa-search"></i></div>
            <div class="info"><div class="count">{{ status_counts.aguardando_validacao }}</div><div class="label">Ag. Validação</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'implementacao' %}todos{% else %}implementacao{% endif %}" 
           class="filter-card {% if current_status == 'implementacao' %}active{% endif %}" 
           data-status="implementacao">
            <div class="icon-wrapper"><i class="fas fa-cogs"></i></div>
            <div class="info"><div class="count">{{ status_counts.implementacao }}</div><div class="label">Implementação</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'ag_aprovacao' %}todos{% else %}ag_aprovacao{% endif %}" 
           class="filter-card {% if current_status == 'ag_aprovacao' %}active{% endif %}" 
           data-status="ag_aprovacao">
            <div class="icon-wrapper"><i class="fas fa-user-check"></i></div>
            <div class="info"><div class="count">{{ status_counts.ag_aprovacao }}</div><div class="label">Ag. Aprovação</div></div>
        </a>

        <a href="?mode=active&status={% if current_status == 'val_eficacia' %}todos{% else %}val_eficacia{% endif %}" 
           class="filter-card {% if current_status == 'val_eficacia' %}active{% endif %}" 
           data-status="val_eficacia">
            <div class="icon-wrapper"><i class="fas fa-clipboard-check"></i></div>
            <div class="info"><div class="count">{{ status_counts.val_eficacia }}</div><div class="label">Val. Eficácia</div></div>
        </a>

    {% else %}
        <a href="?mode=finished&status={% if current_status == 'concluidas' %}todos{% else %}concluidas{% endif %}" 
           class="filter-card {% if current_status == 'concluidas' %}active{% endif %}" 
           data-status="concluidas">
            <div class="icon-wrapper"><i class="fas fa-check-circle"></i></div>
            <div class="info"><div class="count">{{ status_counts.concluidas }}</div><div class="label">Concluídas</div></div>
        </a>

        <a href="?mode=finished&status={% if current_status == 'recusadas' %}todos{% else %}recusadas{% endif %}" 
           class="filter-card {% if current_status == 'recusadas' %}active{% endif %}" 
           data-status="recusadas">
            <div class="icon-wrapper"><i class="fas fa-ban"></i></div>
            <div class="info"><div class="count">{{ status_counts.recusadas }}</div><div class="label">Recusadas</div></div>
        </a>

        <a href="?mode=finished&status={% if current_status == 'arquivadas' %}todos{% else %}arquivadas{% endif %}" 
           class="filter-card {% if current_status == 'arquivadas' %}active{% endif %}" 
           data-status="arquivadas">
            <div class="icon-wrapper"><i class="fas fa-archive"></i></div>
            <div class="info"><div class="count">{{ status_counts.arquivadas }}</div><div class="label">Arquivadas</div></div>
        </a>
    {% endif %}

</div>

<div id="actionGridModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px; background: #f8fafc; border-radius: 8px;">
        <div class="modal-header" style="background: white; border-bottom: 1px solid #e2e8f0; padding: 20px 30px; border-radius: 8px 8px 0 0;">
            <h2 id="modalActionTitle" style="font-size: 18px; color: #1e293b; font-weight: 700; margin: 0;"></h2>
            <span class="close-btn" onclick="closeActionGridModal()">&times;</span>
        </div>
        
        <div class="modal-body" style="padding: 30px;">
            <div class="action-grid">
                <a href="#" id="btnInvestir" class="grid-action-btn" style="display: none;">
                    <div class="icon-circle"><i class="fas fa-dollar-sign"></i></div>
                    <span>Investir</span>
                </a>
                <a href="#" id="btnExportar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-file-export"></i></div>
                    <span>Exportar</span>
                </a>

                <a href="#" id="btnRedirecionar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-share"></i></div>
                    <span>Redirecionar</span>
                </a>

                <a href="#" id="btnRelatorio" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-file-alt"></i></div>
                    <span>Relatório</span>
                </a>

                <a href="#" id="btnArquivar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-archive"></i></div>
                    <span>Arquivar</span>
                </a>

                <a href="#" id="btnClonar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-copy"></i></div>
                    <span>Clonar Ação</span>
                </a>

                <a href="#" id="btnPrazo" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-calendar-alt"></i></div>
                    <span>Nova data de<br>encerramento</span>
                </a>

                <a href="#" id="btnAceitar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-check-circle"></i></div>
                    <span>Aceitar</span>
                </a>

                <a href="#" id="btnRecusar" class="grid-action-btn">
                    <div class="icon-circle"><i class="fas fa-times-circle"></i></div>
                    <span>Recusar</span>
                </a>
                
            </div>
        </div>
        
        <div class="modal-footer" style="background: white; border-top: 1px solid #e2e8f0; padding: 15px 30px; border-radius: 0 0 8px 8px;">
            <button type="button" class="btn btn-danger" onclick="closeActionGridModal()" style="padding: 8px 24px;">Fechar</button>
        </div>
    </div>
</div>

<div id="modalDetalhes" class="modal">
    <div class="modal-content" style="max-width: 900px; width: 90%; border-radius: 8px;">
        
        <div class="modal-detailed-header">
            <div class="modal-top-bar">
                <h3 id="detalheTitulo" style="font-size: 16px; font-weight: 700; margin: 0; color: #333;">
                    </h3>
                <div class="modal-actions-top">
                    <button class="btn-circle-action" title="Mais opções" onclick="openOptionsFromDetails()">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                    
                    <button class="btn-circle-action close-red" onclick="closeModalDetalhes()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="modal-tabs">
                <div class="modal-tab active">AÇÕES</div>
                <div class="modal-tab">RESOLUÇÃO</div>
                <div class="modal-tab">HISTÓRICO</div>
                <div class="modal-tab">FÓRUM</div>
                <div class="modal-tab">FERRAMENTA</div>
            </div>
        </div>

        <div class="modal-detailed-body">
            
            <div id="tab-acoes" class="tab-content-panel active">
                <div class="form-grid">
                    <div class="form-group"><label>ID do Plano de Ação</label><div id="detalheId" class="form-value-box"></div></div>
                    <div class="form-group"><label>ID da Auditoria</label><div id="detalheIdAuditoria" class="form-value-box"></div></div>
                    <div class="form-group"><label>Status Atual</label><div id="detalheStatus" class="form-value-box" style="font-weight: bold;"></div></div>
                    <div class="form-group"><label>Responsável</label><div id="detalheResponsavel" class="form-value-box"></div></div>
                    <div class="form-group"><label>Auditor</label><div id="detalheAuditor" class="form-value-box"></div></div>
                    <div class="form-group"><label>Categoria</label><div id="detalheCategoria" class="form-value-box"></div></div>
                    <div class="form-group"><label>Local</label><div id="detalheLocal" class="form-value-box"></div></div>
                    <div class="form-group"><label>Data Início</label><div id="detalheDataInicio" class="form-value-box"></div></div>
                    <div class="form-group"><label>Data Final</label><div id="detalheDataFim" class="form-value-box"></div></div>
                    <div id="grupoOrientacoesExtra" class="form-group full-width" style="display: none; margin-top: 10px;">
                    <label style="color: #2311c0;">Orientações Adicionais (Clonagem)</label>
                    <div id="detalheOrientacoesExtra" class="form-value-box textarea-style" style="background-color: #fff5f5; border-color: #fed7d7; color: #9b2c2c;">
                        </div>
                </div>
                </div>
            </div>

            <div id="tab-resolucao" class="tab-content-panel">
                <div class="resolution-container">
                    
                    <div class="context-section">
                        <div class="section-title" style="color: #b91c1c;">
                            <i class="fas fa-exclamation-circle"></i> O Que Foi Encontrado (Contexto)
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Item da Auditoria (Pergunta)</label>
                            <div id="resPergunta" class="form-value-box" style="background: #fff; border-color: #fecaca;">Carregando...</div>
                        </div>

                        <div class="form-group full-width" style="margin-top: 10px;">
                            <label>Observação do Auditor</label>
                            <div id="resObservacao" class="form-value-box textarea-style" style="min-height: 60px; background: #fff;">-</div>
                        </div>

                        <div style="margin-top: 10px;">
                            <label style="font-size: 12px; font-weight: 600; color: #333;">Evidências (Fotos da Auditoria)</label>
                            <div id="resEvidencias" class="evidence-gallery">
                                <span style="font-size: 12px; color: #666; font-style: italic;">Nenhuma evidência anexada na auditoria.</span>
                            </div>
                        </div>
                    </div>

                    <div class="solution-section">
                        <div class="section-title" style="color: #15803d;">
                            <i class="fas fa-tools"></i> Tratativa / Resolução
                        </div>

                        <form id="formTratativa">
                            <div class="form-group full-width">
                                <label for="inputCausaRaiz">Análise de Causa Raiz</label>
                                <textarea id="inputCausaRaiz" class="form-control" rows="3" readonly 
                                          style="background-color: #f1f5f9; color: #555; cursor: not-allowed;"
                                          placeholder="Aguardando preenchimento no aceite..."></textarea>
                            </div>

                            <div class="form-group full-width" style="margin-top: 15px;">
                                <label>Ações Propostas (Planejamento)</label>
                                <textarea id="inputAcoes" class="form-control" rows="3" readonly style="background-color: #f1f5f9; color: #555;"></textarea>
                            </div>

                            <div class="form-grid" style="margin-top: 15px;">
                                <div class="form-group">
                                    <label>Data Finalização - Prevista</label>
                                    <input type="date" id="inputDataPrevista" class="form-control" readonly style="background-color: #f1f5f9; color: #555;">
                                </div>

                                <div class="form-group full-width" style="margin-top: 15px;">
                                    <label style="font-size: 13px; font-weight: 700; color: #333; margin-bottom: 8px;">Investimentos Realizados</label>
                                    
                                    <div id="listaInvestimentosVisual" style="display: flex; flex-direction: column; gap: 15px;">
                                        </div>
                                    
                                    <div id="totalizadorInvestimentos" style="text-align: right; margin-top: 10px; font-weight: 700; color: #15803d; display: none;">
                                        Total Geral: R$ <span id="valorTotalGeral">0,00</span>
                                    </div>
                                </div>

                                <div class="form-group full-width" style="margin-top: 15px;">
                                <label style="color: #15803d; font-weight: 700;">Ações Realizadas (Execução)</label>
                                <textarea id="inputAcoesRealizadas" class="form-control" rows="3" readonly 
                                          style="background-color: #f0fdf4; border-color: #bbf7d0; color: #166534;" 
                                          placeholder="Aguardando conclusão..."></textarea>
                                </div>
                                
                                <div class="form-group full-width" style="margin-top: 15px;">
                                    <label style="font-size: 13px; font-weight: 700; color: #333;">
                                        <i class="fas fa-paperclip"></i> Evidências de Conclusão (Anexadas)
                                    </label>
                                    
                                    <div id="listaEvidenciasLeitura" style="display: flex; flex-direction: column; gap: 8px; margin-top: 5px;">
                                        <span style="font-size: 12px; color: #999;">Carregando...</span>
                                    </div>
                                </div>
                            </div>
                            
                        </form>
                    </div>

                </div>
            </div>

            <div id="tab-historico" class="tab-content-panel">
                <div id="timelineContainer" class="timeline">
                    <span style="margin-left: 30px; color: #999;">Carregando histórico...</span>
                </div>
            </div>
            <div id="tab-forum" class="tab-content-panel" style="height: 100%;">
                <div class="forum-container">
                    
                    <div style="padding-bottom: 15px; border-bottom: 1px solid #e2e8f0; margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 14px; font-weight: 700; color: #333;">Fórum de Mensagens</h4>
                    </div>

                    <div id="forumMessagesArea" class="forum-messages-area">
                        <div style="text-align: center; color: #999; margin-top: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando mensagens...
                        </div>
                    </div>

                    <div class="forum-input-area">
                        <input type="text" id="forumInputMsg" class="form-control" placeholder="Mensagem" 
                               onkeypress="if(event.key === 'Enter') enviarMensagemForum()">
                        
                        <button type="button" onclick="enviarMensagemForum()" class="btn-send-forum">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                </div>
            </div>
            <div id="tab-ferramenta" class="tab-content-panel">...</div>

        </div>
    </div>
</div>
<div id="modalArquivar" class="modal">
    <div class="modal-content" style="max-width: 600px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Arquivar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <div class="input-wrapper-archive">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <label for="motivoArquivamento" style="font-size: 14px; color: #555;">Motivo do arquivamento</label>
                    <span id="charCounter" style="font-size: 12px; color: #22c55e; font-weight: bold;">0/255</span>
                </div>
                
                <div class="textarea-container">
                    <textarea id="motivoArquivamento" maxlength="255" placeholder="Digite o motivo..." oninput="updateCharCount(this)"></textarea>
                    <i class="fas fa-check" id="checkIcon" style="display: none; color: #22c55e; position: absolute; right: 10px; top: 10px;"></i>
                </div>
            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff;">
            <button type="button" onclick="closeArchiveModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarArquivar" onclick="submitArquivamento()" disabled 
                    style="background-color: #2311c0; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Arquivar
            </button>
        </div>
    </div>
</div>
<div id="modalAceitarAcao" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formAceitarAcao">
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label for="causaRaizAceitar" style="font-size: 14px; color: #555; font-weight: 600;">
                            Análise de Causa Raiz
                        </label>
                    </div>
                    <textarea id="causaRaizAceitar" class="form-control" rows="3" 
                              style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"
                              placeholder="Descreva a causa raiz do problema (ex: Utilize a técnica dos 5 Porquês)..."></textarea>
                    <small style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div class="input-wrapper-archive" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label for="acoesPropostas" style="font-size: 14px; color: #555;">Ações Propostas</label>
                        <span id="charCounterAceitar" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="acoesPropostas" class="form-control" rows="4" maxlength="255" 
                                  placeholder="Descreva as ações que serão realizadas..."
                                  oninput="updateCharCountAceitar(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconAceitar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="dataFinalizacaoPrevista" style="font-size: 14px; color: #555;">Data de Finalização Prevista</label>
                    <input type="date" id="dataFinalizacaoPrevista" class="form-control" required>
                </div>

                <div style="margin-bottom: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="checkFluxoSimplificado" style="width: 18px; height: 18px; margin-top: 2px; accent-color: #16a34a;">
                        <div>
                            <span style="font-weight: 600; color: #166534; font-size: 14px;">Fluxo Simplificado</span>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #15803d;">
                                Marque se esta ação for simples e não necessitar de validação ou aprovação posterior do auditor.
                                Ao concluir, a ação será finalizada automaticamente.
                            </p>
                        </div>
                    </label>
                </div>

                <div style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden;">
                    <div style="padding: 15px; background: #f8fafc; cursor: pointer; display: flex; justify-content: space-between; align-items: center;"
                         onclick="toggleEvidenciasAceitar()">
                        <span style="font-weight: 600; color: #333;">Evidências</span>
                        <i class="fas fa-chevron-down" id="iconEvidencias"></i>
                    </div>
                    <div id="containerEvidenciasAceitar" style="padding: 20px; display: none; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>Adicionar evidência</span>
                            <button type="button" class="btn btn-primary btn-sm" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background-color: #b91c1c; border-color: #b91c1c;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <p style="font-size: 12px; color: #999; margin-top: 10px;">(Funcionalidade de upload em breve)</p>
                    </div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeAceitarModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            

            <button type="button" id="btnConfirmarAceite" onclick="submitAceitarAcao('CONFIRMAR')" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalAprovarPlano" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <div style="margin-bottom: 20px;">
                <h5 style="font-size: 16px; font-weight: 700; color: #333; margin-bottom: 10px;">Ação Proposta</h5>
                <p id="textoAcaoProposta" style="font-size: 14px; color: #555; background: #f8fafc; padding: 10px; border-radius: 4px; border: 1px solid #e2e8f0;">
                    Carregando...
                </p>
            </div>
            
            <p style="font-size: 15px; color: #333;">
                Deseja confirmar novo prazo proposto para o dia <strong id="textoDataProposta">...</strong>?
            </p>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeAprovarModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarAprovacao" onclick="submitAprovacaoAuditor()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalInvestir" class="modal">
    <div class="modal-content" style="max-width: 900px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Investir</h3>
            
            <button type="button" onclick="adicionarLinhaInvestimento()" title="Adicionar novo item" 
                    style="background: #2311c0; color: white; border: none; width: 32px; height: 32px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div style="padding: 20px; background-color: #f8fafc; max-height: 70vh; overflow-y: auto;">
            <form id="formInvestir">
                <div id="containerInvestimentos"></div>
            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <div style="margin-right: auto; display: flex; align-items: center; font-weight: 700; color: #333;">
                Total Geral: <span id="totalGeralInvest" style="margin-left: 5px; color: #15803d;">R$ 0,00</span>
            </div>

            <button type="button" onclick="closeInvestirModal()" style="background: #fff; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Fechar
            </button>
            
            <button type="button" onclick="submitInvestimentoEmLote()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Salvar Investimentos
            </button>
        </div>
    </div>
</div>
<div id="modalConcluir" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação (Conclusão)</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formConcluir">
                
                <div class="input-wrapper-archive" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Ações realizadas</label>
                        <span id="charCounterConcluir" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="acoesRealizadas" class="form-control" rows="4" maxlength="255" 
                                  placeholder="Descreva o que foi feito..."
                                  oninput="updateCharCountConcluir(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconConcluir" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroAcoes" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; background: #fff;">
                    <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #333;">Evidências</span>
                        <i class="fas fa-chevron-down" style="color: #666;"></i>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 14px; color: #555;">Adicionar evidência</span>
                            
                            <button type="button" onclick="document.getElementById('inputEvidenciasFile').click()" 
                                    style="width: 36px; height: 36px; background-color: #2311c0; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="file" id="inputEvidenciasFile" multiple style="display: none;" onchange="handleFileSelect(this)">
                        </div>

                        <div id="listaArquivosUpload" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
                        <small id="msgErroEvidencias" style="color: #ef4444; font-size: 11px; display: none;">É obrigatório anexar pelo menos uma evidência.</small>
                    </div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeConcluirModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>

            <button type="button" id="btnConfirmarConclusao" onclick="submitConclusao()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>

<div id="modalFinalizar" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Finalizar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <div style="display: flex; flex-direction: column; gap: 15px;">
                
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="radio" name="decisaoFinal" value="finalizar" checked 
                           style="accent-color: #2311c0; width: 18px; height: 18px;">
                    <span style="font-size: 15px; font-weight: 600; color: #333;">Finalizar Ação</span>
                </label>

                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="radio" name="decisaoFinal" value="eficacia" 
                           style="accent-color: #2311c0; width: 18px; height: 18px;">
                    <span style="font-size: 15px; font-weight: 600; color: #333;">Enviar para Validação de Eficácia</span>
                </label>

            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeFinalizarModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarFinalizacao" onclick="submitDecisaoAuditor()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalEficacia" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Aceitar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formEficacia">
                
                <div class="input-wrapper-archive" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Observações da eficácia</label>
                        <span id="charCounterEficacia" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="obsEficacia" class="form-control" rows="4" maxlength="255" 
                                  placeholder="Descreva a eficácia da ação..."
                                  oninput="updateCharCountEficacia(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconEficacia" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroEficacia" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

                <div style="border: 1px solid #e0e0e0; border-radius: 6px; overflow: hidden; background: #fff;">
                    <div style="padding: 15px; background: #f8fafc; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: #333;">Evidências</span>
                        <i class="fas fa-chevron-down" style="color: #666;"></i>
                    </div>
                    
                    <div style="padding: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <span style="font-size: 14px; color: #555;">Adicionar evidência</span>
                            
                            <button type="button" onclick="document.getElementById('inputEvidenciasEficacia').click()" 
                                    style="width: 36px; height: 36px; background-color: #2311c0; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                                <i class="fas fa-plus"></i>
                            </button>
                            <input type="file" id="inputEvidenciasEficacia" multiple style="display: none;" onchange="handleFileSelectEficacia(this)">
                        </div>

                        <div id="listaArquivosEficacia" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
                    </div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeEficaciaModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarEficacia" onclick="submitEficacia()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;" disabled>
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalRecusar" class="modal">
    <div class="modal-content" style="max-width: 600px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Recusar / Devolver</h3>
        </div>

        <div style="padding: 30px;">
            <div class="input-wrapper-archive">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <label style="font-size: 14px; color: #555;">Motivo da recusa</label>
                    <span id="charCounterRecusar" style="font-size: 12px; color: #666; font-weight: bold;">0/255</span>
                </div>
                
                <div class="textarea-container">
                    <textarea id="motivoRecusa" class="form-control" rows="4" maxlength="255" 
                              placeholder="Descreva o motivo..." 
                              style="border-color: #ef4444;"
                              oninput="updateCharCountRecusar(this)"></textarea>
                    <i class="fas fa-exclamation-circle" id="errorIconRecusar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                </div>
                <small id="msgErroRecusa" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff;">
            <button type="button" onclick="closeRecusarModal()" style="border: none; background: transparent; color: #666; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarRecusa" onclick="submitRecusa()" disabled 
                    style="background-color: #2311c0; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                Confirmar Descarte
            </button>
        </div>
    </div>
</div>
<div id="modalClonar" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Solicitar mais ações</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formClonar">
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="font-size: 14px; color: #555;">Novo responsável</label>
                    <select id="clonarResponsavel" class="form-control" style="border-color: #22c55e; color: #555;">
                        <option value="">Selecione um item</option>
                        {% for u in usuarios_ativos %}
                            <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }} ({{ u.username }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-wrapper-archive">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Novas orientações</label>
                        <span id="charCounterClonar" style="font-size: 12px; color: #b91c1c; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="clonarOrientacoes" class="form-control" rows="5" maxlength="255" 
                                  style="border-color: #ef4444;"
                                  oninput="updateCharCountClonar(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconClonar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroClonar" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeClonarModal()" style="background: #f8fafc; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Fechar
            </button>
            
            <button type="button" id="btnConfirmarClonar" onclick="submitClonar()" disabled
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                Clonar
            </button>
        </div>
    </div>
</div>
<div id="modalAlterarPrazo" class="modal">
    <div class="modal-content" style="max-width: 500px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Alterar data de encerramento</h3>
        </div>

        <div style="padding: 30px;">
            <div class="form-group">
                <label for="novaDataEncerramento" style="font-size: 14px; color: #555; margin-bottom: 8px; display: block;">Nova data de encerramento</label>
                <input type="date" id="novaDataEncerramento" class="form-control" 
                       style="border: 1px solid #93c5fd; padding: 10px; border-radius: 6px; width: 100%; outline: none; transition: box-shadow 0.2s;">
            </div>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closePrazoModal()" style="border: none; background: transparent; color: #333; cursor: pointer; font-weight: 600;">Cancelar</button>
            
            <button type="button" id="btnConfirmarPrazo" onclick="submitNovoPrazo()" 
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalRedirecionar" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Redirecionar Ação</h3>
        </div>

        <div style="padding: 30px;">
            <form id="formRedirecionar">
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label style="font-size: 14px; color: #555;">De:</label>
                        <div id="txtResponsavelAtual" style="padding: 10px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 4px; color: #333;">
                            -
                        </div>
                    </div>

                    <div class="form-group">
                        <label style="font-size: 14px; color: #555;">Para:</label>
                        <select id="selNovoResponsavel" class="form-control" style="border-color: #22c55e; color: #555;">
                            <option value="">Selecione um item</option>
                            {% for u in usuarios_ativos %}
                                <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="input-wrapper-archive">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 14px; color: #555;">Ações sugeridas</label>
                        <span id="charCounterRedirecionar" style="font-size: 12px; color: #b91c1c; font-weight: bold;">0/255</span>
                    </div>
                    <div class="textarea-container">
                        <textarea id="txtAcoesSugeridas" class="form-control" rows="5" maxlength="255" 
                                  style="border-color: #ef4444;"
                                  oninput="updateCharCountRedirecionar(this)"></textarea>
                        <i class="fas fa-exclamation-circle" id="errorIconRedirecionar" style="display: block; color: #ef4444; position: absolute; right: 10px; top: 10px;"></i>
                    </div>
                    <small id="msgErroRedirecionar" style="color: #ef4444; font-size: 11px;">Campo obrigatório</small>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeRedirecionarModal()" style="background: #f8fafc; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">
                Cancelar
            </button>
            
            <button type="button" id="btnConfirmarRedirecionar" onclick="submitRedirecionar()" disabled
                    style="background-color: #2311c0; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; opacity: 0.7;">
                Confirmar
            </button>
        </div>
    </div>
</div>
<div id="modalNovoPlano" class="modal">
    <div class="modal-content" style="max-width: 800px; padding: 0; border-radius: 8px; overflow: hidden;">
        
        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: #fff;">
            <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 700;">Criar Ação</h3>
        </div>

        <div style="padding: 30px; background-color: #fff;">
            <form id="formNovoPlano" enctype="multipart/form-data">
                
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="date-input-group">
                        <div class="date-icon-box success"><i class="far fa-calendar-alt"></i></div>
                        <div style="flex: 1;">
                            <label class="date-label">Início</label>
                            <input type="date" name="data_inicio" class="date-clean-input" value="{% now 'Y-m-d' %}">
                        </div>
                    </div>

                    <div class="date-input-group">
                        <div class="date-icon-box danger"><i class="far fa-calendar-times"></i></div>
                        <div style="flex: 1;">
                            <label class="date-label">Final (Previsão)</label>
                            <input type="date" name="data_fim" class="date-clean-input">
                        </div>
                    </div>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Título <span style="color:red">*</span></label>
                        <span class="counter" id="countTitulo">0/255</span>
                    </div>
                    <input type="text" name="titulo" id="newTitulo" class="input-clean" maxlength="255" placeholder="Digite o título da ação" oninput="updateCounter(this, 'countTitulo')">
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Categoria <span style="color:red">*</span></label>
                    </div>
                    <select name="categoria" id="newCategoria" class="input-clean">
                        <option value="">Selecione a categoria...</option>
                        {% for cat in categorias %}
                            <option value="{{ cat.id }}">{{ cat.descricao }} ({{ cat.pilar.nome }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Observação <span style="color:red">*</span></label>
                    </div>
                    <div class="textarea-container">
                        <div style="border-bottom: 1px solid #eee; padding: 5px; background: #fafafa; display: flex; gap: 10px;">
                            <i class="fas fa-bold" style="color: #666; font-size: 12px;"></i>
                            <i class="fas fa-italic" style="color: #666; font-size: 12px;"></i>
                            <i class="fas fa-list-ul" style="color: #666; font-size: 12px;"></i>
                        </div>
                        <textarea name="observacao" class="input-clean textarea-clean" rows="5" style="border-top: none; border-radius: 0 0 4px 4px;" placeholder="Descreva os detalhes da ação..."></textarea>
                    </div>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Responsável <span style="color:red">*</span></label>
                    </div>
                    <select name="responsavel" id="newResponsavel" class="input-clean">
                        <option value="">Selecione...</option>
                        {% for u in usuarios_ativos %}
                            <option value="{{ u.id }}">{{ u.first_name }} {{ u.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-bottom: 20px;">
                    <div class="input-wrapper-clean">
                        <div class="label-row">
                            <label>Nível</label>
                        </div>
                        <select name="nivel" id="newNivel" class="input-clean" onchange="filtrarLocais()">
                            <option value="todos">Todos</option>
                            <option value="EMPRESA">Empresa</option>
                            <option value="AREA">Área</option>
                            <option value="SETOR">Setor</option>
                            <option value="SUBSETOR" selected>Subsetor</option>
                        </select>
                    </div>

                    <div class="input-wrapper-clean">
                        <div class="label-row">
                            <label>Local (Subsetor)</label>
                        </div>
                        <select name="local" id="newLocal" class="input-clean">
                            <option value="">Selecione um item</option>
                            {% for sub in subsetores %}
                                <option value="{{ sub.id }}">{{ sub.nome }} ({{ sub.setor.area.empresa.nome }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="input-wrapper-clean">
                    <div class="label-row">
                        <label>Anexos</label>
                    </div>
                    <div class="file-upload-box" onclick="document.getElementById('newFiles').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Clique para fazer upload de arquivos</span>
                        <input type="file" id="newFiles" name="arquivos" multiple style="display: none;" onchange="updateFileList(this)">
                    </div>
                    <div id="newFileList" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>

            </form>
        </div>

        <div style="padding: 15px 30px 20px; display: flex; justify-content: flex-end; gap: 15px; background: #fff; border-top: 1px solid #e0e0e0;">
            <button type="button" onclick="closeModalNovoPlano()" style="background: transparent; border: 1px solid #ddd; color: #333; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">Cancelar</button>
            <button type="button" onclick="submitNovoPlano()" style="background-color: #b91c1c; color: white; border: none; padding: 8px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;">Salvar</button>
        </div>
    </div>
</div>
{% endblock search_form %}


{# --- CABEÇALHOS DA TABELA --- #}
{% block table_headers %}
    <tr>
        <th style="width: 100px; text-align: center;">Ações</th> 
        <th style="width: 80px;">ID Plano</th>
        <th style="width: 100px;">ID Auditoria</th>
        <th>Título (Pergunta)</th>
        <th>Tipo</th>
        <th>Auditor</th>
        <th>Responsável</th>
        <th>Local</th>
        <th>Ferramenta</th>
        <th>Categoria</th>
        <th>Data Abertura</th>
        <th>Prazo</th>
        <th>Data Encerramento</th>
        <th style="width: 80px;">Chat</th>
    </tr>
    <tr class="filter-row">
        <th></th> 
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1" value="{{ searches.id|default:'' }}"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2" value="{{ searches.auditoria_id|default:'' }}"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="4"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="5"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="6"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="7"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="8"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="9"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="10"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="11"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="12"></th>
        <th></th> 
    </tr>
{% endblock %}

{# --- LINHAS DA TABELA (SEM DEBUG) --- #}
{% block table_row %}
    {# --- CÉLULA 1: Ações (Status + Engrenagem) --- #}
    <td style="padding: 0; height: 1px; position: relative;">
        
        <div class="status-action-wrapper">
            {# 1. Barra Lateral: Abre Modal Padrão #}
            <div class="status-bar status-{{ object.status_plano|default:'ABERTO' }}" 
                    data-tooltip="{{ object.get_status_plano_display|default:'Recebido'|abreviar_status }}"
                    style="cursor: pointer;"
                    {# ADICIONADO O 4º PARÂMETRO: ID DA AUDITORIA #}
                    onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
            </div>

            {# 2. Engrenagem: Abre NOVO Modal #}
            <div class="gear-wrapper">
                <button type="button" class="btn-gear" title="Detalhes do Plano" 
                    style="cursor: pointer; border: 1px solid #e0e0e0; background: white;"
                    
                    data-id="{{ object.id }}"
                    data-id-auditoria="{{ object.origem_resposta.auditoria_instancia.id|default:'-' }}" 
                    
                    {# --- MUDANÇA 1: Adicionado Status CODE e Display --- #}
                    data-status="{{ object.get_status_plano_display }}"
                    data-status-code="{{ object.status_plano }}" 
                    
                    {# --- MUDANÇA 2: Adicionado ID do Responsável --- #}
                    data-responsavel-id="{{ object.responsavel_acao.id }}"
                    data-responsavel="{{ object.responsavel_acao.get_full_name|default:object.responsavel_acao.username }}"
                    
                    data-auditor="{% if object.origem_resposta %}{{ object.origem_resposta.auditoria_instancia.responsavel.get_full_name|default:'Sistema' }}{% elif object.criado_por %}{{ object.criado_por.get_full_name|default:object.criado_por.username }}{% else %}Sistema{% endif %}"
                    data-solicitante="{{ object.solicitante.get_full_name|default:'-' }}" 
                    data-id-form="{{ object.origem_resposta.auditoria_instancia.modelo.id|default:'-' }}" 
                    data-categoria="{{ object.categoria.descricao|default:'-' }}"
                    data-local="{{ object.local_execucao.nome|default:'-' }}"
                    data-inicio="{{ object.data_abertura|date:'d/m/Y' }}"
                    data-fim="{{ object.prazo_conclusao|date:'d/m/Y' }}"
                    data-titulo-pergunta="{{ object.titulo|escapejs }}"
                    data-titulo-modal="{{ object.id }} - {{ object.get_tipo_display }}" 
                    data-orientacoes-extra="{{ object.orientacoes_extra|default:''|escapejs }}"
                    data-origem-orientacao="{{ object.origem_orientacao|default:'CLONAGEM' }}" 

                    onclick="openDetailedModal(event, this)">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </td>
    
    {# --- DEMAIS CÉLULAS: Adicionado o 4º parâmetro (ID Auditoria) --- #}
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.id }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.origem_resposta.auditoria_instancia.id }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.titulo|truncatechars:40 }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {% if object.tipo == 'NAO_CONFORMIDADE' %}
            <span class="badge badge-error" style="font-size: 10px;">NC</span>
        {% else %}
            <span class="badge badge-success" style="font-size: 10px;">OM</span>
        {% endif %}
    </td>

    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {% if object.origem_resposta %}
            {{ object.origem_resposta.auditoria_instancia.responsavel.get_full_name|default:"-" }}
        {% else %}
            {# Se for manual, verifica se tem criado_por #}
            {% if object.criado_por %}
                {{ object.criado_por.get_full_name|default:object.criado_por.username }}
            {% else %}
                Sistema
            {% endif %}
        {% endif %}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.responsavel_acao.get_full_name|default:object.responsavel_acao.username|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.local_execucao.nome|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        <span class="badge badge-secondary" style="font-size: 10px;">{{ object.ferramenta.nome|default:"-" }}</span>
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.categoria.descricao|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.data_abertura|date:"d/m/Y" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.prazo_conclusao|date:"d/m/Y"|default:"-" }}
    </td>
    
    <td style="cursor: pointer;" onclick="openStandardModal('{{ object.id }}', '{{ object.titulo|escapejs }}', '{{ object.status_plano }}', '{{ object.origem_resposta.auditoria_instancia.id }}', '{{ object.responsavel_acao.id }}', '{{ object.responsavel_acao.get_full_name|escapejs }}')">
        {{ object.data_conclusao|date:"d/m/Y"|default:"-" }}
    </td>
    
    <td>
        {% if object.forum %}
            <button type="button" class="btn btn-secondary btn-icon js-open-chat" title="Abrir Chat" data-forum-id="{{ object.forum.id }}">
                <i class="fas fa-comments"></i>
            </button>
        {% else %}
            <button type="button" class="btn btn-secondary btn-icon" disabled style="opacity: 0.5;">
                <i class="fas fa-comments"></i>
            </button>
        {% endif %}
    </td>
{% endblock %}



{# --- SCRIPTS JS (Mantidos no final) --- #}
{% block extra_js %}
    {{ block.super }}
    <script>
    // Pega o ID do usuário logado do Django
    const currentUserId = "{{ request.user.id }}";
    let currentPlanContext = {};
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Script da Lista de Planos de Ação Carregado.");

        // --- Lógica de Filtros da Tabela ---
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        
        if (table) {
            const tableBody = table.querySelector('tbody');
            if (tableBody) {
                function applyTableFilters() {
                    const dataRows = tableBody.querySelectorAll('tr');
                    if (dataRows.length === 0) return;
                    
                    dataRows.forEach(row => {
                        let isRowVisible = true;
                        const cells = row.querySelectorAll('td');
                        if (cells.length === 0) return; 

                        filters.forEach(filter => {
                            const filterText = filter.value.toLowerCase().trim();
                            const colIndex = parseInt(filter.dataset.columnIndex, 10);
                            if (filterText) {
                                const cell = cells[colIndex];
                                if (cell) {
                                    const cellText = cell.textContent.toLowerCase().trim();
                                    if (!cellText.includes(filterText)) {
                                        isRowVisible = false;
                                    }
                                }
                            }
                        });
                        row.style.display = isRowVisible ? '' : 'none';
                    });
                }

                if (filters.length > 0) {
                    filters.forEach(filter => {
                        filter.addEventListener('input', applyTableFilters);
                    });
                }
                applyTableFilters();
            }
        }

        // --- LÓGICA DO CHAT ---
        const chatButtons = document.querySelectorAll('.js-open-chat');
        chatButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const forumId = this.dataset.forumId;
                if (typeof window.openChat === 'function') {
                    window.openChat(forumId);
                } else {
                    alert("Erro no sistema: Função de chat não carregada.");
                }
            });
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Adiciona evento de clique nas abas
        const tabs = document.querySelectorAll('.modal-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // 1. Remove ativo de todas as abas e painéis
                document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content-panel').forEach(p => p.classList.remove('active'));
                
                // 2. Ativa a aba clicada
                this.classList.add('active');
                
                // 3. Mostra o painel correspondente
                // Normaliza o texto para remover acentos (FÓRUM -> forum) e minúsculas
                const tabName = this.textContent.trim().toLowerCase()
                    .normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
                
                const panelId = `tab-${tabName}`;
                const panel = document.getElementById(panelId);
                if(panel) panel.classList.add('active');

                // --- CORREÇÃO AQUI ---
                // Verifica "FÓRUM" (com acento) OU normaliza a comparação
                const textoAba = this.textContent.trim().toUpperCase();
                
                if (textoAba === 'FÓRUM' || textoAba === 'FORUM') {
                    if (activeForumId) {
                        carregarMensagensForum();
                    } else {
                        // Se não tiver ID ainda, tenta pegar do contexto global salvo ao abrir o modal
                        if(currentPlanContext && currentPlanContext.id) {
                             // Uma pequena contingência: recarrega os detalhes para garantir o ID do fórum
                             carregarDadosResolucao(currentPlanContext.id);
                        } else {
                             document.getElementById('forumMessagesArea').innerHTML = '<div style="text-align:center; padding:20px;">Fórum não disponível.</div>';
                        }
                    }
                }
            });
        });
    });

    // Variável global para armazenar o ID atual
    let currentActionId = null; 

    // --- FUNÇÕES DE MODAIS ---

    // --- Atualização: Adicionados responsavelId e responsavelNome ---
    function openStandardModal(id, titulo, status, auditoriaId, responsavelId, responsavelNome) {
        openActionGrid(id, titulo, status, auditoriaId, responsavelId, responsavelNome);
    }

    function openActionGrid(id, titulo, status, auditoriaId, responsavelId, responsavelNome) { // <--- CORREÇÃO AQUI: Adicionados os argumentos que faltavam
        currentActionId = id; 
        
        const modal = document.getElementById('actionGridModal');
        const titleEl = document.getElementById('modalActionTitle');
        const btnInvestir = document.getElementById('btnInvestir');
        const btnRelatorio = document.getElementById('btnRelatorio');
        const btnExportar = document.getElementById('btnExportar');
        const btnArquivar = document.getElementById('btnArquivar');
        const btnRedirecionar = document.getElementById('btnRedirecionar');
        const btnPrazo = document.getElementById('btnPrazo');
    
        // Configura Botão Arquivar
        const newBtnArquivar = btnArquivar.cloneNode(true);
        btnArquivar.parentNode.replaceChild(newBtnArquivar, btnArquivar);
        newBtnArquivar.onclick = function() {
            closeActionGridModal();
            openArchiveModal();
        };

        // Configura Botão Prazo
        const newBtnPrazo = btnPrazo.cloneNode(true);
        btnPrazo.parentNode.replaceChild(newBtnPrazo, btnPrazo);
        newBtnPrazo.onclick = function() {
            openPrazoModal();
        };
        
        // Configura Botão Clonar
        const btnClonar = document.getElementById('btnClonar');
        const newBtnClonar = btnClonar.cloneNode(true);
        btnClonar.parentNode.replaceChild(newBtnClonar, btnClonar);
        newBtnClonar.onclick = function() {
             openClonarModal();
        };

        // --- LÓGICA DE VISIBILIDADE DO REDIRECIONAR ---
        // Agora 'responsavelId' existe e não vai dar erro
        if (currentUserId == responsavelId && status !== 'CONCLUIDO' && status !== 'CANCELADO') {
            btnRedirecionar.style.display = 'flex';
            
            const newBtn = btnRedirecionar.cloneNode(true);
            btnRedirecionar.parentNode.replaceChild(newBtn, btnRedirecionar);
            
            newBtn.onclick = function() {
                openRedirecionarModal(responsavelNome);
            };
        } else {
            btnRedirecionar.style.display = 'none';
        }

        titleEl.textContent = `Plano #${id} - ${titulo}`;

        // Lógica de Visibilidade do Botão Investir
        if (status === 'EM_IMPLEMENTACAO') {
            btnInvestir.style.display = 'flex';
            
            const newBtnInvestir = btnInvestir.cloneNode(true);
            btnInvestir.parentNode.replaceChild(newBtnInvestir, btnInvestir);
            
            newBtnInvestir.onclick = function() {
                openInvestirModal();
            };
        } else {
            btnInvestir.style.display = 'none';
        }
        
        // Configura Botão Relatório
        if (auditoriaId && auditoriaId !== 'None' && auditoriaId !== '') {
            btnRelatorio.href = `/auditorias/historico/${auditoriaId}/visualizar`; 
            btnRelatorio.target = '_blank';
            btnRelatorio.style.pointerEvents = 'auto';
            btnRelatorio.style.opacity = '1';
        } else {
            btnRelatorio.href = '#';
            btnRelatorio.style.pointerEvents = 'none';
            btnRelatorio.style.opacity = '0.5';
        }

        btnExportar.href = 'javascript:void(0);';
        
        // --- LÓGICA DO BOTÃO ACEITAR ---
        const btnAceitar = document.getElementById('btnAceitar');
        const newBtnAceitar = btnAceitar.cloneNode(true);
        btnAceitar.parentNode.replaceChild(newBtnAceitar, btnAceitar);
        
        newBtnAceitar.onclick = function() {
            if (status === 'AGUARDANDO_VALIDACAO') {
                openAprovarModal(id); 
            } else if (status === 'EM_IMPLEMENTACAO') {
                openConcluirModal(); 
            } else if (status === 'AGUARDANDO_APROVACAO') {
                openFinalizarModal(); 
            } else if (status === 'VALIDACAO_EFICACIA') {
                openEficaciaModal(); 
            } else {
                openAceitarModal(); 
            }
        };
        
        newBtnAceitar.style.display = 'flex';

        // --- LÓGICA DO BOTÃO RECUSAR ---
        const btnRecusar = document.getElementById('btnRecusar');
        const newBtnRecusar = btnRecusar.cloneNode(true);
        btnRecusar.parentNode.replaceChild(newBtnRecusar, btnRecusar);
        
        newBtnRecusar.onclick = function() {
            openRecusarModal();
        };

        // EXIBE O MODAL
        modal.style.display = 'flex';
    }

    // --- NOVAS FUNÇÕES DE REDIRECIONAMENTO ---

    function openRedirecionarModal(nomeAtual) {
        closeActionGridModal();
        const modal = document.getElementById('modalRedirecionar');
        
        // Preenche o campo "De"
        document.getElementById('txtResponsavelAtual').textContent = nomeAtual || "Não definido";
        
        // Reset
        document.getElementById('selNovoResponsavel').value = "";
        document.getElementById('txtAcoesSugeridas').value = "";
        updateCharCountRedirecionar(document.getElementById('txtAcoesSugeridas'));
        
        modal.style.display = 'flex';
    }

    function closeRedirecionarModal() {
        document.getElementById('modalRedirecionar').style.display = 'none';
    }

    function updateCharCountRedirecionar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterRedirecionar').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarRedirecionar');
        const icon = document.getElementById('errorIconRedirecionar');
        const msg = document.getElementById('msgErroRedirecionar');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e';
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        }
    }

    function submitRedirecionar() {
        const novoResp = document.getElementById('selNovoResponsavel').value;
        const acoes = document.getElementById('txtAcoesSugeridas').value;

        if (!novoResp) {
            showToast("Selecione o novo responsável.", "error");
            return;
        }
        if (!acoes.trim()) {
            showToast("Ações sugeridas são obrigatórias.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarRedirecionar');
        btn.disabled = true;
        btn.innerText = "Redirecionando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/redirecionar/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                novo_responsavel: novoResp,
                acoes_sugeridas: acoes
            })
        })
        .then(async response => {
            if (response.ok) {
                closeRedirecionarModal();
                showToast("Ação redirecionada com sucesso!", "success");
                setTimeout(() => window.location.reload(), 1500);
            } else {
                throw new Error("Erro ao redirecionar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar solicitação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    const btnRecusar = document.getElementById('btnRecusar');
    
    // Clonar para limpar eventos anteriores
    const newBtnRecusar = btnRecusar.cloneNode(true);
    btnRecusar.parentNode.replaceChild(newBtnRecusar, btnRecusar);
    
    newBtnRecusar.onclick = function() {
        openRecusarModal();
    };
    
    /* --------------------------------------------------------- */

    // --- Novas Funções para o Modal de Aprovação (Auditor) ---

    function openAprovarModal(id) {
        closeActionGridModal(); // Fecha o grid
        const modal = document.getElementById('modalAprovarPlano');
        
        // Carrega os dados do plano para mostrar ao auditor
        // Reutilizamos a API de detalhes que já criamos
        fetch(`/auditorias/planos-de-acao/api/${id}/detalhes/`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('textoAcaoProposta').textContent = data.plano_acao || "Nenhuma ação descrita.";
                
                // Formata a data para exibir bonito (dd/mm/yyyy)
                let dataFormatada = data.data_prevista;
                if(dataFormatada && dataFormatada.includes('-')) {
                    const parts = dataFormatada.split('-');
                    dataFormatada = `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
                document.getElementById('textoDataProposta').textContent = dataFormatada || "Sem data";
                
                modal.style.display = 'flex';
            })
            .catch(err => {
                console.error(err);
                showToast("Erro ao carregar dados do plano.", "error");
            });
    }

    function closeAprovarModal() {
        document.getElementById('modalAprovarPlano').style.display = 'none';
    }

    function submitAprovacaoAuditor() {
        if (!currentActionId) return;

        const btn = document.getElementById('btnConfirmarAprovacao');
        btn.disabled = true;
        btn.innerText = "Confirmando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/aprovar-planejamento/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({}) // Corpo vazio, a ação é apenas confirmar
        })
        .then(async response => {
            if (response.ok) {
                closeAprovarModal();
                showToast("Planejamento aprovado! Plano em implementação.", "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao aprovar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar aprovação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    function closeActionGridModal() {
        document.getElementById('actionGridModal').style.display = 'none';
    }

    // --- Modal Detalhes (Engrenagem) ---
    function openDetailedModal(event, btnElement) {
        event.stopPropagation(); 
        
        // Resetar para aba inicial
        document.querySelector('.modal-tab:first-child').click();

        const modal = document.getElementById('modalDetalhes');
        const data = btnElement.dataset;
        currentActionId = data.id; // Garante que temos o ID globalmente

        currentPlanContext = {
            id: data.id,
            titulo: data.tituloPergunta, // Usamos o título da pergunta para o modal de ações
            status: data.statusCode, // Importante: Usa o código (ex: EM_IMPLEMENTACAO)
            auditoriaId: data.idAuditoria,
            responsavelId: data.responsavelId,
            responsavelNome: data.responsavel
        };

        // Preencher Aba 1 (Ações) - Dados estáticos do botão
        document.getElementById('detalheTitulo').textContent = data.tituloModal;
        setText('detalheId', data.id);
        setText('detalheIdAuditoria', data.idAuditoria);
        setText('detalheStatus', data.status);
        setText('detalheResponsavel', data.responsavel);
        setText('detalheAuditor', data.auditor);
        setText('detalheCategoria', data.categoria);
        setText('detalheLocal', data.local);
        setText('detalheDataInicio', data.inicio);
        setText('detalheDataFim', data.fim);

        // Preencher Aba 2 (Resolução) - Dados via AJAX
        carregarDadosResolucao(data.id);

        const orientacoesExtra = btnElement.dataset.orientacoesExtra;
        const origemOrientacao = btnElement.dataset.origemOrientacao;
        const divExtra = document.getElementById('grupoOrientacoesExtra');
        const labelExtra = divExtra.querySelector('label');
        const boxExtra = document.getElementById('detalheOrientacoesExtra');
        
        if (orientacoesExtra && orientacoesExtra.trim() !== "") {
            boxExtra.textContent = orientacoesExtra;
            
            // --- ESTILO PADRÃO (AMARELO/LARANJA) PARA AMBOS ---
            labelExtra.style.color = "#f59e0b"; // Laranja título
            boxExtra.style.borderColor = "#fcd34d"; // Borda amarela
            boxExtra.style.backgroundColor = "#fffbeb"; // Fundo amarelo claro
            boxExtra.style.color = "#92400e"; // Texto laranja escuro

            // --- DEFINIR APENAS O TEXTO ---
            if (origemOrientacao === 'REDIRECIONAMENTO') {
                labelExtra.textContent = "Orientações Adicionais (Redirecionamento)";
            } else {
                // Caso seja CLONAGEM ou Padrão
                labelExtra.textContent = "Orientações Adicionais (Clonagem)";
            }

            divExtra.style.display = 'flex'; 
        } else {
            divExtra.style.display = 'none'; 
        }

        modal.style.display = 'flex';
    }

    let activeForumId = null; // Variável global para o chat

    // --- Função para buscar dados da Resolução (AJAX) ---
    function carregarDadosResolucao(planoId) {
        // --- 1. Referências aos Elementos ---
        const elPergunta = document.getElementById('resPergunta');
        const elObservacao = document.getElementById('resObservacao');
        const elEvidencias = document.getElementById('resEvidencias'); // Fotos da Auditoria (Origem)
        
        const elCausa = document.getElementById('inputCausaRaiz');
        const elAcoes = document.getElementById('inputAcoes'); 
        const elAcoesRealizadas = document.getElementById('inputAcoesRealizadas'); 
        const elDataPrevista = document.getElementById('inputDataPrevista');
        
        // Elemento NOVO de leitura de evidências
        const elListaEvidenciasLeitura = document.getElementById('listaEvidenciasLeitura'); 
        
        const elListaInvestimentos = document.getElementById('listaInvestimentosVisual');
        const elTotalInvestimentos = document.getElementById('totalizadorInvestimentos');

        // --- 2. Limpeza Inicial ---
        if(elPergunta) elPergunta.textContent = "Carregando...";
        if(elObservacao) elObservacao.textContent = "...";
        if(elEvidencias) elEvidencias.innerHTML = '<span class="spinner"></span>';
        
        if(elCausa) elCausa.value = "";
        if(elAcoes) elAcoes.value = "";
        if(elAcoesRealizadas) elAcoesRealizadas.value = "";
        if(elDataPrevista) elDataPrevista.value = "";
        
        // Limpa a lista de leitura
        if(elListaEvidenciasLeitura) elListaEvidenciasLeitura.innerHTML = '<span style="font-size:12px; color:#999;">Buscando arquivos...</span>';
        
        if(elListaInvestimentos) elListaInvestimentos.innerHTML = '<div style="padding:15px; text-align:center; color:#666;">Carregando...</div>';
        if(elTotalInvestimentos) elTotalInvestimentos.style.display = 'none';

        // --- 3. Busca de Dados ---
        fetch(`/auditorias/planos-de-acao/api/${planoId}/detalhes/`)
            .then(r => r.json())
            .then(data => {

                // --- PARTE F: HISTÓRICO ---
                const timelineContainer = document.getElementById('timelineContainer');
                
                if (data.historico && data.historico.length > 0) {
                    timelineContainer.innerHTML = ''; // Limpa
                    
                    data.historico.forEach(item => {
                        // Define ícone/cor baseado no tipo (opcional, refinamento visual)
                        let markerClass = `marker-${item.tipo}`;
                        
                        const htmlItem = `
                            <div class="timeline-item">
                                <div class="timeline-marker ${markerClass}"></div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <div class="timeline-author">
                                            <div class="timeline-avatar">${item.avatar}</div>
                                            ${item.usuario}
                                        </div>
                                        <div class="timeline-date">
                                            <i class="far fa-clock"></i> ${item.data} às ${item.hora}
                                        </div>
                                    </div>
                                    <div class="timeline-body">
                                        ${item.descricao}
                                    </div>
                                </div>
                            </div>
                        `;
                        timelineContainer.insertAdjacentHTML('beforeend', htmlItem);
                    });
                } else {
                    timelineContainer.innerHTML = `
                        <div style="padding: 30px; text-align: center; color: #94a3b8; margin-left: -20px;">
                            <i class="fas fa-history" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>Nenhum histórico registrado ainda.</p>
                        </div>
                    `;
                }
                
                // A. Contexto
                if(elPergunta) elPergunta.textContent = data.auditoria_pergunta;
                if(elObservacao) elObservacao.textContent = data.auditoria_observacao || "Sem observações.";
                
                // B. Evidências da Auditoria (Origem)
                if(elEvidencias) {
                    elEvidencias.innerHTML = '';
                    if (data.auditoria_evidencias && data.auditoria_evidencias.length > 0) {
                        data.auditoria_evidencias.forEach(foto => {
                            const img = document.createElement('img');
                            img.src = foto.url;
                            img.className = 'evidence-thumb';
                            img.title = foto.nome;
                            img.onclick = () => window.open(foto.url, '_blank');
                            elEvidencias.appendChild(img);
                        });
                    } else {
                        elEvidencias.innerHTML = '<span style="font-size:12px; color:#999;">Sem evidências.</span>';
                    }
                }

                // C. Campos de Texto
                if(elCausa) elCausa.value = data.causa_raiz || "Não preenchido";
                if(elAcoes) elAcoes.value = data.plano_acao || "Não preenchido"; 
                if(elAcoesRealizadas) elAcoesRealizadas.value = data.acoes_realizadas || "";
                if(elDataPrevista) elDataPrevista.value = data.data_prevista || "";

                // D. Evidências de Conclusão (LEITURA APENAS)
                if(elListaEvidenciasLeitura) {
                    elListaEvidenciasLeitura.innerHTML = ''; // Limpa o "Carregando..."
                    
                    if (data.evidencias_conclusao && data.evidencias_conclusao.length > 0) {
                        data.evidencias_conclusao.forEach(arq => {
                            // Cria um card visual simples para cada arquivo
                            const item = `
                                <div style="display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e2e8f0; padding: 10px 15px; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                    <div style="display: flex; align-items: center; gap: 12px; overflow: hidden;">
                                        <div style="width: 36px; height: 36px; background: #e0f2fe; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #0284c7;">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-size: 13px; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">${arq.nome}</span>
                                            <span style="font-size: 11px; color: #64748b;">Evidência de conclusão</span>
                                        </div>
                                    </div>
                                    <a href="${arq.url}" target="_blank" class="btn btn-sm btn-secondary" style="text-decoration: none; padding: 6px 12px; font-size: 12px; border: 1px solid #cbd5e1; border-radius: 4px; color: #475569; display: flex; align-items: center; gap: 5px;">
                                        <i class="fas fa-download"></i> Baixar
                                    </a>
                                </div>
                            `;
                            elListaEvidenciasLeitura.insertAdjacentHTML('beforeend', item);
                        });
                    } else {
                        // Mensagem caso não tenha nada anexado ainda
                        elListaEvidenciasLeitura.innerHTML = `
                            <div style="padding: 15px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 6px; color: #94a3b8; font-size: 13px; text-align: center;">
                                <i class="fas fa-folder-open" style="margin-right: 6px;"></i> Nenhuma evidência foi anexada na conclusão.
                            </div>
                        `;
                    }
                }

                // E. Investimentos (Mantido)
                if(elListaInvestimentos) {
                    elListaInvestimentos.innerHTML = '';
                    if (data.investimentos && data.investimentos.length > 0) {
                        data.investimentos.forEach(inv => {
                            const valUnit = inv.valor_unitario.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            const valTotal = inv.valor_total.toLocaleString('pt-BR', {minimumFractionDigits: 2});

                            const htmlItem = `
                                <div style="display: flex; gap: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                                    <div style="flex: 1;">
                                        <label style="font-size: 12px; color: #555;">Descrição</label>
                                        <div class="form-value-box textarea-style" style="min-height: 80px; background-color: #e2e8f0; border: 1px solid #cbd5e1;">${inv.descricao}</div>
                                    </div>
                                    <div style="width: 200px; display: flex; flex-direction: column; gap: 8px;">
                                        <div>
                                            <label style="font-size: 12px; color: #555;">Valor Unitário</label>
                                            <div class="form-value-box" style="background-color: #e2e8f0;">R$ ${valUnit}</div>
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; color: #555;">Quantidade</label>
                                            <div class="form-value-box" style="background-color: #e2e8f0;">${inv.quantidade}</div>
                                        </div>
                                        <div>
                                            <label style="font-size: 12px; color: #555;">Total</label>
                                            <div class="form-value-box" style="background-color: #e2e8f0; font-weight: bold;">R$ ${valTotal}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            elListaInvestimentos.insertAdjacentHTML('beforeend', htmlItem);
                        });

                        if (data.total_investido > 0 && elTotalInvestimentos) {
                            document.getElementById('valorTotalGeral').textContent = data.total_investido.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                            elTotalInvestimentos.style.display = 'block';
                        }
                    } else {
                        elListaInvestimentos.innerHTML = `
                            <div style="padding: 20px; text-align: center; color: #94a3b8; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 6px;">
                                <i class="fas fa-search-dollar" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                                <p style="margin: 0; font-size: 13px;">Nenhum investimento registrado.</p>
                            </div>
                        `;
                    }
                }

                // SALVA O ID DO FÓRUM PARA O CHAT
                // Certifique-se de que sua view 'get_detalhes_plano' retorna 'forum_id'
                if (data.forum_id) {
                    activeForumId = data.forum_id;
                    // Se a aba de fórum já estiver ativa, carrega as mensagens
                    const abaForum = document.getElementById('tab-forum');
                    if (abaForum.classList.contains('active')) {
                        carregarMensagensForum();
                    }
                }
            })
            .catch(err => {
                console.error("Erro no carregamento:", err);
                if(elPergunta) elPergunta.textContent = "Erro ao carregar dados.";
            });
    }

    // --- Função Placeholder para Salvar Tratativa ---
    function salvarTratativa() {
        // Aqui você implementará o fetch POST para salvar os dados
        // Pode usar o ID global `currentActionId`
        showToast("Funcionalidade de salvar em desenvolvimento", "info");
        
        const causa = document.getElementById('inputCausaRaiz').value;
        const acao = document.getElementById('inputAcoes').value;
        console.log("Salvando:", causa, acao);
    }

    function setText(id, value) {
        const el = document.getElementById(id);
        if(el) el.textContent = value || '-';
    }

    function closeModalDetalhes() {
        document.getElementById('modalDetalhes').style.display = 'none';
    }

    // --- ARQUIVAMENTO ---

    function openArchiveModal() {
        const modal = document.getElementById('modalArquivar');
        const textarea = document.getElementById('motivoArquivamento');
        const btn = document.getElementById('btnConfirmarArquivar');
        
        // Reset
        textarea.value = '';
        textarea.classList.remove('valid');
        textarea.style.borderColor = '#dc2626'; // Vermelho inicial
        btn.disabled = true;
        
        document.getElementById('charCounter').textContent = '0/255';
        document.getElementById('checkIcon').style.display = 'none';
        
        modal.style.display = 'flex';
        textarea.focus();
    }

    // A FUNÇÃO QUE FALTAVA
    function closeArchiveModal() {
        const modal = document.getElementById('modalArquivar');
        if (modal) modal.style.display = 'none';
    }

    function updateCharCount(textarea) {
        const count = textarea.value.length;
        const counterEl = document.getElementById('charCounter');
        const checkIcon = document.getElementById('checkIcon');
        const btn = document.getElementById('btnConfirmarArquivar');
        
        counterEl.textContent = `${count}/255`;
        
        if (count > 0) {
            textarea.classList.add('valid');
            textarea.style.borderColor = '#22c55e'; // Verde
            checkIcon.style.display = 'block';
            btn.disabled = false;
        } else {
            textarea.classList.remove('valid');
            textarea.style.borderColor = '#dc2626'; // Vermelho
            checkIcon.style.display = 'none';
            btn.disabled = true;
        }
    }

    // --- FUNÇÃO PARA EXIBIR MENSAGEM TOAST ---
    function showToast(message, type = 'success') {
        // Cria o container se não existir
        let container = document.getElementById('toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toast-container';
            document.body.appendChild(container);
        }

        // Cria o elemento da notificação
        const toast = document.createElement('div');
        toast.className = `toast-notification ${type}`;
        
        // Ícone baseado no tipo
        const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
        
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                ${icon} <span>${message}</span>
            </div>
        `;

        container.appendChild(toast);

        // Remove automaticamente após 4 segundos
        setTimeout(() => {
            toast.style.animation = 'fadeOutRight 0.5s ease-out forwards';
            toast.addEventListener('animationend', () => {
                toast.remove();
            });
        }, 4000);
    }

    // --- FUNÇÃO DE ARQUIVAR ATUALIZADA ---
    function submitArquivamento() {
        const motivo = document.getElementById('motivoArquivamento').value;
        
        if (!currentActionId) {
            showToast("Erro: ID da ação não encontrado.", "error");
            return;
        }

        const url = `/auditorias/planos-de-acao/${currentActionId}/arquivar/`; 
        
        // Desativa o botão para evitar cliques duplos
        const btn = document.getElementById('btnConfirmarArquivar');
        btn.disabled = true;
        btn.textContent = "Arquivando...";

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ motivo: motivo })
        })
        .then(async response => {
            if (response.ok) {
                // SUCESSO!
                closeArchiveModal();
                
                try {
                    // Remove visualmente
                    removeRowFromTable(currentActionId);
                    // Exibe mensagem de sucesso
                    showToast("Plano de ação arquivado com sucesso!", "success");
                } catch (e) {
                    console.warn("Erro visual:", e);
                    window.location.reload();
                }
            } else {
                throw new Error("Erro na resposta do servidor.");
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast("Não foi possível arquivar. Tente novamente.", "error");
        })
        .finally(() => {
            // Restaura o botão (caso tenha dado erro e o modal continue aberto)
            if(document.getElementById('modalArquivar').style.display !== 'none') {
                btn.disabled = false;
                btn.textContent = "Arquivar";
            }
        });
    }

    function removeRowFromTable(id) {
        // Busca o botão de engrenagem que contém o ID correto
        const gearButton = document.querySelector(`button.btn-gear[data-id="${id}"]`);
        
        if (gearButton) {
            const row = gearButton.closest('tr');
            if (row) {
                row.style.transition = 'all 0.5s ease';
                row.style.opacity = '0';
                row.style.backgroundColor = '#fee2e2';
                setTimeout(() => {
                    row.remove();
                    // Verifica se a tabela ficou vazia e recarrega se necessário
                    const tbody = document.querySelector('#dataTable tbody');
                    if (tbody && tbody.children.length === 0) window.location.reload();
                }, 500);
            }
        } else {
            // Se não achou o botão (talvez paginação ou erro de DOM), recarrega para garantir
            window.location.reload();
        }
    }

    // --- Funções do Modal Aceitar Ação ---

    function openAceitarModal() {
        // Fecha o modal anterior (grid de botões)
        closeActionGridModal();
        
        const modal = document.getElementById('modalAceitarAcao');
        const textarea = document.getElementById('acoesPropostas');
        const dataInput = document.getElementById('dataFinalizacaoPrevista');
        
        // Limpar campos
        textarea.value = '';
        dataInput.value = '';
        updateCharCountAceitar(textarea); // Reseta validação visual

        if(document.getElementById('checkFluxoSimplificado')) {
            document.getElementById('checkFluxoSimplificado').checked = false;
        }
        
        modal.style.display = 'flex';
    }

    function closeAceitarModal() {
        document.getElementById('modalAceitarAcao').style.display = 'none';
    }

    function toggleEvidenciasAceitar() {
        const container = document.getElementById('containerEvidenciasAceitar');
        const icon = document.getElementById('iconEvidencias');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
        } else {
            container.style.display = 'none';
            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
        }
    }

    function updateCharCountAceitar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterAceitar').textContent = `${count}/255`;
        const btn = document.getElementById('btnConfirmarAceite');
        const errorIcon = document.getElementById('errorIconAceitar');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e'; // Verde
            errorIcon.style.display = 'none';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#b91c1c'; // Vermelho forte
        } else {
            textarea.style.borderColor = '#ef4444'; // Vermelho erro
            errorIcon.style.display = 'block';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.backgroundColor = '#cd5c5c'; // Vermelho claro
        }
    }

    function submitAceitarAcao(tipoBotao) {
        // 1. Captura os valores dos campos
        const causa = document.getElementById('causaRaizAceitar').value; // <--- NOVO
        const acoes = document.getElementById('acoesPropostas').value;
        const dataFim = document.getElementById('dataFinalizacaoPrevista').value;

        const isSimplificado = document.getElementById('checkFluxoSimplificado').checked;

        // 2. Validações
        if (!causa.trim()) {
            showToast("A Análise de Causa Raiz é obrigatória.", "error");
            return;
        }
        if (!acoes.trim()) {
            showToast("O campo de Ações Propostas é obrigatório.", "error");
            return;
        }
        if (!dataFim) {
            showToast("A Data Prevista é obrigatória.", "error");
            return;
        }

        // 3. Preparar dados para envio (Payload)
        const payload = {
            causa_raiz: causa,        // <--- ENVIANDO A CAUSA RAIZ AGORA
            acoes_propostas: acoes,
            data_finalizacao: dataFim,
            acao_botao: tipoBotao,
            fluxo_simplificado: isSimplificado
        };

        if (!currentActionId) {
            showToast("Erro: ID do plano perdido.", "error");
            return;
        }

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/aceitar/`;

        // Desativa botões para evitar duplo clique
        const btnConfirmar = document.getElementById('btnConfirmarAceite');
        const originalText = btnConfirmar.innerText;
        btnConfirmar.disabled = true;
        btnConfirmar.innerText = "Salvando...";

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(async response => {
            if (response.ok) {
                closeAceitarModal();
                showToast("Ação aceita e enviada para validação!", "success");
                
                // Recarregar a página para atualizar status na tabela e mover para o card correto
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar a solicitação.", "error");
            // Reativa o botão em caso de erro
            btnConfirmar.disabled = false;
            btnConfirmar.innerText = originalText;
        });
    }

    function openInvestirModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalInvestir');
        const container = document.getElementById('containerInvestimentos');
        
        // Limpa e adiciona a primeira linha obrigatória
        container.innerHTML = ''; 
        adicionarLinhaInvestimento(); 
        
        atualizarTotalGeral();
        modal.style.display = 'flex';
    }

    function closeInvestirModal() {
        document.getElementById('modalInvestir').style.display = 'none';
    }

    // Função que cria o HTML de uma nova linha
    function adicionarLinhaInvestimento() {
        const container = document.getElementById('containerInvestimentos');
        const index = container.children.length + 1; // Apenas para IDs únicos se precisar

        const row = document.createElement('div');
        row.className = 'investimento-row';
        row.innerHTML = `
            <button type="button" class="btn-delete-row" onclick="removerLinhaInvestimento(this)" title="Remover item">
                <i class="fas fa-trash"></i>
            </button>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="input-wrapper-archive">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <label style="font-size: 13px; font-weight: 600; color: #555;">Descrição</label>
                        <span class="char-counter" style="font-size: 11px; color: #999;">0/255</span>
                    </div>
                    <textarea class="form-control inv-descricao" rows="4" maxlength="255" 
                              style="resize: none;" placeholder="Descreva o item..."
                              oninput="atualizarContadorLinha(this)"></textarea>
                </div>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="font-size: 13px; color: #555;">Quantidade</label>
                        <input type="number" class="form-control inv-qtd" value="1" min="1" oninput="calcularTotalLinha(this)">
                    </div>
                    <div>
                        <label style="font-size: 13px; color: #555;">Preço Unitário</label>
                        <div class="input-group-text">
                            <span style="padding: 10px; background: #f8fafc; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px;">R$</span>
                            <input type="number" class="form-control inv-preco" step="0.01" placeholder="0,00" style="border-radius: 0 4px 4px 0;" oninput="calcularTotalLinha(this)">
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 13px; color: #555;">Total</label>
                        <div class="input-group-text">
                            <span style="padding: 10px; background: #e2e8f0; border: 1px solid #ccc; border-right: none; border-radius: 4px 0 0 4px;">R$</span>
                            <input type="text" class="form-control inv-total" readonly style="background-color: #e2e8f0; border-radius: 0 4px 4px 0; font-weight: bold;" value="0,00">
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        container.appendChild(row);
        
        // Foca na descrição da nova linha
        const textarea = row.querySelector('.inv-descricao');
        textarea.focus();
        
        verificarBotoesExclusao();
    }

    function removerLinhaInvestimento(btn) {
        const container = document.getElementById('containerInvestimentos');
        
        // Impede deletar se for a única linha (embora a função verificarBotoesExclusao já esconda o botão)
        if (container.children.length <= 1) {
            showToast("É necessário pelo menos um item de investimento.", "warning");
            return;
        }

        // Remove a linha (div pai do botão)
        btn.closest('.investimento-row').remove();
        
        verificarBotoesExclusao();
        atualizarTotalGeral();
    }

    // Esconde o botão de excluir se só tiver 1 linha
    function verificarBotoesExclusao() {
        const linhas = document.querySelectorAll('.investimento-row');
        linhas.forEach(linha => {
            const btn = linha.querySelector('.btn-delete-row');
            if (linhas.length === 1) {
                btn.style.display = 'none';
            } else {
                btn.style.display = 'flex';
            }
        });
    }

    function calcularTotalLinha(input) {
        // Encontra a linha pai do input que foi alterado
        const row = input.closest('.investimento-row');
        
        const qtd = parseFloat(row.querySelector('.inv-qtd').value) || 0;
        const preco = parseFloat(row.querySelector('.inv-preco').value) || 0;
        const total = qtd * preco;

        // Atualiza o campo total daquela linha
        row.querySelector('.inv-total').value = total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        atualizarTotalGeral();
    }

    function atualizarTotalGeral() {
        let totalGeral = 0;
        document.querySelectorAll('.investimento-row').forEach(row => {
            const qtd = parseFloat(row.querySelector('.inv-qtd').value) || 0;
            const preco = parseFloat(row.querySelector('.inv-preco').value) || 0;
            totalGeral += (qtd * preco);
        });
        
        document.getElementById('totalGeralInvest').textContent = 
            totalGeral.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function atualizarContadorLinha(textarea) {
        const count = textarea.value.length;
        // Acha o contador dentro da mesma div wrapper
        const counter = textarea.closest('.input-wrapper-archive').querySelector('.char-counter');
        counter.textContent = `${count}/255`;
        
        if (count > 0) {
            textarea.style.borderColor = '#ccc';
            counter.style.color = '#15803d';
        } else {
            textarea.style.borderColor = '#ef4444';
            counter.style.color = '#ef4444';
        }
    }

    function submitInvestimentoEmLote() {
        const linhas = document.querySelectorAll('.investimento-row');
        const payload = [];
        let erroValidacao = false;

        linhas.forEach((row, index) => {
            const descricao = row.querySelector('.inv-descricao').value.trim();
            const qtd = row.querySelector('.inv-qtd').value;
            const preco = row.querySelector('.inv-preco').value;

            if (!descricao || !qtd || !preco) {
                row.style.border = "1px solid #ef4444"; // Marca a linha com erro
                erroValidacao = true;
            } else {
                row.style.border = "1px solid #e2e8f0"; // Remove marcação
                payload.push({
                    descricao: descricao,
                    quantidade: qtd,
                    preco: preco
                });
            }
        });

        if (erroValidacao) {
            showToast("Preencha todos os campos obrigatórios em todas as linhas.", "error");
            return;
        }

        if (payload.length === 0) return;

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/investir/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(async response => {
            if (response.ok) {
                closeInvestirModal();
                showToast(`${payload.length} investimento(s) salvo(s) com sucesso!`, "success");
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao registrar investimentos.", "error");
        });
    }
    // Array para armazenar os arquivos selecionados temporariamente
    let arquivosParaUpload = [];

    function openConcluirModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalConcluir');
        
        // Resetar campos
        document.getElementById('acoesRealizadas').value = '';
        document.getElementById('inputEvidenciasFile').value = '';
        document.getElementById('listaArquivosUpload').innerHTML = '';
        arquivosParaUpload = []; // Limpa array
        
        updateCharCountConcluir(document.getElementById('acoesRealizadas'));
        modal.style.display = 'flex';
    }

    function closeConcluirModal() {
        document.getElementById('modalConcluir').style.display = 'none';
    }

    function updateCharCountConcluir(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterConcluir').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarConclusao');
        const icon = document.getElementById('errorIconConcluir');
        const msg = document.getElementById('msgErroAcoes');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e'; // Verde
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#b91c1c';
        } else {
            textarea.style.borderColor = '#ef4444'; // Vermelho
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.backgroundColor = '#cd5c5c';
        }
    }

    // Gerencia a seleção de arquivos e exibe na tela
    function handleFileSelect(input) {
        const files = Array.from(input.files);
        const lista = document.getElementById('listaArquivosUpload');
        const msgErro = document.getElementById('msgErroEvidencias');

        files.forEach(file => {
            // Adiciona ao array global
            arquivosParaUpload.push(file);

            // Cria elemento visual
            const item = document.createElement('div');
            item.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; padding: 8px 12px; border-radius: 4px; font-size: 13px;";
            item.innerHTML = `
                <span><i class="fas fa-paperclip" style="color: #666; margin-right: 6px;"></i> ${file.name}</span>
                <i class="fas fa-times" style="color: #ef4444; cursor: pointer;" onclick="removerArquivo(this, '${file.name}')"></i>
            `;
            lista.appendChild(item);
        });

        if (arquivosParaUpload.length > 0) msgErro.style.display = 'none';
    }

    function removerArquivo(btnElement, fileName) {
        // Remove do array
        arquivosParaUpload = arquivosParaUpload.filter(f => f.name !== fileName);
        // Remove visualmente
        btnElement.parentElement.remove();
    }

    function submitConclusao() {
        const acoes = document.getElementById('acoesRealizadas').value;
        const msgErroEvidencias = document.getElementById('msgErroEvidencias');

        // Validação Final
        if (!acoes.trim()) {
            showToast("O campo de Ações Realizadas é obrigatório.", "error");
            return;
        }
        if (arquivosParaUpload.length === 0) {
            msgErroEvidencias.style.display = 'block';
            showToast("É obrigatório anexar pelo menos uma evidência.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarConclusao');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        // Usamos FormData para enviar arquivos
        const formData = new FormData();
        formData.append('acoes_realizadas', acoes);
        
        arquivosParaUpload.forEach(file => {
            formData.append('evidencias', file);
        });

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/concluir/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
                // Não definir Content-Type aqui, o browser define automaticamente para multipart/form-data
            },
            body: formData
        })
        .then(async response => {
            if (response.ok) {
                closeConcluirModal();
                showToast("Implementação concluída! Aguardando aprovação.", "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar a solicitação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    // --- LÓGICA DE FINALIZAÇÃO (AG_APROVACAO -> CONCLUIDO ou VAL_EFICACIA) ---

    function openFinalizarModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalFinalizar');
        // Reseta para a primeira opção sempre que abrir
        document.querySelector('input[name="decisaoFinal"][value="finalizar"]').checked = true;
        modal.style.display = 'flex';
    }

    function closeFinalizarModal() {
        document.getElementById('modalFinalizar').style.display = 'none';
    }

    function submitDecisaoAuditor() {
        // Pega o valor do radio selecionado
        const decisao = document.querySelector('input[name="decisaoFinal"]:checked').value;
        
        const btn = document.getElementById('btnConfirmarFinalizacao');
        btn.disabled = true;
        btn.innerText = "Processando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/avaliar-conclusao/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ decisao: decisao })
        })
        .then(async response => {
            if (response.ok) {
                closeFinalizarModal();
                let msg = decisao === 'finalizar' 
                    ? "Plano de ação concluído com sucesso!" 
                    : "Plano enviado para validação de eficácia.";
                
                showToast(msg, "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar decisão.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao processar solicitação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    // --- LÓGICA DE EFICÁCIA (VALIDACAO_EFICACIA -> CONCLUIDO) ---
    
    let arquivosEficacia = [];

    function openEficaciaModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalEficacia');
        
        // Reset
        document.getElementById('obsEficacia').value = '';
        document.getElementById('listaArquivosEficacia').innerHTML = '';
        arquivosEficacia = [];
        
        updateCharCountEficacia(document.getElementById('obsEficacia'));
        modal.style.display = 'flex';
    }

    function closeEficaciaModal() {
        document.getElementById('modalEficacia').style.display = 'none';
    }

    function updateCharCountEficacia(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterEficacia').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarEficacia');
        const icon = document.getElementById('errorIconEficacia');
        const msg = document.getElementById('msgErroEficacia');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e';
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#b91c1c';
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.style.backgroundColor = '#cd5c5c';
        }
    }

    function handleFileSelectEficacia(input) {
        const files = Array.from(input.files);
        const lista = document.getElementById('listaArquivosEficacia');

        files.forEach(file => {
            arquivosEficacia.push(file);
            const item = document.createElement('div');
            item.style.cssText = "display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; padding: 8px 12px; border-radius: 4px; font-size: 13px;";
            item.innerHTML = `
                <span><i class="fas fa-paperclip" style="color: #666; margin-right: 6px;"></i> ${file.name}</span>
                <i class="fas fa-times" style="color: #ef4444; cursor: pointer;" onclick="removerArquivoEficacia(this, '${file.name}')"></i>
            `;
            lista.appendChild(item);
        });
    }

    function removerArquivoEficacia(btnElement, fileName) {
        arquivosEficacia = arquivosEficacia.filter(f => f.name !== fileName);
        btnElement.parentElement.remove();
    }

    function submitEficacia() {
        const obs = document.getElementById('obsEficacia').value;
        
        if (!obs.trim()) {
            showToast("Observação é obrigatória.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarEficacia');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const formData = new FormData();
        formData.append('observacao_eficacia', obs);
        
        arquivosEficacia.forEach(file => {
            formData.append('evidencias', file);
        });

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/validar-eficacia/`;

        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
        })
        .then(async response => {
            if (response.ok) {
                closeEficaciaModal();
                showToast("Ciclo finalizado! Plano de ação concluído.", "success");
                // Ao recarregar, o item deve sumir da lista pois está CONCLUIDO
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao finalizar processo.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    // --- LÓGICA DE RECUSA ---

    function openRecusarModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalRecusar');
        const textarea = document.getElementById('motivoRecusa');
        
        // Reset
        textarea.value = '';
        updateCharCountRecusar(textarea);
        
        modal.style.display = 'flex';
        textarea.focus();
    }

    function closeRecusarModal() {
        document.getElementById('modalRecusar').style.display = 'none';
    }

    function updateCharCountRecusar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterRecusar').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarRecusa');
        const icon = document.getElementById('errorIconRecusar');
        const msg = document.getElementById('msgErroRecusa');

        if (count > 0) {
            textarea.style.borderColor = '#ccc';
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            btn.disabled = false;
            btn.style.opacity = '1';
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        }
    }

    function submitRecusa() {
        const motivo = document.getElementById('motivoRecusa').value;
        
        if (!motivo.trim()) {
            showToast("O motivo da recusa é obrigatório.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarRecusa');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/recusar/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ motivo: motivo })
        })
        .then(async response => {
            if (response.ok) {
                closeRecusarModal();
                
                // --- FEEDBACK PARA O USUÁRIO ---
                // Usa o tipo 'success' para ficar Verde
                showToast("Ação recusada com sucesso.", "success"); 
                
                // Recarrega a página para atualizar a lista (item some ou muda de status)
                setTimeout(() => window.location.reload(), 1500);
            } else {
                throw new Error("Erro ao recusar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Não foi possível recusar a ação.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar Recusa";
        });
    }

    function openClonarModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalClonar');
        
        // Reset
        document.getElementById('clonarResponsavel').value = "";
        document.getElementById('clonarOrientacoes').value = "";
        updateCharCountClonar(document.getElementById('clonarOrientacoes'));
        
        modal.style.display = 'flex';
    }

    function closeClonarModal() {
        document.getElementById('modalClonar').style.display = 'none';
    }

    function updateCharCountClonar(textarea) {
        const count = textarea.value.length;
        document.getElementById('charCounterClonar').textContent = `${count}/255`;
        
        const btn = document.getElementById('btnConfirmarClonar');
        const icon = document.getElementById('errorIconClonar');
        const msg = document.getElementById('msgErroClonar');

        if (count > 0) {
            textarea.style.borderColor = '#22c55e'; // Verde se preenchido
            icon.style.display = 'none';
            msg.style.visibility = 'hidden';
            document.getElementById('charCounterClonar').style.color = '#22c55e';
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.backgroundColor = '#db5461'; // Rosa escuro/Vermelho suave
        } else {
            textarea.style.borderColor = '#ef4444';
            icon.style.display = 'block';
            msg.style.visibility = 'visible';
            document.getElementById('charCounterClonar').style.color = '#ef4444';
            btn.disabled = true;
            btn.style.opacity = '0.7';
        }
    }

    function submitClonar() {
        const responsavel = document.getElementById('clonarResponsavel').value;
        const orientacoes = document.getElementById('clonarOrientacoes').value;

        if (!responsavel) {
            showToast("Selecione um novo responsável.", "error");
            return;
        }
        if (!orientacoes.trim()) {
            showToast("Orientações são obrigatórias.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarClonar');
        btn.disabled = true;
        btn.innerText = "Clonando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/clonar/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                novo_responsavel: responsavel,
                orientacoes: orientacoes
            })
        })
        .then(async response => {
            if (response.ok) {
                closeClonarModal();
                showToast("Plano clonado com sucesso! Uma nova tarefa foi criada.", "success");
                setTimeout(() => window.location.reload(), 1500);
            } else {
                throw new Error("Erro ao clonar.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao clonar ação.", "error");
            btn.disabled = false;
            btn.innerText = "Clonar";
        });
    }

    function openPrazoModal() {
        closeActionGridModal();
        const modal = document.getElementById('modalAlterarPrazo');
        const inputData = document.getElementById('novaDataEncerramento');
        
        // Limpa o campo
        inputData.value = '';
        
        // Opcional: Adicionar foco visual extra
        inputData.addEventListener('focus', () => {
            inputData.style.boxShadow = '0 0 0 3px rgba(147, 197, 253, 0.5)'; // Anel azul claro
        });
        inputData.addEventListener('blur', () => {
            inputData.style.boxShadow = 'none';
        });

        modal.style.display = 'flex';
    }

    function closePrazoModal() {
        document.getElementById('modalAlterarPrazo').style.display = 'none';
    }

    function submitNovoPrazo() {
        const novaData = document.getElementById('novaDataEncerramento').value;
        
        if (!novaData) {
            showToast("Selecione uma data válida.", "error");
            return;
        }

        const btn = document.getElementById('btnConfirmarPrazo');
        btn.disabled = true;
        btn.innerText = "Salvando...";

        const url = `/auditorias/planos-de-acao/api/${currentActionId}/alterar-prazo/`;

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ nova_data: novaData })
        })
        .then(async response => {
            if (response.ok) {
                closePrazoModal();
                showToast("Data de encerramento atualizada com sucesso!", "success");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                throw new Error("Erro ao salvar data.");
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro ao alterar data.", "error");
            btn.disabled = false;
            btn.innerText = "Confirmar";
        });
    }

    function carregarMensagensForum() {
        if (!activeForumId) return;

        const container = document.getElementById('forumMessagesArea');
        // Não limpa o container imediatamente para evitar "piscar" se for refresh automático
        // container.innerHTML = '...'; 

        fetch(`/auditorias/planos-de-acao/api/forum/${activeForumId}/mensagens/`) 
            .then(r => r.json())
            .then(data => {
                const mensagens = data.mensagens;
                container.innerHTML = ''; // Agora limpa

                if (mensagens.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; margin-top: 40px;">Nenhuma mensagem ainda. Inicie a conversa!</div>';
                    return;
                }

                mensagens.forEach(msg => {
                    // Lógica visual: Minha mensagem (me) vs Outros
                    const isMe = msg.is_me;
                    const cssClass = isMe ? 'me' : '';
                    
                    // Avatar: Primeira letra ou ícone
                    // Supondo que msg.autor venha como string "Nome Sobrenome"
                    const avatarLetter = msg.autor ? msg.autor.charAt(0).toUpperCase() : '?';
                    // Cor do avatar (aleatória fixa baseada no nome seria ideal, mas fixo serve)
                    const avatarColor = isMe ? '#334155' : '#c4b5fd'; 

                    const html = `
                        <div class="forum-msg-item ${cssClass}">
                            <div class="forum-avatar" style="background-color: ${avatarColor};">
                                ${avatarLetter}
                            </div>
                            <div class="forum-msg-content">
                                <div class="forum-msg-meta">
                                    ${msg.autor} • ${msg.data_envio}
                                </div>
                                <div class="forum-msg-bubble">
                                    ${msg.conteudo}
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });

                // Rola para o final
                container.scrollTop = container.scrollHeight;
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = '<div style="color:red; text-align:center;">Erro ao carregar mensagens.</div>';
            });
    }

    function enviarMensagemForum() {
        const input = document.getElementById('forumInputMsg');
        const texto = input.value.trim();

        if (!texto || !activeForumId) return;

        // Feedback visual imediato (Opcional, ou espera o servidor)
        input.disabled = true;

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(`/auditorias/planos-de-acao/api/forum/${activeForumId}/enviar/`, { 
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' // Use a tag do Django
            },
            body: JSON.stringify({ conteudo: texto })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                input.value = ''; // Limpa input
                carregarMensagensForum(); // Recarrega lista
            } else {
                showToast("Erro ao enviar mensagem.", "error");
            }
        })
        .catch(err => {
            console.error(err);
            showToast("Erro de conexão.", "error");
        })
        .finally(() => {
            input.disabled = false;
            input.focus();
        });
    }

    // --- Função chamada pelo botão "..." do Modal de Detalhes ---
    function openOptionsFromDetails() {
        // 1. Fecha o modal de detalhes (Engrenagem)
        closeModalDetalhes();

        // 2. Abre o modal de ações (Grid) usando os dados salvos
        // Verifica se temos os dados necessários
        if (currentPlanContext.id) {
            // Pequeno delay para a transição visual ficar suave (opcional)
            setTimeout(() => {
                openActionGrid(
                    currentPlanContext.id,
                    currentPlanContext.titulo,
                    currentPlanContext.status,
                    currentPlanContext.auditoriaId,
                    currentPlanContext.responsavelId,
                    currentPlanContext.responsavelNome
                );
            }, 100);
        } else {
            console.error("Dados do contexto perdidos.");
        }
    }

    // --- LÓGICA DO NOVO PLANO ---

    function openModalNovoPlano() {
        document.getElementById('modalNovoPlano').style.display = 'flex';
    }

    function closeModalNovoPlano() {
        document.getElementById('modalNovoPlano').style.display = 'none';
    }

    function updateCounter(input, counterId) {
        const max = input.getAttribute('maxlength');
        const current = input.value.length;
        const counter = document.getElementById(counterId);
        counter.textContent = `${current}/${max}`;
        
        if (current === 0) {
            counter.style.color = '#ef4444';
            input.classList.add('error');
        } else {
            counter.style.color = '#22c55e';
            input.classList.remove('error');
        }
    }

    function updateFileList(input) {
        const list = document.getElementById('newFileList');
        list.innerHTML = '';
        if (input.files.length > 0) {
            for (let i = 0; i < input.files.length; i++) {
                list.innerHTML += `<div style="margin-bottom:4px;"><i class="fas fa-paperclip"></i> ${input.files[i].name}</div>`;
            }
        }
    }

    function submitNovoPlano() {
        const form = document.getElementById('formNovoPlano');
        const formData = new FormData(form);
        
        // Validações
        const titulo = document.getElementById('newTitulo');
        const categoria = document.getElementById('newCategoria');
        const responsavel = document.getElementById('newResponsavel');
        const dataFim = document.querySelector('input[name="data_fim"]');

        let hasError = false;

        if(!titulo.value.trim()) { titulo.classList.add('error'); hasError = true; }
        if(!categoria.value) { categoria.classList.add('error'); hasError = true; }
        if(!responsavel.value) { responsavel.classList.add('error'); hasError = true; }
        if(!dataFim.value) { dataFim.classList.add('error'); hasError = true; }

        if(hasError) {
            showToast("Preencha os campos obrigatórios em vermelho.", "error");
            return;
        }

        const btn = event.target;
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Salvando...";

        fetch("{% url 'auditorias:criar_plano_manual' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if(data.status === 'success') {
                showToast(data.message, "success");
                closeModalNovoPlano();
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showToast(data.message || "Erro ao criar plano.", "error");
                btn.disabled = false;
                btn.innerText = originalText;
            }
        })
        .catch(error => {
            console.error(error);
            showToast("Erro de conexão.", "error");
            btn.disabled = false;
            btn.innerText = originalText;
        });
    }

    // Opcional: Lógica simples para o select de Nível
    // Como no seu modelo o 'Local' do plano é um SubSetor,
    // o nível aqui serve mais como filtro visual ou metadado se quiser expandir depois.
    function filtrarLocais() {
        // Por enquanto, mantém todos os subsetores visíveis, 
        // ou você pode implementar uma chamada AJAX aqui se quiser filtrar
        // subsetores baseados na seleção (ex: filtrar por Empresa se selecionado Empresa).
        // Para simplificar e manter funcional:
        console.log("Filtro de nível alterado - Implementar filtro dinâmico se necessário.");
    }

    // Fechar modais ao clicar fora
    window.onclick = function(event) {
        const modalGrid = document.getElementById('actionGridModal');
        const modalDetalhes = document.getElementById('modalDetalhes');
        const modalArquivar = document.getElementById('modalArquivar');
        
        if (event.target == modalGrid) closeActionGridModal();
        if (event.target == modalDetalhes) closeModalDetalhes();
        if (event.target == modalArquivar) closeArchiveModal();
    }
    </script>
{% endblock %}