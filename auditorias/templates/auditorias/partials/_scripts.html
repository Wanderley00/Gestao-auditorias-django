<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
    // ===============================================
    // FUNÇÕES GLOBAIS (Válidas para todas as páginas)
    // ===============================================

    // Função para confirmar exclusão
    function confirmDelete(url, itemName) {
        const modal = document.getElementById('deleteModal');
        if (!modal) return;
        
        const form = modal.querySelector('#deleteForm');
        const nameSpan = modal.querySelector('#deleteItemName');
        
        form.action = url; // Define a URL de exclusão no formulário
        nameSpan.textContent = `"${itemName}"`; // Mostra o nome do item
        modal.style.display = 'flex';
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        if (modal) modal.style.display = 'none';
    }
    
    // Função para abrir o modal de redirecionamento
    function openRedirectModal(formUrl, currentResponsavelId, allUsers) {
        const modal = document.getElementById('redirectModal');
        const form = document.getElementById('redirectForm');
        const select = document.getElementById('responsavel_select');

        if (!modal || !form || !select) {
            console.error('Elementos do modal de redirecionamento não encontrados!');
            return;
        }

        form.action = formUrl;

        select.innerHTML = '<option value="">Selecione um auditor...</option>';
        allUsers.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            // Corrigido para lidar com nomes nulos ou vazios
            option.textContent = user.name.trim() ? user.name : `(Usuário ${user.id})`;
            if (user.id == currentResponsavelId) {
                option.selected = true;
            }
            select.appendChild(option);
        });

        modal.style.display = 'flex';
    }

    function closeRedirectModal() {
        const modal = document.getElementById('redirectModal');
        if (modal) modal.style.display = 'none';
    }

    // Funções de UI (sidebar, alertas, etc)
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide de alertas
        document.querySelectorAll('.alert').forEach(alert => {
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        });

        // Lógica de fechar modal de delete ao clicar fora
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
            deleteModal.addEventListener('click', function(e) {
                if (e.target === this) closeDeleteModal();
            });
        }

        // Lógica de fechar modal de redirect ao clicar fora
        const redirectModal = document.getElementById('redirectModal');
        if (redirectModal) {
            redirectModal.addEventListener('click', function(e) {
                if (e.target === this) closeRedirectModal();
            });
        }
        
        // Lógica de filtro da sidebar
        const searchInput = document.getElementById('sidebarSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const filterText = this.value.toLowerCase().trim();
                document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => {
                    const itemText = item.querySelector('.nav-item-text').textContent.toLowerCase();
                    item.style.display = itemText.includes(filterText) ? 'flex' : 'none';
                });
            });
        }
    });
</script>

{% block extra_js %}{% endblock %}