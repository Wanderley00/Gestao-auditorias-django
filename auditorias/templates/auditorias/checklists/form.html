{% extends 'auditorias/base.html' %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-light: #3b82f6;
        --secondary: #f8fafc;
        --accent: #059669;
        --error: #dc2626;
        --text-primary: #0f172a;
        --text-secondary: #475569;
        --text-muted: #64748b;
        --border: rgba(255, 255, 255, 0.2);
        --border-focus: #93c5fd;
        --bg-primary: rgba(255, 255, 255, 0.95);
        --bg-secondary: #f1f5f9;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 16px;
        --radius-xl: 20px;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
    }

    .form-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-xl);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin: 20px;
        overflow: hidden;
    }

    .content-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 2rem;
        position: relative;
        overflow: hidden;
    }

    .content-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
        pointer-events: none;
    }

    .content-header .header-content {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .content-title {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        letter-spacing: -0.03em;
        color: white;
    }

    .content-subtitle {
        font-size: 1rem;
        color: white;
        opacity: 0.9;
        font-weight: 400;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        border: none;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        position: relative;
        overflow: hidden;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
        box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.9);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: var(--shadow-md);
    }
    
    .btn-sm {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: var(--radius-sm);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--error) 0%, #b91c1c 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
    }

    .btn-danger:hover {
        box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);
    }

    .card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow-md);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
    }

    .card-body {
        padding: 2rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .form-row.single {
        grid-template-columns: 1fr;
    }

    .form-group {
        position: relative;
    }

    .form-group.required .form-label::after {
        content: '*';
        color: var(--error);
        margin-left: 4px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        letter-spacing: -0.01em;
    }

    .input-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .form-control {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-md);
        padding: 16px 20px;
        color: var(--text-primary);
        font-size: 15px;
        font-weight: 500;
        width: 100%;
        outline: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }
    
    .form-control.validation-error {
        border-color: var(--error);
        animation: shake 0.3s;
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-4px); }
        75% { transform: translateX(4px); }
    }

    .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1), 0 4px 20px rgba(37, 99, 235, 0.1);
        background: rgba(255, 255, 255, 0.98);
    }

    .form-control.error {
        border-color: var(--error);
        box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ccc;
        border-radius: 34px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background: white;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input:checked + .toggle-slider {
        background: var(--primary);
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    /* Tabs styling */
    .tabs-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-xl);
        padding: 0;
        margin-top: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    .tabs-header {
        display: flex;
        border-bottom: 2px solid rgba(37, 99, 235, 0.1);
    }

    .tab-btn {
        flex: 1;
        padding: 1.5rem 2rem;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: none;
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .tab-btn:hover {
        background: rgba(37, 99, 235, 0.05);
    }

    .tab-btn.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: white;
    }

    .tab-content {
        display: none;
        padding: 2rem;
    }

    .tab-content.active {
        display: block;
    }

    .checklist-manager {
        background: rgba(255, 255, 255, 0.92);
        border-radius: var(--radius-xl);
        padding: 2.5rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: var(--shadow-lg);
        position: relative;
        overflow: hidden;
    }

    .checklist-manager::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 20% 80%, rgba(37, 99, 235, 0.03) 0%, transparent 50%);
        pointer-events: none;
    }

    .manager-header {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid rgba(37, 99, 235, 0.1);
        position: relative;
        z-index: 2;
    }

    .manager-header h4 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.02em;
    }

    .checklist-body {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        z-index: 2;
    }

    .topic-wrapper {
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
        overflow: hidden;
    }

    .topic-wrapper:hover {
        box-shadow: var(--shadow-lg);
    }

    .topic-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.5rem 2rem;
        position: relative;
        overflow: hidden;
    }

    .topic-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(circle at 30% 20%, rgba(255, 255, 255, 0.08) 0%, transparent 50%);
        pointer-events: none;
    }

    .topic-header-controls {
        position: relative;
        z-index: 2;
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .topic-header .form-control {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        flex: 1;
    }

    .topic-header .form-control::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .topic-header .form-control:focus {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .questions-container {
        padding: 2rem;
        background: rgba(248, 250, 252, 0.8);
    }

    .question-card {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
    }

    .question-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    }

    .question-card:hover {
        transform: translateX(2px);
        box-shadow: var(--shadow-md);
        border-color: rgba(37, 99, 235, 0.2);
    }

    .question-card textarea {
        resize: vertical;
        min-height: 80px;
        margin-bottom: 1rem;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin: 1rem 0;
        padding: 1rem;
        background: rgba(248, 250, 252, 0.6);
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-sm);
        border: 1px solid rgba(255, 255, 255, 0.3);
        cursor: pointer;
    }

    .checkbox-item:hover {
        background: rgba(255, 255, 255, 1);
        box-shadow: var(--shadow-sm);
    }

    .checkbox-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        accent-color: var(--primary);
    }

    .checkbox-item label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
        cursor: pointer;
        margin: 0;
    }

    .question-footer {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px dashed rgba(37, 99, 235, 0.2);
    }

    .options-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(248, 250, 252, 0.7);
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .options-section h5 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .options-section h5::before {
        content: '‚öôÔ∏è';
        font-size: 16px;
    }

    .option-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.9);
        border-radius: var(--radius-md);
        margin-bottom: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .option-item.resposta { grid-template-columns: auto 2fr 1fr auto; }
    .option-item.porcentagem { grid-template-columns: auto 2fr 1fr 1fr auto; }

    .option-item:hover {
        background: rgba(255, 255, 255, 0.98);
        transform: translateX(2px);
        box-shadow: var(--shadow-sm);
    }
    
    .option-controls {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .option-controls .btn {
        padding: 4px;
        width: 24px;
        height: 24px;
        font-size: 12px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid #e2e8f0;
    }
    .option-controls .btn:hover {
        background: #e2e8f0;
    }
     .option-controls .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    @media (max-width: 768px) {
        .form-container {
            margin: 10px;
        }

        .content-header {
            padding: 1.5rem;
        }

        .content-header .header-content {
            flex-direction: column;
            gap: 1rem;
            align-items: flex-start;
        }

        .content-title {
            font-size: 1.5rem;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .checklist-manager {
            padding: 1.5rem;
        }

        .topic-header {
            padding: 1rem;
        }

        .topic-header-controls {
            flex-direction: column;
            gap: 0.5rem;
        }

        .questions-container {
            padding: 1rem;
        }

        .question-card {
            padding: 1rem;
        }

        .option-item, .option-item.resposta, .option-item.porcentagem {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .checkbox-group {
            flex-direction: column;
            gap: 0.5rem;
        }
    }

    .btn.loading {
        pointer-events: none;
        opacity: 0.7;
    }

    .btn.loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        margin-left: 8px;
    }

    .field-error {
        color: var(--error);
        font-size: 0.85rem;
        margin-top: 8px;
        font-weight: 500;
        padding-left: 5px;
    }

    .form-control,
    .btn,
    .card,
    .topic-wrapper,
    .question-card,
    .checkbox-item,
    .option-item {
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }

    /* NOVOS ESTILOS PARA BOT√ïES DE A√á√ÉO */
    .action-btn-group {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
    }
    .action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    /* ESTILOS PARA OS TOASTS DE NOTIFICA√á√ÉO */
    .toast-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        pointer-events: none;
        gap: 12px;
    }
    .toast {
        background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 20px;
        min-width: 400px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.15);
        display: flex;
        align-items: flex-start;
        gap: 16px;
        position: relative;
        overflow: hidden;
        pointer-events: auto;
        animation: slideDownIn 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        transform-origin: top center;
    }
    .toast.toast-error { color: #fca5a5; border-color: rgba(239, 68, 68, 0.3); }
    .toast-icon { flex-shrink: 0; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.25); }
    .toast-content { flex: 1; min-width: 0; }
    .toast-title { font-size: 16px; font-weight: 700; color: #f8fafc; margin-bottom: 6px; }
    .toast-message { font-size: 14px; color: rgba(248, 250, 252, 0.85); line-height: 1.5; word-wrap: break-word; }
    .toast-close { flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; cursor: pointer; color: rgba(255, 255, 255, 0.6); }
    .toast-close:hover { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.9); }
    .toast.hiding { animation: slideUpOut 0.4s cubic-bezier(0.4, 0, 1, 1) forwards; }
    @keyframes slideDownIn { from { opacity: 0; transform: translateY(-100px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes slideUpOut { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(-100px) scale(0.95); } }
</style>

<div class="modal" id="confirmActionModal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2 id="confirmActionTitle"><i class="fas fa-exclamation-triangle"></i> Confirmar A√ß√£o</h2>
            <span class="close-btn" id="confirmActionClose">&times;</span>
        </div>
        <div class="modal-body" style="text-align: center;">
            <p id="confirmActionMessage">Tem certeza que deseja executar esta a√ß√£o?</p>
            <p style="color: var(--error); font-weight: 500;">Esta a√ß√£o n√£o pode ser desfeita.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="confirmActionCancel">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmActionConfirm">Sim, Confirmar</button>
        </div>
    </div>
</div>

<div class="form-container">
    <div class="toast-container" id="toastContainer"></div>

    <form method="post" enctype="multipart/form-data" id="mainForm" novalidate>
        {% csrf_token %}

        <div class="content-header">
            <div class="header-content">
                <div>
                    <h2 class="content-title">{{ title }}</h2>
                    <p class="content-subtitle">Configure seu checklist de forma completa e organizada</p>
                </div>
                <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs-header">
                <button type="button" class="tab-btn active" id="tab-btn-info" onclick="switchTab(event, 'checklist-info')">
                    <i class="fas fa-info-circle"></i> Informa√ß√µes do Checklist
                </button>
                <button type="button" class="tab-btn" id="tab-btn-structure" onclick="switchTab(event, 'checklist-structure')">
                    <i class="fas fa-sitemap"></i> Estrutura do Checklist
                </button>
            </div>
            
            <div class="tab-content active" id="checklist-info">
                <div class="card">
                    <div class="card-body">
                        <p style="color: var(--text-secondary); margin-bottom: 2rem; font-size: 15px;">
                            Preencha os campos abaixo para configurar as informa√ß√µes b√°sicas do checklist.
                        </p>

                        <div class="form-row single">
                            <div class="form-group required">
                                <label for="nome" class="form-label">Nome do Checklist</label>
                                <input type="text" id="nome" name="nome" class="form-control" value="{{ checklist.nome|default:'' }}" required maxlength="255" placeholder="Digite o nome do checklist">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="ferramenta" class="form-label">Ferramenta Digital</label>
                                <select id="ferramenta" name="ferramenta" class="form-control form-select">
                                    <option value="">Selecione uma ferramenta...</option>
                                    {% for f in ferramentas %}
                                        <option value="{{ f.pk }}" {% if checklist.ferramenta.pk == f.pk %}selected{% endif %}>{{ f.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status do Checklist</label>
                                <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
                                    <label class="toggle-switch">
                                        <input type="checkbox" name="ativo" {% if checklist.ativo|default:True %}checked{% endif %}>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <span style="color: var(--text-secondary); font-size: 14px; font-weight: 500;">Checklist ativo no sistema</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row single">
                            <div class="form-group">
                                <label for="normas_relacionadas" class="form-label">Normas Relacionadas</label>
                                
                                <!-- Verifique se o 'id' e 'multiple' est√£o presentes -->
                                <select id="normas_relacionadas" name="normas_relacionadas" multiple placeholder="Selecione as normas...">
                                    {% for norma in todas_as_normas %}
                                        <option value="{{ norma.pk }}" 
                                            {% if checklist and norma in checklist.normas_relacionadas.all %}selected{% endif %}>
                                            {{ norma }} <!-- Usar o __str__ do modelo √© uma boa pr√°tica -->
                                        </option>
                                    {% endfor %}
                                </select>

                                <div class="field-help">Selecione as normas que este checklist ajuda a verificar.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="checklist-structure">
                <div class="checklist-manager">
                    <div class="manager-header">
                        <h4>üîß Estrutura do Checklist</h4>
                        <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 14px;">Configure os t√≥picos e perguntas que comp√µem seu checklist</p>
                    </div>
                    
                    <div class="checklist-body" id="topics-container">
                        {% for topico in checklist.topicos.all|dictsort:"ordem" %}
                        <div class="topic-wrapper" data-topic-id="{{ topico.id }}">
                            <div class="topic-header">
                                <div class="topic-header-controls">
                                    <input type="hidden" name="topico-ordem[{{ topico.id }}]" class="js-topic-order" value="{{ topico.ordem }}">
                                    <input type="text" name="topico-descricao[{{ topico.id }}]" class="form-control" value="{{ topico.descricao }}" placeholder="Descri√ß√£o do T√≥pico">
                                    <div class="action-btn-group">
                                        <button type="button" class="action-btn js-move-topic-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                        <button type="button" class="action-btn js-move-topic-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                        <button type="button" class="action-btn js-duplicate-topic" title="Duplicar T√≥pico"><i class="fas fa-copy"></i></button>
                                        <button type="button" class="action-btn btn-danger js-remove-topic" title="Excluir T√≥pico">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="questions-container">
                                {% for pergunta in topico.perguntas.all|dictsort:"ordem" %}
                                <div class="question-card" data-question-id="{{ pergunta.id }}">
                                    <div class="question-header">
                                        <input type="hidden" name="pergunta-ordem[{{ topico.id }}-{{ pergunta.id }}]" class="js-question-order" value="{{ pergunta.ordem }}">
                                        <div class="action-btn-group">
                                            <button type="button" class="btn btn-secondary btn-sm js-move-question-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                            <button type="button" class="btn btn-secondary btn-sm js-move-question-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                        </div>
                                        <div class="action-btn-group">
                                            <button type="button" class="btn btn-secondary btn-sm js-duplicate-question" title="Duplicar Pergunta"><i class="fas fa-copy"></i></button>
                                            <button type="button" class="btn btn-danger btn-sm js-remove-question" title="Excluir Pergunta"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </div>
                                    <textarea name="pergunta-descricao[{{ topico.id }}-{{ pergunta.id }}]" class="form-control" rows="3" placeholder="Digite a descri√ß√£o da pergunta">{{ pergunta.descricao }}</textarea>
                                    
                                    <div class="checkbox-group">
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" name="pergunta-resposta_livre[{{ topico.id }}-{{ pergunta.id }}]" id="resposta_livre_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.resposta_livre %}checked{% endif %}>
                                            <label for="resposta_livre_{{ topico.id }}_{{ pergunta.id }}">üìù Resposta Livre</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" name="pergunta-foto[{{ topico.id }}-{{ pergunta.id }}]" id="foto_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.foto %}checked{% endif %}>
                                            <label for="foto_{{ topico.id }}_{{ pergunta.id }}">üì∑ Foto</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" data-controls="options-resposta-section" name="pergunta-criar_opcao[{{ topico.id }}-{{ pergunta.id }}]" id="criar_opcao_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.criar_opcao %}checked{% endif %}>
                                            <label for="criar_opcao_{{ topico.id }}_{{ pergunta.id }}">‚úÖ Criar uma Op√ß√£o</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" class="js-response-type" data-controls="options-porcentagem-section" name="pergunta-porcentagem[{{ topico.id }}-{{ pergunta.id }}]" id="porcentagem_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.porcentagem %}checked{% endif %}>
                                            <label for="porcentagem_{{ topico.id }}_{{ pergunta.id }}">üìä Porcentagem</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="pergunta-obrigatorio[{{ topico.id }}-{{ pergunta.id }}]" id="obrigatorio_{{ topico.id }}_{{ pergunta.id }}" {% if pergunta.obrigatoria %}checked{% endif %}>
                                            <label for="obrigatorio_{{ topico.id }}_{{ pergunta.id }}">‚ö†Ô∏è Obrigat√≥ria</label>
                                        </div>
                                    </div>

                                    <div class="question-footer">
                                        <div class="options-section options-resposta-section" style="display: {% if pergunta.criar_opcao %}block{% else %}none{% endif %};">
                                            <h5>Op√ß√µes de Resposta</h5>
                                            <div class="options-container">
                                                {% for opcao in pergunta.opcoes_resposta.all|dictsort:"ordem" %}
                                                <div class="option-item resposta">
                                                    <div class="option-controls">
                                                        <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                                        <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                                    </div>
                                                    <input type="hidden" class="js-option-order" name="opcao-resposta-ordem[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.ordem }}">
                                                    <input type="text" name="opcao-resposta-descricao[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.descricao }}" placeholder="Descri√ß√£o da op√ß√£o">
                                                    <select name="opcao-resposta-status[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control">
                                                        {% for value, text in status_opcoes %}
                                                            <option value="{{ value }}" {% if opcao.status == value %}selected{% endif %}>{{ text }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <button type="button" class="btn btn-danger btn-sm js-remove-option">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button type="button" class="btn btn-secondary js-add-option-resposta">
                                                <i class="fas fa-plus"></i> Adicionar Op√ß√£o
                                            </button>
                                        </div>
                                        
                                        <div class="options-section options-porcentagem-section" style="display: {% if pergunta.porcentagem %}block{% else %}none{% endif %};">
                                            <h5>Op√ß√µes de Porcentagem</h5>
                                            <div class="options-container">
                                                {% for opcao in pergunta.opcoes_porcentagem.all|dictsort:"ordem" %}
                                                <div class="option-item porcentagem">
                                                    <div class="option-controls">
                                                        <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                                                        <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                                                    </div>
                                                    <input type="hidden" class="js-option-order" name="opcao-porcentagem-ordem[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.ordem }}">
                                                    <input type="text" name="opcao-porcentagem-descricao[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.descricao }}" placeholder="Descri√ß√£o da op√ß√£o">
                                                    <input type="number" name="opcao-porcentagem-peso[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.peso }}" min="0" max="100" placeholder="Peso %">
                                                    <input type="color" name="opcao-porcentagem-cor[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" class="form-control" value="{{ opcao.cor }}" style="width: 60px; height: 40px; padding: 4px;">
                                                    <button type="button" class="btn btn-danger btn-sm js-remove-option">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <button type="button" class="btn btn-secondary js-add-option-porcentagem">
                                                <i class="fas fa-plus"></i> Adicionar Op√ß√£o
                                            </button>
                                        </div>
                                    </div>
                                    
                                </div>
                                {% endfor %}
                                <button type="button" class="btn btn-primary js-add-question">
                                    <i class="fas fa-plus"></i> Adicionar Pergunta
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div style="display: flex; justify-content: center; margin-top: 2rem;">
                        <button type="button" id="add-topic-btn" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Adicionar Novo T√≥pico
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin: 2rem; padding-top: 2rem; border-top: 2px solid rgba(37, 99, 235, 0.1);">
            <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save"></i> Salvar Altera√ß√µes
            </button>
        </div>
    </form>
</div>

{{ status_opcoes|json_script:"status-opcoes-data" }}

<template id="topic-template">
    <div class="topic-wrapper" data-topic-id="new-id">
        <div class="topic-header">
            <div class="topic-header-controls">
                <input type="hidden" name="topico-ordem[new-id]" class="js-topic-order" value="">
                <input type="text" name="topico-descricao[new-id]" class="form-control" placeholder="Descri√ß√£o do Novo T√≥pico">
                <div class="action-btn-group">
                    <button type="button" class="action-btn js-move-topic-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                    <button type="button" class="action-btn js-move-topic-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
                    <button type="button" class="action-btn js-duplicate-topic" title="Duplicar T√≥pico"><i class="fas fa-copy"></i></button>
                    <button type="button" class="action-btn btn-danger js-remove-topic" title="Excluir T√≥pico">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="questions-container">
            <button type="button" class="btn btn-primary js-add-question">
                <i class="fas fa-plus"></i> Adicionar Pergunta
            </button>
        </div>
    </div>
</template>

<template id="question-template">
    <div class="question-card" data-question-id="new-question-id">
        <div class="question-header">
            <input type="hidden" name="pergunta-ordem[topic-id-question-id]" class="js-question-order" value="">
            <div class="action-btn-group">
                <button type="button" class="btn btn-secondary btn-sm js-move-question-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
                <button type="button" class="btn btn-secondary btn-sm js-move-question-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
            </div>
            <div class="action-btn-group">
                <button type="button" class="btn btn-secondary btn-sm js-duplicate-question" title="Duplicar Pergunta"><i class="fas fa-copy"></i></button>
                <button type="button" class="btn btn-danger btn-sm js-remove-question" title="Excluir Pergunta"><i class="fas fa-trash"></i></button>
            </div>
        </div>
        <textarea name="pergunta-descricao[topic-id-question-id]" class="form-control" rows="3" placeholder="Digite a descri√ß√£o da pergunta"></textarea>
        
        <div class="checkbox-group">
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" name="pergunta-resposta_livre[topic-id-question-id]" id="resposta_livre_new">
                <label for="resposta_livre_new">üìù Resposta Livre</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" name="pergunta-foto[topic-id-question-id]" id="foto_new">
                <label for="foto_new">üì∑ Foto</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" data-controls="options-resposta-section" name="pergunta-criar_opcao[topic-id-question-id]" id="criar_opcao_new" checked>
                <label for="criar_opcao_new">‚úÖ Criar uma Op√ß√£o</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" class="js-response-type" data-controls="options-porcentagem-section" name="pergunta-porcentagem[topic-id-question-id]" id="porcentagem_new">
                <label for="porcentagem_new">üìä Porcentagem</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" name="pergunta-obrigatorio[topic-id-question-id]" id="obrigatorio_new">
                <label for="obrigatorio_new">‚ö†Ô∏è Obrigat√≥ria</label>
            </div>
        </div>
        
        <div class="question-footer">
            <div class="options-section options-resposta-section">
                <h5>Op√ß√µes de Resposta</h5>
                <div class="options-container"></div>
                <button type="button" class="btn btn-secondary js-add-option-resposta">
                    <i class="fas fa-plus"></i> Adicionar Op√ß√£o
                </button>
            </div>
            <div class="options-section options-porcentagem-section" style="display: none;">
                <h5>Op√ß√µes de Porcentagem</h5>
                <div class="options-container"></div>
                <button type="button" class="btn btn-secondary js-add-option-porcentagem">
                    <i class="fas fa-plus"></i> Adicionar Op√ß√£o
                </button>
            </div>
        </div>
    </div>
</template>

<template id="option-resposta-template">
    <div class="option-item resposta">
        <div class="option-controls">
            <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
            <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
        </div>
        <input type="hidden" class="js-option-order" name="opcao-resposta-ordem[question-id-option-id]" value="">
        <input type="text" name="opcao-resposta-descricao[question-id-option-id]" class="form-control" placeholder="Descri√ß√£o da op√ß√£o">
        <select name="opcao-resposta-status[question-id-option-id]" class="form-control"></select>
        <button type="button" class="btn btn-danger btn-sm js-remove-option">
            <i class="fas fa-times"></i>
        </button>
    </div>
</template>

<template id="option-porcentagem-template">
    <div class="option-item porcentagem">
        <div class="option-controls">
            <button type="button" class="btn btn-sm js-move-option-up" title="Mover para Cima"><i class="fas fa-arrow-up"></i></button>
            <button type="button" class="btn btn-sm js-move-option-down" title="Mover para Baixo"><i class="fas fa-arrow-down"></i></button>
        </div>
        <input type="hidden" class="js-option-order" name="opcao-porcentagem-ordem[question-id-option-id]" value="">
        <input type="text" name="opcao-porcentagem-descricao[question-id-option-id]" class="form-control" placeholder="Descri√ß√£o da op√ß√£o">
        <input type="number" name="opcao-porcentagem-peso[question-id-option-id]" class="form-control" min="0" max="100" placeholder="Peso %">
        <input type="color" name="opcao-porcentagem-cor[question-id-option-id]" class="form-control" value="#3b82f6" style="width: 60px; height: 40px; padding: 4px;">
        <button type="button" class="btn btn-danger btn-sm js-remove-option">
            <i class="fas fa-times"></i>
        </button>
    </div>
</template>

<script>

// Fun√ß√£o para trocar de aba
function switchTab(event, tabId) {
    if (event) event.preventDefault();
    
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    document.getElementById(`tab-btn-${tabId.split('-')[1]}`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

document.addEventListener('DOMContentLoaded', function() {
    
    // Inicializa o TomSelect para o campo de Normas (movido para c√°)
    new TomSelect('#normas_relacionadas',{
        plugins: ['remove_button'],
        placeholder: 'Selecione uma ou mais normas...',
        sortField: {
            field: "text",
            direction: "asc"
        }
    });

    const topicsContainer = document.getElementById('topics-container');
    const statusOpcoesElement = document.getElementById('status-opcoes-data');
    let statusOpcoes = [];
    
    try {
        statusOpcoes = JSON.parse(statusOpcoesElement.textContent);
    } catch (e) {
        statusOpcoes = [['CONFORME', 'Conforme'], ['NAO_CONFORME', 'N√£o Conforme'], ['NA', 'N/A']];
    }

    let newTopicCounter = 0;
    let newQuestionCounter = 0;
    let newOptionCounter = 0;

    function getNewId(prefix) {
        if (prefix === 'topic') return `new-${++newTopicCounter}`;
        if (prefix === 'question') return `new-${++newQuestionCounter}`;
        if (prefix === 'option') return `new-${++newOptionCounter}`;
    }

    // *** IN√çCIO DAS NOVAS FUN√á√ïES DE MODAL E TOAST ***
    function showToast(type, title, message) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-icon"><i class="fas fa-exclamation-circle"></i></div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button type="button" class="toast-close" aria-label="Fechar"><i class="fas fa-times"></i></button>`;
        container.appendChild(toast);
        setTimeout(() => hideToast(toast), 5000);
    }

    function hideToast(toast) {
        if(toast) {
            toast.classList.add('hiding');
            toast.addEventListener('animationend', () => toast.remove());
        }
    }

    function showConfirmModal(title, message, onConfirmCallback) {
        const modal = document.getElementById('confirmActionModal');
        modal.querySelector('#confirmActionTitle').innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${title}`;
        modal.querySelector('#confirmActionMessage').innerHTML = message;
        
        const confirmBtn = modal.querySelector('#confirmActionConfirm');
        const cancelBtn = modal.querySelector('#confirmActionCancel');
        const closeBtn = modal.querySelector('#confirmActionClose');

        // Clona o bot√£o para remover listeners antigos
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        newConfirmBtn.addEventListener('click', () => {
            onConfirmCallback();
            hideConfirmModal();
        }, { once: true }); // Garante que o evento s√≥ dispare uma vez

        cancelBtn.onclick = hideConfirmModal;
        closeBtn.onclick = hideConfirmModal;
        
        modal.style.display = 'flex';
    }

    function hideConfirmModal() {
        const modal = document.getElementById('confirmActionModal');
        modal.style.display = 'none';
    }
    // *** FIM DAS NOVAS FUN√á√ïES DE MODAL E TOAST ***

    document.body.addEventListener('click', function(e) {
        const target = e.target;
        const closest = target.closest.bind(target);
        
        if (target.id === 'add-topic-btn' || closest('#add-topic-btn')) { e.preventDefault(); addTopic(); return; }
        if (closest('.js-remove-topic')) { e.preventDefault(); removeTopic(closest('.js-remove-topic')); return; }
        if (closest('.js-duplicate-topic')) { e.preventDefault(); duplicateTopic(closest('.js-duplicate-topic')); return; }
        if (closest('.js-move-topic-up')) { e.preventDefault(); moveUp(closest('.topic-wrapper')); updateOrders(); return; }
        if (closest('.js-move-topic-down')) { e.preventDefault(); moveDown(closest('.topic-wrapper')); updateOrders(); return; }
        if (closest('.js-add-question')) { e.preventDefault(); addQuestion(closest('.js-add-question')); return; }
        if (closest('.js-remove-question')) { e.preventDefault(); removeQuestion(closest('.js-remove-question')); return; }
        if (closest('.js-duplicate-question')) { e.preventDefault(); duplicateQuestion(closest('.js-duplicate-question')); return; }
        if (closest('.js-move-question-up')) { e.preventDefault(); moveUp(closest('.question-card')); updateOrders(); return; }
        if (closest('.js-move-question-down')) { e.preventDefault(); moveDown(closest('.question-card')); updateOrders(); return; }
        if (closest('.js-add-option-resposta')) { e.preventDefault(); addOptionResposta(closest('.js-add-option-resposta')); return; }
        if (closest('.js-add-option-porcentagem')) { e.preventDefault(); addOptionPorcentagem(closest('.js-add-option-porcentagem')); return; }
        if (closest('.js-remove-option')) { e.preventDefault(); removeOption(closest('.js-remove-option')); return; }
        // *** NOVA L√ìGICA DE ORDENA√á√ÉO DE OP√á√ïES ***
        if (closest('.js-move-option-up')) { e.preventDefault(); moveUp(closest('.option-item')); updateOrders(); return; }
        if (closest('.js-move-option-down')) { e.preventDefault(); moveDown(closest('.option-item')); updateOrders(); return; }

        if (closest('.toast-close')) { hideToast(closest('.toast')); return; }
    });

    function updateOrders() {
        const topics = topicsContainer.querySelectorAll('.topic-wrapper');
        topics.forEach((topic, topicIndex) => {
            const topicOrderInput = topic.querySelector('.js-topic-order');
            if(topicOrderInput) topicOrderInput.value = topicIndex;

            const questions = topic.querySelectorAll('.question-card');
            questions.forEach((question, questionIndex) => {
                const questionOrderInput = question.querySelector('.js-question-order');
                if(questionOrderInput) questionOrderInput.value = questionIndex;
                
                // *** NOVA L√ìGICA DE ORDENA√á√ÉO DE OP√á√ïES ***
                const optionSections = question.querySelectorAll('.options-section');
                optionSections.forEach(section => {
                    const options = section.querySelectorAll('.option-item');
                    options.forEach((option, optionIndex) => {
                        const optionOrderInput = option.querySelector('.js-option-order');
                        if(optionOrderInput) optionOrderInput.value = optionIndex;
                    });
                });
            });
        });
        updateMoveButtons();
    }

    function updateMoveButtons() {
        const topics = topicsContainer.querySelectorAll('.topic-wrapper');
        topics.forEach((topic, index) => {
            topic.querySelector('.js-move-topic-up').disabled = (index === 0);
            topic.querySelector('.js-move-topic-down').disabled = (index === topics.length - 1);
        });

        topics.forEach(topic => {
            const questions = topic.querySelectorAll('.question-card');
            questions.forEach((question, index) => {
                question.querySelector('.js-move-question-up').disabled = (index === 0);
                question.querySelector('.js-move-question-down').disabled = (index === questions.length - 1);
                
                // *** NOVA L√ìGICA DE ORDENA√á√ÉO DE OP√á√ïES ***
                const optionSections = question.querySelectorAll('.options-section');
                optionSections.forEach(section => {
                    const options = section.querySelectorAll('.option-item');
                    options.forEach((option, optionIndex) => {
                        option.querySelector('.js-move-option-up').disabled = (optionIndex === 0);
                        option.querySelector('.js-move-option-down').disabled = (optionIndex === options.length - 1);
                    });
                });
            });
        });
    }

    function moveUp(element) { if (element.previousElementSibling) element.parentNode.insertBefore(element, element.previousElementSibling); }
    function moveDown(element) { if (element.nextElementSibling) element.parentNode.insertBefore(element.nextElementSibling, element); }
    
    function addTopic() {
        const tpl = document.getElementById('topic-template').content.cloneNode(true);
        const wrapper = tpl.querySelector('.topic-wrapper');
        const newId = getNewId('topic');
        wrapper.dataset.topicId = newId;
        wrapper.innerHTML = wrapper.innerHTML.replace(/new-id/g, newId);
        topicsContainer.appendChild(tpl);
        updateOrders();
    }

    function removeTopic(target) {
        const topicWrapper = target.closest('.topic-wrapper');
        const topicName = topicWrapper.querySelector('input[name*="topico-descricao"]').value || "este t√≥pico";
        showConfirmModal(
            'Excluir T√≥pico?', 
            `Tem certeza que deseja excluir o t√≥pico "<strong>${topicName}</strong>" e todas as suas perguntas?`,
            () => {
                topicWrapper.remove();
                updateOrders();
            }
        );
    }

    function duplicateTopic(target) {
        const originalTopic = target.closest('.topic-wrapper');
        const clone = originalTopic.cloneNode(true);
        const newTopicId = getNewId('topic');
        
        clone.dataset.topicId = newTopicId;

        // Renomeia os inputs do pr√≥prio t√≥pico
        const descInput = clone.querySelector('input[name*="topico-descricao"]');
        descInput.value = `${descInput.value} (c√≥pia)`;
        descInput.name = `topico-descricao[${newTopicId}]`;

        const orderInput = clone.querySelector('.js-topic-order');
        orderInput.name = `topico-ordem[${newTopicId}]`;

        // Itera sobre cada pergunta clonada para atualizar seus IDs e nomes
        clone.querySelectorAll('.question-card').forEach(question => {
            const originalQuestionId = question.dataset.questionId;
            const newQuestionId = getNewId('question');
            question.dataset.questionId = newQuestionId;
            
            const oldQuestionPrefix = `[${originalTopic.dataset.topicId}-${originalQuestionId}]`;
            const newQuestionPrefix = `[${newTopicId}-${newQuestionId}]`;
            
            // Atualiza todos os 'name' e 'id' da pergunta
            question.querySelectorAll(`[name*="${oldQuestionPrefix}"], [id*="${originalQuestionId}"]`).forEach(el => {
                const oldName = el.name;
                const oldId = el.id;

                if (oldName) {
                    el.name = oldName.replace(`[${originalTopic.dataset.topicId}-${originalQuestionId}]`, newQuestionPrefix);
                }
                if (oldId) {
                    el.id = oldId.replace(`_${originalQuestionId}`, `_${newQuestionId}`);
                    const label = question.querySelector(`label[for="${oldId}"]`);
                    if (label) {
                        label.setAttribute('for', el.id);
                    }
                }
            });

            // Itera sobre as op√ß√µes para garantir que seus IDs tamb√©m sejam novos
            question.querySelectorAll('.option-item').forEach(option => {
                const originalOptionId = option.querySelector('input, select')?.name.match(/(\d+|new-\d+)$/)?.[0] || getNewId('option');
                const newOptionId = getNewId('option');

                option.querySelectorAll('[name]').forEach(el => {
                    // Reconstr√≥i o name do zero para garantir
                    const match = el.name.match(/^(opcao-\w+-\w+)\[(.*)\]$/);
                    if (match) {
                        const baseName = match[1];
                        el.name = `${baseName}[${newTopicId}-${newQuestionId}-${newOptionId}]`;
                    }
                });
            });
        });

        originalTopic.parentNode.insertBefore(clone, originalTopic.nextSibling);
        updateOrders();
    }

    function addQuestion(target) {
        const questionsContainer = target.closest('.questions-container');
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;
        const tpl = document.getElementById('question-template').content.cloneNode(true);
        const card = tpl.querySelector('.question-card');
        const newId = getNewId('question');
        card.dataset.questionId = newId;
        
        let html = card.innerHTML;
        const regex = /\[topic-id-question-id\]|id="(.*?)_new"/g;
        card.innerHTML = html.replace(regex, (match, p1) => {
            if (match.startsWith('[')) return `[${topicId}-${newId}]`;
            if (match.startsWith('id="')) return `id="${p1}_${topicId}_${newId}"`;
            return match;
        });
        questionsContainer.insertBefore(tpl, target);
        updateOrders();
    }

    function removeQuestion(target) {
        const questionCard = target.closest('.question-card');
        const questionName = questionCard.querySelector('textarea[name*="pergunta-descricao"]').value || "esta pergunta";
        const truncatedName = questionName.length > 50 ? questionName.substring(0, 50) + '...' : questionName;

        showConfirmModal(
            'Excluir Pergunta?',
            `Tem certeza que deseja excluir a pergunta "<strong>${truncatedName}</strong>"?`,
            () => {
                questionCard.remove();
                updateOrders();
            }
        );
    }

    function duplicateQuestion(target) {
        const originalQuestion = target.closest('.question-card');
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;

        const clone = originalQuestion.cloneNode(true);
        const newQuestionId = getNewId('question');
        clone.dataset.questionId = newQuestionId;
        
        // Limpa o valor da descri√ß√£o clonada e adiciona "(c√≥pia)"
        const descTextarea = clone.querySelector('textarea[name*="pergunta-descricao"]');
        descTextarea.value = `${descTextarea.value} (c√≥pia)`;

        const oldQuestionId = originalQuestion.dataset.questionId;
        
        // Atualiza todos os 'name', 'id' e 'for' da pergunta clonada
        clone.querySelectorAll(`[name*="${oldQuestionId}"], [id*="${oldQuestionId}"]`).forEach(el => {
            const oldName = el.name;
            const oldId = el.id;

            if (oldName) {
                // Reconstr√≥i o name usando o novo ID da pergunta
                el.name = oldName.replace(`[${topicId}-${oldQuestionId}]`, `[${topicId}-${newQuestionId}]`);
            }
            if (oldId) {
                // Atualiza o ID do elemento
                const newId = oldId.replace(`_${oldQuestionId}`, `_${newQuestionId}`);
                el.id = newId;
                
                // Busca e atualiza o 'for' do label correspondente
                const label = clone.querySelector(`label[for="${oldId}"]`);
                if (label) {
                    label.setAttribute('for', newId);
                }
            }
        });

        // Itera sobre as op√ß√µes clonadas para garantir que recebam novos IDs
        clone.querySelectorAll('.option-item').forEach(option => {
            const newOptionId = getNewId('option');
            
            option.querySelectorAll('[name]').forEach(el => {
                // Reconstr√≥i o name da op√ß√£o do zero para m√°xima seguran√ßa
                const match = el.name.match(/^(opcao-\w+-\w+)\[(.*)\]$/);
                if (match) {
                    const baseName = match[1];
                    el.name = `${baseName}[${topicId}-${newQuestionId}-${newOptionId}]`;
                }
            });
        });

        originalQuestion.parentNode.insertBefore(clone, originalQuestion.nextSibling);
        updateOrders();
    }

    function addOptionResposta(target) {
        const optionsContainer = target.closest('.options-section').querySelector('.options-container');
        const questionCard = target.closest('.question-card');
        const questionId = questionCard.dataset.questionId;
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;
        const tpl = document.getElementById('option-resposta-template').content.cloneNode(true);
        const item = tpl.querySelector('.option-item');
        const newId = getNewId('option');
        
        item.innerHTML = item.innerHTML.replace(/\[question-id-option-id\]/g, `[${topicId}-${questionId}-${newId}]`);
        
        const select = item.querySelector('select');
        statusOpcoes.forEach(([value, text]) => select.add(new Option(text, value)));
        
        optionsContainer.appendChild(tpl);
        updateOrders();
    }

    function addOptionPorcentagem(target) {
        const optionsContainer = target.closest('.options-section').querySelector('.options-container');
        const questionCard = target.closest('.question-card');
        const questionId = questionCard.dataset.questionId;
        const topicWrapper = target.closest('.topic-wrapper');
        const topicId = topicWrapper.dataset.topicId;
        const tpl = document.getElementById('option-porcentagem-template').content.cloneNode(true);
        const item = tpl.querySelector('.option-item');
        const newId = getNewId('option');
        
        item.innerHTML = item.innerHTML.replace(/\[question-id-option-id\]/g, `[${topicId}-${questionId}-${newId}]`);
        optionsContainer.appendChild(tpl);
        updateOrders();
    }

    function removeOption(target) {
        const optionItem = target.closest('.option-item');
        showConfirmModal(
            'Remover Op√ß√£o?',
            'Tem certeza que deseja remover esta op√ß√£o?',
            () => {
                optionItem.remove();
                updateOrders();
            }
        );
    }

    /**
     * Garante que apenas "Criar uma Op√ß√£o" ou "Porcentagem" possam ser marcados.
     * @param {HTMLInputElement} checkbox - O checkbox que foi alterado.
     */
    function handleCheckboxExclusivity(checkbox) {
        // S√≥ faz algo se o checkbox foi MARCADO
        if (!checkbox.checked) return;

        const questionCard = checkbox.closest('.question-card');
        if (!questionCard) return;
        
        let siblingCheckbox;

        // Se o checkbox de 'Op√ß√£o' foi marcado, desmarca o de 'Porcentagem'
        if (checkbox.name.includes('pergunta-criar_opcao')) {
            siblingCheckbox = questionCard.querySelector('[name*="pergunta-porcentagem"]');
        } 
        // Se o checkbox de 'Porcentagem' foi marcado, desmarca o de 'Op√ß√£o'
        else if (checkbox.name.includes('pergunta-porcentagem')) {
            siblingCheckbox = questionCard.querySelector('[name*="pergunta-criar_opcao"]');
        }

        // Se encontramos o "irm√£o" e ele est√° marcado, desmarcamos
        if (siblingCheckbox && siblingCheckbox.checked) {
            siblingCheckbox.checked = false;
            // Dispara o evento de 'change' para que a UI se atualize (esconda a se√ß√£o de op√ß√µes)
            siblingCheckbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    document.body.addEventListener('change', function(e) {
        // L√≥gica de exclusividade dos checkboxes
        if (e.target.classList.contains('js-response-type')) {
            handleCheckboxExclusivity(e.target);
        }

        // L√≥gica para mostrar/esconder se√ß√µes de op√ß√µes
        if (e.target.classList.contains('js-response-type') && e.target.dataset.controls) {
            const section = e.target.closest('.question-card').querySelector(`.${e.target.dataset.controls}`);
            if (section) section.style.display = e.target.checked ? 'block' : 'none';
        }
    });

    // Valida√ß√£o do formul√°rio
    const form = document.getElementById('mainForm');
    const submitBtn = document.getElementById('submitBtn');

    function validateForm() {
        document.querySelectorAll('.validation-error').forEach(el => el.classList.remove('validation-error'));

        const checklistNameInput = document.getElementById('nome');
        if (!checklistNameInput.value.trim()) {
            showToast('error', 'Valida√ß√£o Falhou', 'O nome do checklist √© obrigat√≥rio. Por favor, preencha o campo antes de salvar.');
            switchTab(null, 'checklist-info');
            checklistNameInput.classList.add('validation-error');
            checklistNameInput.focus();
            return false;
        }

        const topicInputs = document.querySelectorAll('input[name*="topico-descricao"]');
        const topicNames = new Set();
        let duplicateFound = false;
        
        topicInputs.forEach(input => {
            const name = input.value.trim().toLowerCase();
            if (name && topicNames.has(name)) {
                duplicateFound = true;
                document.querySelectorAll('input[name*="topico-descricao"]').forEach(innerInput => {
                    if (innerInput.value.trim().toLowerCase() === name) {
                        innerInput.classList.add('validation-error');
                    }
                });
            }
            topicNames.add(name);
        });

        if (duplicateFound) {
            showToast('error', 'Valida√ß√£o Falhou', 'Existem t√≥picos com nomes duplicados.');
            switchTab(null, 'checklist-structure');
            return false;
        }

        return true;
    }

    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            if (!validateForm()) {
                e.preventDefault();
                return;
            }
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;
        });
    }



    updateOrders();
    console.log('Script carregado completamente');
});
</script>

{% endblock %}