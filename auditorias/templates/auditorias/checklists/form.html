{% extends 'auditorias/base.html' %}

{% block content %}
<style>
    /* Estilos CSS (sem alterações, mantidos para consistência) */
    :root {
        --primary-color: #3b82f6;
        --primary-light: #dbeafe;
        --primary-dark: #1e40af;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-800: #1f2937;
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        --radius-lg: 0.75rem;
        --radius-xl: 1rem;
        --transition-all: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .checklist-manager {
        background: var(--gray-50);
        border-radius: var(--radius-xl);
        padding: 2rem;
        margin-top: 2rem;
        border: 1px solid var(--gray-200);
    }
    .manager-header {
        margin-bottom: 2.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid var(--gray-200);
    }
    .checklist-body {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        align-items: center;
        max-width: 1000px;
        margin: 0 auto;
    }
    .topic-wrapper {
        width: 100%;
        background: white;
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
    }
    .topic-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.5rem 2rem;
    }
    .questions-container {
        padding: 2rem;
        background: var(--gray-50);
    }
    .question-card {
        background: white;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .question-footer {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px dashed var(--gray-200);
    }
    .option-item {
        display: grid;
        grid-template-columns: 2fr 1fr 2fr auto;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--radius-lg);
    }
</style>

<form method="post" enctype="multipart/form-data" id="mainForm" novalidate>
    {% csrf_token %}

    <div class="content-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 class="content-title">{{ title }}</h2>
                <p class="content-subtitle">Preencha os campos abaixo para configurar o checklist e sua estrutura.</p>
            </div>
            <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </div>

    <div class="card" style="margin-bottom: 32px;">
        <div class="card-body" style="padding: 24px;">
            <div class="form-row single">
                <div class="form-group required">
                    <label for="nome" class="form-label">Nome do Checklist</label>
                    <input type="text" id="nome" name="nome" class="form-control" value="{{ checklist.nome|default:'' }}" required maxlength="255">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="ferramenta" class="form-label">Ferramenta Digital</label>
                    <select id="ferramenta" name="ferramenta" class="form-control form-select">
                        <option value="">Selecione...</option>
                        {% for f in ferramentas %}
                        <option value="{{ f.pk }}" {% if checklist.ferramenta.pk == f.pk %}selected{% endif %}>{{ f.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-row single">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label class="toggle-switch">
                            <input type="checkbox" name="ativo" {% if checklist.ativo|default:True %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="color: var(--text-secondary); font-size: 14px;">Checklist ativo no sistema</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="checklist-manager">
        <div class="manager-header">
            <h4>Estrutura do Checklist</h4>
        </div>
        
        <div class="checklist-body" id="topics-container">
            {% for topico in checklist.topicos.all %}
            <div class="topic-wrapper" data-topic-id="{{ topico.id }}">
                <div class="topic-header">
                    <div class="topic-header-controls">
                        <input type="text" name="topico-descricao[{{ topico.id }}]" class="form-control" value="{{ topico.descricao }}" placeholder="Descrição do Tópico">
                        <button type="button" class="btn btn-danger js-remove-topic">Excluir Tópico</button>
                    </div>
                </div>
                <div class="questions-container">
                    {% for pergunta in topico.perguntas.all %}
                    <div class="question-card" data-question-id="{{ pergunta.id }}">
                        <textarea name="pergunta-descricao[{{ topico.id }}-{{ pergunta.id }}]" class="form-control" rows="2">{{ pergunta.descricao }}</textarea>
                        
                        <div>
                            <input type="checkbox" class="js-response-type" name="pergunta-resposta_livre[{{ topico.id }}-{{ pergunta.id }}]" {% if pergunta.resposta_livre %}checked{% endif %}> Resposta Livre
                            <input type="checkbox" class="js-response-type" name="pergunta-foto[{{ topico.id }}-{{ pergunta.id }}]" {% if pergunta.foto %}checked{% endif %}> Foto
                            <input type="checkbox" class="js-response-type" data-controls="options-resposta-section" name="pergunta-criar_opcao[{{ topico.id }}-{{ pergunta.id }}]" {% if pergunta.criar_opcao %}checked{% endif %}> Criar uma Opção
                            <input type="checkbox" class="js-response-type" data-controls="options-porcentagem-section" name="pergunta-porcentagem[{{ topico.id }}-{{ pergunta.id }}]" {% if pergunta.porcentagem %}checked{% endif %}> Porcentagem
                            <input type="checkbox" name="pergunta-obrigatorio[{{ topico.id }}-{{ pergunta.id }}]" {% if pergunta.obrigatoria %}checked{% endif %}> Obrigatória
                        </div>

                        <div class="question-footer">
                            <div class="options-section options-resposta-section" style="display: {% if pergunta.criar_opcao %}block{% else %}none{% endif %};">
                                <h5>Opções de Resposta</h5>
                                <div class="options-container">
                                    {% for opcao in pergunta.opcoes_resposta.all %}
                                    <div class="option-item">
                                        <input type="text" name="opcao-resposta-descricao[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.descricao }}">
                                        <select name="opcao-resposta-status[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]">
                                            {% for value, text in status_opcoes %}
                                            <option value="{{ value }}" {% if opcao.status == value %}selected{% endif %}>{{ text }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-danger js-remove-option">Remover</button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-secondary js-add-option-resposta">Adicionar Opção</button>
                            </div>
                            <div class="options-section options-porcentagem-section" style="display: {% if pergunta.porcentagem %}block{% else %}none{% endif %};">
                                <h5>Opções de Porcentagem</h5>
                                <div class="options-container">
                                    {% for opcao in pergunta.opcoes_porcentagem.all %}
                                    <div class="option-item">
                                        <input type="text" name="opcao-porcentagem-descricao[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.descricao }}">
                                        <input type="number" name="opcao-porcentagem-peso[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.peso }}" min="0" max="100">
                                        <input type="color" name="opcao-porcentagem-cor[{{ topico.id }}-{{ pergunta.id }}-{{ opcao.id }}]" value="{{ opcao.cor }}">
                                        <button type="button" class="btn btn-danger js-remove-option">Remover</button>
                                    </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-secondary js-add-option-porcentagem">Adicionar Opção</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-danger js-remove-question">Excluir Pergunta</button>
                    </div>
                    {% endfor %}
                    <button type="button" class="btn btn-primary js-add-question">Adicionar Pergunta</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <button type="button" id="add-topic-btn" class="btn btn-secondary">Adicionar Novo Tópico</button>
    </div>

    <div style="display: flex; justify-content: flex-end; margin-top: 32px;">
        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
    </div>
</form>

{{ status_opcoes|json_script:"status-opcoes-data" }}

<template id="topic-template">
    <div class="topic-wrapper" data-topic-id="new-id">
        <div class="topic-header">
            <input type="text" name="topico-descricao[new-id]" class="form-control" placeholder="Descrição do Novo Tópico">
            <button type="button" class="btn btn-danger js-remove-topic">Excluir Tópico</button>
        </div>
        <div class="questions-container"></div>
        <button type="button" class="btn btn-primary js-add-question">Adicionar Pergunta</button>
    </div>
</template>

<template id="question-template">
    <div class="question-card" data-question-id="new-question-id">
        <textarea name="pergunta-descricao[topic-id-question-id]" class="form-control" rows="2" placeholder="Digite a descrição da pergunta"></textarea>
        <div>
            <input type="checkbox" class="js-response-type" name="pergunta-resposta_livre[topic-id-question-id]"> Resposta Livre
            <input type="checkbox" class="js-response-type" name="pergunta-foto[topic-id-question-id]"> Foto
            <input type="checkbox" class="js-response-type" data-controls="options-resposta-section" name="pergunta-criar_opcao[topic-id-question-id]" checked> Criar uma Opção
            <input type="checkbox" class="js-response-type" data-controls="options-porcentagem-section" name="pergunta-porcentagem[topic-id-question-id]"> Porcentagem
            <input type="checkbox" name="pergunta-obrigatorio[topic-id-question-id]"> Obrigatória
        </div>
        <div class="question-footer">
            <div class="options-section options-resposta-section">
                <h5>Opções de Resposta</h5>
                <div class="options-container"></div>
                <button type="button" class="btn btn-secondary js-add-option-resposta">Adicionar Opção</button>
            </div>
            <div class="options-section options-porcentagem-section" style="display: none;">
                <h5>Opções de Porcentagem</h5>
                <div class="options-container"></div>
                <button type="button" class="btn btn-secondary js-add-option-porcentagem">Adicionar Opção</button>
            </div>
        </div>
        <button type="button" class="btn btn-danger js-remove-question">Excluir Pergunta</button>
    </div>
</template>

<template id="option-resposta-template">
    <div class="option-item">
        <input type="text" name="opcao-resposta-descricao[question-id-option-id]" placeholder="Descrição da opção">
        <select name="opcao-resposta-status[question-id-option-id]"></select>
        <button type="button" class="btn btn-danger js-remove-option">Remover</button>
    </div>
</template>

<template id="option-porcentagem-template">
    <div class="option-item">
        <input type="text" name="opcao-porcentagem-descricao[question-id-option-id]" placeholder="Descrição da opção">
        <input type="number" name="opcao-porcentagem-peso[question-id-option-id]" min="0" max="100" placeholder="Peso %">
        <input type="color" name="opcao-porcentagem-cor[question-id-option-id]">
        <button type="button" class="btn btn-danger js-remove-option">Remover</button>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const topicsContainer = document.getElementById('topics-container');
    const statusOpcoes = JSON.parse(document.getElementById('status-opcoes-data').textContent);

    let newTopicCounter = 0;
    let newQuestionCounter = 0;
    let newOptionCounter = 0;

    function getNewId(prefix) {
        if (prefix === 'topic') {
            newTopicCounter++;
            return `new-${newTopicCounter}`;
        }
        if (prefix === 'question') {
            newQuestionCounter++;
            return `new-${newQuestionCounter}`;
        }
        if (prefix === 'option') {
            newOptionCounter++;
            return `new-${newOptionCounter}`;
        }
    }

    // Event Delegation for all dynamic actions
    document.body.addEventListener('click', function(e) {
        const target = e.target;

        // ==========================================================
        // CORREÇÃO: Usar .closest() para todos os botões de ADICIONAR
        // ==========================================================
        const addTopicBtn = target.closest('#add-topic-btn');
        const addQuestionBtn = target.closest('.js-add-question');
        const addOptionRespostaBtn = target.closest('.js-add-option-resposta');
        const addOptionPorcentagemBtn = target.closest('.js-add-option-porcentagem');

        // REMOVE ACTIONS (Já estavam corretos)
        const removeTopicBtn = target.closest('.js-remove-topic');
        const removeQuestionBtn = target.closest('.js-remove-question');
        const removeOptionBtn = target.closest('.js-remove-option');

        // ADD TOPIC
        if (addTopicBtn) {
            const topicTemplate = document.getElementById('topic-template');
            const newTopicElement = topicTemplate.content.cloneNode(true);
            const topicWrapper = newTopicElement.querySelector('.topic-wrapper');
            const newId = getNewId('topic');
            topicWrapper.dataset.topicId = newId;
            topicWrapper.innerHTML = topicWrapper.innerHTML.replace(/new-id/g, newId);
            topicsContainer.appendChild(newTopicElement);
        }

        // ADD QUESTION
        if (addQuestionBtn) {
            const questionTemplate = document.getElementById('question-template');
            const newQuestionElement = questionTemplate.content.cloneNode(true);
            const questionCard = newQuestionElement.querySelector('.question-card');
            const topicWrapper = addQuestionBtn.closest('.topic-wrapper');
            const questionsContainer = topicWrapper.querySelector('.questions-container');
            const topicId = topicWrapper.dataset.topicId;
            const newQuestionId = getNewId('question');

            questionCard.dataset.questionId = newQuestionId;
            questionCard.innerHTML = questionCard.innerHTML.replace(/topic-id-question-id/g, `${topicId}-${newQuestionId}`);
            questionsContainer.appendChild(newQuestionElement);
        }

        // ADD OPTION RESPOSTA
        if (addOptionRespostaBtn) {
            const optionTemplate = document.getElementById('option-resposta-template');
            const newOptionElement = optionTemplate.content.cloneNode(true);
            const optionItem = newOptionElement.querySelector('.option-item');
            const questionCard = addOptionRespostaBtn.closest('.question-card');
            const optionsContainer = addOptionRespostaBtn.closest('.options-section').querySelector('.options-container');
            const topicId = questionCard.closest('.topic-wrapper').dataset.topicId;
            const questionId = questionCard.dataset.questionId;
            const newOptionId = getNewId('option');

            optionItem.querySelectorAll('[name]').forEach(el => {
                el.name = el.name.replace('question-id-option-id', `${topicId}-${questionId}-${newOptionId}`);
            });

            const selectElement = optionItem.querySelector('select');
            if (selectElement) {
                statusOpcoes.forEach(optionData => {
                    const option = document.createElement('option');
                    option.value = optionData[0];
                    option.textContent = optionData[1];
                    selectElement.appendChild(option);
                });
            }
            optionsContainer.appendChild(newOptionElement);
        }

        // ADD OPTION PORCENTAGEM
        if (addOptionPorcentagemBtn) {
            const optionTemplate = document.getElementById('option-porcentagem-template');
            const newOptionElement = optionTemplate.content.cloneNode(true);
            const optionItem = newOptionElement.querySelector('.option-item');
            const questionCard = addOptionPorcentagemBtn.closest('.question-card');
            const optionsContainer = addOptionPorcentagemBtn.closest('.options-section').querySelector('.options-container');
            const topicId = questionCard.closest('.topic-wrapper').dataset.topicId;
            const questionId = questionCard.dataset.questionId;
            const newOptionId = getNewId('option');
            optionItem.querySelectorAll('[name]').forEach(el => {
                el.name = el.name.replace('question-id-option-id', `${topicId}-${questionId}-${newOptionId}`);
            });
            optionsContainer.appendChild(newOptionElement);
        }

        // REMOVE ACTIONS
        if (removeTopicBtn) {
            removeTopicBtn.closest('.topic-wrapper').remove();
        }
        if (removeQuestionBtn) {
            removeQuestionBtn.closest('.question-card').remove();
        }
        if (removeOptionBtn) {
            removeOptionBtn.closest('.option-item').remove();
        }
    });

    // Event delegation for showing/hiding option sections
    document.body.addEventListener('change', function(e) {
        if (e.target && e.target.classList.contains('js-response-type') && e.target.dataset.controls) {
            const sectionClass = e.target.dataset.controls;
            const questionCard = e.target.closest('.question-card');
            const section = questionCard.querySelector(`.${sectionClass}`);
            if (section) {
                section.style.display = e.target.checked ? 'block' : 'none';
            }
        }
    });
});
</script>
{% endblock %}