{% extends 'auditorias/base.html' %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    /* Variáveis e Layout */
    :root {
        --dash-bg: #f8fafc;
        --card-white: #ffffff;
    }
    
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    /* KPI Cards */
    .kpi-card {
        background: var(--card-white);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-left: 5px solid transparent;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

    .kpi-info h4 { margin: 0; font-size: 13px; color: #64748b; text-transform: uppercase; font-weight: 600; }
    .kpi-info .value { font-size: 28px; font-weight: 800; color: #1e293b; margin-top: 5px; }
    
    .kpi-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }

    /* Cores Específicas dos KPIs */
    .kpi-realizadas { border-left-color: #10b981; }
    .kpi-realizadas .kpi-icon { background: #dcfce7; color: #10b981; }

    .kpi-planejadas { border-left-color: #3b82f6; }
    .kpi-planejadas .kpi-icon { background: #dbeafe; color: #3b82f6; }

    .kpi-eficiencia { border-left-color: #6366f1; }
    .kpi-eficiencia .kpi-icon { background: #e0e7ff; color: #6366f1; }

    .kpi-nc { border-left-color: #ef4444; }
    .kpi-nc .kpi-icon { background: #fee2e2; color: #ef4444; }

    /* Gráficos Containers */
    .chart-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .card-chart {
        background: var(--card-white);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
    }

    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f1f5f9;
    }
    .card-header-custom h3 { font-size: 16px; font-weight: 700; color: #333; margin: 0; }

    /* Tabela */
    .table-responsive { overflow-x: auto; }
    .table-modern { width: 100%; border-collapse: collapse; font-size: 14px; }
    .table-modern th { text-align: left; padding: 12px; background: #f8fafc; color: #64748b; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
    .table-modern td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .table-modern tr:hover td { background: #f8fafc; }

    /* Responsivo */
    @media (max-width: 1024px) {
        .dashboard-grid { grid-template-columns: 1fr 1fr; }
        .chart-row { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
        .dashboard-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">Dashboard de Auditorias</h2>
            <p class="content-subtitle">Indicadores de desempenho e programação (Ano Atual)</p>
        </div>
        <div style="display: flex; gap: 10px;">
            {# Botão Voltar #}
            <a href="{% url 'auditorias:lista_auditorias' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>

            {# Botão Agendar (Já existia) #}
            <a href="{% url 'auditorias:criar_auditoria' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Agendar Auditoria
            </a>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="kpi-card kpi-realizadas">
        <div class="kpi-info">
            <h4>Realizadas</h4>
            <div class="value">{{ kpi_realizadas }}</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
    </div>

    <div class="kpi-card kpi-planejadas">
        <div class="kpi-info">
            <h4>Planejadas</h4>
            <div class="value">{{ kpi_planejadas }}</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-calendar-alt"></i></div>
    </div>

    <div class="kpi-card kpi-eficiencia">
        <div class="kpi-info">
            <h4>Eficiência</h4>
            <div class="value">{{ kpi_eficiencia }}%</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-chart-line"></i></div>
    </div>

    <div class="kpi-card kpi-nc">
        <div class="kpi-info">
            <h4>Itens Não Conforme</h4>
            <div class="value">{{ kpi_nc }}</div>
        </div>
        <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
    </div>
</div>

<div class="chart-row">
    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Desempenho Mensal</h3>
        </div>
        <div id="chartMensal"></div>
    </div>

    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Conformidade Geral</h3>
        </div>
        <div id="chartConformidade"></div>
    </div>
</div>

<div class="chart-row" style="grid-template-columns: 1fr 2fr;">
    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Auditorias por Local (Top 10)</h3>
        </div>
        <div id="chartLocais"></div>
    </div>

    <div class="card-chart">
        <div class="card-header-custom">
            <h3>Próximas Auditorias Agendadas</h3>
            <a href="{% url 'auditorias:lista_execucoes' %}" style="font-size: 12px; color: #3b82f6; text-decoration: none;">Ver todas</a>
        </div>
        <div class="table-responsive">
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Local</th>
                        <th>Ferramenta</th>
                        <th>Auditor</th>
                    </tr>
                </thead>
                <tbody>
                    {% for aud in proximas_auditorias %}
                    <tr>
                        <td><span style="font-weight: 600;">{{ aud.data_execucao|date:"d/m/Y" }}</span></td>
                        <td>{{ aud.local_execucao.nome|default:"A definir" }}</td>
                        <td><span class="badge badge-secondary">{{ aud.auditoria_agendada.ferramenta.nome }}</span></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 24px; height: 24px; background: #eff6ff; color: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold;">
                                    {{ aud.responsavel.first_name.0|default:'U' }}
                                </div>
                                {{ aud.responsavel.get_full_name|default:aud.responsavel.username }}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #999; padding: 20px;">Nenhuma auditoria agendada para os próximos dias.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- DADOS DO BACKEND ---
    const labelsMeses = JSON.parse('{{ chart_meses_labels|safe }}');
    const dataPlanejado = JSON.parse('{{ chart_series_planejado|safe }}');
    const dataRealizado = JSON.parse('{{ chart_series_realizado|safe }}');
    
    const labelsLocais = JSON.parse('{{ chart_locais_labels|safe }}');
    const dataLocais = JSON.parse('{{ chart_locais_series|safe }}');
    
    const dataConformidade = JSON.parse('{{ chart_conformidade_series|safe }}');

    // 1. GRÁFICO MENSAL (COLUNAS MISTAS)
    var optionsMensal = {
        series: [{
            name: 'Planejado',
            data: dataPlanejado
        }, {
            name: 'Realizado',
            data: dataRealizado
        }],
        chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '55%',
                borderRadius: 4
            },
        },
        dataLabels: { enabled: false },
        stroke: { show: true, width: 2, colors: ['transparent'] },
        xaxis: { categories: labelsMeses },
        fill: { opacity: 1 },
        colors: ['#3b82f6', '#10b981'], // Azul (Plan), Verde (Real)
        tooltip: {
            y: { formatter: function (val) { return val + " auditorias" } }
        }
    };
    new ApexCharts(document.querySelector("#chartMensal"), optionsMensal).render();

    // 2. GRÁFICO DE PIZZA (CONFORMIDADE)
    var optionsPizza = {
        series: dataConformidade, // [Conforme, Não Conforme]
        labels: ['Itens Conformes', 'Itens Não Conformes'],
        chart: {
            type: 'donut',
            height: 350
        },
        colors: ['#10b981', '#ef4444'], // Verde, Vermelho
        plotOptions: {
            pie: {
                donut: {
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            label: 'Total Itens',
                            formatter: function (w) {
                                return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                            }
                        }
                    }
                }
            }
        },
        dataLabels: { enabled: false }
    };
    new ApexCharts(document.querySelector("#chartConformidade"), optionsPizza).render();

    // 3. GRÁFICO DE BARRAS HORIZONTAIS (LOCAIS)
    var optionsLocais = {
        series: [{
            name: 'Auditorias',
            data: dataLocais
        }],
        chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: false }
        },
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: true,
                barHeight: '60%'
            }
        },
        dataLabels: { enabled: true },
        xaxis: { categories: labelsLocais },
        colors: ['#f59e0b'] // Amarelo/Laranja igual imagem
    };
    new ApexCharts(document.querySelector("#chartLocais"), optionsLocais).render();

</script>
{% endblock %}