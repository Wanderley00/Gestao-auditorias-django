{% extends 'auditorias/base.html' %}

{% block title %}{{ title }} - Sistema de Auditorias{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">{{ subtitle|default:"Preencha os campos abaixo" }}</p>
        </div>
        {% if back_url %}
        {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
        <a href="{% url back_url %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Voltar
        </a>
        {% else %}
        <button type="button" onclick="window.history.back()" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Voltar
        </button>
        {% endif %}
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 32px;">
    <!-- Formulário Principal -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">{{ form_title|default:title }}</h3>
            <p class="card-subtitle">{{ form_subtitle|default:"Campos obrigatórios são marcados com *" }}</p>
        </div>
        
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="mainForm" novalidate>
                {% csrf_token %}
                
                {% block form_content %}
                <!-- Conteúdo específico do formulário será definido nos templates filhos -->
                {% endblock %}
                
                <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
                    {% if back_url %}
                    {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
                    <a href="{% url back_url %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </a>
                    {% else %}
                    <button type="button" onclick="window.history.back()" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </button>
                    {% endif %}
                    <button type="submit" class="btn btn-primary" id="submitBtn" data-original-text="Salvar">
                        <i class="fas fa-save"></i>
                        {{ submit_text|default:"Salvar" }}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Painel Lateral -->
    <div>
        <!-- Informações de Ajuda -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle"></i>
                    Ajuda
                </h3>
            </div>
            <div class="card-body">
                {% block help_content %}
                <div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
                    <p><strong>Dicas:</strong></p>
                    <ul style="margin: 12px 0; padding-left: 20px;">
                        <li>Campos marcados com * são obrigatórios</li>
                        <li>Use nomes descritivos e únicos</li>
                        <li>Verifique os dados antes de salvar</li>
                    </ul>
                </div>
                {% endblock %}
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bolt"></i>
                    Ações Rápidas
                </h3>
            </div>
            <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    {% block quick_actions %}
                    <button type="button" onclick="resetForm()" class="btn btn-secondary btn-sm">
                        <i class="fas fa-undo"></i>
                        Resetar
                    </button>
                    {% if back_url %}
                    {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
                    <a href="{% url back_url %}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-list"></i>
                        Ver Lista
                    </a>
                    {% endif %}
                    {% endblock %}
                </div>
            </div>
        </div>

        <!-- Histórico (se editando) -->
        {% if object %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history"></i>
                    Histórico
                </h3>
            </div>
            <div class="card-body">
                <div style="font-size: 14px; color: var(--text-secondary);">
                    <div style="margin-bottom: 12px;">
                        <strong>Criado em:</strong><br>
                        {{ object.data_cadastro|date:"d/m/Y H:i" }}
                    </div>
                    {% if object.data_atualizacao != object.data_cadastro %}
                    <div>
                        <strong>Última atualização:</strong><br>
                        {{ object.data_atualizacao|date:"d/m/Y H:i" }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% block extra_js %}
<script>
// Função para resetar formulário
function resetForm() {
    if (confirm('Tem certeza que deseja resetar o formulário? Todos os dados não salvos serão perdidos.')) {
        document.getElementById('mainForm').reset();
        
        // Limpar erros e classes de validação
        document.querySelectorAll('.form-control').forEach(field => {
            field.classList.remove('error', 'success');
        });
        
        document.querySelectorAll('.field-error').forEach(error => {
            error.remove();
        });
    }
}

// Detectar mudanças no formulário para aviso antes de sair
let formChanged = false;
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mainForm');
    if (form) {
        form.addEventListener('input', () => formChanged = true);
        form.addEventListener('change', () => formChanged = true);
        form.addEventListener('submit', () => formChanged = false);
    }
});

// Aviso antes de sair da página com dados não salvos
window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S para salvar
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        document.getElementById('submitBtn').click();
    }
    
    // Escape para voltar
    if (e.key === 'Escape') {
        {% if back_url %}
        {# CORREÇÃO APLICADA: Usa a variável 'back_url' diretamente #}
        window.location.href = "{{ back_url }}";
        {% else %}
        window.history.back();
        {% endif %}
    }
});
</script>
{% endblock %}
{% endblock %}