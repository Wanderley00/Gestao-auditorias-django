{% extends 'auditorias/lista_generica.html' %}

{# Remove o formulário de busca genérico herdado do template pai #}
{% block search_form %}{% endblock %}

{# Este bloco fica vazio, pois os filtros agora estão no cabeçalho da tabela #}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    {# Linha 1: Títulos das Colunas #}
    <tr>
        <th>Nome</th>
        <th>Descrição</th>
        <th>Status</th>
        <th>Data Cadastro</th>
        <th style="width: 120px;">Ações</th>
    </tr>
    {# Linha 2: Campos de Filtro #}
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th></th> {# Coluna de Ações sem filtro #}
    </tr>
{% endblock %}

{% block table_row %}
<td>
    <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px;"> 
            {{ object.nome.0|upper }}
        </div>
        <div>
            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">
                {{ object.nome }} 
            </div>
            <div style="font-size: 12px; color: var(--text-muted);"> 
                ID: {{ object.pk }}
            </div>
        </div>
    </div>
</td>
<td>
    <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ object.descricao }}">
        {{ object.descricao|default:"—" }} 
    </div>
</td>
<td>
    {% if object.ativo %} 
        <span class="badge badge-success"> 
            <i class="fas fa-check-circle"></i> 
            Ativo
        </span>
    {% else %}
        <span class="badge badge-error">
            <i class="fas fa-times-circle"></i>
            Inativo
        </span>
    {% endif %} 
</td>
<td>
    <div style="color: var(--text-secondary);"> 
        {{ object.data_cadastro|date:"d/m/Y" }}
    </div>
    <div style="font-size: 12px; color: var(--text-muted);">
        {{ object.data_cadastro|date:"H:i" }}
    </div>
</td>
<td>
    <div class="action-buttons">
        {% if perms.auditorias.change_pilar %}
        <a href="{% url 'auditorias:editar_pilar' object.pk %}" 
           class="btn btn-secondary btn-icon" 
           title="Editar pilar">
            <i class="fas fa-edit"></i> 
        </a>
        {% endif %}

        {% if perms.auditorias.delete_pilar %}
        <button type="button" 
                class="btn btn-danger btn-icon" 
                title="Deletar pilar"
                onclick="confirmDelete('{% url 'auditorias:deletar_pilar' object.pk %}', '{{ object.nome }}')">
            <i class="fas fa-trash"></i> 
        </button>
        {% endif %}

    </div>
</td>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .filter-row th {
            padding: 8px !important;
            vertical-align: top;
        }
        .column-filter {
            height: 38px;
            font-size: 13px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) {
            return;
        }
        const tableBody = table.querySelector('tbody');
        if (!tableBody) {
            return;
        }

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) {
                return;
            }

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);

                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) {
                                isRowVisible = false;
                            }
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }

        if (filters.length > 0) {
            filters.forEach(filter => {
                filter.addEventListener('input', applyTableFilters);
            });
        }
    });
    </script>
{% endblock %}