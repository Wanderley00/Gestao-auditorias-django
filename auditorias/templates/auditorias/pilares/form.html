{% extends 'auditorias/form_generico.html' %}

{% block form_content %}
<div class="form-row single">
    <div class="form-group required">
        <label for="nome" class="form-label">Nome do Pilar</label>
        <input type="text" 
               id="nome" 
               name="nome" 
               class="form-control" 
               value="{{ pilar.nome|default:'' }}" 
               required 
               maxlength="100"
               placeholder="Digite o nome do pilar">
        <div class="field-help">Nome único e descritivo para identificar o pilar</div>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea id="descricao" 
                  name="descricao" 
                  class="form-control" 
                  rows="4" 
                  placeholder="Descreva o propósito e objetivos deste pilar">{{ pilar.descricao|default:'' }}</textarea>
        <div class="field-help">Descrição detalhada do pilar e sua aplicação</div>
    </div>
</div>

<div class="form-row single">
    <div class="form-group">
        <label class="form-label">Status</label>
        <div style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch">
                <input type="checkbox" 
                       name="ativo" 
                       {% if pilar.ativo|default:True %}checked{% endif %}>
                <span class="toggle-slider"></span>
            </label>
            <span style="color: var(--text-secondary); font-size: 14px;">
                Pilar ativo no sistema
            </span>
        </div>
        <div class="field-help">Pilares inativos não aparecerão nas listagens de seleção</div>
    </div>
</div>
{% endblock %}

{% block help_content %}
<div style="color: var(--text-secondary); font-size: 14px; line-height: 1.6;">
    <p><strong>Sobre Pilares:</strong></p>
    <ul style="margin: 12px 0; padding-left: 20px;">
        <li>Pilares são categorias principais para organizar auditorias</li>
        <li>Cada pilar pode ter múltiplas categorias de auditoria</li>
        <li>Use nomes claros e únicos</li>
        <li>A descrição ajuda outros usuários a entender o propósito</li>
    </ul>
    
    <p><strong>Exemplos de Pilares:</strong></p>
    <ul style="margin: 12px 0; padding-left: 20px;">
        <li>Qualidade</li>
        <li>Segurança</li>
        <li>Meio Ambiente</li>
        <li>Produtividade</li>
        <li>Manutenção</li>
    </ul>
</div>
{% endblock %}

{% block quick_actions %}
<button type="button" onclick="previewForm()" class="btn btn-secondary btn-sm">
    <i class="fas fa-eye"></i>
    Visualizar
</button>
<button type="button" onclick="resetForm()" class="btn btn-secondary btn-sm">
    <i class="fas fa-undo"></i>
    Resetar
</button>
<button type="button" onclick="generateSuggestions()" class="btn btn-secondary btn-sm">
    <i class="fas fa-lightbulb"></i>
    Sugestões
</button>
<button type="button" onclick="validatePilarName()" class="btn btn-secondary btn-sm">
    <i class="fas fa-check"></i>
    Verificar Nome
</button>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    // Validação específica para pilares
    document.addEventListener('DOMContentLoaded', function() {
        const nomeField = document.getElementById('nome');
        const descricaoField = document.getElementById('descricao');
        
        // Validação em tempo real do nome
        nomeField.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length > 0 && value.length < 3) {
                showFieldError(this, 'Nome deve ter pelo menos 3 caracteres');
            } else if (value.length > 100) {
                showFieldError(this, 'Nome não pode ter mais de 100 caracteres');
            }
        });
        
        // Auto-capitalização do nome
        nomeField.addEventListener('blur', function() {
            this.value = this.value.trim().replace(/\b\w/g, l => l.toUpperCase());
        });
        
        // Contador de caracteres para descrição
        const charCounter = document.createElement('div');
        charCounter.className = 'field-help';
        charCounter.style.textAlign = 'right';
        descricaoField.parentNode.appendChild(charCounter);
        
        function updateCharCounter() {
            const length = descricaoField.value.length;
            charCounter.textContent = `${length} caracteres`;
            
            if (length > 500) {
                charCounter.style.color = 'var(--warning)';
            } else {
                charCounter.style.color = 'var(--text-muted)';
            }
        }
        
        descricaoField.addEventListener('input', updateCharCounter);
        updateCharCounter();
    });

    // Função para gerar sugestões
    function generateSuggestions() {
        const suggestions = [
            'Qualidade',
            'Segurança do Trabalho',
            'Meio Ambiente',
            'Produtividade',
            'Manutenção',
            'Gestão de Pessoas',
            'Inovação',
            'Sustentabilidade',
            'Compliance',
            'Eficiência Operacional'
        ];
        
        let suggestionsHtml = '<div style="margin-bottom: 16px;"><strong>Sugestões de Pilares:</strong></div>';
        suggestionsHtml += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
        
        suggestions.forEach(suggestion => {
            suggestionsHtml += `
                <button type="button" 
                        onclick="applySuggestion('${suggestion}')" 
                        class="btn btn-secondary btn-sm"
                        style="font-size: 12px; padding: 4px 8px;">
                    ${suggestion}
                </button>
            `;
        });
        
        suggestionsHtml += '</div>';
        
        document.getElementById('previewContent').innerHTML = suggestionsHtml;
        document.getElementById('previewModal').style.display = 'flex';
    }

    // Aplicar sugestão
    function applySuggestion(suggestion) {
        document.getElementById('nome').value = suggestion;
        
        // Gerar descrição automática baseada na sugestão
        const descriptions = {
            'Qualidade': 'Pilar focado na garantia da qualidade de produtos e processos',
            'Segurança do Trabalho': 'Pilar dedicado à segurança e saúde ocupacional dos colaboradores',
            'Meio Ambiente': 'Pilar voltado para práticas ambientalmente sustentáveis',
            'Produtividade': 'Pilar focado na otimização da produtividade e eficiência',
            'Manutenção': 'Pilar dedicado à manutenção preventiva e corretiva de equipamentos',
            'Gestão de Pessoas': 'Pilar focado no desenvolvimento e gestão de recursos humanos',
            'Inovação': 'Pilar dedicado à inovação e melhoria contínua',
            'Sustentabilidade': 'Pilar voltado para práticas sustentáveis e responsabilidade social',
            'Compliance': 'Pilar focado no cumprimento de normas e regulamentações',
            'Eficiência Operacional': 'Pilar dedicado à otimização de processos operacionais'
        };
        
        if (descriptions[suggestion]) {
            document.getElementById('descricao').value = descriptions[suggestion];
        }
        
        closePreviewModal();
        
        // Trigger validation
        document.getElementById('nome').dispatchEvent(new Event('input'));
    }

    // Validar nome do pilar
    function validatePilarName() {
        const nome = document.getElementById('nome').value.trim();
        
        if (!nome) {
            alert('Digite um nome para validar');
            return;
        }
        
        // Simular validação via AJAX
        setButtonLoading('submitBtn', true);
        
        setTimeout(() => {
            setButtonLoading('submitBtn', false);
            
            // Simular resultado da validação
            const isUnique = Math.random() > 0.3; // 70% chance de ser único
            
            if (isUnique) {
                showFieldSuccess(document.getElementById('nome'), 'Nome disponível');
            } else {
                showFieldError(document.getElementById('nome'), 'Este nome já está em uso');
            }
        }, 1000);
    }

    // Mostrar sucesso no campo
    function showFieldSuccess(field, message) {
        field.classList.add('success');
        field.classList.remove('error');
        
        // Remover mensagem anterior
        const existingMessage = field.parentNode.querySelector('.field-error, .field-success');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // Adicionar mensagem de sucesso
        const successElement = document.createElement('div');
        successElement.className = 'field-success';
        successElement.style.color = 'var(--success)';
        successElement.style.fontSize = '12px';
        successElement.style.marginTop = '4px';
        successElement.style.display = 'flex';
        successElement.style.alignItems = 'center';
        successElement.style.gap = '4px';
        successElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
        field.parentNode.appendChild(successElement);
        
        // Remover após 3 segundos
        setTimeout(() => {
            if (successElement.parentNode) {
                successElement.remove();
            }
        }, 3000);
    }

    // Validação customizada do formulário
    function validateForm() {
        const nome = document.getElementById('nome').value.trim();
        let isValid = true;
        
        if (!nome) {
            showFieldError(document.getElementById('nome'), 'Nome é obrigatório');
            isValid = false;
        } else if (nome.length < 3) {
            showFieldError(document.getElementById('nome'), 'Nome deve ter pelo menos 3 caracteres');
            isValid = false;
        }
        
        return isValid;
    }

    // Atalhos específicos para pilares
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + G para gerar sugestões
        if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
            e.preventDefault();
            generateSuggestions();
        }
        
        // Ctrl/Cmd + T para validar nome
        if ((e.ctrlKey || e.metaKey) && e.key === 't') {
            e.preventDefault();
            validatePilarName();
        }
    });
</script>
{% endblock %}

