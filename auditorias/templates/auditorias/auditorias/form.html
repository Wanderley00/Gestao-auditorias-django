{% extends 'auditorias/form_generico.html' %}

{% block form_content %}

<h4 style="color: var(--text-primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    1. Informações Gerais
</h4>
<div class="form-row">
    <div class="form-group required">
        <label for="responsavel" class="form-label">Responsável</label>
        <select id="responsavel" name="responsavel" class="form-control form-select" required>
            <option value="">Selecione...</option>
            {% for u in usuarios %}
            <option value="{{ u.pk }}" {% if auditoria.responsavel.pk == u.pk %}selected{% endif %}>{{ u.get_full_name|default:u.username }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<h4 style="color: var(--text-primary); margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    2. Local e Modelo
</h4>
<div class="form-row">
    <div class="form-group required">
        <label for="nivel_organizacional" class="form-label">Nível Organizacional</label>
        <select id="nivel_organizacional" name="nivel_organizacional" class="form-control form-select" required>
            <option value="">Selecione...</option>
            <option value="EMPRESA" {% if auditoria.nivel_organizacional == 'EMPRESA' %}selected{% endif %}>Empresa</option>
            <option value="AREA" {% if auditoria.nivel_organizacional == 'AREA' %}selected{% endif %}>Área</option>
            <option value="SETOR" {% if auditoria.nivel_organizacional == 'SETOR' %}selected{% endif %}>Setor</option>
            <option value="SUBSETOR" {% if auditoria.nivel_organizacional == 'SUBSETOR' %}selected{% endif %}>Subsetor</option>
        </select>
    </div>
    <div class="form-group required">
        <label for="categoria_auditoria" class="form-label">Categoria</label>
        <select id="categoria_auditoria" name="categoria_auditoria" class="form-control form-select" required>
            <option value="APP" selected>App</option>
        </select>
    </div>
</div>
<div class="form-row">
    <div class="form-group" id="container-empresa">
        <label for="local_empresa" class="form-label">Empresa</label>
        <select id="local_empresa" name="local_empresa" class="form-control form-select">
            <option value="">Selecione uma empresa...</option>
            {% for e in empresas %}<option value="{{ e.pk }}" {% if auditoria.local_empresa.pk == e.pk %}selected{% endif %}>{{ e.nome }}</option>{% endfor %}
        </select>
    </div>
    <div class="form-group" id="container-area" style="display:none;">
        <label for="local_area" class="form-label">Área</label>
        <select id="local_area" name="local_area" class="form-control form-select"></select>
    </div>
</div>
<div class="form-row">
    <div class="form-group" id="container-setor" style="display:none;">
        <label for="local_setor" class="form-label">Setor</label>
        <select id="local_setor" name="local_setor" class="form-control form-select"></select>
    </div>
    <div class="form-group" id="container-subsetor" style="display:none;">
        <label for="local_subsetor" class="form-label">Subsetor</label>
        <select id="local_subsetor" name="local_subsetor" class="form-control form-select"></select>
    </div>
</div>

<div class="form-row single">
     <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="agendamento_especifico" name="agendamento_especifico" {% if auditoria.agendamento_especifico %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px; margin-left: 12px;">Agendar para locais específicos</span>
        <div class="field-help">Marque esta opção para selecionar subsetores individuais. Se desmarcado, será criada uma auditoria única para o nível selecionado (o local será escolhido no app).</div>
    </div>
</div>

<div class="form-row single" id="container-subsetores-especificos" style="display:none;">
    <div class="form-group">
        <label for="subsetores_selecionados" class="form-label">Subsetores Específicos</label>
        <select id="subsetores_selecionados" name="subsetores_selecionados" multiple>
            </select>
        <div class="field-help">Selecione um ou mais subsetores para criar uma auditoria para cada um.</div>
    </div>
</div>

<div class="form-row">
    <div class="form-group required">
        <label for="modelos" class="form-label">Modelo de Auditoria</label>
        <select id="modelos" name="modelos" required>
            <option value="">Selecione um modelo...</option>
            {% for m in modelos %}
                <option value="{{ m.pk }}" 
                    {% if auditoria and m in auditoria.modelos.all %}selected{% endif %}>
                    {{ m.descricao }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="ativos_auditados" class="form-label">Ativos Auditados (Opcional)</label>
        <select id="ativos_auditados" name="ativos_auditados" multiple>
            {% if auditoria %}{% for a in auditoria.ativos_auditados.all %}<option value="{{ a.pk }}" selected>{{ a.tag }} - {{ a.descricao }}</option>{% endfor %}{% endif %}
        </select>
    </div>
</div>

<h4 style="color: var(--text-primary); margin: 32px 0 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border);">
    3. Programação
</h4>

<div class="form-row">
    <div class="form-group required">
        <label for="data_inicio" class="form-label">Data de Início</label>
        <input type="date" id="data_inicio" name="data_inicio" class="form-control schedule-input" value="{{ auditoria.data_inicio|date:'Y-m-d' }}" required>
    </div>
    <div class="form-group">
        <label for="data_fim" class="form-label">Até o Dia:</label>
        <input type="date" id="data_fim" name="data_fim" class="form-control schedule-input" value="{{ auditoria.data_fim|date:'Y-m-d' }}">
        <div class="field-help">*Se desejar fazer somente um dia, não preencha este campo.</div>
    </div>
</div>

<div class="form-row">
    <div class="form-group">
        <input type="radio" id="por_frequencia" name="schedule_type" value="por_frequencia" class="schedule-input" {% if auditoria.por_frequencia or not auditoria %}checked{% endif %}>
        <label for="por_frequencia">Por Frequência</label>
    </div>
    <div class="form-group">
        <input type="radio" id="por_intervalo" name="schedule_type" value="por_intervalo" class="schedule-input" {% if auditoria.por_intervalo %}checked{% endif %}>
        <label for="por_intervalo">Por Intervalo</label>
    </div>
</div>

<div class="form-row">
    <div class="form-group" id="frequency-fields">
        <label for="frequencia" class="form-label">Frequência</label>
        <select id="frequencia" name="frequencia" class="form-control schedule-input">
            <option value="DIARIO" {% if auditoria.frequencia == 'DIARIO' %}selected{% endif %}>Diário</option>
            <option value="SEMANAL" {% if auditoria.frequencia == 'SEMANAL' %}selected{% endif %}>Semanal</option>
            <option value="QUINZENAL" {% if auditoria.frequencia == 'QUINZENAL' %}selected{% endif %}>Quinzenal</option>
            <option value="MENSAL" {% if auditoria.frequencia == 'MENSAL' %}selected{% endif %}>Mensal</option>
            <option value="ANUAL" {% if auditoria.frequencia == 'ANUAL' %}selected{% endif %}>Anual</option>
        </select>
    </div>
    <div class="form-group" id="interval-fields">
        <label for="intervalo" class="form-label">Intervalo (em dias)</label>
        <input type="number" id="intervalo" name="intervalo" class="form-control schedule-input" value="{{ auditoria.intervalo|default:'1' }}" min="1">
    </div>
    <div class="form-group">
        <label for="numero_repeticoes" class="form-label">Número de Repetições</label>
        <input type="number" id="numero_repeticoes" name="numero_repeticoes" class="form-control schedule-input" value="{{ auditoria.numero_repeticoes|default:'1' }}" min="1">
        <div class="field-help">Quantas vezes a auditoria deve ocorrer em cada data gerada.</div>
    </div>
</div>


<div class="form-row single">
     <div class="form-group">
        <label class="toggle-switch">
            <input type="checkbox" id="pular_finais_semana" name="pular_finais_semana" class="schedule-input" {% if auditoria.pular_finais_semana %}checked{% endif %}>
            <span class="toggle-slider"></span>
        </label>
        <span style="color: var(--text-secondary); font-size: 14px; margin-left: 12px;">Pular fins de semana</span>
    </div>
</div>

<div id="date-preview-container" style="margin-top: 24px; display: none;">
    <h5 style="color: var(--text-primary); margin-bottom: 12px;">Datas que serão geradas</h5>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Auditorias</th>
                    <th>Repetição</th>
                    <th>Dia da Semana</th>
                    <th>Dia</th>
                    <th>Mês</th>
                    <th>Ano</th>
                </tr>
            </thead>
            <tbody id="date-preview-body">
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===================================================================
    // LÓGICA NOVA: INICIALIZAÇÃO DO TOM SELECT
    // ===================================================================
    new TomSelect('#modelos',{
        placeholder: 'Selecione um modelo...',
        maxItems: 1, // Garante apenas 1 item
        sortField: {
            field: "text",
            direction: "asc"
        }
        // Removi o plugin 'remove_button' para ficar com cara de select padrão
    });

    new TomSelect('#ativos_auditados',{
        plugins: ['remove_button'],
        placeholder: 'Selecione um ou mais ativos...',
        sortField: {
            field: "text",
            direction: "asc"
        }
    });

    const subsetoresTomSelect = new TomSelect('#subsetores_selecionados',{
        plugins: ['remove_button'],
        placeholder: 'Selecione um ou mais subsetores...',
        sortField: { field: "text", direction: "asc" }
    });
    
    // ===================================================================
    // LÓGICA 1: CARREGAMENTO DINÂMICO DE LOCAL, MODELO E ATIVO
    // ===================================================================
    const nivelSelect = document.getElementById('nivel_organizacional');
    const empresaSelect = document.getElementById('local_empresa');
    const areaSelect = document.getElementById('local_area');
    const setorSelect = document.getElementById('local_setor');
    const subsetorSelect = document.getElementById('local_subsetor');
    const agendamentoEspecificoCheckbox = document.getElementById('agendamento_especifico');
    const containerSubsetoresEspecificos = document.getElementById('container-subsetores-especificos');

    const containers = {
        'EMPRESA': document.getElementById('container-empresa'),
        'AREA': document.getElementById('container-area'),
        'SETOR': document.getElementById('container-setor'),
        'SUBSETOR': document.getElementById('container-subsetor')
    };

    function atualizarVisibilidade() {
        const nivel = nivelSelect.value;
        
        Object.values(containers).forEach(c => c.style.display = 'none');
        if (nivel === 'EMPRESA') {
            containers.EMPRESA.style.display = 'block';
        } else if (nivel === 'AREA') {
            containers.EMPRESA.style.display = 'block';
            containers.AREA.style.display = 'block';
        } else if (nivel === 'SETOR') {
            containers.EMPRESA.style.display = 'block';
            containers.AREA.style.display = 'block';
            containers.SETOR.style.display = 'block';
        } else if (nivel === 'SUBSETOR') {
            Object.values(containers).forEach(c => c.style.display = 'block');
        }
        carregarAtivos();

        if (nivel && nivel !== 'SUBSETOR') {
            agendamentoEspecificoCheckbox.closest('.form-group').style.display = 'block';
            toggleSpecificScheduling();
        } else {
            agendamentoEspecificoCheckbox.closest('.form-group').style.display = 'none';
            containerSubsetoresEspecificos.style.display = 'none';
        }

        loadSubsetorsForSelection();
    }

    function toggleSpecificScheduling() {
        if (agendamentoEspecificoCheckbox.checked) {
            containerSubsetoresEspecificos.style.display = 'block';
        } else {
            containerSubsetoresEspecificos.style.display = 'none';
        }
    }

    function loadSubsetorsForSelection() {
        const nivel = nivelSelect.value;
        let local_id = null;
        let query_param = '';

        if (nivel === 'SETOR' && setorSelect.value) { local_id = setorSelect.value; query_param = 'setor_id'; }
        else if (nivel === 'AREA' && areaSelect.value) { local_id = areaSelect.value; query_param = 'area_id'; }
        else if (nivel === 'EMPRESA' && empresaSelect.value) { local_id = empresaSelect.value; query_param = 'empresa_id'; }

        subsetoresTomSelect.clear();
        subsetoresTomSelect.clearOptions();
        
        if (query_param && local_id) {
            // Esta é a URL que você criou em urls.py 
            const url = `{% url 'auditorias:get_subsetores_por_nivel' %}?${query_param}=${local_id}`;

            subsetoresTomSelect.addOption({value: '', text: 'Carregando subsetores...'});
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro na rede: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    subsetoresTomSelect.clearOptions();
                    if (data.length > 0) {
                        data.forEach(sub => {
                            subsetoresTomSelect.addOption({ value: sub.id, text: sub.nome });
                        });
                    } else {
                        subsetoresTomSelect.addOption({value: '', text: 'Nenhum subsetor encontrado'});
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar subsetores:', error);
                    subsetoresTomSelect.clearOptions();
                    subsetoresTomSelect.addOption({value: '', text: 'Erro ao carregar subsetores'});
                });

        } else if (nivel && nivel !== 'SUBSETOR') {
            subsetoresTomSelect.addOption({value: '', text: 'Selecione um local acima para carregar'});
        } else {
             subsetoresTomSelect.addOption({value: '', text: 'Opção desabilitada para este nível'});
        }
    }

    function popularSelect(selectElement, url, placeholder) {
        selectElement.innerHTML = `<option value="">${placeholder}</option>`;
        fetch(url)
            .then(response => response.json())
            .then(data => {
                data.forEach(item => {
                    const option = new Option(item.nome, item.id);
                    selectElement.add(option);
                });
            })
            .catch(error => {
                console.error('Erro ao popular select:', error);
                selectElement.innerHTML = `<option value="">Erro ao carregar</option>`;
            });
    }

    function carregarAtivos() {
        const nivel = nivelSelect.value;
        let local_id = null;
        if (nivel === 'SUBSETOR' && subsetorSelect.value) local_id = subsetorSelect.value;
        else if (nivel === 'SETOR' && setorSelect.value) local_id = setorSelect.value;
        else if (nivel === 'AREA' && areaSelect.value) local_id = areaSelect.value;
        else if (nivel === 'EMPRESA' && empresaSelect.value) local_id = empresaSelect.value;
        
        const ativosTomSelect = ativos_auditados.tomselect;
        ativosTomSelect.clear();
        ativosTomSelect.clearOptions();
        ativosTomSelect.addOption({value: '', text: 'Carregando...'});
        
        if (nivel && local_id) {
            const url = `{% url 'auditorias:get_ativos_por_local' %}?nivel=${nivel}&local_id=${local_id}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    ativosTomSelect.clearOptions();
                    if (data.length > 0) {
                        data.forEach(ativo => {
                            ativosTomSelect.addOption({
                                value: ativo.id,
                                text: `${ativo.tag} - ${ativo.descricao}`
                            });
                        });
                    } else {
                        ativosTomSelect.addOption({value: '', text: 'Nenhum ativo encontrado para este local'});
                    }
                });
        } else {
            ativosTomSelect.clearOptions();
            ativosTomSelect.addOption({value: '', text: 'Selecione um local para ver os ativos'});
        }
    }

    // --- CORREÇÃO NOS LISTENERS ---
    agendamentoEspecificoCheckbox.addEventListener('change', toggleSpecificScheduling);

    nivelSelect.addEventListener('change', atualizarVisibilidade);
    
    empresaSelect.addEventListener('change', () => {
        popularSelect(areaSelect, `{% url 'auditorias:get_areas_por_empresa' %}?empresa_id=${empresaSelect.value}`, 'Selecione uma área...');
        carregarAtivos();
        loadSubsetorsForSelection(); // <-- ESTA LINHA FOI ADICIONADA
    });
    areaSelect.addEventListener('change', () => {
        popularSelect(setorSelect, `{% url 'auditorias:get_setores_por_area' %}?area_id=${areaSelect.value}`, 'Selecione um setor...');
        carregarAtivos();
        loadSubsetorsForSelection(); // <-- ESTA LINHA FOI ADICIONADA
    });
    setorSelect.addEventListener('change', () => {
        popularSelect(subsetorSelect, `{% url 'auditorias:get_subsetores_por_setor' %}?setor_id=${setorSelect.value}`, 'Selecione um subsetor...');
        carregarAtivos();
        loadSubsetorsForSelection(); // <-- ESTA LINHA FOI ADICIONADA
    });
    subsetorSelect.addEventListener('change', () => {
        carregarAtivos();
        // Não precisamos chamar loadSubsetorsForSelection() aqui, pois o nível "SUBSETOR" desativa o campo.
    });
    // --- FIM DA CORREÇÃO ---

    atualizarVisibilidade(); // Chamada inicial


    // ===================================================================
    // LÓGICA 2: PREVISÃO DINÂMICA DE DATAS DE AGENDAMENTO
    // ===================================================================
    const scheduleInputs = document.querySelectorAll('.schedule-input');
    const frequencyContainer = document.getElementById('frequency-fields');
    const intervalContainer = document.getElementById('interval-fields');
    const porFrequenciaRadio = document.getElementById('por_frequencia');
    const previewBody = document.getElementById('date-preview-body');
    const previewContainer = document.getElementById('date-preview-container');

    function toggleScheduleFields() {
        const frequenciaSelect = document.getElementById('frequencia');
        const intervaloInput = document.getElementById('intervalo');
        const repeticoesInput = document.getElementById('numero_repeticoes');

        if (porFrequenciaRadio.checked) {
            // Mostra Frequência / Esconde Intervalo
            frequencyContainer.style.display = 'block';
            intervalContainer.style.display = 'none';

            // TORNA OBRIGATÓRIO: Frequência
            // REMOVE OBRIGATORIEDADE: Intervalo
            frequenciaSelect.setAttribute('required', 'required');
            intervaloInput.removeAttribute('required');
        } else {
            // Mostra Intervalo / Esconde Frequência
            frequencyContainer.style.display = 'none';
            intervalContainer.style.display = 'block';

            // TORNA OBRIGATÓRIO: Intervalo
            // REMOVE OBRIGATORIEDADE: Frequência
            intervaloInput.setAttribute('required', 'required');
            frequenciaSelect.removeAttribute('required');
        }
        
        // Número de repetições é sempre obrigatório (padrão 1)
        repeticoesInput.setAttribute('required', 'required');
    }

    function updateDatePreview() {
        toggleScheduleFields();

        const dataInicio = document.getElementById('data_inicio').value;
        const dataFim = document.getElementById('data_fim').value;
        const scheduleType = document.querySelector('input[name="schedule_type"]:checked').value;
        const frequencia = document.getElementById('frequencia').value;
        const intervalo = document.getElementById('intervalo').value;
        const numeroRepeticoes = document.getElementById('numero_repeticoes').value;
        const pularFinsSemana = document.getElementById('pular_finais_semana').checked;

        if (!dataInicio) {
            previewContainer.style.display = 'none';
            return;
        }

        const params = new URLSearchParams({
            data_inicio: dataInicio,
            ate_dia: dataFim,
            schedule_type: scheduleType,
            frequencia: frequencia,
            intervalo: intervalo,
            numero_repeticoes: numeroRepeticoes,
            pular_fins_semana: pularFinsSemana
        });
        
        const url = `{% url 'auditorias:preview_audit_dates' %}?${params.toString()}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                previewBody.innerHTML = '';
                
                if (data.dates && data.dates.length > 0) {
                    previewContainer.style.display = 'block';
                    data.dates.forEach(date => {
                        const row = `
                            <tr>
                                <td>${date.auditoria_num}</td>
                                <td>${date.repeticao_num}x</td>
                                <td>${date.dia_semana}</td>
                                <td>${date.dia}</td>
                                <td>${date.mes}</td>
                                <td>${date.ano}</td>
                            </tr>
                        `;
                        previewBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    previewContainer.style.display = 'none';
                }
            })
            .catch(error => console.error('Erro:', error));
    }

    scheduleInputs.forEach(input => {
        input.addEventListener('change', updateDatePreview);
    });

    updateDatePreview();
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // CORREÇÃO: Removido o prefixo 'id_' para bater com o seu HTML
        const dataInicioInput = document.getElementById('data_inicio');
        const dataFimInput = document.getElementById('data_fim');

        if (dataInicioInput && dataFimInput) {
            
            // 1. Define a data mínima do "Início" como Hoje
            // Pega a data atual (YYYY-MM-DD)
            const hoje = new Date().toISOString().split('T')[0];
            
            // Se for cadastro novo (campo vazio), bloqueia datas passadas
            if (!dataInicioInput.value) {
                dataInicioInput.setAttribute('min', hoje);
            }

            // 2. Função para travar a data Fim baseada na data Início
            function atualizarDataFim() {
                const dataSelecionada = dataInicioInput.value;
                if (dataSelecionada) {
                    // O campo 'Até o dia' não pode ser menor que a data de início
                    dataFimInput.setAttribute('min', dataSelecionada);
                    
                    // Se o usuário já tinha escolhido um fim menor que o novo início, limpa o campo
                    if (dataFimInput.value && dataFimInput.value < dataSelecionada) {
                        dataFimInput.value = '';
                    }
                }
            }

            // Adiciona o evento de mudança
            dataInicioInput.addEventListener('change', atualizarDataFim);

            // Roda uma vez ao carregar a página para aplicar as regras
            atualizarDataFim();
        }
    });
</script>
{% endblock %}