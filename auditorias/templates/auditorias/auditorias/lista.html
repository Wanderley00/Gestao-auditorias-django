{% extends 'auditorias/lista_generica.html' %}

{# --- CABEÇALHO --- #}
{% block header_content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">Administrar auditorias agendadas do sistema</p>
        </div>
        <div style="display: flex; gap: 10px;">
            {# NOVO BOTÃO CALENDÁRIO #}
            <button type="button" onclick="openCalendarModal()" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-calendar-alt" style="color: #0ea5e9;"></i> Calendário
            </button>

            <a href="{% url 'auditorias:dashboard' %}" class="btn btn-secondary" style="background-color: #fff; color: #333; border: 1px solid #ddd;">
                <i class="fas fa-chart-pie" style="color: #7c3aed;"></i> Dashboard
            </a>
            
            <a href="{% url create_url %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                {% if button_text %}{{ button_text }}{% else %}Criar {{ singular|default:title|slice:":-1" }}{% endif %}
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block search_form %}{% endblock %}
{% block extra_filters %}{% endblock %}

{% block table_headers %}
    <tr>
        <th>ID Agendamento</th>
        <th>Criado por</th>
        <th>Auditor</th>
        <th>Modelo(s)</th>
        <th>Local</th>
        <th>Ferramenta</th>
        <th>Plataforma</th>
        <th>Programação</th>
        <th>Data de Início</th>
        <th>Data de Fim</th>
        <th style="width: 120px;">Ações</th>
    </tr>
    <tr class="filter-row">
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="0"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="1"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="2"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="3"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="4"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="5"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="6"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="7"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="8"></th>
        <th><input type="text" class="form-control column-filter" placeholder="Filtrar..." data-column-index="9"></th>
        <th></th>
    </tr>
{% endblock %}

{% block table_row %}
    <td><strong>#{{ object.id }}</strong></td>
    <td>{{ object.criado_por.get_full_name|default:object.criado_por.username|default:"Sistema" }}</td>
    <td>
        <div style="font-weight: 600; color: var(--text-primary);">
             {{ object.responsavel.get_full_name|default:object.responsavel.username|default:"N/A" }}
        </div>
    </td>
    <td>
        {% for modelo in object.modelos.all %}
            {{ modelo.descricao }}{% if not forloop.last %},<br>{% endif %}
        {% empty %}--{% endfor %}
    </td>
    <td>
        {% if object.local_subsetor %}{{ object.local_subsetor.nome }}{% elif object.local_setor %}{{ object.local_setor.nome }}{% elif object.local_area %}{{ object.local_area.nome }}{% elif object.local_empresa %}{{ object.local_empresa.nome }}{% else %}--{% endif %}
    </td>
    <td><span class="badge badge-secondary">{{ object.ferramenta.nome|default:"N/A" }}</span></td>
    <td><span class="badge badge-info">{{ object.get_categoria_auditoria_display|default:"N/A" }}</span></td>
    <td>{{ object.get_programacao_display }}</td>
    <td>{{ object.data_inicio|date:"d/m/Y" }}</td>
    <td>{{ object.data_fim|date:"d/m/Y"|default:"-" }}</td>
    <td>
        <div class="action-buttons">
            <button type="button" class="btn btn-secondary btn-icon" title="Redirecionar Agendamento"
                 onclick='openRedirectModal("{% url 'auditorias:redirecionar_agendamento' object.pk %}", {{ object.responsavel.id|default:"null" }}, {{ all_users_json|safe }})'>
                <i class="fas fa-people-arrows"></i>
            </button>
            <button type="button" class="btn btn-danger btn-icon" title="Deletar Agendamento"
                    onclick="confirmDelete('{% url 'auditorias:deletar_auditoria' object.pk %}', 'Agendamento #{{ object.id }}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
{% endblock %}

{# --- CORREÇÃO: CSS MOVIDO PARA DENTRO DE EXTRA_JS (OU CONTENT) PARA GARANTIR CARREGAMENTO --- #}
{# Como o bloco extra_css não existe no base.html, colocamos o style aqui junto com os scripts #}
{% block extra_js %}
    {{ block.super }}
    <style>
        .filter-row th { padding: 8px !important; vertical-align: top; }
        .column-filter { height: 38px; font-size: 13px; }

        /* ESTILOS DO CALENDÁRIO */
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .calendar-month-title {
            font-size: 28px;
            font-weight: 800;
            color: #333;
            text-transform: lowercase;
            margin: 0;
        }
        .calendar-month-title::first-letter {
            text-transform: uppercase;
        }

        /* GRID FIX: Força o display grid */
        .calendar-grid-header {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            text-align: right;
            padding-right: 10px;
            margin-bottom: 5px;
            font-weight: 700;
            color: #555;
            text-transform: lowercase;
        }

        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0; /* Adicionei borda externa */
        }

        .calendar-day {
            border: 1px solid #e2e8f0;
            min-height: 100px;
            padding: 5px;
            background: white;
            position: relative;
            margin: -1px 0 0 -1px; /* Bordas colapsadas */
        }

        .calendar-day.other-month {
            background-color: #fcfcfc;
            color: #ccc;
        }

        .day-number {
            text-align: right;
            font-size: 16px;
            color: #333;
            padding-right: 5px;
            margin-bottom: 5px;
        }
        .other-month .day-number { color: #ccc; }

        /* Barras de Evento */
        .event-bar {
            display: block;
            padding: 2px 6px;
            margin-bottom: 2px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
            border-radius: 2px;
        }

        /* Cores das barras */
        .bg-success { background-color: #10b981; }
        .bg-warning { background-color: #f59e0b; }
        .bg-secondary { background-color: #94a3b8; }
        .bg-info { background-color: #0ea5e9; }
        .bg-danger { background-color: #ef4444; }

        /* Legenda */
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #555;
        }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .dot-gray { background: #94a3b8; }
        .dot-blue { background: #0ea5e9; }
        .dot-orange { background: #f59e0b; }
        .dot-green { background: #10b981; }
        .dot-red { background: #ef4444; }
    </style>

    <script>
    // --- LÓGICA DA TABELA (FILTROS) ---
    document.addEventListener('DOMContentLoaded', function() {
        const filters = document.querySelectorAll('.column-filter');
        const table = document.querySelector('#dataTable');
        if (!table) return;
        const tableBody = table.querySelector('tbody');
        if (!tableBody) return;

        function applyTableFilters() {
            const dataRows = tableBody.querySelectorAll('tr');
            if (dataRows.length === 0) return;

            dataRows.forEach(row => {
                let isRowVisible = true;
                const cells = row.querySelectorAll('td');
                filters.forEach(filter => {
                    const filterText = filter.value.toLowerCase().trim();
                    const colIndex = parseInt(filter.dataset.columnIndex, 10);
                    if (filterText) {
                        const cell = cells[colIndex];
                        if (cell) {
                            const cellText = cell.textContent.toLowerCase().trim();
                            if (!cellText.includes(filterText)) isRowVisible = false;
                        } else {
                            isRowVisible = false;
                        }
                    }
                });
                row.style.display = isRowVisible ? '' : 'none';
            });
        }
        if (filters.length > 0) {
            filters.forEach(filter => filter.addEventListener('input', applyTableFilters));
        }
        
        // Inicializa calendário
        renderCalendar();
    });

    // --- LÓGICA DO CALENDÁRIO ---
    let currentDate = new Date();

    function openCalendarModal() {
        document.getElementById('calendarModal').style.display = 'flex';
        renderCalendar(); 
    }

    function closeCalendarModal() {
        document.getElementById('calendarModal').style.display = 'none';
    }

    function irParaHoje() {
        currentDate = new Date();
        renderCalendar();
    }

    function mudarMes(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        const monthNames = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
        document.getElementById('calendarTitle').innerText = `${monthNames[month]} ${year}`;

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Carregando...</div>';

        fetch(`{% url 'auditorias:get_dados_calendario' %}?year=${year}&month=${month + 1}`)
            .then(response => response.json())
            .then(data => {
                if(!data.sucesso) {
                    grid.innerHTML = `<div style="color:red; padding:20px;">Erro: ${data.erro}</div>`;
                    return;
                }
                construirGrade(year, month, data.dados);
            })
            .catch(err => {
                console.error(err);
                grid.innerHTML = '<div style="color:red; padding:20px;">Erro de conexão.</div>';
            });
    }

    function construirGrade(year, month, dadosAuditoria) {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const prevMonthDays = new Date(year, month, 0).getDate();
        
        // Dias do mês anterior
        for (let i = firstDayOfMonth; i > 0; i--) {
            const dayNum = prevMonthDays - i + 1;
            grid.innerHTML += `<div class="calendar-day other-month"><div class="day-number">${dayNum}</div></div>`;
        }

        // Dias do mês atual
        for (let i = 1; i <= daysInMonth; i++) {
            let barsHtml = '';
            
            if (dadosAuditoria[i]) {
                for (const [key, count] of Object.entries(dadosAuditoria[i])) {
                    const [label, color] = key.split('|');
                    barsHtml += `<div class="event-bar bg-${color}">${count} - ${label}</div>`;
                }
            }

            grid.innerHTML += `
                <div class="calendar-day">
                    <div class="day-number">${i}</div>
                    ${barsHtml}
                </div>
            `;
        }

        // Dias do próximo mês
        const totalCells = firstDayOfMonth + daysInMonth;
        const nextMonthDays = (totalCells > 35 ? 42 : 35) - totalCells;
        
        for (let i = 1; i <= nextMonthDays; i++) {
            grid.innerHTML += `<div class="calendar-day other-month"><div class="day-number">${i}</div></div>`;
        }
    }
    </script>
{% endblock %}

{# --- USANDO BLOCK CONTENT PARA O HTML DO MODAL --- #}
{% block content %}
    {{ block.super }}

    <div id="calendarModal" class="modal" style="display: none; padding-top: 20px;">
        <div class="modal-content" style="max-width: 1100px; width: 95%; border-radius: 8px; height: 90vh; display: flex; flex-direction: column;">
            
            <div class="modal-header" style="background: white; border-bottom: 1px solid #e2e8f0; padding: 15px 25px;">
                <h2 style="font-size: 18px; color: #333; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-calendar-alt"></i> Calendário de Auditorias
                </h2>
                <span class="close-btn" onclick="closeCalendarModal()">&times;</span>
            </div>

            <div class="modal-body" style="padding: 20px; overflow-y: auto; flex: 1; background: #f8fafc;">
                
                <div class="calendar-controls">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-danger" onclick="mudarMes(-1)">Anterior</button>
                        <button class="btn btn-sm btn-secondary" onclick="irParaHoje()">Hoje</button>
                        <button class="btn btn-sm btn-danger" onclick="mudarMes(1)">Próximo</button>
                    </div>
                    <h2 id="calendarTitle" class="calendar-month-title">Dezembro 2025</h2>
                    <div style="width: 150px;"></div>
                </div>

                <div class="calendar-grid-header">
                    <div>domingo</div>
                    <div>segunda-feira</div>
                    <div>terça-feira</div>
                    <div>quarta-feira</div>
                    <div>quinta-feira</div>
                    <div>sexta-feira</div>
                    <div>sábado</div>
                </div>
                
                <div id="calendarGrid" class="calendar-grid">
                    </div>

                <div class="calendar-legend">
                    <div class="legend-item"><span class="dot dot-gray"></span> Planejado</div>
                    <div class="legend-item"><span class="dot dot-orange"></span> Pendente</div>
                    <div class="legend-item"><span class="dot dot-red"></span> Não realizado</div>
                    <div class="legend-item"><span class="dot dot-green"></span> Concluída</div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 10px 25px;">
                <button type="button" class="btn btn-danger" onclick="closeCalendarModal()">Fechar</button>
            </div>
        </div>
    </div>
{% endblock %}