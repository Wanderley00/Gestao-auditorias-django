{% extends 'auditorias/base.html' %}

{% block title %}{{ title }}{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="content-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 class="content-title">{{ title }}</h2>
            <p class="content-subtitle">Gerencie as perguntas e tópicos do checklist.</p>
        </div>
        <div>
            <a href="{% url 'auditorias:lista_checklists' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar para Checklists
            </a>
            <a href="{% url 'auditorias:criar_pergunta' checklist.pk %}" class="btn btn-primary">
                <i class="fas fa-plus"></i> Nova Pergunta
            </a>
        </div>
    </div>
</div>

{% if topicos_com_perguntas %}
    {% for topico in topicos_com_perguntas %}
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header" style="background: var(--bg-tertiary);">
            <h3 class="card-title" style="margin: 0;">Tópico: {{ topico.descricao }}</h3>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if topico.perguntas.all %}
                <div class="table-container" style="border: none; box-shadow: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width: 60%;">Descrição da Pergunta</th>
                                <th>Tipo</th>
                                <th>Status</th>
                                <th style="width: 120px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pergunta in topico.perguntas.all %}
                            <tr>
                                <td>
                                    <div style="font-weight: 500; color: var(--text-primary);">
                                        {{ pergunta.descricao }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-info">{{ pergunta.tipo_questao.nome }}</span>
                                </td>
                                <td>
                                    {% if pergunta.campo_obrigatorio %}
                                        <span class="badge badge-warning">Obrigatório</span>
                                    {% endif %}
                                    {% if pergunta.campo_desabilitado %}
                                        <span class="badge badge-error">Desabilitado</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{% url 'auditorias:editar_pergunta' pergunta.pk %}" class="btn btn-secondary btn-icon" title="Editar Pergunta">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-danger btn-icon" title="Deletar Pergunta"
                                                onclick="confirmDelete('{% url 'auditorias:deletar_pergunta' pergunta.pk %}', 'a pergunta selecionada')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div style="text-align: center; padding: 32px; color: var(--text-muted);">
                    <p>Nenhuma pergunta cadastrada para este tópico.</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="card">
        <div class="card-body" style="text-align: center; padding: 64px 24px; color: var(--text-muted);">
            <i class="fas fa-folder-open" style="font-size: 64px; margin-bottom: 24px; opacity: 0.3;"></i>
            <h3 style="margin-bottom: 12px; color: var(--text-secondary);">Nenhum tópico encontrado</h3>
            <p style="margin-bottom: 24px;">Este checklist ainda não possui tópicos. Adicione tópicos e perguntas para começar.</p>
            <a href="{% url 'auditorias:editar_checklist' checklist.pk %}" class="btn btn-secondary">
                <i class="fas fa-edit"></i> Editar Checklist para adicionar Tópicos
            </a>
        </div>
    </div>
{% endif %}

<!-- Modal de Confirmação para Exclusão (reutilizado do lista_generica) -->
<div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--radius-lg); padding: 32px; max-width: 400px; width: 90%; box-shadow: var(--shadow-xl);">
        <div style="text-align: center; margin-bottom: 24px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 16px;"></i>
            <h3 style="margin-bottom: 8px;">Confirmar Exclusão</h3>
            <p style="color: var(--text-secondary);">Esta ação não pode ser desfeita.</p>
        </div>
        <form id="deleteForm" method="post" style="display: inline;">
            {% csrf_token %}
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary">Cancelar</button>
                <button type="submit" class="btn btn-danger">Excluir</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function confirmDelete(url, itemName) {
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = url;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
</script>
{% endblock %}
